<!DOCTYPE html>
<html>
<head>
    <title>Deepgram Voice Recognition Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .status.info { background: #e3f2fd; color: #1976d2; }
        .status.success { background: #e8f5e8; color: #2e7d32; }
        .status.error { background: #ffebee; color: #c62828; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        .transcript { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; min-height: 100px; }
        .interim { color: #666; font-style: italic; }
        .final { color: #000; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Deepgram Voice Recognition Test</h1>
        
        <div>
            <label for="api-key">Deepgram API Key:</label><br>
            <input type="password" id="api-key" placeholder="Enter your Deepgram API key" style="width: 100%; padding: 8px; margin: 5px 0;">
        </div>
        
        <div>
            <button id="start-btn">Start Recording</button>
            <button id="stop-btn" disabled>Stop Recording</button>
        </div>
        
        <div id="status" class="status info">Ready to test Deepgram voice recognition</div>
        
        <div class="transcript">
            <h3>Transcript:</h3>
            <div id="interim-text" class="interim"></div>
            <div id="final-text" class="final"></div>
        </div>
        
        <div>
            <h3>Debug Log:</h3>
            <div id="debug-log" style="background: #f0f0f0; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace; font-size: 12px;"></div>
        </div>
    </div>

    <script>
        // Deepgram Voice Recognition Class (same as in fullscreen.html)
        class DeepgramVoiceRecognition {
            constructor(apiKey) {
                this.apiKey = apiKey;
                this.socket = null;
                this.mediaRecorder = null;
                this.audioStream = null;
                this.isRecording = false;
                this.onFinalTranscript = null;
                this.onInterimTranscript = null;
                this.onError = null;
                this.currentSentence = '';
                this.pauseTimer = null;
            }
            
            async startStreaming() {
                this.log('开始 Deepgram 流式识别');
                
                if (!this.apiKey) {
                    this.log('错误: 缺少 Deepgram API Key', 'error');
                    if (this.onError) this.onError('缺少 Deepgram API Key');
                    return false;
                }
                
                try {
                    // 连接到 Deepgram WebSocket
                    const wsUrl = `wss://api.deepgram.com/v1/listen?` + 
                        `model=nova-2&` +
                        `language=zh-CN&` +
                        `smart_format=true&` +
                        `punctuate=true&` +
                        `interim_results=true&` +
                        `endpointing=300&` +
                        `utterance_end_ms=1000&` +
                        `vad_events=true`;
                        
                    this.socket = new WebSocket(wsUrl, ['token', this.apiKey]);
                    
                    this.socket.onopen = () => {
                        this.log('WebSocket 连接已建立', 'success');
                    };
                    
                    this.socket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.handleTranscription(data);
                    };
                    
                    this.socket.onerror = (error) => {
                        this.log('WebSocket 错误: ' + error, 'error');
                        if (this.onError) this.onError('Deepgram 连接错误');
                    };
                    
                    this.socket.onclose = () => {
                        this.log('WebSocket 连接已关闭');
                    };
                    
                    // 等待连接建立
                    await new Promise((resolve, reject) => {
                        this.socket.onopen = resolve;
                        this.socket.onerror = reject;
                        setTimeout(() => reject(new Error('连接超时')), 5000);
                    });
                    
                    // 开始音频捕获
                    await this.startAudioCapture();
                    return true;
                    
                } catch (error) {
                    this.log('启动失败: ' + error.message, 'error');
                    if (this.onError) this.onError('Deepgram 启动失败');
                    return false;
                }
            }
            
            async startAudioCapture() {
                try {
                    this.audioStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            sampleRate: 16000,
                            channelCount: 1,
                            echoCancellation: true,
                            noiseSuppression: true
                        } 
                    });
                    
                    this.mediaRecorder = new MediaRecorder(this.audioStream, {
                        mimeType: 'audio/webm;codecs=opus'
                    });
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0 && this.socket && this.socket.readyState === WebSocket.OPEN) {
                            this.socket.send(event.data);
                        }
                    };
                    
                    this.mediaRecorder.start(100); // 每100ms发送一次数据
                    this.isRecording = true;
                    this.log('音频捕获已开始', 'success');
                    
                } catch (error) {
                    this.log('音频捕获失败: ' + error.message, 'error');
                    throw error;
                }
            }
            
            handleTranscription(data) {
                // 处理语音活动检测事件
                if (data.type === 'SpeechStarted') {
                    this.log('检测到语音开始');
                    return;
                }
                
                if (data.type === 'UtteranceEnd') {
                    this.log('检测到语句结束');
                    if (this.currentSentence.trim()) {
                        if (this.onFinalTranscript) {
                            this.onFinalTranscript(this.currentSentence.trim());
                        }
                        this.currentSentence = '';
                    }
                    return;
                }
                
                // 处理转录结果
                if (data.channel?.alternatives?.[0]) {
                    const transcript = data.channel.alternatives[0].transcript;
                    const isFinal = data.is_final;
                    
                    if (transcript.trim()) {
                        if (isFinal) {
                            this.log('最终结果: ' + transcript);
                            this.currentSentence += transcript;
                            
                            // 清除暂停计时器
                            if (this.pauseTimer) {
                                clearTimeout(this.pauseTimer);
                            }
                            
                            // 设置暂停检测计时器
                            this.pauseTimer = setTimeout(() => {
                                if (this.currentSentence.trim()) {
                                    this.log('暂停检测触发，发送句子: ' + this.currentSentence);
                                    if (this.onFinalTranscript) {
                                        this.onFinalTranscript(this.currentSentence.trim());
                                    }
                                    this.currentSentence = '';
                                }
                            }, 1500); // 1.5秒暂停检测
                            
                        } else {
                            // 临时结果，用于实时反馈
                            const fullTranscript = this.currentSentence + transcript;
                            if (this.onInterimTranscript) {
                                this.onInterimTranscript(fullTranscript);
                            }
                        }
                    }
                }
            }
            
            stop() {
                this.log('停止 Deepgram 识别');
                
                // 处理剩余的句子
                if (this.currentSentence.trim()) {
                    if (this.onFinalTranscript) {
                        this.onFinalTranscript(this.currentSentence.trim());
                    }
                    this.currentSentence = '';
                }
                
                // 清理计时器
                if (this.pauseTimer) {
                    clearTimeout(this.pauseTimer);
                    this.pauseTimer = null;
                }
                
                // 停止录音
                if (this.mediaRecorder && this.isRecording) {
                    this.mediaRecorder.stop();
                    this.isRecording = false;
                }
                
                // 关闭音频流
                if (this.audioStream) {
                    this.audioStream.getTracks().forEach(track => track.stop());
                    this.audioStream = null;
                }
                
                // 关闭WebSocket
                if (this.socket) {
                    this.socket.close();
                    this.socket = null;
                }
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logElement = document.getElementById('debug-log');
                logElement.innerHTML += `[${timestamp}] ${message}\n`;
                logElement.scrollTop = logElement.scrollHeight;
                
                const statusElement = document.getElementById('status');
                statusElement.textContent = message;
                statusElement.className = `status ${type}`;
            }
        }

        // Test implementation
        let recognition = null;
        
        document.getElementById('start-btn').addEventListener('click', async () => {
            const apiKey = document.getElementById('api-key').value.trim();
            if (!apiKey) {
                alert('请输入 Deepgram API Key');
                return;
            }
            
            recognition = new DeepgramVoiceRecognition(apiKey);
            
            recognition.onFinalTranscript = (transcript) => {
                const finalDiv = document.getElementById('final-text');
                finalDiv.innerHTML += '<div>' + transcript + '</div>';
            };
            
            recognition.onInterimTranscript = (transcript) => {
                document.getElementById('interim-text').textContent = transcript;
            };
            
            recognition.onError = (error) => {
                recognition.log('错误: ' + error, 'error');
            };
            
            const success = await recognition.startStreaming();
            if (success) {
                document.getElementById('start-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
            }
        });
        
        document.getElementById('stop-btn').addEventListener('click', () => {
            if (recognition) {
                recognition.stop();
                recognition = null;
            }
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
            document.getElementById('interim-text').textContent = '';
        });
    </script>
</body>
</html>