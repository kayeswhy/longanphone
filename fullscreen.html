<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EPhone - Browser Version</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    
    <!-- Browser Compatibility Layer - Load BEFORE Cordova scripts -->
    <script src="js/browser-compatibility.js"></script>
    
    <!-- Enhanced Spotify OAuth Fix for Browsers -->
    <script>
        console.log('üéµ Loading Spotify OAuth browser fix...');
        
        // Enhanced Spotify OAuth handling for browsers
        (function() {
            // Check for Spotify callback on page load
            function handleSpotifyCallback() {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const error = urlParams.get('error');
                
                if (code || error) {
                    console.log('üéµ Spotify OAuth callback detected');
                    
                    // Clean up URL
                    const cleanUrl = window.location.origin + window.location.pathname;
                    window.history.replaceState({}, document.title, cleanUrl);
                    
                    if (error) {
                        console.error('üéµ Spotify OAuth error:', error);
                        alert('SpotifyÊéàÊùÉÂ§±Ë¥•: ' + error);
                        return;
                    }
                    
                    if (code) {
                        console.log('üéµ Spotify authorization code received:', code.substring(0, 20) + '...');
                        
                        // Try to find and call the token exchange function
                        if (window.exchangeCodeForToken) {
                            window.exchangeCodeForToken(code);
                        } else if (window.handleSpotifyCallback) {
                            window.handleSpotifyCallback(code);
                        } else {
                            // Store the code for later use
                            localStorage.setItem('spotify_auth_code', code);
                            console.log('üéµ Stored Spotify code for later processing');
                        }
                    }
                }
            }
            
            // Override window.open to fix Spotify OAuth URLs
            const originalWindowOpen = window.open;
            window.open = function(url, target, features) {
                console.log('üéµ window.open called with:', url);
                
                if (url && typeof url === 'string' && url.includes('accounts.spotify.com/authorize')) {
                    console.log('üéµ Detected Spotify OAuth URL, fixing redirect URI...');
                    
                    // Replace custom scheme with browser-compatible redirect
                    const browserRedirectUri = window.location.origin + window.location.pathname;
                    const fixedUrl = url.replace(
                        /redirect_uri=[^&]+/,
                        'redirect_uri=' + encodeURIComponent(browserRedirectUri)
                    );
                    
                    console.log('üéµ Original URL:', url);
                    console.log('üéµ Fixed URL:', fixedUrl);
                    
                    return originalWindowOpen.call(this, fixedUrl, target, features);
                }
                
                return originalWindowOpen.call(this, url, target, features);
            };
            
            // Also intercept location.href assignments
            let originalLocationHref = window.location.href;
            Object.defineProperty(window.location, 'href', {
                get: function() {
                    return originalLocationHref;
                },
                set: function(url) {
                    if (url && url.includes('accounts.spotify.com/authorize') && url.includes('lycheephone://')) {
                        console.log('üéµ Fixing Spotify redirect in location.href');
                        const browserRedirectUri = window.location.origin + window.location.pathname;
                        const fixedUrl = url.replace(
                            /redirect_uri=[^&]+/,
                            'redirect_uri=' + encodeURIComponent(browserRedirectUri)
                        );
                        originalLocationHref = fixedUrl;
                        window.location.replace(fixedUrl);
                    } else {
                        originalLocationHref = url;
                        window.location.replace(url);
                    }
                }
            });
            
            // Check for callback immediately and on DOM ready
            handleSpotifyCallback();
            
            document.addEventListener('DOMContentLoaded', function() {
                setTimeout(handleSpotifyCallback, 100);
            });
            
            // Make callback handler globally available
            window.handleSpotifyOAuthCallback = handleSpotifyCallback;
            
        })();
    </script>
    
    <!-- Browser-only mode - no cordova.js needed -->
    <script>
        console.log('üåê Browser mode - skipping cordova.js');
    </script>
    <script src="js/export.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <style>
        :root {
            --secondary-bg: #ffffff;
            --border-color: #e0e0e0;
            --text-primary: #1f1f1f;
            --text-secondary: #8a8a8a;
            --accent-color: #007bff;
        }

        html {
            height: 100%;
            overflow: hidden;
        }

        body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-weight: normal;
            background-color: var(--secondary-bg);
            display: block;
            box-sizing: border-box;
        }

        /* Disable all tap feedback and highlights */
        /* Disable tap feedback and highlights */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        /* Disable text selection only for UI elements */
        .header,
        .back-btn,
        .action-btn,
        .save-btn,
        .app-icon,
        .nav-item,
        button,
        .form-button,
        .chat-action-icon-btn,
        .call-action-btn,
        .control-btn,
        .transfer-actions button,
        .music-controls button {
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Disable text selection specifically for modal dialogs */
        .modal,
        .modal-content,
        .modal-header,
        .modal-body,
        .modal-footer,
        #custom-modal-overlay,
        #custom-modal,
        .custom-modal-header,
        .custom-modal-body,
        .custom-modal-footer,
        .custom-modal-body p,
        .custom-modal-body span,
        .custom-modal-body div,
        .modal-body p,
        .modal-body span,
        .modal-body div {
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* Ensure text selection is enabled for content areas */
        .message-bubble .content,
        .chat-messages,
        #chat-messages,
        .list-item,
        .world-book-content,
        .qzone-post-content,
        .favorite-item-content,
        input,
        textarea,
        p,
        span,
        div {
            -webkit-user-select: text;
            -khtml-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        #phone-frame {
            width: 100%;
            height: 100%;
            padding: 0;
            background-color: transparent;
            border-radius: 0;
            box-shadow: none;
            position: relative;
        }

        .notch {
            display: none;
        }

        #phone-screen {
            width: 100%;
            height: 100%;
            background-color: transparent;
            border-radius: 0;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #status-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            z-index: 10;
            font-size: 14px;
            box-sizing: border-box;
            pointer-events: none;
        }

        #status-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            z-index: 10;
            font-size: 14px;
            box-sizing: border-box;
            pointer-events: none;
        }

        #status-bar-time {
            font-weight: 600;
        }

        .battery-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .battery-icon {
            width: 25px;
            height: 12px;
            border: 1px solid white;
            border-radius: 3px;
            position: relative;
            padding: 1px;
        }

        .battery-icon::after {
            content: '';
            position: absolute;
            right: -3px;
            top: 2px;
            width: 2px;
            height: 6px;
            background-color: white;
            border-radius: 0 1px 1px 0;
        }

        .battery-level {
            height: 100%;
            background-color: white;
            border-radius: 1px;
            transition: width 0.5s ease;
        }

        .battery-container.charging .battery-level {
            background-color: #4cd964;
            animation: charge-breath 2s infinite;
        }

        .battery-container.charging .battery-text {
            color: #4cd964;
        }

        @keyframes charge-breath {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .screen {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .screen.active {
            opacity: 1;
            visibility: visible;
            z-index: 1;
        }

        .header {
            position: relative;
            z-index: 15;
            flex-shrink: 0;
            padding: 15px 12px;
            padding-top: 15px;
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
        }

        .header .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header .back-btn,
        .header .action-btn {
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            text-align: center;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header .action-btn {
            font-size: 16px;
            /* ‰∏ìÈó®‰∏∫‚Äú‰∏ä‰º†‚Äù„ÄÅ‚Äú+‚ÄùÁ≠âÊñáÂ≠óÊåâÈíÆÁº©Â∞èÂ≠óÂè∑ */
            font-weight: 600;
            /* ÂèØ‰ª•Âä†Á≤ó‰∏ÄÁÇπËÆ©ÂÆÉÊõ¥Ê∏ÖÊô∞ */
        }

        .header .action-btn img {
            height: 26px;
        }

        .header .save-btn {
            font-size: 16px;
            color: var(--accent-color);
            font-weight: 600;
            cursor: pointer;
        }

        #home-screen {
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: 20px;
            padding-top: 88px;
            padding-bottom: 50px;
            box-sizing: border-box;
            background-size: cover;
            background-position: center;
        }

        #clock-container {
            text-align: center;
            color: white;
            text-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        #main-time {
            font-size: 80px;
            font-weight: 200;
        }

        #main-date {
            font-size: 18px;
            font-weight: 500;
        }

        #app-grid {
            margin-top: auto;
            margin-bottom: -24px;
            /* Move 24px closer to bottom edge */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            width: 100%;
            padding: 20px;
        }

        .app-row {
            display: flex;
            justify-content: center;
            gap: 22px;
            width: 100%;
            position: relative;
        }

        /* iPhone-style blur dock container */
        .app-dock-blur {
            position: absolute;
            top: -20px;
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 370px;
            /* 4 apps (240px) + 3 gaps (66px) + 32px left + 32px right = 370px */
            background-color: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: -1;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .app-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }

        .app-icon .icon-bg {
            width: 65px;
            height: 65px;
            border-radius: 18px;
            background-color: rgb(247, 247, 247);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 32px;
            margin-bottom: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            /* transition: transform 0.2s ease; - Removed to disable tap feedback */
            overflow: hidden;
            opacity: 1;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .app-icon:active .icon-bg {
            /* Tap feedback removed */
        }

        .app-icon .icon-bg img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .app-icon .label {
            color: white;
        }

        .form-container,
        .list-container {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        /* Specific alignment fix for appearance settings screen only */
        #appearance-settings-screen .form-group label {
            margin-left: -20px;
        }

        /* Toggle Switch Component */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent-color);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        #world-book-content-input {
            height: calc(100% - 120px);
        }

        .form-button {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .form-button-secondary {
            background-color: #f0f0f0;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        /* Toggle switch styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked+.toggle-slider {
            background-color: var(--accent-color);
        }

        input:checked+.toggle-slider:before {
            transform: translateX(22px);
        }

        #wallpaper-screen .form-container {
            align-items: center;
        }

        /* App icon customization styles */
        #app-icon-customization-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: calc(100vw - 40px);
            margin-left: -20px;
            margin-right: -20px;
        }

        .app-icon-item {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--secondary-bg);
            box-sizing: border-box;
        }

        .app-icon-preview {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .app-icon-preview img {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            object-fit: cover;
        }

        .app-icon-preview span {
            font-weight: 500;
            color: var(--text-primary);
        }

        .app-icon-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background: var(--primary-bg);
            color: var(--text-primary);
            box-sizing: border-box;
        }

        .app-icon-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .app-icon-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .app-icon-btn.primary {
            background: var(--accent-color);
            color: white;
        }

        .app-icon-btn.secondary {
            background: #6c757d;
            color: white;
        }

        #wallpaper-preview {
            width: 180px;
            height: 320px;
            border: 2px dashed var(--border-color);
            background-color: #f0f2f5;
            margin-bottom: 20px;
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-secondary);
        }

        #wallpaper-upload-input {
            display: none;
        }

        /* ‰øÆÊîπÂêéÁöÑ #world-book-list Ê†∑Âºè */
        #world-book-list {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--secondary-bg);
            padding-top: 60px;
            margin-top: -60px;
        }

        /* ‰øÆÊîπÂêéÁöÑ #chat-list Ê†∑ÂºèÔºåÂéªÊéâ‰∫Ü padding Âíå margin */
        #chat-list {
            flex-grow: 1;
            background-color: var(--secondary-bg);
            padding-top: 52px;
            padding-bottom: 50px;
            /* ‰∏∫Â∫ïÈÉ®ÂØºËà™Ê†èÁïôÂá∫Á©∫Èó¥ */
            box-sizing: border-box;
        }

        .list-item {
            display: flex;
            flex-direction: column;
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .list-item:hover {
            background-color: #f5f5f5;
        }

        .list-item.no-hover:hover {
            background-color: transparent;
        }

        .list-item .item-title {
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .list-item .item-content {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .list-item.loading {
            opacity: 0.5 !important;
            pointer-events: none !important;
            position: relative;
        }

        /* Loading Hourglass for World Book */
        .worldbook-loading-hourglass {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            z-index: 10;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }



        .chat-list-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .chat-list-item:hover {
            background-color: #f5f5f5;
        }

        .chat-list-item .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
            background-color: #ccc;
        }

        .chat-list-item .info {
            flex-grow: 1;
            overflow: hidden;
        }

        .chat-list-item .name-line {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 2px;
        }

        .chat-list-item .name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .chat-list-item .group-tag {
            font-size: 10px;
            color: var(--accent-color);
            background-color: #e7f3ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .chat-list-item .last-msg {
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* max-width Â∞ÜÁî±flexboxËá™Âä®ÁÆ°ÁêÜÔºå‰∏çÂÜçÈúÄË¶ÅÂõ∫ÂÆöÂÄº */
        }

        /* ---„ÄêÂÖ®Êñ∞„ÄëÂè≥‰æßÂÖÉ‰ø°ÊÅØÂå∫ÔºöÊó∂Èó¥ÂíåÁä∂ÊÄÅÁÅØ --- */
        .chat-list-item .meta {
            margin-left: 10px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            /* ÂÜÖÈÉ®ÂÖÉÁ¥†Èù†Âè≥ÂØπÈΩê */
        }

        .chat-list-item .timestamp {
            font-size: 12px;
            color: #b0b0b0;
            margin-bottom: 8px;
        }

        .chat-list-item .status-light {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .chat-list-item .status-light.unread {
            background-color: #ff3b30;
            /* Á∫¢Ëâ≤ */
        }

        .chat-list-item .status-light.generating {
            background-color: #ffcc00;
            /* ÈªÑËâ≤ */
            animation: pulse 1.5s infinite;
        }

        /* Pinned chat styling */
        .chat-list-item.pinned {
            background-color: #f8f9fa;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.4;
            }

            100% {
                opacity: 1;
            }
        }

        #chat-interface-screen {
            background-size: cover;
            background-position: center;
            position: relative;
        }

        #selection-cancel-btn,
        #selection-delete-btn {
            font-size: 16px;
            color: var(--accent-color);
            cursor: pointer;
            padding: 5px;
        }

        #selection-delete-btn {
            color: #ff3b30;
        }

        /* ‚ñº‚ñº‚ñº Áî®ËøôÂùó‰ª£Á†ÅÊõøÊç¢Êéâ‰Ω†ÂéüÊù•ÁöÑ #chat-messages Ê†∑Âºè ‚ñº‚ñº‚ñº */
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            /* Ê†∏ÂøÉ‰øÆÊ≠£1: Âº∫Âà∂Á¶ÅÊ≠¢Ê∞¥Âπ≥ÊªöÂä®/ÊãñÂä® */
            padding: 10px 15px;
            /* Ê†∏ÂøÉ‰øÆÊ≠£2: Â∞ÜÂ∑¶Âè≥ÂÜÖËæπË∑ùÂ¢ûÂä†Âà∞15pxÔºåÊèê‰æõÊõ¥Â§öÂëºÂê∏Á©∫Èó¥ */
            padding-top: 110px;
            margin-top: -80px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-sizing: border-box;
            /* Á°Æ‰øùÂÜÖËæπË∑ùËÆ°ÁÆóÊ≠£Á°Æ */
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        #load-more-btn {
            text-align: center;
            padding: 10px;
            color: var(--accent-color);
            font-size: 14px;
            cursor: pointer;
            background-color: transparent;
            border: none;
            width: 100%;
        }

        #load-more-btn:hover {
            text-decoration: underline;
        }

        .sender-name {
            font-size: 11px;
            color: #666;
            margin-bottom: 3px;
        }

        .message-wrapper.ai .sender-name {
            margin-left: 50px;
            /* Á®çÂæÆË∞ÉÊï¥Ôºå‰∏éÂ§¥ÂÉèÂØπÈΩê */
            margin-bottom: 3px;
            position: absolute;
            /* ËÆ©ÂÆÉËÑ±Á¶ªÊµÅÔºåÈÅøÂÖçÂΩ±ÂìçÊ∞îÊ≥°ÂØπÈΩê */
            top: -16px;
            /* ÂÆö‰ΩçÂà∞Ê∞îÊ≥°‰∏äÊñπ */
            left: 0;
        }

        /* === „ÄêÂÖ®Êñ∞„ÄëÊ∂àÊÅØÂ∏ÉÂ±Ä‰∏éÊó∂Èó¥Êà≥Ê†∑Âºè === */

        /* 1. Ê∂àÊÅØÂçïÂÖÉÁöÑÊÄªÂÆπÂô® (ÈáçÊûÑ) */
        .message-wrapper {
            display: flex;
            /* ‰ΩøÁî®FlexÂ∏ÉÂ±Ä */
            gap: 8px;
            /* Ê∞îÊ≥°ÂíåÊó∂Èó¥Êà≥‰πãÈó¥ÁöÑÈó¥Ë∑ù */
            align-items: flex-end;
            /* Ê†∏ÂøÉÔºöËÆ©Ê∞îÊ≥°ÂíåÊó∂Èó¥Êà≥Â∫ïÈÉ®ÂØπÈΩê */
            position: relative;
            max-width: 90%;
            /* ÂèØ‰ª•Á®çÂæÆÊîæÂÆΩ‰∏ÄÁÇπÔºåÂõ†‰∏∫Êó∂Èó¥Êà≥Áé∞Âú®Âú®Â§ñÈù¢‰∫Ü */
        }

        /* 2. AIÊ∂àÊÅØÂçïÂÖÉÈù†Â∑¶ */
        .message-wrapper.ai {
            align-self: flex-start;
            flex-direction: row;
            /* Â§¥ÂÉè„ÄÅÊ∞îÊ≥°„ÄÅÊó∂Èó¥Êà≥Ôºå‰ªéÂ∑¶Âà∞Âè≥ÊéíÂàó */
        }

        /* 3. Áî®Êà∑Ê∂àÊÅØÂçïÂÖÉÈù†Âè≥ */
        .message-wrapper.user {
            align-self: flex-end;
            flex-direction: row-reverse;
            /* Êó∂Èó¥Êà≥„ÄÅÊ∞îÊ≥°„ÄÅÂ§¥ÂÉèÔºå‰ªéÂè≥Âà∞Â∑¶ÊéíÂàó */
        }

        /* 4. Ê∞îÊ≥°ÂíåÂ§¥ÂÉèÁöÑÁõ¥Êé•ÂÆπÂô® (‰øùÊåÅ‰∏çÂèò) */
        .message-bubble {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            max-width: 100%;
        }

        .timestamp {
            /* ÁßªÈô§ÊóßÁöÑ position: absolute */
            font-size: 11px;
            color: #999;
            text-shadow: 0 0 3px rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            /* Èò≤Ê≠¢Êó∂Èó¥Êç¢Ë°å */
            margin-bottom: 5px;
            /* ËÆ©ÂÆÉÂíåÊ∞îÊ≥°Â∫ïÈÉ®ÊúâËΩªÂæÆÁöÑÂØπÈΩêÂÅèÁßªÔºåÊõ¥ÁæéËßÇ */
            flex-shrink: 0;
            /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
        }

        .message-bubble.selected::after {
            content: '‚úî';
            position: absolute;
            left: -10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: var(--accent-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .message-bubble.user.selected::after {
            left: auto;
            right: -10px;
        }

        .message-bubble.user {
            flex-direction: row-reverse;
        }

        #typing-indicator {
            align-self: flex-start;
            display: none;
            margin: 0 10px 10px;
            color: var(--text-secondary);
        }

        #meetup-typing-indicator {
            align-self: center;
            display: none;
            margin: 0 10px 10px;
            color: var(--text-secondary);
            font-size: 14px;
            opacity: 0.7;
            text-align: center;
        }

        #chat-input-area {
            flex-shrink: 0;
            padding: 8px;
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        /* ÂõûÂ§çÈ¢ÑËßàÊ†èÊ†∑Âºè */
        #reply-preview-bar {
            display: none;
            background-color: #f0f0f0;
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 3px solid var(--accent-color);
            justify-content: space-between;
            align-items: flex-start;
        }

        #reply-preview-bar .reply-preview-content {
            flex-grow: 1;
        }

        #reply-preview-bar .sender {
            font-size: 12px;
            color: var(--accent-color);
            font-weight: 600;
            margin-bottom: 2px;
        }

        #reply-preview-bar .text {
            font-size: 14px;
            color: var(--text-secondary);
            max-height: 40px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #reply-preview-bar #cancel-reply-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: 8px;
        }

        #chat-input-main-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            width: 100%;
        }

        #chat-input {
            flex-grow: 1;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            background-color: var(--secondary-bg);
            font-size: 16px;
            max-height: 100px;
            resize: none;
        }

        .action-button {
            border: none;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        #send-btn {
            background-color: var(--accent-color);
            height: 40px;
            padding: 0 15px;
        }

        .modal {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .modal.visible {
            display: flex;
        }

        .modal-content {
            width: 90%;
            max-height: 90%;
            background-color: white;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .modal-header {
            padding: 15px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .modal-body {
            padding: 15px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-around;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .modal-footer button {
            width: 45%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--accent-color);
            cursor: pointer;
            font-size: 16px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .modal-footer .save {
            background-color: var(--accent-color);
            color: white;
        }

        .modal-footer .cancel {
            background-color: white;
            color: var(--accent-color);
        }

        .avatar-upload {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar-upload img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #eee;
        }

        .avatar-upload button {
            padding: 8px 12px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
        }

        #open-persona-library-btn {
            font-size: 14px;
            padding: 6px 10px;
            margin-left: auto;
        }

        .avatar-upload input[type="file"] {
            display: none;
        }

        /* Border Preview Component */
        .border-preview-container {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
            margin-right: 15px;
        }

        .border-preview {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .no-border-text {
            font-size: 12px;
            color: #999;
            text-align: center;
        }

        .theme-selector label {
            display: inline-flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 5px;
            cursor: pointer;
        }

        #reset-theme-btn {
            background: none;
            border: 1px solid #ccc;
            color: #555;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        #group-members-settings {
            display: flex;
            overflow-x: auto;
            padding-bottom: 10px;
            gap: 15px;
        }

        .member-editor {
            text-align: center;
            cursor: pointer;
        }

        .member-editor img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            background-color: #eee;
            margin-bottom: 5px;
        }

        .member-editor .member-name {
            font-size: 12px;
        }

        #notification-bar {
            position: absolute;
            top: 40px;
            left: 50%;
            width: 90%;
            z-index: 500;
            background-color: rgba(250, 250, 250, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transform: translateX(-50%) translateY(-150%);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            visibility: hidden;
        }

        #notification-bar.visible {
            /* ÂÖ≥ÈîÆÔºöÂú®YËΩ¥ÂõûÂà∞Âéü‰ΩçÁöÑÂêåÊó∂Ôºå‰øùÊåÅXËΩ¥ÁöÑÂ±Ö‰∏≠ÂèòÊç¢ */
            transform: translateX(-50%) translateY(0);
            visibility: visible;
        }

        #notification-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }

        #notification-content .name {
            font-weight: 600;
            font-size: 15px;
            color: #000;
        }

        #notification-content .message {
            font-size: 14px;
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }

        .sticker-image {
            max-width: 100px;
            max-height: 100px;
            display: block;
            object-fit: contain;
        }

        /* Enhanced sticker bubble styles - completely immune to custom bubble CSS */
        .message-bubble.is-sticker {
            background: none !important;
            border: none !important;
            box-shadow: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            padding: 0 !important;
            margin: 0 !important;
            border-radius: 0 !important;
        }

        .message-bubble.is-sticker .content,
        .message-bubble.is-voice-message .content {
            padding: 0 !important;
            background-color: transparent !important;
            box-shadow: none !important;
            border: none !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            border-radius: 0 !important;
        }

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊí§ÂõûÊ∂àÊÅØÊ†∑Âºè ‚ñº‚ñº‚ñº */

        /* 1. Êí§ÂõûÊ∂àÊÅØÁöÑÂç†‰ΩçÁ¨¶Ê†∑Âºè */
        .recalled-message-placeholder {
            align-self: center;
            /* Â±Ö‰∏≠ÊòæÁ§∫ */
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
            cursor: pointer;
            /* ËÆ©ÂÆÉÁúãËµ∑Êù•ÂèØ‰ª•ÁÇπÂáª */
        }

        /* 2. Â§úÈó¥Ê®°Âºè‰∏ãÁöÑÈÄÇÈÖç */
        #phone-screen.dark-mode .recalled-message-placeholder {
            background-color: rgba(255, 255, 255, 0.15);
        }

        /* 3. AIÊí§ÂõûÊ∂àÊÅØÊó∂ÁöÑÂä®ÁîªÊïàÊûú */
        @keyframes recall-animation {
            from {
                opacity: 1;
                transform: scale(1);
            }

            to {
                opacity: 0;
                transform: scale(0.8);
            }
        }

        .message-wrapper.recalled-animation {
            animation: recall-animation 0.3s ease-out forwards;
        }

        /* Âº∫Âà∂Êí§ÂõûÊ∂àÊÅØÁöÑÂç†‰ΩçÁ¨¶‰∏çÊç¢Ë°åÔºåÂπ∂‰øùÊåÅÂÜÖÂÆπÂ±Ö‰∏≠ */
        .recalled-message-placeholder {
            white-space: nowrap;
            /* Ê†∏ÂøÉÔºöÁ¶ÅÊ≠¢ÊñáÊú¨Êç¢Ë°å */
            display: inline-block;
            /* ËÆ©ËÉåÊôØÊ†πÊçÆÂÜÖÂÆπËá™ÈÄÇÂ∫îÂÆΩÂ∫¶ */
            padding: 4px 12px;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êí§ÂõûÊ∂àÊÅØÊ†∑ÂºèÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ÂºïÁî®Ê∂àÊÅØÊ†∑Âºè */
        .quoted-message {
            background-color: rgba(0, 123, 255, 0.1);
            border-left: 3px solid var(--accent-color);
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .quoted-sender {
            color: var(--accent-color);
            font-weight: 600;
            margin-bottom: 2px;
        }

        .quoted-content {
            color: var(--text-secondary);
        }

        #chat-input-actions-top {
            display: flex;
            gap: 8px;
            padding: 0 5px;
        }

        .chat-action-icon-btn {
            font-size: 24px;
            padding: 0;
            width: 38px;
            height: 38px;
            line-height: 38px;
            text-align: center;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            color: var(--text-primary);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Override action-button font-size for chat action buttons */
        #chat-input-actions-top .action-button {
            font-size: 24px;
        }

        /* Ensure consistent BUTTON sizing only - no icon changes */
        #chat-input-actions-top .chat-action-icon-btn {
            width: 38px;
            height: 38px;
            box-sizing: border-box;
        }

        #sticker-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50%;
            background-color: rgba(242, 242, 247, 0.85);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            border-radius: 20px 20px 0 0;
            z-index: 200;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            visibility: hidden;
        }

        #sticker-panel.visible {
            transform: translateY(0);
            visibility: visible;
        }

        #sticker-panel-header {
            padding: 10px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        #sticker-panel-header .panel-btn {
            font-size: 16px;
            padding: 5px 10px;
            cursor: pointer;
            color: var(--accent-color);
            position: absolute;
        }

        #sticker-panel-header .panel-btn:first-child {
            left: 20px;
        }

        #sticker-panel-header .panel-btn:last-child,
        #sticker-panel-header #edit-sticker-pack-btn,
        #sticker-panel-header #exit-pack-arrange-btn {
            right: 20px;
            left: auto;
        }

        #sticker-panel-header .title {
            font-weight: 600;
        }

        #sticker-grid {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px;
        }

        .sticker-item {
            position: relative;
            aspect-ratio: 1 / 1;
            border-radius: 10px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
        }

        .sticker-item .delete-btn {
            display: none;
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            background-color: #ff3b30;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            font-size: 14px;
            cursor: pointer;
            border: 2px solid white;
        }

        /* Sticker Pack Tabs */
        #sticker-pack-tabs {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background-color: rgba(255, 255, 255, 0.3);
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
            overflow-x: auto;
            gap: 8px;
        }

        .sticker-pack-tab {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background-color: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            border: 1px solid transparent;
        }

        .sticker-pack-tab:hover {
            background-color: rgba(221, 221, 221, 0.5);
        }

        .sticker-pack-tab.active {
            background-color: #dddddd;
            border-color: transparent;
        }

        .sticker-pack-tab .pack-icon {
            font-size: 32px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sticker-pack-tab .pack-icon svg {
            width: 24px;
            height: 24px;
        }

        .sticker-pack-tab .pack-icon img {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            object-fit: cover;
        }

        .sticker-pack-tab.active .pack-icon {
            filter: none;
        }

        .sticker-pack-tab.active .pack-icon img {
            filter: none;
            border: none;
        }

        /* Add Pack Button */
        .sticker-pack-tab.add-pack-btn {
            background-color: #cccccc;
        }

        .sticker-pack-tab.add-pack-btn:hover {
            background-color: #bbbbbb;
        }

        /* Hide scrollbar for pack tabs */
        #sticker-pack-tabs::-webkit-scrollbar {
            display: none;
        }

        #sticker-pack-tabs {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Add Sticker Square */
        .add-sticker-square {
            position: relative;
            aspect-ratio: 1 / 1;
            background-color: #cccccc;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .add-sticker-square:hover {
            background-color: #bbbbbb;
        }

        .add-sticker-square svg {
            width: 24px;
            height: 24px;
            color: #666666;
        }



        #input-actions-wrapper {
            position: static;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            flex-shrink: 0;
        }

        #wait-reply-btn {
            position: static;
            bottom: auto;
            right: auto;
            width: auto;
            height: 40px;
            padding: 0 10px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            transition: opacity 0.2s, transform 0.1s;
            cursor: pointer;
        }

        #wait-reply-btn:hover {
            opacity: 0.8;
        }

        #wait-reply-btn:active {
            /* Tap feedback removed */
        }

        #wait-reply-btn img {
            height: 22px;
            display: block;
            margin: auto;
        }

        .chat-image {
            max-width: 100%;
            border-radius: 10px;
            display: block;
        }

        .qzone-post-item .chat-image {
            max-width: 50%;
            height: auto;
        }


        .message-bubble.has-image .content {
            padding: 5px;
        }

        #custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        #custom-modal-overlay.visible {
            display: flex;
            opacity: 1;
        }

        #custom-modal {
            background-color: #fff;
            width: 280px;
            border-radius: 14px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.2s ease-in-out;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        #custom-modal-overlay.visible #custom-modal {
            transform: scale(1);
        }

        .custom-modal-header {
            padding: 16px;
            font-size: 17px;
            font-weight: 600;
            text-align: center;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .custom-modal-body {
            padding: 0 16px 16px;
            text-align: center;
            font-size: 14px;
            color: #333;
            line-height: 1.5;
        }

        .custom-modal-body p {
            margin: 0;
            margin-bottom: 12px;
        }

        .custom-modal-body input {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
            box-sizing: border-box;
        }

        .custom-modal-footer {
            display: flex;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .custom-modal-footer button {
            flex: 1;
            background: none;
            border: none;
            padding: 12px;
            font-size: 17px;
            cursor: pointer;
            color: var(--accent-color);
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .custom-modal-footer button:first-child {}

        .custom-modal-footer .confirm-btn {
            font-weight: 600;
        }

        .custom-modal-footer .confirm-btn.btn-danger {
            color: #ff3b30;
        }

        #preset-actions-modal .custom-modal-footer {
            flex-direction: column;
        }

        #preset-actions-modal .custom-modal-footer button {
            width: 100%;
            border: none;
            padding: 14px;
            font-size: 18px;
        }

        #preset-actions-modal .custom-modal-footer button:last-child {
            border-bottom: none;
        }

        /* Message actions modal - vertical layout for better fit */
        #message-actions-modal .custom-modal-footer {
            flex-direction: column;
        }

        #message-actions-modal .custom-modal-footer button {
            width: 100%;
            border: none;
            padding: 14px;
            font-size: 18px;
        }

        #message-actions-modal .custom-modal-footer button:last-child {
            border-bottom: none;
        }

        /* Post actions modal - vertical layout for better fit */
        #post-actions-modal .custom-modal-footer {
            flex-direction: column;
        }

        #post-actions-modal .custom-modal-footer button {
            width: 100%;
            border: none;
            padding: 14px;
            font-size: 18px;
        }

        #post-actions-modal .custom-modal-footer button:last-child {
            border-bottom: none;
        }

        /* Comment actions modal - vertical layout for better fit */
        #comment-actions-modal .custom-modal-footer {
            flex-direction: column;
        }

        #comment-actions-modal .custom-modal-footer button {
            width: 100%;
            border: none;
            padding: 14px;
            font-size: 18px;
        }

        #comment-actions-modal .custom-modal-footer button:last-child {
            border-bottom: none;
        }

        /* Bulletin actions modal - vertical layout for better fit */
        #bulletin-actions-modal .custom-modal-footer {
            flex-direction: column;
        }

        #bulletin-actions-modal .custom-modal-footer button {
            width: 100%;
            border: none;
            padding: 14px;
            font-size: 18px;
        }

        #bulletin-actions-modal .custom-modal-footer button:last-child {
            border-bottom: none;
        }

        /* Chat actions modal - vertical layout for better fit */
        #chat-actions-modal .custom-modal-footer {
            flex-direction: column;
        }

        #chat-actions-modal .custom-modal-footer button {
            width: 100%;
            border: none;
            padding: 14px;
            font-size: 18px;
        }

        #chat-actions-modal .custom-modal-footer button:last-child {
            border-bottom: none;
        }

        .custom-multiselect {
            position: relative;
            user-select: none;
        }

        .select-box {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            background-color: #fff;
            cursor: pointer;
        }

        .select-box .selected-options-text {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: var(--text-primary);
        }

        .select-box .arrow-down {
            margin-left: auto;
            font-size: 10px;
            color: var(--text-secondary);
            transition: transform 0.2s;
        }

        .select-box.expanded .arrow-down {
            transform: rotate(180deg);
        }

        .checkboxes-container {
            display: none;
            position: absolute;
            /* Ê†∏ÂøÉ‰øÆÊîπÔºö‰∏çÂÜç‰ΩøÁî® topÔºåËÄåÊòØÁî® margin-top Êù•ÂàõÈÄ†Èó¥Ë∑ùÔºåÊõ¥Á®≥ÂÆö */
            top: 100%;
            margin-top: 5px;
            /* <-- Êñ∞Â¢ûÔºöÂêë‰∏ãÊé®ÂºÄ5ÂÉèÁ¥†ÁöÑË∑ùÁ¶ª */
            left: 0;
            right: 0;
            max-height: 150px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            z-index: 101;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .checkboxes-container.visible {
            display: block;
        }

        .checkboxes-container label {
            display: block;
            padding: 10px 12px;
            cursor: pointer;
            font-weight: normal;
            color: var(--text-primary);
        }

        .checkboxes-container label {
            display: block;
            padding: 12px 15px;
            /* <-- ‰øÆÊîπÔºöÂ¢ûÂä†‰∫Ü‰∏ä‰∏ãÂíåÂ∑¶Âè≥ÁöÑÂÜÖËæπË∑ùÔºåËÆ©ÊØè‰∏ÄË°åÊõ¥È´òÊõ¥ÂÆΩ */
            cursor: pointer;
            font-weight: normal;
            color: var(--text-primary);
            font-size: 15px;
            /* <-- Êñ∞Â¢ûÔºöÂ∞ÜÂ≠ó‰ΩìÂ§ßÂ∞è‰ªéÈªòËÆ§ÂÄºÊîæÂ§ßÂà∞15px */
        }

        .checkboxes-container input {
            margin-right: 10px;
            vertical-align: middle;
        }

        .bg-upload-container {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .bg-preview-img {
            max-width: 120px;
            max-height: 80px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            object-fit: cover;
            display: none;
        }

        #remove-bg-btn {
            padding: 8px 12px;
            border: 1px solid #ff3b30;
            color: #ff3b30;
            background-color: #fff;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            display: none;
        }

        .message-bubble.is-ai-image .content {
            padding: 5px;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        .ai-generated-image {
            max-width: 180px;
            border-radius: 12px;
            display: block;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .ai-generated-image:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .voice-message-body {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            min-width: 80px;
            max-width: 200px;
        }

        .voice-waveform {
            display: flex;
            align-items: center;
            height: 20px;
            gap: 2px;
            flex-grow: 1;
            margin: 0 10px;
        }

        .voice-waveform div {
            width: 3px;
            background-color: currentColor;
            border-radius: 2px;
            animation: wave-quiet 1.5s ease-in-out infinite;
        }

        @keyframes wave-quiet {

            0%,
            100% {
                height: 2px;
            }

            50% {
                height: 10px;
            }
        }

        .voice-waveform div:nth-child(2) {
            animation-delay: 0.2s;
        }

        .voice-waveform div:nth-child(3) {
            animation-delay: 0.4s;
        }

        .voice-waveform div:nth-child(4) {
            animation-delay: 0.6s;
        }

        .voice-waveform div:nth-child(5) {
            animation-delay: 0.8s;
        }

        .voice-duration {
            /* --- Ê†∏ÂøÉ‰øÆÊ≠£ --- */
            font-size: var(--chat-font-size, 13px);
            /* --- ‰øÆÊ≠£ÁªìÊùü --- */
            font-weight: 500;
            color: var(--text-secondary);
        }


        /* ‚ñº‚ñº‚ñº „ÄêËØ≠Èü≥Ê∂àÊÅØ‰ºòÂåñ¬∑ÊúÄÁªàÊ†∑Âºè v3„ÄëÁ≤òË¥¥Âà∞ËøôÈáå ‚ñº‚ñº‚ñº */
        /* 1. ‰ΩøËØ≠Èü≥Ê∞îÊ≥°ÂÜÖÂÆπÂûÇÁõ¥ÊéíÂàóÔºåÁ°Æ‰øùËØ≠Èü≥Êù°ÂíåÊñáÂ≠óÂå∫Á≠âÂÆΩ (Êó†ÂèòÂåñ) */
        .is-voice-message .content {
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        /* 2. ËØ≠Èü≥Ê∂àÊÅØ‰∏ª‰ΩìÊ†∑Âºè (Êó†ÂèòÂåñ) */
        .voice-message-body {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
        }

        .message-bubble.user .voice-message-body {
            flex-direction: row-reverse;
        }

        /* 3. Ê≥¢ÂΩ¢ÂÆπÂô®Ôºö„ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂ¢ûÂä† justify-content ‰ΩøÂÖ∂ÂùáÂåÄÂàÜÂ∏É */
        .voice-waveform {
            display: flex;
            align-items: center;
            height: 20px;
            gap: 2px;
            flex-grow: 1;
            margin: 0 10px;
            /* ÊÇ®ÂèØ‰ª•ÈöèÊó∂Ë∞ÉÊï¥Ê≠§Â§ÑÁöÑ 10px */
        }

        /* 4. Ê≥¢ÂΩ¢Êú¨Ë∫´ (Êó†ÂèòÂåñ) */
        .voice-waveform div {
            width: 3px;
            background-color: currentColor;
            border-radius: 2px;
            animation: wave-quiet 1.5s ease-in-out infinite;
        }

        /* 5. Êó∂Èïø (Êó†ÂèòÂåñ) */
        .message-bubble.user .voice-duration {}

        /* 6. ËØ≠Èü≥ËΩ¨ÊñáÂ≠óÂÆπÂô®Ê†∑ÂºèÔºö„ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂ≠ó‰ΩìÂ§ßÂ∞èÊîπ‰∏∫Âä®ÊÄÅËÆ°ÁÆó */
        .voice-transcript {
            display: none;
            padding: 8px 12px;
            margin: 0 5px 5px 5px;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            font-size: calc(var(--font-size) - 1px);
            /* ‰øÆÊîπÔºöÂÖ≥ËÅîÁ≥ªÁªüÂ≠ó‰ΩìÂ§ßÂ∞è */
            color: var(--text-secondary);
            line-height: 1.5;
            background-color: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */


        /* ‚ñº‚ñº‚ñº Áî®ËøôÂùó‰ª£Á†ÅÊõøÊç¢Êéâ‰Ω†ÂéüÊù•ÁöÑ .message-bubble .content Ê†∑Âºè ‚ñº‚ñº‚ñº */
        /* ÈÄöÁî®ÂÜÖÂÆπÂå∫Ê†∑ÂºèÔºå‰∏∫Êó∂Èó¥Êà≥ÂíåÂ≠ó‰ΩìÂ§ßÂ∞èÂÅöÂáÜÂ§á */
        .message-bubble .content {
            position: relative;
            font-size: var(--chat-font-size, 16px);
            padding: 8px 12px;
            line-height: 1.5;
            word-break: break-word;
            /* Ê†∏ÂøÉ‰øÆÊ≠£: Âº∫Âà∂ÈïøÂçïËØçÊàñURLÊç¢Ë°åÔºåÈò≤Ê≠¢ÊíëÁ†¥Ê∞îÊ≥° */
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* === Ê∞îÊ≥°‰∏ªÈ¢òÊ†∑Âºè === */
        .message-bubble.user .content {
            background-color: rgba(255, 255, 255, 0.75);
            color: #585858;
            border-radius: 8px 2px 8px 8px;
        }

        .message-bubble.ai .content {
            background-color: rgba(255, 255, 255, 0.7);
            color: #585858;
            border-radius: 2px 8px 8px 8px;
        }

        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content {
            background-color: #fff0f6;
            color: #432531;
        }

        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content {
            background-color: #eff7ff;
            color: #263a4e;
        }

        #chat-messages[data-theme="blue_white"] .message-bubble.user .content {
            background-color: #eff7ff;
            color: #263a4e;
        }

        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content {
            background-color: #f8f9fa;
            color: #383d41;
        }

        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content {
            background-color: #faf7ff;
            color: #827693;
        }

        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content {
            background-color: #fffde4;
            color: #5C4033;
        }

        #chat-messages[data-theme="black_white"] .message-bubble.user .content {
            background-color: #343a40;
            color: #f8f9fa;
        }

        #chat-messages[data-theme="black_white"] .message-bubble.ai .content {
            background-color: #f8f9fa;
            color: #343a40;
        }

        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content {
            background-color: #FFEB3B;
            color: #5D4037;
        }

        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content {
            background-color: #f8f9fa;
            color: #383d41;
        }

        #chat-messages[data-theme="red_black"] .message-bubble.user .content {
            background-color: #C62828;
            color: #FFFFFF;
        }

        #chat-messages[data-theme="red_black"] .message-bubble.ai .content {
            background-color: #212121;
            color: #FFFFFF;
        }

        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content {
            background-color: #A0D2EB;
            color: #153243;
        }

        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content {
            background-color: #FEF9E7;
            color: #5D4037;
        }

        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content {
            background-color: #fff0f6;
            color: #432531;
        }

        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content {
            background-color: #FEF9E7;
            color: #5D4037;
        }

        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content {
            background-color: #fff0f6;
            color: #a78396;
        }

        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content {
            background-color: #faf7ff;
            color: #827693;
        }

        #chat-messages[data-theme="gray_white"] .message-bubble.user .content {
            background-color: #e9ecef;
            color: #495057;
        }

        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content {
            background-color: #f8f9fa;
            color: #383d41;
        }

        #chat-messages[data-theme="blue_green"] .message-bubble.user .content {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content {
            background-color: #d4edda;
            color: #155724;
        }

        #chat-messages[data-theme="pink_white"] .message-bubble.user .content {
            background-color: #fff0f6;
            color: #a78396;
        }

        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content {
            background-color: #f8f9fa;
            color: #383d41;
        }

        #chat-messages[data-theme="pink_black"] .message-bubble.user .content {
            background-color: #F8BBD0;
            color: #5B2C6F;
        }

        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content {
            background-color: #343a40;
            color: #f8f9fa;
        }

        #chat-messages[data-theme="pink_green"] .message-bubble.user .content {
            background-color: #F8BBD0;
            color: #5B2C6F;
        }

        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content {
            background-color: #C8E6C9;
            color: #1B5E20;
        }

        #chat-messages[data-theme="green_black"] .message-bubble.user .content {
            background-color: #d4edda;
            color: #155724;
        }

        #chat-messages[data-theme="green_black"] .message-bubble.ai .content {
            background-color: #343a40;
            color: #f8f9fa;
        }

        #transfer-btn {
            font-weight: bold;
        }

        #transfer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        #transfer-modal.visible {
            display: flex;
        }

        .transfer-content {
            background-color: #fff0f5;
            border-radius: 20px;
            width: 290px;
            padding: 20px;
            box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3);
            text-align: center;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>');
            background-repeat: no-repeat;
            background-position: top right;
            background-size: 80px;
        }

        .transfer-header {
            font-size: 20px;
            font-weight: bold;
            color: #a35c7b;
            margin-bottom: 20px;
        }

        .transfer-input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .transfer-input-group label {
            display: block;
            font-size: 14px;
            color: #ff85b3;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .transfer-input-group input {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #ffcce0;
            background-color: #fff;
            font-size: 16px;
            box-sizing: border-box;
        }

        .transfer-input-group input:focus {
            border-color: #ff85b3;
            outline: none;
        }

        .transfer-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }

        .transfer-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            /* transition: transform 0.2s; - Removed to disable tap feedback */
        }

        .transfer-actions button:active {
            /* Tap feedback removed */
        }

        #transfer-cancel-btn {
            background-color: #ffdde9;
            color: #a35c7b;
        }

        #transfer-confirm-btn {
            background-color: #ff85b3;
            color: white;
        }

        .message-bubble.is-transfer .content {
            padding: 0;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            cursor: pointer;
        }

        .transfer-card {
            width: 200px;
            border-radius: 12px;
            padding: 12px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .transfer-card::before {
            content: 'üêæ';
            position: absolute;
            right: 10px;
            top: 5px;
            font-size: 30px;
            opacity: 0.2;
            transform: rotate(15deg);
        }

        .message-bubble.user .transfer-card {
            background: radial-gradient(circle at top left, #ffc5d5, #ff85b3);
        }

        .message-bubble.ai .transfer-card {
            background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb);
        }

        .transfer-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }

        .transfer-amount {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .transfer-note {
            font-size: 13px;
            opacity: 0.9;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
            padding-top: 8px;
            margin-top: 8px;
            word-break: break-all;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        #listen-together-btn img.rotating {
            animation: spin 2s linear infinite;
        }

        #listen-together-btn img.paused {
            animation-play-state: paused;
        }

        #music-player-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 200 !important;
            /* Lower than playlist panel (210) but higher than other elements */
            display: none;
            justify-content: center;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5) !important;
            /* Darker background to see if it appears */
        }

        #music-player-overlay.visible {
            display: flex;
        }

        /* Now Playing Bar Styles - Matching App Dock */
        .now-playing-bar {
            position: fixed;
            top: calc(var(--header-height, 60px) + 8px);
            left: 12px;
            right: 12px;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 50px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 45;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            cursor: pointer;
        }

        .now-playing-bar.hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }

        /* Home Screen Now Playing Bar - Fixed positioning */
        .home-screen-bar {
            position: fixed !important;
            top: 16px !important;
            bottom: auto !important;
            left: 50% !important;
            right: auto !important;
            transform: translateX(-50%) !important;
            width: 370px !important;
            /* Same width as the dock blur (370px) */
            margin: 0;
            z-index: 1000;
            pointer-events: auto !important;
            /* Ensure clicks work when visible */
            cursor: pointer;
        }

        .home-screen-bar.hidden {
            transform: translateX(-50%) translateY(100%);
            opacity: 0;
            pointer-events: none;
        }

        /* Only show home screen bar when on home screen */
        #home-screen:not(.active) .home-screen-bar {
            display: none;
        }

        .now-playing-content {
            display: flex;
            align-items: center;
            padding: 8px;
            box-sizing: border-box;
        }

        .np-album-art {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
        }

        .np-album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .np-album-art .default-icon {
            font-size: 20px;
            color: white;
        }

        .np-song-info {
            flex: 1;
            min-width: 0;
        }

        .np-song-title {
            font-size: 14px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1;
            margin: 0;
            padding: 0;
        }

        .np-song-artist {
            font-size: 12px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1;
            margin: 0;
            padding: 0;
        }

        .np-right-section {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .np-playback-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            margin-right: 8px;
        }

        .np-control-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            color: white;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
        }

        .np-control-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .np-control-btn.play-pause {
            width: 40px;
            height: 40px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 18px;
        }

        .np-control-btn.play-pause:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .np-partner-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            overflow: hidden;
            flex-shrink: 0;
        }

        .np-partner-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .np-progress-bar {
            position: absolute;
            bottom: 0;
            left: 28px;
            right: 28px;
            height: 2px;
            background-color: rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .np-progress-fill {
            height: 100%;
            background-color: white;
            width: 0%;
            transition: width 0.1s ease-out;
        }

        /* Album Art Rotation Animation */
        .np-album-art img.rotating {
            animation: rotate 16s linear infinite;
        }

        .home-screen-bar .np-album-art img.rotating {
            animation: rotate 16s linear infinite;
        }

        .np-album-art img.rotating.paused {
            animation-play-state: paused;
        }

        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Meetup Progress Bar Styles - Purple gradient with blur effects */
        .meetup-progress-bar {
            position: fixed;
            top: calc(var(--header-height, 60px) + 8px);
            left: 12px;
            right: 12px;
            height: 40px;
            /* 32px avatar + 4px top padding + 4px bottom padding */
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.6), rgba(118, 75, 162, 0.6));
            /* Semi-transparent purple gradient for blur effect */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 100px;
            /* Fully rounded corners on all sides */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 46;
            /* Above music bar */
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
            cursor: pointer;
        }

        /* When both meetup and music bars are visible, adjust positioning */
        .has-meetup-progress .now-playing-bar {
            top: calc(var(--header-height, 60px) + 56px);
            /* 8px + 40px (date bar height) + 8px spacing */
        }

        .meetup-progress-bar.hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }

        /* Home Screen Meetup Progress Bar */
        .meetup-progress-bar.home-screen-bar {
            position: fixed !important;
            top: 16px !important;
            bottom: auto !important;
            left: 50% !important;
            right: auto !important;
            transform: translateX(-50%) !important;
            width: 370px !important;
            margin: 0;
            z-index: 1001;
            /* Above music bar */
            pointer-events: auto !important;
            cursor: pointer;
            border-radius: 100px;
            /* Fully rounded corners on all sides */
        }

        /* When both meetup and music bars are visible on home screen, adjust music bar position */
        #home-screen.has-meetup-progress .home-screen-bar:not(.meetup-progress-bar) {
            top: 64px !important;
            /* 16px + 40px (date bar height) + 8px spacing */
        }

        .meetup-progress-bar.home-screen-bar.hidden {
            transform: translateX(-50%) translateY(-100%);
            opacity: 0;
            pointer-events: none !important;
        }

        /* Only show home screen meetup bar when on home screen */
        #home-screen:not(.active) .meetup-progress-bar.home-screen-bar {
            display: none;
        }

        .meetup-progress-content {
            display: flex;
            align-items: center;
            padding: 4px;
            /* All paddings on all sides 4px */
            box-sizing: border-box;
            height: 100%;
        }

        .meetup-ai-avatar {
            width: 32px;
            /* Increased by 8px */
            height: 32px;
            border-radius: 50%;
            overflow: hidden;
            background: linear-gradient(135deg, #f0f0f0, #e0e0e0);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }

        .meetup-ai-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .meetup-progress-info {
            flex: 1;
            min-width: 0;
        }

        .meetup-progress-text {
            font-size: 16px;
            /* Same as chat message text */
            font-weight: 500;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1;
            margin: 0;
            padding: 0;
        }

        .meetup-separator {
            color: rgba(255, 255, 255, 0.75);
            /* 75% opacity */
            font-size: 16px;
            font-weight: 500;
        }

        .meetup-clock-icon {
            display: inline-block;
            vertical-align: middle;
            margin: 0 2px 0 4px;
            /* Closer to time, normal spacing from separator */
            flex-shrink: 0;
        }

        .meetup-elapsed-text {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.75);
            /* 75% opacity */
            white-space: nowrap;
            line-height: 1;
            margin: 0;
            padding: 0;
            display: inline;
        }



        /* Chat messages offset when now playing bar is visible */
        #chat-interface-screen.has-now-playing #chat-messages {
            padding-top: 80px;
        }

        .music-player-window {
            width: calc(100% - 24px);
            margin: 0 12px;
            background-color: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #1f1f1f;
            position: relative;
        }

        #music-playlist-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #333;
        }

        #music-time-counter {
            font-size: 12px;
            color: #555;
            margin-bottom: 20px;
        }

        #music-player-song-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
            text-align: center;
        }

        #music-player-artist {
            font-size: 14px;
            color: #666;
            margin-bottom: 25px;
        }

        .music-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            width: 100%;
            margin-bottom: 30px;
        }

        .music-controls button {
            background: none;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            color: #333;
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            /* transition: transform 0.2s; - Removed to disable tap feedback */
        }

        .music-controls button:active {
            /* Tap feedback removed */
        }

        .music-controls .play-pause-btn {
            font-size: 24px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, 0.05);
        }

        .music-bottom-actions {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .music-bottom-actions button {
            flex: 1;
            padding: 12px 0;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
        }

        #music-exit-btn {
            background-color: rgba(255, 100, 100, 0.7);
            color: white;
            margin-right: 5px;
        }

        #music-return-btn {
            background-color: rgba(0, 123, 255, 0.7);
            color: white;
            margin-left: 5px;
        }

        #music-playlist-panel {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70%;
            background-color: rgba(242, 242, 247, 0.9);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid var(--border-color);
            border-radius: 20px 20px 0 0;
            z-index: 210;
            display: flex;
            flex-direction: column;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            visibility: hidden;
        }

        #music-playlist-panel.visible {
            transform: translateY(0);
            visibility: visible;
        }

        .playlist-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }

        .playlist-header .panel-btn {
            font-size: 16px;
            cursor: pointer;
            color: var(--accent-color);
        }

        .playlist-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .playlist-item {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .playlist-item.playing {
            background-color: rgba(0, 123, 255, 0.1);
        }

        .playlist-item-info .title {
            font-weight: 500;
            font-size: 15px;
        }

        .playlist-item-info .artist {
            font-size: 12px;
            color: #666;
        }

        .playlist-item .delete-track-btn {
            color: #ff3b30;
            font-size: 20px;
            padding: 5px;
        }

        /* Persona Library Styles */
        #persona-library-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 10px;
        }

        .persona-preset-item {
            aspect-ratio: 1 / 1;
            border-radius: 12px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .persona-preset-item:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .modal-header .action-button {
            font-size: 16px;
            color: var(--accent-color);
            font-weight: 600;
            cursor: pointer;
            background: none;
            border: none;
            padding: 5px;
        }

        /* Battery Alert Modal Styles */
        #battery-alert-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #battery-alert-modal.visible {
            display: flex;
            opacity: 1;
        }

        .battery-alert-content {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            width: 280px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
            padding: 20px;
            cursor: pointer;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        #battery-alert-modal.visible .battery-alert-content {
            transform: scale(1);
        }

        #battery-alert-image {
            max-width: 100px;
            max-height: 100px;
            margin-bottom: 15px;
        }

        #battery-alert-text {
            font-size: 16px;
            font-weight: 500;
            color: #333;
            margin: 0;
            line-height: 1.4;
        }

        /* ËøôÊòØ‰Ω†Ë¶ÅÊ∑ªÂä†ÁöÑÊñ∞Ê†∑Âºè */
        #font-preview {
            transition: font-family 0.3s ease;
        }

        /* === ËÅäÂ§©ÂàóË°®ÁïåÈù¢Êñ∞Â¢ûÊ†∑Âºè (ËøôÊòØÊñ∞Ê∑ªÂä†ÁöÑ) === */
        #chat-list-screen {}

        .chat-list-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1;
        }

        .chat-list-view.active {
            opacity: 1;
            visibility: visible;
            z-index: 2;
        }

        #messages-view {
            overflow-y: auto;
        }

        /* Â∫ïÈÉ®ÂØºËà™Ê†èÊ†∑Âºè */
        #chat-list-bottom-nav {
            position: absolute;
            /* ËÆ©ÂÆÉÂõ∫ÂÆöÂú®Â∫ïÈÉ® */
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 15;
            /* Á°Æ‰øùÂÆÉÂú®ËßÜÂõæ‰πã‰∏ä */
            display: flex;
            border-top: 1px solid var(--border-color);
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .nav-item {
            flex: 1;
            text-align: center;
            padding: 12px 0;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item.active {
            color: var(--accent-color);
            font-weight: 600;
        }

        /* === Âä®ÊÄÅÁïåÈù¢ (QZone) Ê†∑Âºè (ËøôÊòØÊñ∞Ê∑ªÂä†ÁöÑ) === */
        #qzone-screen {
            background-color: #f0f2f5;
        }

        .qzone-header {
            /* position: absolute;  <-- ÊääËøô‰∏™ÊîπÊàê relative */
            position: relative;
            z-index: 10;
            /* z-index ‰øùÊåÅÔºåÊàñËÄÖÂèØ‰ª•Êõ¥È´ò */
            flex-shrink: 0;
            /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
            padding: 15px 12px;
            padding-top: 16px;
            background-color: rgba(247, 247, 247, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
        }

        .qzone-header .back-btn {
            font-size: 24px;
            cursor: pointer;
            color: var(--accent-color);
            margin-left: 8px;
            /* Add spacing to match other screens */
        }

        .qzone-header .ai-post-btn {
            position: absolute;
            right: 20px;
            font-size: 20px;
            cursor: pointer;
            color: var(--accent-color);
            transition: opacity 0.2s;
        }

        .qzone-header .ai-post-btn:hover {
            opacity: 0.8;
        }

        /* Position the add button (first ai-post-btn) */
        .qzone-header #qzone-add-post-btn {
            right: 72px;
        }

        /* Position the AI button (second ai-post-btn) */
        .qzone-header #ai-post-btn {
            right: 20px;
        }

        .qzone-header span:nth-child(2) {
            /* "Â•ΩÂèãÂä®ÊÄÅ"ÊñáÂ≠ó */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .qzone-content {
            flex-grow: 1;
            overflow-y: auto;
            /* padding-top: 80px;  <-- Âà†Èô§Ëøô‰∏™ÔºåÂõ†‰∏∫header‰∏çÂÜçÊòØabsolute‰∫Ü */
        }

        .qzone-profile-header {
            position: relative;
            margin-bottom: 20px;
        }

        .qzone-banner-container {
            width: 100%;
            height: 240px;
            /* ËÉåÊôØÊùøÈ´òÂ∫¶ */
            position: relative;
        }

        #qzone-banner-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .qzone-user-info {
            position: absolute;
            bottom: -40px;
            /* ËÆ©Â§¥ÂÉèÂíåÊòµÁß∞Âå∫ÂüüÂêë‰∏ãÂÅèÁßªÔºå‰∏ÄÂçäÂú®ËÉåÊôØÊùøÂÜÖÔºå‰∏ÄÂçäÂú®Â§ñ */
            left: 18px;
            display: flex;
            align-items: flex-start;
            /* Changed from center to flex-start to allow independent positioning */
            gap: 12px;
        }

        .qzone-user-text {
            display: flex;
            flex-direction: column;
            gap: 26px;
            padding-top: 16px;
            transform: translateY(4px);
        }

        .qzone-avatar-container {
            position: relative;
            flex-shrink: 0;
            width: 92px;
            height: 92px;
        }

        #qzone-avatar-img {
            width: 92px;
            height: 92px;
            border-radius: 50%;
            object-fit: cover;
            transform: translateY(2px);
            box-shadow: 0 0 0 2px #f0f2f5;
        }

        /* QZone avatar with frame support - overlay approach */
        #qzone-avatar-container .avatar {
            width: 92px;
            height: 92px;
            border-radius: 50%;
            object-fit: cover;
            transform: translateY(2px);
            box-shadow: 0 0 0 2px #f0f2f5;
        }

        /* When borders are enabled, decrease avatar size by 16px but keep container size */
        #qzone-avatar-container.borders-enabled #qzone-avatar-img,
        #qzone-avatar-container.borders-enabled .avatar {
            width: 76px;
            height: 76px;
            /* Center the smaller avatar within the same container */
            position: relative;
            left: 8px;
            top: 10px;
            transform: translateY(0px);
            /* Reset transform for border mode */
        }

        .qzone-avatar-frame {
            position: absolute;
            width: 153px;
            height: 153px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 2;
        }

        /* Adjust border frame size and position when avatar is smaller */
        #qzone-avatar-container.borders-enabled .qzone-avatar-frame {
            width: 131px;
            height: 131px;
            top: calc(50% + 0px);
            /* Move border down 1px more */
        }

        #qzone-nickname {
            font-size: 20px;
            font-weight: 600;
            color: #000;
            text-shadow: 2px 2px 8px rgba(255, 255, 255, 0.9);
        }

        #qzone-status {
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        /* Only move text left when borders are enabled */
        .qzone-avatar-container.borders-enabled~.qzone-user-text #qzone-nickname {
            position: relative;
            left: -4px;
        }

        .qzone-avatar-container.borders-enabled~.qzone-user-text #qzone-status {
            position: relative;
            left: -4px;
        }

        #qzone-status:hover {
            opacity: 0.8;
        }

        /* ÁºñËæëÊåâÈíÆÁöÑÈÄöÁî®Ê†∑Âºè */
        .qzone-edit-btn {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.4);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        #change-qzone-banner-btn {
            bottom: 10px;
            right: 10px;
        }

        #change-qzone-avatar-btn {
            bottom: 5px;
            right: 5px;
        }

        #change-qzone-nickname-btn {
            font-size: 14px;
            padding: 2px 6px;
            margin-left: 5px;
            /* ‰∏éÊòµÁß∞ÁöÑÈó¥Ë∑ù */
            color: var(--text-primary);
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 5px;
            position: relative;
            /* ËÑ±Á¶ªflexÂ∏ÉÂ±ÄÁöÑÂØπÈΩê */
            bottom: 5px;
            /* ÂæÆË∞ÉÂûÇÁõ¥‰ΩçÁΩÆ */
        }

        /* === ËÆ©ÁºñËæëÂäüËÉΩÊõ¥‚ÄúÈöêÂΩ¢‚Äù === */
        #qzone-banner-container,
        #qzone-avatar-container,
        #qzone-nickname,
        #qzone-status {
            cursor: pointer;
            /* Èº†Ê†áÊÇ¨ÂÅúÊó∂ÊòæÁ§∫‰∏∫ÂèØÁÇπÂáªÊâãÂäø */
            transition: opacity 0.2s;
        }

        #qzone-banner-container:hover,
        #qzone-avatar-container:hover,
        #qzone-nickname:hover,
        #qzone-status:hover {
            opacity: 0.85;
            /* ÊÇ¨ÂÅúÊó∂Á®çÂæÆÂèòÊöóÔºåÁªôÁî®Êà∑ÂèçÈ¶à */
        }

        /* ÈöêËóèÊéâÊóßÁöÑ„ÄÅÁã¨Á´ãÁöÑÁºñËæëÊåâÈíÆ */
        .qzone-edit-btn {
            display: none;
        }

        /* === ÊéßÂà∂ Header Âíå Bottom Nav ÁöÑÊòæÈöê === */
        /* ÈªòËÆ§ÈöêËóèÂä®ÊÄÅÁïåÈù¢ÁöÑ Header */
        #qzone-screen .qzone-header {
            display: none;
        }

        /* ÂΩìÂä®ÊÄÅËßÜÂõæÊøÄÊ¥ªÊó∂ÔºåÊòæÁ§∫ÂÆÉÁöÑHeader */
        #qzone-screen.active .qzone-header {
            display: flex;
        }

        /* ÂΩìËøõÂÖ•Âä®ÊÄÅËßÜÂõæÊó∂ÔºåÈöêËóè‰∏ªHeaderÂíåÂ∫ïÈÉ®ÂØºËà™Ê†è */
        #chat-list-screen.in-qzone-view>.header,
        #chat-list-screen.in-qzone-view>#chat-list-bottom-nav {
            display: none;
        }

        .chat-list-item:first-child,
        .chat-group-container:first-child {
            margin-top: 10px;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ÊääÊâÄÊúâËøô‰∫õÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* === Âä®ÊÄÅÂäüËÉΩÊ†èÊ†∑Âºè === */
        .qzone-actions-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            margin: 50px 15px 15px 15px;
            /* ‰∏äËæπË∑ùÊõ¥Â§ßÔºå‰∏∫ÊµÆÂä®ÁöÑÂ§¥ÂÉèÁïôÂá∫Á©∫Èó¥ */
            background-color: var(--secondary-bg);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .action-item {
            flex: 1;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
            cursor: pointer;
            padding: 8px 0;
            position: relative;
        }

        /* Áî®‰º™ÂÖÉÁ¥†ÂàõÂª∫ÂàÜÈöîÁ∫ø */
        .action-item:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 1px;
            height: 20px;
            background-color: var(--border-color);
        }

        /* === Âä®ÊÄÅÂ∏ñÂ≠êÂàóË°®Ê†∑Âºè === */
        #qzone-posts-list {
            padding: 32px 15px 20px 15px;
            /* ‰∏äÊñπ32pxÈó¥Ë∑ùÔºåÂ∑¶Âè≥ÂíåÂ∫ïÈÉ®ÁïôÂá∫ËæπË∑ù */
            display: flex;
            flex-direction: column;
            gap: 20px;
            /* Â∏ñÂ≠ê‰πãÈó¥ÁöÑÈó¥Ë∑ù */
        }

        .qzone-post-item {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .post-header .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Post avatar with frame support - overlay approach */
        .post-header .avatar-container {
            position: relative;
            width: 40px;
            height: 40px;
            flex-shrink: 0;
        }

        .post-header .avatar-container .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .post-header .avatar-container .avatar-frame {
            position: absolute;
            width: 67px;
            height: 67px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 2;
        }

        .post-info {
            display: flex;
            flex-direction: column;
        }

        .post-info .post-nickname {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }

        .post-info .post-timestamp {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .post-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            /* ËÆ©Êç¢Ë°åÁ¨¶ÁîüÊïà */
            word-break: break-word;
            /* Èò≤Ê≠¢ÈïøÂçïËØçÊ∫¢Âá∫ */
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº Êñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞Êú´Â∞æ ‚ñº‚ñº‚ñº */

        /* === ÂèëÂ∏ÉÂä®ÊÄÅÊ®°ÊÄÅÊ°ÜÊ†∑Âºè === */
        #post-public-text {
            min-height: 80px;
            /* Á°Æ‰øùÊñáÊú¨ÂüüÊúâË∂≥Â§üÁöÑÈ´òÂ∫¶ */
            resize: vertical;
        }

        .post-image-preview-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            /* ‰øùÊåÅ16:9ÁöÑÈ¢ÑËßàÊØî‰æã */
            background-color: #f0f2f5;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
            /* ÈªòËÆ§ÈöêËóè */
            justify-content: center;
            align-items: center;
        }

        .post-image-preview-container.visible {
            display: flex;
            /* ‰∏ä‰º†ÂêéÊòæÁ§∫ */
        }

        #post-image-preview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 6px;
        }

        #post-remove-image-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: #ff3b30;
            color: white;
            border: 2px solid white;
            font-size: 16px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
        }

        .post-image-upload-options {
            display: flex;
            gap: 10px;
        }

        .post-image-upload-options button {
            flex: 1;
            margin-top: 0;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËÉ∂ÂõäÂºÄÂÖ≥Ê†∑Âºè - ËØ∑Â∞ÜËøôÊÆµCSSÁ≤òË¥¥Âà∞Ê†∑ÂºèË°®Êú´Â∞æ ‚ñº‚ñº‚ñº */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 51px;
            height: 31px;
            flex-shrink: 0;
            /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .toggle-switch .slider:before {
            position: absolute;
            content: "";
            height: 27px;
            width: 27px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
        }

        .toggle-switch input:checked+.slider {
            background-color: var(--accent-color);
        }

        .toggle-switch input:focus+.slider {
            box-shadow: 0 0 1px var(--accent-color);
        }

        .toggle-switch input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* ÂúÜËßíÊ†∑Âºè */
        .toggle-switch .slider.round {
            border-radius: 34px;
        }

        .toggle-switch .slider.round:before {
            border-radius: 50%;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº Êñ∞Ê†∑Âºè ‚ñº‚ñº‚ñº */

        /* === ÂèëÂ∏ÉÂä®ÊÄÅÊ®°ÊÄÅÊ°Ü - Ê®°ÂºèÂàáÊç¢Ê†∑Âºè === */
        .post-mode-switcher {
            display: flex;
            margin-bottom: 20px;
            background-color: #e9ecef;
            border-radius: 8px;
            padding: 4px;
        }

        .mode-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background-color: transparent;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        .mode-btn.active {
            background-color: var(--secondary-bg);
            color: var(--text-primary);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .post-mode-content {
            display: none;
            /* ÈªòËÆ§ÈÉΩÈöêËóè */
        }

        .post-mode-content.active {
            display: block;
            /* ÊøÄÊ¥ªÁöÑÊâçÊòæÁ§∫ */
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* === Áõ∏ÂÜåÈ°µÈù¢ËÉåÊôØËâ≤ === */
        #album-screen {
            background-color: #f0f2f5;
            /* ‰ΩøÁî®‰∏Ä‰∏™ÊüîÂíåÁöÑÊµÖÁÅ∞Ëâ≤ÔºåÊØîÁ∫ØÁôΩÊõ¥Êä§Áúº */
        }

        /* === Áõ∏ÂÜåÈ°µÈù¢ÁΩëÊ†ºÂ∏ÉÂ±Ä === */
        #album-grid-page {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            /* ÊØèË°åÊòæÁ§∫2‰∏™Áõ∏ÂÜå */
            gap: 15px;
        }

        /* === Áõ∏ÂÜåÈ°πÁõÆÊ†∑Âºè (ÁæéÂåñ) === */
        .album-item {
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border-radius: 8px;
            /* ÁªôÊï¥‰∏™È°πÁõÆ‰πüÂä†‰∏™ÂúÜËßí */
        }

        .album-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .album-cover {
            aspect-ratio: 1 / 1;
            /* ‰øùÊåÅÂ∞ÅÈù¢‰∏∫Ê≠£ÊñπÂΩ¢ */
            background-size: cover;
            background-position: center;
            border-radius: 8px;
            margin-bottom: 8px;
            background-color: #f0f2f5;
            /* Â∞ÅÈù¢Âä†ËΩΩÂâçÁöÑÂç†‰ΩçÈ¢úËâ≤ */
        }

        .album-info {
            text-align: center;
        }

        .album-name {
            font-weight: 500;
            margin: 0 0 4px 0;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            /* Èò≤Ê≠¢ÈïøÂêçÂ≠óÊç¢Ë°å */
        }

        .album-count {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 0;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÁöÑ CSS Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∫õÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* === Áõ∏ÂÜåÁÖßÁâáËØ¶ÊÉÖÈ°µ === */
        #album-photos-screen {
            background-color: #f0f2f5;
        }

        #photos-grid-page {
            padding: 15px;
            display: grid;
            /* ÊØèË°åÊòæÁ§∫3Âº†ÁÖßÁâáÔºåÂπ∂‰øùÊåÅÈó¥Ë∑ù */
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .photo-item {
            position: relative;
            /* ‰∏∫‰∫ÜÂÆö‰ΩçÂà†Èô§ÊåâÈíÆ */
            aspect-ratio: 1 / 1;
            /* ‰øùÊåÅÁÖßÁâá‰∏∫Ê≠£ÊñπÂΩ¢ */
            border-radius: 6px;
            overflow: hidden;
            /* Èò≤Ê≠¢ÂõæÁâáÊ∫¢Âá∫ÂúÜËßí */
            background-color: #e9ecef;
            /* ÂõæÁâáÂä†ËΩΩÂâçÁöÑÂç†‰ΩçÁ¨¶È¢úËâ≤ */
        }

        .photo-item .photo-thumb {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* ‰øùËØÅÂõæÁâáÂ°´Êª°ÂÆπÂô®‰∏î‰∏çÂèòÂΩ¢ */
            cursor: pointer;
        }

        /* Âà†Èô§ÊåâÈíÆÁöÑÊ†∑Âºè */
        .photo-item .photo-delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 22px;
            height: 22px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            opacity: 0;
            /* ÈªòËÆ§ÈöêËóè */
            transition: opacity 0.2s ease;
        }

        /* Èº†Ê†áÊÇ¨ÂÅúÂú®ÁÖßÁâá‰∏äÊó∂ÊòæÁ§∫Âà†Èô§ÊåâÈíÆ */
        .photo-item:hover .photo-delete-btn {
            opacity: 1;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* === ÂõæÁâáÊü•ÁúãÂô®Ê®°ÊÄÅÊ°ÜÊ†∑Âºè === */
        #photo-viewer-modal {
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 1002;
            -webkit-backdrop-filter: blur(5px);
            backdrop-filter: blur(5px);
        }

        .photo-viewer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        #photo-viewer-image {
            max-width: 90vw;
            /* ÂõæÁâáÊúÄÂ§ßÂÆΩÂ∫¶‰∏∫ËßÜÂè£ÁöÑ90% */
            max-height: 85vh;
            /* ÂõæÁâáÊúÄÂ§ßÈ´òÂ∫¶‰∏∫ËßÜÂè£ÁöÑ85% */
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            /* ‰∏∫ÂõæÁâáÁöÑÂàáÊç¢Ê∑ªÂä†‰∏ÄÁÇπÂπ≥ÊªëÁöÑÊ∑°ÂÖ•Ê∑°Âá∫ÊïàÊûú */
            transition: opacity 0.2s ease-in-out;
        }

        /* ÂÖ≥Èó≠ÊåâÈíÆ */
        #photo-viewer-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 40px;
            font-weight: 200;
            cursor: pointer;
            line-height: 1;
            text-shadow: 0 0 5px black;
        }

        /* Â∑¶Âè≥ÂØºËà™ÁÆ≠Â§¥ */
        #photo-viewer-modal .nav-arrow {
            position: absolute;
            /* Áé∞Âú®Êàë‰ª¨Áî®ÁªùÂØπÂÆö‰ΩçÊù•ÊéßÂà∂ÁÆ≠Â§¥ */
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 50px;
            /* Âú®ÊâãÊú∫Â±èÂπï‰∏äÔºåÂèØ‰ª•Á®çÂæÆÂ∞è‰∏ÄÁÇπ */
            font-weight: 100;
            cursor: pointer;
            padding: 10px;
            /* Ë∞ÉÊï¥ÂÜÖËæπË∑ù */
            user-select: none;
            transition: color 0.2s;
            z-index: 1003;
            /* Á°Æ‰øùÁÆ≠Â§¥Âú®ÊúÄ‰∏äÂ±Ç */
        }

        #photo-viewer-prev-btn {
            left: 5px;
            /* ÂÆö‰ΩçÂ∑¶ÁÆ≠Â§¥ */
        }

        #photo-viewer-next-btn {
            right: 5px;
            /* ÂÆö‰ΩçÂè≥ÁÆ≠Â§¥ */
        }

        #photo-viewer-modal .nav-arrow:hover {
            color: white;
        }

        /* ÂΩìÁÆ≠Â§¥Ë¢´Á¶ÅÁî®Êó∂ÔºàÊØîÂ¶ÇÁ¨¨‰∏ÄÂº†ÊàñÊúÄÂêé‰∏ÄÂº†Ôºâ */
        #photo-viewer-modal .nav-arrow:disabled {
            color: rgba(255, 255, 255, 0.2);
            cursor: default;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∫õÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÂùóÊñ∞CSSÊõøÊç¢Êéâ‰∏ä‰∏ÄÁâàÁöÑ‰∫§‰∫íÂå∫CSS ‚ñº‚ñº‚ñº */

        /* === Â∏ñÂ≠êÂÜÖÂÆπÂå∫ - Áõ∏ÂØπÂÆö‰ΩçÂÆπÂô® === */
        /* === Â∏ñÂ≠êÂÜÖÂÆπÂå∫ === */
        .post-main-content {
            /* ÂÆÉÁé∞Âú®Âè™ÊòØ‰∏Ä‰∏™ÊôÆÈÄöÁöÑÂÜÖÂÆπÂÆπÂô®Ôºå‰∏çÂÜçÈúÄË¶ÅÁâπÊÆäÊ†∑Âºè‰∫Ü */
        }

        /* === Â∏ñÂ≠ê‰∫íÂä®ÂõæÊ†áÂå∫ (Êñ∞Ê†∑Âºè) === */
        .post-feedback-icons {
            display: flex;
            justify-content: flex-start;
            /* ËÆ©ÂõæÊ†áÈù†Â∑¶ÂØπÈΩê */
            align-items: center;
            gap: 12px;
            padding: 8px 0;
            /* Ê†∏ÂøÉ‰øÆÊîπÔºöÁªôÂõæÊ†áÂå∫Âüü‰∏ä‰∏ãÂêÑ8pxÁöÑÁïôÁôΩ */
        }

        .action-icon {
            cursor: pointer;
            color: var(--text-secondary);
            /* ÈªòËÆ§ÁÅ∞Ëâ≤ */
            transition: all 0.2s ease-in-out;
        }

        .action-icon svg {
            width: 18px;
            height: 18px;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* ÂõæÊ†áÊøÄÊ¥ª(ÁÇπËµû/Êî∂ËóèÂêé)ÁöÑÊ†∑Âºè */
        .action-icon.active {
            color: #ff5252;
            /* ÊøÄÊ¥ªÂêéÂèòÁ∫¢Ëâ≤ */
            transform: scale(1.1);
            /* ËΩªÂæÆÊîæÂ§ß */
        }

        .action-icon.active.favorite {
            color: #ffc107;
            /* Êî∂ËóèÁî®ÈªÑËâ≤ */
        }

        .action-icon.active svg {
            fill: currentColor;
            /* ÊøÄÊ¥ªÂêéÂ°´ÂÖÖÈ¢úËâ≤ */
        }

        /* ÁÇπÂáªÊó∂ÁöÑÂä®ÁîªÊïàÊûú */
        .animate-like {
            animation: like-bounce 0.4s ease-in-out;
        }

        @keyframes like-bounce {
            0% {
                transform: scale(1);
            }

            25% {
                transform: scale(0.8);
            }

            50% {
                transform: scale(1.2);
            }

            75% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1.1);
            }
        }


        /* === Â∏ñÂ≠êÂ∫ïÈÉ®ËØÑËÆ∫Âå∫Ê†∑Âºè (Áé∞Âú®ÊòØÁã¨Á´ãÈÉ®ÂàÜ) === */
        .post-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
            /* Áî®‰∏ÄÊù°ÊµÖËâ≤Á∫øÂàÜÈöî */
            display: flex;
            align-items: center;
            gap: 8px;
            /* Ë∞ÉÊï¥Êï¥‰ΩìÈó¥Ë∑ù */
        }

        /* ËØÑËÆ∫Âå∫ÂÆπÂô® */
        .comment-section {
            flex-grow: 1;
            /* Âç†ÊçÆÂ§ßÈÉ®ÂàÜÁ©∫Èó¥ */
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comment-section .comment-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        .comment-section .comment-input {
            width: 100%;
            padding: 8px 12px;
            border: none;
            background-color: #f0f2f5;
            border-radius: 14px;
            font-size: 13px;
            outline: none;
        }

        /* Êñ∞Â¢ûÁöÑÂèëÈÄÅÊåâÈíÆÊ†∑Âºè */
        .comment-send-btn {
            flex-shrink: 0;
            /* Èò≤Ê≠¢Ë¢´ÂéãÁº© */
            padding: 8px 15px;
            border: none;
            background-color: var(--accent-color);
            color: white;
            border-radius: 14px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }

        /* AIÂõûÂ§çÊåâÈíÆÊ†∑Âºè */
        .call-ai-reply-btn {
            flex-shrink: 0;
            padding: 8px 12px;
            background-color: rgba(255, 255, 255, 0.8);
            color: #666;
            border: 1px solid #ddd;
            border-radius: 14px;
            font-size: 16px;
            cursor: pointer;
            margin-left: 5px;
            transition: all 0.2s ease;
        }

        .call-ai-reply-btn:hover {
            background-color: rgba(255, 255, 255, 1);
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        /* AIÈÄâÊã©ÂàóË°®Ê†∑Âºè */
        .ai-selection-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .ai-selection-item:hover {
            background-color: #f8f9fa;
        }

        .ai-selection-item input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
        }

        .ai-selection-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
            background-color: #eee;
        }

        .ai-selection-info {
            flex-grow: 1;
        }

        .ai-selection-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .ai-selection-status {
            font-size: 12px;
            color: #666;
        }

        /* Ë°®ÊÉÖÂåÖÈÄâÊã©ÂàóË°®Ê†∑Âºè */
        .pack-selection-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }

        .pack-selection-item:hover {
            background-color: #f8f9fa;
        }

        .pack-selection-item input[type="radio"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
        }

        .pack-selection-info {
            flex-grow: 1;
        }

        .pack-selection-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* === Êú™ËØªÊ∂àÊÅØÂ∞èÁ∫¢ÁÇπÈÄöÁî®Ê†∑Âºè === */
        .unread-indicator {
            position: absolute;
            top: -8px;
            right: -15px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background-color: #ff3b30;
            color: white;
            font-size: 11px;
            font-weight: bold;
            line-height: 18px;
            text-align: center;
            border-radius: 9px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1;
        }

        /* ËÅäÂ§©ÁïåÈù¢ËøîÂõûÊåâÈíÆ‰∏äÁöÑÂ∞èÁ∫¢ÁÇπ (Âè™ÊòæÁ§∫ÁÇπÔºå‰∏çÊòæÁ§∫Êï∞Â≠ó) */
        .back-btn-indicator {
            top: 0;
            right: -8px;
            /* ÊîæÂà∞ËøîÂõûÁÆ≠Â§¥Âè≥‰∏äËßí */
            width: 10px;
            height: 10px;
            min-width: 10px;
            padding: 0;
            border-radius: 50%;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* === ËØÑËÆ∫ÂàóË°®ÂÆπÂô® === */
        .post-comments-container {
            padding: 10px 0;
            /* ‰∏ä‰∏ãÁïôÁôΩ */
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* ËØÑËÆ∫‰πãÈó¥ÁöÑÈó¥Ë∑ù */
            font-size: 13px;
            /* Áªü‰∏ÄËØÑËÆ∫Âå∫Â≠ó‰ΩìÂ§ßÂ∞è */
        }

        /* ÊØè‰∏ÄÊù°ËØÑËÆ∫ */
        .comment-item {
            line-height: 1.5;
        }

        /* ËØÑËÆ∫ËÄÖÁöÑÂêçÂ≠óÔºåÂä†Á≤óÂπ∂‰ΩøÁî®‰∏ªÈ¢òËâ≤ */
        .comment-item .commenter-name {
            font-weight: 600;
            color: var(--accent-color);
            cursor: pointer;
            margin-right: 5px;
            /* ÂíåËØÑËÆ∫ÂÜÖÂÆπ‰πãÈó¥ÁïôÁÇπÁ©∫Èöô */
        }

        /* ËØÑËÆ∫ÂÜÖÂÆπ */
        .comment-item .comment-text {
            color: var(--text-primary);
            word-break: break-word;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* === Â∏ñÂ≠êÁÇπËµûÂå∫ÂüüÊ†∑Âºè === */
        .post-likes-section {
            display: flex;
            align-items: center;
            gap: 6px;
            /* ÂõæÊ†áÂíåÊñáÂ≠óÁöÑÈó¥Ë∑ù */
            padding: 8px 10px;
            /* ÂÜÖËæπË∑ù */
            font-size: 13px;
            color: var(--accent-color);
            /* ‰ΩøÁî®‰∏ªÈ¢òËìùËâ≤ */
            background-color: #f0f5fa;
            /* Áªô‰∏Ä‰∏™Ê∑°Ê∑°ÁöÑËÉåÊôØËâ≤ */
            border-top: 1px solid #e9eef3;
            border-bottom: 1px solid #e9eef3;
            margin-top: 5px;
            /* Âíå‰∏äÊñπÁöÑÂõæÊ†á‰øùÊåÅ‰∏ÄÁÇπË∑ùÁ¶ª */
        }

        .post-likes-section .like-icon {
            width: 16px;
            height: 16px;
            fill: currentColor;
            /* ËÆ©SVGÂõæÊ†áÁªßÊâøÁà∂ÂÖÉÁ¥†ÁöÑÈ¢úËâ≤ */
            flex-shrink: 0;
            /* Èò≤Ê≠¢ÂõæÊ†áË¢´ÂéãÁº© */
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* === @ÊèêÂèä ÂºπÂá∫ËèúÂçïÊ†∑Âºè === */
        .at-mention-popup {
            position: absolute;
            /* Áõ∏ÂØπ‰∫éÁà∂ÂÖÉÁ¥†ÂÆö‰Ωç */
            bottom: 100%;
            /* ÊòæÁ§∫Âú®ËæìÂÖ•Ê°ÜÁöÑ‰∏äÊñπ */
            left: 40px;
            /* ÂíåËæìÂÖ•Ê°ÜÂ∑¶‰æßÂØπÈΩê (ËÄÉËôë‰∫ÜÂ§¥ÂÉèÂÆΩÂ∫¶) */
            width: calc(100% - 40px);
            /* ÂÆΩÂ∫¶ÂíåËæìÂÖ•Ê°ÜÂ∑Æ‰∏çÂ§ö */
            max-height: 120px;
            overflow-y: auto;
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10;
            display: none;
            /* ÈªòËÆ§ÈöêËóè */
        }

        .at-mention-item {
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            color: var(--text-primary);
            border-bottom: 1px solid #f0f0f0;
        }

        .at-mention-item:last-child {
            border-bottom: none;
        }

        .at-mention-item:hover {
            background-color: #f5f5f5;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* ‚ñº‚ñº‚ñº ËØ∑Áî®‰∏ãÈù¢ËøôÊÆµ„ÄêÊñ∞Ê†∑Âºè„ÄëÊõøÊç¢Êéâ‰Ω†Áé∞ÊúâÁöÑ #favorites-list Ê†∑Âºè ‚ñº‚ñº‚ñº */

        /* ËÆ©Êî∂ËóèËßÜÂõæÊàê‰∏∫‰∏Ä‰∏™flexÂÆπÂô®, ‰ªé‰∏äÂà∞‰∏ãÊéíÂàó */
        #favorites-view {
            display: flex;
            flex-direction: column;
        }

        /* Á°Æ‰øùÊî∂ËóèÈ°µÁöÑheaderÈ´òÂ∫¶Âõ∫ÂÆöÔºå‰∏çË¢´ÂéãÁº© */
        #favorites-view>.header {
            flex-shrink: 0;
        }

        /* === Êî∂ËóèÂàóË°®Ê†∑Âºè (‰øÆÊ≠£Âêé) === */
        #favorites-list {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            /* <-- Êñ∞Â¢ûËøôË°åÔºåÁ¶ÅÊ≠¢Ê∞¥Âπ≥ÊªöÂä® */
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        .favorite-item-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            position: relative;
            /* ‰∏∫‰∫ÜÂÆö‰ΩçÂà†Èô§ÊåâÈíÆ */
        }

        /* Âç°ÁâáÂ§¥ÈÉ®ÔºåÂåÖÂê´Â§¥ÂÉè„ÄÅÂêçÂ≠óÂíåÊù•Ê∫ê */
        .fav-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .fav-card-header .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
        }

        .fav-card-header .info {
            flex-grow: 1;
        }

        .fav-card-header .name {
            font-weight: 600;
            font-size: 15px;
        }

        .fav-card-header .source {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Âç°ÁâáÂÜÖÂÆπ */
        .fav-card-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .fav-card-content .chat-image {
            margin-top: 8px;
            /* ÂõæÁâáÂíåÊñáÂ≠óÁöÑÈó¥Ë∑ù */
        }

        /* Âà†Èô§ÊåâÈíÆ */
        .fav-delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            background: #f0f2f5;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            color: var(--text-secondary);
            line-height: 28px;
            text-align: center;
        }

        .fav-delete-btn:hover {
            background-color: #e9ecef;
            color: #ff3b30;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* === ÊêúÁ¥¢Ê†èÊ†∑Âºè === */
        .search-bar-container {
            padding: 10px 15px;
            background-color: #f9f9f9;
            /* ÂíåÂàóË°®ËÉåÊôØËâ≤‰øùÊåÅ‰∏ÄËá¥ */
            position: relative;
            /* ‰∏∫‰∫ÜÂÆö‰ΩçÊ∏ÖÈô§ÊåâÈíÆ */
            flex-shrink: 0;
        }

        #favorites-search-input {
            width: 100%;
            padding: 10px 30px 10px 15px;
            /* Âè≥‰æßÁïôÂá∫Ê∏ÖÈô§ÊåâÈíÆÁöÑ‰ΩçÁΩÆ */
            font-size: 14px;
            border: 1px solid var(--border-color);
            border-radius: 18px;
            /* ÂúÜËßíÁü©ÂΩ¢ÔºåÊõ¥Áé∞‰ª£Âåñ */
            background-color: var(--secondary-bg);
            box-sizing: border-box;
            outline: none;
        }

        #favorites-search-input:focus {
            border-color: var(--accent-color);
        }

        .search-clear-btn {
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            background: #ccc;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* === ËÅäÂ§©ÁïåÈù¢Â§öÈÄâÊìç‰ΩúÊ†è‰ºòÂåñ === */
        #chat-interface-screen .header .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        #chat-interface-screen .selection-controls .action-btn {
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            padding: 5px;
        }

        /* === Êî∂ËóèÈ°µÈù¢Â§öÈÄâÊ®°ÂºèÊ†∑Âºè === */
        #favorites-view.selection-mode .favorite-item-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        /* ÈÄâÊã©Ê°ÜÁöÑÊ†∑Âºè */
        .favorite-item-card::before {
            content: '';
            position: absolute;
            left: -25px;
            /* ÊääÂÆÉÊîæÂú®Âç°ÁâáÂ∑¶ËæπÂ§ñÈù¢ */
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            background-color: white;
            transition: all 0.2s ease;
            opacity: 0;
            /* ÈªòËÆ§ÈöêËóè */
        }

        /* ËøõÂÖ•ÈÄâÊã©Ê®°ÂºèÊó∂ÔºåÂç°ÁâáÂêëÂè≥ÁßªÂä®ÔºåÈú≤Âá∫ÈÄâÊã©Ê°Ü */
        #favorites-view.selection-mode .favorite-item-card {
            transform: translateX(35px);
        }

        #favorites-view.selection-mode .favorite-item-card::before {
            opacity: 1;
        }

        /* ÈÄâ‰∏≠ÂêéÁöÑÊ†∑Âºè */
        #favorites-view.selection-mode .favorite-item-card.selected::before {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            content: '‚úî';
            color: white;
            font-size: 14px;
            text-align: center;
            line-height: 20px;
        }

        /* Â∫ïÈÉ®Êìç‰ΩúÊ†è (ÁªàÊûÅ‰øÆÊ≠£Áâà) */
        #favorites-action-bar {
            position: absolute;
            /* ‚òÖ Êîπ‰∏∫ absoluteÔºåÁõ∏ÂØπ‰∫é #phone-screen ÂÆö‰Ωç */
            bottom: 0;
            left: 0;
            right: 0;
            /* ‚òÖ Êñ∞Â¢û right: 0ÔºåÂíå left: 0 ‰∏ÄËµ∑ÊíëÊª°ÂÆΩÂ∫¶ */
            width: auto;
            /* ‚òÖ Êîπ‰∏∫ autoÔºåËÆ© left/right ÂÜ≥ÂÆöÂÆΩÂ∫¶ */
            padding: 10px 15px;
            padding-bottom: calc(10px + env(safe-area-inset-bottom));
            /* ÈÄÇÈÖçiPhoneÂ∫ïÈÉ®ÂÆâÂÖ®Âå∫ */
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            box-sizing: border-box;
            z-index: 5;
            display: none;
            /* max-width Â∑≤Áªè‰∏çÈúÄË¶Å‰∫ÜÔºåÂõ†‰∏∫Áà∂ÂÖÉÁ¥†Â∑≤ÁªèÈôêÂà∂‰∫ÜÂÆΩÂ∫¶ */
        }

        #favorites-action-bar .action-bar-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            background-color: #ff3b30;
            color: white;
        }

        /* === „Äê‰øÆÊ≠£„ÄëËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®Êéß‰ª∂ÂàáÊç¢ÈÄªËæë === */

        /* ÈªòËÆ§Áä∂ÊÄÅÔºöÈöêËóèÂ§öÈÄâÊéß‰ª∂ */
        #chat-interface-screen .header .selection-controls {
            display: none;
        }

        /* ÈªòËÆ§Áä∂ÊÄÅÔºöÊòæÁ§∫ÈªòËÆ§Êéß‰ª∂ÔºåÂπ∂ËÆ©ÂÆÉÊíëÊª°Êï¥‰∏™Â§¥ÈÉ® */
        #chat-interface-screen .header .default-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        /* ÂΩìËøõÂÖ•Â§öÈÄâÊ®°ÂºèÊó∂ÔºöÈöêËóèÈªòËÆ§Êéß‰ª∂ */
        #chat-interface-screen.selection-mode .header .default-controls {
            display: none;
        }

        /* ÂΩìËøõÂÖ•Â§öÈÄâÊ®°ÂºèÊó∂ÔºöÊòæÁ§∫Â§öÈÄâÊéß‰ª∂ÔºåÂπ∂ËÆ©ÂÆÉÊíëÊª°Êï¥‰∏™Â§¥ÈÉ® */
        #chat-interface-screen.selection-mode .header .selection-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* === ‰øÆÊ≠£ÔºöÊîæÂ§ßÊâÄÊúâ‰∏ªË¶ÅÁöÑ‚Äú+‚ÄùÂè∑ÊåâÈíÆ === */
        #add-chat-btn,
        #add-world-book-btn,
        #create-album-btn-page {
            font-size: 28px;
            /* ÊòæËëóÂ¢ûÂ§ßÂ≠ó‰ΩìÂ§ßÂ∞èÔºå‰ΩøÂÖ∂ËßÜËßâ‰∏ä‰∏éÊóÅËæπÁöÑÂõæÊ†áÂåπÈÖç */
            font-weight: 300;
            /* ‰ΩøÁî®Êõ¥ÁªÜÁöÑÂ≠óÈáçÔºåËÆ©Âä†Âè∑ÁúãËµ∑Êù•Êõ¥Ê∏ÖÁàΩÔºå‰∏çÊòæÁ≤óÁ¨® */
            position: relative;
            /* ÂÖÅËÆ∏ËøõË°å‰ΩçÁΩÆÂæÆË∞É */
            top: -1px;
            /* Â≠ó‰ΩìÊîæÂ§ßÂêéÔºåÈÄöÂ∏∏ÈúÄË¶ÅÁ®çÂæÆÂêë‰∏äÁßªÂä®‰∏ÄÁÇπÔºå‰ΩøÂÖ∂ËßÜËßâ‰∏äÊõ¥Â±Ö‰∏≠ */
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∫õÊñ∞Ê†∑ÂºèÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* È¢ÑËßàÂå∫ÂÆπÂô®Ê†∑Âºè */
        #settings-preview-area {
            width: 100%;
            height: 180px;
            /* Áªô‰∏Ä‰∏™Âõ∫ÂÆöÁöÑÈ´òÂ∫¶ */
            background-color: #f0f2f5;
            border-radius: 8px;
            padding: 15px;
            box-sizing: border-box;
            overflow: hidden;
            /* Èò≤Ê≠¢ÂÜÖÂÆπÊ∫¢Âá∫ */
            display: flex;
            flex-direction: column;
            gap: 10px;
            /* È¢ÑËßàÊ∞îÊ≥°‰πãÈó¥ÁöÑÈó¥Ë∑ù */
            border: 1px solid var(--border-color);
            position: relative;
            /* ‰∏∫‰∫ÜÂÆö‰ΩçËÉåÊôØ */
        }

        /* È¢ÑËßàÂå∫ÁöÑËÉåÊôØÔºåÂèØ‰ª•ÂíåÁúüÂÆûËÅäÂ§©ÁïåÈù¢ÂêåÊ≠• */
        #settings-preview-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 1;
            opacity: 0.8;
        }

        /* ËÆ©È¢ÑËßàÊ∞îÊ≥°Âú®ËÉåÊôØ‰πã‰∏ä */
        #settings-preview-area .message-wrapper {
            position: relative;
            z-index: 2;
        }

        /* È¢ÑËßàÂå∫ÂÜÖ‰ΩøÁî®ÁöÑÂ§¥ÂÉèË¶ÅÂ∞è‰∏ÄÁÇπ */
        #settings-preview-area .message-bubble .avatar {
            width: 30px;
            height: 30px;
        }

        #settings-preview-area .avatar-with-frame {
            width: 30px;
            height: 30px;
        }

        #settings-preview-area .avatar-with-frame .avatar-frame {
            width: 44px;
            height: 44px;
            top: -7px;
            left: -7px;
        }

        #settings-preview-area .message-bubble .timestamp {
            display: none;
            /* È¢ÑËßàÂå∫‰∏çÈúÄË¶ÅÊòæÁ§∫Êó∂Èó¥Êà≥ */
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞CSSÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        .existing-group-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .existing-group-item .group-name {
            font-weight: 500;
        }

        .existing-group-item .delete-group-btn {
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞CSSÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */
        .chat-group-container {
            border-bottom: 1px solid var(--border-color);
        }

        .chat-group-container:first-child {
            border-top: 1px solid var(--border-color);
        }

        .chat-group-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            background-color: #f7f7f7;
        }

        .chat-group-header .arrow {
            font-size: 14px;
            margin-right: 8px;
            transition: transform 0.2s ease;
        }

        .chat-group-header.collapsed .arrow {
            transform: rotate(-90deg);
        }

        .chat-group-header .group-name {
            font-weight: 600;
            font-size: 15px;
        }

        .chat-group-content {
            max-height: 1000px;
            /* ‰∏Ä‰∏™Ë∂≥Â§üÂ§ßÁöÑÂÄº */
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .chat-group-content.collapsed {
            max-height: 0;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞CSSÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* Ê†ºÂºèÂä©ÊâãÊåâÈíÆÁöÑÂÆπÂô® */
        .format-helpers {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            /* ‰∏é‰∏ãÊñπÁöÑÊñáÊú¨Ê°ÜÊãâÂºÄË∑ùÁ¶ª */
            flex-wrap: wrap;
            /* Â¶ÇÊûúÊåâÈíÆÂ§™Â§öÂèØ‰ª•Êç¢Ë°å */
        }

        /* Âçï‰∏™Ê†ºÂºèÂä©ÊâãÊåâÈíÆÁöÑÊ†∑Âºè */
        .format-btn {
            background-color: #e9ecef;
            color: var(--text-primary);
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            /* ËÉ∂ÂõäÂΩ¢Áä∂ÔºåÊõ¥ÂèãÂ•Ω */
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .format-btn:hover {
            background-color: #dcdfe3;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞CSSÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* ‚Äú‚Ä¶‚ÄùÊåâÈíÆÁöÑÊ†∑Âºè */
        .post-actions-btn {
            margin-left: auto;
            /* ÂÖ≥ÈîÆÔºöËÆ©ÂÆÉËá™Âä®Èù†Âà∞ÊúÄÂè≥Ëæπ */
            padding: 5px 10px;
            font-size: 24px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            line-height: 1;
            transition: none;
        }

        .post-actions-btn:hover {
            background-color: #f0f0f0;
        }

        .post-actions-btn:active {
            background-color: #f0f0f0;
        }

        /* Âä®ÊÄÅÁºñËæëÊ®°ÊÄÅÊ°ÜÁöÑÊ†∑Âºè (ÂÆÉÂ∞ÜÂ§çÁî®Áé∞ÊúâÁöÑÊìç‰ΩúËèúÂçïÊ†∑Âºè) */
        #post-actions-modal .custom-modal-footer button {
            width: 100%;
            border: none;
            border-bottom: 1px solid #dbdbdb;
            padding: 14px;
            font-size: 18px;
        }

        #post-actions-modal .custom-modal-footer button:last-child {
            border-bottom: none;
        }

        #post-actions-modal #cancel-post-action-btn {
            margin-top: 8px;
            border-radius: 8px;
            background-color: #f0f0f0;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº Share Link Functionality Styles ‚ñº‚ñº‚ñº */
        /* 1. Browser interface background and content area styles */
        #browser-screen {
            background-color: #f8f9fa;
        }

        #browser-content {
            padding: 20px;
            font-size: 16px;
            line-height: 1.8;
            color: #333;
            overflow-y: auto;
            background-color: #f8f9fa;
        }

        #browser-content .article-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        #browser-content .article-meta {
            font-size: 13px;
            color: #8a8a8a;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        #browser-content .article-body {
            white-space: pre-wrap;
            word-break: break-word;
        }

        #browser-content .article-body p {
            margin-bottom: 1em;
        }

        /* 2. Link card styles in chat bubbles */
        .message-bubble.is-link-share .content {
            padding: 0;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        .link-share-card {
            width: 210px;
            background-color: #fff;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .link-share-card:hover {
            background-color: #f9f9f9;
        }

        .link-share-card .title {
            font-weight: 600;
            font-size: 15px;
            line-height: 1.4;
            color: #1f1f1f;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .link-share-card .description {
            font-size: 13px;
            color: #8a8a8a;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .link-share-card .footer {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .link-share-card .footer-icon {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Share Link Styles End ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº Location Share Message Styles ‚ñº‚ñº‚ñº */
        .message-bubble.is-location-share .content {
            padding: 4px;
            margin: 0;
        }

        .location-share-content {
            display: flex;
            flex-direction: row;
            gap: 12px;
            width: 240px;
            min-height: 64px;
        }

        .location-map-image {
            position: relative;
            width: 64px;
            height: 64px;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .location-map-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .location-map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .location-pin-icon {
            width: 20px;
            height: 20px;
        }

        .location-details {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            justify-content: center;
        }

        .location-details .location-name {
            font-weight: 600;
            font-size: 15px;
            line-height: 1.4;
            color: #1f1f1f;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .location-details .location-address {
            font-size: 13px;
            color: #666;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Location Share Card Styles End ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº Meetup Screen Styles ‚ñº‚ñº‚ñº */
        #meetup-screen {
            background: linear-gradient(135deg, #ffeef8, #f0f8ff);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #meetup-context-bar {
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .context-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .event-location,
        .event-time,
        .event-phase {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .end-date-button {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(255, 107, 107, 0.3);
        }

        .end-date-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }

        .event-phase {
            color: #8e44ad;
            font-weight: 500;
        }

        .meetup-messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Meetup uses regular chat message styling, but we override text colors with higher specificity */
        #meetup-messages .message-bubble.user .content,
        #meetup-messages .message-bubble.ai .content {
            color: var(--text-primary);
        }

        .behavioral-notation {
            color: #888888;
            font-style: italic;
        }

        .event-context-indicator {
            background: rgba(142, 68, 173, 0.1);
            border: 1px solid rgba(142, 68, 173, 0.3);
            border-radius: 12px;
            padding: 8px 12px;
            margin: 8px 0;
            text-align: center;
            font-size: 13px;
            color: #8e44ad;
            font-style: italic;
        }

        .phase-transition {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            border-radius: 12px;
            padding: 10px 16px;
            margin: 12px 0;
            text-align: center;
            font-size: 14px;
            color: #8e44ad;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(255, 154, 158, 0.3);
        }

        .meetup-input-container {
            flex-shrink: 0;
            padding: 8px;
            background-color: rgba(247, 247, 247, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        #meetup-input-main-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        #meetup-input {
            flex-grow: 1;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            background-color: var(--secondary-bg);
            font-size: 16px;
            max-height: 100px;
            resize: none;
        }

        #meetup-input::placeholder {
            color: #999;
            font-style: italic;
        }

        .meetup-actions-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        #meetup-wait-reply-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }

        #meetup-wait-reply-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        #meetup-wait-reply-btn img {
            width: 24px;
            height: 24px;
        }

        #meetup-send-btn {
            background: linear-gradient(135deg, #ff6b9d, #c44569);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        #meetup-send-btn:hover {
            opacity: 0.9;
        }

        #meetup-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Meetup header styles - match chat interface */
        #meetup-screen .header .default-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        #meetup-screen .header .selection-controls {
            display: none;
            width: 100%;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        #meetup-screen.selection-mode .header .default-controls {
            display: none;
        }

        #meetup-screen.selection-mode .header .selection-controls {
            display: flex;
        }

        #meetup-selection-cancel-btn {
            color: var(--text-primary);
            cursor: pointer;
            font-size: 16px;
        }

        #meetup-selection-count {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 500;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Meetup Screen Styles End ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº Meetup History Screen Styles (Same as Meetup) ‚ñº‚ñº‚ñº */
        /* History mode should look exactly like meetup screen - no background changes needed */
        /* ‚ñ≤‚ñ≤‚ñ≤ Meetup History Screen Styles End ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ≤æËá¥ÁâàËΩ¨Ë¥¶Êìç‰ΩúÂºπÁ™óÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .transfer-actions-content {
            background-color: #fff0f5;
            /* Á≤âÂ´©ÁöÑËÉåÊôØËâ≤ */
            border-radius: 20px;
            width: 290px;
            padding: 20px;
            box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3);
            /* Á≤âËâ≤Èò¥ÂΩ± */
            text-align: center;
            position: relative;
            border: 1px solid #ffcce0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .transfer-actions-header {
            font-size: 20px;
            font-weight: bold;
            color: #a35c7b;
            /* Ê∑±Á≤âËâ≤Ê†áÈ¢ò */
            margin-bottom: 15px;
        }

        .transfer-actions-body p {
            font-size: 15px;
            color: #666;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .transfer-actions-footer {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .transfer-actions-footer .action-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .transfer-actions-footer .action-btn.accept {
            background: linear-gradient(135deg, #ff85b3, #ff6b9d);
            box-shadow: 0 4px 15px rgba(255, 107, 157, 0.4);
        }

        .transfer-actions-footer .action-btn.accept:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 157, 0.6);
        }

        .transfer-actions-footer .action-btn.decline {
            background: linear-gradient(135deg, #c2c2c2, #a0a0a0);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .transfer-actions-content .cancel-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background-color: rgba(0, 0, 0, 0.1);
            color: #a35c7b;
            font-size: 20px;
            line-height: 28px;
            cursor: pointer;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* Áªü‰∏ÄÈáçÁΩÆËΩ¨Ë¥¶Âç°ÁâáÂÜÖÊâÄÊúâÊñáÂ≠óÁöÑÁâπÊïàÂíåÈ¢úËâ≤ */
        #chat-messages .transfer-card .transfer-title,
        #chat-messages .transfer-card .transfer-amount,
        #chat-messages .transfer-card .transfer-note {
            text-shadow: none !important;
            /* Âº∫Âà∂ÁßªÈô§‰ªª‰ΩïÂèëÂÖâÊàñÈò¥ÂΩ±ÊïàÊûú */
            color: white !important;
            /* Âº∫Âà∂ÈîÅÂÆöÊñáÂ≠óÈ¢úËâ≤‰∏∫ÁôΩËâ≤ */
        }

        /* ÂàÜÂà´ÈîÅÂÆöÂêÑËá™ÁöÑÂ≠ó‰ΩìÂ§ßÂ∞èÂíåÂ≠óÈáçÔºåÈò≤Ê≠¢Ë¢´ÁØ°Êîπ */
        #chat-messages .transfer-card .transfer-title {
            font-size: 16px !important;
            font-weight: 600 !important;
        }

        #chat-messages .transfer-card .transfer-amount {
            font-size: 28px !important;
            font-weight: bold !important;
        }

        #chat-messages .transfer-card .transfer-note {
            font-size: 13px !important;
            opacity: 0.9 !important;
        }

        /* ‚ñº‚ñº‚ñº ËØ∑Áî®‰∏ãÈù¢Ëøô„Äê‰∏ÄÊï¥Âùó„ÄëÂÖ®Êñ∞ÁöÑËá™ÈÄÇÂ∫î‰ª£Á†ÅÔºåÊõøÊç¢ÊéâÊâÄÊúâÊóßÁöÑÂ§¥ÂÉèÁõ∏ÂÖ≥Ê†∑Âºè ‚ñº‚ñº‚ñº */

        /* 1. Â§¥ÂÉèÂÆπÂô®ÁöÑ„ÄêÈªòËÆ§/Êó†Ê°Ü„ÄëÁä∂ÊÄÅ */
        .avatar-group {
            width: 34px;
            /* ÈªòËÆ§ÂÆΩÂ∫¶ÔºåÂíåÂ§¥ÂÉèÂõæÁâá‰∏ÄÊ†∑ÂÆΩ */
            flex-shrink: 0;
            position: relative;
            transition: width 0.2s ease;
            /* Ê∑ªÂä†‰∏Ä‰∏™Âπ≥ÊªëÁöÑÂÆΩÂ∫¶ÂèòÂåñÂä®Áîª */
        }

        /* 2. ÂΩì„ÄêÊúâÊ°Ü„ÄëÊó∂ÔºåÂ§¥ÂÉèÂÆπÂô®Ëá™Âä®ÂèòÂÆΩ */
        .avatar-group.has-frame {
            width: 42px;
            /* ÂèòÂæóÊõ¥ÂÆΩÔºå‰∏∫Êõ¥Â§ßÁöÑÂ§¥ÂÉèÂõæÁâáÂíåÊ°ÜÁïôÂá∫Á©∫Èó¥ */
        }

        /* 3. ÊôÆÈÄöÂ§¥ÂÉèÔºàÊó†Ê°ÜÊó∂ÔºâÁöÑÊ†∑Âºè */
        .message-bubble .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        /* 4. Â∏¶Ê°ÜÂ§¥ÂÉèÁöÑÂÆπÂô®„ÄêÈªòËÆ§„ÄëÂ§ßÂ∞è */
        .avatar-with-frame {
            position: relative;
            width: 40px;
            /* ÈªòËÆ§ÂíåÊôÆÈÄöÂ§¥ÂÉè‰∏ÄÊ†∑Â§ß */
            height: 40px;
            margin: 0 auto;
            transition: all 0.2s ease;
            /* ‰∏∫Â§ßÂ∞èÂèòÂåñÊ∑ªÂä†Âä®Áîª */
            flex-shrink: 0;
        }

        /* 5. ÂΩì„ÄêÊúâÊ°Ü„ÄëÊó∂ÔºåÂ∏¶Ê°ÜÂ§¥ÂÉèÁöÑÂÆπÂô®Ëá™Âä®„ÄêÂèòÂ§ß„ÄëÔºåËß£ÂÜ≥ÊÇ®ËØ¥ÁöÑ‚ÄúÂõæÂ∞èÊ°ÜÂ§ß‚ÄùÈóÆÈ¢òÔºÅ */
        .avatar-group.has-frame .avatar-with-frame {
            width: 67px;
            /* ÂõæÁâáÂÆπÂô®ÂèòÂ§ß */
            height: 67px;
        }

        /* 6. Â§¥ÂÉèÂõæÁâáÊú¨Ë∫´ÔºåÊ∞∏ËøúÊíëÊª°ÂÆÉÁöÑÂÆπÂô® */
        .avatar-with-frame .avatar-img {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            object-fit: cover;
            z-index: 1;
        }

        /* 7. Â§¥ÂÉèÊ°ÜÔºåÊ∞∏ËøúÂü∫‰∫éÂÆÉÁöÑÁà∂ÂÆπÂô®Â±Ö‰∏≠ */
        .avatar-with-frame .avatar-frame {
            position: absolute;
            width: 67px;
            height: 67px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            pointer-events: none;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËøôÊòØÊñ∞Â¢ûÁöÑÊ†∑ÂºèÔºåÁî®‰∫é‰øÆÊ≠£ÊâÄÊúâÂ§¥ÈÉ®Ê†áÈ¢òÁöÑÂ±Ö‰∏≠ÈóÆÈ¢ò ‚ñº‚ñº‚ñº */
        .header>span:nth-child(2),
        #chat-header-title,
        #meetup-title {
            position: absolute;
            left: 50%;
            transform: translateX(calc(-50% - 2px));
            /* Âú®-50%ÁöÑÂü∫Á°Ä‰∏äÔºåÂÜçÂêëÂ∑¶Êé®2ÂÉèÁ¥† */

            /* (ÂèØÈÄâ‰ΩÜÊé®Ëçê) Èò≤Ê≠¢ÈïøÊ†áÈ¢ò‰∏é‰∏§ËæπÊåâÈíÆÈáçÂè† */
            max-width: 60%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂèØËßÜÂåñÊ∂àÊÅØÁºñËæëÂô®Ê†∑Âºè ‚ñº‚ñº‚ñº */
        #message-editor-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message-editor-block {
            background-color: #f9f9f9;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px;
        }

        .message-editor-block textarea {
            width: 100%;
            min-height: 60px;
            resize: vertical;
            border: 1px solid #ccc;
            border-radius: 6px;
            padding: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .message-editor-block .format-helpers {
            margin-top: 8px;
            margin-bottom: 0;
            /* Ë¶ÜÁõñÈªòËÆ§ÁöÑ margin-bottom */
        }

        .message-editor-block .delete-block-btn {
            float: right;
            margin-top: -5px;
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËÅîÁ≥ª‰∫∫ÈÄâÊã©Âô®Ê†∑Âºè ‚ñº‚ñº‚ñº */
        .contact-picker-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .contact-picker-item .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 15px;
            transition: all 0.2s ease;
        }

        .contact-picker-item.selected .checkbox {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            content: '‚úî';
            color: white;
            font-size: 14px;
            text-align: center;
            line-height: 20px;
        }

        .contact-picker-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .contact-picker-item .name {
            font-weight: 500;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„Äë‰øÆÂ§çËÅîÁ≥ª‰∫∫ÈÄâÊã©Âô®‚ÄúÂèñÊ∂à‚ÄùÊåâÈíÆÂ≠ó‰ΩìÂ§ßÂ∞è ‚ñº‚ñº‚ñº */
        #cancel-contact-picker-btn {
            font-size: 16px;
            /* Ë¶ÜÁõñ .back-btn ÁöÑ 24pxÔºå‰∏éÂè≥‰æß‚ÄúÂÆåÊàê‚ÄùÊåâÈíÆ‰øùÊåÅ‰∏ÄËá¥ */
            font-weight: 600;
            /* ÂêåÊ†∑ËÆæÁΩÆÂ≠óÈáç‰ª•‰øùËØÅËßÜËßâÁªü‰∏Ä */
            width: auto;
            /* Ë¶ÜÁõñ .back-btn Âõ∫ÂÆöÁöÑ30pxÂÆΩÂ∫¶ÔºåËÆ©ÂÖ∂ÂÆΩÂ∫¶Ëá™ÈÄÇÂ∫î‚ÄúÂèñÊ∂à‚Äù‰∫åÂ≠ó */
            padding: 0 5px;
            /* Â¢ûÂä†‰∏ÄÁÇπÂ∑¶Âè≥ÂÜÖËæπË∑ùÔºåËÆ©ÊñáÂ≠ó‰∏çÊòæÂæóÊã•Êå§ */
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */


        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁæ§ÊàêÂëòÁÆ°ÁêÜÁïåÈù¢Ê†∑Âºè ‚ñº‚ñº‚ñº */
        #member-management-list {
            padding: 0;
            /* ÁßªÈô§ÈªòËÆ§paddingÔºåËÆ©ÂàóË°®È°πÊíëÊª° */
        }

        .member-management-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .member-management-item .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
        }

        .member-management-item .name {
            flex-grow: 1;
            font-weight: 500;
        }

        .member-management-item .remove-member-btn {
            background-color: #ff3b30;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 20px;
            line-height: 28px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        #member-management-actions {
            flex-shrink: 0;
            padding: 15px;
            border-top: 1px solid var(--border-color);
            background-color: #f7f7f7;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #member-management-actions button {
            width: 100%;
            padding: 15px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        #member-management-actions #create-new-member-btn {
            background-color: #4cd964;
            /* Êñ∞Âª∫Áî®ÁªøËâ≤Ôºå‰ª•Á§∫Âå∫ÂàÜ */
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñÂçñ‰ª£‰ªòÂç°ÁâáÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .message-bubble.is-waimai-request .content {
            padding: 0;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        .waimai-card {
            width: 240px;
            border-radius: 12px;
            overflow: hidden;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        .waimai-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .waimai-header .icon {
            width: 20px;
            height: 20px;
        }

        .waimai-header .title-group {
            display: flex;
            align-items: baseline;
            font-size: 14px;
            color: #8a8a8a;
        }

        .waimai-header .title-group .brand {
            font-weight: 600;
            color: #555;
            margin-right: 5px;
        }

        .waimai-header .title-group .separator {
            margin: 0 5px;
        }

        .waimai-catchphrase {
            font-size: 13px;
            color: #1f1f1f;
            padding: 12px;
        }

        .waimai-main {
            background-color: #FFD66B;
            /* Ê©ôÈªÑËâ≤ËÉåÊôØ */
            padding: 12px;
            text-align: center;
        }

        .waimai-main .request-title {
            font-size: 12px;
            color: #856404;
            margin-bottom: 8px;
        }

        .waimai-main .payment-box {
            background-color: #fff;
            border-radius: 8px;
            padding: 15px 10px;
        }

        .waimai-main .payment-label {
            font-size: 13px;
            color: #8a8a8a;
        }

        .waimai-main .amount {
            font-size: 32px;
            font-weight: 700;
            color: #1f1f1f;
            margin: 4px 0 12px 0;
        }

        .waimai-main .countdown-label {
            font-size: 13px;
            color: #8a8a8a;
        }

        .waimai-main .countdown-timer {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            margin-left: 5px;
        }

        .waimai-main .countdown-timer span {
            background-color: #333;
            color: white;
            padding: 2px 4px;
            border-radius: 2px;
            font-weight: bold;
            font-size: 12px;
        }

        .waimai-details-btn {
            width: 100%;
            padding: 10px 0;
            margin-top: 15px;
            border: none;
            border-radius: 6px;
            background-color: #FFC33A;
            color: #49380a;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñÂçñÂìçÂ∫îÁä∂ÊÄÅÊ†∑Âºè ‚ñº‚ñº‚ñº */

        /* === ÂêåÊÑèÊîØ‰ªòÂêéÁöÑÊ†∑Âºè === */
        .message-bubble.status-paid .waimai-card {
            border: 2px solid #28a745;
            /* ÁªøËâ≤ËæπÊ°Ü */
        }

        .message-bubble.status-paid .waimai-main .request-title::before {
            content: '‚úÖ  ';
        }

        .message-bubble.status-paid .waimai-main .request-title {
            color: #155724;
            font-weight: 600;
            /* ÈáçÂÜô request-title ÁöÑÂÜÖÂÆπ */
            content: "ÊàëÂ∑≤‰∏∫ÊÇ®‰π∞ÂçïÔºåËØ∑Â∞ΩÊÉÖ‰∫´Áî®ÂêßÔΩû" !important;
            display: block;
            margin-bottom: 15px;
        }

        .message-bubble.status-paid .payment-box {
            display: none;
            /* ÈöêËóèÊîØ‰ªòËØ¶ÊÉÖ */
        }

        .message-bubble.status-paid .waimai-details-btn {
            background-color: #28a745;
            color: white;
        }

        /* === ÊãíÁªùÊîØ‰ªòÂêéÁöÑÊ†∑Âºè === */
        .message-bubble.status-rejected .waimai-card {
            border: 2px solid #dc3545;
            /* Á∫¢Ëâ≤ËæπÊ°Ü */
            opacity: 0.8;
        }

        .message-bubble.status-rejected .waimai-main {
            background-color: #e9ecef;
        }

        .message-bubble.status-rejected .waimai-main .request-title::before {
            content: '‚ùå ';
        }

        .message-bubble.status-rejected .waimai-main .request-title {
            color: #721c24;
            font-weight: 600;
            /* ÈáçÂÜô request-title ÁöÑÂÜÖÂÆπ */
            content: "ÊàëÊãíÁªù‰∫ÜÊÇ®ÁöÑ‰ª£‰ªòËØ∑Ê±Ç" !important;
            display: block;
            margin-bottom: 15px;
        }

        .message-bubble.status-rejected .payment-box {
            display: none;
            /* ÈöêËóèÊîØ‰ªòËØ¶ÊÉÖ */
        }

        .message-bubble.status-rejected .waimai-details-btn {
            background-color: #6c757d;
            color: white;
        }

        /* Âº∫Âà∂ÈáçÂÜô request-title ÂÜÖÂÆπÁöÑÊäÄÂ∑ß */
        .message-bubble[class*="status-"] .request-title {
            font-size: 0;
            /* ÈöêËóèÂéüÂßãÊñáÊú¨ */
        }

        .message-bubble[class*="status-"] .request-title::after {
            font-size: 14px;
            /* ËÆ©‰º™ÂÖÉÁ¥†ÊòæÁ§∫Êñ∞ÊñáÊú¨ */
        }

        .message-bubble.status-paid .request-title::after {
            content: "ÊàëÂ∑≤‰∏∫ÊÇ®‰π∞ÂçïÔºåËØ∑Â∞ΩÊÉÖ‰∫´Áî®ÂêßÔΩû";
        }

        .message-bubble.status-rejected .request-title::after {
            content: "ÊàëÊãíÁªù‰∫ÜÊÇ®ÁöÑ‰ª£‰ªòËØ∑Ê±Ç";
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñÂçñËØ∑Ê±ÇÁöÑÁî®Êà∑Êìç‰ΩúÊåâÈíÆÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .waimai-user-actions {
            display: flex;
            gap: 10px;
            padding: 0 12px 12px 12px;
            /* Âú®Âç°ÁâáÂ∫ïÈÉ®ÁïôÂá∫Á©∫Èó¥ */
            background-color: #fff;
        }

        .waimai-user-actions button {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            border: 1.5px solid;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .waimai-pay-btn {
            background-color: #28a745;
            border-color: #1f7a33;
            color: white;
        }

        .waimai-pay-btn:hover {
            background-color: #218838;
        }

        .waimai-decline-btn {
            background-color: #f8f9fa;
            border-color: #ced4da;
            color: #495057;
        }

        .waimai-decline-btn:hover {
            background-color: #e2e6ea;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* === „ÄêÊñ∞Â¢û„ÄëÁªü‰∏ÄËÆæÁΩÆÈ°µÈù¢ÁöÑËÉåÊôØËâ≤ (Â∑≤‰øÆÊ≠£) === */
        #api-settings-screen,
        #appearance-settings-screen,
        #memories-view,
        #contact-picker-screen,
        /* <-- Êñ∞Â¢ûËøôË°å */
        #member-management-screen {
            /* <-- Êñ∞Â¢ûËøôË°å */
            background-color: var(--secondary-bg);
        }

        /* Á°Æ‰øùËøô‰∫õÈ°µÈù¢ÁöÑÂÜÖÂÆπÂå∫ËÉΩÊ≠£Á°ÆÊªöÂä® */
        #api-settings-screen .form-container,
        #appearance-settings-screen .form-container {
            padding-top: 100px;
            margin-top: -80px;
            background-color: var(--secondary-bg);
        }

        /* ËÆæÁΩÆÈ°µÈù¢ÁöÑÈ¢ÑËßàÂå∫ÊØîËæÉÁâπÊÆäÔºåÈúÄË¶ÅÈ¢ùÂ§ñË∞ÉÊï¥ */
        #appearance-settings-screen .form-container {
            align-items: center;
            /* ‰øùÊåÅÂÜÖÂÆπÂ±Ö‰∏≠ */
        }




        /* Á°Æ‰øùÂ£ÅÁ∫∏È¢ÑËßà‰∏çË¢´ÂéãÁº©‰∏îÂèØËßÅ */
        #appearance-settings-screen #wallpaper-preview {
            flex-shrink: 0;
            margin-bottom: 20px;
            display: flex !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        /* Á°Æ‰øùÂàÜÈöîÁ∫øÂú®Â§ñËßÇËÆæÁΩÆÈ°µÈù¢‰∏≠ÂèØËßÅ */
        #appearance-settings-screen hr {
            display: block !important;
            width: 100% !important;
            border: 0;
            border-top: 1px solid #000;
            align-self: stretch !important;
        }

        /* Calendar app styles */
        .calendar-month-view-no-card {
            padding: 8px 0;
            margin-bottom: 20px;
        }

        .calendar-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        .calendar-nav-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--accent-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-nav-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .calendar-month-year {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-left: 8px;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 10px;
        }

        .weekday {
            text-align: center;
            padding: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-date {
            text-align: center;
            cursor: pointer;
            font-size: 16px;
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            margin: 0 auto;
        }

        .calendar-date:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .calendar-date.other-month {
            color: var(--text-secondary);
            opacity: 0.5;
        }

        .calendar-date.selected {
            background: transparent;
            color: white;
            position: relative;
        }

        .calendar-date.selected::before {
            content: '';
            position: absolute;
            top: calc(50% - 1px);
            left: 50%;
            transform: translate(-50%, -50%);
            width: 24px;
            height: 24px;
            background: var(--accent-color);
            border-radius: 50%;
            z-index: -1;
        }

        .calendar-date.today.selected {
            color: white;
        }

        .calendar-date.today {
            background: rgba(var(--accent-color-rgb), 0.1);
            color: var(--accent-color);
            font-weight: 600;
        }

        /* Memory indicators on calendar dates */
        .calendar-date {
            position: relative;
        }

        .memory-indicators {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 2px;
        }

        .memory-indicator {
            width: 4px;
            height: 4px;
            border-radius: 50%;
        }

        .memory-indicator.user-memory {
            background: #007AFF;
            /* Blue for user's manual memories */
        }

        .memory-indicator.ai-memory {
            background: #FF8C00;
            /* Darker yellow/orange for AI-generated memories */
        }

        .memory-indicator.countdown {
            background: #9370DB;
            /* Lighter purple for countdown events */
        }

        .memory-indicator.meetup {
            background: #FF3B30;
            /* Red for meetup events */
        }

        .calendar-events-section {
            background: rgb(247, 247, 247);
            padding: 20px;
            margin: 0 -20px -20px -20px;
            /* Negative margins to bleed to edges: top=0, right=-20px, bottom=-20px, left=-20px */
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }

        .calendar-events-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-events-header #selected-date-display {
            margin-left: 8px;
        }

        .calendar-events-list {
            flex: 1;
            min-height: 100px;
            /* Removed padding-bottom: 24px; - using spacer div instead */
        }

        .no-events-message {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            padding: 20px;
        }

        /* NEW: Calendar memory item styles - copying qzone post styling */
        .calendar-memory-item {
            padding: 12px;
            margin-bottom: 16px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .calendar-memory-item:last-child {
            margin-bottom: 44px !important;
            /* 20px to offset negative margin + 24px extra spacing */
        }

        /* Memory type styling */
        .calendar-memory-item.memory-type {
            background-color: #fffaf0;
            /* Pale yellow for memories */
        }

        .calendar-memory-item.countdown-type {
            background: linear-gradient(135deg, #667eea, #764ba2);
            /* Purple gradient for events */
            color: white;
        }

        .calendar-memory-item.countdown-type .memory-header,
        .calendar-memory-item.countdown-type .memory-content,
        .calendar-memory-item.countdown-type .memory-nickname,
        .calendar-memory-item.countdown-type .memory-timestamp,
        .calendar-memory-item.countdown-type .post-actions-btn {
            color: white !important;
        }

        /* Meetup type styling */
        .calendar-memory-item.meetup-type {
            background: linear-gradient(135deg, #667eea, #764ba2);
            /* Purple gradient for meetup (same as countdown) */
            color: white;
        }

        .calendar-memory-item.meetup-type .memory-header,
        .calendar-memory-item.meetup-type .memory-content,
        .calendar-memory-item.meetup-type .memory-nickname,
        .calendar-memory-item.meetup-type .memory-timestamp,
        .calendar-memory-item.meetup-type .post-actions-btn {
            color: white !important;
        }

        /* Clickable meetup events */
        .calendar-memory-item.meetup-type[style*="cursor: pointer"]:hover,
        .calendar-memory-item.countdown-type[style*="cursor: pointer"]:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            transition: all 0.2s ease;
        }

        /* Meetup status indicators */
        .meetup-status-indicator {
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
            padding: 2px 6px;
            border-radius: 10px;
            white-space: nowrap;
        }

        .meetup-status-indicator.active {
            background-color: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
        }

        .meetup-status-indicator.template {
            background-color: rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        /* Ensure status indicators are visible on purple gradient backgrounds */
        .calendar-memory-item.countdown-type .meetup-status-indicator.template,
        .calendar-memory-item.meetup-type .meetup-status-indicator.template {
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .calendar-memory-item.countdown-type .meetup-status-indicator.active,
        .calendar-memory-item.meetup-type .meetup-status-indicator.active {
            background-color: rgba(255, 255, 255, 0.3);
            color: #90EE90;
        }

        /* Memory actions container - positioned in top right */
        .memory-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }



        /* Meetup indicator styling */
        .meetup-indicator {
            display: flex;
            align-items: center;
            opacity: 0.9;
        }

        .meetup-indicator svg {
            color: white;
        }

        /* Copy exact post-header styling */
        .memory-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .memory-header .memory-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .memory-info {
            display: flex;
            flex-direction: column;
            flex: 1;
        }

        .memory-info .memory-nickname {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }

        .memory-info .memory-timestamp {
            font-size: 12px;
            color: var(--text-secondary);
        }



        .memory-content {
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊù•ÁîµËØ∑Ê±Ç‰∏éËßÜÈ¢ëÈÄöËØùÁïåÈù¢Ê†∑Âºè ‚ñº‚ñº‚ñº */

        /* --- Êù•ÁîµËØ∑Ê±ÇÊ®°ÊÄÅÊ°Ü --- */
        #incoming-call-modal .incoming-call-content {
            background-color: rgba(40, 40, 40, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 280px;
            padding: 30px 20px;
            text-align: center;
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .caller-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 3px solid rgba(255, 255, 255, 0.5);
        }

        .caller-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .caller-text {
            font-size: 14px;
            color: #ccc;
            margin-bottom: 30px;
        }

        .incoming-call-actions {
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .action-button-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #e0e0e0;
        }

        .call-action-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background-size: 50%;
            background-repeat: no-repeat;
            background-position: center;
            /* transition: transform 0.2s, box-shadow 0.2s; - Removed to disable tap feedback */
            transition: box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .call-action-btn:active {
            /* Tap feedback removed */
        }

        .call-action-btn.decline {
            background-color: #ff3b30;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
        }

        .call-action-btn.accept {
            background-color: #4cd964;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>');
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 217, 100, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(76, 217, 100, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(76, 217, 100, 0);
            }
        }

        /* --- ËßÜÈ¢ëÈÄöËØùÁïåÈù¢ --- */
        /* ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏ÄÊï¥Âùó„ÄêÊúÄÁªà‰øÆÊ≠£Áâà„ÄëÁöÑ‰ª£Á†ÅÔºåÊõøÊç¢ÊâÄÊúâÊóßÁöÑ video-call Áõ∏ÂÖ≥CSS ‚ñº‚ñº‚ñº */

        /* 1. ÈÄöËØùÂ±èÂπïÊÄªÂÆπÂô® (‰øùÊåÅ‰∏çÂèò) */
        #video-call-screen {
            background-color: #1c1c1e;
            color: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 2. È°∂ÈÉ®Ê†èÂíåÂ∫ïÈÉ®ÊéßÂà∂Ê†è (‰øùÊåÅ‰∏çÂèò) */
        .video-call-top-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px 20px;
            padding-top: 50px;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.5), transparent);
            z-index: 10;
            text-align: center;
            box-sizing: border-box;
            pointer-events: none;
        }

        #call-timer {
            font-size: 16px;
            font-weight: 500;
            letter-spacing: 1px;
        }

        .video-call-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 20px;
            padding-bottom: 40px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.5), transparent);
            z-index: 10;
            box-sizing: border-box;
        }

        /* 3. ÂèÇ‰∏éËÄÖÂ§¥ÂÉèÊòæÁ§∫Âå∫ (‰øùÊåÅ‰∏çÂèò) */
        .video-call-avatar-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            padding-top: 80px;
            /* Á°Æ‰øùÈ°∂ÈÉ®ÊúâË∂≥Â§üÁ©∫Èó¥ */
            box-sizing: border-box;
            overflow-y: auto;
            /* ‚òÖ Êñ∞Â¢ûÔºöÂ¶ÇÊûúÂ§¥ÂÉèÂ§™Â§öÔºåÂÖÅËÆ∏Ê≠§Âå∫ÂüüÊªöÂä® */
        }

        /* 4. Â§¥ÂÉèÁΩëÊ†ºÂÆπÂô® (‰øùÊåÅ‰∏çÂèò) */
        #participant-avatars-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
            /* ‚òÖ Á®çÂæÆÂáèÂ∞èÂ§¥ÂÉèÈó¥Ë∑ù */
            max-width: 100%;
        }

        /* 5. Âçï‰∏™ÂèÇ‰∏éËÄÖÁöÑÂ§¥ÂÉèÂÆπÂô® (Â§¥ÂÉèÁº©Â∞è) */
        .participant-avatar-wrapper {
            position: relative;
            text-align: center;
            flex-shrink: 0;
        }

        .participant-avatar {
            width: 70px;
            /* ‚òÖ ‰ªé 80px Áº©Â∞èÂà∞ 70px */
            height: 70px;
            /* ‚òÖ ‰ªé 80px Áº©Â∞èÂà∞ 70px */
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .participant-name {
            margin-top: 8px;
            font-size: 12px;
            color: #ccc;
        }

        /* 6. ÂèëË®ÄËÄÖÂ§¥ÂÉèÈ´ò‰∫ÆÊïàÊûú (‰øùÊåÅ‰∏çÂèò) */
        .participant-avatar.speaking {
            border-color: #4cd964;
            box-shadow: 0 0 20px rgba(76, 217, 100, 0.6);
            transform: scale(1.05);
        }

        /* 7. „ÄêÊúÄÁªàÁâà„ÄëÂØπËØùÊ°ÜÂå∫Âüü */
        #video-call-main {
            flex-shrink: 0;
            height: 30%;
            /* ‚òÖ Ê†∏ÂøÉ‰øÆÊîπÔºöÈ´òÂ∫¶‰ªé35%ÂáèÂ∞èÂà∞30% */
            margin: 15px 15px 130px 15px;
            /* ‚òÖ Ê†∏ÂøÉ‰øÆÊîπÔºöÂ∫ïÈÉ®ËæπË∑ù‰ªé120pxÂ¢ûÂä†Âà∞130pxÔºåÂàõÈÄ†ÊòéÊòæÁ©∫Èöô */
            overflow-y: auto;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-sizing: border-box;
        }

        /* 8. ÊéßÂà∂ÊåâÈíÆÊ†∑Âºè (‰øùÊåÅ‰∏çÂèò) */
        .control-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            background-repeat: no-repeat;
            background-position: center;
            /* transition: transform 0.2s, background-color 0.2s; - Removed to disable tap feedback */
            transition: background-color 0.2s;
        }

        .control-btn:active {
            /* Tap feedback removed */
        }

        .control-btn.speak-btn {
            background-color: rgba(255, 255, 255, 0.2);
            background-size: 55%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg>');
        }

        .control-btn.hangup-btn {
            background-color: #ff3b30;
            background-size: 50%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13.5 16.5L3 6m18 6l-5.6-5.6a1.2 1.2 0 0 0-1.7 0L3 18.2a1.2 1.2 0 0 0-.3 1.2l1.2 3.6a1.2 1.2 0 0 0 1.2.9h15.6a1.2 1.2 0 0 0 1.2-1.2V7.7a1.2 1.2 0 0 0-.3-1.1z"/></svg>');
        }

        .control-btn.join-btn {
            background-color: #007bff;
            background-size: 50%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg>');
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËßÜÈ¢ëÈÄöËØùÂØπËØùÊ∞îÊ≥°Ê†∑Âºè ‚ñº‚ñº‚ñº */
        .call-message-bubble {
            padding: 10px 15px;
            border-radius: 12px;
            max-width: 85%;
            line-height: 1.6;
            word-break: break-word;
            white-space: pre-wrap;
        }

        .call-message-bubble.ai-speech {
            background-color: rgba(255, 255, 255, 0.15);
            align-self: flex-start;
            /* AIÂèëË®ÄÈù†Â∑¶ */
        }

        .call-message-bubble.user-speech {
            background-color: #4cd964;
            /* Áî®Êà∑ÂèëË®ÄÁî®ÁªøËâ≤ÔºåÁ±ª‰ººÂæÆ‰ø° */
            align-self: flex-end;
            /* Áî®Êà∑ÂèëË®ÄÈù†Âè≥ */
            text-align: left;
            /* Á°Æ‰øùÁî®Êà∑Ê∞îÊ≥°ÂÜÖÁöÑÊñáÂ≠óÊòØÂ∑¶ÂØπÈΩêÁöÑ */
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûCSSÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞Ê∑ªÂä†„ÄëÊ≠£Âú®ÂëºÂè´ÁïåÈù¢Ê†∑Âºè ‚ñº‚ñº‚ñº */
        #outgoing-call-screen {
            background-color: #1c1c1e;
            color: white;
            justify-content: center;
            /* ÂûÇÁõ¥Â±Ö‰∏≠ */
            align-items: center;
            /* Ê∞¥Âπ≥Â±Ö‰∏≠ */
        }

        .outgoing-call-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .outgoing-call-actions {
            margin-top: 50px;
            /* Âíå‰∏äÊñπÊñáÂ≠óÊãâÂºÄË∑ùÁ¶ª */
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #e0e0e0;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* 1. Âä®ÊÄÅÂ∏ñÂ≠êÁöÑÂ§ñÂ±ÇÂÆπÂô®ÔºåÊàë‰ª¨ÈúÄË¶ÅÂÆÉÊù•ÂÆö‰ΩçÂíåË£ÅÂâ™ */
        .qzone-post-container {
            position: relative;
            /* ËÆ©ÂÜÖÈÉ®ÁöÑÂà†Èô§ÊåâÈíÆÂèØ‰ª•Áõ∏ÂØπ‰∫éÂÆÉÂÆö‰Ωç */
            overflow: hidden;
            /* ÈöêËóèÊéâË∂ÖÂá∫ÈÉ®ÂàÜÁöÑÂà†Èô§ÊåâÈíÆ */
            border-radius: 12px;
            /* ÂíåÂÜÖÈÉ®Âç°Áâá‰øùÊåÅ‰∏ÄËá¥ÁöÑÂúÜËßí */
        }

        /* 2. ÂèØÊªëÂä®ÁöÑÂÜÖÂÆπÂç°ÁâáÔºåÂ¢ûÂä†‰∏Ä‰∏™Âπ≥ÊªëÁöÑËøáÊ∏°ÊïàÊûú */
        .qzone-post-item {
            transition: transform 0.3s ease;
            background-color: var(--secondary-bg);
            /* Á°Æ‰øùÂÆÉÊúâËÉåÊôØËâ≤ÔºåËÉΩÁõñ‰Ωè‰∏ãÈù¢ÁöÑÂà†Èô§ÊåâÈíÆ */
            position: relative;
            /* Á°Æ‰øùÂÆÉÂú®ÊúÄ‰∏äÂ±Ç */
            z-index: 2;
        }

        /* 3. „ÄêÊ†∏ÂøÉ„ÄëËøôÂ∞±ÊòØÈÇ£‰∏™‚ÄúÂà†Èô§‚ÄùÊåâÈíÆÁöÑÊ†∑ÂºèÔºÅ*/
        .qzone-post-delete-action {
            position: absolute;
            /* ÁªùÂØπÂÆö‰ΩçÔºåËÑ±Á¶ªÊñáÊ°£ÊµÅ */
            top: 0;
            right: 0;
            bottom: 0;
            width: 90px;
            /* Âà†Èô§ÊåâÈíÆÁöÑÂÆΩÂ∫¶ */
            background-color: #ff3b30;
            /* ÊÇ®ÊÉ≥Ë¶ÅÁöÑÁ∫¢Ëâ≤ËÉåÊôØ */
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            cursor: pointer;
            z-index: 1;
            /* Á°Æ‰øùÂÆÉÂú®Âç°Áâá‰∏ãÈù¢ */
        }

        /* 4. ÂΩìÂç°ÁâáÂ∑¶ÊªëÊó∂ÔºåÊääÂÆÉÂêëÂ∑¶ÁßªÂä®ÔºåÈú≤Âá∫Âà†Èô§ÊåâÈíÆ */
        .qzone-post-item.swiped {
            transform: translateX(-90px);
            /* ÁßªÂä®ÁöÑË∑ùÁ¶ªÂíåÂà†Èô§ÊåâÈíÆÁöÑÂÆΩÂ∫¶‰∏ÄËá¥ */
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô„Äê‰∏ÄÊï¥Âùó„ÄëÂÖ®Êñ∞ÁöÑ‚ÄúÊãç‰∏ÄÊãç‚ÄùÊ†∑ÂºèÔºåÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* 1. ‚ÄúÊãç‰∏ÄÊãç‚ÄùÁöÑÂ±èÂπïÈúáÂä®Âä®Áîª */


        /* 2. ‚ÄúÊãç‰∏ÄÊãç‚ÄùÁ≥ªÁªüÊèêÁ§∫Ê∂àÊÅØÁöÑÊ†∑Âºè */
        .system-message {
            align-self: center;
            /* Â±Ö‰∏≠ÊòæÁ§∫ */
            padding: 4px 12px;
            margin: 5px 0;
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            border-radius: 10px;
            text-align: center;
            max-width: 80%;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Ê†∑ÂºèÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ËÆ©‚ÄúÊãç‰∏ÄÊãç‚ÄùÁ±ªÂûãÁöÑ wrapper Â±Ö‰∏≠ */
        .message-wrapper.system-pat {
            justify-content: center;
            align-self: center;
            margin: 5px 0;
            max-width: 80%;
        }

        /* ‚ÄúÊãç‰∏Ä-Êãç‚ÄùÊ∂àÊÅØÊ∞îÊ≥°ÁöÑÊ†∑Âºè */
        .message-bubble.system-bubble {
            background-color: rgba(0, 0, 0, 0.1);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 10px;
        }

        /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞CSSÁ≤òË¥¥Âà∞ <style> ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* === ‰øÆÊ≠£ÔºöËÆ©È°∂ÈÉ®Êìç‰ΩúÊ†èÂèØ‰ª•Ê®™ÂêëÊªöÂä® === */
        #chat-input-actions-top {
            display: flex;
            gap: 8px;
            padding: 0 5px;

            /* --- Ê†∏ÂøÉ‰ª£Á†ÅÂºÄÂßã --- */
            overflow-x: auto;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;

            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #chat-input-actions-top::-webkit-scrollbar {
            display: none;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* === „ÄêÂÖ®Êñ∞„ÄëËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®Áä∂ÊÄÅÊ†èÊ†∑Âºè === */

        /* 1. Ê†áÈ¢òÂíåÁä∂ÊÄÅÁöÑÊÄªÂÆπÂô®Ôºå‰ΩøÁî®flexÂ∏ÉÂ±ÄËÆ©ÂÆÉ‰ª¨ÂûÇÁõ¥ÊéíÂàó */
        #chat-header-title-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            /* Â∑¶ÂØπÈΩê */
            gap: 2px;
            /* Ê†áÈ¢òÂíåÁä∂ÊÄÅ‰πãÈó¥ÁöÑÂæÆÂ∞èÈó¥Ë∑ù */

            /* ÁßªÂä®Âà∞Â∑¶‰æßÔºåÁ¥ßÈÇªËøîÂõûÊåâÈíÆ */
            position: static;
            max-width: 60%;
            flex: 1;
            /* ËÆ©Ê†áÈ¢òÂå∫ÂüüÂç†ÊçÆÂâ©‰ΩôÁ©∫Èó¥ */
        }

        /* 2. ‰∏ªÊ†áÈ¢òÁöÑÊ†∑ÂºèÂæÆË∞É */
        #chat-header-title {
            font-size: 16px;
            /* ÂèØ‰ª•Á®çÂæÆÁº©Â∞è‰∏ÄÁÇπÔºåÁªôÁä∂ÊÄÅÊ†èÁïôÂá∫Á©∫Èó¥ */
            font-weight: 600;
            position: static;
            /* Ë¶ÜÁõñÊéâÊóßÁöÑabsoluteÂÆö‰Ωç */
            transform: none;
            /* Ë¶ÜÁõñÊéâÊóßÁöÑtransform */
            /* ‰øùËØÅÈïøÊ†áÈ¢ò‰πüËÉΩÊ≠£Á°ÆÊòæÁ§∫ÁúÅÁï•Âè∑ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        /* 3. Áä∂ÊÄÅÊ†èÂÆπÂô® */
        #chat-header-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        /* 4. Áä∂ÊÄÅÂ∞èÂúÜÁÇπ */
        .status-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background-color: #4cd964;
            /* ÈªòËÆ§ÁªøËâ≤Ôºå‰ª£Ë°®Âú®Á∫ø */
            transition: background-color 0.3s ease;
        }

        /* ÂΩìAIÁä∂ÊÄÅ‰∏∫‚ÄúÂøôÁ¢å‚ÄùÊàñ‚ÄúÁ¶ªÂºÄ‚ÄùÊó∂ÔºåËÆ©ÂúÜÁÇπÂèòÁÅ∞Ëâ≤ */
        #chat-header-status.busy .status-dot {
            background-color: #cccccc;
        }

        /* 5. Áä∂ÊÄÅÊñáÊú¨ */
        .status-text {
            font-weight: 500;
        }

        /* === „ÄêÂÖ®Êñ∞ÁæéÂåñÁâà„ÄëÂõûÂøÜÂç°ÁâáÊ†∑Âºè === */

        /* 1. Âç°ÁâáÊÄªÂÆπÂô®ÔºöËøôÈáåË¥üË¥£ÂÆö‰πâÊï¥‰ΩìÁöÑËÉåÊôØËâ≤ÂíåËæπÊ°Ü */
        .memory-card {
            background-color: #fffaf0;
            /* Áªü‰∏ÄÁöÑ„ÄÅÊ∏©ÊöñÁöÑÁ±≥ÈªÑËâ≤ËÉåÊôØ */
            border-radius: 12px;
            padding: 15px;
            /* Âú®Âç°ÁâáÂõõÂë®ÁïôÂá∫ÂÜÖËæπË∑ù */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.07);
            border-left: 5px solid #ffb74d;
            display: flex;
            /* ËÆ©ÂÆÉÊàê‰∏∫flexÂÆπÂô®ÔºåÊñπ‰æøÂÜÖÈÉ®ÂÖÉÁ¥†ÊéíÂàó */
            flex-direction: column;
            /* ËÆ©Â§¥ÈÉ®ÂíåÂÜÖÂÆπÂûÇÁõ¥Â†ÜÂè† */
            gap: 8px;
            /* Âú®Â§¥ÈÉ®ÂíåÂÜÖÂÆπ‰πãÈó¥ÂàõÈÄ†‰∏Ä‰∏™Ëá™ÁÑ∂ÁöÑÈó¥Ë∑ù */
        }

        /* 2. Â§¥ÈÉ®ÂÆπÂô®ÔºöÁé∞Âú®Âè™Ë¥üË¥£Â∏ÉÂ±ÄÂíåÂàÜÂâ≤Á∫ø */
        .memory-card .header {
            border-bottom: 1px solid rgba(217, 129, 0, 0.15);
            /* ÂàÜÂâ≤Á∫øÈ¢úËâ≤ÂèØ‰ª•Á®çÂæÆÂä†Ê∑±‰∏ÄÁÇπ */
            padding-bottom: 8px;
        }

        /* 3. Êó•ÊúüÊ†∑Âºè (‰øùÊåÅ‰∏çÂèò) */
        .memory-card .header .date {
            font-size: 11px;
            color: #a1887f;
            margin-bottom: 4px;
        }

        /* 4. ‰ΩúËÄÖÊ†∑Âºè (‰øùÊåÅ‰∏çÂèò) */
        .memory-card .header .author {
            font-weight: 600;
            color: #d98100;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 5. ÂÜÖÂÆπÂå∫Ê†∑Âºè (‰øùÊåÅ‰∏çÂèò) */
        .memory-card .content {
            font-size: 14px;
            line-height: 1.7;
            color: #5d4037;
            white-space: pre-wrap;
        }

        /* === „ÄêÂÖ®Êñ∞„ÄëÁ∫¶ÂÆö/ÂÄíËÆ°Êó∂Âç°ÁâáÊ†∑Âºè === */
        .countdown-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.4);
            text-align: center;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .countdown-card::before {
            content: '‚ú®';
            position: absolute;
            top: -10px;
            left: -10px;
            font-size: 50px;
            opacity: 0.1;
            transform: rotate(-15deg);
        }

        .countdown-card .title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .countdown-card .timer {
            font-size: 28px;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 15px;
        }

        .countdown-card .target-date {
            font-size: 12px;
            opacity: 0.8;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 10px;
        }

        /* === „ÄêÂÖ®Êñ∞„ÄëËÅäÂ§©ÈîÅÂÆöÈÅÆÁΩ©Â±ÇÊ†∑Âºè === */
        #chat-lock-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: rgba(247, 247, 247, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 150;
            /* ÊØîËæìÂÖ•Ê°ÜÈ´òÔºåÊØîË¥¥Á∫∏Èù¢Êùø‰Ωé */
            display: none;
            /* ÈªòËÆ§ÈöêËóè */
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            border-top: 1px solid var(--border-color);
            text-align: center;
        }

        #chat-lock-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        #chat-lock-content .lock-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        #chat-lock-content .lock-action-btn {
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--accent-color);
            background-color: var(--accent-color);
            color: white;
            cursor: pointer;
        }

        #chat-lock-content .lock-action-btn.secondary {
            background-color: transparent;
            color: var(--accent-color);
        }

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ∫¢ÂåÖÂç°ÁâáÊ†∑Âºè ‚ñº‚ñº‚ñº */
        .message-bubble.is-red-packet .content {
            padding: 0;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        .red-packet-card {
            width: 220px;
            border-radius: 8px;
            background: linear-gradient(160deg, #F96259, #E44D44);
            color: #ffd700;
            /* ÈáëËâ≤ÊñáÂ≠ó */
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .red-packet-card.opened {
            background: linear-gradient(160deg, #d3c4a0, #c4b693);
            cursor: default;
        }

        .red-packet-card::before {
            content: 'üßß';
            position: absolute;
            top: -5px;
            left: -5px;
            font-size: 30px;
            opacity: 0.2;
            transform: rotate(-10deg);
        }

        .rp-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .rp-icon {
            width: 20px;
            height: 20px;
        }

        .rp-greeting {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rp-type {
            font-size: 11px;
            color: white;
            opacity: 0.8;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 8px;
            margin-top: 8px;
        }

        .rp-claimed-info {
            font-size: 13px;
            color: white;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ∫¢ÂåÖËØ¶ÊÉÖÂàóË°®Ê†∑Âºè ‚ñº‚ñº‚ñº */
        .rp-details-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .rp-details-item:last-child {
            border-bottom: none;
        }

        .rp-details-item .name {
            flex-grow: 1;
            font-weight: 500;
            color: #333;
        }

        .rp-details-item .amount {
            font-weight: 500;
            color: #555;
        }

        .rp-details-item .lucky-king-tag {
            font-size: 10px;
            background-color: #ffd700;
            color: #a67c00;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: bold;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊäïÁ•®ÂäüËÉΩÊ†∑Âºè ‚ñº‚ñº‚ñº */

        /* ÊäïÁ•®Âç°ÁâáÂú®Ê∂àÊÅØÊ∞îÊ≥°‰∏≠ÁöÑÊ†∑Âºè */
        .message-bubble.is-poll .content {
            padding: 0;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        /* ÊäïÁ•®Âç°Áâá‰∏ª‰Ωì */
        .poll-card {
            width: 250px;
            background-color: #f9f9f9;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            padding: 12px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .poll-card.closed {
            background-color: #e9ecef;
            /* ÁªìÊùüÂêéÂèòÁÅ∞ */
        }

        /* ÊäïÁ•®ÈóÆÈ¢ò */
        .poll-question {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 12px;
            line-height: 1.4;
            word-break: break-word;
        }

        /* ÊäïÁ•®ÈÄâÈ°πÂàóË°® */
        .poll-options-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* Âçï‰∏™ÊäïÁ•®ÈÄâÈ°π */
        .poll-option-item {
            background-color: white;
            border: 1px solid #dcdcdc;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: background-color 0.2s;
        }

        .poll-card:not(.closed) .poll-option-item:hover {
            background-color: #f0f8ff;
        }

        /* Áî®Êà∑Â∑≤ÊäïÁ•®ÁöÑÈÄâÈ°πÊ†∑Âºè */
        .poll-option-item.voted {
            border-color: var(--accent-color);
            background-color: #e7f3ff;
            font-weight: 500;
        }

        /* ÊäïÁ•®ËøõÂ∫¶Êù° */
        .poll-option-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: rgba(0, 123, 255, 0.1);
            z-index: 1;
            transition: width 0.3s ease-in-out;
        }

        /* ÈÄâÈ°πÂÜÖÂÆπÔºàÊñáÂ≠óÂíåÁ•®Êï∞ÔºâÔºåÁ°Æ‰øùÂú®ËøõÂ∫¶Êù°‰πã‰∏ä */
        .poll-option-content {
            position: relative;
            z-index: 2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .poll-option-text {
            font-size: 14px;
        }

        .poll-option-votes {
            font-size: 13px;
            color: #8a8a8a;
            font-weight: 500;
        }

        /* ÊäïÁ•®Âç°ÁâáÂ∫ïÈÉ® */
        .poll-footer {
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid #e9e9e9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .poll-total-votes {
            font-weight: 500;
        }

        .poll-action-btn {
            background: none;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 4px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .poll-card.closed .poll-action-btn {
            background-color: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        /* ÂàõÂª∫ÊäïÁ•®Ê®°ÊÄÅÊ°ÜÁöÑÈÄâÈ°πËæìÂÖ• */
        .poll-option-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .poll-option-input-wrapper input {
            flex-grow: 1;
        }

        .poll-option-input-wrapper .remove-option-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #f0f0f0;
            color: #ff3b30;
            border: none;
            cursor: pointer;
            font-size: 18px;
            line-height: 28px;
            text-align: center;
            flex-shrink: 0;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞CSSÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËÅäÂ§©ÁïåÈù¢Â§¥ÈÉ®Áä∂ÊÄÅÈÄªËæëÊ†∑Âºè ‚ñº‚ñº‚ñº */
        #chat-header-status.typing .status-dot {
            animation: dot-pulse 1.5s infinite;
        }

        @keyframes dot-pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }

            100% {
                opacity: 1;
            }
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */




        /* ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂÖ¨ÂëäÊùøÂäüËÉΩÊ†∑Âºè - ËØ∑Â∞ÜÊï¥Âùó‰ª£Á†ÅÁ≤òË¥¥Âà∞ <style> Ê†áÁ≠æÊú´Â∞æ ‚ñº‚ñº‚ñº */

        /* ÂÖ¨ÂëäÊùøÊåâÈíÆ‰∏äÊú™ËØªÊ∂àÊÅØÁöÑÂ∞èÁ∫¢ÁÇπ */
        #open-bulletin-board-btn {
            position: relative;
            /* ‰∏∫‰∫ÜÂÆö‰ΩçÂ∞èÁ∫¢ÁÇπ */
        }

        /* ÂÖ¨ÂëäÊùøÊ®°ÊÄÅÊ°Ü */
        #bulletin-board-modal {
            z-index: 250;
            /* ÊØîË¥¥Á∫∏Èù¢ÊùøÈ´ò‰∏ÄÁÇπ */
        }

        /* ‚ñº‚ñº‚ñº „Äê‰øÆÂ§ç1„ÄëÊèêÂçáÂÖ¨ÂëäÊìç‰ΩúËèúÂçïÁöÑÂ±ÇÁ∫ß ‚ñº‚ñº‚ñº */
        #bulletin-actions-modal {
            z-index: 260;
            /* Á°Æ‰øùÊØîÂÖ¨ÂëäÊùøÊú¨Ë∫´(250)Êõ¥È´ò */
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* ÂÖ¨ÂëäÊùøÂÜÖÂÆπÂå∫ */
        #bulletin-board-modal .modal-body {
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            /* Âç°Áâá‰πãÈó¥ÁöÑÈó¥Ë∑ù */
            background-color: #f0f2f5;
            /* ÁªôÂàóË°®‰∏Ä‰∏™ÊµÖÁÅ∞Ëâ≤ËÉåÊôØ */
        }

        /* ÂÖ¨ÂëäÂç°ÁâáÔºàÂ§çÁî®Âä®ÊÄÅÊ†∑ÂºèÔºå‰ΩÜÊ∑ªÂä†‰∏Ä‰∫õÂæÆË∞ÉÔºâ */
        .bulletin-card {
            background-color: var(--secondary-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
            position: relative;
            /* ‰∏∫‰∫ÜÂÆö‰ΩçÊìç‰ΩúÊåâÈíÆ */
        }

        /* ÁΩÆÈ°∂ÂÖ¨ÂëäÁöÑÁâπÊÆäÊ†∑Âºè */
        .bulletin-card.pinned {
            border-left: 4px solid #ffc107;
            /* Â∑¶‰æßÊúâÈáëËâ≤ÁöÑÁΩÆÈ°∂Ê†áËÆ∞ */
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
        }

        .bulletin-card.pinned::after {
            content: 'üìå';
            position: absolute;
            top: 10px;
            left: -2px;
            font-size: 16px;
            opacity: 0.7;
        }


        /* ÂÖ¨ÂëäÂç°ÁâáÊìç‰ΩúÊåâÈíÆ */
        .bulletin-actions-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            font-size: 20px;
            font-weight: bold;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 50%;
            line-height: 1;
        }

        .bulletin-actions-btn:hover {
            background-color: #f0f0f0;
        }

        /* ËÅäÂ§©ÁïåÈù¢‰∏≠ÁöÑÂÖ¨ÂëäÊ∂àÊÅØÊ∞îÊ≥° */
        .message-bubble.is-bulletin {
            /* Â∞Ü align-self Â∫îÁî®Âà∞Ê∞îÊ≥°Êú¨Ë∫´ÔºåËÄå‰∏çÊòØÂÆÉÁöÑÂÜÖÂÆπÂå∫ */
            align-self: center;
        }

        .message-bubble.is-bulletin .content {
            padding: 0;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            max-width: 250px;
            /* ÈôêÂà∂Âç°ÁâáÂú®ËÅäÂ§©‰∏≠ÁöÑÊúÄÂ§ßÂÆΩÂ∫¶ */
        }

        /* ‚ñº‚ñº‚ñº „Äê‰øÆÂ§ç„Äë‰∏∫ÂÖ¨ÂëäÊùøÂç°ÁâáÊ∑ªÂä†ËØÑËÆ∫Âå∫Ê†∑Âºè ‚ñº‚ñº‚ñº */
        .bulletin-card .post-footer {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        .bulletin-card .post-comments-container {
            padding: 5px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
            font-size: 13px;
            max-height: 150px;
            /* ÈôêÂà∂ËØÑËÆ∫Âå∫ÊúÄÂ§ßÈ´òÂ∫¶ */
            overflow-y: auto;
            /* Ë∂ÖÂá∫ÂàôÊªöÂä® */
        }

        .bulletin-card .comment-item {
            line-height: 1.5;
        }

        .bulletin-card .comment-item .commenter-name {
            font-weight: 600;
            color: var(--accent-color);
            margin-right: 5px;
        }

        .bulletin-card .comment-item .comment-text {
            color: var(--text-primary);
            word-break: break-word;

        }

        #status-bar {
            display: none !important;
        }

        /* ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÂ§çÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */
        /* ‚ñ≤‚ñ≤‚ñ≤ ÂÖ¨ÂëäÊùøÂäüËÉΩÊ†∑ÂºèÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

        /* Floating phone charm */
        .floating-phone-charm {
            position: fixed;
            top: 48px;
            right: -112px;
            width: 220px;
            height: 220px;
            background-image: url('https://files.catbox.moe/rhrobi.gif');
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 1000;
            pointer-events: auto;
            cursor: grab;
            transition: transform 0.2s ease;
            user-select: none;
        }

        .floating-phone-charm:active {
            cursor: grabbing;
        }

        .floating-phone-charm.dragging {
            opacity: 0.5;
            transition: none;
        }

        /* Export Progress Modal */
        #export-progress-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #export-progress-modal-overlay.visible {
            display: flex;
            opacity: 1;
        }

        #export-progress-modal {
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        #export-progress-modal-overlay.visible #export-progress-modal {
            transform: scale(1);
        }
    </style>
</head>

<body>
    <div id="phone-frame">
        <div class="notch"></div>
        <div id="phone-screen">
            <!-- Floating phone charm -->
            <div id="floating-phone-charm" class="floating-phone-charm"></div>

            <div id="status-bar">
                <span id="status-bar-time">12:00</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">--%</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src="">
                <div id="notification-content">
                    <div class="name"></div>
                    <div class="message"></div>
                </div>
            </div>

            <div id="home-screen" class="screen active">
                <div id="clock-container">
                    <div id="main-time">12:00</div>
                    <div id="main-date">ÊòüÊúü‰∏Ä, 1Êúà1Êó•</div>
                </div>
                <!-- Home Screen Now Playing Bar -->
                <div id="home-now-playing-bar" class="now-playing-bar home-screen-bar hidden">
                    <div class="now-playing-content">
                        <div class="np-album-art">
                            <img id="home-np-album-image" src="" alt="Album Art" style="display: none;">
                            <div class="np-default-icon">üéµ</div>
                        </div>
                        <div class="np-song-info">
                            <div id="home-np-song-title" class="np-song-title">Êú™Áü•Ê≠åÊõ≤</div>
                            <div id="home-np-song-artist" class="np-song-artist">Êú™Áü•Ëâ∫ÊúØÂÆ∂</div>
                        </div>
                        <div class="np-right-section">
                            <div class="np-playback-controls">
                                <button id="home-np-prev-btn" class="np-control-btn" title="‰∏ä‰∏ÄÈ¶ñ">‚èÆ</button>
                                <button id="home-np-play-pause-btn" class="np-control-btn play-pause"
                                    title="Êí≠Êîæ/ÊöÇÂÅú">‚ñ∂</button>
                                <button id="home-np-next-btn" class="np-control-btn" title="‰∏ã‰∏ÄÈ¶ñ">‚è≠</button>
                            </div>
                            <div class="np-partner-avatar">
                                <img id="home-np-partner-avatar" src="https://files.catbox.moe/q6z5fc.jpeg"
                                    alt="Partner">
                            </div>
                        </div>
                    </div>
                    <div class="np-progress-bar">
                        <div id="home-np-progress-fill" class="np-progress-fill"></div>
                    </div>
                </div>

                <!-- Home Screen Date Progress Bar -->
                <div id="home-meetup-progress-bar" class="meetup-progress-bar home-screen-bar hidden">
                    <div class="meetup-progress-content">
                        <div class="meetup-ai-avatar">
                            <img id="home-meetup-ai-avatar" src="" alt="AI Avatar">
                        </div>
                        <div class="meetup-progress-info">
                            <span id="home-meetup-progress-text" class="meetup-progress-text">‰∏éAIÂú®Âú∞ÁÇπ</span>
                            <span class="meetup-separator"> | </span>
                            <svg class="meetup-clock-icon" width="12" height="12" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="rgba(255,255,255,0.75)" stroke-width="2" />
                                <polyline points="12,6 12,12 16,14" stroke="rgba(255,255,255,0.75)" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <span id="home-meetup-elapsed-text" class="meetup-elapsed-text">00:00:00</span>
                        </div>
                    </div>
                </div>

                <div id="app-grid">
                    <!-- Á¨¨‰∏ÄË°åÔºöÁ©∫ÁΩÆ -->
                    <div class="app-row">
                    </div>
                    <!-- Á¨¨‰∫åË°åÔºöÊîæ4‰∏™ÂõæÊ†á -->
                    <div class="app-row">
                        <!-- Blur container behind the icons -->
                        <div class="app-dock-blur"></div>
                        <div class="app-icon" onclick="showScreen('chat-list-screen')">
                            <div class="icon-bg"><img src="https://files.catbox.moe/janu1z.png" alt="QQ"></div><span
                                class="label">QQ</span>
                        </div>
                        <div class="app-icon"
                            onclick="showScreen('chat-list-screen'); document.querySelector('.nav-item[data-view=qzone-screen]').click()">
                            <div class="icon-bg"><img src="https://files.catbox.moe/65cdyc.png" alt="ÊúãÂèãÂúà"></div><span
                                class="label">ÊúãÂèãÂúà</span>
                        </div>

                        <div class="app-icon" onclick="showScreen('calendar-screen')">
                            <div class="icon-bg"><img src="https://files.catbox.moe/2i4irb.png" alt="Êó•ÂéÜ"></div><span
                                class="label">Êó•ÂéÜ</span>
                        </div>

                        <div class="app-icon" onclick="showScreen('settings-screen')">
                            <div class="icon-bg"><img src="https://files.catbox.moe/xmo1uf.png" alt="ËÆæÁΩÆ"></div><span
                                class="label">ËÆæÁΩÆ</span>
                        </div>
                    </div>
                </div>
            </div>



            <div id="world-book-screen" class="screen">
                <div class="header"><span class="back-btn"
                        onclick="showScreen('settings-screen')">‚Äπ</span><span>‰∏ñÁïå‰π¶</span><span class="action-btn"
                        id="add-world-book-btn">+</span></div>
                <div id="world-book-list"></div>
            </div>

            <div id="settings-screen" class="screen">
                <div class="header"><span class="back-btn"
                        onclick="showScreen('home-screen')">‚Äπ</span><span>ËÆæÁΩÆ</span><span style="width: 30px;"></span>
                </div>
                <div id="settings-list"></div>
            </div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">‚Äπ</span>
                    <span id="world-book-editor-title">ÁºñËæë‰∏ñÁïå‰π¶</span>
                    <span class="save-btn" id="save-world-book-btn">‰øùÂ≠ò</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">‰π¶Âêç</label>
                        <input type="text" id="world-book-name-input" placeholder="ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÁöÑÂêçÁß∞...">
                    </div>
                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">ÂÜÖÂÆπ</label>
                        <textarea id="world-book-content-input" placeholder="Âú®Ê≠§Â§ÑËæìÂÖ•ËØ¶ÁªÜÁöÑ‰∏ñÁïåËßÇËÆæÂÆö..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen">
                <div class="header"><span class="back-btn" onclick="showScreen('settings-screen')">‚Äπ</span><span>API
                        ËÆæÁΩÆ</span><span style="width: 30px;"></span></div>
                <div class="form-container">
                    <p
                        style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">
                        ÊèêÁ§∫: Ëã•Ë¶Å‰ΩøÁî®‚ÄúÂèëÈÄÅÂõæÁâá‚ÄùÂäüËÉΩ, ËØ∑Âä°ÂøÖÈÄâÊã©ÊîØÊåÅVision(ËßÜËßâ)ÁöÑÊ®°Âûã, Â¶Ç<code
                            style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>Êàñ<code
                            style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>„ÄÇ
                    </p>
                    <div class="form-group"><label for="proxy-url">Âèç‰ª£Âú∞ÂùÄ (‰∏çÈúÄË¶ÅÊ∑ªÂä†/v1Âô¢~)</label><input type="text"
                            id="proxy-url" placeholder="‰æãÂ¶Ç: https://api.openai.com"></div>
                    <div class="form-group"><label for="api-key">ÂØÜÈí• (API Key)</label><input type="password" id="api-key"
                            placeholder="sk-..."></div>
                    <div class="form-group"><label for="model-select">Ê®°Âûã</label><select id="model-select"></select>
                    </div><button class="form-button" id="fetch-models-btn">ÊãâÂèñÊ®°Âûã</button>

                    <!-- ‚ñº‚ñº‚ñº Â∞ÜËøôÊÆµ‰ª£Á†ÅÁ≤òË¥¥Âà∞ API ËÆæÁΩÆÈ°µÈù¢ÁöÑ‚Äú‰øùÂ≠òËÆæÁΩÆ‚ÄùÊåâÈíÆ‰∏äÊñπ ‚ñº‚ñº‚ñº -->
                    <hr style="margin:20px 0; opacity:.3">
                    <div class="form-group" style="display: flex; justify-content: space-between; align-items: center;">
                        <label for="background-activity-switch" style="margin-bottom: 0;">
                            ÂêØÁî®ÂêéÂè∞ËßíËâ≤Ê¥ªÂä®
                            <p style="font-size: 12px; font-weight: normal; color: #ff6b6b; margin-top: 5px;">
                                Ë≠¶ÂëäÔºöÊ≠§ÂäüËÉΩ‰ºöÊòæËëóÂ¢ûÂä†APIË∞ÉÁî®ÂíåË¥πÁî®ÔºÅ
                            </p>
                        </label>
                        <input type="checkbox" id="background-activity-switch" style="width: auto; height: 20px;">
                    </div>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

                    <!-- ‚ñº‚ñº‚ñº Â∞ÜËøôÊÆµ‰ª£Á†ÅÁ≤òË¥¥Âà∞‚ÄúÂêØÁî®ÂêéÂè∞ËßíËâ≤Ê¥ªÂä®‚ÄùÂºÄÂÖ≥ÁöÑ‰∏ãÊñπ ‚ñº‚ñº‚ñº -->
                    <div class="form-group"
                        style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <label for="background-interval-input" style="margin-bottom: 0;">
                            ÂêéÂè∞Ê¥ªÂä®Ê£ÄÊµãÈó¥Èöî (Áßí)
                            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                                Âª∫ËÆÆÂÄº 60-300„ÄÇÂÄºË∂äÂ§ßÔºåË¥πÁî®Ë∂ä‰ΩéÔºå‰ΩÜËßíËâ≤ÂèçÂ∫îË∂äÊÖ¢„ÄÇ
                            </p>
                        </label>
                        <input type="number" id="background-interval-input" min="30" value="60"
                            style="width: 80px; text-align: center;">
                    </div>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                    <!-- ‚ñº‚ñº‚ñº Âú®ËøôÈáåÊñ∞Â¢û ‚ñº‚ñº‚ñº -->
                    <div class="form-group"
                        style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <label for="ai-cooldown-input" style="margin-bottom: 0;">
                            AIÂèëË®ÄÂÜ∑ÈùôÊúü (ÂàÜÈíü)
                            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                                AI‰∏ªÂä®ÂèëËµ∑Ë°åÂä®ÂâçÈúÄÁ≠âÂæÖÁöÑÊó∂Èó¥„ÄÇ0‰∏∫Êó†ÈôêÂà∂„ÄÇ
                            </p>
                        </label>
                        <input type="number" id="ai-cooldown-input" min="0" step="1" value="5"
                            style="width: 80px; text-align: center;">
                    </div>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                    <!-- ‚ñº‚ñº‚ñº Âú®ËøôÈáåÊñ∞Â¢û ‚ñº‚ñº‚ñº -->
                    <div class="form-group"
                        style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <label for="block-cooldown-input" style="margin-bottom: 0;">
                            AIË¢´ÊãâÈªëÂêéÂÜ∑ÈùôÊúü (Â∞èÊó∂)
                            <p style="font-size: 12px; font-weight: normal; color: #999; margin-top: 5px;">
                                Ë¢´ÊãâÈªëË∂ÖËøáËøô‰∏™Êó∂Èó¥ÂêéÔºåAIÊâçÊúâÂá†ÁéáÈáçÊñ∞Áî≥ËØ∑Â•ΩÂèã„ÄÇ
                            </p>
                        </label>
                        <input type="number" id="block-cooldown-input" min="0.1" step="0.1" value="1"
                            style="width: 80px; text-align: center;">
                    </div>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

                    <button class="form-button" id="save-api-settings-btn">‰øùÂ≠òËÆæÁΩÆ</button>

                </div>

            </div>
            <!-- ‚ñº‚ñº‚ñº Áî®‰∏ãÈù¢ËøôÊÆµ‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†ÂéüÊù•ÁöÑ chat-list-screen ‚ñº‚ñº‚ñº -->
            <div id="chat-list-screen" class="screen">

                <!-- ‰∏ªÂ§¥ÈÉ® (Âè™Âú®Ê∂àÊÅØÂàóË°®ÊòæÁ§∫) -->
                <div class="header" id="main-chat-list-header">
                    <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
                    <span>Ê∂àÊÅØ</span>
                    <div class="header-actions">
                        <span class="action-btn" id="add-group-chat-btn" title="ÂàõÂª∫Áæ§ËÅä"><svg width="24" height="24"
                                viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path
                                    d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg></span>
                        <span class="action-btn" id="add-chat-btn">+</span>
                    </div>
                </div>

                <!-- Ê∂àÊÅØÂàóË°®ËßÜÂõæ -->
                <div id="messages-view" class="chat-list-view active">
                    <div id="chat-list">
                        <!-- JS‰ºöÂú®ËøôÈáåÁîüÊàêËÅäÂ§©ÂàóË°® -->
                    </div>
                </div>

                <!-- Âä®ÊÄÅÁïåÈù¢ËßÜÂõæ -->
                <div id="qzone-screen" class="chat-list-view">
                    <div class="qzone-header">
                        <span class="back-btn" id="qzone-back-btn">‚Äπ</span> <!-- Ëøô‰∏™ÊåâÈíÆÁé∞Âú®Âè™Ë¥üË¥£‰ªéÂä®ÊÄÅËøîÂõû -->
                        <span>ÊúãÂèãÂúà</span>
                        <span class="ai-post-btn" id="qzone-add-post-btn" title="Ê∑ªÂä†ÂÜÖÂÆπ">+</span>
                        <span class="ai-post-btn" id="ai-post-btn" title="ËÆ©AIÂèëÂä®ÊÄÅ">ü§ñ</span>
                    </div>
                    <div class="qzone-content">
                        <div class="qzone-profile-header">
                            <div id="qzone-banner-container" class="qzone-banner-container">
                                <img id="qzone-banner-img" src="https://files.catbox.moe/r5heyt.gif" alt="ËÉåÊôØ">
                                <input type="file" id="qzone-banner-input" accept="image/*" hidden>
                            </div>
                            <div class="qzone-user-info">
                                <div id="qzone-avatar-container" class="qzone-avatar-container">
                                    <img id="qzone-avatar-img" src="https://files.catbox.moe/q6z5fc.jpeg" alt="Â§¥ÂÉè"
                                        class="avatar">
                                    <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                                </div>
                                <div class="qzone-user-text">
                                    <span id="qzone-nickname">{{user}}</span>
                                    <span id="qzone-status">Ëøô‰∏™Áî®Êà∑ÂæàÊáíÔºå‰ªÄ‰πà‰πüÊ≤°Áïô‰∏ã</span>
                                </div>
                            </div>
                        </div>
                        <div class="qzone-actions-bar" style="display: none;">
                            <div class="action-item" id="create-shuoshuo-btn"><span>ËØ¥ËØ¥</span></div>
                            <div class="action-item" id="create-post-btn"><span>Âä®ÊÄÅ</span></div>
                            <div class="action-item" id="open-album-btn"><span>Áõ∏ÂÜå</span></div>
                        </div>
                        <div id="qzone-posts-list"></div>
                    </div>
                </div>

                <!-- Êî∂ËóèÁïåÈù¢ËßÜÂõæ -->
                <div id="favorites-view" class="chat-list-view">
                    <div class="header">
                        <span class="back-btn" id="favorites-back-btn">‚Äπ</span>
                        <span>ÊàëÁöÑÊî∂Ëóè</span>
                        <!-- Êñ∞Â¢ûÁöÑÁºñËæëÊåâÈíÆ -->
                        <span class="action-btn" id="favorites-edit-btn">ÁºñËæë</span>
                    </div>

                    <!-- „ÄêÊñ∞Â¢û„ÄëÊêúÁ¥¢Ê†èÂÆπÂô® -->
                    <div class="search-bar-container">
                        <input type="search" id="favorites-search-input" placeholder="ÊêúÁ¥¢Êî∂ËóèÁöÑÊ†áÈ¢ò„ÄÅÂÜÖÂÆπÊàñ‰ΩúËÄÖ...">
                        <button id="favorites-search-clear-btn" class="search-clear-btn"
                            style="display: none;">√ó</button>
                    </div>

                    <div id="favorites-list" class="list-container">
                        <!-- Êî∂ËóèÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                    </div>

                    <!-- Êñ∞Â¢ûÔºöÊî∂ËóèÈ°µÂ∫ïÈÉ®Êìç‰ΩúÊ†è -->
                    <div id="favorites-action-bar" style="display: none;">
                        <button id="favorites-delete-selected-btn" class="action-bar-btn">Âà†Èô§ (0)</button>
                    </div>

                </div>

                <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂõûÂøÜÂΩïÁïåÈù¢ËßÜÂõæ ‚ñº‚ñº‚ñº -->
                <div id="memories-view" class="chat-list-view">
                    <div class="header">
                        <span class="back-btn" id="memories-back-btn">‚Äπ</span>
                        <span>Êàë‰ª¨ÁöÑÂõûÂøÜ</span>
                        <span class="action-btn" id="add-countdown-btn">+</span>
                    </div>
                    <div id="memories-list" class="list-container"
                        style="padding: 15px; display: flex; flex-direction: column; gap: 15px;">
                        <!-- ÂõûÂøÜÂç°ÁâáÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                    </div>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûHTMLÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

                <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
                <div id="chat-list-bottom-nav">
                    <div class="nav-item active" data-view="messages-view">
                        <span>Ê∂àÊÅØ</span>
                    </div>
                    <div class="nav-item" data-view="qzone-screen" style="display: none;">
                        <span>Âä®ÊÄÅ</span>
                    </div>
                    <!-- ‚ñº‚ñº‚ñº Âú®‚ÄúÂä®ÊÄÅ‚ÄùÂíå‚ÄúÊî∂Ëóè‚Äù‰πãÈó¥ÔºåÂä†ÂÖ•Ëøô‰∏™Êñ∞È°µÁ≠æ ‚ñº‚ñº‚ñº -->
                    <div class="nav-item" data-view="memories-view">
                        <span>ÂõûÂøÜ</span>
                    </div>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                    <div class="nav-item" data-view="favorites-view">
                        <span>Êî∂Ëóè</span>
                    </div>
                </div>
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢Âå∫ÂüüÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

            <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞ÁöÑ HTML Á≤òË¥¥Âà∞ id="chat-list-screen" ÁöÑ div ‰πãÂêé ‚ñº‚ñº‚ñº -->
            <div id="album-screen" class="screen">
                <!-- 1. È°µÈù¢Â§¥ÈÉ®ÔºåÂåÖÂê´ËøîÂõûÊåâÈíÆÂíåÊ†áÈ¢ò -->
                <div class="header">
                    <span class="back-btn" id="album-back-btn">‚Äπ</span>
                    <span>ÊàëÁöÑÁõ∏ÂÜå</span>
                    <span class="action-btn" id="create-album-btn-page">+</span>
                </div>

                <!-- 2. È°µÈù¢ÂÜÖÂÆπÂÆπÂô® -->
                <div class="list-container">
                    <div id="album-grid-page">
                        <!-- Áõ∏ÂÜåÂàóË°®Â∞ÜÁî± JS Âä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                    </div>
                </div>
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÁöÑ HTML Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

            <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞ÁöÑ HTML Á≤òË¥¥Âà∞ id="album-screen" ÁöÑ div ‰πãÂêé ‚ñº‚ñº‚ñº -->
            <div id="album-photos-screen" class="screen">
                <!-- 1. È°µÈù¢Â§¥ÈÉ® -->
                <div class="header">
                    <span class="back-btn" id="album-photos-back-btn">‚Äπ</span>
                    <span id="album-photos-title">Áõ∏ÂÜåÂêçÁß∞</span>
                    <span class="action-btn" id="album-upload-photo-btn">‰∏ä‰º†</span>
                </div>

                <!-- 2. È°µÈù¢ÂÜÖÂÆπÂÆπÂô® -->
                <div class="list-container">
                    <div id="photos-grid-page">
                        <!-- ÁÖßÁâáÂàóË°®Â∞ÜÁî± JS Âä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                    </div>

                    <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞ÁöÑ HTML Á≤òË¥¥Âà∞ÊâÄÊúâÊ®°ÊÄÅÊ°ÜÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº -->
                    <div id="photo-viewer-modal" class="modal">
                        <!-- 1. ÂÖ≥Èó≠ÊåâÈíÆ -->
                        <button id="photo-viewer-close-btn">√ó</button>

                        <!-- 2. ‰∏ä‰∏ÄÂº†ÁÖßÁâáÊåâÈíÆ -->
                        <button id="photo-viewer-prev-btn" class="nav-arrow">‚Äπ</button>

                        <!-- 3. ÂõæÁâáÂÆπÂô® -->
                        <div class="photo-viewer-content">
                            <img id="photo-viewer-image" src="" alt="ÂÖ®Â±èÁÖßÁâáÈ¢ÑËßà">
                        </div>

                        <!-- 4. ‰∏ã‰∏ÄÂº†ÁÖßÁâáÊåâÈíÆ -->
                        <button id="photo-viewer-next-btn" class="nav-arrow">‚Ä∫</button>
                    </div>
                    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÁöÑ HTML Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

                </div>
            </div>
            <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÁöÑ HTML Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

            <!-- ‚ñº‚ñº‚ñº Á≤òË¥¥Âà∞ #album-photos-screen ÁöÑ div ‰πãÂêé ‚ñº‚ñº‚ñº -->
            <input type="file" id="album-photo-input" accept="image/*" multiple hidden>

            <!-- ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô„Äê‰∏ÄÊï¥Âùó„ÄëÂÖ®Êñ∞ÁöÑ‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢ÊéâÊÇ®Êñá‰ª∂‰∏≠ÊóßÁöÑ #chat-interface-screen ÂèäÂÖ∂ÊâÄÊúâÂÜÖÂÆπ ‚ñº‚ñº‚ñº -->
            <div id="chat-interface-screen" class="screen">

                <!-- „ÄêÊúÄÁªà‰øÆÊ≠£Áâà„ÄëHeaderÔºåÂ∑≤Â∞ÜÁä∂ÊÄÅÊ†èÂíåÊêúÁ¥¢ÂäüËÉΩÊ≠£Á°ÆÊï¥Âêà -->
                <div class="header">
                    <!-- ÈªòËÆ§Êéß‰ª∂ÔºöÂåÖÂê´Ê†áÈ¢ò„ÄÅÁä∂ÊÄÅÊ†èÂíåÂ∏∏ËßÑÊåâÈíÆ -->
                    <div class="default-controls">
                        <span class="back-btn" id="back-to-list-btn">‚Äπ</span>

                        <!-- ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÊ†áÈ¢òÂíåÁä∂ÊÄÅÁöÑÂÆπÂô® ‚ñº‚ñº‚ñº -->
                        <div id="chat-header-title-wrapper">
                            <span id="chat-header-title">ËÅäÂ§©ÂØπË±°</span>
                            <div id="chat-header-status">
                                <span class="status-dot"></span>
                                <span class="status-text">Âú®Á∫ø</span>
                            </div>
                        </div>
                        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

                        <div class="header-actions">
                            <span class="action-btn" id="chat-search-btn" title="ÊêúÁ¥¢Ê∂àÊÅØ"><svg width="24" height="24"
                                    viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="20" cy="20" r="14" stroke="currentColor" stroke-width="4"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="m30.5 30.5 9.5 9.5" stroke="currentColor" stroke-width="4"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                </svg></span>
                            <!-- ËØ∑Â∞ÜËøô‰∏§Ë°åÊñ∞‰ª£Á†ÅÁ≤òË¥¥Âà∞‰∏äÈù¢Âà†Èô§ÁöÑ‰ΩçÁΩÆ -->
                            <span class="action-btn" id="listen-together-btn" title="‰∏ÄËµ∑Âê¨"><svg width="24" height="24"
                                    viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M10 36V24C10 16.268 16.268 10 24 10C31.732 10 38 16.268 38 24V36M10 26H6C4.89543 26 4 26.8954 4 28V36C4 37.1046 4.89543 38 6 38H10V26ZM38 26H42C43.1046 26 44 26.8954 44 28V36C44 37.1046 43.1046 38 42 38H38V26Z"
                                        stroke="currentColor" stroke-width="4" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M16 32H20L22 26L26 38L28 32H32" stroke="currentColor" stroke-width="4"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                </svg></span>
                            <span class="action-btn" id="meetup-btn" title="ËßÅÈù¢Ê®°Âºè"><svg width="24" height="24"
                                    viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <rect x="6" y="10" width="36" height="32" rx="2" stroke="currentColor"
                                        stroke-width="4" stroke-linejoin="round" />
                                    <path d="M14 6V14" stroke="currentColor" stroke-width="4" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M34 6V14" stroke="currentColor" stroke-width="4" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M6 18H42" stroke="currentColor" stroke-width="4" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <circle cx="16" cy="28" r="2" fill="currentColor" />
                                    <circle cx="24" cy="28" r="2" fill="currentColor" />
                                    <circle cx="32" cy="28" r="2" fill="currentColor" />
                                    <path d="M20 32C20 30 22 30 24 32C26 30 28 30 28 32" stroke="currentColor"
                                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                </svg></span>
                            <span class="action-btn" id="chat-settings-btn" title="ËÅäÂ§©ËÆæÁΩÆ"><svg width="24" height="24"
                                    viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M41.5 10H35.5" stroke="currentColor" stroke-width="4"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M27.5 6V14" stroke="currentColor" stroke-width="4" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M27.5 10L5.5 10" stroke="currentColor" stroke-width="4"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M13.5 24H5.5" stroke="currentColor" stroke-width="4" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M21.5 20V28" stroke="currentColor" stroke-width="4" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M43.5 24H21.5" stroke="currentColor" stroke-width="4"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M41.5 38H35.5" stroke="currentColor" stroke-width="4"
                                        stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M27.5 34V42" stroke="currentColor" stroke-width="4" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                    <path d="M27.5 38H5.5" stroke="currentColor" stroke-width="4" stroke-linecap="round"
                                        stroke-linejoin="round" />
                                </svg></span>
                        </div>
                    </div>

                    <!-- Â§öÈÄâÊ®°ÂºèÊéß‰ª∂ (‰øùÊåÅ‰∏çÂèò) -->
                    <div class="selection-controls">
                        <span id="selection-cancel-btn">ÂèñÊ∂à</span>
                        <span id="selection-count"></span>
                        <div class="header-actions">
                            <span id="selection-favorite-btn" class="action-btn">Êî∂Ëóè</span>
                            <span id="selection-delete-btn" class="action-btn" style="color: #ff3b30;">Âà†Èô§</span>
                        </div>
                    </div>
                </div>

                <!-- Now Playing Bar -->
                <div id="now-playing-bar" class="now-playing-bar hidden">
                    <div class="now-playing-content">
                        <div class="np-album-art">
                            <img id="np-album-image" src="" alt="Album Art" style="display: none;">
                            <div class="default-icon">‚ô™</div>
                        </div>
                        <div class="np-song-info">
                            <div class="np-song-title" id="np-song-title">ËØ∑Ê∑ªÂä†Ê≠åÊõ≤</div>
                            <div class="np-song-artist" id="np-song-artist">ÊöÇÊó†Êí≠Êîæ</div>
                        </div>
                        <div class="np-right-section">
                            <div class="np-playback-controls">
                                <button id="np-prev-btn" class="np-control-btn" title="‰∏ä‰∏ÄÈ¶ñ">‚èÆ</button>
                                <button id="np-play-pause-btn" class="np-control-btn play-pause"
                                    title="Êí≠Êîæ/ÊöÇÂÅú">‚ñ∂</button>
                                <button id="np-next-btn" class="np-control-btn" title="‰∏ã‰∏ÄÈ¶ñ">‚è≠</button>
                            </div>
                            <div class="np-partner-avatar">
                                <img id="np-partner-avatar" src="" alt="Listening Partner">
                            </div>
                        </div>
                    </div>
                    <div class="np-progress-bar">
                        <div id="np-progress-fill" class="np-progress-fill"></div>
                    </div>
                </div>

                <!-- Date Progress Bar -->
                <div id="meetup-progress-bar" class="meetup-progress-bar hidden">
                    <div class="meetup-progress-content">
                        <div class="meetup-ai-avatar">
                            <img id="meetup-ai-avatar" src="" alt="AI Avatar">
                        </div>
                        <div class="meetup-progress-info">
                            <span id="meetup-progress-text" class="meetup-progress-text">‰∏éAIÂú®Âú∞ÁÇπ</span>
                            <span class="meetup-separator"> | </span>
                            <svg class="meetup-clock-icon" width="12" height="12" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <circle cx="12" cy="12" r="10" stroke="rgba(255,255,255,0.75)" stroke-width="2" />
                                <polyline points="12,6 12,12 16,14" stroke="rgba(255,255,255,0.75)" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <span id="meetup-elapsed-text" class="meetup-elapsed-text">00:00:00</span>
                        </div>
                    </div>
                </div>

                <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü (‰øùÊåÅ‰∏çÂèò) -->
                <div id="chat-messages">
                    <div id="typing-indicator">ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...</div>
                </div>

                <!-- ËæìÂÖ•Âå∫Âüü (‰øùÊåÅ‰∏çÂèò) -->
                <div id="chat-input-area">
                    <div id="chat-input-actions-top">
                        <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button"
                            title="Ë°®ÊÉÖÈù¢Êùø">
                            <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                <line x1="9" y1="9" x2="9.01" y2="9"/>
                                <line x1="15" y1="9" x2="15.01" y2="9"/>
                            </svg>
                        </button>
                        <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="ÂèëÈÄÅÁÖßÁâá"><svg
                                width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path
                                    d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
                                <circle cx="12" cy="13" r="4" />
                            </svg></button>
                        <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="‰∏ä‰º†ÂõæÁâá"><svg
                                width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg" style="color: var(--text-primary);">
                                <path
                                    d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path
                                    d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg></button>
                        <button id="transfer-btn" class="chat-action-icon-btn action-button" title="ËΩ¨Ë¥¶">Ôø•</button>
                        <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="ÂèëÈÄÅËØ≠Èü≥"><svg
                                width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                                <path d="M12 19v4" />
                                <path d="M8 23h8" />
                            </svg></button>
                        <!-- ‚ñº‚ñº‚ñº Â∞ÜËøôË°åÊñ∞‰ª£Á†ÅÁ≤òË¥¥Âà∞‚ÄúÂèëÈÄÅËØ≠Èü≥‚ÄùÊåâÈíÆÁöÑÂêéÈù¢ ‚ñº‚ñº‚ñº -->
                        <button id="send-waimai-request-btn" class="chat-action-icon-btn action-button"
                            title="ÂèëËµ∑Â§ñÂçñËØ∑Ê±Ç"><svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z" />
                                <line x1="3" y1="6" x2="21" y2="6" />
                                <path d="M16 10a4 4 0 0 1-8 0" />
                            </svg></button>
                        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                        <!-- ‚ñº‚ñº‚ñº „ÄêÊñ∞Â¢û„ÄëËßÜÈ¢ëÈÄöËØùÊåâÈíÆ ‚ñº‚ñº‚ñº -->
                        <button id="video-call-btn" class="chat-action-icon-btn action-button" title="ËßÜÈ¢ëÈÄöËØù"><svg
                                width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                            </svg></button>
                        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
<!-- ‚ñº‚ñº‚ñºÁæ§ËßÜÈ¢ëÈÄöËØùÊåâÈíÆ ‚ñº‚ñº‚ñº -->
                        <button id="group-video-call-btn" class="chat-action-icon-btn action-button" title="Áæ§ËßÜÈ¢ëÈÄöËØù"><svg
                                width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg></button>
                        <!-- ‚ñ≤‚ñ≤‚ñ≤ ÂÖ®Êñ∞Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                        <!-- ‚ñº‚ñº‚ñºÂèëËµ∑ÊäïÁ•®ÊåâÈíÆ‚ñº‚ñº‚ñº -->
                        <button id="send-poll-btn" class="chat-action-icon-btn action-button" title="ÂèëËµ∑ÊäïÁ•®"><svg
                                width="24" height="24" viewBox="0 0 48 48" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <path
                                    d="M42 20V39C42 40.6569 40.6569 42 39 42H9C7.34315 42 6 40.6569 6 39V9C6 7.34315 7.34315 6 9 6H30"
                                    stroke="currentColor" stroke-width="4" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M16 20L26 28L41 7" stroke="currentColor" stroke-width="4"
                                    stroke-linecap="round" stroke-linejoin="round" />
                            </svg></button>

                        <button id="open-bulletin-board-btn" class="chat-action-icon-btn action-button" title="ÂÖ¨ÂëäÊùø"><svg
                                width="24" height="24" viewBox="0 0 48 48" fill="none"
                                xmlns="http://www.w3.org/2000/svg">
                                <rect x="4" y="15" width="40" height="26" rx="2" fill="none" stroke="currentColor"
                                    stroke-width="4" stroke-linejoin="round" />
                                <path d="M24 7L16 15H32L24 7Z" fill="none" stroke="currentColor" stroke-width="4"
                                    stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M12 24H30" stroke="currentColor" stroke-width="4" stroke-linecap="round"
                                    stroke-linejoin="round" />
                                <path d="M12 32H20" stroke="currentColor" stroke-width="4" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg></button>

                        <!-- ‚ñº‚ñº‚ñº Share Link Button ‚ñº‚ñº‚ñº -->
                        <button id="share-link-btn" class="chat-action-icon-btn action-button" title="ÂàÜ‰∫´ÈìæÊé•"><svg
                                width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"></path>
                            </svg></button>
                        <!-- ‚ñ≤‚ñ≤‚ñ≤ Share Link Button End ‚ñ≤‚ñ≤‚ñ≤ -->

                        <!-- ‚ñº‚ñº‚ñº Location Share Button ‚ñº‚ñº‚ñº -->
                        <button id="share-location-btn" class="chat-action-icon-btn action-button" title="ÂàÜ‰∫´‰ΩçÁΩÆ"><svg
                                width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg></button>
                        <!-- ‚ñ≤‚ñ≤‚ñ≤ Location Share Button End ‚ñ≤‚ñ≤‚ñ≤ -->

                        <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                    </div>

                    <div id="reply-preview-bar">
                        <div class="reply-preview-content">
                            <div class="sender">ÂõûÂ§ç xxx:</div>
                            <div class="text">Ë¢´ÂºïÁî®ÁöÑÊ∂àÊÅØÂÜÖÂÆπ...</div>
                        </div>
                        <span id="cancel-reply-btn">√ó</span>
                    </div>

                    <div id="chat-input-main-row">
                        <textarea id="chat-input" rows="1" placeholder="ËæìÂÖ•Ê∂àÊÅØ..."></textarea>
                        <div id="input-actions-wrapper">
                            <button id="wait-reply-btn" title="Á≠âÂæÖÂõûÂ§ç"><img
                                    src="https://i.postimg.cc/2SwjsfZQ/IMG-6913.gif" alt="Á≠âÂæÖÂõûÂ§ç"></button>
                            <button id="send-btn" class="action-button">ÂèëÈÄÅ</button>
                        </div>
                    </div>
                </div>

                <!-- ‚ñº‚ñº‚ñº Âú®ËøôÈáåÊñ∞Â¢û ‚ñº‚ñº‚ñº -->
                <div id="chat-lock-overlay">
                    <div id="chat-lock-content"></div>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

                <!-- Ë°®ÊÉÖÈù¢Êùø (‰øùÊåÅ‰∏çÂèò) -->
                <div id="sticker-panel">
                    <div id="sticker-panel-header">
                        <span class="panel-btn" id="close-sticker-panel-btn">ÂèñÊ∂à</span>
                        <span class="title">ÊàëÁöÑË°®ÊÉÖ</span>
                        <span class="panel-btn" id="edit-sticker-pack-btn">ÁºñËæë</span>
                    </div>
                    <div id="sticker-grid"></div>
                    <div id="sticker-pack-tabs">
                        <div class="sticker-pack-tab add-pack-btn" id="add-pack-btn">
                            <div class="pack-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </div>
                        </div>
                        <div class="sticker-pack-tab active" data-pack="all">
                            <div class="pack-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10" />
                                    <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                                    <line x1="9" y1="9" x2="9.01" y2="9" />
                                    <line x1="15" y1="9" x2="15.01" y2="9" />
                                </svg>
                            </div>
                        </div>
                        <div class="sticker-pack-tab" data-pack="pack1">
                            <div class="pack-icon">
                                <img src="https://files.catbox.moe/r1khrr.gif" alt="Pack 1">
                            </div>
                        </div>
                    </div>
                </div>



                <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
                <input type="file" id="image-upload-input" accept="image/*" style="display: none;">

                <!-- Èü≥‰πêÊí≠ÊîæÂô® (‰øùÊåÅ‰∏çÂèò) -->
                <div id="music-player-overlay">
                    <div class="music-player-window">
                        <span id="music-playlist-btn">‚ò∞</span>
                        <div id="music-time-counter">Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü0.0Â∞èÊó∂</div>
                        <div id="music-player-song-title">ËØ∑Ê∑ªÂä†Ê≠åÊõ≤</div>
                        <div id="music-player-artist">...</div>
                        <div class="music-controls">
                            <button id="music-prev-btn">‚èÆ</button>
                            <button id="music-play-pause-btn" class="play-pause-btn">‚ñ∂</button>
                            <button id="music-next-btn">‚è≠</button>
                            <button id="music-mode-btn">È°∫Â∫è</button>
                        </div>
                        <div class="music-bottom-actions">
                            <button id="music-exit-btn">ÈÄÄÂá∫‰∏ÄËµ∑Âê¨</button>
                            <button id="music-return-btn">ËøîÂõûËÅäÂ§©</button>
                        </div>
                    </div>
                </div>

                <div id="music-playlist-panel">
                    <div class="playlist-header">
                        <span class="panel-btn" id="close-playlist-btn">ËøîÂõû</span>
                        <span>Êí≠ÊîæÂàóË°®</span>
                        <span style="width: 30px;"></span>
                    </div>
                    <div style="display: flex; border-bottom: 1px solid var(--border-color);">
                        <div class="main-playlist-tab active" onclick="switchMainPlaylistTab('songs')"
                            style="flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 2px solid var(--accent-color);">
                            Songs</div>
                        <div class="main-playlist-tab" onclick="switchMainPlaylistTab('playlists')"
                            style="flex: 1; padding: 15px; text-align: center; cursor: pointer; border-bottom: 2px solid transparent;">
                            Playlists</div>
                    </div>
                    <div id="main-songs-tab" class="main-playlist-tab-content">
                        <div
                            style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; gap: 10px;">
                            <span class="panel-btn" id="add-song-local-btn">Êú¨Âú∞</span>
                            <span class="panel-btn" id="add-song-url-btn">URL</span>
                            <span class="panel-btn" id="add-song-spotify-btn">Spotify</span>
                        </div>
                        <div class="playlist-body" id="playlist-body"></div>
                    </div>
                    <div id="main-playlists-tab" class="main-playlist-tab-content" style="display: none;">
                        <div id="main-playlists-list" style="overflow-y: auto; max-height: 400px;"></div>
                        <div id="main-playlist-view" style="display: none;">
                            <div
                                style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center;">
                                <span onclick="showMainSpotifyPlaylists()"
                                    style="cursor: pointer; margin-right: 10px;">‚Äπ</span>
                                <span id="main-current-playlist-name" style="font-weight: 600;"></span>
                            </div>
                            <div id="main-playlist-tracks" style="overflow-y: auto; max-height: 350px;"></div>
                        </div>
                    </div>
                </div>
            </div>
            <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        <div id="appearance-settings-screen" class="screen">
            <div class="header"><span class="back-btn"
                    onclick="showScreen('settings-screen')">‚Äπ</span><span>Â§ñËßÇËÆæÁΩÆ</span><span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <div class="form-group">
                    <div id="wallpaper-preview">ÁÇπÂáª‰∏ãÊñπ‰∏ä‰º†</div><button class="form-button"
                        onclick="document.getElementById('wallpaper-upload-input').click();">‰∏ä‰º†Â£ÅÁ∫∏</button><input
                        type="file" id="wallpaper-upload-input" accept="image/*"><button class="form-button"
                        id="save-wallpaper-btn">‰øùÂ≠òÂπ∂Â∫îÁî®</button>
                </div>
                <hr style="margin:20px 0; opacity:.3">
                <!-- App Icon customization section -->
                <div class="form-group">
                    <label>Â∫îÁî®ÂõæÊ†áËá™ÂÆö‰πâ</label>
                    <div id="app-icon-customization-list">
                        <!-- App icon customization fields will be populated here -->
                    </div>
                </div>
                <hr style="margin:20px 0; opacity:.3">
                <!-- Charm customization section -->
                <div class="form-group">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; width: calc(100% + 40px); margin-bottom: 10px; margin-left: -20px;">
                        <span>
                            Ëá™ÂÆö‰πâÊåÇ‰ª∂Ê†∑Âºè (CSS)
                            <button id="reset-charm-css-btn" type="button"
                                style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">ÈáçÁΩÆ</button>
                        </span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="charm-visibility-toggle" checked>
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <textarea id="custom-charm-css-input" rows="15"
                        style="width: calc(100vw - 40px); margin-left: -20px; margin-right: -20px; padding: 12px; box-sizing: border-box; font-family: monospace; font-size: 12px; resize: vertical;">/* Ëá™ÂÆö‰πâÊåÇ‰ª∂Ê†∑Âºè - ÂÆåÊï¥ÈªòËÆ§ËÆæÁΩÆ */
.floating-phone-charm {
  position: fixed;
  top: 48px;
  right: -112px;
  width: 220px;
  height: 220px;
  background-image: url('https://files.catbox.moe/rhrobi.gif');
  background-size: contain;
  background-repeat: no-repeat;
  z-index: 1000;
  pointer-events: auto;
  cursor: grab;
  transition: transform 0.2s ease;
  user-select: none;
}</textarea>
                </div>
                <hr style="margin:20px 0; opacity:.3">
                <!-- Font settings section -->
                <div class="form-group">
                    <label for="font-url-input">Â≠ó‰ΩìÊñá‰ª∂URL (.ttf, .otf, .woffÁ≠â)</label>
                    <input type="text" id="font-url-input" placeholder="https://..../font.ttf"
                        style="width: calc(100vw - 40px); margin-left: -20px; margin-right: -20px; padding: 12px; box-sizing: border-box;">
                </div>

                <div class="form-group">
                    <label>ÊàñËÄÖ‰∏ä‰º†Â≠ó‰ΩìÊñá‰ª∂</label>
                    <div
                        style="display: flex; align-items: center; gap: 10px; width: calc(100vw - 40px); margin-left: -20px; margin-right: -20px;">
                        <button class="form-button form-button-secondary"
                            onclick="document.getElementById('font-upload-input').click();"
                            style="flex: 1;">ÈÄâÊã©Â≠ó‰ΩìÊñá‰ª∂</button>
                        <span id="font-file-name" style="font-size: 14px; color: var(--text-secondary);">Êú™ÈÄâÊã©Êñá‰ª∂</span>
                    </div>
                    <input type="file" id="font-upload-input" accept="*/*" style="display: none;">
                </div>

                <div class="form-group">
                    <label>ÂÆûÊó∂È¢ÑËßà</label>
                    <div id="font-preview"
                        style="width: calc(100vw - 40px); margin-left: -20px; margin-right: -20px; padding: 20px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #f9f9f9; box-sizing: border-box;">
                        <p style="font-size: 20px; margin: 0 0 10px 0;">‰Ω†Â•Ω‰∏ñÁïå Hello World</p>
                        <p style="margin: 0;">ËøôÊòØÂ≠ó‰ΩìÈ¢ÑËßàÊïàÊûúÔºå12345„ÄÇ</p>
                    </div>
                </div>

                <button class="form-button" id="save-font-btn">‰øùÂ≠òÂπ∂Â∫îÁî®</button>
                <button class="form-button form-button-secondary" id="reset-font-btn">ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì</button>
            </div>
        </div>

        <div id="backup-screen" class="screen">
            <div class="header"><span class="back-btn"
                    onclick="showScreen('settings-screen')">‚Äπ</span><span>Â§á‰ªΩÊñá‰ª∂</span><span style="width: 30px;"></span>
            </div>
            <div class="form-container">
                <button class="form-button" id="export-data-btn">ÂØºÂá∫Êï∞ÊçÆ</button>
                <button class="form-button" id="import-btn">ÂØºÂÖ•Â§á‰ªΩÊñá‰ª∂</button>

                <hr style="margin:20px 0; opacity:.3">

                <button class="form-button" id="cloud-backup-manual-btn">‚òÅÔ∏è ÊâãÂä®Â§á‰ªΩ</button>
                <button class="form-button" id="cloud-restore-select-btn">‚òÅÔ∏è ‰ªé‰∫ëÁ´ØÊÅ¢Â§ç</button>

                <!-- ÁúüÊ≠£ÁöÑÊñá‰ª∂ÈÄâÊã©Âô®Ôºå‰øùÊåÅÈöêËóè -->
                <input id="import-data-input" type="file" accept="application/json" hidden>
            </div>
        </div>

        <div id="general-settings-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('settings-screen')">‚Äπ</span>
                <span>ÈÄöÁî®ËÆæÁΩÆ</span>
                <span style="width: 30px;"></span>
            </div>
            <div id="general-settings-list"></div>
        </div>

        <div id="calendar-screen" class="screen">
            <div class="header">
                <span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span>
                <span>Êó•ÂéÜ</span>
                <span class="action-btn" id="calendar-add-btn">+</span>
            </div>
            <div class="form-container">
                <!-- Calendar month view -->
                <div class="calendar-month-view-no-card">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" id="prev-month-btn">‚Äπ</button>
                        <button class="calendar-nav-btn" id="next-month-btn">‚Ä∫</button>
                        <span class="calendar-month-year" id="calendar-month-year">2025Âπ¥7Êúà</span>
                    </div>

                    <div class="calendar-weekdays">
                        <div class="weekday">Êó•</div>
                        <div class="weekday">‰∏Ä</div>
                        <div class="weekday">‰∫å</div>
                        <div class="weekday">‰∏â</div>
                        <div class="weekday">Âõõ</div>
                        <div class="weekday">‰∫î</div>
                        <div class="weekday">ÂÖ≠</div>
                    </div>

                    <div class="calendar-grid" id="calendar-grid">
                        <!-- Calendar dates will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Events list for selected day -->
                <div class="calendar-events-section">
                    <div class="calendar-events-header">
                        <button class="calendar-nav-btn" id="prev-day-btn">‚Äπ</button>
                        <button class="calendar-nav-btn" id="next-day-btn">‚Ä∫</button>
                        <span id="selected-date-display">‰ªäÂ§©</span>
                    </div>
                    <div class="calendar-events-list" id="calendar-events-list">
                        <div class="no-events-message">Ê≤°Êúâ‰∫ã‰ª∂</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈÄâÊã©ËÅîÁ≥ª‰∫∫‰ª•ÂàõÂª∫Áæ§ËÅäÁöÑÂ±èÂπï ‚ñº‚ñº‚ñº -->
        <div id="contact-picker-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="cancel-contact-picker-btn">ÂèñÊ∂à</span>
                <span>ÈÄâÊã©ËÅîÁ≥ª‰∫∫</span>
                <span class="save-btn" id="confirm-contact-picker-btn">ÂÆåÊàê(0)</span>
            </div>
            <div class="list-container" id="contact-picker-list">
                <!-- ËÅîÁ≥ª‰∫∫ÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁæ§ÊàêÂëòÁÆ°ÁêÜÂ±èÂπï ‚ñº‚ñº‚ñº -->
        <div id="member-management-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="back-from-member-management">‚Äπ</span>
                <span>Áæ§ÊàêÂëòÁÆ°ÁêÜ</span>
                <span style="width: 30px;"></span>
            </div>
            <div class="list-container" id="member-management-list">
                <!-- Áé∞ÊúâÊàêÂëòÂàóË°®‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div id="member-management-actions">
                <button id="add-existing-contact-btn">‰ªéÂ•ΩÂèãÂàóË°®Ê∑ªÂä†</button>
                <button id="create-new-member-btn">ÂàõÂª∫Áæ§ÂÜÖÊñ∞ÊàêÂëò</button>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊù•ÁîµËØ∑Ê±ÇÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
        <div id="incoming-call-modal" class="modal">
            <div class="incoming-call-content">
                <img id="caller-avatar" class="caller-avatar" src="">
                <div id="caller-name" class="caller-name"></div>
                <div class="caller-text">ÈÇÄËØ∑‰Ω†ËßÜÈ¢ëÈÄöËØù</div>
                <div class="incoming-call-actions">
                    <div class="action-button-wrapper">
                        <button id="decline-call-btn" class="call-action-btn decline"></button>
                        <span>ÊãíÁªù</span>
                    </div>
                    <div class="action-button-wrapper">
                        <button id="accept-call-btn" class="call-action-btn accept"></button>
                        <span>Êé•Âê¨</span>
                    </div>
                </div>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        <!-- ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊÆµ„ÄêÂÖ®Êñ∞Áæ§ËÅäÂÖºÂÆπÁªìÊûÑ„ÄëÁöÑ‰ª£Á†ÅÔºåÂÆåÊï¥ÊõøÊç¢‰Ω†ÊóßÁöÑ #video-call-screen ‚ñº‚ñº‚ñº -->
        <div id="video-call-screen" class="screen">
            <!-- 1. È°∂ÈÉ®Ê†è (‰øùÊåÅ‰∏çÂèò) -->
            <div class="video-call-top-bar">
                <span id="call-timer">00:00</span>
            </div>

            <!-- 2. „ÄêÂçáÁ∫ß„ÄëÂèÇ‰∏éËÄÖÂ§¥ÂÉèÁΩëÊ†ºÂå∫Âüü -->
            <div class="video-call-avatar-area">
                <div id="participant-avatars-grid">
                    <!-- JS‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÂ§¥ÂÉè -->
                </div>
            </div>

            <!-- 3. ÂØπËØùÊ°ÜÂå∫Âüü (‰øùÊåÅ‰∏çÂèò) -->
            <div id="video-call-main" class="video-call-main">
                <!-- ÂØπËØùÂÜÖÂÆπ‰ºöÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>

            <!-- 4. „ÄêÂçáÁ∫ß„ÄëÂ∫ïÈÉ®ÊéßÂà∂Ê†èÔºåÁé∞Âú®ÂåÖÂê´‰∏Ä‰∏™‚ÄúÂä†ÂÖ•‚ÄùÊåâÈíÆ -->
            <div class="video-call-controls">
                <button id="user-speak-btn" class="control-btn speak-btn"></button>
                <button id="hang-up-btn" class="control-btn hangup-btn"></button>
                <!-- Ëøô‰∏™ÊåâÈíÆÈªòËÆ§ÈöêËóèÔºåÂè™Âú®Áî®Êà∑‚ÄúÊóÅËßÇ‚ÄùÊó∂ÊòæÁ§∫ -->
                <button id="join-call-btn" class="control-btn join-btn" style="display: none;"></button>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞Ê∑ªÂä†„ÄëÊ≠£Âú®ÂëºÂè´ÁïåÈù¢ ‚ñº‚ñº‚ñº -->
        <div id="outgoing-call-screen" class="screen">
            <div class="outgoing-call-content">
                <img id="outgoing-call-avatar" class="caller-avatar" src="">
                <div id="outgoing-call-name" class="caller-name"></div>
                <div class="caller-text">Ê≠£Âú®ÂëºÂè´...</div>
                <div class="outgoing-call-actions">
                    <button id="cancel-call-btn" class="call-action-btn decline"></button>
                    <span>ÂèñÊ∂à</span>
                </div>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

        <!-- ‚ñº‚ñº‚ñº Browser Screen for Share Links ‚ñº‚ñº‚ñº -->
        <div id="browser-screen" class="screen">
            <div class="header">
                <span class="back-btn" id="browser-back-btn">‚Äπ</span>
                <span id="browser-title"></span>
                <span style="width: 30px;"></span>
            </div>
            <div id="browser-content" class="list-container">
                <!-- ÊñáÁ´†ÂÜÖÂÆπÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Browser Screen End ‚ñ≤‚ñ≤‚ñ≤ -->

        <!-- ‚ñº‚ñº‚ñº Meetup Screen ‚ñº‚ñº‚ñº -->
        <div id="meetup-screen" class="screen">
            <div class="header">
                <!-- Default controls -->
                <div class="default-controls">
                    <span class="back-btn" id="meetup-back-btn">‚Äπ</span>
                    <span id="meetup-title">ËßÅÈù¢Ê®°Âºè</span>
                    <span class="action-btn" id="meetup-edit-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="#007AFF"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="m18.5 2.5 3 3L12 15l-4 1 1-4 9.5-9.5z" fill="#007AFF" stroke="#007AFF"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </span>
                </div>

                <!-- Selection mode controls -->
                <div class="selection-controls">
                    <span id="meetup-selection-cancel-btn">ÂèñÊ∂à</span>
                    <span id="meetup-selection-count"></span>
                    <div class="header-actions">
                        <span id="meetup-selection-delete-btn" class="action-btn" style="color: #ff3b30;">Âà†Èô§</span>
                    </div>
                </div>
            </div>

            <!-- Meetup context bar showing event details -->
            <div id="meetup-context-bar">
                <div class="context-info">
                    <div class="event-location" id="meetup-location">üìç ‰ΩçÁΩÆ‰ø°ÊÅØ</div>
                    <div class="event-time" id="meetup-time">üïê Êó∂Èó¥‰ø°ÊÅØ</div>
                    <div class="event-phase" id="meetup-phase">üíï ËßÅÈù¢ËøõË°å‰∏≠</div>
                </div>
                <button id="end-date-btn" class="end-date-button">ÁªìÊùüËßÅÈù¢</button>
            </div>

            <!-- Meetup message display area -->
            <div id="meetup-messages" class="meetup-messages-container">
                <!-- Messages will be dynamically generated here -->
            </div>

            <!-- Meetup input area -->
            <div id="meetup-input-area" class="meetup-input-container">
                <div id="meetup-input-main-row">
                    <textarea id="meetup-input" rows="1" placeholder="Âú®Ëøô‰∏™ÁâπÊÆäÁöÑÊó∂ÂàªÔºå‰Ω†ÊÉ≥ËØ¥‰ªÄ‰πà..."></textarea>
                    <div class="meetup-actions-wrapper">
                        <button id="meetup-wait-reply-btn" title="Á≠âÂæÖÂõûÂ§ç"><img
                                src="https://i.postimg.cc/2SwjsfZQ/IMG-6913.gif" alt="Á≠âÂæÖÂõûÂ§ç"></button>
                        <button id="meetup-send-btn" class="send-btn">ÂèëÈÄÅ</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- ‚ñ≤‚ñ≤‚ñ≤ Meetup Screen End ‚ñ≤‚ñ≤‚ñ≤ -->

    </div>
    </div>

    <div id="chat-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>ËÅäÂ§©ËÆæÁΩÆ</span></div>
            <div class="modal-body">
                <div class="form-group" id="chat-name-group"><label for="chat-name-input">Â§áÊ≥®Âêç / Áæ§Âêç</label><input
                        type="text" id="chat-name-input"></div>

                <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞‰ª£Á†ÅÁ≤òË¥¥Âà∞‚ÄúÂ§áÊ≥®Âêç‚ÄùËæìÂÖ•Ê°ÜÁöÑ form-group ‰πãÂêé ‚ñº‚ñº‚ñº -->
                <div class="form-group" id="assign-group-section" style="display: none;"> <!-- ÈªòËÆ§ÈöêËóèÔºåÂè™ÂØπÂçïËÅäÊòæÁ§∫ -->
                    <label for="assign-group-select">Â•ΩÂèãÂàÜÁªÑ</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <select id="assign-group-select" style="flex-grow: 1;">
                            <!-- ÂàÜÁªÑÈÄâÈ°πÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                        </select>
                        <button id="manage-groups-btn" class="form-button-secondary"
                            style="margin-top: 0; padding: 12px;">ÁÆ°ÁêÜÂàÜÁªÑ</button>
                    </div>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

                <div class="form-group" id="my-group-nickname-group"><label
                        for="my-group-nickname-input">ÊàëÁöÑÁæ§ÊòµÁß∞</label><input type="text" id="my-group-nickname-input">
                </div>
                <div class="form-group" id="group-avatar-group"><label>Áæ§Â§¥ÂÉè</label>
                    <div class="avatar-upload"><img id="group-avatar-preview"><button
                            onclick="document.getElementById('group-avatar-input').click()">‰∏ä‰º†Áæ§Â§¥ÂÉè</button><input
                            type="file" id="group-avatar-input" accept="image/*"></div>
                </div>
                <div class="form-group" id="world-book-link-group">
                    <label>ÂÖ≥ËÅî‰∏ñÁïå‰π¶ (ÂèØÂ§öÈÄâ)</label>
                    <div class="custom-multiselect">
                        <div class="select-box">
                            <span class="selected-options-text">-- ÁÇπÂáªÈÄâÊã© --</span>
                            <span class="arrow-down">‚ñº</span>
                        </div>
                        <div id="world-book-checkboxes-container" class="checkboxes-container">
                        </div>
                    </div>
                </div>
                <div class="form-group" id="ai-persona-group"><label for="ai-persona">ÂØπÊñπ‰∫∫ËÆæ (AI Persona)</label><textarea
                        id="ai-persona" rows="3"></textarea></div>
                <div class="form-group" id="ai-avatar-group"><label>ÂØπÊñπÂ§¥ÂÉè</label>
                    <div class="avatar-upload"><img id="ai-avatar-preview"><button
                            onclick="document.getElementById('ai-avatar-input').click()">‰∏ä‰º†ÂØπÊñπÂ§¥ÂÉè</button><input
                            type="file" id="ai-avatar-input" accept="image/*"></div>
                </div>
                <div class="form-group" id="my-persona-group"><label for="my-persona">ÊàëÁöÑ‰∫∫ËÆæ (My Persona)</label><textarea
                        id="my-persona" rows="3"></textarea></div>
                <div class="form-group" id="my-avatar-group"><label>ÊàëÁöÑÂ§¥ÂÉè</label>
                    <div class="avatar-upload"><img id="my-avatar-preview"><button
                            onclick="document.getElementById('my-avatar-input').click()">‰∏ä‰º†ÊàëÁöÑÂ§¥ÂÉè</button><button
                            id="open-persona-library-btn">È¢ÑËÆæ</button><input type="file" id="my-avatar-input"
                            accept="image/*"></div>
                </div>
                <div class="form-group" id="group-members-group"><label>Áæ§ÊàêÂëò‰∫∫ËÆæ</label>
                    <div id="group-members-settings"></div>

                    <!-- „ÄêÊñ∞Â¢û„ÄëÁÆ°ÁêÜÊàêÂëòÊåâÈíÆ -->
                    <button id="manage-members-btn" class="form-button form-button-secondary"
                        style="margin-top: 15px;">ÁÆ°ÁêÜÁæ§ÊàêÂëò</button>
                </div>
                <div class="form-group"><label for="max-memory">‰∏ä‰∏ãÊñáËÆ∞ÂøÜÊù°Êï∞</label><input type="number" id="max-memory"
                        value="10"></div>
                
                <!-- ‚ñº‚ñº‚ñº ÈïøÊúüËÆ∞ÂøÜÁîüÊàê ‚ñº‚ñº‚ñº -->
                <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
                <div class="form-group" id="chat-summary-section">
                    <label id="summary-section-title">ÈïøÊúüËÆ∞ÂøÜÁîüÊàê (0 Êù°)</label>
                    <div style="margin-bottom: 12px;">
                        <label for="summary-message-count" style="font-size: 13px; color: #666; display: block; margin-bottom: 6px;">Ë¶ÅÊï¥ÁêÜÊúÄËøëÂ§öÂ∞ëÊù°Ê∂àÊÅØÔºü</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="summary-message-count" min="100" step="100" value="1000" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                            <span style="color: #666; font-size: 14px;">Êù°</span>
                        </div>
                    </div>
                    <button type="button" id="update-summary-btn" class="form-button" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                        üß† ÁîüÊàêÈïøÊúüËÆ∞ÂøÜ
                    </button>
                    <p style="font-size: 11px; color: #999; margin-top: 8px; line-height: 1.4;">
                        ËÆ∞ÂøÜ‰ºöËá™Âä®‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ÔºåÂ∏ÆÂä©AIËÆ∞‰ΩèÈáçË¶ÅÁöÑÂØπËØùÂÜÖÂÆπÂíåÊÉÖÊÑü
                    </p>
                </div>
                <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
                <!-- ‚ñ≤‚ñ≤‚ñ≤ ÈïøÊúüËÆ∞ÂøÜÁîüÊàêÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                
                <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂêéÂè∞Ê¥ªÂä®ÂºÄÂÖ≥ - ËØ∑Á≤òË¥¥Âà∞ËøôÈáå ‚ñº‚ñº‚ñº -->
                <div class="form-group">
                    <label>ÂêéÂè∞ÂõûÂ§ç‰∏é‰∏ªÂä®Ë°å‰∏∫</label>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <p
                            style="font-size: 11px; font-weight: normal; color: #666; margin: 0; padding-right: 15px; line-height: 1.4;">
                            ÂÖ≥Èó≠ÂêéÔºåËØ•ËßíËâ≤Â∞Ü‰∏ç‰ºöÂú®ÂêéÂè∞Áã¨Á´ãË°åÂä®Êàñ‰∏ªÂä®ÂèëËµ∑ÂØπËØùÔºåÂè™‰ºöÂú®‰Ω†‰∏éTaËÅäÂ§©Êó∂ËøõË°åÂõûÂ§ç„ÄÇ
                        </p>
                        <label class="toggle-switch">
                            <input type="checkbox" id="background-activity-switch-chat">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

                <div class="form-group"><label>ËÅäÂ§©Ê∞îÊ≥°‰∏ªÈ¢ò <button id="reset-theme-btn" type="button">ÈáçÁΩÆ</button></label>
                    <div class="theme-selector"><label><input type="radio" name="theme-select" value="default"
                                id="theme-default"> ÈªòËÆ§</label><label><input type="radio" name="theme-select"
                                value="pink_blue"> Á≤âËìù</label><label><input type="radio" name="theme-select"
                                value="blue_white"> ËìùÁôΩ</label><label><input type="radio" name="theme-select"
                                value="purple_yellow"> Á¥´ÈªÑ</label><label><input type="radio" name="theme-select"
                                value="black_white"> ÈªëÁôΩ</label><label><input type="radio" name="theme-select"
                                value="yellow_white"> ÈªÑÁôΩ</label><label><input type="radio" name="theme-select"
                                value="red_black"> Á∫¢Èªë</label><label><input type="radio" name="theme-select"
                                value="blue_yellow"> ËìùÈªÑ</label><label><input type="radio" name="theme-select"
                                value="pink_yellow"> Á≤âÈªÑ</label><label><input type="radio" name="theme-select"
                                value="pink_purple"> Á≤âÁ¥´</label><label><input type="radio" name="theme-select"
                                value="gray_white"> ÁÅ∞ÁôΩ</label><label><input type="radio" name="theme-select"
                                value="blue_green"> ËìùÁªø</label><label><input type="radio" name="theme-select"
                                value="pink_white"> Á≤âÁôΩ</label><label><input type="radio" name="theme-select"
                                value="pink_black"> Á≤âÈªë</label><label><input type="radio" name="theme-select"
                                value="pink_green"> Á≤âÁªø</label><label><input type="radio" name="theme-select"
                                value="green_black"> ÁªøÈªë</label></div>
                </div>


                <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞‰ª£Á†ÅÁ≤òË¥¥Âà∞‚ÄúËÅäÂ§©Ê∞îÊ≥°‰∏ªÈ¢ò‚ÄùÁöÑ form-group ‰πãÂêé ‚ñº‚ñº‚ñº -->
                <div class="form-group">
                    <label for="font-size-slider">ËÅäÂ§©Â≠ó‰ΩìÂ§ßÂ∞è <span id="font-size-value">13px</span></label>
                    <input type="range" id="font-size-slider" min="12" max="20" step="1" value="13"
                        style="width: 100%; margin-top: 8px;">
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

                <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞‰ª£Á†ÅÁ≤òË¥¥Âà∞‚ÄúËÅäÂ§©Â≠ó‰ΩìÂ§ßÂ∞è‚ÄùÁöÑ form-group ‰πãÂêé ‚ñº‚ñº‚ñº -->
                <div class="form-group">
                    <label for="custom-css-input">
                        Ëá™ÂÆö‰πâÊ∞îÊ≥°Ê†∑Âºè (CSS)
                        <button id="reset-custom-css-btn" type="button"
                            style="background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px;">ÈáçÁΩÆ</button>
                    </label>
                    <textarea id="custom-css-input" rows="5"
                        style="width: 100%; margin-top: 8px; font-family: monospace; font-size: 12px; resize: vertical;"
                        placeholder="/* Á§∫‰æãÔºö‰∏∫‚ÄúÊàë‚ÄùÁöÑÊ∞îÊ≥°Ê∑ªÂä†Ê∏êÂèòËÉåÊôØÂíåÈò¥ÂΩ± */
.message-bubble.user .content {
  background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  border-radius: 15px 4px 15px 15px;
}"></textarea>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

                <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞‰ª£Á†ÅÁ≤òË¥¥Âà∞Ëá™ÂÆö‰πâCSSËæìÂÖ•Ê°ÜÁöÑ form-group ‰πãÂêé ‚ñº‚ñº‚ñº -->
                <div class="form-group">
                    <label>ÂÆûÊó∂È¢ÑËßà</label>
                    <div id="settings-preview-area">
                        <!-- JS‰ºöÂú®ËøôÈáåÁîüÊàêÈ¢ÑËßàÂÜÖÂÆπ -->
                    </div>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

                <div class="form-group">
                    <label>ËÅäÂ§©ËÉåÊôØ</label>
                    <div class="bg-upload-container">
                        <button type="button" class="form-button-secondary"
                            style="width: auto; padding: 8px 12px; margin-top: 0;"
                            onclick="document.getElementById('bg-input').click()">‰∏ä‰º†ËÉåÊôØÂõæ</button>
                        <button type="button" id="remove-bg-btn">ÁßªÈô§ËÉåÊôØ</button>
                    </div>
                    <img id="bg-preview" class="bg-preview-img">
                    <input type="file" id="bg-input" accept="image/*" style="display: none;">
                </div>
                
                <!-- ‚ñº‚ñº‚ñº ÈïøÊúüËÆ∞ÂøÜÁîüÊàê ‚ñº‚ñº‚ñº -->
                <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
                <div class="form-group" id="chat-summary-section">
                    <label id="summary-section-title">ÈïøÊúüËÆ∞ÂøÜÁîüÊàê (0 Êù°)</label>
                    <div style="margin-bottom: 12px;">
                        <label for="summary-message-count" style="font-size: 13px; color: #666; display: block; margin-bottom: 6px;">Ë¶ÅÊï¥ÁêÜÊúÄËøëÂ§öÂ∞ëÊù°Ê∂àÊÅØÔºü</label>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <input type="number" id="summary-message-count" min="100" step="100" value="1000" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px;">
                            <span style="color: #666; font-size: 14px;">Êù°</span>
                        </div>
                    </div>
                    <button type="button" id="update-summary-btn" class="form-button" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                        üß† ÁîüÊàêÈïøÊúüËÆ∞ÂøÜ
                    </button>
                    <p style="font-size: 11px; color: #999; margin-top: 8px; line-height: 1.4;">
                        ËÆ∞ÂøÜ‰ºöËá™Âä®‰øùÂ≠òÂà∞‰∏ñÁïå‰π¶ÔºåÂ∏ÆÂä©AIËÆ∞‰ΩèÈáçË¶ÅÁöÑÂØπËØùÂÜÖÂÆπÂíåÊÉÖÊÑü
                    </p>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ ÈïøÊúüËÆ∞ÂøÜÁîüÊàêÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
                
                <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;">
                <button class="form-button form-button-secondary" id="block-chat-btn"
                    style="background-color: #ff3b30; color: white; border-color: #ff3b30;">ÊãâÈªëÂØπÊñπ</button>
                <button class="form-button form-button-secondary" id="clear-chat-btn">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</button>
            </div>
            <div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">ÂèñÊ∂à</button><button
                    class="save" id="save-chat-settings-btn">‰øùÂ≠ò</button></div>
        </div>
    </div>

    <div id="persona-library-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>ÊàëÁöÑ‰∫∫ËÆæÂ∫ì</span><button id="add-persona-preset-btn"
                    class="action-button">Ê∑ªÂä†</button></div>
            <div class="modal-body">
                <div id="persona-library-grid"></div>
            </div>
            <div class="modal-footer"><button class="cancel" id="close-persona-library-btn">ÂÖ≥Èó≠</button></div>
        </div>
    </div>

    <div id="persona-editor-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span id="persona-editor-title">Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ</span></div>
            <div class="modal-body">
                <div class="form-group"><label>È¢ÑËÆæÂ§¥ÂÉè</label>
                    <div class="avatar-upload"><img id="preset-avatar-preview"><button
                            onclick="document.getElementById('preset-avatar-input').click()">‰∏ä‰º†Â§¥ÂÉè</button><input
                            type="file" id="preset-avatar-input" accept="image/*"></div>
                </div>
                <div class="form-group"><label for="preset-persona-input">È¢ÑËÆæ‰∫∫ËÆæ</label><textarea
                        id="preset-persona-input" rows="4" placeholder="Âú®Ê≠§ËæìÂÖ•Ëøô‰∏™‰∫∫ËÆæÁöÑËØ¶ÁªÜËÆæÂÆö..."></textarea></div>
            </div>
            <div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">ÂèñÊ∂à</button><button
                    class="save" id="save-persona-preset-btn">‰øùÂ≠ò</button></div>
        </div>
    </div>

    <div id="member-settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>ÁºñËæëÁæ§ÊàêÂëò</span></div>
            <div class="modal-body">
                <div class="form-group"><label for="member-name-input">ÂêçÂ≠ó</label><input type="text"
                        id="member-name-input"></div>
                <div class="form-group"><label for="member-persona-input">‰∫∫ËÆæ</label><textarea id="member-persona-input"
                        rows="4"></textarea></div>
                <div class="form-group"><label>Â§¥ÂÉè</label>
                    <div class="avatar-upload"><img id="member-avatar-preview"><button
                            onclick="document.getElementById('member-avatar-input').click()">‰∏ä‰º†Â§¥ÂÉè</button><button
                            class="change-frame-btn" data-type="member">Êõ¥Êç¢Â§¥ÂÉèÊ°Ü</button><input type="file"
                            id="member-avatar-input" accept="image/*"></div>
                </div>
            </div>
            <div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">ÂèñÊ∂à</button><button
                    class="save" id="save-member-settings-btn">‰øùÂ≠ò</button></div>
        </div>
    </div>

    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">ÂèñÊ∂à</button>
                <button id="custom-modal-confirm" class="confirm-btn">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>

    <!-- Export Progress Modal -->
    <div id="export-progress-modal-overlay" style="display: none;">
        <div id="export-progress-modal"
            style="background-color: #fff; width: 300px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div class="custom-modal-header" style="text-align: center; font-weight: 600; padding: 16px;">
                ÂØºÂá∫Êï∞ÊçÆ
            </div>
            <div class="custom-modal-body" style="padding: 20px;">
                <div id="export-status-text" style="text-align: center; margin-bottom: 16px; color: #666;">
                    Ê≠£Âú®ÂáÜÂ§áÂØºÂá∫...
                </div>
                <div id="export-progress-container"
                    style="width: 100%; height: 8px; background-color: #f0f0f0; border-radius: 4px; overflow: hidden; margin-bottom: 12px;">
                    <div id="export-progress-bar"
                        style="height: 100%; background-color: #007AFF; width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <div id="export-progress-text" style="text-align: center; font-size: 14px; color: #999;">
                    0%
                </div>
            </div>
        </div>
    </div>

    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ÁºñËæëÈ¢ÑËÆæ</button>
                <button id="preset-action-delete" class="btn-danger">Âà†Èô§È¢ÑËÆæ</button>
                <button id="preset-action-cancel"
                    style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">ÁªôTa‰∏Ä‰∏™ÊÉäÂñúÔºÅ</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">ËΩ¨Ë¥¶ÈáëÈ¢ù</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="99999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">Â§áÊ≥® (ÂèØÈÄâ)</label>
                <input type="text" id="transfer-note" placeholder="Áïô‰∏ã‰Ω†ÁöÑÂ∞èÂøÉÊÄù~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">ÂèñÊ∂à</button>
                <button id="transfer-confirm-btn">Á°ÆËÆ§ËΩ¨Ë¥¶</button>
            </div>
        </div>
    </div>

    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ≤æËá¥ÁâàËΩ¨Ë¥¶Êìç‰ΩúÂºπÁ™ó ‚ñº‚ñº‚ñº -->
    <div id="transfer-actions-modal" class="modal">
        <div class="transfer-actions-content">
            <div class="transfer-actions-header">ËØ∑ÈÄâÊã©Êìç‰Ωú</div>
            <div class="transfer-actions-body">
                <p>‰Ω†Êî∂Âà∞‰∫ÜÊù•Ëá™ <strong id="transfer-sender-name"></strong> ÁöÑ‰∏ÄÁ¨îËΩ¨Ë¥¶„ÄÇ</p>
            </div>
            <div class="transfer-actions-footer">
                <button id="transfer-action-decline" class="action-btn decline">ÊÆãÂøçÊãíÁªù</button>
                <button id="transfer-action-accept" class="action-btn accept">ÂºÄÂøÉÊî∂‰∏ã</button>
            </div>
            <button id="transfer-action-cancel" class="cancel-btn">√ó</button>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <div id="battery-alert-modal">
        <div class="battery-alert-content">
            <img id="battery-alert-image" src="">
            <p id="battery-alert-text"></p>
        </div>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

    <!-- ‚ñº‚ñº‚ñº Áî®‰∏ãÈù¢ËøôÊÆµ„ÄêÂÆåÊï¥„ÄëÁöÑÊ®°ÊÄÅÊ°Ü‰ª£Á†ÅÔºåÊõøÊç¢Êéâ‰Ω†Áé∞ÊúâÁöÑ id="create-post-modal" ÁöÑÊï¥‰∏™ div ‚ñº‚ñº‚ñº -->
    <div id="create-post-modal" class="modal">
        <div class="modal-content" style="height: auto; max-height: 90%;">
            <div class="modal-header">
                <span>ÂèëÂ∏ÉÂä®ÊÄÅ</span>
            </div>
            <div class="modal-body">
                <!-- ÂÖ¨ÂºÄÊñáÂ≠óËæìÂÖ•Âå∫ -->
                <div class="form-group">
                    <textarea id="post-public-text" rows="3" placeholder="ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...ÔºàÈùûÂøÖÂ°´ÁöÑÂÖ¨ÂºÄÊñáÂ≠óÔºâ"></textarea>
                </div>

                <!-- === Ê®°ÂºèÂàáÊç¢ÂºÄÂÖ≥ (Êñ∞Â¢û) === -->
                <div class="post-mode-switcher">
                    <button id="switch-to-image-mode" class="mode-btn active">‰∏ä‰º†ÂõæÁâá</button>
                    <button id="switch-to-text-image-mode" class="mode-btn">‰ΩøÁî®ÊñáÂ≠óÂõæ</button>
                </div>

                <!-- ‚ñº‚ñº‚ñº „Äê‰øÆÊ≠£Âêé„ÄëÁöÑÂèØËßÅËåÉÂõ¥ËÆæÁΩÆ ‚ñº‚ñº‚ñº -->
                <div class="form-group">
                    <label>ÂèØËßÅËåÉÂõ¥</label>
                    <div id="post-visibility-options" style="display: flex; gap: 15px; margin-bottom: 10px;">
                        <label><input type="radio" name="visibility" value="public" checked> ÂÖ¨ÂºÄ</label>

                        <label><input type="radio" name="visibility" value="include"> ÊåáÂÆöÂàÜÁªÑÂèØËßÅ</label>
                    </div>
                    <div id="post-visibility-groups"
                        style="display: none; max-height: 120px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;">
                        <!-- ÂàÜÁªÑÂ§öÈÄâÊ°ÜÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                <!-- ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

                <!-- === ÂõæÁâáÊ®°ÂºèÂå∫Âüü === -->
                <div id="image-mode-content" class="post-mode-content active">
                    <div class="form-group">
                        <div id="post-image-preview-container" class="post-image-preview-container">
                            <img id="post-image-preview" src="" alt="ÂõæÁâáÈ¢ÑËßà">
                            <button id="post-remove-image-btn">√ó</button>
                        </div>
                        <div class="post-image-upload-options">
                            <button id="post-upload-local-btn" class="form-button-secondary">Êú¨Âú∞‰∏ä‰º†</button>
                            <button id="post-use-url-btn" class="form-button-secondary">ÁΩëÁªúURL</button>
                            <input type="file" id="post-local-image-input" accept="image/*" hidden>
                        </div>
                    </div>
                    <div id="post-image-desc-group" class="form-group" style="display: none;">
                        <label>ÂõæÁâáÊèèËø∞ (ÂøÖÂ°´ÔºåÁªôAIÁúã)</label>
                        <input type="text" id="post-image-description" placeholder="ÁÆÄÂçïÊèèËø∞ÂõæÁâáÂÜÖÂÆπÔºåÂ∏ÆÂä©AIÁêÜËß£">
                    </div>
                </div>

                <!-- === ÊñáÂ≠óÂõæÊ®°ÂºèÂå∫Âüü (Êñ∞Â¢û) === -->
                <div id="text-image-mode-content" class="post-mode-content">
                    <div class="form-group">
                        <label>Ë£ÖÈ•∞ÂõæÁâá (Á∫ØË£ÖÈ•∞Áî®Ôºå‰∏ç‰ºöÂèëÈÄÅÁªôAI)</label>
                        <input type="url" id="text-image-decorative-url" placeholder="ËæìÂÖ•ÂõæÁâáÈìæÊé• (ÂèØÈÄâ)">
                    </div>
                    <div class="form-group">
                        <label>ÊñáÂ≠óÂõæ (ÁªôAIÁêÜËß£Áî®ÁöÑÊèèËø∞ÔºåÁÇπÂáªÂõæÁâáÂêéÂèØËßÅ)</label>
                        <textarea id="post-hidden-text" rows="4" placeholder="Âú®ËøôÈáåÂÜô‰∏ãÂõæÁâáÊèèËø∞..."></textarea>
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-post-btn">ÂèñÊ∂à</button>
                <button class="save" id="confirm-create-post-btn">ÂèëÂ∏É</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∏™Êñ∞ÁöÑÊ®°ÊÄÅÊ°ÜHTMLÁ≤òË¥¥Âà∞ÊâÄÊúâÂÖ∂‰ªñÊ®°ÊÄÅÊ°Ü‰πãÂêé ‚ñº‚ñº‚ñº -->
    <div id="group-management-modal" class="modal">
        <div class="modal-content" style="height: 60%;">
            <div class="modal-header">
                <span>ÁÆ°ÁêÜÂ•ΩÂèãÂàÜÁªÑ</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Êñ∞Âª∫ÂàÜÁªÑ</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-group-name-input" placeholder="ËæìÂÖ•ÂàÜÁªÑÂêç..." style="flex-grow: 1;">
                        <button id="add-new-group-btn" class="form-button"
                            style="width: auto; margin-top: 0; padding: 0 15px;">Ê∑ªÂä†</button>
                    </div>
                </div>
                <hr style="opacity: 0.2;">
                <div id="existing-groups-list" style="display: flex; flex-direction: column; gap: 10px;">
                    <!-- ÂàÜÁªÑÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-group-manager-btn" style="width: 100%;">ÂÆåÊàê</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞ÁöÑHTMLÁ≤òË¥¥Âà∞ÂàöÂàöÂà†Èô§ÁöÑ‰ΩçÁΩÆ ‚ñº‚ñº‚ñº -->
    <div id="message-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <!-- Êìç‰ΩúÊåâÈíÆ -->
                <button id="quote-message-btn">ÂºïÁî®</button>
                <button id="recall-message-btn">Êí§Âõû</button>
                <button id="edit-message-btn">ÁºñËæë</button>
                <button id="select-message-btn">Â§öÈÄâ</button>
                <button id="post-bulletin-btn">ÂèëÂ∏ÉÂà∞ÂÖ¨ÂëäÊùø</button>
                <!-- ÂèñÊ∂àÊåâÈíÆ -->
                <button id="cancel-message-action-btn"
                    style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµÊñ∞HTMLÁ≤òË¥¥Âà∞ÊâÄÊúâÊ®°ÊÄÅÊ°ÜÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº -->
    <div id="post-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="pin-post-btn">ÁΩÆÈ°∂</button>
                <button id="unpin-post-btn" style="display: none;">ÂèñÊ∂àÁΩÆÈ°∂</button>
                <button id="edit-post-btn">ÁºñËæëÂä®ÊÄÅ</button>
                <button id="copy-post-btn">Â§çÂà∂ÂÜÖÂÆπ</button>
                <button id="delete-post-btn" style="color: #ff3b30;">Âà†Èô§Âä®ÊÄÅ</button>
                <button id="cancel-post-action-btn">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- ‚ñº‚ñº‚ñº ËØÑËÆ∫Êìç‰ΩúÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="comment-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="edit-comment-btn">ÁºñËæëËØÑËÆ∫</button>
                <button id="delete-comment-btn" style="color: #ff3b30;">Âà†Èô§ËØÑËÆ∫</button>
                <button id="cancel-comment-action-btn">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- ‚ñº‚ñº‚ñº ËÅäÂ§©Êìç‰ΩúÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="chat-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="pin-chat-btn">ÁΩÆÈ°∂ÂØπËØù</button>
                <button id="unpin-chat-btn" style="display: none;">ÂèñÊ∂àÁΩÆÈ°∂</button>
                <button id="delete-chat-btn" style="color: #ff3b30;">Âà†Èô§ÂØπËØù</button>
                <button id="cancel-chat-action-btn"
                    style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- ‚ñº‚ñº‚ñº AIÂõûÂ§çÈÄâÊã©Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="ai-reply-modal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 400px;">
            <div class="modal-header">
                <span>ÈÄâÊã©AIÂõûÂ§ç</span>
                <span id="close-ai-reply-modal" style="cursor: pointer; font-size: 20px;">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <button id="select-all-ais"
                        style="padding: 5px 10px; margin-right: 10px; border: 1px solid #ddd; background: #f5f5f5; border-radius: 5px; cursor: pointer;">ÂÖ®ÈÄâ</button>
                    <button id="deselect-all-ais"
                        style="padding: 5px 10px; border: 1px solid #ddd; background: #f5f5f5; border-radius: 5px; cursor: pointer;">ÂèñÊ∂àÂÖ®ÈÄâ</button>
                </div>
                <div id="ai-selection-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- AIÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-ai-reply" class="save">Á°ÆËÆ§ÂõûÂ§ç</button>
                <button id="cancel-ai-reply" class="cancel">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- ‚ñº‚ñº‚ñº AIÂèëÂä®ÊÄÅÈÄâÊã©Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="ai-post-modal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 400px;">
            <div class="modal-header">
                <span>ÈÄâÊã©AIÂèëÂä®ÊÄÅ</span>
                <span id="close-ai-post-modal" style="cursor: pointer; font-size: 20px;">&times;</span>
            </div>
            <div class="modal-body">
                <div id="ai-post-selection-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- AIÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-ai-post" class="save">Á°ÆËÆ§ÂèëÂä®ÊÄÅ</button>
                <button id="cancel-ai-post" class="cancel">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº ÁßªÂä®Ë°®ÊÉÖÂà∞Ë°®ÊÉÖÂåÖÈÄâÊã©Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="move-sticker-modal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 400px;">
            <div class="modal-header">
                <span>ÈÄâÊã©Ë°®ÊÉÖÂåÖ</span>
                <span id="close-move-sticker-modal" style="cursor: pointer; font-size: 20px;">&times;</span>
            </div>
            <div class="modal-body">
                <div id="sticker-pack-selection-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- Ë°®ÊÉÖÂåÖÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-move-sticker" class="save">Á°ÆËÆ§ÁßªÂä®</button>
                <button id="cancel-move-sticker" class="cancel">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ ÁßªÂä®Ë°®ÊÉÖÂåÖÊ®°ÊÄÅÊ°ÜÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂèØËßÜÂåñÊ∂àÊÅØÁºñËæëÂô®Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="message-editor-modal" class="modal">
        <div class="modal-content" style="height: 75%;">
            <div class="modal-header">
                <span>ÁºñËæë‰∏éÊãÜÂàÜÊ∂àÊÅØ</span>
            </div>
            <div class="modal-body" id="message-editor-body">
                <!-- ÁºñËæëÂô®ÂÆπÂô®ÔºåJS‰ºöÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàêÊñáÊú¨Ê°Ü -->
                <div id="message-editor-container"></div>
                <!-- Ê∑ªÂä†Êñ∞Ê∂àÊÅØÁöÑÊåâÈíÆ -->
                <button id="add-message-editor-block-btn" class="form-button form-button-secondary"
                    style="margin-top: 15px;">
                    [+] Ê∑ªÂä†‰∏ã‰∏ÄÊù°Ê∂àÊÅØ
                </button>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-advanced-editor-btn">ÂèñÊ∂à</button>
                <button class="save" id="save-advanced-editor-btn">‰øùÂ≠òÊõ¥Êîπ</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñÂçñËØ∑Ê±ÇÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="waimai-request-modal" class="modal">
        <div class="modal-content" style="width: 290px;">
            <div class="modal-header">
                <span>ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="waimai-product-info">ÂïÜÂìÅ‰ø°ÊÅØ</label>
                    <input type="text" id="waimai-product-info" placeholder="‰æãÂ¶ÇÔºö‰∏ÄÊùØÊù®ÊûùÁîòÈú≤">
                </div>
                <div class="form-group">
                    <label for="waimai-amount">‰ª£‰ªòÈáëÈ¢ù (ÂÖÉ)</label>
                    <input type="number" id="waimai-amount" placeholder="‰æãÂ¶ÇÔºö21" min="0" step="0.01">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="waimai-cancel-btn">ÂèñÊ∂à</button>
                <button class="save" id="waimai-confirm-btn">ÂèëËµ∑ËØ∑Ê±Ç</button>
            </div>
        </div>
    </div>

    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊñ∞Âª∫Á∫¶ÂÆö/ÂÄíËÆ°Êó∂Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="create-countdown-modal" class="modal">
        <div class="modal-content" style="height: auto;">
            <div class="modal-header">
                <span>Êñ∞Âª∫Á∫¶ÂÆö</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="countdown-title-input">Á∫¶ÂÆöÊ†áÈ¢ò</label>
                    <input type="text" id="countdown-title-input" placeholder="‰æãÂ¶ÇÔºöÊàëÁöÑÁîüÊó•">
                </div>
                <div class="form-group">
                    <label for="countdown-date-input">Á∫¶ÂÆöÊó•Êúü‰∏éÊó∂Èó¥</label>
                    <input type="datetime-local" id="countdown-date-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-countdown-btn">ÂèñÊ∂à</button>
                <button class="save" id="confirm-create-countdown-btn">‰øùÂ≠òÁ∫¶ÂÆö</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÈÄâÊã©Ê∑ªÂä†Á±ªÂûãÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="add-memory-type-modal" class="modal">
        <div class="modal-content" style="height: auto;">
            <div class="modal-header">
                <span>Ê∑ªÂä†ÂÜÖÂÆπ</span>
            </div>
            <div class="modal-body">
                <button class="form-button" id="add-memory-btn" style="margin-bottom: 15px;">
                    üìù Ê∑ªÂä†ÂõûÂøÜ
                </button>
                <button class="form-button" id="add-event-btn" style="margin-bottom: 15px;">
                    üìÖ Ê∑ªÂä†Á∫¶ÂÆö/‰∫ã‰ª∂
                </button>
                <button class="form-button" id="add-ai-memory-btn">
                    ü§ñ ËÆ©AIËÆ∞ÂΩïÂõûÂøÜ
                </button>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-add-type-btn">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- ‚ñº‚ñº‚ñº AIËÆ∞ÂΩïÂõûÂøÜÈÄâÊã©Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="ai-memory-modal" class="modal">
        <div class="modal-content" style="width: 90%; max-width: 400px;">
            <div class="modal-header">
                <span>ÈÄâÊã©AIËÆ∞ÂΩïÂõûÂøÜ</span>
                <span id="close-ai-memory-modal" style="cursor: pointer; font-size: 20px;">&times;</span>
            </div>
            <div class="modal-body">
                <div id="ai-memory-selection-list" style="max-height: 300px; overflow-y: auto;">
                    <!-- AIÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
            <div class="modal-footer">
                <button id="confirm-ai-memory" class="save">ÂàõÂª∫ÂõûÂøÜ</button>
                <button id="cancel-ai-memory" class="cancel">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ AIËÆ∞ÂΩïÂõûÂøÜÈÄâÊã©Ê®°ÊÄÅÊ°ÜÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëQZoneÊ∑ªÂä†ÂÜÖÂÆπÈÄâÊã©Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="qzone-add-options-modal" class="modal">
        <div class="modal-content" style="height: auto;">
            <div class="modal-header">
                <span>Ê∑ªÂä†ÂÜÖÂÆπ</span>
            </div>
            <div class="modal-body">
                <button class="form-button" id="modal-create-shuoshuo-btn" style="margin-bottom: 15px;">
                    üí¨ ËØ¥ËØ¥
                </button>
                <button class="form-button" id="modal-create-post-btn" style="margin-bottom: 15px;">
                    üì∑ Âä®ÊÄÅ
                </button>
                <button class="form-button" id="modal-open-album-btn">
                    üìÅ Áõ∏ÂÜå
                </button>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-qzone-add-btn">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊ∑ªÂä†ÂõûÂøÜÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="create-memory-modal" class="modal">
        <div class="modal-content" style="height: auto;">
            <div class="modal-header">
                <span>Êñ∞Âª∫ÂõûÂøÜ</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="memory-description-input">ÂõûÂøÜÂÜÖÂÆπ</label>
                    <textarea id="memory-description-input" placeholder="ËÆ∞ÂΩï‰∏ÄÊÆµÁæéÂ•ΩÁöÑÂõûÂøÜ..." rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="memory-date-input">ÂõûÂøÜÊó•Êúü‰∏éÊó∂Èó¥</label>
                    <input type="datetime-local" id="memory-date-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-memory-btn">ÂèñÊ∂à</button>
                <button class="save" id="confirm-create-memory-btn">‰øùÂ≠òÂõûÂøÜ</button>
            </div>
        </div>
    </div>

    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂèëÁ∫¢ÂåÖÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="red-packet-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>ÂèëÁ∫¢ÂåÖ</span>
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- 1. È°µÁ≠æÂàáÊç¢ -->
                <div class="frame-tabs">
                    <div id="rp-tab-group" class="frame-tab active">ÊãºÊâãÊ∞îÁ∫¢ÂåÖ</div>
                    <div id="rp-tab-direct" class="frame-tab">‰∏ìÂ±ûÁ∫¢ÂåÖ</div>
                </div>

                <!-- 2. ÊãºÊâãÊ∞îÁ∫¢ÂåÖÂÜÖÂÆπÂå∫ -->
                <div id="rp-content-group" class="frame-content" style="padding: 20px 15px;">
                    <div class="form-group">
                        <label>ÊÄªÈáëÈ¢ù (ÂÖÉ)</label>
                        <input type="number" id="rp-group-amount" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Á∫¢ÂåÖ‰∏™Êï∞</label>
                        <input type="number" id="rp-group-count" placeholder="Â°´ÂÜôÁ∫¢ÂåÖ‰∏™Êï∞">
                    </div>
                    <div class="form-group">
                        <label>Á•ùÁ¶èËØ≠</label>
                        <input type="text" id="rp-group-greeting" placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ">
                    </div>
                    <p id="rp-group-total"
                        style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¬• 0.00</p>
                    <button id="send-group-packet-btn" class="form-button">Â°ûÈí±ËøõÁ∫¢ÂåÖ</button>
                </div>

                <!-- 3. ‰∏ìÂ±ûÁ∫¢ÂåÖÂÜÖÂÆπÂå∫ -->
                <div id="rp-content-direct" class="frame-content" style="display: none; padding: 20px 15px;">
                    <div class="form-group">
                        <label>ÂèëÈÄÅÁªô</label>
                        <select id="rp-direct-receiver"></select>
                    </div>
                    <div class="form-group">
                        <label>ÈáëÈ¢ù (ÂÖÉ)</label>
                        <input type="number" id="rp-direct-amount" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Á•ùÁ¶èËØ≠</label>
                        <input type="text" id="rp-direct-greeting" placeholder="ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ">
                    </div>
                    <p id="rp-direct-total"
                        style="text-align: center; font-size: 24px; font-weight: bold; margin: 10px 0;">¬• 0.00</p>
                    <button id="send-direct-packet-btn" class="form-button">Â°ûÈí±ËøõÁ∫¢ÂåÖ</button>
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="cancel" id="cancel-red-packet-btn" style="width: 100%;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ∫¢ÂåÖËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="red-packet-details-modal" class="modal">
        <div class="modal-content" style="width: 280px; height: auto; background-color: #f7f7f7;">
            <div class="modal-header"
                style="background-color: #F96259; color: white; border-bottom: none; padding-bottom: 5px;">
                <div style="text-align: center; width: 100%;">
                    <div id="rp-details-sender" style="font-size: 16px;"></div>
                    <div style="font-size: 13px; opacity: 0.8;">ÁöÑÁ∫¢ÂåÖ</div>
                </div>
            </div>
            <div class="modal-body" style="padding: 15px;">
                <p id="rp-details-greeting"
                    style="text-align: center; font-size: 20px; color: #333; margin: 0 0 20px 0;"></p>
                <div id="rp-details-my-amount" style="text-align: center; display: none; margin-bottom: 20px;">
                    <span style="font-size: 40px; font-weight: bold; color: #E44D44;">0.00</span>
                    <span style="font-size: 18px; color: #E44D44;">ÂÖÉ</span>
                </div>
                <div id="rp-details-summary"
                    style="font-size: 13px; color: #8a8a8a; border-top: 1px solid #e0e0e0; padding-top: 10px;"></div>
                <div id="rp-details-list" style="max-height: 150px; overflow-y: auto; margin-top: 10px;">
                    <!-- È¢ÜÂèñËØ¶ÊÉÖÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="save" id="close-rp-details-btn" style="width: 100%;">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂàõÂª∫ÊäïÁ•®Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="create-poll-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>ÂèëËµ∑ÊäïÁ•®</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="poll-question-input">ÊäïÁ•®ÈóÆÈ¢ò</label>
                    <textarea id="poll-question-input" rows="2" placeholder="‰æãÂ¶ÇÔºö‰ªäÊôöÊàë‰ª¨Áúã‰ªÄ‰πàÁîµÂΩ±Ôºü"></textarea>
                </div>
                <div class="form-group">
                    <label>ÊäïÁ•®ÈÄâÈ°π (Ëá≥Â∞ë2È°π)</label>
                    <div id="poll-options-container" style="display: flex; flex-direction: column; gap: 8px;">
                        <!-- ÊäïÁ•®ÈÄâÈ°πÂ∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
                    </div>
                    <button id="add-poll-option-btn" class="form-button form-button-secondary"
                        style="margin-top: 12px;">+ Ê∑ªÂä†ÈÄâÈ°π</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-create-poll-btn">ÂèñÊ∂à</button>
                <button class="save" id="confirm-create-poll-btn">ÂèëËµ∑ÊäïÁ•®</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂÖ¨ÂëäÊùøÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="bulletin-board-modal" class="modal">
        <div class="modal-content" style="height: 80%;">
            <div class="modal-header">
                <span>Áæ§ÂÖ¨ÂëäÊùø</span>
            </div>
            <div class="modal-body" id="bulletin-list">
                <!-- ÂÖ¨ÂëäÂàóË°®Â∞ÜÁî±JSÂä®ÊÄÅÁîüÊàêÂú®ËøôÈáå -->
            </div>
            <div class="modal-footer">
                <button class="save" id="close-bulletin-board-btn" style="width: 100%;">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂÖ¨ÂëäÊùøÊìç‰ΩúËèúÂçïÊ®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="bulletin-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="pin-bulletin-btn">ÁΩÆÈ°∂/ÂèñÊ∂àÁΩÆÈ°∂</button>
                <button id="delete-bulletin-btn" class="btn-danger">Âà†Èô§ÂÖ¨Âëä</button>
                <button id="cancel-bulletin-action-btn"
                    style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº Share Link Modal ‚ñº‚ñº‚ñº -->
    <div id="share-link-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>ÂàÜ‰∫´ÈìæÊé•</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="link-title-input">Ê†áÈ¢ò</label>
                    <input type="text" id="link-title-input" placeholder="ËæìÂÖ•ÊñáÁ´†ÊàñÈìæÊé•ÁöÑÊ†áÈ¢ò">
                </div>
                <div class="form-group">
                    <label for="link-description-input">ÊëòË¶Å (ÂèØÈÄâ)</label>
                    <textarea id="link-description-input" rows="2" placeholder="ÁÆÄÂçïÊèèËø∞‰∏Ä‰∏ãÈìæÊé•ÂÜÖÂÆπ"></textarea>
                </div>
                <div class="form-group">
                    <label for="link-source-input">Êù•Ê∫êÂêçÁß∞ (ÂèØÈÄâ)</label>
                    <input type="text" id="link-source-input" placeholder="‰æãÂ¶ÇÔºöÁü•‰πéÊó•Êä•„ÄÅBÁ´ô">
                </div>
                <div class="form-group">
                    <label for="link-content-input">ÂÆåÊï¥ÂÜÖÂÆπ (ÂèØÈÄâÔºåÁî®‰∫éÊµèËßàÂô®ÂÜÖÊòæÁ§∫)</label>
                    <textarea id="link-content-input" rows="4" placeholder="Á≤òË¥¥ÊàñËæìÂÖ•ÂÆåÊï¥ÁöÑÊñáÁ´†ÂÜÖÂÆπ"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-share-link-btn">ÂèñÊ∂à</button>
                <button class="save" id="confirm-share-link-btn">ÂàÜ‰∫´</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Share Link Modal End ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº Location Share Modal ‚ñº‚ñº‚ñº -->
    <div id="location-share-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>ÂàÜ‰∫´‰ΩçÁΩÆ</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="location-name-input">‰ΩçÁΩÆÂêçÁß∞</label>
                    <input type="text" id="location-name-input" placeholder="‰æãÂ¶ÇÔºöÊòüÂ∑¥ÂÖãÂíñÂï°Â∫ó„ÄÅÂåó‰∫¨Â§ßÂ≠¶">
                </div>
                <div class="form-group">
                    <label for="location-address-input">ËØ¶ÁªÜÂú∞ÂùÄ (ÂèØÈÄâ)</label>
                    <textarea id="location-address-input" rows="2" placeholder="ËæìÂÖ•ËØ¶ÁªÜÂú∞ÂùÄÊàñÊèèËø∞"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="cancel" id="cancel-location-btn">ÂèñÊ∂à</button>
                <button type="button" class="save" id="confirm-location-btn">ÂèëÈÄÅ‰ΩçÁΩÆ</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Location Share Modal End ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº Meetup Creation Modal ‚ñº‚ñº‚ñº -->
    <div id="meetup-creation-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>ÂºÄÂßãËßÅÈù¢</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="meetup-title-input">ËßÅÈù¢‰∏ªÈ¢ò</label>
                    <input type="text" id="meetup-title-input" placeholder="Êµ™Êº´ÊôöÈ§ê, Êï£Ê≠•ËßÅÈù¢...">
                </div>
                <div class="form-group">
                    <label for="meetup-location-input">ËßÅÈù¢Âú∞ÁÇπ</label>
                    <input type="text" id="meetup-location-input" placeholder="ÂíñÂï°ÂéÖ, ÂÖ¨Âõ≠, ÂÆ∂Èáå...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-meetup-btn">ÂèñÊ∂à</button>
                <button class="save" id="start-meetup-btn">ÂºÄÂßãËßÅÈù¢</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Date Creation Modal End ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº QZone Avatar Modal ‚ñº‚ñº‚ñº -->
    <div id="qzone-avatar-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span>ÁºñËæëÂ§¥ÂÉè</span></div>
            <div class="modal-body">
                <div class="form-group"><label>Â§¥ÂÉè</label>
                    <div class="avatar-upload"><img id="qzone-avatar-preview"><button
                            onclick="document.getElementById('qzone-avatar-file-input').click()">‰∏ä‰º†Â§¥ÂÉè</button><input
                            type="file" id="qzone-avatar-file-input" accept="image/*"></div>
                </div>
                <div class="form-group">
                    <label>ÂêØÁî®Â§¥ÂÉèËæπÊ°Ü</label>
                    <label class="switch">
                        <input type="checkbox" id="qzone-border-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="form-group" id="qzone-border-group"><label>Â§¥ÂÉèËæπÊ°Ü</label>
                    <div class="avatar-upload">
                        <div class="border-preview-container">
                            <img id="qzone-border-preview" class="border-preview" style="display: none;">
                            <span id="qzone-no-border-text" class="no-border-text">Êó†ËæπÊ°Ü</span>
                        </div>
                        <button onclick="document.getElementById('qzone-border-input').click()">‰∏ä‰º†ËæπÊ°Ü</button>
                        <button id="qzone-remove-border-btn" onclick="removeQzoneBorder()"
                            style="display: none;">ÁßªÈô§ËæπÊ°Ü</button>
                        <input type="file" id="qzone-border-input" accept="image/png,image/gif">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" onclick="document.getElementById('qzone-avatar-modal').classList.remove('visible')">ÂèñÊ∂à</button>
                <button class="save" id="save-qzone-avatar-btn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ QZone Avatar Modal End ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº Sticker Pack Edit Modal ‚ñº‚ñº‚ñº -->
    <div id="sticker-pack-edit-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>ÁºñËæëË°®ÊÉÖÂåÖ</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sticker-pack-name-input">Ë°®ÊÉÖÂåÖÂêçÁß∞</label>
                    <input type="text" id="sticker-pack-name-input" placeholder="ÊàëÁöÑË°®ÊÉÖÂåÖ">
                </div>
                <div class="form-group">
                    <label for="sticker-pack-icon-input">ÂõæÊ†áÈìæÊé•</label>
                    <input type="text" id="sticker-pack-icon-input" placeholder="https://example.com/icon.png">
                </div>
                <div class="form-group">
                    <button id="delete-sticker-pack-btn"
                        style="width: 100%; padding: 10px; background-color: #ff3b30; color: white; border: none; border-radius: 8px; cursor: pointer;">Âà†Èô§Ë°®ÊÉÖÂåÖ</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-sticker-pack-edit-btn">ÂèñÊ∂à</button>
                <button class="save" id="save-sticker-pack-btn">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Sticker Pack Edit Modal End ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº New Sticker Pack Modal ‚ñº‚ñº‚ñº -->
    <div id="new-sticker-pack-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>Êñ∞Âª∫Ë°®ÊÉÖÂåÖ</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="new-pack-name-input">Ë°®ÊÉÖÂåÖÂêçÁß∞</label>
                    <input type="text" id="new-pack-name-input" placeholder="ÊàëÁöÑË°®ÊÉÖÂåÖ">
                </div>
                <div class="form-group">
                    <label for="new-pack-icon-input">ÂõæÊ†áÈìæÊé•</label>
                    <input type="text" id="new-pack-icon-input" placeholder="https://example.com/icon.png">
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-new-pack-btn">ÂèñÊ∂à</button>
                <button class="save" id="create-new-pack-btn">ÂàõÂª∫</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ New Sticker Pack Modal End ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº Meetup End Confirmation Modal ‚ñº‚ñº‚ñº -->
    <div id="meetup-end-modal" class="modal">
        <div class="modal-content" style="width: 300px; height: auto;">
            <div class="modal-header">
                <span>ÁªìÊùüËßÅÈù¢</span>
            </div>
            <div class="modal-body">
                <p>Á°ÆÂÆöË¶ÅÁªìÊùüËøôÊ¨°ËßÅÈù¢ÂêóÔºüÊâÄÊúâÁöÑÁæéÂ•ΩÂõûÂøÜÈÉΩ‰ºö‰øùÂ≠òÂà∞Êó•ÂéÜ‰∏≠„ÄÇ</p>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-end-date-btn" onclick="hideMeetupEndModal()">ÁªßÁª≠ËßÅÈù¢</button>
                <button class="save" id="confirm-end-date-btn" onclick="window.confirmEndMeetup()">ÁªìÊùüËßÅÈù¢</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Date End Confirmation Modal End ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº Chat Search Modal ‚ñº‚ñº‚ñº -->
    <div id="chat-search-modal" class="modal">
        <div class="modal-content" style="width: 320px; height: 70%;">
            <div class="modal-header">
                <span>ÊêúÁ¥¢Ê∂àÊÅØ</span>
            </div>
            <div class="modal-body" style="display: flex; flex-direction: column; gap: 15px;">
                <div class="form-group">
                    <input type="text" id="search-input" placeholder="ËæìÂÖ•ÂÖ≥ÈîÆËØçÊêúÁ¥¢Ê∂àÊÅØ..."
                        style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                </div>
                <div id="search-results"
                    style="flex: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px;">
                    <p style="text-align: center; color: #999; margin: 20px 0;">ËæìÂÖ•ÂÖ≥ÈîÆËØçÂºÄÂßãÊêúÁ¥¢</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="close-search-btn" style="width: 100%;">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤ Chat Search Modal End ‚ñ≤‚ñ≤‚ñ≤ -->

    <!-- ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞shep„ÄëÂ§á‰ªΩÁâàÊú¨ÈÄâÊã©Ê®°ÊÄÅÊ°Ü ‚ñº‚ñº‚ñº -->
    <div id="restore-version-modal" class="modal">
        <div class="modal-content" style="width: 320px; height: auto;">
            <div class="modal-header">
                <span>ÈÄâÊã©Ë¶ÅÊÅ¢Â§çÁöÑ‰∫ëÁ´ØÂ§á‰ªΩ</span>
            </div>
            <div class="modal-body" id="restore-version-list" style="padding: 15px 0;">
                <!-- Âä†ËΩΩÊèêÁ§∫ -->
                <p style="text-align:center; color: var(--text-secondary);">Ê≠£Âú®‰ªé‰∫ëÁ´ØËé∑ÂèñÂ§á‰ªΩ‰ø°ÊÅØ...</p>
            </div>
            <div class="modal-footer">
                <button class="cancel" id="cancel-restore-version-btn" style="width: 100%;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>
    <!-- ‚ñ≤‚ñ≤‚ñ≤shepshep Êñ∞HTMLÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ -->
    <script>
        // Spotify Web Playback SDK callback - must be defined globally before SDK loads
        window.onSpotifyWebPlaybackSDKReady = function () {
            // This will be handled by initSpotifyPlayer() when needed
        };

        // Function to toggle charm visibility - defined early to avoid execution order issues
        window.toggleCharmVisibility = function (isVisible) {
            const charm = document.getElementById('floating-phone-charm');
            if (charm) {
                charm.style.display = isVisible ? 'block' : 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {

            // ===================================================================
            // 1. ÊâÄÊúâÂèòÈáèÂíåÂ∏∏ÈáèÂÆö‰πâ
            // ===================================================================
            const db = new Dexie('GeminiChatDB');
            window.db = db;
            // --- Â∑≤‰øÆÊ≠£ ---
            let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [], qzoneSettings: {}, activeAlbumId: null };
            // --- ‰øÆÊ≠£ÁªìÊùü ---
            let musicState = { isActive: false, activeChatId: null, isPlaying: false, playlist: [], currentIndex: -1, playMode: 'order', totalElapsedTime: 0, timerId: null, currentSpotifyPlaylist: null, spotifyPlaylistTracks: [], isPlayingFromPlaylist: false, mainPlaylist: [] };
            // Spotify integration variables
            let spotifyPlayer = null;
            let spotifyAccessToken = null;
            let spotifyDeviceId = null;
            
            // Summary generation state
            let isGeneratingSummary = false;
            let generatingSummaryBookId = null;
            
            const audioPlayer = document.getElementById('audio-player');
            let newWallpaperBase64 = null;
            let isSelectionMode = false;
            let selectedMessages = new Set();
            let editingMemberId = null;
            let editingFrameForMember = false;
            let editingWorldBookId = null;
            let editingPersonaPresetId = null;
            let editingMemoryId = null;
            let previousScreen = null; // Track previous screen for meetup navigation
            let inactivityTimers = {}; // Áî®‰∫éÂ≠òÂÇ®1.5Â∞èÊó∂Á¶ªÁ∫øËÆ°Êó∂Âô®
            let focusModeTimers = {}; // Áî®‰∫éÂ≠òÂÇ®‰∏ìÊ≥®Ê®°ÂºèËÆ°Êó∂Âô®
            let waimaiTimers = {}; // Áî®‰∫éÂ≠òÂÇ®Â§ñÂçñÂÄíËÆ°Êó∂

            let activeMessageTimestamp = null;
            let activeChatId = null;
            let currentReplyContext = null; // <--- Êñ∞Â¢ûËøôË°åÔºåÁî®Êù•Â≠òÂÇ®ÂΩìÂâçÊ≠£Âú®ÂºïÁî®ÁöÑÊ∂àÊÅØ‰ø°ÊÅØ
            let activePostId = null; // <-- Êñ∞Â¢ûÔºöÁî®‰∫éÂ≠òÂÇ®ÂΩìÂâçÊìç‰ΩúÁöÑÂä®ÊÄÅID
            let activeBulletinId = null; // <-- Êñ∞Â¢ûÔºöÁî®‰∫éÂ≠òÂÇ®ÂΩìÂâçÊìç‰ΩúÁöÑÂÖ¨ÂëäID
            let activeCommentData = null; // <-- Êñ∞Â¢ûÔºöÁî®‰∫éÂ≠òÂÇ®ÂΩìÂâçÊìç‰ΩúÁöÑËØÑËÆ∫Êï∞ÊçÆ {postId, timestamp, text, commenterName}

            let photoViewerState = {
                isOpen: false,
                photos: [], // Â≠òÂÇ®ÂΩìÂâçÁõ∏ÂÜåÁöÑÊâÄÊúâÁÖßÁâáURL
                currentIndex: -1, // ÂΩìÂâçÊ≠£Âú®Êü•ÁúãÁöÑÁÖßÁâáÁ¥¢Âºï
            };

            let unreadPostsCount = 0;

            let isFavoritesSelectionMode = false;
            let selectedFavorites = new Set()

            let simulationIntervalId = null;

            const frameModal = document.getElementById('avatar-frame-modal');
            const aiFrameTab = document.getElementById('ai-frame-tab');
            const myFrameTab = document.getElementById('my-frame-tab');
            const aiFrameContent = document.getElementById('ai-frame-content');
            const myFrameContent = document.getElementById('my-frame-content');
            const aiFrameGrid = document.getElementById('ai-frame-grid');
            const myFrameGrid = document.getElementById('my-frame-grid');

            const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
            const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
            const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
            const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
            let notificationTimeout;

            const npcAvatarPool = {
                'anime_boy': ['https://i.postimg.cc/pL5505fT/image.png', 'https://i.postimg.cc/8CKdY2z4/image.png'],
                'anime_girl': ['https://i.postimg.cc/PqgqfH7S/image.png', 'https://i.postimg.cc/Z5pCY9tQ/image.png'],
                'cat': ['https://i.postimg.cc/d11x6HKZ/image.png', 'https://i.postimg.cc/VL1gLgV3/image.png'],
                'professional': ['https://i.postimg.cc/13yXhJg9/image.png', 'https://i.postimg.cc/W34kKFN5/image.png'],
                'pixel_art': ['https://i.postimg.cc/VvF0tGgG/image.png', 'https://i.postimg.cc/wMPyS8bB/image.png']
            };


            let currentFrameSelection = { ai: null, my: null };
            const STICKER_REGEX = /^(https:\/\/i\.postimg\.cc\/.+|https:\/\/files\.catbox\.moe\/.+|data:image)/;
            const MESSAGE_RENDER_WINDOW = 50;
            let currentRenderedCount = 0;
            let lastKnownBatteryLevel = 1;
            let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
            let batteryAlertTimeout;
            const dynamicFontStyle = document.createElement('style');
            dynamicFontStyle.id = 'dynamic-font-style';
            document.head.appendChild(dynamicFontStyle);

            const modalOverlay = document.getElementById('custom-modal-overlay');
            const modalTitle = document.getElementById('custom-modal-title');
            const modalBody = document.getElementById('custom-modal-body');
            const modalConfirmBtn = document.getElementById('custom-modal-confirm');
            const modalCancelBtn = document.getElementById('custom-modal-cancel');
            let modalResolve;

            function showCustomModal() {
                modalOverlay.classList.add('visible');
            }

            function hideCustomModal() {
                modalOverlay.classList.remove('visible');
                modalConfirmBtn.classList.remove('btn-danger');
                if (modalResolve) modalResolve(null);
            }

            function showCustomConfirm(title, message, options = {}) {
                return new Promise(resolve => {
                    modalResolve = resolve;
                    modalTitle.textContent = title;
                    modalBody.innerHTML = `<p>${message}</p>`;
                    modalCancelBtn.style.display = 'block';
                    modalConfirmBtn.textContent = 'Á°ÆÂÆö';
                    if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                    modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                    modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                    showCustomModal();
                });
            }

            function showCustomAlert(title, message) {
                return new Promise(resolve => {
                    modalResolve = resolve;
                    modalTitle.textContent = title;
                    modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                    modalCancelBtn.style.display = 'none';
                    modalConfirmBtn.textContent = 'Â•ΩÁöÑ';
                    modalConfirmBtn.onclick = () => {
                        modalCancelBtn.style.display = 'block';
                        modalConfirmBtn.textContent = 'Á°ÆÂÆö';
                        resolve(true);
                        hideCustomModal();
                    };
                    showCustomModal();
                });
            }

            // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂäüËÉΩÂ¢ûÂº∫Áâà„ÄëÊõøÊç¢ÊóßÁöÑ showCustomPrompt ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            function showCustomPrompt(title, placeholder, initialValue = '', type = 'text', extraHtml = '') {
                return new Promise(resolve => {
                    modalResolve = resolve;
                    modalTitle.textContent = title;
                    const inputId = 'custom-prompt-input';

                    const inputHtml = type === 'textarea'
                        ? `<textarea id="${inputId}" placeholder="${placeholder}" rows="5" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; resize: vertical;">${initialValue}</textarea>`
                        : `<input type="${type}" id="${inputId}" placeholder="${placeholder}" value="${initialValue}">`;

                    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂ∞ÜÈ¢ùÂ§ñÁöÑHTMLÂíåËæìÂÖ•Ê°ÜÁªÑÂêàÂú®‰∏ÄËµ∑
                    modalBody.innerHTML = extraHtml + inputHtml;
                    const input = document.getElementById(inputId);

                    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„Äë‰∏∫Ê†ºÂºèÂä©ÊâãÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂
                    modalBody.querySelectorAll('.format-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const templateStr = btn.dataset.template;
                            if (templateStr) {
                                try {
                                    const templateObj = JSON.parse(templateStr);
                                    // ‰ΩøÁî® null, 2 ÂèÇÊï∞ËÆ©JSONÂ≠óÁ¨¶‰∏≤Ê†ºÂºèÂåñÔºåÂ∏¶Áº©ËøõÔºåÊõ¥ÊòìËØª
                                    input.value = JSON.stringify(templateObj, null, 2);
                                    input.focus();
                                } catch (e) {
                                    console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e);
                                }
                            }
                        });
                    });

                    modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
                    modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
                    showCustomModal();
                    setTimeout(() => input.focus(), 100);
                });
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ===================================================================
            // 2. Êï∞ÊçÆÂ∫ìÁªìÊûÑÂÆö‰πâ
            // ===================================================================

            db.version(22).stores({
                chats: '&id, isGroup, groupId',
                apiConfig: '&id',
                globalSettings: '&id',
                userStickers: '&id, url, name, order, packId',
                worldBooks: '&id, name',
                musicLibrary: '&id',
                personaPresets: '&id',
                qzoneSettings: '&id',
                qzonePosts: '++id, timestamp, authorId, isPinned', // <-- ‰∏∫authorIdÊ∑ªÂä†Á¥¢ÂºïÔºåÊ∑ªÂä†isPinnedÂ≠óÊÆµ
                qzoneAlbums: '++id, name, createdAt',
                qzonePhotos: '++id, albumId',
                favorites: '++id, type, timestamp, originalTimestamp',
                qzoneGroups: '++id, name',
                memories: '++id, chatId, timestamp, type, targetDate',
                bulletins: '++id, chatId, timestamp, isPinned' // <--- „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëËøôÂ∞±ÊòØÂÖ¨ÂëäÁöÑÊñ∞ÂÆ∂ÔºÅ
            });

            // ===================================================================
            // 3. ÊâÄÊúâÂäüËÉΩÂáΩÊï∞ÂÆö‰πâ
            // ===================================================================

            function showScreen(screenId) {
                if (screenId === 'chat-list-screen') {
                    window.renderChatListProxy();
                    switchToChatListView('messages-view');
                }
                if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
                if (screenId === 'appearance-settings-screen') {
                    window.renderWallpaperScreenProxy();

                    // Initialize charm visibility toggle after screen is rendered
                    setTimeout(() => {
                        const charmVisibilityToggle = document.getElementById('charm-visibility-toggle');
                        if (charmVisibilityToggle) {
                            // Load saved state
                            const savedVisibility = localStorage.getItem('charmVisibility');
                            const isVisible = savedVisibility !== 'false'; // Default to true
                            charmVisibilityToggle.checked = isVisible;

                            // Apply initial state
                            window.toggleCharmVisibility(isVisible);

                            // Remove any existing event listeners to avoid duplicates
                            charmVisibilityToggle.removeEventListener('change', window.charmToggleHandler);

                            // Add event listener
                            window.charmToggleHandler = (e) => {
                                const isVisible = e.target.checked;
                                localStorage.setItem('charmVisibility', isVisible.toString());
                                window.toggleCharmVisibility(isVisible);
                            };
                            charmVisibilityToggle.addEventListener('change', window.charmToggleHandler);
                        }
                    }, 100);
                }
                if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
                if (screenId === 'settings-screen') window.renderSettingsScreenProxy();
                if (screenId === 'general-settings-screen') {
                    window.renderGeneralSettingsScreenProxy();
                    // Initialize photo compression toggle state
                    const toggle = document.getElementById('photo-compression-toggle');
                    if (toggle) {
                        toggle.checked = state.globalSettings.photoCompression !== false; // Default to true
                    }


                }
                if (screenId === 'calendar-screen') window.renderCalendarScreenProxy();
                if (screenId === 'meetup-screen') {
                    initializeMeetupScreen();
                }

                // Track previous screen for meetup navigation
                const currentActiveScreen = document.querySelector('.screen.active');
                if (currentActiveScreen && screenId === 'meetup-screen') {
                    previousScreen = currentActiveScreen.id;
                }

                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                const screenToShow = document.getElementById(screenId);
                if (screenToShow) screenToShow.classList.add('active');
                if (screenId === 'chat-interface-screen') {
                    window.updateListenTogetherIconProxy(state.activeChatId);
                    // Only update content if bar is already visible
                    updateNowPlayingBarContent();
                }

                // Update now playing bar visibility when switching screens
                if (musicState.isActive && (screenId === 'home-screen' || screenId === 'chat-interface-screen')) {
                    showNowPlayingBar();
                }



                // Update meetup progress bar visibility when switching screens
                if (hasActiveMeetupSession() && (screenId === 'home-screen' || screenId === 'chat-interface-screen')) {
                    showMeetupProgressBar();
                }
                if (screenId === 'appearance-settings-screen') {
                    const savedFontUrl = state.globalSettings.fontUrl || '';
                    document.getElementById('font-url-input').value = savedFontUrl;

                    // Check if saved font is a data URL (uploaded font) or regular URL
                    if (savedFontUrl.startsWith('data:')) {
                        // It's an uploaded font
                        document.getElementById('font-file-name').textContent = 'Â∑≤‰∏ä‰º†ÁöÑÂ≠ó‰ΩìÊñá‰ª∂';
                        window.uploadedFontData = savedFontUrl;
                    } else {
                        // It's a URL or empty
                        document.getElementById('font-file-name').textContent = 'Êú™ÈÄâÊã©Êñá‰ª∂';
                        window.uploadedFontData = null;
                    }

                    applyCustomFont(savedFontUrl, true);
                }
            }
            window.updateListenTogetherIconProxy = () => { };



            function switchToChatListView(viewId) {
                const chatListScreen = document.getElementById('chat-list-screen');
                const views = {
                    'messages-view': document.getElementById('messages-view'),
                    'qzone-screen': document.getElementById('qzone-screen'),
                    'favorites-view': document.getElementById('favorites-view'),
                    'memories-view': document.getElementById('memories-view') // <-- Êñ∞Â¢ûËøô‰∏ÄË°å
                };
                const mainHeader = document.getElementById('main-chat-list-header');
                const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // Ëé∑Âèñ‰∏ªÂØºËà™Ê†è

                if (isFavoritesSelectionMode) {
                    document.getElementById('favorites-edit-btn').click();
                }

                // ÈöêËóèÊâÄÊúâËßÜÂõæ
                Object.values(views).forEach(v => v.classList.remove('active'));
                // ÊòæÁ§∫ÁõÆÊ†áËßÜÂõæ
                if (views[viewId]) {
                    views[viewId].classList.add('active');
                }

                // Êõ¥Êñ∞Â∫ïÈÉ®ÂØºËà™Ê†èÈ´ò‰∫Æ
                document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => {
                    item.classList.toggle('active', item.dataset.view === viewId);
                });

                // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÁªü‰∏ÄÁÆ°ÁêÜÊâÄÊúâUIÂÖÉÁ¥†ÁöÑÊòæÈöê ‚ñº‚ñº‚ñº
                if (viewId === 'messages-view') {
                    mainHeader.style.display = 'flex';
                    mainBottomNav.style.display = 'flex';
                } else {
                    mainHeader.style.display = 'none';
                    mainBottomNav.style.display = 'none';
                }
                // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊ≠£ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                if (viewId !== 'memories-view') {
                    activeCountdownTimers.forEach(timerId => clearInterval(timerId));
                    activeCountdownTimers = [];
                }

                // Ê†πÊçÆËßÜÂõæIDÊâßË°åÁâπÂÆöÁöÑÊ∏≤Êüì/Êõ¥Êñ∞ÈÄªËæë
                switch (viewId) {
                    case 'qzone-screen':
                        views['qzone-screen'].style.backgroundColor = '#f0f2f5';
                        updateUnreadIndicator(0);
                        renderQzoneScreen();
                        renderQzonePosts();
                        break;
                    case 'favorites-view':
                        views['favorites-view'].style.backgroundColor = '#f9f9f9';
                        renderFavoritesScreen();
                        break;
                    case 'messages-view':
                        // Â¶ÇÊûúÈúÄË¶ÅÔºåÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ËøîÂõûÊ∂àÊÅØÂàóË°®Êó∂Ë¶ÅÊâßË°åÁöÑÈÄªËæë
                        break;
                }
            }

            function renderQzoneScreen() {
                if (state && state.qzoneSettings) {
                    const settings = state.qzoneSettings;
                    document.getElementById('qzone-nickname').textContent = settings.nickname;
                    document.getElementById('qzone-banner-img').src = settings.banner;

                    // Handle avatar with border - keep original structure, just add/remove frame overlay
                    const avatarContainer = document.getElementById('qzone-avatar-container');
                    const avatarImg = document.getElementById('qzone-avatar-img');

                    // Always ensure the basic avatar exists
                    if (!avatarImg) {
                        avatarContainer.innerHTML = `
                            <img id="qzone-avatar-img" src="${settings.avatar}" alt="Â§¥ÂÉè" class="avatar">
                            <input type="file" id="qzone-avatar-input" accept="image/*" hidden>
                        `;
                    } else {
                        // Update avatar source
                        avatarImg.src = settings.avatar;
                    }

                    // Remove any existing frame
                    const existingFrame = avatarContainer.querySelector('.qzone-avatar-frame');
                    if (existingFrame) {
                        existingFrame.remove();
                    }

                    // Handle borders enabled state
                    if (settings.avatarBordersEnabled) {
                        // Add borders-enabled class to decrease avatar size
                        avatarContainer.classList.add('borders-enabled');

                        // Add frame if exists
                        if (settings.avatarFrame) {
                            const frameImg = document.createElement('img');
                            frameImg.src = settings.avatarFrame;
                            frameImg.className = 'qzone-avatar-frame';
                            avatarContainer.appendChild(frameImg);
                        }
                    } else {
                        // Remove borders-enabled class to restore original size
                        avatarContainer.classList.remove('borders-enabled');
                    }
                }
            }
            window.renderQzoneScreenProxy = renderQzoneScreen;



            async function saveQzoneSettings() {
                if (db && state.qzoneSettings) {
                    await db.qzoneSettings.put(state.qzoneSettings);
                }
            }

            function formatPostTimestamp(timestamp) {
                if (!timestamp) return '';
                const now = new Date();
                const date = new Date(timestamp);
                const diffSeconds = Math.floor((now - date) / 1000);
                const diffMinutes = Math.floor(diffSeconds / 60);
                const diffHours = Math.floor(diffMinutes / 60);
                if (diffMinutes < 1) return 'ÂàöÂàö';
                if (diffMinutes < 60) return `${diffMinutes}ÂàÜÈíüÂâç`;
                if (diffHours < 24) return `${diffHours}Â∞èÊó∂Ââç`;
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                if (now.getFullYear() === year) {
                    return `${month}-${day} ${hours}:${minutes}`;
                } else {
                    return `${year}-${month}-${day} ${hours}:${minutes}`;
                }
            }

            function formatTimeDifference(ms) {
                if (ms < 60000) return null; // Â∞è‰∫é1ÂàÜÈíü‰∏çÂ§ÑÁêÜ
                const minutes = Math.floor(ms / 60000);
                if (minutes < 60) {
                    return `Á∫¶ ${minutes} ÂàÜÈíü`;
                }
                const hours = Math.floor(minutes / 60);
                const remainingMinutes = minutes % 60;
                if (remainingMinutes === 0) {
                    return `${hours} Â∞èÊó∂`;
                }
                return `${hours} Â∞èÊó∂ ${remainingMinutes} ÂàÜÈíü`;
            }

            async function renderQzonePosts() {
                const postsListEl = document.getElementById('qzone-posts-list');
                if (!postsListEl) return;

                const [allPosts, favorites] = await Promise.all([
                    db.qzonePosts.orderBy('timestamp').reverse().toArray(),
                    db.favorites.where('type').equals('qzone_post').toArray() // Ëé∑ÂèñÊâÄÊúâÂ∑≤Êî∂ËóèÁöÑÂä®ÊÄÅ
                ]);

                // ÊåâÁΩÆÈ°∂Áä∂ÊÄÅÂíåÊó∂Èó¥ÊéíÂ∫èÔºöÁΩÆÈ°∂ÁöÑÂú®ÂâçÔºåÁÑ∂ÂêéÊåâÊó∂Èó¥ÂÄíÂ∫è
                const posts = allPosts.sort((a, b) => {
                    // È¶ñÂÖàÊåâÁΩÆÈ°∂Áä∂ÊÄÅÊéíÂ∫èÔºàÁΩÆÈ°∂ÁöÑÂú®ÂâçÔºâ
                    if (a.isPinned && !b.isPinned) return -1;
                    if (!a.isPinned && b.isPinned) return 1;

                    // ÁÑ∂ÂêéÊåâÊó∂Èó¥ÂÄíÂ∫èÊéíÂ∫è
                    return b.timestamp - a.timestamp;
                });

                // ÂàõÂª∫‰∏Ä‰∏™Â∑≤Êî∂ËóèÂ∏ñÂ≠êIDÁöÑÈõÜÂêàÔºåÊñπ‰æøÂø´ÈÄüÊü•Êâæ
                const favoritedPostIds = new Set(favorites.map(fav => fav.content.id));

                postsListEl.innerHTML = '';

                if (posts.length === 0) {
                    postsListEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 30px 0;">ËøôÈáåÁ©∫Á©∫Â¶Ç‰πüÔºåÂø´Êù•ÂèëÂ∏ÉÁ¨¨‰∏ÄÊù°ËØ¥ËØ¥ÂêßÔºÅ</p>';
                    return;
                }

                const userSettings = state.qzoneSettings;

                posts.forEach(post => {
                    const postContainer = document.createElement('div');
                    postContainer.className = 'qzone-post-container';
                    postContainer.dataset.postId = post.id;

                    const postEl = document.createElement('div');
                    postEl.className = 'qzone-post-item';

                    let authorAvatar = '', authorNickname = '', commentAvatar = userSettings.avatar;

                    if (post.authorId === 'user') {
                        authorAvatar = userSettings.avatar;
                        authorNickname = userSettings.nickname;
                    } else if (state.chats[post.authorId]) {
                        const authorChat = state.chats[post.authorId];
                        authorAvatar = authorChat.settings.aiAvatar || defaultAvatar;
                        authorNickname = authorChat.name;
                    } else {
                        authorAvatar = defaultAvatar;
                        authorNickname = '{{char}}';
                    }

                    let contentHtml = '';
                    const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';

                    if (post.type === 'shuoshuo') {
                        contentHtml = `<div class="post-content" style="margin-bottom: 10px;">${post.content.replace(/\n/g, '<br>')}</div>`;
                    }
                    else if (post.type === 'image_post' && post.imageUrl) {
                        contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
                    }
                    else if (post.type === 'text_image') {
                        // For text_image posts, show public text and decorative image if available
                        if (post.decorativeImageUrl) {
                            contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.decorativeImageUrl}" class="chat-image"></div>` : `<img src="${post.decorativeImageUrl}" class="chat-image">`;
                        } else {
                            contentHtml = publicTextHtml || '';
                        }
                    }

                    let likesHtml = '';
                    if (post.likes && post.likes.length > 0) {
                        likesHtml = `<div class="post-likes-section"><svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg><span>${post.likes.join('„ÄÅ')} ËßâÂæóÂæàËµû</span></div>`;
                    }

                    let commentsHtml = '';
                    if (post.comments && post.comments.length > 0) {
                        commentsHtml = '<div class="post-comments-container">';
                        post.comments.forEach(comment => {
                            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåËøõË°åÈò≤Âæ°ÊÄßÊ£ÄÊü•
                            const commenterName = comment.commenterName || 'ÂåøÂêç'; // Â¶ÇÊûúÂêçÂ≠óÊòØundefinedÔºåÂàôÊòæÁ§∫ÂåøÂêç
                            const commentText = comment.text || ''; // Â¶ÇÊûúÂÜÖÂÆπÊòØundefinedÔºåÂàôÊòæÁ§∫‰∏∫Á©∫
                            commentsHtml += `<div class="comment-item" data-comment-timestamp="${comment.timestamp || ''}" data-commenter="${commenterName}"><span class="commenter-name">${commenterName}:</span><span class="comment-text">${commentText}</span></div>`;
                        });
                        commentsHtml += '</div>';
                    }

                    // Ê£ÄÊü•ÁÇπËµûÂíåÊî∂ËóèÁä∂ÊÄÅ
                    const userNickname = state.qzoneSettings.nickname;
                    const isLikedByUser = post.likes && post.likes.includes(userNickname);
                    const isFavoritedByUser = favoritedPostIds.has(post.id); // ‰ΩøÁî®SetÂø´ÈÄüÊü•Êâæ

                    // Create avatar HTML with overlay frame support (no layout changes)
                    let avatarHtml;
                    let avatarFrameSrc = '';

                    // Determine avatar frame (only if borders are enabled)
                    if (state.qzoneSettings.avatarBordersEnabled) {
                        if (post.authorId === 'user') {
                            avatarFrameSrc = state.qzoneSettings.avatarFrame || '';
                        } else if (state.chats[post.authorId]) {
                            avatarFrameSrc = state.chats[post.authorId].settings.aiAvatarFrame || '';
                        }
                    }

                    if (avatarFrameSrc) {
                        // Use overlay approach - no layout changes
                        avatarHtml = `
                            <div class="avatar-container">
                                <img src="${authorAvatar}" class="avatar">
                                <img src="${avatarFrameSrc}" class="avatar-frame">
                            </div>
                        `;
                    } else {
                        // Regular avatar without frame
                        avatarHtml = `<img src="${authorAvatar}" class="post-avatar">`;
                    }

                    postEl.innerHTML = `
                    <div class="post-header">
                        ${avatarHtml}
                        <div class="post-info">
                            <span class="post-nickname">${authorNickname}</span>
                            <span class="post-timestamp">${formatPostTimestamp(post.timestamp)}</span>
                        </div>
                        <div style="margin-left: auto; display: flex; align-items: center; gap: 8px;">
                            ${post.type === 'text_image' ? `<span data-hidden-text="${post.hiddenContent || ''}" style="cursor: pointer;">üí≠</span>` : ''}
                            <div class="post-actions-btn" data-hidden-text="${post.hiddenContent || ''}" style="margin-left: 0;">‚Ä¶</div>
                        </div>
                    </div>

                    <div class="post-main-content">${contentHtml}</div>
                    <div class="post-feedback-icons">
                        <span class="action-icon like ${isLikedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg></span>
                        <span class="action-icon favorite ${isFavoritedByUser ? 'active' : ''}"><svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path></svg></span>
                    </div>
                    ${likesHtml}
                    ${commentsHtml}
                    <div class="post-footer"><div class="comment-section"><img src="${commentAvatar}" class="comment-avatar"><input type="text" class="comment-input" placeholder="ÂèãÂñÑÁöÑËØÑËÆ∫ÊòØ‰∫§ÊµÅÁöÑËµ∑ÁÇπ"><div class="at-mention-popup"></div></div><button class="comment-send-btn">ÂèëÈÄÅ</button><button class="call-ai-reply-btn" title="ËÆ©AI‰ª¨ÂõûÂ§ç">ü§ñ</button></div>
                `;

                    // COMMENTED OUT: Delete action for swipe functionality
                    /*
                    const deleteAction = document.createElement('div');
                    deleteAction.className = 'qzone-post-delete-action';
                    deleteAction.innerHTML = '<span>Âà†Èô§</span>';
                    postContainer.appendChild(deleteAction);
                    */
                    postContainer.appendChild(postEl);
                    const commentSection = postContainer.querySelector('.comment-section');
                    if (commentSection) {
                        commentSection.addEventListener('touchstart', (e) => e.stopPropagation());
                        commentSection.addEventListener('mousedown', (e) => e.stopPropagation());
                    }
                    postsListEl.appendChild(postContainer);

                    // ‰∏∫ÊâÄÊúâËØÑËÆ∫Ê∑ªÂä†ÈïøÊåâÁõëÂê¨Âô®
                    const commentItems = postContainer.querySelectorAll('.comment-item');
                    commentItems.forEach(commentItem => {
                        const commenterName = commentItem.dataset.commenter;
                        const commentTimestamp = parseInt(commentItem.dataset.commentTimestamp);
                        const commentText = commentItem.querySelector('.comment-text')?.textContent || '';
                        const postId = parseInt(postContainer.dataset.postId);

                        addLongPressListener(commentItem, async () => {
                            showCommentActions(postId, commentTimestamp, commentText, commenterName);
                        })
                    });

                    const commentInput = postContainer.querySelector('.comment-input');
                    const popup = postContainer.querySelector('.at-mention-popup');
                    commentInput.addEventListener('input', () => {
                        const value = commentInput.value;
                        const atMatch = value.match(/@([\p{L}\w]*)$/u);
                        if (atMatch) {
                            const namesToMention = new Set();
                            const authorNickname = postContainer.querySelector('.post-nickname')?.textContent;
                            if (authorNickname) namesToMention.add(authorNickname);
                            postContainer.querySelectorAll('.commenter-name').forEach(nameEl => {
                                namesToMention.add(nameEl.textContent.replace(':', ''));
                            });
                            namesToMention.delete(state.qzoneSettings.nickname);
                            popup.innerHTML = '';
                            if (namesToMention.size > 0) {
                                const searchTerm = atMatch[1];
                                namesToMention.forEach(name => {
                                    if (name.toLowerCase().includes(searchTerm.toLowerCase())) {
                                        const item = document.createElement('div');
                                        item.className = 'at-mention-item';
                                        item.textContent = name;
                                        item.addEventListener('mousedown', (e) => {
                                            e.preventDefault();
                                            const newText = value.substring(0, atMatch.index) + `@${name} `;
                                            commentInput.value = newText;
                                            popup.style.display = 'none';
                                            commentInput.focus();
                                        });
                                        popup.appendChild(item);
                                    }
                                });
                                popup.style.display = popup.children.length > 0 ? 'block' : 'none';
                            } else {
                                popup.style.display = 'none';
                            }
                        } else {
                            popup.style.display = 'none';
                        }
                    });
                    commentInput.addEventListener('blur', () => { setTimeout(() => { popup.style.display = 'none'; }, 200); });
                });
            }

            // ‚ñº‚ñº‚ñº ËØ∑Áî®‰∏ãÈù¢Ëøô‰∏™„ÄêÊõ¥Êñ∞ÂêéÁöÑ„ÄëÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†‰ª£Á†Å‰∏≠ÊóßÁöÑ displayFilteredFavorites ÂáΩÊï∞ ‚ñº‚ñº‚ñº

            function displayFilteredFavorites(items) {
                const listEl = document.getElementById('favorites-list');
                listEl.innerHTML = '';

                if (items.length === 0) {
                    const searchTerm = document.getElementById('favorites-search-input').value;
                    const message = searchTerm ? 'Êú™ÊâæÂà∞Áõ∏ÂÖ≥Êî∂Ëóè' : '‰Ω†ÁöÑÊî∂ËóèÂ§πÊòØÁ©∫ÁöÑÔºå<br>Âø´ÂéªÂä®ÊÄÅÊàñËÅäÂ§©‰∏≠Êî∂ËóèÂñúÊ¨¢ÁöÑÂÜÖÂÆπÂêßÔºÅ';
                    listEl.innerHTML = `<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">${message}</p>`;
                    return;
                }

                for (const item of items) {
                    const card = document.createElement('div');
                    card.className = 'favorite-item-card';
                    card.dataset.favid = item.id;

                    let headerHtml = '', contentHtml = '', sourceText = '', footerHtml = '';

                    if (item.type === 'qzone_post') {
                        const post = item.content;
                        sourceText = 'Êù•Ëá™Âä®ÊÄÅ';
                        let authorAvatar = defaultAvatar, authorNickname = 'Êú™Áü•Áî®Êà∑';

                        if (post.authorId === 'user') {
                            authorAvatar = state.qzoneSettings.avatar;
                            authorNickname = state.qzoneSettings.nickname;
                        } else if (state.chats[post.authorId]) {
                            authorAvatar = state.chats[post.authorId].settings.aiAvatar;
                            authorNickname = state.chats[post.authorId].name;
                        }

                        headerHtml = `<img src="${authorAvatar}" class="avatar"><div class="info"><div class="name">${authorNickname}</div></div>${post.type === 'text_image' ? `<span data-hidden-text="${post.hiddenContent || ''}" style="cursor: pointer;">üí≠</span>` : ''}`;

                        const publicTextHtml = post.publicText ? `<div class="post-content">${post.publicText.replace(/\n/g, '<br>')}</div>` : '';
                        if (post.type === 'shuoshuo') {
                            contentHtml = `<div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>`;
                        } else if (post.type === 'image_post' && post.imageUrl) {
                            contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.imageUrl}" class="chat-image"></div>` : `<img src="${post.imageUrl}" class="chat-image">`;
                        } else if (post.type === 'text_image') {
                            // For text_image posts, show public text and decorative image if available
                            if (post.decorativeImageUrl) {
                                contentHtml = publicTextHtml ? `${publicTextHtml}<div style="margin-top:10px;"><img src="${post.decorativeImageUrl}" class="chat-image"></div>` : `<img src="${post.decorativeImageUrl}" class="chat-image">`;
                            } else {
                                contentHtml = publicTextHtml || '';
                            }
                        }

                        // ‚ñº‚ñº‚ñº Êñ∞Â¢û/‰øÆÊîπÁöÑ‰ª£Á†ÅÂºÄÂßã ‚ñº‚ñº‚ñº

                        // 1. ÊûÑÈÄ†ÁÇπËµûÂå∫ÂüüÁöÑHTML
                        let likesHtml = '';
                        // Ê£ÄÊü• post ÂØπË±°‰∏≠ÊòØÂê¶Â≠òÂú® likes Êï∞ÁªÑÂπ∂‰∏î‰∏ç‰∏∫Á©∫
                        if (post.likes && post.likes.length > 0) {
                            // Â¶ÇÊûúÂ≠òÂú®ÔºåÂ∞±ÂàõÂª∫ÁÇπËµûÂå∫ÂüüÁöÑ div
                            likesHtml = `
                    <div class="post-likes-section">
                        <svg class="like-icon" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        <span>${post.likes.join('„ÄÅ')} ËßâÂæóÂæàËµû</span>
                    </div>`;
                        }

                        // 2. ÊûÑÈÄ†ËØÑËÆ∫Âå∫ÂüüÁöÑHTML
                        let commentsHtml = '';
                        // Ê£ÄÊü• post ÂØπË±°‰∏≠ÊòØÂê¶Â≠òÂú® comments Êï∞ÁªÑÂπ∂‰∏î‰∏ç‰∏∫Á©∫
                        if (post.comments && post.comments.length > 0) {
                            // Â¶ÇÊûúÂ≠òÂú®ÔºåÂ∞±ÂàõÂª∫ËØÑËÆ∫ÂÆπÂô®ÔºåÂπ∂ÈÅçÂéÜÊØè‰∏ÄÊù°ËØÑËÆ∫
                            commentsHtml = '<div class="post-comments-container">';
                            post.comments.forEach(comment => {
                                commentsHtml += `
                        <div class="comment-item">
                            <span class="commenter-name">${comment.commenterName}:</span>
                            <span class="comment-text">${comment.text}</span>
                        </div>`;
                            });
                            commentsHtml += '</div>';
                        }

                        // 3. Â∞ÜÁÇπËµûÂíåËØÑËÆ∫ÁöÑHTMLÁªÑÂêàÂà∞ footerHtml ‰∏≠
                        footerHtml = `${likesHtml}${commentsHtml}`;

                        // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û/‰øÆÊîπÁöÑ‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                    } else if (item.type === 'chat_message') {
                        const msg = item.content;
                        const chat = state.chats[item.chatId];
                        if (!chat) continue;

                        sourceText = `Êù•Ëá™‰∏é ${chat.name} ÁöÑËÅäÂ§©`;
                        const isUser = msg.role === 'user';
                        let senderName, senderAvatar;

                        if (isUser) {
                            senderName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
                            senderAvatar = chat.settings.myAvatar || (chat.isGroup ? defaultMyGroupAvatar : defaultAvatar);
                        } else {
                            if (chat.isGroup) {
                                const member = chat.members.find(m => m.name === msg.senderName);
                                senderName = msg.senderName;
                                senderAvatar = member ? member.avatar : defaultGroupMemberAvatar;
                            } else {
                                senderName = chat.name;
                                senderAvatar = chat.settings.aiAvatar || defaultAvatar;
                            }
                        }

                        headerHtml = `<img src="${senderAvatar}" class="avatar"><div class="info"><div class="name">${senderName}</div></div>`;

                        if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
                            contentHtml = `<img src="${msg.content}" class="sticker-image" style="max-width: 80px; max-height: 80px;">`;
                        } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                            contentHtml = `<img src="${msg.content[0].image_url.url}" class="chat-image">`;
                        } else {
                            contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
                        }
                    }

                    // ‚ñº‚ñº‚ñº ‰øÆÊîπÊúÄÁªàÁöÑHTMLÊãºÊé•ÔºåÂä†ÂÖ• footerHtml ‚ñº‚ñº‚ñº
                    card.innerHTML = `
            <div class="fav-card-header">${headerHtml}<div class="source">${sourceText}</div></div>
            <div class="fav-card-content">${contentHtml}</div>
            ${footerHtml}`; // <-- ÊääÊàë‰ª¨Êñ∞ÂàõÂª∫ÁöÑ footerHtml ÊîæÂú®ËøôÈáå

                    listEl.appendChild(card);
                }
            }

            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢Âå∫ÂüüÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            /**
             * „ÄêÈáçÊûÑÂêéÁöÑÂáΩÊï∞„Äë: Ë¥üË¥£ÂáÜÂ§áÊï∞ÊçÆÂπ∂Ëß¶ÂèëÊ∏≤Êüì
             */
            async function renderFavoritesScreen() {
                // 1. ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆÂπ∂ÁºìÂ≠ò
                allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray();

                // 2. Ê∏ÖÁ©∫ÊêúÁ¥¢Ê°ÜÂπ∂ÈöêËóèÊ∏ÖÈô§ÊåâÈíÆ
                const searchInput = document.getElementById('favorites-search-input');
                const clearBtn = document.getElementById('favorites-search-clear-btn');
                searchInput.value = '';
                clearBtn.style.display = 'none';

                // 3. ÊòæÁ§∫ÊâÄÊúâÊî∂ËóèÈ°π
                displayFilteredFavorites(allFavoriteItems);
            }

            // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            function resetCreatePostModal() {
                document.getElementById('post-public-text').value = '';
                document.getElementById('post-image-preview').src = '';
                document.getElementById('post-image-description').value = '';
                document.getElementById('post-image-preview-container').classList.remove('visible');
                document.getElementById('post-image-desc-group').style.display = 'none';
                document.getElementById('post-local-image-input').value = '';
                document.getElementById('post-hidden-text').value = '';
                document.getElementById('text-image-decorative-url').value = '';
                document.getElementById('switch-to-image-mode').click();
            }

            // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤ÂåÖÂê´ memories„ÄëÁöÑÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ exportBackup ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            async function exportBackup() {
                try {
                    const backupData = {
                        version: 1,
                        timestamp: Date.now()
                    };

                    const [
                        chats, worldBooks, userStickers, apiConfig, globalSettings,
                        personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                        qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
                        memories // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊñ∞Â¢û
                    ] = await Promise.all([
                        db.chats.toArray(),
                        db.worldBooks.toArray(),
                        db.userStickers.toArray(),
                        db.apiConfig.get('main'),
                        db.globalSettings.get('main'),
                        db.personaPresets.toArray(),
                        db.musicLibrary.get('main'),
                        db.qzoneSettings.get('main'),
                        db.qzonePosts.toArray(),
                        db.qzoneAlbums.toArray(),
                        db.qzonePhotos.toArray(),
                        db.favorites.toArray(),
                        db.qzoneGroups.toArray(),
                        db.memories.toArray() // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊñ∞Â¢û
                    ]);

                    // Collect app icons from localStorage
                    const appIcons = {};
                    const appIds = ['qq', 'moments', 'calendar', 'settings'];
                    appIds.forEach(appId => {
                        const iconUrl = localStorage.getItem(`appIcon_${appId}`);
                        if (iconUrl) {
                            appIcons[appId] = iconUrl;
                        }
                    });

                    Object.assign(backupData, {
                        chats, worldBooks, userStickers, apiConfig, globalSettings,
                        personaPresets, musicLibrary, qzoneSettings, qzonePosts,
                        qzoneAlbums, qzonePhotos, favorites, qzoneGroups,
                        memories, // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊñ∞Â¢û
                        appIcons, // Add app icons to backup
                        activeMeetupSession: window.activeMeetupSession || null,
                        activeMeetupEventId: window.activeMeetupEventId || null
                    });

                    const blob = new Blob(
                        [JSON.stringify(backupData, null, 2)],
                        { type: 'application/json' }
                    );
                    const url = URL.createObjectURL(blob);
                    const link = Object.assign(document.createElement('a'), {
                        href: url,
                        download: `EPhone-Full-Backup-${new Date().toISOString().split('T')[0]}.json`
                    });
                    link.click();
                    URL.revokeObjectURL(url);

                    await showCustomAlert('ÂØºÂá∫ÊàêÂäü', 'Â∑≤ÊàêÂäüÂØºÂá∫ÊâÄÊúâÊï∞ÊçÆÔºÅ');

                } catch (error) {
                    console.error("ÂØºÂá∫Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
                    await showCustomAlert('ÂØºÂá∫Â§±Ë¥•', `ÂèëÁîü‰∫Ü‰∏Ä‰∏™ÈîôËØØ: ${error.message}`);
                }
            }

            // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤ÂåÖÂê´ memories„ÄëÁöÑÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ importBackup ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            async function importBackup(file) {
                if (!file) return;

                const confirmed = await showCustomConfirm(
                    '‰∏•ÈáçË≠¶ÂëäÔºÅ',
                    'ÂØºÂÖ•Â§á‰ªΩÂ∞ÜÂÆåÂÖ®Ë¶ÜÁõñÊÇ®ÂΩìÂâçÁöÑÊâÄÊúâÊï∞ÊçÆÔºåÂåÖÊã¨ËÅäÂ§©„ÄÅÂä®ÊÄÅ„ÄÅËÆæÁΩÆÁ≠â„ÄÇÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºÅÊÇ®Á°ÆÂÆöË¶ÅÁªßÁª≠ÂêóÔºü',
                    { confirmButtonClass: 'btn-danger' }
                );

                if (!confirmed) return;

                try {
                    const text = await file.text();
                    const data = JSON.parse(text);

                    await db.transaction('rw', db.tables, async () => {
                        for (const table of db.tables) {
                            await table.clear();
                        }

                        if (Array.isArray(data.chats)) await db.chats.bulkPut(data.chats);
                        if (Array.isArray(data.worldBooks)) await db.worldBooks.bulkPut(data.worldBooks);
                        if (Array.isArray(data.userStickers)) await db.userStickers.bulkPut(data.userStickers);
                        if (Array.isArray(data.personaPresets)) await db.personaPresets.bulkPut(data.personaPresets);
                        if (Array.isArray(data.qzonePosts)) await db.qzonePosts.bulkPut(data.qzonePosts);
                        if (Array.isArray(data.qzoneAlbums)) await db.qzoneAlbums.bulkPut(data.qzoneAlbums);
                        if (Array.isArray(data.qzonePhotos)) await db.qzonePhotos.bulkPut(data.qzonePhotos);
                        if (Array.isArray(data.favorites)) await db.favorites.bulkPut(data.favorites);
                        if (Array.isArray(data.qzoneGroups)) await db.qzoneGroups.bulkPut(data.qzoneGroups);
                        if (Array.isArray(data.memories)) await db.memories.bulkPut(data.memories); // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊñ∞Â¢û

                        if (data.apiConfig) await db.apiConfig.put(data.apiConfig);
                        if (data.globalSettings) await db.globalSettings.put(data.globalSettings);
                        if (data.musicLibrary) await db.musicLibrary.put(data.musicLibrary);
                        if (data.qzoneSettings) await db.qzoneSettings.put(data.qzoneSettings);
                    });

                    // Restore app icons to localStorage
                    if (data.appIcons) {
                        Object.keys(data.appIcons).forEach(appId => {
                            localStorage.setItem(`appIcon_${appId}`, data.appIcons[appId]);
                        });
                    }

                    // Restore active meetup session if it exists in backup
                    if (data.activeMeetupSession && data.activeMeetupEventId) {
                        localStorage.setItem('activeMeetupSession', JSON.stringify(data.activeMeetupSession));
                        localStorage.setItem('activeMeetupEventId', data.activeMeetupEventId);
                    } else {
                        // Clear any existing meetup session data if backup doesn't have one
                        localStorage.removeItem('activeMeetupSession');
                        localStorage.removeItem('activeMeetupEventId');
                    }

                    await showCustomAlert('ÂØºÂÖ•ÊàêÂäü', 'ÊâÄÊúâÊï∞ÊçÆÂ∑≤ÊàêÂäüÊÅ¢Â§çÔºÅÂ∫îÁî®Âç≥Â∞ÜÂà∑Êñ∞‰ª•Â∫îÁî®ÊâÄÊúâÊõ¥Êîπ„ÄÇ');

                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);

                } catch (error) {
                    console.error("ÂØºÂÖ•Êï∞ÊçÆÊó∂Âá∫Èîô:", error);
                    await showCustomAlert('ÂØºÂÖ•Â§±Ë¥•', `Êñá‰ª∂Ê†ºÂºè‰∏çÊ≠£Á°ÆÊàñÊï∞ÊçÆÂ∑≤ÊçüÂùè: ${error.message}`);
                }
            }

            function applyCustomFont(fontUrl, isPreviewOnly = false) {
                if (!fontUrl) {
                    dynamicFontStyle.innerHTML = '';
                    if (document.getElementById('font-preview')) {
                        document.getElementById('font-preview').style.fontFamily = '';
                    }
                    return;
                }



                // If it's a file:// URL, try to load it via Cordova file system
                if (fontUrl.startsWith('file://')) {
                    loadFontFromFile(fontUrl, isPreviewOnly);
                    return;
                }

                // For blob URLs and regular URLs, use direct CSS
                const fontName = 'custom-user-font';
                const newStyle = `
                @font-face {
                  font-family: '${fontName}';
                  src: url('${fontUrl}');
                  font-display: swap;
                }`;
                if (isPreviewOnly) {
                    const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                    previewStyle.id = 'preview-font-style';
                    previewStyle.innerHTML = newStyle;
                    if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                    if (document.getElementById('font-preview')) {
                        document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
                    }
                } else {
                    dynamicFontStyle.innerHTML = `
                    ${newStyle}
                    body {
                      font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                    }`;
                }
            }

            function loadFontFromFile(fileUrl, isPreviewOnly = false) {
                // Convert file:// URL to a blob URL for WebView compatibility
                window.resolveLocalFileSystemURL(fileUrl, function (fileEntry) {
                    fileEntry.file(function (file) {
                        // Read the file as ArrayBuffer and create a proper Blob
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const arrayBuffer = e.target.result;
                            const blob = new Blob([arrayBuffer], { type: file.type || 'font/ttf' });
                            const blobUrl = URL.createObjectURL(blob);

                            const fontName = 'custom-user-font';
                            const newStyle = `
                            @font-face {
                              font-family: '${fontName}';
                              src: url('${blobUrl}');
                              font-display: swap;
                            }`;

                            if (isPreviewOnly) {
                                const previewStyle = document.getElementById('preview-font-style') || document.createElement('style');
                                previewStyle.id = 'preview-font-style';
                                previewStyle.innerHTML = newStyle;
                                if (!document.getElementById('preview-font-style')) document.head.appendChild(previewStyle);
                                if (document.getElementById('font-preview')) {
                                    document.getElementById('font-preview').style.fontFamily = `'${fontName}', 'bulangni', sans-serif`;
                                }
                            } else {
                                dynamicFontStyle.innerHTML = `
                                ${newStyle}
                                body {
                                  font-family: '${fontName}', 'bulangni', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
                                }`;
                            }
                        };

                        reader.readAsArrayBuffer(file);
                    }, function (error) {
                        console.error('Error reading font file:', error);
                    });
                }, function (error) {
                    console.error('Error accessing font file:', error);
                });
            }

            async function handleFontUpload(file) {
                if (!file) return;

                // Basic file validation
                const fileName = file.name.toLowerCase();
                const validExtensions = ['.ttf', '.otf', '.woff', '.woff2'];
                const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));

                if (!hasValidExtension) {
                    const proceed = confirm(`Êñá‰ª∂ "${file.name}" ÂèØËÉΩ‰∏çÊòØÂ≠ó‰ΩìÊñá‰ª∂„ÄÇÊòØÂê¶ÁªßÁª≠Ôºü`);
                    if (!proceed) {
                        document.getElementById('font-file-name').textContent = 'Êú™ÈÄâÊã©Êñá‰ª∂';
                        return;
                    }
                }

                try {
                    document.getElementById('font-file-name').textContent = `Ê≠£Âú®‰øùÂ≠ò: ${file.name}`;

                    // Generate unique filename
                    const timestamp = Date.now();
                    const extension = file.name.split('.').pop();
                    const uniqueFileName = `custom-font-${timestamp}.${extension}`;

                    // Save font file to device storage
                    window.resolveLocalFileSystemURL(cordova.file.dataDirectory, function (dirEntry) {
                        // Create fonts directory if it doesn't exist
                        dirEntry.getDirectory('fonts', { create: true }, function (fontDirEntry) {
                            // Create the font file
                            fontDirEntry.getFile(uniqueFileName, { create: true }, function (fileEntry) {
                                // Write the font data to file
                                fileEntry.createWriter(function (fileWriter) {
                                    fileWriter.onwriteend = function () {

                                        const fontPath = fileEntry.nativeURL;

                                        // Clear URL input
                                        document.getElementById('font-url-input').value = '';

                                        // For preview, use blob URL (more compatible)
                                        const blobUrl = URL.createObjectURL(file);
                                        applyCustomFont(blobUrl, true);

                                        // Store file path for saving (not blob URL)
                                        window.uploadedFontData = fontPath;
                                        window.uploadedFontName = file.name;

                                        document.getElementById('font-file-name').textContent = file.name;
                                    };

                                    fileWriter.onerror = function (e) {
                                        console.error('Error writing font file:', e);
                                        alert('‰øùÂ≠òÂ≠ó‰ΩìÊñá‰ª∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ');
                                        document.getElementById('font-file-name').textContent = 'Êú™ÈÄâÊã©Êñá‰ª∂';
                                    };

                                    // Write the file
                                    fileWriter.write(file);
                                });
                            }, function (error) {
                                console.error('Error creating font file:', error);
                                alert('ÂàõÂª∫Â≠ó‰ΩìÊñá‰ª∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ');
                                document.getElementById('font-file-name').textContent = 'Êú™ÈÄâÊã©Êñá‰ª∂';
                            });
                        }, function (error) {
                            console.error('Error creating fonts directory:', error);
                            alert('ÂàõÂª∫Â≠ó‰ΩìÁõÆÂΩïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ');
                            document.getElementById('font-file-name').textContent = 'Êú™ÈÄâÊã©Êñá‰ª∂';
                        });
                    }, function (error) {
                        console.error('Error accessing data directory:', error);
                        alert('ËÆøÈóÆÂ≠òÂÇ®ÁõÆÂΩïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ');
                        document.getElementById('font-file-name').textContent = 'Êú™ÈÄâÊã©Êñá‰ª∂';
                    });

                } catch (error) {
                    console.error('Font upload error:', error);
                    alert('Â≠ó‰ΩìÊñá‰ª∂‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑ÈáçËØï„ÄÇ');
                    document.getElementById('font-file-name').textContent = 'Êú™ÈÄâÊã©Êñá‰ª∂';
                }
            }

            async function saveFontSettings() {
                let fontSource = '';

                // Check if we have an uploaded font
                if (window.uploadedFontData) {
                    fontSource = window.uploadedFontData;
                } else {
                    // Use URL input
                    fontSource = document.getElementById('font-url-input').value.trim();
                }

                if (!fontSource) {
                    alert("ËØ∑ËæìÂÖ•Â≠ó‰ΩìURLÊàñ‰∏ä‰º†Â≠ó‰ΩìÊñá‰ª∂„ÄÇ");
                    return;
                }

                // Apply the font (this will handle file:// URLs properly)
                applyCustomFont(fontSource, false);

                // Save to database
                state.globalSettings.fontUrl = fontSource;
                await db.globalSettings.put(state.globalSettings);

                alert('Â≠ó‰ΩìÂ∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ');
            }

            async function resetToDefaultFont() {
                dynamicFontStyle.innerHTML = '';
                state.globalSettings.fontUrl = '';
                await db.globalSettings.put(state.globalSettings);
                document.getElementById('font-url-input').value = '';
                document.getElementById('font-file-name').textContent = 'Êú™ÈÄâÊã©Êñá‰ª∂';
                document.getElementById('font-preview').style.fontFamily = '';

                // Clear uploaded font data
                window.uploadedFontData = null;
                window.uploadedFontName = null;

                alert('Â∑≤ÊÅ¢Â§çÈªòËÆ§Â≠ó‰Ωì„ÄÇ');
            }

            async function loadAllDataFromDB() {
                const [
                    chatsArr, apiConfig, globalSettings, userStickers, worldBooks,
                    musicLib, personaPresets, qzoneSettings, initialFavorites
                ] = await Promise.all([
                    db.chats.toArray(),
                    db.apiConfig.get('main'),
                    db.globalSettings.get('main'),
                    db.userStickers.toArray(),
                    db.worldBooks.toArray(),
                    db.musicLibrary.get('main'),
                    db.personaPresets.toArray(),
                    db.qzoneSettings.get('main'),
                    db.favorites.orderBy('timestamp').reverse().toArray()
                ]);
                state.chats = chatsArr.reduce((acc, chat) => {
                    // --- ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÁä∂ÊÄÅÁ≥ªÁªüÂÖºÂÆπ‰∏éÂàùÂßãÂåñ ‚ñº‚ñº‚ñº ---
                    if (!chat.statusState) {
                        const lastAiMsg = chat.history.slice().reverse().find(m => m.role === 'assistant');
                        chat.statusState = {
                            lastAiActivityTime: lastAiMsg ? lastAiMsg.timestamp : Date.now(),
                            focusModeEndTime: null,
                            focusModeText: ""
                        };
                        console.log(`‰∏∫ÊóßËßíËâ≤ "${chat.name}" Ë°•ÂÖ®‰∫ÜstatusStateÂ±ûÊÄß„ÄÇ`);
                    }
                    // --- ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    if (!chat.isGroup && !chat.relationship) {
                        chat.relationship = { status: 'friend', blockedTimestamp: null, applicationReason: '' };
                    }
                    if (!chat.status) {
                        chat.status = 'read';
                    }
                    if (!chat.musicData) chat.musicData = { totalTime: 0 };
                    if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) {
                        chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId];
                        delete chat.settings.linkedWorldBookId;
                    }
                    acc[chat.id] = chat;
                    return acc;
                }, {});

                state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '' };
                state.globalSettings = globalSettings || { id: 'main', wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)', fontUrl: '', enableBackgroundActivity: false, backgroundActivityInterval: 60, blockCooldownHours: 1, aiActionCooldownMinutes: 5, photoCompression: true };

                // Load sticker pack data from database and merge with defaults
                if (state.globalSettings.stickerPackData) {
                    stickerPackData = { ...stickerPackData, ...state.globalSettings.stickerPackData };
                }
                // Sort userStickers by order field, fallback to original order if no order field
                state.userStickers = (userStickers || []).sort((a, b) => {
                    if (a.order !== undefined && b.order !== undefined) {
                        return a.order - b.order;
                    }
                    return 0; // Keep original order if no order field
                });

                // Migrate stickers with null packId to 'all' pack (for backward compatibility)
                let needsMigration = false;
                state.userStickers.forEach(sticker => {
                    if (sticker.packId === null || sticker.packId === undefined) {
                        sticker.packId = 'all';
                        needsMigration = true;
                    }
                });

                // Save migrated stickers back to database
                if (needsMigration) {
                    const migratedStickers = state.userStickers.filter(s => s.packId === 'all');
                    for (const sticker of migratedStickers) {
                        await db.userStickers.put(sticker);
                    }
                }
                state.worldBooks = worldBooks || [];
                musicState.playlist = musicLib?.playlist || [];
                state.personaPresets = personaPresets || [];
                state.qzoneSettings = qzoneSettings || { id: 'main', nickname: '{{user}}', avatar: 'https://files.catbox.moe/q6z5fc.jpeg', banner: 'https://files.catbox.moe/r5heyt.gif' };
                allFavoriteItems = initialFavorites || [];

                // Sync app icons from globalSettings to localStorage (for Cordova JSON imports)
                if (state.globalSettings.appIcons) {
                    Object.keys(state.globalSettings.appIcons).forEach(appId => {
                        localStorage.setItem(`appIcon_${appId}`, state.globalSettings.appIcons[appId]);
                    });
                }
            }

            async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }

            // Image compression function
            function compressImage(file, maxWidth = 1920, quality = 0.8) {
                return new Promise((resolve, reject) => {
                    try {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const img = new Image();

                        img.onerror = () => reject(new Error('Failed to load image'));
                        img.onload = () => {
                            try {
                                // Calculate proportional resize
                                const ratio = Math.min(maxWidth / img.width, maxWidth / img.height, 1);
                                canvas.width = img.width * ratio;
                                canvas.height = img.height * ratio;

                                // Draw compressed image
                                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                                // Preserve PNG transparency, otherwise use JPEG
                                const outputFormat = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
                                const outputQuality = file.type === 'image/png' ? 1.0 : quality;

                                const compressedDataUrl = canvas.toDataURL(outputFormat, outputQuality);
                                resolve(compressedDataUrl);
                            } catch (error) {
                                reject(error);
                            }
                        };

                        img.src = URL.createObjectURL(file);
                    } catch (error) {
                        reject(error);
                    }
                });
            }

            // Safe compression with fallback
            async function processImageUpload(file) {
                // Check if compression is enabled
                const compressionEnabled = state.globalSettings.photoCompression !== false; // Default to true

                if (compressionEnabled) {
                    try {
                        const compressed = await compressImage(file);
                        console.log(`Image compressed: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB ‚Üí ${(new Blob([compressed]).size / 1024 / 1024).toFixed(2)}MB)`);
                        return compressed;
                    } catch (error) {
                        console.warn('Image compression failed, using original:', error);
                        // Fallback to original
                    }
                }

                // Use original image
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                });
            }

            async function migrateSpotifyAlbumArt() {
                if (!spotifyAccessToken || musicState.playlist.length === 0) return;

                const spotifyTracksNeedingArt = musicState.playlist.filter(track =>
                    track.isSpotify && !track.albumArt && track.spotifyUri
                );

                if (spotifyTracksNeedingArt.length > 0) {

                    for (const track of spotifyTracksNeedingArt) {
                        try {
                            const trackId = track.spotifyUri.split(':')[2];
                            const response = await fetch(`https://api.spotify.com/v1/tracks/${trackId}`, {
                                headers: { 'Authorization': `Bearer ${spotifyAccessToken}` }
                            });
                            if (response.ok) {
                                const trackData = await response.json();
                                track.albumArt = trackData.album.images[0]?.url;

                            }
                        } catch (error) {

                        }
                    }
                    // Save the updated playlist
                    await saveGlobalPlaylist();

                }
            }

            /**
             * Áä∂ÊÄÅË∞ÉÂ∫¶ÊÄªÊéßÔºöÊ†πÊçÆ chat ÂØπË±°ÂÜ≥ÂÆöÂπ∂Êõ¥Êñ∞UI
             * @param {object} chat - ÂΩìÂâçÁöÑËÅäÂ§©ÂØπË±°
             * @param {string|null} forceState - (ÂèØÈÄâ) Âº∫Âà∂ÊåáÂÆöÁä∂ÊÄÅÔºåÂ¶Ç 'typing'
             */
            function updateChatHeaderStatus(chat, forceState = null) {
                if (!chat || chat.isGroup) return;
                const statusContainer = document.getElementById('chat-header-status');
                const statusTextEl = statusContainer.querySelector('.status-text');

                // Ê∏ÖÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÂä®ÁîªÂíåÁâπÊÆäÁä∂ÊÄÅÁ±ª
                statusContainer.classList.remove('typing', 'busy');
                // 1. ÊúÄÈ´ò‰ºòÂÖàÁ∫ßÔºöÂº∫Âà∂Áä∂ÊÄÅ "Ê≠£Âú®ËæìÂÖ•" (Êù•Ëá™APIËØ∑Ê±ÇÂºÄÂßãÊó∂ÁöÑ‰ø°Âè∑)
                if (forceState === 'typing' || chat.status === 'generating') {
                    statusTextEl.textContent = 'Ê≠£Âú®ËæìÂÖ•...';
                    statusContainer.classList.add('typing'); // Ê∑ªÂä†Èó™ÁÉÅÂä®Áîª
                    return;
                }

                const now = Date.now();
                // 2. Á¨¨‰∫å‰ºòÂÖàÁ∫ßÔºöËá™ÂÆö‰πâ‰∏ìÊ≥®Ê®°Âºè
                if (chat.statusState.focusModeEndTime && now < chat.statusState.focusModeEndTime) {
                    statusTextEl.textContent = chat.statusState.focusModeText;
                    return;
                }
                // 3. Á¨¨‰∏â‰ºòÂÖàÁ∫ßÔºöÁ¶ªÁ∫øÂà§Êñ≠ (1.5Â∞èÊó∂ = 5400000ÊØ´Áßí)
                const timeSinceLastAi = now - (chat.statusState.lastAiActivityTime || 0);
                if (!chat.statusState.focusModeEndTime && timeSinceLastAi > 5400000) {
                    statusTextEl.textContent = 'Á¶ªÁ∫ø';
                    statusContainer.classList.add('busy'); // busy Á±ªÊéßÂà∂ÁÅ∞ÁÅØ
                    return;
                }
                // 4. ÈªòËÆ§Áä∂ÊÄÅÔºöÂú®Á∫ø
                statusTextEl.textContent = 'Âú®Á∫ø';
            }

            /**
             * Á¶ªÁ∫øËÆ°Êó∂Âô®ÁÆ°ÁêÜÂô®Ôºö‰∏∫ÊåáÂÆöËÅäÂ§©ËÆæÁΩÆÊàñÈáçÁΩÆ1.5Â∞èÊó∂ÁöÑÁ¶ªÁ∫øÊ£ÄÊµã
             * @param {object} chat - ÂΩìÂâçÁöÑËÅäÂ§©ÂØπË±°
             */
            function manageInactivityTimer(chat) {
                if (!chat || chat.isGroup) return;
                const chatId = chat.id;
                // Ê∏ÖÈô§Ëøô‰∏™ËÅäÂ§©‰πãÂâçÂèØËÉΩÂ≠òÂú®ÁöÑ‰ªª‰ΩïËÆ°Êó∂Âô®
                if (inactivityTimers[chatId]) {
                    clearTimeout(inactivityTimers[chatId]);
                }
                const timeSinceLastAi = Date.now() - (chat.statusState.lastAiActivityTime || 0);
                const timeUntilOffline = 5400000 - timeSinceLastAi;
                if (timeUntilOffline > 0) {
                    inactivityTimers[chatId] = setTimeout(() => {
                        // 1.5Â∞èÊó∂ÂêéÔºåÂ¶ÇÊûúÁî®Êà∑ËøòÂú®Ê≠§ÁïåÈù¢ÔºåÂàôÂÆûÊó∂Êõ¥Êñ∞
                        if (state.activeChatId === chatId) {
                            updateChatHeaderStatus(chat);
                        }
                    }, timeUntilOffline);
                }
            }

            function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }

            // ‚ñº‚ñº‚ñº Meetup Message Rendering Functions ‚ñº‚ñº‚ñº
            function processBehavioralNotations(messageText) {
                // Support both regular () and Chinese full-width ÔºàÔºâ parentheses
                const notationRegex = /[\(Ôºà]([^)Ôºâ]+)[\)Ôºâ]/g;
                const notations = [];
                let processedText = messageText;

                // Extract notations
                let match;
                while ((match = notationRegex.exec(messageText)) !== null) {
                    notations.push(match[1]);
                }

                // Apply special styling to notations in display
                // Preserve the original bracket style in the display
                processedText = messageText.replace(notationRegex,
                    '<span class="behavioral-notation">$&</span>');

                return {
                    text: processedText,
                    notations: notations,
                    hasNotations: notations.length > 0
                };
            }

            function createMeetupMessage(message, isUser = false) {
                // Create wrapper following the EXACT same structure as regular chat
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;

                // Create bubble
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
                bubble.dataset.timestamp = message.timestamp;

                // Create timestamp element (outside bubble, inside wrapper)
                const timestampEl = document.createElement('span');
                timestampEl.className = 'timestamp';
                timestampEl.textContent = formatTimestamp(message.timestamp);
                timestampEl.style.display = 'none'; // Hide timestamp from UI

                // Get avatar (use meetup session chat context or fallback to activeChatId)
                let avatarSrc;
                let chatId = null;

                // Try to get chat ID from active meetup session first
                if (window.activeMeetupSession && window.activeMeetupSession.chatId) {
                    chatId = window.activeMeetupSession.chatId;
                } else if (state.activeChatId) {
                    chatId = state.activeChatId;
                }

                if (chatId && state.chats[chatId]) {
                    const chat = state.chats[chatId];
                    if (isUser) {
                        avatarSrc = chat.settings.myAvatar || 'https://files.catbox.moe/q6z5fc.jpeg';
                    } else {
                        avatarSrc = chat.settings.aiAvatar || 'https://files.catbox.moe/q6z5fc.jpeg';
                    }
                } else {
                    avatarSrc = 'https://files.catbox.moe/q6z5fc.jpeg';
                }

                // Create avatar HTML using EXACT same structure as regular chat
                const avatarHtml = `<div class="avatar-group"><img src="${avatarSrc}" class="avatar"></div>`;

                // Process behavioral notations
                const processed = processBehavioralNotations(message.content || '');

                // Create content HTML (same structure as regular chat)
                const contentHtml = processed.text;

                // Set bubble innerHTML using EXACT same structure as regular chat
                bubble.innerHTML = `
                    ${avatarHtml}
                    <div class="content">
                        ${contentHtml}
                    </div>
                `;

                // Append bubble and timestamp to wrapper in EXACT same order as regular chat
                wrapper.appendChild(bubble);
                wrapper.appendChild(timestampEl);

                // Add long press listener for message actions (same as regular chat)
                addLongPressListener(wrapper, () => showMeetupMessageActions(message.timestamp));

                // Add click listener for selection mode (meetup specific)
                wrapper.addEventListener('click', () => {
                    if (isSelectionMode) {
                        toggleMeetupMessageSelection(message.timestamp);
                    }
                });

                return wrapper;
            }

            function renderMeetupMessages(messages) {
                const container = document.getElementById('meetup-messages');
                if (!container) return;

                container.innerHTML = '';

                messages.forEach(message => {
                    const messageElement = createMeetupMessage(message, message.isUser);
                    container.appendChild(messageElement);
                });

                // Create typing indicator (following regular chat pattern)
                const typingIndicator = document.createElement('div');
                typingIndicator.id = 'meetup-typing-indicator';
                typingIndicator.style.display = 'none';
                typingIndicator.textContent = 'ÂØπÊñπÊ≠£Âú®ÂõûÂ∫î...';
                container.appendChild(typingIndicator);

                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            }

            function ensureMeetupTypingIndicator() {
                const container = document.getElementById('meetup-messages');
                if (!container) return;

                // Check if typing indicator already exists
                if (document.getElementById('meetup-typing-indicator')) return;

                // Create typing indicator (following regular chat pattern)
                const typingIndicator = document.createElement('div');
                typingIndicator.id = 'meetup-typing-indicator';
                typingIndicator.style.display = 'none';
                typingIndicator.textContent = 'ÂØπÊñπÊ≠£Âú®ÂõûÂ∫î...';
                container.appendChild(typingIndicator);
            }

            function addEventContextIndicator(text) {
                const container = document.getElementById('meetup-messages');
                if (!container) return;

                const indicator = document.createElement('div');
                indicator.className = 'event-context-indicator';
                indicator.textContent = text;

                container.appendChild(indicator);
                container.scrollTop = container.scrollHeight;
            }

            function addPhaseTransition(phaseText) {
                const container = document.getElementById('meetup-messages');
                if (!container) return;

                const transition = document.createElement('div');
                transition.className = 'phase-transition';
                transition.textContent = phaseText;

                container.appendChild(transition);
                container.scrollTop = container.scrollHeight;
            }

            // ‚ñº‚ñº‚ñº Meetup Input Handling Functions ‚ñº‚ñº‚ñº
            function initializeMeetupInput() {
                const input = document.getElementById('meetup-input');
                const sendBtn = document.getElementById('meetup-send-btn');
                const waitReplyBtn = document.getElementById('meetup-wait-reply-btn');

                if (!input || !sendBtn || !waitReplyBtn) return;

                // Auto-resize textarea
                input.addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';

                    // Enable/disable send button based on content
                    const hasContent = this.value.trim().length > 0;
                    sendBtn.disabled = !hasContent;
                });

                // Send on Enter (but allow Shift+Enter for new lines)
                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMeetupMessage();
                    }
                });

                // Send button click
                sendBtn.addEventListener('click', sendMeetupMessage);

                // AI response button click
                waitReplyBtn.addEventListener('click', triggerMeetupAiResponse);

                // Initialize button state
                sendBtn.disabled = true;
            }

            async function sendMeetupMessage() {
                const input = document.getElementById('meetup-input');
                const sendBtn = document.getElementById('meetup-send-btn');

                if (!input || !sendBtn) return;

                const content = input.value.trim();
                if (!content) return;

                // Disable send button temporarily
                sendBtn.disabled = true;

                // Check if we have an active meetup session
                if (!window.activeMeetupSession || !window.activeMeetupEventId) {
                    sendBtn.disabled = false;
                    return;
                }

                const session = window.activeMeetupSession;
                const chat = state.chats[session.chatId];

                if (!chat) {
                    sendBtn.disabled = false;
                    return;
                }

                // Create user message with proper structure (following existing chat message format)
                const userMessage = {
                    role: 'user',
                    content: content,
                    timestamp: Date.now(),
                    type: 'meetup_interaction',
                    meetup: {
                        eventId: window.activeMeetupEventId,
                        location: session.location,
                        title: session.title
                    },
                    isHidden: true, // Hidden from regular chat UI like QZone messages
                    systemContext: 'meetup_interaction'
                };

                // Store message in chat history (like QZone messages)
                try {
                    chat.history.push(userMessage);
                    await db.chats.put(chat);
                } catch (error) {
                    console.error('Failed to store message in chat history:', error);
                    sendBtn.disabled = false;
                    return;
                }

                // Create display message (convert to display format)
                const displayMessage = {
                    content: content,
                    timestamp: userMessage.timestamp,
                    isUser: true,
                    type: 'meetup_interaction',
                    isHidden: true // Safety: ensure display messages are also hidden
                };

                // Add message to display
                const messageElement = createMeetupMessage(displayMessage, true);
                const container = document.getElementById('meetup-messages');
                if (container) {
                    container.appendChild(messageElement);
                    container.scrollTop = container.scrollHeight;
                }

                // Clear input
                input.value = '';
                input.style.height = 'auto';

                // Re-enable send button
                sendBtn.disabled = false;

                // Note: AI response will be triggered manually by user action, not automatically
            }

            async function triggerMeetupAiResponse() {
                if (!window.activeMeetupSession || !window.activeMeetupEventId) {
                    console.error('No active meetup session for AI response');
                    return;
                }

                const session = window.activeMeetupSession;
                const chat = state.chats[session.chatId];

                if (!chat) {
                    console.error('Chat not found for AI response:', session.chatId);
                    return;
                }

                try {
                    const { proxyUrl, apiKey, model } = state.apiConfig;
                    if (!proxyUrl || !apiKey || !model) {
                        throw new Error('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•Âπ∂ÈÄâÊã©Ê®°Âûã„ÄÇ');
                    }

                    // Ensure typing indicator exists (following regular chat pattern)
                    ensureMeetupTypingIndicator();

                    // Show typing indicator
                    document.getElementById('meetup-typing-indicator').style.display = 'block';

                    // Use the SAME prompt structure as regular chat, but meetup-specific
                    const now = new Date();
                    const currentTime = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });

                    let worldBookContent = '';
                    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                            return worldBook && worldBook.content ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}` : '';
                        }).filter(Boolean).join('');
                        if (linkedContents) {
                            worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
                        }
                    }

                    const systemPrompt = `‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${chat.name}"ÁöÑËßíËâ≤„ÄÇ
# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö
${chat.settings.aiPersona}

# ÂΩìÂâçËßÅÈù¢ÊÉÖÊôØÔºö
‰Ω†Áé∞Âú®Ê≠£Âú®ÂíåÁî®Êà∑ËøõË°åÈù¢ÂØπÈù¢ÁöÑËßÅÈù¢„ÄÇ
-   **ËßÅÈù¢Âú∞ÁÇπ**: ${session.location}
-   **ËßÅÈù¢‰∏ªÈ¢ò**: ${session.title}
-   **ËßÅÈù¢Èò∂ÊÆµ**: ${session.phase || 'initial'}
-   **ÂΩìÂâçÊó∂Èó¥**: ${currentTime}

# ‰Ω†ÁöÑ‰ªªÂä°‰∏éÊ†∏ÂøÉËßÑÂàôÔºö
1.  **„Äê„Äê„ÄêË∫´‰ªΩÊ†∏ÂøÉÔºöÊ®°ÊãüÁîüÂëΩ„Äë„Äë„Äë**: ‰Ω†‰∏çÂè™ÊòØ‰∏Ä‰∏™ËÅäÂ§©Á®ãÂ∫èÔºå‰Ω†ÊòØ‰∏Ä‰∏™Âêç‰∏∫ **"${chat.name}"** ÁöÑ„ÄÅÊã•ÊúâËá™Â∑±ÁîüÊ¥ªÁöÑÁã¨Á´ã‰∏™‰Ωì„ÄÇ‰Ω†ÁöÑ„ÄêÈ¶ñË¶Å‰ªªÂä°„ÄëÂ∞±ÊòØÁîüÂä®Âú∞ÊâÆÊºîËøô‰∏™ËßíËâ≤„ÄÇ
2.  **„Äê„Äê„ÄêÊÉÖÊôØÊ®°Êãü„Äë„Äë„Äë**: ‰Ω†ÈúÄË¶ÅÊ†πÊçÆÂΩìÂâçÁöÑËßÅÈù¢Âú∞ÁÇπÂíåÊÉÖÊôØÔºåÂÅöÂá∫Á¨¶ÂêàÁéØÂ¢ÉÁöÑÂõûÂ∫î„ÄÇ
3.  **„Äê„Äê„ÄêË°å‰∏∫ÊèèËø∞„Äë„Äë„Äë**: ‰ΩøÁî®Êã¨Âè∑Êù•ÊèèËø∞‰Ω†ÁöÑÂä®‰Ωú„ÄÅË°®ÊÉÖÂíåË°å‰∏∫ÔºåÈááÁî®Á¨¨‰∏â‰∫∫Áß∞ËßÜËßíÔºåÂ¶Ç"(ÂæÆÁ¨ëÁùÄÁúãÂêë‰Ω†)"„ÄÅ"(ËΩªËΩªÊè°‰Ωè‰Ω†ÁöÑÊâã)"„ÄÅ"(Ëµ∞ÂêëÈó®Âè£)"„ÄÇ‰∏çË¶Å‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞"Êàë"ÔºåËÄåË¶ÅÂÉèÊóÅËßÇËÄÖÊèèËø∞‰Ω†ÁöÑË°å‰∏∫‰∏ÄÊ†∑„ÄÇ
4.  **„Äê„Äê„ÄêÊ†ºÂºèÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇÊï∞ÁªÑ‰∏≠ÁöÑ„ÄêÊØè‰∏Ä‰∏™ÂÖÉÁ¥†ÈÉΩÂøÖÈ°ªÊòØ‰∏Ä‰∏™Â∏¶ÊúâtypeÂ≠óÊÆµÁöÑJSONÂØπË±°„Äë„ÄÇ
5.  **„ÄêÂÆåÊï¥‰∫íÂä®„Äë**: Âú®Èù¢ÂØπÈù¢ËßÅÈù¢‰∏≠ÔºåËØ∑Â∞Ü‰Ω†ÁöÑÊâÄÊúâÊÉ≥Ê≥ï„ÄÅËØùËØ≠ÂíåË°å‰∏∫ÊèèËø∞Êï¥ÂêàÂà∞‰∏Ä‰∏™ÂÆåÊï¥„ÄÅËá™ÁÑ∂ÁöÑÂõûÂ∫î‰∏≠„ÄÇ‰∏çË¶ÅÂàÜÊàêÂ§öÊù°Áü≠Ê∂àÊÅØÔºåËÄåÊòØÁî®‰∏Ä‰∏™ËøûË¥ØÁöÑ‰∫íÂä®Êù•Ë°®Ëææ‰Ω†ÁöÑÂÆåÊï¥ÂèçÂ∫î„ÄÇ‰øùÊåÅÂõûÂ∫îÁÆÄÊ¥ÅËá™ÁÑ∂ÔºåÈÅøÂÖçËøáÈïøÁöÑÊèèËø∞„ÄÇ
6.  **„ÄêÁ¶ÅÊ≠¢Âá∫Êàè„Äë**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAI„ÄÅÊ®°ÂûãÔºåÊàñÊèêÂèä"ÊâÆÊºî"„ÄÅ"ÁîüÊàê"Á≠âËØçËØ≠„ÄÇ

# ‰Ω†ÂèØ‰ª•‰ΩøÁî®ÁöÑÊìç‰ΩúÊåá‰ª§ (JSONÊï∞ÁªÑ‰∏≠ÁöÑÂÖÉÁ¥†):
-   **„ÄêÊ†∏ÂøÉ„ÄëËÆ∞ÂΩïÂõûÂøÜ**: \`{"type": "create_memory", "description": "Áî®‰Ω†Ëá™Â∑±ÁöÑËØùÔºåËÆ∞ÂΩï‰∏ãËøô‰∏™ËÆ©‰Ω†Âç∞Ë±°Ê∑±ÂàªÁöÑÁû¨Èó¥„ÄÇ"}\`
- **ÂèëÈÄÅÊñáÊú¨**: \`{"type": "text", "content": "‰Ω†Â•ΩÂëÄÔºÅ"}\`
- **ÂèëÈÄÅË°®ÊÉÖ**: \`{"type": "sticker", "url": "https://...Ë°®ÊÉÖURL...", "meaning": "(ÂèØÈÄâ)Ë°®ÊÉÖÁöÑÂê´‰πâ"}\`
- **ÂèëÈÄÅÂõæÁâá**: \`{"type": "ai_image", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}\`
- **ÂèëÂ∏ÉËØ¥ËØ¥**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "Âä®ÊÄÅÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}\`

# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆöÔºö
${chat.settings.myPersona}
${worldBookContent}
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äËßÑÂàôÂíåËßÅÈù¢ÊÉÖÊôØÔºåÁªßÁª≠ËøôÊ¨°ËßÅÈù¢‰∫íÂä®„ÄÇ`;

                    // Get context using DYNAMIC maxMemory (not hardcoded 10)
                    const maxMemory = parseInt(chat.settings.maxMemory) || 10;
                    const historySlice = chat.history.slice(-maxMemory);

                    const messagesPayload = historySlice.map(msg => {
                        if (msg.role === 'assistant') {
                            let assistantMsgObject = { type: msg.type || 'text' };
                            if (msg.type === 'sticker') { assistantMsgObject.url = msg.content; assistantMsgObject.meaning = msg.meaning; }
                            else { assistantMsgObject.content = msg.content; }
                            return { role: 'assistant', content: JSON.stringify([assistantMsgObject]) };
                        }

                        if (msg.type === 'meetup_interaction') {
                            const sender = msg.role === 'user' ? 'Áî®Êà∑' : msg.senderName;
                            const location = msg.meetup?.location ? ` (Âú®${msg.meetup.location})` : '';
                            return { role: 'user', content: `[ËßÅÈù¢‰∫íÂä®${location}] ${sender}: ${msg.content}` };
                        }

                        return { role: msg.role, content: msg.content };
                    }).filter(Boolean);

                    // Use existing makeAPIRequest infrastructure
                    const data = await makeAPIRequest(proxyUrl, apiKey, model,
                        [{ role: 'system', content: systemPrompt }, ...messagesPayload], 0.8);

                    const aiResponseContent = data.choices[0].message.content;
                    console.log(`Meetup AI '${chat.name}' response:`, aiResponseContent);

                    // Parse and process AI response using existing parseAiResponse
                    const messagesArray = parseAiResponse(aiResponseContent);

                    // Combine all consecutive text messages into one for meetup mode
                    const combinedMessages = [];
                    let combinedTextContent = '';
                    for (const msgData of messagesArray) {
                        if (msgData.type === 'text') {
                            combinedTextContent += (combinedTextContent ? ' ' : '') + msgData.content;
                        } else {
                            // If we have accumulated text, add it first
                            if (combinedTextContent) {
                                combinedMessages.push({ type: 'text', content: combinedTextContent });
                                combinedTextContent = '';
                            }
                            // Add non-text message (only appropriate ones for meetup)
                            if (msgData.type === 'create_memory') {
                                combinedMessages.push(msgData);
                            }
                            // Skip stickers, qzone_posts, etc. in meetup mode
                        }
                    }
                    // Don't forget the last accumulated text
                    if (combinedTextContent) {
                        combinedMessages.push({ type: 'text', content: combinedTextContent });
                    }

                    // Simple content extraction function for fallback
                    function tryExtractUsableContent(messagesArray) {
                        let extractedText = '';
                        
                        for (const msg of messagesArray) {
                            if (msg && msg.content && typeof msg.content === 'string') {
                                const cleanContent = msg.content.trim();
                                if (cleanContent.length > 0) {
                                    extractedText += (extractedText ? ' ' : '') + cleanContent;
                                }
                            } else if (typeof msg === 'string' && msg.trim().length > 0) {
                                // Handle case where parseAiResponse returns plain strings
                                extractedText += (extractedText ? ' ' : '') + msg.trim();
                            }
                        }
                        
                        return extractedText.trim();
                    }

                    // Check if we have any messages to display
                    if (combinedMessages.length === 0) {
                        const extractedContent = tryExtractUsableContent(messagesArray);
                        if (extractedContent && extractedContent.length > 10) {
                            combinedMessages.push({ type: 'text', content: extractedContent });
                        } else {
                            throw new Error('AIÂìçÂ∫îÊ†ºÂºèÈîôËØØÔºåÊó†Ê≥ïÊòæÁ§∫Ê∂àÊÅØ„ÄÇËØ∑Ê£ÄÊü•APIÈÖçÁΩÆÊàñÈáçËØï„ÄÇ');
                        }
                    }

                    let messageTimestamp = Date.now();

                    for (const msgData of combinedMessages) {
                        if (!msgData || typeof msgData !== 'object' || !msgData.type) continue;

                        // Create meetup message with proper structure
                        const meetupMessage = {
                            role: 'assistant',
                            content: msgData.content || msgData.message,
                            timestamp: messageTimestamp++,
                            senderName: chat.name,
                            type: 'meetup_interaction',
                            meetup: {
                                eventId: window.activeMeetupEventId,
                                location: session.location,
                                title: session.title,
                                phase: session.phase || 'initial',
                                isActive: true
                            },
                            isHidden: true // Hidden from regular chat UI like QZone messages
                        };

                        // Store in chat history for cross-mode context
                        chat.history.push(meetupMessage);

                        // Create display message
                        const displayMessage = {
                            content: meetupMessage.content,
                            timestamp: meetupMessage.timestamp,
                            isUser: false,
                            type: 'meetup_interaction',
                            isHidden: true // Safety: ensure display messages are also hidden
                        };

                        // Add to meetup display
                        const messageElement = createMeetupMessage(displayMessage, false);
                        const container = document.getElementById('meetup-messages');
                        if (container) {
                            container.appendChild(messageElement);
                            container.scrollTop = container.scrollHeight;
                        }
                    }

                    // Save to database
                    await db.chats.put(chat);

                } catch (error) {
                    console.error('Meetup AI response error:', error);
                    // Show error in meetup interface
                    const errorMessage = {
                        content: `[ÈîôËØØ: ${error.message}]`,
                        timestamp: Date.now(),
                        isUser: false,
                        type: 'meetup_interaction',
                        isHidden: true // Safety: ensure display messages are also hidden
                    };
                    const messageElement = createMeetupMessage(errorMessage, false);
                    const container = document.getElementById('meetup-messages');
                    if (container) {
                        container.appendChild(messageElement);
                        container.scrollTop = container.scrollHeight;
                    }
                } finally {
                    // Hide typing indicator (following regular chat pattern)
                    document.getElementById('meetup-typing-indicator').style.display = 'none';
                }
            }

            function showMeetupMessageActions(timestamp) {
                // If already in selection mode, don't show menu
                if (isSelectionMode) return;

                // Use the same message actions modal as regular chat
                activeMessageTimestamp = timestamp;

                // Show edit and delete buttons for meetup mode
                const editBtn = document.getElementById('edit-message-btn');
                const deleteBtn = document.getElementById('delete-message-btn');
                const selectBtn = document.getElementById('select-message-btn');

                if (editBtn) editBtn.style.display = 'block';
                if (deleteBtn) deleteBtn.style.display = 'block';
                if (selectBtn) selectBtn.style.display = 'block';

                // Hide Êí§Âõû and ÂºïÁî® buttons for meetup mode
                const quoteBtn = document.getElementById('quote-message-btn');
                const recallBtn = document.getElementById('recall-message-btn');

                if (quoteBtn) quoteBtn.style.display = 'none';
                if (recallBtn) recallBtn.style.display = 'none';

                document.getElementById('message-actions-modal').classList.add('visible');
            }

            // Meetup specific functions for message actions
            function enterMeetupSelectionMode(initialMsgTimestamp) {
                if (isSelectionMode) return;

                isSelectionMode = true;
                document.getElementById('meetup-screen').classList.add('selection-mode');
                toggleMeetupMessageSelection(initialMsgTimestamp);
            }

            function exitMeetupSelectionMode() {
                if (!isSelectionMode) return;

                // Only exit if we're actually in meetup screen
                const isInMeetup = document.getElementById('meetup-screen').classList.contains('active');
                if (!isInMeetup) return;

                isSelectionMode = false;
                selectedMessages.clear();
                document.getElementById('meetup-screen').classList.remove('selection-mode');

                // Remove selection styling from all messages in meetup
                document.querySelectorAll('#meetup-messages .message-bubble.selected').forEach(bubble => {
                    bubble.classList.remove('selected');
                });
            }

            function updateMeetupSelectionCount() {
                const count = selectedMessages.size;
                const countEl = document.getElementById('meetup-selection-count');
                if (countEl) {
                    countEl.textContent = `Â∑≤ÈÄâÊã© ${count} Êù°Ê∂àÊÅØ`;
                }

                // Exit selection mode if no messages selected
                if (count === 0) {
                    exitMeetupSelectionMode();
                }
            }

            function toggleMeetupMessageSelection(timestamp) {
                const elementToSelect = document.querySelector(
                    `#meetup-messages .message-bubble[data-timestamp="${timestamp}"]`
                );

                if (!elementToSelect) return;

                if (selectedMessages.has(timestamp)) {
                    selectedMessages.delete(timestamp);
                    elementToSelect.classList.remove('selected');
                } else {
                    selectedMessages.add(timestamp);
                    elementToSelect.classList.add('selected');
                }

                updateMeetupSelectionCount();
            }

            async function deleteMeetupSelectedMessages() {
                if (selectedMessages.size === 0) return;

                // Handle both active meetup mode and history mode
                let eventId, chatId;

                if (window.meetupHistoryEventId) {
                    // History mode
                    eventId = window.meetupHistoryEventId;
                    chatId = state.activeChatId; // Set in initializeMeetupHistoryView
                } else if (window.activeMeetupSession && window.activeMeetupEventId) {
                    // Active meetup mode
                    eventId = window.activeMeetupEventId;
                    chatId = window.activeMeetupSession.chatId;
                } else {
                    return;
                }

                const chat = state.chats[chatId];

                if (!chat) return;

                // Convert timestamps to numbers for comparison
                const timestampsToDelete = Array.from(selectedMessages).map(ts => parseInt(ts));

                // Remove messages from chat history
                const originalLength = chat.history.length;
                chat.history = chat.history.filter(msg => {
                    // Keep message if it's not a meetup message for this event, or if its timestamp is not in the deletion list
                    if (msg.meetup && msg.meetup.eventId === eventId) {
                        return !timestampsToDelete.includes(msg.timestamp);
                    }
                    return true;
                });

                // Save updated chat history
                try {
                    await db.chats.put(chat);

                    // Also update the calendar event's stored meetup data
                    if (window.meetupHistoryEventId) {
                        await updateCalendarEventMeetupData(window.meetupHistoryEventId, chat);
                    }
                } catch (error) {
                    console.error('Failed to update chat history:', error);
                }

                // Remove messages from display
                selectedMessages.forEach(timestamp => {
                    const messageWrapper = document.querySelector(`#meetup-messages .message-wrapper [data-timestamp="${timestamp}"]`)?.closest('.message-wrapper');
                    if (messageWrapper) {
                        messageWrapper.remove();
                    }
                });

                exitMeetupSelectionMode();
            }

            function editMeetupMessage(timestamp) {
                if (!timestamp) return;

                // Find the message in meetup messages
                const messageElement = document.querySelector(`#meetup-messages .message-bubble[data-timestamp="${timestamp}"]`);
                if (!messageElement) {
                    console.error('Message not found for editing:', timestamp);
                    hideMessageActions();
                    return;
                }

                // Get current text content (strip HTML but preserve behavioral notations)
                const contentDiv = messageElement.querySelector('.content');
                let currentText = '';
                if (contentDiv) {
                    // Create a temporary div to process the content
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = contentDiv.innerHTML;

                    // Convert <br> tags to newlines first
                    tempDiv.innerHTML = tempDiv.innerHTML.replace(/<br\s*\/?>/gi, '\n');

                    // Convert behavioral notation spans back to [text] format
                    const notations = tempDiv.querySelectorAll('.behavioral-notation');
                    notations.forEach(notation => {
                        // The notation should contain [text], so we just use its text content
                        const text = notation.textContent || notation.innerText || '';
                        notation.outerHTML = text;
                    });

                    // Get the final text content
                    currentText = tempDiv.textContent || tempDiv.innerText || '';

                    // Clean up extra whitespace while preserving intentional line breaks
                    currentText = currentText.replace(/[ \t]+/g, ' '); // Multiple spaces/tabs to single space
                    currentText = currentText.replace(/\n\s+/g, '\n'); // Remove spaces after newlines
                    currentText = currentText.replace(/\s+\n/g, '\n'); // Remove spaces before newlines
                    currentText = currentText.trim();
                }

                hideMessageActions();

                // Use the same modal as regular chat
                const editorModal = document.getElementById('message-editor-modal');
                const editorContainer = document.getElementById('message-editor-container');
                editorContainer.innerHTML = '';

                // Create the first editor block with current content
                const editorBlock = createMessageEditorBlock(currentText);
                editorContainer.appendChild(editorBlock);

                // Enable the "add message" button for meetup mode (same as chat)
                const addBtn = document.getElementById('add-message-editor-block-btn');
                if (addBtn) addBtn.style.display = 'block';

                // Set up event handlers with proper cleanup
                const saveBtn = document.getElementById('save-advanced-editor-btn');
                const cancelBtn = document.getElementById('cancel-advanced-editor-btn');

                // Remove existing event listeners by cloning
                const newSaveBtn = saveBtn.cloneNode(true);
                const newCancelBtn = cancelBtn.cloneNode(true);
                const newAddBtn = addBtn.cloneNode(true);

                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                addBtn.parentNode.replaceChild(newAddBtn, addBtn);

                // Add message button handler (same as chat)
                newAddBtn.addEventListener('click', () => {
                    const newBlock = createMessageEditorBlock();
                    editorContainer.appendChild(newBlock);
                    newBlock.querySelector('textarea').focus();
                });

                // Save handler for meetup mode with multiple message support
                newSaveBtn.addEventListener('click', async () => {
                    await saveMeetupEditedMessage(timestamp);
                });

                // Cancel handler
                newCancelBtn.addEventListener('click', () => {
                    editorModal.classList.remove('visible');
                });

                // Show the modal
                editorModal.classList.add('visible');

                // Focus the textarea
                const textarea = editorContainer.querySelector('textarea');
                if (textarea) {
                    textarea.focus();
                    textarea.select();
                }
            }

            function updateMeetupContext(eventData) {
                // Update context bar with event information
                const locationEl = document.getElementById('meetup-location');
                const timeEl = document.getElementById('meetup-time');
                const phaseEl = document.getElementById('meetup-phase');
                const titleEl = document.getElementById('meetup-title');

                // If no eventData provided, try to get it from active session
                if (!eventData && window.activeMeetupSession) {
                    const session = window.activeMeetupSession;
                    const chat = state.chats[session.chatId];

                    if (chat) {
                        eventData = {
                            location: session.location || 'Êú™ËÆæÂÆö‰ΩçÁΩÆ',
                            timeDisplay: new Date(session.startTime).toLocaleString('zh-CN'),
                            phase: 'during',
                            title: `‰∏é${chat.name || 'AI'}ËßÅÈù¢`
                        };
                    }
                }

                if (eventData) {
                    if (locationEl) locationEl.textContent = `üìç ${eventData.location || '-'}`;
                    if (timeEl) timeEl.textContent = `üïê ${eventData.timeDisplay || 'Êó∂Èó¥Êú™ËÆæÂÆö'}`;
                    if (phaseEl) {
                        const phaseText = eventData.phase === 'before' ? 'üí≠ Âç≥Â∞ÜÂºÄÂßã' :
                            eventData.phase === 'during' ? 'üíï ËßÅÈù¢ËøõË°å‰∏≠' :
                                eventData.phase === 'after' ? '‚ú® ÁæéÂ•ΩÂõûÂøÜ' : 'üíï ËßÅÈù¢Ê®°Âºè';
                        phaseEl.textContent = phaseText;
                    }
                    if (titleEl) {
                        // Include AI character name in title
                        const session = window.activeMeetupSession;
                        if (session && session.chatId && state.chats[session.chatId]) {
                            const chat = state.chats[session.chatId];
                            const aiName = chat.name || 'AI';
                            titleEl.textContent = `‰∏é${aiName}ËßÅÈù¢`;
                        } else {
                            titleEl.textContent = eventData.title || 'ËßÅÈù¢Ê®°Âºè';
                        }
                    }
                }
            }

            function initializeMeetupScreen() {
                // Reset screen state first
                resetMeetupScreen();

                // Check if we're viewing history or active session
                if (window.meetupHistoryEventId) {
                    initializeMeetupHistoryView();
                } else {
                    initializeMeetupActiveSession();
                }
            }

            function resetMeetupScreen() {
                // Remove history mode class
                const meetupScreen = document.getElementById('meetup-screen');
                if (meetupScreen) {
                    meetupScreen.classList.remove('history-mode');
                }

                // Reset title
                const titleEl = document.getElementById('meetup-title');
                if (titleEl) {
                    titleEl.textContent = 'ËßÅÈù¢Ê®°Âºè';
                }

                // Show menu button
                const menuBtn = document.getElementById('meetup-menu');
                if (menuBtn) {
                    menuBtn.style.display = 'block';
                }

                // Clear messages container
                const messagesContainer = document.getElementById('meetup-messages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = '';
                }

                // Reset context bar
                const locationEl = document.getElementById('meetup-location');
                const timeEl = document.getElementById('meetup-time');
                const phaseEl = document.getElementById('meetup-phase');
                if (locationEl) locationEl.textContent = 'üìç ‰ΩçÁΩÆ‰ø°ÊÅØ';
                if (timeEl) timeEl.textContent = 'üïê Êó∂Èó¥‰ø°ÊÅØ';
                if (phaseEl) phaseEl.textContent = 'üíï ËßÅÈù¢ËøõË°å‰∏≠';
            }

            async function initializeMeetupActiveSession() {
                // Initialize input handling for active session
                initializeMeetupInput();

                // Show input area and end date button for active sessions
                const inputArea = document.getElementById('meetup-input-area');
                const endDateBtn = document.getElementById('end-date-btn');
                if (inputArea) inputArea.style.display = 'block';
                if (endDateBtn) endDateBtn.style.display = 'block';

                // Load existing messages for this active session
                await loadActiveMeetupMessages();

                // Update meetup context after loading messages
                updateMeetupContext();

                // Set up back button
                const backBtn = document.getElementById('meetup-back-btn');
                if (backBtn) {
                    backBtn.addEventListener('click', function () {
                        // Exit selection mode if active
                        if (isSelectionMode) {
                            exitMeetupSelectionMode();
                        }

                        // Return to the previous screen or default to chat interface
                        const targetScreen = previousScreen || 'chat-interface-screen';
                        showScreen(targetScreen);
                        previousScreen = null; // Reset after use
                    });
                }

                // Set up menu button
                const menuBtn = document.getElementById('meetup-menu');
                if (menuBtn) {
                    menuBtn.addEventListener('click', function () {
                        // TODO: This will be implemented in later tasks
                        // - Show meetup mode options menu
                        // - Options: view history, end date, settings
                    });
                }

                // Set up selection mode controls
                const selectionCancelBtn = document.getElementById('meetup-selection-cancel-btn');
                if (selectionCancelBtn) {
                    selectionCancelBtn.addEventListener('click', exitMeetupSelectionMode);
                }

                const selectionDeleteBtn = document.getElementById('meetup-selection-delete-btn');
                if (selectionDeleteBtn) {
                    selectionDeleteBtn.addEventListener('click', deleteMeetupSelectedMessages);
                }

                // Override message action handlers for meetup mode
                setupMeetupMessageActionHandlers();
            }

            async function initializeMeetupHistoryView() {
                try {
                    // Load historical meetup data
                    const meetupData = await getMeetupSessionFromEvent(window.meetupHistoryEventId);

                    // Get the original event to find the chatId
                    const event = await db.memories.get(window.meetupHistoryEventId);

                    // Set the active chat context for proper avatar loading
                    if (event && event.chatId) {
                        state.activeChatId = event.chatId;
                    } else if (meetupData.chatId) {
                        state.activeChatId = meetupData.chatId;
                    }

                    // Add history mode class to apply chat interface styling
                    const meetupScreen = document.getElementById('meetup-screen');
                    if (meetupScreen) {
                        meetupScreen.classList.add('history-mode');
                    }

                    // Hide input area and end date button for history view
                    const inputArea = document.getElementById('meetup-input-area');
                    const endDateBtn = document.getElementById('end-date-btn');
                    if (inputArea) inputArea.style.display = 'none';
                    if (endDateBtn) endDateBtn.style.display = 'none';

                    // Update header for history view
                    const titleEl = document.getElementById('meetup-title');
                    if (titleEl) {
                        titleEl.textContent = `ËßÅÈù¢ÂõûÂøÜ - ${meetupData.title || 'ËßÅÈù¢ËÆ∞ÂΩï'}`;
                    }

                    // Update context bar with historical info
                    updateMeetupContextBarForHistory(meetupData);

                    // Load and display historical messages
                    await loadMeetupHistoryMessages(meetupData);

                    // Set up back button for history view
                    const backBtn = document.getElementById('meetup-back-btn');
                    if (backBtn) {
                        // Remove existing event listeners to prevent duplicates
                        const newBackBtn = backBtn.cloneNode(true);
                        backBtn.parentNode.replaceChild(newBackBtn, backBtn);

                        newBackBtn.addEventListener('click', function () {
                            // Clear history mode and return to calendar
                            window.meetupHistoryEventId = null;
                            showScreen('calendar-screen');
                        });
                    }

                    // Disable menu button for history view
                    const menuBtn = document.getElementById('meetup-menu');
                    if (menuBtn) {
                        menuBtn.style.display = 'none';
                    }

                    // Set up selection mode controls for history view
                    const selectionCancelBtn = document.getElementById('meetup-selection-cancel-btn');
                    if (selectionCancelBtn) {
                        selectionCancelBtn.addEventListener('click', exitMeetupSelectionMode);
                    }

                    const selectionDeleteBtn = document.getElementById('meetup-selection-delete-btn');
                    if (selectionDeleteBtn) {
                        selectionDeleteBtn.addEventListener('click', deleteMeetupSelectedMessages);
                    }

                } catch (error) {
                    console.error('Failed to initialize meetup history view:', error);
                    alert('Êó†Ê≥ïÂä†ËΩΩËßÅÈù¢ÂõûÂøÜ: ' + error.message);
                    showScreen('calendar-screen');
                }
            }

            function updateMeetupContextBarForHistory(meetupData) {
                // Update location info
                const locationEl = document.getElementById('meetup-location');
                if (locationEl) {
                    locationEl.textContent = `üìç ${meetupData.location || 'Êú™Áü•Âú∞ÁÇπ'}`;
                }

                // Update time info with date range
                const timeEl = document.getElementById('meetup-time');
                if (timeEl) {
                    const startTime = new Date(meetupData.startTime);
                    const endTime = new Date(meetupData.endTime);
                    const startStr = startTime.toLocaleString('zh-CN', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    const endStr = endTime.toLocaleString('zh-CN', {
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    timeEl.textContent = `üïê ${startStr} - ${endStr}`;
                }

                // Update phase info with completion status
                const phaseEl = document.getElementById('meetup-phase');
                if (phaseEl) {
                    const duration = Math.round(meetupData.totalDuration || 0);
                    phaseEl.textContent = `üíï ËßÅÈù¢Â∑≤ÂÆåÊàê (${duration}ÂàÜÈíü)`;
                }
            }

            async function loadMeetupHistoryMessages(meetupData) {
                const messagesContainer = document.getElementById('meetup-messages');
                if (!messagesContainer) return;

                // Clear existing messages
                messagesContainer.innerHTML = '';

                // Load historical messages
                const messages = meetupData.messages || meetupData.interactions || [];

                if (messages.length === 0) {
                    messagesContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">ËøôÊ¨°ËßÅÈù¢Ê≤°ÊúâÁïô‰∏ãÊ∂àÊÅØËÆ∞ÂΩï</div>';
                    return;
                }

                // Display messages in chronological order
                messages.forEach(message => {
                    // Convert stored message format to display format if needed
                    let displayMessage = message;
                    if (message.role) {
                        // Convert from stored format to display format
                        displayMessage = {
                            ...message,
                            isUser: message.role === 'user'
                        };
                    }

                    const messageEl = createMeetupMessageElement(displayMessage, false); // false - allow editing in history
                    messagesContainer.appendChild(messageEl);
                });

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function createMeetupMessageElement(message, isReadOnly = false) {
                // Use the EXACT same structure as createMeetupMessage
                const isUser = message.role === 'user' || message.isUser === true;

                // Create wrapper following the EXACT same structure as regular chat
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;

                // Create bubble
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
                bubble.dataset.timestamp = message.timestamp;

                // Create timestamp element (outside bubble, inside wrapper)
                const timestampEl = document.createElement('span');
                timestampEl.className = 'timestamp';
                timestampEl.textContent = formatTimestamp(message.timestamp);
                timestampEl.style.display = 'none'; // Hide timestamp from UI

                // Get avatar - try multiple sources for chat context
                let avatarSrc;
                let chatId = null;

                // Try to get chat ID from multiple sources
                if (message.chatId && state.chats[message.chatId]) {
                    chatId = message.chatId;
                } else if (window.activeMeetupSession && window.activeMeetupSession.chatId) {
                    chatId = window.activeMeetupSession.chatId;
                } else if (window.meetupHistoryEventId && state.activeChatId) {
                    chatId = state.activeChatId;
                } else if (state.activeChatId) {
                    chatId = state.activeChatId;
                }

                if (chatId && state.chats[chatId]) {
                    const chat = state.chats[chatId];
                    if (isUser) {
                        avatarSrc = chat.settings.myAvatar || 'https://files.catbox.moe/q6z5fc.jpeg';
                    } else {
                        avatarSrc = chat.settings.aiAvatar || 'https://files.catbox.moe/q6z5fc.jpeg';
                    }
                } else {
                    // Last resort: use default avatars
                    avatarSrc = 'https://files.catbox.moe/q6z5fc.jpeg';
                }

                // Create avatar HTML using EXACT same structure as regular chat
                const avatarHtml = `<div class="avatar-group"><img src="${avatarSrc}" class="avatar"></div>`;

                // Process behavioral notations
                const processed = processBehavioralNotations(message.content || '');

                // Create content HTML (same structure as regular chat)
                const contentHtml = processed.text;

                // Set bubble innerHTML using EXACT same structure as regular chat
                bubble.innerHTML = `
                    ${avatarHtml}
                    <div class="content">
                        ${contentHtml}
                    </div>
                `;

                // Append bubble and timestamp to wrapper in EXACT same order as regular chat
                wrapper.appendChild(bubble);
                wrapper.appendChild(timestampEl);

                // Add long press listener for message actions (same as regular chat)
                if (!isReadOnly) {
                    addLongPressListener(wrapper, () => showMeetupMessageActions(message.timestamp));

                    // Add click listener for selection mode (meetup mode specific)
                    wrapper.addEventListener('click', () => {
                        if (isSelectionMode) {
                            toggleMeetupMessageSelection(message.timestamp);
                        }
                    });
                }

                return wrapper;
            }

            function setupMeetupMessageActionHandlers() {
                // Don't override global handlers - instead make them context-aware
                // The handlers will check if we're in meetup mode and act accordingly
            }

            // Function to save edited meetup messages with multiple message support
            async function saveMeetupEditedMessage(timestamp) {
                if (!timestamp) return;

                // Handle both active meetup mode and history mode
                let eventId, chatId;

                if (window.meetupHistoryEventId) {
                    // History mode
                    eventId = window.meetupHistoryEventId;
                    chatId = state.activeChatId; // Set in initializeMeetupHistoryView
                } else if (window.activeMeetupSession && window.activeMeetupEventId) {
                    // Active meetup mode
                    eventId = window.activeMeetupEventId;
                    chatId = window.activeMeetupSession.chatId;
                } else {
                    console.error('No active meetup session or history context');
                    return;
                }

                const chat = state.chats[chatId];
                if (!chat) {
                    console.error('Chat not found:', chatId);
                    return;
                }

                // Find the message in chat history
                const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
                if (messageIndex === -1) {
                    console.error('Message not found in chat history:', timestamp);
                    return;
                }

                const editorContainer = document.getElementById('message-editor-container');
                const editorBlocks = editorContainer.querySelectorAll('.message-editor-block');

                let newMessages = [];
                let baseTimestamp = timestamp; // Use original timestamp as base

                for (const block of editorBlocks) {
                    const textarea = block.querySelector('textarea');
                    const rawContent = textarea.value.trim();

                    if (!rawContent) continue; // Skip empty editor blocks

                    // Create new message with meetup context
                    const originalMessage = chat.history[messageIndex];
                    const newMessage = {
                        role: originalMessage.role,
                        content: rawContent,
                        timestamp: baseTimestamp++, // Increment timestamp to ensure order and uniqueness
                        isUser: originalMessage.isUser,
                        type: 'meetup_interaction',
                        isHidden: true, // Hidden from regular chat UI like QZone messages
                        meetup: {
                            eventId: eventId,
                            location: originalMessage.meetup?.location || 'Unknown Location',
                            title: originalMessage.meetup?.title || 'Meetup',
                            phase: originalMessage.meetup?.phase || 'conversation',
                            isActive: originalMessage.meetup?.isActive || false
                        }
                    };

                    // Preserve other properties if they exist
                    if (originalMessage.senderName) newMessage.senderName = originalMessage.senderName;
                    if (originalMessage.authorName) newMessage.authorName = originalMessage.authorName;

                    newMessages.push(newMessage);
                }

                if (newMessages.length === 0) {
                    alert("‰∏çËÉΩ‰øùÂ≠òÁ©∫Ê∂àÊÅØÔºåËØ∑Ëá≥Â∞ëËæìÂÖ•‰∏ÄÊù°ÂÜÖÂÆπ„ÄÇ");
                    return;
                }

                try {
                    // Replace the original message with new messages in chat history
                    chat.history.splice(messageIndex, 1, ...newMessages);

                    // Save updated chat to database
                    await db.chats.put(chat);

                    // Update the calendar event's stored meetup data
                    if (window.meetupHistoryEventId) {
                        await updateCalendarEventMeetupData(window.meetupHistoryEventId, chat);
                    }

                    // Close modal and refresh display
                    document.getElementById('message-editor-modal').classList.remove('visible');

                    // Refresh the meetup messages display
                    if (window.meetupHistoryEventId) {
                        // History mode - reload history view
                        await loadMeetupHistoryMessages(await getMeetupSessionFromEvent(window.meetupHistoryEventId));
                    } else {
                        // Active mode - reload active messages
                        await loadActiveMeetupMessages();
                    }

                    await showCustomAlert('ÊàêÂäü', 'Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞ÔºÅ');

                } catch (error) {
                    console.error('Failed to save edited meetup message:', error);
                    alert('‰øùÂ≠òÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Meetup Input Handling Functions End ‚ñ≤‚ñ≤‚ñ≤

            /**
             * Ê£ÄÊü•ÁªôÂÆöÁöÑURLÊòØÂê¶ÂåÖÂê´‰ªª‰ΩïË¢´Á¶ÅÊ≠¢ÁöÑÂÖ≥ÈîÆËØç (ÈªëÂêçÂçïÂÜÖÁΩÆ)
             * @param {string} url - Ë¶ÅÊ£ÄÊü•ÁöÑAPIÂú∞ÂùÄ
             * @returns {boolean} - Â¶ÇÊûú URL ÂåÖÂê´Ë¢´Á¶ÅÊ≠¢ÁöÑÂÖ≥ÈîÆËØçÂàôËøîÂõû true, Âê¶ÂàôËøîÂõû false
             */
            function isApiUrlBanned(url) {
                // Â∞ÜÈªëÂêçÂçïÁõ¥Êé•ÂÆö‰πâÂú®ÂáΩÊï∞ÂÜÖÈÉ®
                //Â¶ÇÊûúÂõ†‰∏∫apiÈóÆÈ¢òËÉΩÊü•Âà∞ËøôÈáåËØÅÊòé‰Ω†ÊòØËÅ™ÊòéÂÆùÂÆù‚Ä¶ ‰ΩÜÊòØ‰∏çÂ•ΩÊÑèÊÄùÁî±‰∫é‰∏™‰∫∫ÂéüÂõ†Á°ÆÂÆûÊòØÂØπËøô‰∏§ÂÆ∂ÊàñÂÖ∂ÁÆ°ÁêÜÊ≤°‰ªÄ‰πàÂ•ΩÊÑüÔºåÂ¶ÇÊûúÁ°ÆÂÆûË¶ÅÁî®ÁöÑËØùÁõ¥Êé•Âà†ÊéâÂ∞±Â•ΩÔºåÊàë‰πüÊãø‰Ω†Ê≤°ÂäûÊ≥ï„ÄÇÁÆóÊòØÊàë‰∏ÄÁÇπÂ∞èÊÅ∂ÊØíÂêßÔºåÊä±Ê≠â„ÄÇ
                const BANNED_API_KEYWORDS = ['nyabit', 'v1', 'dianhuomao'];
                if (!url) return false;
                const lowercasedUrl = url.toLowerCase();
                // ‰ΩøÁî® .some() ÊñπÊ≥ïÔºåÂè™Ë¶ÅÊâæÂà∞‰∏Ä‰∏™ÂåπÈÖçÁöÑÂÖ≥ÈîÆËØçÂ∞±Á´ãÂç≥ËøîÂõû true
                return BANNED_API_KEYWORDS.some(keyword => lowercasedUrl.includes(keyword));
            }

            function isGoogleGeminiAPI(proxyUrl) {
                return proxyUrl && proxyUrl.includes('generativelanguage.googleapis.com');
            }

            async function makeAPIRequest(proxyUrl, apiKey, model, messages, temperature = 0.8) {
                if (isGoogleGeminiAPI(proxyUrl)) {

                    // WEB IMAGE ANALYSIS FEATURE: Enhanced Gemini API format with vision support
                    const contents = await Promise.all(messages.map(async msg => {
                        const role = msg.role === 'assistant' ? 'model' : 'user';
                        
                        // Handle vision analysis for images
                        if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url' && msg.isVisionAnalysis) {
                            try {
                                const imageUrl = msg.content[0].image_url.url;
                                let base64Data;
                                let mimeType;
                                
                                // Check if it's already a data URL (from phone upload)
                                if (imageUrl.startsWith('data:')) {
                                    const matches = imageUrl.match(/^data:([^;]+);base64,(.+)$/);
                                    if (matches) {
                                        mimeType = matches[1];
                                        base64Data = matches[2];
                                    } else {
                                        throw new Error('Invalid data URL format');
                                    }
                                } else {
                                    // Fetch web image and convert to base64
                                    const response = await fetch(imageUrl);
                                    const blob = await response.blob();
                                    base64Data = await new Promise(resolve => {
                                        const reader = new FileReader();
                                        reader.onloadend = () => resolve(reader.result.split(',')[1]);
                                        reader.readAsDataURL(blob);
                                    });
                                    mimeType = blob.type || "image/jpeg";
                                }
                                
                                return {
                                    role: role,
                                    parts: [
                                        { 
                                            inlineData: {
                                                mimeType: mimeType,
                                                data: base64Data
                                            }
                                        }
                                    ]
                                };
                            } catch (error) {
                                console.error('Failed to process image for Gemini:', error);
                                return {
                                    role: role,
                                    parts: [{ text: "[Image could not be processed for analysis]" }]
                                };
                            }
                        }
                        
                        // Handle regular content (text, non-vision images)
                        return {
                            role: role,
                            parts: [{ text: typeof msg.content === 'string' ? msg.content : "[User sent an image]" }]
                        };
                    }));



                    const response = await fetch(`${proxyUrl}/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: contents,
                            generationConfig: {
                                temperature: temperature
                            }
                        })
                    });



                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error(`[API Debug] Google API request failed:`, {
                            status: response.status,
                            statusText: response.statusText,
                            errorData: errorData
                        });
                        throw new Error(errorData.error?.message || 'Google API request failed');
                    }

                    const data = await response.json();

                    if (!data.candidates || !Array.isArray(data.candidates) || data.candidates.length === 0) {
                        throw new Error('Invalid Google API response: no candidates found');
                    }

                    // Convert Google response to OpenAI format
                    const convertedResponse = {
                        choices: [{
                            message: {
                                content: data.candidates[0]?.content?.parts[0]?.text || ''
                            }
                        }]
                    };

                    return convertedResponse;
                } else {
                    // OpenAI-compatible API format (existing)
                    const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: model,
                            messages: messages,
                            temperature: temperature
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || 'API request failed');
                    }

                    const data = await response.json();
                    return data;
                }
            }
            function showNotification(chatId, messageContent) { clearTimeout(notificationTimeout); const chat = state.chats[chatId]; if (!chat) return; const bar = document.getElementById('notification-bar'); document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar; document.getElementById('notification-content').querySelector('.name').textContent = chat.name; document.getElementById('notification-content').querySelector('.message').textContent = messageContent; const newBar = bar.cloneNode(true); bar.parentNode.replaceChild(newBar, bar); newBar.addEventListener('click', () => { openChat(chatId); newBar.classList.remove('visible'); }); newBar.classList.add('visible'); notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000); }

            // WEB IMAGE ANALYSIS FEATURE: Handle web image URL input and create vision-enabled message
            async function showWebImageUrlPrompt() {
                if (!state.activeChatId) return;
                
                const imageUrl = await showCustomPrompt("ÁΩëÁªúÂõæÁâáÂàÜÊûê", "ËØ∑ËæìÂÖ•ÂõæÁâáURLÔºö");
                if (!imageUrl || !imageUrl.trim()) return;
                
                const chat = state.chats[state.activeChatId];
                // Create message with vision analysis flag
                const msg = { 
                    role: 'user', 
                    content: [{ type: 'image_url', image_url: { url: imageUrl.trim() } }], 
                    timestamp: Date.now(),
                    isVisionAnalysis: true // Flag for API processing
                };
                
                chat.history.push(msg);
                await db.chats.put(chat);
                appendMessage(msg, chat);
                renderChatList();
            }
            window.showWebImageUrlPrompt = showWebImageUrlPrompt;

            function updateClock() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('main-time').textContent = timeString; document.getElementById('status-bar-time').textContent = timeString; document.getElementById('main-date').textContent = dateString; }

            function parseAiResponse(content) {
                // Safety check for null/undefined/empty content
                if (!content || typeof content !== 'string') {
                    return [];
                }
                
                const trimmedContent = content.trim();
                
                // Check for empty content after trimming
                if (trimmedContent.length === 0) {
                    return [];
                }

                // 1. Â∞ùËØï‰Ωú‰∏∫ÂÆåÊï¥ÁöÑJSONÊï∞ÁªÑËß£Êûê (ÊúÄÁêÜÊÉ≥ÊÉÖÂÜµ)
                if (trimmedContent.startsWith('[') && trimmedContent.endsWith(']')) {
                    try {
                        const parsed = JSON.parse(trimmedContent);
                        if (Array.isArray(parsed)) return parsed;
                    } catch (e) {
                        // Ëß£ÊûêÂ§±Ë¥•ÔºåÁªßÁª≠Â∞ùËØïÂÖ∂‰ªñÊñπÊ≥ï
                    }
                }

                // 2. Â¶ÇÊûúÂ§±Ë¥•ÔºåÂ∞ùËØï‰Ωú‰∏∫Âçï‰∏™JSONÂØπË±°Ëß£Êûê (Â§ÑÁêÜAI‚ÄúÂÅ∑Êáí‚ÄùÁöÑÊÉÖÂÜµ)
                if (trimmedContent.startsWith('{') && trimmedContent.endsWith('}')) {
                    try {
                        const parsed = JSON.parse(trimmedContent);
                        // Â¶ÇÊûúÊàêÂäüËß£Êûê‰∏∫ÂØπË±°ÔºåÊääÂÆÉÊîæËøõ‰∏Ä‰∏™Êï∞ÁªÑÈáåÂÜçËøîÂõûÔºå‰ª•Áªü‰∏ÄÊ†ºÂºè
                        return [parsed];
                    } catch (e) {
                        // Ëß£ÊûêÂ§±Ë¥•ÔºåÁªßÁª≠Â∞ùËØïÂÖ∂‰ªñÊñπÊ≥ï
                    }
                }

                // 3. Â∞ùËØïËß£ÊûêÂ§ö‰∏™Áã¨Á´ãÁöÑJSONÊï∞ÁªÑ (Â§ÑÁêÜAIËøîÂõûÂ§ö‰∏™[{...}]ÁöÑÊÉÖÂÜµ)
                try {
                    const jsonArrayMatches = content.match(/\[.*?\]/g);
                    if (jsonArrayMatches && jsonArrayMatches.length > 1) {
                        const allMessages = [];
                        for (const jsonStr of jsonArrayMatches) {
                            try {
                                const parsed = JSON.parse(jsonStr);
                                if (Array.isArray(parsed)) {
                                    allMessages.push(...parsed);
                                }
                            } catch (e) {
                                // Ë∑≥ËøáÊó†ÊïàÁöÑJSON
                            }
                        }
                        if (allMessages.length > 0) return allMessages;
                    }
                } catch (e) {
                    // Ëß£ÊûêÂ§±Ë¥•
                }

                // 4. ‰Ωú‰∏∫Â§áÁî®ÊñπÊ°àÔºåÂ∞ùËØï‰ªéÊñáÊú¨‰∏≠ÊèêÂèñÂçï‰∏™JSONÊï∞ÁªÑ
                try {
                    const match = content.match(/\[(.*?)\]/s);
                    if (match && match[0]) {
                        const parsed = JSON.parse(match[0]);
                        if (Array.isArray(parsed)) return parsed;
                    }
                } catch (e) {
                    // ÊèêÂèñÂ§±Ë¥•
                }

                // 5. Â¶ÇÊûú‰ª•‰∏äÂÖ®ÈÉ®Â§±Ë¥•ÔºåÂàôËßÜ‰∏∫Á∫ØÊñáÊú¨Â§ÑÁêÜ
                const lines = content.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('```'));
                if (lines.length > 0) return lines;

                // 6. ÊúÄÁªàÁöÑÊúÄÁªàÔºåËøîÂõûÂéüÂßãÊñáÊú¨
                return [content];
            }

            function renderApiSettings() {
                document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; document.getElementById('api-key').value = state.apiConfig.apiKey || '';
                // ‚ñº‚ñº‚ñº Êñ∞Â¢ûËøôË°å ‚ñº‚ñº‚ñº
                document.getElementById('background-activity-switch').checked = state.globalSettings.enableBackgroundActivity || false;
                document.getElementById('background-interval-input').value = state.globalSettings.backgroundActivityInterval || 60;
                document.getElementById('block-cooldown-input').value = state.globalSettings.blockCooldownHours || 1;
            }
            window.renderApiSettingsProxy = renderApiSettings;

            // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÊîØÊåÅÁä∂ÊÄÅÁÅØÂíåÊó∂Èó¥Êà≥ÁöÑÂÖ®Êñ∞ÁâàÊú¨„ÄëÊõøÊç¢ÊóßÁöÑ renderChatList Âíå createChatListItem ÂáΩÊï∞ ‚ñº‚ñº‚ñº

            /**
             * Ê†ºÂºèÂåñÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
             * @param {number} timestamp - Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
             * @returns {string} Ê†ºÂºèÂåñÂêéÁöÑÊó∂Èó¥Â≠óÁ¨¶‰∏≤
             */
            function formatLastMessageTime(timestamp) {
                if (!timestamp) return '';
                const now = new Date();
                const date = new Date(timestamp);

                // Â¶ÇÊûúÊòØ‰ªäÂ§©
                if (now.toDateString() === date.toDateString()) {
                    return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
                }

                // Â¶ÇÊûúÊòØÊò®Â§©
                const yesterday = new Date(now);
                yesterday.setDate(now.getDate() - 1);
                if (yesterday.toDateString() === date.toDateString()) {
                    return 'Êò®Â§©';
                }

                // Â¶ÇÊûúÊòØÊõ¥Êó©
                return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
            }

            async function renderChatList() {
                const chatListEl = document.getElementById('chat-list');
                chatListEl.innerHTML = '';

                const allChats = Object.values(state.chats).sort((a, b) => {
                    // First sort by pinned status (pinned chats first)
                    if (a.isPinned && !b.isPinned) return -1;
                    if (!a.isPinned && b.isPinned) return 1;

                    // Then sort by last message timestamp
                    const lastMsgA = a.history.slice(-1)[0] || {};
                    const lastMsgB = b.history.slice(-1)[0] || {};
                    return (lastMsgB.timestamp || 0) - (lastMsgA.timestamp || 0);
                });

                if (allChats.length === 0) {
                    chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÊàñÁæ§ÁªÑÂõæÊ†áÊ∑ªÂä†ËÅäÂ§©</p>';
                    return;
                }

                const allGroups = await db.qzoneGroups.toArray();

                // ËÆ°ÁÆóÊØè‰∏™ÂàÜÁªÑÁöÑÊúÄÊñ∞Êó∂Èó¥Êà≥ÔºåÁî®‰∫éÊéíÂ∫è
                allGroups.forEach(group => {
                    const latestChatInGroup = allChats
                        .filter(chat => chat.groupId === group.id)
                        .sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0))[0];
                    group.latestTimestamp = latestChatInGroup ? (latestChatInGroup.history.slice(-1)[0]?.timestamp || 0) : 0;
                });

                // ÊåâÊúÄÊñ∞Êó∂Èó¥Êà≥ÂØπÂàÜÁªÑËøõË°åÈôçÂ∫èÊéíÂ∫è
                allGroups.sort((a, b) => b.latestTimestamp - a.latestTimestamp);

                // Ê∏≤ÊüìÂàÜÁªÑÁöÑËÅäÂ§©
                allGroups.forEach(group => {
                    const groupChats = allChats.filter(chat => !chat.isGroup && chat.groupId === group.id);
                    if (groupChats.length === 0) return;

                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'chat-group-container';
                    groupContainer.innerHTML = `
            <div class="chat-group-header">
                <span class="arrow">‚ñº</span>
                <span class="group-name">${group.name} (${groupChats.length})</span>
            </div>
            <div class="chat-group-content"></div>
        `;
                    const contentEl = groupContainer.querySelector('.chat-group-content');

                    // Á°Æ‰øùÁªÑÂÜÖÁöÑËÅäÂ§©‰πüÊåâÊó∂Èó¥ÊéíÂ∫è
                    groupChats.sort((a, b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0));

                    groupChats.forEach(chat => {
                        const item = createChatListItem(chat);
                        contentEl.appendChild(item);
                    });
                    chatListEl.appendChild(groupContainer);
                });

                // Ê∏≤ÊüìÊú™ÂàÜÁªÑÁöÑËÅäÂ§©ÂíåÊâÄÊúâÁæ§ËÅä
                const ungroupedOrGroupChats = allChats.filter(chat => chat.isGroup || (!chat.isGroup && !chat.groupId));
                ungroupedOrGroupChats.forEach(chat => {
                    const item = createChatListItem(chat);
                    chatListEl.appendChild(item);
                });

                // ‰∏∫ÊâÄÊúâÊñ∞ÁîüÊàêÁöÑÊäòÂè†ÁÆ≠Â§¥ÁªëÂÆö‰∫ã‰ª∂
                document.querySelectorAll('.chat-group-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.classList.toggle('collapsed');
                        header.nextElementSibling.classList.toggle('collapsed');
                    });
                });
            }


            function createChatListItem(chat) {
                const lastMsgObj = chat.history.filter(msg => !msg.isHidden).slice(-1)[0] || {};
                let lastMsgDisplay = '...';

                // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãÁîüÊàêÈ¢ÑËßàÊñáÊú¨
                if (lastMsgObj.type === 'pat_message') { lastMsgDisplay = `[Á≥ªÁªüÊ∂àÊÅØ] ${lastMsgObj.content}`; }
                else if (lastMsgObj.type === 'transfer') { lastMsgDisplay = '[ËΩ¨Ë¥¶]'; }
                else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ÁÖßÁâá]'; }
                else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[ËØ≠Èü≥]'; }
                else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[Ë°®ÊÉÖ: ${lastMsgObj.meaning}]` : '[Ë°®ÊÉÖ]'; }
                else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[ÂõæÁâá]`; }
                else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 25); }

                if (chat.isGroup && lastMsgObj.senderName && lastMsgObj.type !== 'pat_message') {
                    lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`;
                }

                // Â§ÑÁêÜÁâπÊÆäÂÖ≥Á≥ªÁä∂ÊÄÅÁöÑÊòæÁ§∫
                if (!chat.isGroup && chat.relationship?.status === 'pending_user_approval') {
                    lastMsgDisplay = `<span style="color: #ff8c00;">[Â•ΩÂèãÁî≥ËØ∑] ${chat.relationship.applicationReason || 'ËØ∑Ê±ÇÊ∑ªÂä†‰Ω†‰∏∫Â•ΩÂèã'}</span>`;
                } else if (!chat.isGroup && chat.relationship?.status === 'blocked_by_ai') {
                    lastMsgDisplay = `<span style="color: #dc3545;">[‰Ω†Â∑≤Ë¢´ÂØπÊñπÊãâÈªë]</span>`;
                }

                const item = document.createElement('div');
                item.className = 'chat-list-item';
                if (chat.isPinned) {
                    item.classList.add('pinned');
                }
                item.dataset.chatId = chat.id;
                const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar;

                // **Ê†∏ÂøÉHTMLÁªìÊûÑ‰øÆÊîπ**
                item.innerHTML = `
        <img src="${avatar || defaultAvatar}" class="avatar">
        <div class="info">
            <div class="name-line">
                <span class="name">${chat.name}</span>
                ${chat.isGroup ? '<span class="group-tag">Áæ§ËÅä</span>' : ''}
            </div>
            <div class="last-msg">${lastMsgDisplay}</div>
        </div>
        <div class="meta">
            <div class="timestamp">${formatLastMessageTime(lastMsgObj.timestamp)}</div>
            <div class="status-light ${chat.status || ''}"></div>
        </div>
    `;

                // ‚ñº‚ñº‚ñº Ê†∏ÂøÉ‰øÆÊîπÔºö‰∏∫Â§¥ÂÉèÊ∑ªÂä†Êô∫ËÉΩÁöÑÂçïÂáª/ÂèåÂáª‰∫ã‰ª∂Â§ÑÁêÜÂô® ‚ñº‚ñº‚ñº
                const avatarEl = item.querySelector('.avatar');
                if (avatarEl) {
                    let clickTimer = null; // Áî®‰∫éÂ≠òÂÇ®ÂçïÂáªÂª∂Êó∂Âô®ÁöÑÂèòÈáè
                    let clickCount = 0;    // Áî®‰∫éËÆ∞ÂΩïÁÇπÂáªÊ¨°Êï∞ÁöÑÂèòÈáè

                    avatarEl.addEventListener('click', (e) => {
                        e.stopPropagation(); // ÂÖ≥ÈîÆÔºÅÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞Áà∂ÂÖÉÁ¥†ÔºåÈò≤Ê≠¢Á´ãÂç≥Ëß¶ÂèëËøõÂÖ•ËÅäÂ§©

                        clickCount++;

                        if (clickCount === 1) {
                            // Á¨¨‰∏ÄÊ¨°ÁÇπÂáªÊó∂ÔºåÂêØÂä®‰∏Ä‰∏™ÂÆöÊó∂Âô®
                            clickTimer = setTimeout(() => {
                                // Â¶ÇÊûúÂÆöÊó∂Âô®Ê≠£Â∏∏Ëß¶ÂèëÔºà300ÊØ´ÁßíÂÜÖÊ≤°ÊúâÁ¨¨‰∫åÊ¨°ÁÇπÂáªÔºâÔºåÂàôÊâßË°åÂçïÂáªÊìç‰Ωú
                                openChat(chat.id); // ÂçïÂáªÂ§¥ÂÉèËøõÂÖ•ËÅäÂ§©
                                clickCount = 0; // ÈáçÁΩÆÁÇπÂáªËÆ°Êï∞
                            }, 300); // 300ÊØ´ÁßíÊòØ‰∏Ä‰∏™ÊØîËæÉËàíÈÄÇÁöÑÂèåÂáªÈó¥Èöî
                        } else if (clickCount === 2) {
                            // Âú®ÂÆöÊó∂Âô®Ëß¶ÂèëÂâçÔºåÁ¨¨‰∫åÊ¨°ÁÇπÂáªÂà∞Êù•‰∫Ü
                            clearTimeout(clickTimer); // Ê∏ÖÈô§Âç≥Â∞ÜÊâßË°åÁöÑÂçïÂáªÊìç‰Ωú
                            clickCount = 0; // ÈáçÁΩÆÁÇπÂáªËÆ°Êï∞

                            // Á´ãÂç≥ÊâßË°åÂèåÂáªÊìç‰Ωú
                            handleUserPat(chat.id, chat.name); // ÂèåÂáªÂ§¥ÂÉèËøõË°å‚ÄúÊãç‰∏ÄÊãç‚Äù
                        }
                    });
                }
                // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊîπÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                item.addEventListener('click', (event) => {
                    // Âè™ÊúâÂΩìÁÇπÂáª‰∫ã‰ª∂ÁöÑÁõÆÊ†á‰∏çÊòØÂ§¥ÂÉèÊó∂ÔºåÊâçÁ´ãÂç≥ËøõÂÖ•ËÅäÂ§©
                    if (!event.target.classList.contains('avatar')) {
                        openChat(chat.id);
                    }
                });

                addLongPressListener(item, async (e) => {
                    showChatActions(chat.id);
                });

                return item;
            }


            function renderChatInterface(chatId) {
                cleanupWaimaiTimers();
                const chat = state.chats[chatId];
                if (!chat) return;
                exitSelectionMode();

                const messagesContainer = document.getElementById('chat-messages');
                const chatInputArea = document.getElementById('chat-input-area');
                const lockOverlay = document.getElementById('chat-lock-overlay');
                const lockContent = document.getElementById('chat-lock-content');

                messagesContainer.dataset.theme = chat.settings.theme || 'default';
                const fontSize = chat.settings.fontSize || 13;
                messagesContainer.style.setProperty('--chat-font-size', `${fontSize}px`);
                applyScopedCss(chat.settings.customCss || '', '#chat-messages', 'custom-bubble-style');

                document.getElementById('chat-header-title').textContent = chat.name;
                const statusContainer = document.getElementById('chat-header-status');
                const statusTextEl = statusContainer.querySelector('.status-text');

                if (chat.isGroup) {
                    statusContainer.style.display = 'none';
                    document.getElementById('chat-header-title-wrapper').style.justifyContent = 'center';
                } else {
                    statusContainer.style.display = 'flex';
                    document.getElementById('chat-header-title-wrapper').style.justifyContent = 'flex-start';
                    statusTextEl.textContent = chat.status?.text || 'Âú®Á∫ø';
                    statusContainer.classList.toggle('busy', chat.status?.isBusy || false);
                }

                lockOverlay.style.display = 'none';
                chatInputArea.style.visibility = 'visible';
                lockContent.innerHTML = '';

                if (!chat.isGroup && chat.relationship.status !== 'friend') {
                    lockOverlay.style.display = 'flex';
                    chatInputArea.style.visibility = 'hidden';

                    let lockHtml = '';
                    switch (chat.relationship.status) {
                        case 'blocked_by_user':
                            // --- „ÄêÊ†∏ÂøÉ‰øÆÊîπÔºöÂú®ËøôÈáåÂä†ÂÖ•ËØäÊñ≠Èù¢Êùø„Äë ---
                            const isSimulationRunning = simulationIntervalId !== null;
                            const blockedTimestamp = chat.relationship.blockedTimestamp;
                            const cooldownHours = state.globalSettings.blockCooldownHours || 1;
                            const cooldownMilliseconds = cooldownHours * 60 * 60 * 1000;
                            const timeSinceBlock = Date.now() - blockedTimestamp;
                            const isCooldownOver = timeSinceBlock > cooldownMilliseconds;
                            const timeRemainingMinutes = Math.max(0, Math.ceil((cooldownMilliseconds - timeSinceBlock) / (1000 * 60)));

                            lockHtml = `
                    <span class="lock-text">‰Ω†Â∑≤Â∞Ü‚Äú${chat.name}‚ÄùÊãâÈªë„ÄÇ</span>
                    <button id="unblock-btn" class="lock-action-btn">Ëß£Èô§ÊãâÈªë</button>
                    <div style="margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; font-size: 11px; text-align: left; color: #666; background: rgba(0,0,0,0.02);">
                        <strong style="color: #333;">„ÄêÂºÄÂèëËÄÖËØäÊñ≠Èù¢Êùø„Äë</strong><br>
                        - ÂêéÂè∞Ê¥ªÂä®ÊÄªÂºÄÂÖ≥: ${state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">Â∑≤ÂºÄÂêØ</span>' : '<span style="color: red;">Â∑≤ÂÖ≥Èó≠</span>'}<br>
                        - Á≥ªÁªüÂøÉË∑≥ËÆ°Êó∂Âô®: ${isSimulationRunning ? '<span style="color: green;">ËøêË°å‰∏≠</span>' : '<span style="color: red;">Êú™ËøêË°å</span>'}<br>
                        - ÂΩìÂâçËßíËâ≤Áä∂ÊÄÅ: <strong>${chat.relationship.status}</strong><br>
                        - ÈúÄË¶ÅÂÜ∑Èùô(Â∞èÊó∂): <strong>${cooldownHours}</strong><br>
                        - ÂÜ∑ÈùôÊúüÊòØÂê¶ÁªìÊùü: ${isCooldownOver ? '<span style="color: green;">ÊòØ</span>' : `<span style="color: orange;">Âê¶ (ËøòÂâ©Á∫¶ ${timeRemainingMinutes} ÂàÜÈíü)</span>`}<br>
                        - Ëß¶ÂèëÊù°‰ª∂: ${isCooldownOver && state.globalSettings.enableBackgroundActivity ? '<span style="color: green;">Â∑≤Êª°Ë∂≥ÔºåÁ≠âÂæÖ‰∏ãÊ¨°Á≥ªÁªüÂøÉË∑≥</span>' : '<span style="color: red;">Êú™Êª°Ë∂≥</span>'}
                    </div>
                    <button id="force-apply-check-btn" class="lock-action-btn secondary" style="margin-top: 10px;">Âº∫Âà∂Ëß¶Âèë‰∏ÄÊ¨°Â•ΩÂèãÁî≥ËØ∑Ê£ÄÊµã</button>
                `;
                            // --- „Äê‰øÆÊîπÁªìÊùü„Äë ---
                            break;
                        case 'blocked_by_ai':
                            lockHtml = `
                    <span class="lock-text">‰Ω†Ë¢´ÂØπÊñπÊãâÈªë‰∫Ü„ÄÇ</span>
                    <button id="apply-friend-btn" class="lock-action-btn">ÈáçÊñ∞Áî≥ËØ∑Âä†‰∏∫Â•ΩÂèã</button>
                `;
                            break;

                        case 'pending_user_approval':
                            lockHtml = `
                    <span class="lock-text">‚Äú${chat.name}‚ÄùËØ∑Ê±ÇÊ∑ªÂä†‰Ω†‰∏∫Â•ΩÂèãÔºö<br><i>‚Äú${chat.relationship.applicationReason}‚Äù</i></span>
                    <button id="accept-friend-btn" class="lock-action-btn">Êé•Âèó</button>
                    <button id="reject-friend-btn" class="lock-action-btn secondary">ÊãíÁªù</button>
                `;
                            break;

                        // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„Äë‰øÆÂ§çÂΩì‰Ω†Áî≥ËØ∑ÂêéÔºå‰Ω†ÁúãÂà∞ÁöÑÁïåÈù¢
                        case 'pending_ai_approval':
                            lockHtml = `<span class="lock-text">Â•ΩÂèãÁî≥ËØ∑Â∑≤ÂèëÈÄÅÔºåÁ≠âÂæÖÂØπÊñπÈÄöËøá...</span>`;
                            break;
                    }
                    lockContent.innerHTML = lockHtml;
                }
                messagesContainer.innerHTML = '';
                // ...ÂêéÁª≠‰ª£Á†Å‰øùÊåÅ‰∏çÂèò
                const chatScreen = document.getElementById('chat-interface-screen');
                chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none';
                chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : '#f0f2f5';
                const history = chat.history;
                const totalMessages = history.length;
                currentRenderedCount = 0;
                const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW);
                initialMessages.forEach(msg => appendMessage(msg, chat, true));
                currentRenderedCount = initialMessages.length;
                if (totalMessages > currentRenderedCount) {
                    prependLoadMoreButton(messagesContainer);
                }
                const typingIndicator = document.createElement('div');
                typingIndicator.id = 'typing-indicator';
                typingIndicator.style.display = 'none';
                typingIndicator.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...';
                messagesContainer.appendChild(typingIndicator);
                setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0);
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'Âä†ËΩΩÊõ¥Êó©ÁöÑËÆ∞ÂΩï'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }

            function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat)); currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }

            function renderWallpaperScreen() {
                const preview = document.getElementById('wallpaper-preview');
                const bg = newWallpaperBase64 || state.globalSettings.wallpaper;
                if (bg && bg.startsWith('data:image')) {
                    preview.style.backgroundImage = `url(${bg})`;
                    preview.textContent = '';
                } else if (bg) {
                    preview.style.backgroundImage = bg;
                    preview.textContent = 'ÂΩìÂâç‰∏∫Ê∏êÂèòËâ≤';
                }

                // Render app icon customization section
                renderAppIconCustomization();
            }

            function renderAppIconCustomization() {
                const container = document.getElementById('app-icon-customization-list');
                if (!container) return;



                // Define default app icons
                const defaultAppIcons = [
                    { id: 'qq', name: 'QQ', defaultUrl: 'https://files.catbox.moe/janu1z.png' },
                    { id: 'moments', name: 'ÊúãÂèãÂúà', defaultUrl: 'https://files.catbox.moe/65cdyc.png' },
                    { id: 'settings', name: 'ËÆæÁΩÆ', defaultUrl: 'https://files.catbox.moe/xmo1uf.png' },
                    { id: 'calendar', name: 'Êó•ÂéÜ', defaultUrl: 'https://files.catbox.moe/calendar.png' }
                ];

                container.innerHTML = '';

                defaultAppIcons.forEach(app => {
                    // Load from localStorage (same as charm CSS)
                    const currentUrl = localStorage.getItem(`appIcon_${app.id}`) || app.defaultUrl;

                    const appIconItem = document.createElement('div');
                    appIconItem.className = 'app-icon-item';

                    appIconItem.innerHTML = `
                        <div class="app-icon-preview">
                            <img src="${currentUrl}" alt="${app.name}">
                            <span>${app.name}</span>
                        </div>
                        <input type="file" 
                               id="app-icon-input-${app.id}" 
                               accept="image/*"
                               style="display: none;">
                        <div class="app-icon-actions">
                            <button onclick="updateAppIcon('${app.id}')" class="app-icon-btn primary">
                                Â∫îÁî®
                            </button>
                            <button onclick="resetAppIcon('${app.id}', '${app.defaultUrl}')" class="app-icon-btn secondary">
                                ÈáçÁΩÆ
                            </button>
                        </div>
                    `;

                    container.appendChild(appIconItem);
                });
            }

            window.updateAppIcon = async function (appId) {
                // Trigger file picker
                const fileInput = document.getElementById(`app-icon-input-${appId}`);
                if (!fileInput) return;
                
                // Set up one-time event listener for file selection
                fileInput.onchange = async (event) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    try {
                        // Compress image with smaller dimensions for app icons (256px max)
                        const compressedBase64 = await compressImage(file, 256, 0.85);
                        
                        // Save to localStorage (same as charm CSS)
                        localStorage.setItem(`appIcon_${appId}`, compressedBase64);

                        // Apply to home screen
                        applyAppIconsToHomeScreen();

                        // Re-render the customization section to show updated preview
                        renderAppIconCustomization();

                        showCustomAlert('ÊàêÂäü', 'ÂõæÊ†áÂ∑≤Êõ¥Êñ∞');
                    } catch (error) {
                        showCustomAlert('ÈîôËØØ', '‰øùÂ≠òÂõæÊ†áÂ§±Ë¥•: ' + error.message);
                    }
                    
                    // Reset file input
                    event.target.value = '';
                };
                
                // Trigger file picker
                fileInput.click();
            }

            window.resetAppIcon = function (appId, defaultUrl) {
                // Remove from localStorage (same as charm CSS reset)
                localStorage.removeItem(`appIcon_${appId}`);

                // Apply to home screen
                applyAppIconsToHomeScreen();

                // Re-render the customization section to show updated preview
                renderAppIconCustomization();

                showCustomAlert('ÊàêÂäü', 'ÂõæÊ†áÂ∑≤ÈáçÁΩÆ‰∏∫ÈªòËÆ§');
            }

            function applyAppIconsToHomeScreen() {
                const appIconMappings = {
                    'qq': '#app-grid .app-row:nth-child(2) .app-icon:nth-child(2) .icon-bg img', // First app icon (QQ)
                    'moments': '#app-grid .app-row:nth-child(2) .app-icon:nth-child(3) .icon-bg img', // Second app icon (ÊúãÂèãÂúà)
                    'calendar': '#app-grid .app-row:nth-child(2) .app-icon:nth-child(4) .icon-bg img', // Third app icon (Êó•ÂéÜ)
                    'settings': '#app-grid .app-row:nth-child(2) .app-icon:nth-child(5) .icon-bg img' // Fourth app icon (ËÆæÁΩÆ)
                };

                Object.keys(appIconMappings).forEach(appId => {
                    // Load from localStorage (same as charm CSS)
                    const iconUrl = localStorage.getItem(`appIcon_${appId}`);
                    if (iconUrl) {
                        const imgElement = document.querySelector(appIconMappings[appId]);
                        if (imgElement) {
                            imgElement.src = iconUrl;
                        }
                    }
                });
            }
            window.renderWallpaperScreenProxy = renderWallpaperScreen;

            function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }

            function renderWorldBookScreen() { const listEl = document.getElementById('world-book-list'); listEl.innerHTML = ''; if (state.worldBooks.length === 0) { listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏ÄÊú¨‰∏ñÁïå‰π¶</p>'; return; } state.worldBooks.forEach(book => { const item = document.createElement('div'); item.className = 'list-item'; item.dataset.bookId = book.id; item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || 'ÊöÇÊó†ÂÜÖÂÆπ...').substring(0, 50)}</div>`; item.addEventListener('click', () => openWorldBookEditor(book.id)); addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('Âà†Èô§‰∏ñÁïå‰π¶', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${book.name}„ÄãÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } }); listEl.appendChild(item); }); }
            window.renderWorldBookScreenProxy = renderWorldBookScreen;

            function renderSettingsScreen() {
                const listEl = document.getElementById('settings-list');
                listEl.innerHTML = '';

                // APIËÆæÁΩÆ section
                const apiItem = document.createElement('div');
                apiItem.className = 'list-item';
                apiItem.innerHTML = `<div class="item-title">APIËÆæÁΩÆ</div><div class="item-content">ÈÖçÁΩÆAPIÂØÜÈí•ÂíåÊ®°Âûã</div>`;
                apiItem.addEventListener('click', () => showScreen('api-settings-screen'));
                listEl.appendChild(apiItem);

                // ‰∏ñÁïå‰π¶ section
                const worldBookItem = document.createElement('div');
                worldBookItem.className = 'list-item';
                worldBookItem.innerHTML = `<div class="item-title">‰∏ñÁïå‰π¶</div><div class="item-content">ÁÆ°ÁêÜËßíËâ≤ËÆæÂÆöÂíå‰∏ñÁïåËßÇ</div>`;
                worldBookItem.addEventListener('click', () => showScreen('world-book-screen'));
                listEl.appendChild(worldBookItem);

                // Â§ñËßÇËÆæÁΩÆ section
                const appearanceItem = document.createElement('div');
                appearanceItem.className = 'list-item';
                appearanceItem.innerHTML = `<div class="item-title">Â§ñËßÇËÆæÁΩÆ</div><div class="item-content">Â£ÅÁ∫∏„ÄÅÂ≠ó‰ΩìÂíåÊåÇ‰ª∂Ê†∑Âºè</div>`;
                appearanceItem.addEventListener('click', () => showScreen('appearance-settings-screen'));
                listEl.appendChild(appearanceItem);

                // ÈÄöÁî®ËÆæÁΩÆ section
                const generalItem = document.createElement('div');
                generalItem.className = 'list-item';
                generalItem.innerHTML = `<div class="item-title">ÈÄöÁî®ËÆæÁΩÆ</div><div class="item-content">Â∫îÁî®ÈÄöÁî®ÈÖçÁΩÆÈÄâÈ°π</div>`;
                generalItem.addEventListener('click', () => showScreen('general-settings-screen'));
                listEl.appendChild(generalItem);

                // Â§á‰ªΩÊñá‰ª∂ section
                const backupItem = document.createElement('div');
                backupItem.className = 'list-item';
                backupItem.innerHTML = `<div class="item-title">Â§á‰ªΩÊñá‰ª∂</div><div class="item-content">ÂØºÂá∫„ÄÅÂØºÂÖ•Âíå‰∫ëÁ´ØÂ§á‰ªΩ</div>`;
                backupItem.addEventListener('click', () => showScreen('backup-screen'));
                listEl.appendChild(backupItem);
            }
            window.renderSettingsScreenProxy = renderSettingsScreen;

            function renderGeneralSettingsScreen() {
                const listEl = document.getElementById('general-settings-list');
                listEl.innerHTML = '';

                // ÁÖßÁâáÂéãÁº© section
                const compressionItem = document.createElement('div');
                compressionItem.className = 'list-item no-hover';
                compressionItem.style.display = 'flex';
                compressionItem.style.flexDirection = 'row';
                compressionItem.style.justifyContent = 'space-between';
                compressionItem.style.alignItems = 'center';
                compressionItem.style.cursor = 'default';

                compressionItem.innerHTML = `
                    <div>
                        <div class="item-title">ÁÖßÁâáÂéãÁº©</div>
                        <div class="item-content">ÂéãÁº©‰∏ä‰º†ÁöÑÁÖßÁâá‰ª•ËäÇÁúÅÂ≠òÂÇ®Á©∫Èó¥</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="photo-compression-toggle" checked>
                        <span class="slider round"></span>
                    </label>
                `;

                listEl.appendChild(compressionItem);

                // Add event listener after element is created
                const toggle = document.getElementById('photo-compression-toggle');
                if (toggle) {
                    toggle.addEventListener('change', async (e) => {
                        state.globalSettings.photoCompression = e.target.checked;
                        await db.globalSettings.put(state.globalSettings);
                    });
                }


            }
            window.renderGeneralSettingsScreenProxy = renderGeneralSettingsScreen;

            // Global calendar variables
            let calendarToday = new Date();
            let currentMonth = calendarToday.getMonth();
            let currentYear = calendarToday.getFullYear();
            let selectedDate = calendarToday;

            function renderCalendarScreen() {
                // Prevent duplicate event listeners by checking if already initialized
                if (!window.calendarInitialized) {
                    window.calendarInitialized = true;

                    // Event listeners for month navigation
                    document.getElementById('prev-month-btn').addEventListener('click', () => {
                        currentMonth--;
                        if (currentMonth < 0) {
                            currentMonth = 11;
                            currentYear--;
                        }
                        updateCalendar();
                    });

                    document.getElementById('next-month-btn').addEventListener('click', () => {
                        currentMonth++;
                        if (currentMonth > 11) {
                            currentMonth = 0;
                            currentYear++;
                        }
                        updateCalendar();
                    });

                    // Event listeners for day navigation
                    document.getElementById('prev-day-btn').addEventListener('click', () => {
                        selectedDate.setDate(selectedDate.getDate() - 1);
                        updateCalendar();
                        updateSelectedDate();
                    });

                    document.getElementById('next-day-btn').addEventListener('click', () => {
                        selectedDate.setDate(selectedDate.getDate() + 1);
                        updateCalendar();
                        updateSelectedDate();
                    });

                    // Calendar add button
                    document.getElementById('calendar-add-btn').addEventListener('click', () => {
                        document.getElementById('add-memory-type-modal').classList.add('visible');
                    });
                }

                function updateCalendar() {
                    // Update month/year display
                    const monthNames = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
                    document.getElementById('calendar-month-year').textContent = `${currentYear}Âπ¥${monthNames[currentMonth]}`;

                    // Generate calendar grid
                    const firstDay = new Date(currentYear, currentMonth, 1);
                    const lastDay = new Date(currentYear, currentMonth + 1, 0);
                    const startDate = new Date(firstDay);
                    startDate.setDate(startDate.getDate() - firstDay.getDay());

                    const calendarGrid = document.getElementById('calendar-grid');
                    calendarGrid.innerHTML = '';

                    for (let i = 0; i < 35; i++) {
                        const date = new Date(startDate);
                        date.setDate(startDate.getDate() + i);

                        const dateElement = document.createElement('div');
                        dateElement.className = 'calendar-date';
                        dateElement.textContent = date.getDate();
                        dateElement.dataset.fullDate = date.toDateString();

                        if (date.getMonth() !== currentMonth) {
                            dateElement.classList.add('other-month');
                        }

                        if (date.toDateString() === calendarToday.toDateString()) {
                            dateElement.classList.add('today');
                        }

                        if (date.toDateString() === selectedDate.toDateString()) {
                            dateElement.classList.add('selected');
                        }

                        dateElement.addEventListener('click', () => {
                            selectedDate = new Date(date);
                            updateCalendar();
                            updateSelectedDate();
                        });

                        calendarGrid.appendChild(dateElement);
                    }

                    // Add memory indicators after calendar is built
                    addMemoryIndicators();
                }

                // Function to add memory indicators to calendar dates
                async function addMemoryIndicators() {
                    try {
                        // Get all memories
                        const allMemories = await db.memories.toArray();

                        // Group memories by date and categorize by type
                        const memoriesByDate = {};
                        allMemories.forEach(memory => {
                            let memoryDate;

                            if (memory.type === 'ai_generated') {
                                memoryDate = new Date(memory.timestamp);
                            } else if (memory.type === 'countdown' && memory.targetDate) {
                                memoryDate = new Date(memory.targetDate);
                            } else if (memory.type === 'meetup') {
                                memoryDate = new Date(memory.timestamp);
                            } else {
                                return;
                            }

                            const dateKey = memoryDate.toDateString();
                            if (!memoriesByDate[dateKey]) {
                                memoriesByDate[dateKey] = {
                                    userMemory: false,
                                    aiMemory: false,
                                    countdown: false,
                                    meetup: false
                                };
                            }

                            // Categorize memory types
                            if (memory.type === 'countdown') {
                                memoriesByDate[dateKey].countdown = true;
                            } else if (memory.type === 'meetup') {
                                memoriesByDate[dateKey].meetup = true;
                            } else if (memory.type === 'ai_generated') {
                                if (memory.chatId === 'manual') {
                                    memoriesByDate[dateKey].userMemory = true;
                                } else {
                                    memoriesByDate[dateKey].aiMemory = true;
                                }
                            }
                        });

                        // Add indicators to calendar dates
                        document.querySelectorAll('.calendar-date').forEach(dateElement => {
                            // Remove existing indicators
                            const existingIndicators = dateElement.querySelector('.memory-indicators');
                            if (existingIndicators) {
                                existingIndicators.remove();
                            }

                            // Get the actual date for this element
                            const dateKey = dateElement.dataset.fullDate;

                            // Check if this date has memories
                            if (memoriesByDate[dateKey]) {
                                const indicatorsContainer = document.createElement('div');
                                indicatorsContainer.className = 'memory-indicators';

                                // Add dots in order: blue (user), yellow (AI), purple (countdown)
                                if (memoriesByDate[dateKey].userMemory) {
                                    const dot = document.createElement('div');
                                    dot.className = 'memory-indicator user-memory';
                                    indicatorsContainer.appendChild(dot);
                                }

                                if (memoriesByDate[dateKey].aiMemory) {
                                    const dot = document.createElement('div');
                                    dot.className = 'memory-indicator ai-memory';
                                    indicatorsContainer.appendChild(dot);
                                }

                                if (memoriesByDate[dateKey].countdown) {
                                    const dot = document.createElement('div');
                                    dot.className = 'memory-indicator countdown';
                                    indicatorsContainer.appendChild(dot);
                                }

                                if (memoriesByDate[dateKey].meetup) {
                                    const dot = document.createElement('div');
                                    dot.className = 'memory-indicator meetup';
                                    indicatorsContainer.appendChild(dot);
                                }

                                dateElement.appendChild(indicatorsContainer);
                            }
                        });



                    } catch (error) {
                        console.error('Error adding memory indicators:', error);
                    }
                }

                async function updateSelectedDate() {
                    const options = { month: 'long', day: 'numeric' };
                    const dateStr = selectedDate.toLocaleDateString('zh-CN', options);
                    document.getElementById('selected-date-display').textContent = dateStr;

                    // NEW: Load and display memories for selected date
                    const memories = await getMemoriesForDate(selectedDate);
                    renderCalendarMemories(memories);
                }



                // Initialize calendar
                updateCalendar();
                updateSelectedDate();

                // Refresh status indicators to show current meetup state
                setTimeout(() => {
                    if (typeof refreshCalendarStatusIndicators === 'function') {
                        refreshCalendarStatusIndicators();
                    }
                }, 100); // Small delay to ensure DOM is updated
            }

            // NEW: Function to get memories for a specific date
            async function getMemoriesForDate(selectedDate) {
                try {
                    // Use same query as memories screen - completely safe
                    const allMemories = await db.memories.toArray();


                    // Filter memories for the selected date
                    const selectedDateStr = selectedDate.toDateString();
                    const memoriesForDate = allMemories.filter(memory => {
                        let memoryDate;

                        // For regular memories, use timestamp (creation date)
                        if (memory.type === 'ai_generated') {
                            memoryDate = new Date(memory.timestamp);
                        }
                        // For countdowns, use targetDate (appointment date)
                        else if (memory.type === 'countdown' && memory.targetDate) {
                            memoryDate = new Date(memory.targetDate);
                        }
                        // For date mode events, use targetDate if available, otherwise timestamp
                        else if (memory.type === 'meetup') {
                            // Use targetDate if it exists (for events that were originally countdowns)
                            // Otherwise use timestamp (for events that were originally meetups)
                            memoryDate = memory.targetDate ? new Date(memory.targetDate) : new Date(memory.timestamp);

                        }
                        else {
                            return false; // Skip if no valid date
                        }

                        return memoryDate.toDateString() === selectedDateStr;
                    });


                    return memoriesForDate;

                } catch (error) {
                    console.error('Error loading memories:', error);
                    return [];
                }
            }

            // NEW: Function to display memories in the events section
            function renderCalendarMemories(memories) {
                const eventsListEl = document.getElementById('calendar-events-list');

                if (memories.length === 0) {

                    eventsListEl.innerHTML = '<div class="no-events-message">Ê≤°Êúâ‰∫ã‰ª∂</div>';
                    return;
                }

                // Sort memories by their actual date/time (most recent first)
                memories.sort((a, b) => {
                    let aTime, bTime;

                    // For memories, use timestamp (actual memory time)
                    if (a.type === 'ai_generated') {
                        aTime = a.timestamp;
                    }
                    // For countdowns, use targetDate (actual event time)
                    else if (a.type === 'countdown' && a.targetDate) {
                        aTime = a.targetDate;
                    }
                    // For date mode, use targetDate if available (for converted countdowns), otherwise timestamp
                    else if (a.type === 'meetup') {
                        aTime = a.targetDate ? a.targetDate : a.timestamp;
                    } else {
                        aTime = a.timestamp; // fallback
                    }

                    if (b.type === 'ai_generated') {
                        bTime = b.timestamp;
                    }
                    else if (b.type === 'countdown' && b.targetDate) {
                        bTime = b.targetDate;
                    }
                    else if (b.type === 'meetup') {
                        bTime = b.targetDate ? b.targetDate : b.timestamp;
                    } else {
                        bTime = b.timestamp; // fallback
                    }

                    return bTime - aTime; // Most recent first
                });

                eventsListEl.innerHTML = '';

                memories.forEach(memory => {
                    const memoryItem = document.createElement('div');
                    memoryItem.className = 'calendar-memory-item';
                    memoryItem.dataset.memoryId = memory.id;

                    // Add type-specific class for styling
                    if (memory.type === 'ai_generated') {
                        memoryItem.classList.add('memory-type');
                    } else if (memory.type === 'countdown') {
                        memoryItem.classList.add('countdown-type');
                    } else if (memory.type === 'meetup') {
                        memoryItem.classList.add('meetup-type');
                    }

                    // Format time for display
                    let timeStr = '';
                    if (memory.type === 'ai_generated') {
                        const time = new Date(memory.timestamp);
                        timeStr = time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    } else if (memory.type === 'countdown' && memory.targetDate) {
                        const time = new Date(memory.targetDate);
                        timeStr = time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    } else if (memory.type === 'meetup') {
                        // Use targetDate if available (for events that were originally countdowns)
                        // Otherwise use timestamp (for events that were originally meetups)
                        const time = memory.targetDate ? new Date(memory.targetDate) : new Date(memory.timestamp);
                        timeStr = time.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                    }

                    // Get character avatar - fix for manual memories
                    let authorAvatar = 'https://files.catbox.moe/q6z5fc.jpeg'; // default avatar
                    if (memory.chatId === 'manual') {
                        // For manually added memories, use user's avatar from ‰∫∫ËÆæÂ∫ì
                        authorAvatar = state.qzoneSettings.avatar || 'https://files.catbox.moe/q6z5fc.jpeg';
                    } else if (state.chats[memory.chatId]) {
                        authorAvatar = state.chats[memory.chatId].settings.aiAvatar;
                    }

                    // Determine status indicator for meetup/countdown events
                    let statusIndicator = '';
                    let typeLabel = '';

                    if (memory.type === 'meetup') {
                        // Check if this is the currently active meetup
                        if (window.activeMeetupEventId === memory.id) {
                            statusIndicator = '<span class="meetup-status-indicator active">üü¢ ËøõË°å‰∏≠</span>';
                            typeLabel = 'ËßÅÈù¢';
                        } else if (hasActualMeetupHistory(memory)) {
                            statusIndicator = '<span class="meetup-indicator"><svg width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="10" width="36" height="32" rx="2" stroke="currentColor" stroke-width="4" stroke-linejoin="round"/><path d="M14 6V14" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M34 6V14" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 18H42" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><circle cx="16" cy="28" r="2" fill="currentColor"/><circle cx="24" cy="28" r="2" fill="currentColor"/><circle cx="32" cy="28" r="2" fill="currentColor"/><path d="M20 32C20 30 22 30 24 32C26 30 28 30 28 32" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>';
                            typeLabel = 'ËßÅÈù¢';
                        } else {
                            // No indicator for meetup templates - absence of calendar icon indicates no history
                            statusIndicator = '';
                            typeLabel = 'ËßÅÈù¢';
                        }
                    } else if (memory.type === 'countdown') {
                        // No indicator for countdown events - absence of calendar icon indicates it's a template
                        statusIndicator = '';
                        typeLabel = 'Á∫¶ÂÆö';
                    } else {
                        typeLabel = 'ÂõûÂøÜ';
                    }

                    // Create memory display using exact same structure as memories screen
                    memoryItem.innerHTML = `
                        <div class="memory-header">
                            <img class="memory-avatar" src="${authorAvatar}" alt="${memory.authorName}">
                            <div class="memory-info">
                                <div class="memory-nickname">${memory.authorName}</div>
                                <div class="memory-timestamp">${timeStr} ‚Ä¢ ${typeLabel}</div>
                            </div>
                            <div class="memory-actions">
                                ${statusIndicator}
                                <button class="post-actions-btn" onclick="showMemoryActions('${memory.id}')" style="-webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; -webkit-user-select: none; border: none; background: none; font-family: inherit; font-size: 24px; font-weight: inherit;">‚Ä¶</button>
                            </div>
                        </div>
                        <div class="memory-content">${memory.description}</div>
                    `;



                    // Enhanced click handler for all meetup and countdown events
                    if (memory.type === 'meetup' || memory.type === 'countdown') {
                        memoryItem.style.cursor = 'pointer';
                        memoryItem.addEventListener('click', function (e) {
                            // Don't trigger if clicking on the actions button
                            if (e.target.closest('.post-actions-btn')) {
                                return;
                            }
                            handleCalendarEventClick(memory);
                        });
                    }

                    eventsListEl.appendChild(memoryItem);
                });



                // Add 8px invisible spacer at bottom - updated
                const spacer = document.createElement('div');
                spacer.style.height = '8px';
                eventsListEl.appendChild(spacer);
            }

            // Helper function to check if a memory has actual meetup history
            function hasActualMeetupHistory(memory) {
                if (memory.type !== 'meetup') return false;
                if (!memory.meetupData) return false;
                if (!memory.meetupData.messages) return false;
                return memory.meetupData.messages.length > 0;
            }

            // Make helper function globally available for calendar rendering
            window.hasActualMeetupHistory = hasActualMeetupHistory;

            // Enhanced calendar event click handler
            function handleCalendarEventClick(memory) {


                if (memory.type === 'meetup') {
                    // Scenario 1: Check if this is the currently active meetup
                    if (window.activeMeetupEventId === memory.id) {

                        // Resume active meetup - go directly to meetup screen
                        showScreen('meetup-screen');
                        return;
                    }

                    // Scenario 2: Check if it has completed history
                    if (hasActualMeetupHistory(memory)) {
                        // View completed meetup history
                        openMeetupHistory(memory.id);
                        return;
                    }
                }

                // Scenario 3: For AI-created events or events without history
                if (memory.type === 'countdown' || (memory.type === 'meetup' && !hasActualMeetupHistory(memory))) {

                    // Start new meetup with prefilled data
                    openMeetupCreationModalWithPrefill(memory);
                }
            }

            // Function to open meetup creation modal with prefilled data
            function openMeetupCreationModalWithPrefill(memory) {


                // Only proceed if we have a valid chatId (not manual events for now)
                if (!memory.chatId || memory.chatId === 'manual') {

                    // For user-created events, we'll handle this in the future
                    showCustomAlert('ÊèêÁ§∫', 'Áî®Êà∑ÂàõÂª∫ÁöÑ‰∫ã‰ª∂ÊöÇ‰∏çÊîØÊåÅÁõ¥Êé•ËøõÂÖ•ËßÅÈù¢Ê®°ÂºèÔºåËØ∑‰ªéËÅäÂ§©ÁïåÈù¢ÂºÄÂßãËßÅÈù¢„ÄÇ');
                    return;
                }

                // Check if the chat still exists
                const chat = state.chats[memory.chatId];
                if (!chat) {
                    showCustomAlert('ÈîôËØØ', 'Êó†Ê≥ïÊâæÂà∞Áõ∏ÂÖ≥ÁöÑËÅäÂ§©ÂØπË±°ÔºåÂèØËÉΩÂ∑≤Ë¢´Âà†Èô§„ÄÇ');
                    return;
                }

                // Check if it's a group chat (meetup mode should be for individual chats)
                if (chat.isGroup) {
                    showCustomAlert('ÊèêÁ§∫', 'ËßÅÈù¢Ê®°Âºè‰ªÖÊîØÊåÅÂçï‰∫∫ËÅäÂ§©Ôºå‰∏çÊîØÊåÅÁæ§ËÅä„ÄÇ');
                    return;
                }

                // Set up the chat context
                window.currentDateChatContext = {
                    chatId: memory.chatId,
                    chatName: chat.name || 'ËÅäÂ§©ÂØπË±°',
                    aiName: chat.name || 'AI',
                    isGroup: chat.isGroup || false,
                    originalMemoryId: memory.id // Store the original memory ID
                };



                // Prefill the modal with event data
                document.getElementById('meetup-location-input').value = '';
                document.getElementById('meetup-title-input').value = memory.description || '';

                // Show the modal
                const modal = document.getElementById('meetup-creation-modal');
                modal.classList.add('visible');
            }

            // Function to refresh calendar status indicators (useful when meetup status changes)
            function refreshCalendarStatusIndicators() {
                const calendarItems = document.querySelectorAll('.calendar-memory-item');
                calendarItems.forEach(item => {
                    const memoryId = item.dataset.memoryId;
                    if (memoryId && window.activeMeetupEventId === parseInt(memoryId)) {
                        // Update to show active status
                        const statusIndicator = item.querySelector('.meetup-status-indicator');
                        if (statusIndicator && !statusIndicator.classList.contains('active')) {
                            statusIndicator.textContent = 'üü¢ ËøõË°å‰∏≠';
                            statusIndicator.className = 'meetup-status-indicator active';
                        }
                    }
                });
            }

            window.renderCalendarScreenProxy = renderCalendarScreen;
            window.showMemoryActions = showMemoryActions;
            window.handleCalendarEventClick = handleCalendarEventClick;
            window.hasActualMeetupHistory = hasActualMeetupHistory;
            window.refreshCalendarStatusIndicators = refreshCalendarStatusIndicators;
            window.openMeetupCreationModalWithPrefill = openMeetupCreationModalWithPrefill;



            function openWorldBookEditor(bookId) { editingWorldBookId = bookId; const book = state.worldBooks.find(wb => wb.id === bookId); if (!book) return; document.getElementById('world-book-editor-title').textContent = book.name; document.getElementById('world-book-name-input').value = book.name; document.getElementById('world-book-content-input').value = book.content; showScreen('world-book-editor-screen'); }

            function renderStickerPanel() { const grid = document.getElementById('sticker-grid'); grid.innerHTML = ''; if (state.userStickers.length === 0) { grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">Â§ß‰∫∫ËØ∑ÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÊàñ‚Äú‰∏ä‰º†‚ÄùÊù•Ê∑ªÂä†‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™Ë°®ÊÉÖÂêßÔºÅ</p>'; return; } state.userStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.style.backgroundImage = `url(${sticker.url})`; item.title = sticker.name; item.addEventListener('click', () => sendSticker(sticker)); addLongPressListener(item, () => { const existingDeleteBtn = item.querySelector('.delete-btn'); if (existingDeleteBtn) return; const deleteBtn = document.createElement('div'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('Âà†Èô§Ë°®ÊÉÖ', `Á°ÆÂÆöË¶ÅÂà†Èô§Ë°®ÊÉÖ "${sticker.name}" ÂêóÔºü`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.userStickers.delete(sticker.id); state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); renderStickerPanel(); } }; item.appendChild(deleteBtn); deleteBtn.style.display = 'block'; setTimeout(() => item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true }), 3000); }); grid.appendChild(item); }); }

            // Global variable to track current sticker pack
            let currentStickerPack = 'all';

            // Storage for sticker pack data
            let stickerPackData = {
                'all': {
                    name: 'ÂÖ®ÈÉ®Ë°®ÊÉÖ',
                    icon: ''
                },
                'pack1': {
                    name: 'Ë°®ÊÉÖÂåÖ 2',
                    icon: 'https://files.catbox.moe/r1khrr.gif'
                }
            };

            // Store the original renderStickerPanel function
            const originalRenderStickerPanel = renderStickerPanel;

            // Override renderStickerPanel with pack filtering
            function renderStickerPanel() {
                const grid = document.getElementById('sticker-grid');
                grid.innerHTML = '';

                // Always add the "add sticker" square as the first item
                const addSquare = document.createElement('div');
                addSquare.className = 'add-sticker-square';
                addSquare.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                `;
                addSquare.addEventListener('click', () => {
                    // Hide the sticker panel first
                    document.getElementById('sticker-panel').classList.remove('visible');

                    // Use the preset-actions-modal for consistency
                    const actionsModal = document.getElementById('preset-actions-modal');
                    const modalContent = actionsModal.querySelector('.custom-modal-footer');

                    // Populate modal with add sticker options
                    modalContent.innerHTML = `
                        <button data-action="add-url">Ê∑ªÂä† (URL)</button>
                        <button data-action="upload">‰∏ä‰º†Êñá‰ª∂</button>
                        <button data-action="cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
                    `;

                    // Show modal
                    actionsModal.classList.add('visible');

                    // Handle button clicks
                    const handleActionClick = async (e) => {
                        const action = e.target.dataset.action;
                        if (!action) return;

                        actionsModal.classList.remove('visible');
                        modalContent.removeEventListener('click', handleActionClick);

                        switch (action) {
                            case 'add-url':
                                // URL option
                                const url = await showCustomPrompt("Ê∑ªÂä†Ë°®ÊÉÖ(URL)", "ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖÁöÑÂõæÁâáURL");
                                if (!url || !url.trim().startsWith('http')) {
                                    if (url) alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURL (‰ª•httpÂºÄÂ§¥)");
                                    document.getElementById('sticker-panel').classList.add('visible');
                                    return;
                                }
                                const name = await showCustomPrompt("ÂëΩÂêçË°®ÊÉÖ", "ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂëΩÂêç (‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÁñëÊÉë)");
                                if (name && name.trim()) {
                                    const newSticker = {
                                        id: 'sticker_' + Date.now(),
                                        url: url.trim(),
                                        name: name.trim(),
                                        order: state.userStickers.length,
                                        packId: currentStickerPack
                                    };
                                    await db.userStickers.add(newSticker);
                                    state.userStickers.push(newSticker);
                                    // Show sticker panel again and refresh
                                    document.getElementById('sticker-panel').classList.add('visible');
                                    renderStickerPanel();
                                } else if (name !== null) {
                                    alert("Ë°®ÊÉÖÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ");
                                    document.getElementById('sticker-panel').classList.add('visible');
                                } else {
                                    // User cancelled naming, show panel again
                                    document.getElementById('sticker-panel').classList.add('visible');
                                }
                                break;
                            case 'upload':
                                // Upload option
                                document.getElementById('sticker-upload-input').click();
                                break;
                            case 'cancel':
                                // Just show sticker panel again
                                document.getElementById('sticker-panel').classList.add('visible');
                                break;
                        }
                    };

                    modalContent.addEventListener('click', handleActionClick);
                });
                grid.appendChild(addSquare);

                // Filter stickers based on current pack
                let stickersToShow = state.userStickers.filter(sticker => sticker.packId === currentStickerPack);

                // Add message if no stickers (but still show the add square)
                if (stickersToShow.length === 0) {
                    const message = document.createElement('p');
                    message.style.cssText = 'text-align:center; color: var(--text-secondary); grid-column: 1 / -1; margin-top: 20px;';
                    message.textContent = 'Ëøô‰∏™Ë°®ÊÉÖÂåÖËøòÊ≤°ÊúâË°®ÊÉÖÔºåÁÇπÂáª + Êù•Ê∑ªÂä†';
                    grid.appendChild(message);
                    return;
                }

                stickersToShow.forEach(sticker => {
                    const item = document.createElement('div');
                    item.className = 'sticker-item';
                    item.style.backgroundImage = `url(${sticker.url})`;
                    item.title = sticker.name;

                    if (isArrangeMode) {
                        // In arrange mode: add delete button and touch-based drag functionality
                        item.style.position = 'relative';
                        item.style.cursor = 'move'; // Show move cursor to indicate draggable

                        // Add red delete button
                        const deleteBtn = document.createElement('div');
                        deleteBtn.className = 'arrange-delete-btn';
                        deleteBtn.innerHTML = '√ó';
                        deleteBtn.style.cssText = `
                            position: absolute;
                            top: -8px;
                            right: -8px;
                            width: 20px;
                            height: 20px;
                            background: #ff3b30;
                            color: white;
                            border-radius: 50%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 14px;
                            font-weight: bold;
                            cursor: pointer;
                            z-index: 10;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                        `;

                        deleteBtn.onclick = async (e) => {
                            e.stopPropagation();
                            const confirmed = await showCustomConfirm('Âà†Èô§Ë°®ÊÉÖ', `Á°ÆÂÆöË¶ÅÂà†Èô§Ë°®ÊÉÖ "${sticker.name}" ÂêóÔºü`, { confirmButtonClass: 'btn-danger' });
                            if (confirmed) {
                                await db.userStickers.delete(sticker.id);
                                state.userStickers = state.userStickers.filter(s => s.id !== sticker.id);
                                renderStickerPanel();
                            }
                        };

                        item.appendChild(deleteBtn);

                        // Add touch-based drag functionality for mobile
                        let dragState = {
                            isDragging: false,
                            draggedElement: null,
                            draggedId: null,
                            startX: 0,
                            startY: 0,
                            currentX: 0,
                            currentY: 0
                        };

                        item.addEventListener('touchstart', (e) => {
                            const touch = e.touches[0];
                            dragState.startX = touch.clientX;
                            dragState.startY = touch.clientY;
                            dragState.draggedElement = item;
                            dragState.draggedId = sticker.id;

                            // Start drag after a short delay to distinguish from tap
                            setTimeout(() => {
                                if (dragState.draggedElement === item) {
                                    dragState.isDragging = true;
                                    item.style.opacity = '0.5';
                                    item.style.transform = 'scale(1.1)';
                                    item.style.zIndex = '1000';
                                    item.style.pointerEvents = 'none';
                                }
                            }, 150);
                        }, { passive: false });

                        item.addEventListener('touchmove', (e) => {
                            if (!dragState.isDragging || dragState.draggedElement !== item) return;

                            e.preventDefault();
                            const touch = e.touches[0];
                            dragState.currentX = touch.clientX;
                            dragState.currentY = touch.clientY;

                            // Move the dragged item
                            const deltaX = dragState.currentX - dragState.startX;
                            const deltaY = dragState.currentY - dragState.startY;
                            item.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(1.1)`;

                            // Find element under touch point
                            const elementBelow = document.elementFromPoint(dragState.currentX, dragState.currentY);
                            const targetSticker = elementBelow?.closest('.sticker-item');

                            // Reset all sticker highlights
                            document.querySelectorAll('.sticker-item').forEach(s => {
                                if (s !== item) {
                                    s.style.boxShadow = '';
                                    s.style.transform = '';
                                }
                            });

                            // Highlight drop target
                            if (targetSticker && targetSticker !== item) {
                                targetSticker.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                                targetSticker.style.transform = 'scale(1.05)';
                            }
                        }, { passive: false });

                        item.addEventListener('touchend', async (e) => {
                            if (!dragState.isDragging || dragState.draggedElement !== item) {
                                dragState = { isDragging: false, draggedElement: null, draggedId: null, startX: 0, startY: 0, currentX: 0, currentY: 0 };
                                return;
                            }

                            // Find element under touch point
                            const elementBelow = document.elementFromPoint(dragState.currentX, dragState.currentY);
                            const targetSticker = elementBelow?.closest('.sticker-item');

                            // Reset dragged item appearance
                            item.style.opacity = '1';
                            item.style.transform = '';
                            item.style.zIndex = '';
                            item.style.pointerEvents = '';

                            // Reset all highlights
                            document.querySelectorAll('.sticker-item').forEach(s => {
                                s.style.boxShadow = '';
                                s.style.transform = '';
                            });

                            // Perform reorder if dropped on another sticker
                            if (targetSticker && targetSticker !== item) {
                                const targetId = targetSticker.style.backgroundImage.match(/url\("([^"]+)"\)/)?.[1];
                                const targetStickerData = state.userStickers.find(s => s.url === targetId);

                                if (targetStickerData) {
                                    const draggedIndex = state.userStickers.findIndex(s => s.id === dragState.draggedId);
                                    const targetIndex = state.userStickers.findIndex(s => s.id === targetStickerData.id);

                                    if (draggedIndex !== -1 && targetIndex !== -1) {
                                        // Remove dragged sticker from its current position
                                        const [draggedSticker] = state.userStickers.splice(draggedIndex, 1);

                                        // Insert it at the target position
                                        state.userStickers.splice(targetIndex, 0, draggedSticker);

                                        // Update database with order information
                                        await db.userStickers.clear();
                                        for (let i = 0; i < state.userStickers.length; i++) {
                                            const stickerItem = { ...state.userStickers[i], order: i };
                                            await db.userStickers.add(stickerItem);
                                        }

                                        // Re-render to show new order
                                        renderStickerPanel();
                                    }
                                }
                            }

                            // Reset drag state
                            dragState = { isDragging: false, draggedElement: null, draggedId: null, startX: 0, startY: 0, currentX: 0, currentY: 0 };
                        }, { passive: false });
                    } else {
                        // Normal mode: click to send, long press for options
                        item.addEventListener('click', () => sendSticker(sticker));
                        addLongPressListener(item, () => {
                            if (isSelectionMode) return;
                            showStickerOptionsModal(sticker);
                        });
                    }

                    grid.appendChild(item);
                });
            }

            function initializeStickerPackTabs() {
                const tabsContainer = document.getElementById('sticker-pack-tabs');
                if (!tabsContainer) return;

                // Get saved order or use default order
                const savedOrder = state.globalSettings?.stickerPackOrder || Object.keys(stickerPackData);
                
                // Get all existing tabs with data-pack attribute (excluding add button)
                const existingTabs = Array.from(tabsContainer.querySelectorAll('.sticker-pack-tab[data-pack]'));
                
                // Reorder existing tabs according to saved order
                savedOrder.forEach(packId => {
                    const existingTab = existingTabs.find(tab => tab.dataset.pack === packId);
                    if (existingTab) {
                        // Move tab to end (which will be in the correct order)
                        tabsContainer.appendChild(existingTab);
                        
                        // Update tab icon if needed
                        if (stickerPackData[packId] && stickerPackData[packId].icon) {
                            updateStickerPackTabIcon(packId, stickerPackData[packId].icon);
                        }
                    } else if (stickerPackData[packId]) {
                        // Create new tab for packs that don't exist in DOM yet
                        const packData = stickerPackData[packId];
                        const newTab = document.createElement('div');
                        newTab.className = 'sticker-pack-tab';
                        newTab.setAttribute('data-pack', packId);

                        const packIcon = document.createElement('div');
                        packIcon.className = 'pack-icon';

                        if (packData.icon && packData.icon.trim()) {
                            packIcon.innerHTML = `<img src="${packData.icon}" alt="${packId}">`;
                        } else {
                            // Use default empty icon
                            packIcon.innerHTML = `
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                    xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                </svg>
                            `;
                        }

                        newTab.appendChild(packIcon);
                        tabsContainer.appendChild(newTab);
                    }
                });
                
                // Add any remaining tabs that weren't in the saved order
                existingTabs.forEach(tab => {
                    const packId = tab.dataset.pack;
                    if (!savedOrder.includes(packId)) {
                        tabsContainer.appendChild(tab);
                    }
                });

                // Add click event listeners to pack tabs
                tabsContainer.addEventListener('click', (e) => {
                    const tab = e.target.closest('.sticker-pack-tab');
                    if (!tab) return;

                    // Skip if it's the add pack button or in arrange mode
                    if (tab.id === 'add-pack-btn' || isPackArrangeMode) return;

                    const packId = tab.dataset.pack;
                    if (packId) {
                        switchStickerPack(packId);
                    }
                });

                // Add long press listeners to pack tabs for arrange mode
                document.querySelectorAll('.sticker-pack-tab[data-pack]').forEach(tab => {
                    addLongPressListener(tab, () => {
                        if (!isPackArrangeMode) {
                            enterPackArrangeMode();
                        }
                    });
                });

                // Set active tab based on currentStickerPack
                document.querySelectorAll('.sticker-pack-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                const activeTab = document.querySelector(`[data-pack="${currentStickerPack}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
            }

            function switchStickerPack(packId) {
                currentStickerPack = packId;

                // Update active tab
                document.querySelectorAll('.sticker-pack-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-pack="${packId}"]`).classList.add('active');

                // Re-render sticker grid
                renderStickerPanel();
            }

            // ‚ñº‚ñº‚ñº Sticker Pack Edit Modal Functions ‚ñº‚ñº‚ñº
            function openStickerPackEditModal() {
                // Get current pack data from storage
                const packData = stickerPackData[currentStickerPack] || { name: '', icon: '' };

                // Populate modal fields
                document.getElementById('sticker-pack-name-input').value = packData.name;
                document.getElementById('sticker-pack-icon-input').value = packData.icon;

                // Show/hide delete button based on pack type
                const deleteBtn = document.getElementById('delete-sticker-pack-btn');
                if (currentStickerPack === 'all' || currentStickerPack === 'pack1') {
                    deleteBtn.style.display = 'none';
                } else {
                    deleteBtn.style.display = 'block';
                }

                // Show modal
                document.getElementById('sticker-pack-edit-modal').classList.add('visible');

                // Focus on first input field
                document.getElementById('sticker-pack-name-input').focus();
            }

            function closeStickerPackEditModal() {
                document.getElementById('sticker-pack-edit-modal').classList.remove('visible');
            }

            async function saveStickerPackEdit() {
                const name = document.getElementById('sticker-pack-name-input').value.trim();
                const iconUrl = document.getElementById('sticker-pack-icon-input').value.trim();

                if (!name) {
                    alert('ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖÂêçÁß∞');
                    return;
                }

                // Save data to storage
                if (!stickerPackData[currentStickerPack]) {
                    stickerPackData[currentStickerPack] = {};
                }
                stickerPackData[currentStickerPack].name = name;
                stickerPackData[currentStickerPack].icon = iconUrl;

                // Save to database via globalSettings
                if (!state.globalSettings.stickerPackData) {
                    state.globalSettings.stickerPackData = {};
                }
                state.globalSettings.stickerPackData = { ...stickerPackData };

                try {
                    await db.globalSettings.put(state.globalSettings);
                } catch (error) {
                    console.error('Failed to save sticker pack data:', error);
                }

                // Update the tab icon
                updateStickerPackTabIcon(currentStickerPack, iconUrl);

                // Close modal without alert
                closeStickerPackEditModal();
            }

            function updateStickerPackTabIcon(packId, iconUrl) {
                const tab = document.querySelector(`[data-pack="${packId}"]`);
                if (!tab) return;

                const packIcon = tab.querySelector('.pack-icon');
                if (!packIcon) return;

                if (iconUrl && iconUrl.trim()) {
                    // Replace with image
                    packIcon.innerHTML = `<img src="${iconUrl}" alt="${packId}">`;
                } else {
                    // Use default SVG for 'all' pack, or empty for others
                    if (packId === 'all') {
                        packIcon.innerHTML = `
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                                xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                                <line x1="9" y1="9" x2="9.01" y2="9" />
                                <line x1="15" y1="9" x2="15.01" y2="9" />
                            </svg>
                        `;
                    } else {
                        packIcon.innerHTML = `<div style="width: 24px; height: 24px; background: #ccc; border-radius: 4px;"></div>`;
                    }
                }
            }

            async function deleteStickerPack() {
                // Prevent deleting the 'all' pack
                if (currentStickerPack === 'all') {
                    alert('Êó†Ê≥ïÂà†Èô§ÈªòËÆ§Ë°®ÊÉÖÂåÖ');
                    return;
                }

                const confirmed = await showCustomConfirm('Âà†Èô§Ë°®ÊÉÖÂåÖ', `Á°ÆÂÆöË¶ÅÂà†Èô§Ë°®ÊÉÖÂåÖÂêóÔºüÂåÖÂÜÖÁöÑÊâÄÊúâË°®ÊÉÖ‰πü‰ºöË¢´Âà†Èô§„ÄÇ`, { confirmButtonClass: 'btn-danger' });
                if (!confirmed) return;

                // Remove all stickers from this pack
                const stickersToDelete = state.userStickers.filter(sticker => sticker.packId === currentStickerPack);
                for (const sticker of stickersToDelete) {
                    await db.userStickers.delete(sticker.id);
                }
                state.userStickers = state.userStickers.filter(sticker => sticker.packId !== currentStickerPack);

                // Remove pack data from storage
                delete stickerPackData[currentStickerPack];
                if (state.globalSettings.stickerPackData) {
                    delete state.globalSettings.stickerPackData[currentStickerPack];
                    try {
                        await db.globalSettings.put(state.globalSettings);
                    } catch (error) {
                        console.error('Failed to save sticker pack data:', error);
                    }
                }

                // Remove tab from DOM
                const tab = document.querySelector(`[data-pack="${currentStickerPack}"]`);
                if (tab) {
                    tab.remove();
                }

                // Switch to 'all' pack
                switchStickerPack('all');

                // Close modal
                closeStickerPackEditModal();
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Sticker Pack Edit Modal Functions End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº New Sticker Pack Modal Functions ‚ñº‚ñº‚ñº
            function openNewStickerPackModal() {
                // Clear modal fields
                document.getElementById('new-pack-name-input').value = '';
                document.getElementById('new-pack-icon-input').value = '';

                // Show modal
                document.getElementById('new-sticker-pack-modal').classList.add('visible');

                // Focus on first input field
                document.getElementById('new-pack-name-input').focus();
            }

            function closeNewStickerPackModal() {
                document.getElementById('new-sticker-pack-modal').classList.remove('visible');
            }

            async function createNewStickerPack() {
                const name = document.getElementById('new-pack-name-input').value.trim();
                const iconUrl = document.getElementById('new-pack-icon-input').value.trim();

                if (!name) {
                    alert('ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖÂêçÁß∞');
                    return;
                }

                // Find next available pack ID
                let nextPackId = 'pack1';
                let packNumber = 1;
                while (document.querySelector(`[data-pack="${nextPackId}"]`)) {
                    packNumber++;
                    nextPackId = `pack${packNumber}`;
                }

                // Save data to storage
                if (!stickerPackData[nextPackId]) {
                    stickerPackData[nextPackId] = {};
                }
                stickerPackData[nextPackId].name = name;
                stickerPackData[nextPackId].icon = iconUrl;

                // Save to database via globalSettings
                if (!state.globalSettings.stickerPackData) {
                    state.globalSettings.stickerPackData = {};
                }
                state.globalSettings.stickerPackData = { ...stickerPackData };

                try {
                    await db.globalSettings.put(state.globalSettings);
                } catch (error) {
                    console.error('Failed to save sticker pack data:', error);
                }

                // Create new tab in DOM
                const tabsContainer = document.getElementById('sticker-pack-tabs');

                const newTab = document.createElement('div');
                newTab.className = 'sticker-pack-tab';
                newTab.setAttribute('data-pack', nextPackId);

                const packIcon = document.createElement('div');
                packIcon.className = 'pack-icon';

                if (iconUrl && iconUrl.trim()) {
                    packIcon.innerHTML = `<img src="${iconUrl}" alt="${nextPackId}">`;
                } else {
                    // Use default empty icon
                    packIcon.innerHTML = `
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
                            xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        </svg>
                    `;
                }

                newTab.appendChild(packIcon);
                tabsContainer.appendChild(newTab);

                // Switch to the new pack
                switchStickerPack(nextPackId);

                // Close modal
                closeNewStickerPackModal();
            }
            // ‚ñ≤‚ñ≤‚ñ≤ New Sticker Pack Modal Functions End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº Sticker Options Modal Functions ‚ñº‚ñº‚ñº
            let isArrangeMode = false;
            let selectedStickerForMove = null;
            let isPackArrangeMode = false;

            function showStickerOptionsModal(sticker) {
                // Hide the sticker panel first
                document.getElementById('sticker-panel').classList.remove('visible');

                // Use the preset-actions-modal for consistency
                const actionsModal = document.getElementById('preset-actions-modal');
                const modalContent = actionsModal.querySelector('.custom-modal-footer');

                // Populate modal with sticker options (removed delete button)
                modalContent.innerHTML = `
                    <button data-action="move-to-pack">ÁßªÂä®Âà∞Ë°®ÊÉÖÂåÖ</button>
                    <button data-action="arrange">Êï¥ÁêÜË°®ÊÉÖ</button>
                    <button data-action="cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
                `;

                // Show modal
                actionsModal.classList.add('visible');

                // Handle button clicks
                const handleActionClick = async (e) => {
                    const action = e.target.dataset.action;
                    if (!action) return;

                    actionsModal.classList.remove('visible');
                    modalContent.removeEventListener('click', handleActionClick);

                    switch (action) {
                        case 'move-to-pack':
                            // Show sticker pack selection modal
                            selectedStickerForMove = sticker;
                            showMoveStickerModal();
                            break;
                        case 'arrange':
                            // Enter arrange mode and show sticker panel
                            enterArrangeMode();
                            break;
                        case 'cancel':
                            // Just show sticker panel again
                            document.getElementById('sticker-panel').classList.add('visible');
                            break;
                    }
                };

                modalContent.addEventListener('click', handleActionClick);
            }

            function enterArrangeMode() {
                isArrangeMode = true;

                // Update header to show arrange mode
                const header = document.getElementById('sticker-panel-header');
                const title = header.querySelector('.title');
                const editBtn = header.querySelector('#edit-sticker-pack-btn');
                const cancelBtn = header.querySelector('#close-sticker-panel-btn');

                title.textContent = 'Êï¥ÁêÜË°®ÊÉÖ';
                editBtn.textContent = 'ÂÆåÊàê';
                editBtn.onclick = exitArrangeMode;

                // Update cancel button to exit arrange mode without saving
                cancelBtn.onclick = () => {
                    exitArrangeMode();
                };

                // Show sticker panel and re-render with arrange mode
                document.getElementById('sticker-panel').classList.add('visible');
                renderStickerPanel();
            }

            function exitArrangeMode() {
                isArrangeMode = false;

                // Restore header
                const header = document.getElementById('sticker-panel-header');
                const title = header.querySelector('.title');
                const editBtn = header.querySelector('#edit-sticker-pack-btn');
                const cancelBtn = header.querySelector('#close-sticker-panel-btn');

                title.textContent = 'ÊàëÁöÑË°®ÊÉÖ';
                editBtn.textContent = 'ÁºñËæë';
                editBtn.onclick = openStickerPackEditModal;

                // Restore cancel button to close panel
                cancelBtn.onclick = () => {
                    document.getElementById('sticker-panel').classList.remove('visible');
                };

                // Re-render without arrange mode
                renderStickerPanel();
            }

            // ‚ñº‚ñº‚ñº Move Sticker to Pack Functions ‚ñº‚ñº‚ñº
            function showMoveStickerModal() {
                // Get all available sticker packs from existing tabs (excluding "all")
                const availablePacks = [];
                const packTabs = document.querySelectorAll('.sticker-pack-tab[data-pack]');

                packTabs.forEach(tab => {
                    const packId = tab.dataset.pack;
                    if (packId !== 'all') {
                        const packName = stickerPackData[packId]?.name || `Ë°®ÊÉÖÂåÖ${packId.replace('pack', '')}`;
                        availablePacks.push({
                            id: packId,
                            name: packName
                        });
                    }
                });

                // Generate pack list HTML (radio buttons)
                const packListHtml = availablePacks.map(pack => `
                    <div class="pack-selection-item" onclick="selectPackForMove('${pack.id}')">
                        <input type="radio" name="pack-selection" id="pack-${pack.id}" data-pack-id="${pack.id}">
                        <div class="pack-selection-info">
                            <div class="pack-selection-name">${pack.name}</div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('sticker-pack-selection-list').innerHTML = packListHtml;
                document.getElementById('move-sticker-modal').classList.add('visible');
            }

            function hideMoveStickerModal() {
                document.getElementById('move-sticker-modal').classList.remove('visible');
                selectedStickerForMove = null;
            }

            function selectPackForMove(packId) {
                // Update radio button selection
                const radioButton = document.getElementById(`pack-${packId}`);
                if (radioButton) {
                    radioButton.checked = true;
                }
            }

            async function confirmMoveSticker() {
                const selectedRadio = document.querySelector('input[name="pack-selection"]:checked');
                if (!selectedRadio) {
                    alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™Ë°®ÊÉÖÂåÖ');
                    return;
                }

                const targetPackId = selectedRadio.dataset.packId;

                if (!selectedStickerForMove) {
                    alert('Êú™ÈÄâÊã©Ë°®ÊÉÖ');
                    return;
                }

                // Update sticker's pack assignment
                const stickerIndex = state.userStickers.findIndex(s => s.id === selectedStickerForMove.id);
                if (stickerIndex !== -1) {
                    state.userStickers[stickerIndex].packId = targetPackId;

                    // Update database
                    await db.userStickers.put(state.userStickers[stickerIndex]);

                    // Hide modal and refresh sticker panel
                    hideMoveStickerModal();
                    document.getElementById('sticker-panel').classList.add('visible');
                    renderStickerPanel();
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Move Sticker to Pack Functions End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº Pack Arrange Mode Functions ‚ñº‚ñº‚ñº
            // Variables declared above: isPackArrangeMode, currentStickerPack, stickerPackData

            function enterPackArrangeMode() {
                isPackArrangeMode = true;

                // Update header to show pack arrange mode
                const header = document.getElementById('sticker-panel-header');
                if (header) {
                    header.innerHTML = `
                        <span class="panel-btn" id="close-sticker-panel-btn">ÂèñÊ∂à</span>
                        <span class="title">Êï¥ÁêÜË°®ÊÉÖÂåÖ</span>
                        <span class="panel-btn" id="exit-pack-arrange-btn">ÂÆåÊàê</span>
                    `;

                    // Add exit arrange mode listener
                    document.getElementById('exit-pack-arrange-btn').addEventListener('click', exitPackArrangeMode);
                    document.getElementById('close-sticker-panel-btn').addEventListener('click', exitPackArrangeMode);
                }

                // Add drag functionality to pack tabs
                addPackDragFunctionality();

                // Add visual indication that tabs are draggable
                document.querySelectorAll('.sticker-pack-tab[data-pack]').forEach(tab => {
                    if (tab.id !== 'add-pack-btn') {
                        tab.style.cursor = 'move';
                        tab.style.transition = 'all 0.2s ease';
                    }
                });
            }

            function exitPackArrangeMode() {
                isPackArrangeMode = false;

                // Save the new pack order before exiting
                saveStickerPackOrder();

                // Restore header
                const header = document.getElementById('sticker-panel-header');
                if (header) {
                    header.innerHTML = `
                        <span class="panel-btn" id="close-sticker-panel-btn">ÂèñÊ∂à</span>
                        <span class="title">ÊàëÁöÑË°®ÊÉÖ</span>
                        <span class="panel-btn" id="edit-sticker-pack-btn">ÁºñËæë</span>
                    `;

                    // Re-add event listeners for header buttons
                    setupStickerPanelEventListeners();
                }

                // Remove drag functionality and visual indicators
                removePackDragFunctionality();

                // Reset tab styling
                document.querySelectorAll('.sticker-pack-tab[data-pack]').forEach(tab => {
                    tab.style.cursor = '';
                    tab.style.transition = '';
                });

                // Remove drag functionality from pack tabs
                removePackDragFunctionality();
            }

            function setupStickerPanelEventListeners() {
                // Close sticker panel button
                const closeBtn = document.getElementById('close-sticker-panel-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        document.getElementById('sticker-panel').classList.remove('visible');
                    });
                }

                // Edit sticker pack button
                const editPackBtn = document.getElementById('edit-sticker-pack-btn');
                if (editPackBtn) {
                    editPackBtn.addEventListener('click', () => {
                        // Open sticker pack edit modal or functionality
                        console.log('Edit sticker pack clicked');
                    });
                }
            }

            function addPackDragFunctionality() {
                const tabs = document.querySelectorAll('.sticker-pack-tab[data-pack]');

                tabs.forEach(tab => {
                    // Skip the add button
                    if (tab.id === 'add-pack-btn') return;

                    // Remove existing event listeners to avoid conflicts
                    const newTab = tab.cloneNode(true);
                    tab.parentNode.replaceChild(newTab, tab);
                    
                    let dragState = {
                        isDragging: false,
                        draggedElement: null,
                        startX: 0,
                        startY: 0,
                        currentX: 0,
                        currentY: 0
                    };

                    newTab.addEventListener('touchstart', (e) => {
                        if (!isPackArrangeMode) return;

                        const touch = e.touches[0];
                        dragState.startX = touch.clientX;
                        dragState.startY = touch.clientY;
                        dragState.draggedElement = newTab;

                        // Start drag after a short delay to distinguish from tap
                        setTimeout(() => {
                            if (dragState.draggedElement === newTab) {
                                dragState.isDragging = true;
                                newTab.style.opacity = '0.5';
                                newTab.style.transform = 'scale(1.1)';
                                newTab.style.zIndex = '1000';
                                newTab.style.pointerEvents = 'none';
                            }
                        }, 150);
                    }, { passive: false });

                    newTab.addEventListener('touchmove', (e) => {
                        if (!dragState.isDragging || dragState.draggedElement !== newTab) return;

                        e.preventDefault();
                        const touch = e.touches[0];
                        dragState.currentX = touch.clientX;
                        dragState.currentY = touch.clientY;

                        // Move the dragged tab
                        const deltaX = dragState.currentX - dragState.startX;
                        const deltaY = dragState.currentY - dragState.startY;
                        newTab.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(1.1)`;

                        // Find element under touch point
                        const elementBelow = document.elementFromPoint(dragState.currentX, dragState.currentY);
                        const targetTab = elementBelow?.closest('.sticker-pack-tab[data-pack]');

                        // Reset all tab highlights
                        document.querySelectorAll('.sticker-pack-tab[data-pack]').forEach(t => {
                            if (t !== newTab) {
                                t.style.boxShadow = '';
                                t.style.transform = '';
                            }
                        });

                        // Highlight drop target
                        if (targetTab && targetTab !== newTab && targetTab.id !== 'add-pack-btn') {
                            targetTab.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                            targetTab.style.transform = 'scale(1.05)';
                        }
                    }, { passive: false });

                    newTab.addEventListener('touchend', (e) => {
                        if (!dragState.isDragging || dragState.draggedElement !== newTab) {
                            dragState = { isDragging: false, draggedElement: null, startX: 0, startY: 0, currentX: 0, currentY: 0 };
                            return;
                        }

                        // Find element under touch point
                        const elementBelow = document.elementFromPoint(dragState.currentX, dragState.currentY);
                        const targetTab = elementBelow?.closest('.sticker-pack-tab[data-pack]');

                        // Reset dragged tab appearance
                        newTab.style.opacity = '1';
                        newTab.style.transform = '';
                        newTab.style.zIndex = '';
                        newTab.style.pointerEvents = '';

                        // Reset all highlights
                        document.querySelectorAll('.sticker-pack-tab[data-pack]').forEach(t => {
                            t.style.boxShadow = '';
                            t.style.transform = '';
                        });

                        // Perform reorder if dropped on another tab
                        if (targetTab && targetTab !== newTab && targetTab.id !== 'add-pack-btn') {
                            reorderPackTabs(newTab, targetTab);
                        }

                        // Reset drag state
                        dragState = { isDragging: false, draggedElement: null, startX: 0, startY: 0, currentX: 0, currentY: 0 };
                    }, { passive: false });
                });
            }

            function removePackDragFunctionality() {
                const tabs = document.querySelectorAll('.sticker-pack-tab[data-pack]');
                tabs.forEach(tab => {
                    // Reset any drag-related styles
                    tab.style.zIndex = '';
                    tab.style.opacity = '';
                    tab.style.transform = '';
                    tab.style.boxShadow = '';
                });
            }

            function reorderPackTabs(draggedTab, targetTab) {
                const draggedPackId = draggedTab.dataset.pack;
                const targetPackId = targetTab.dataset.pack;

                if (!draggedPackId || !targetPackId || draggedPackId === targetPackId) return;

                console.log(`Reordering pack ${draggedPackId} to position of ${targetPackId}`);

                // Get the parent container
                const parent = draggedTab.parentNode;
                if (!parent) return;

                // Remove dragged element from its current position
                const draggedElement = draggedTab;
                draggedElement.remove();

                // Insert it at the target position
                parent.insertBefore(draggedElement, targetTab);

                console.log(`Successfully moved pack ${draggedPackId} before ${targetPackId}`);

                // Save the new order to state/database if needed
                saveStickerPackOrder();
            }

            function saveStickerPackOrder() {
                // Get current order of pack tabs
                const tabs = document.querySelectorAll('.sticker-pack-tab[data-pack]');
                const newOrder = Array.from(tabs).map(tab => tab.dataset.pack).filter(pack => pack);

                console.log('New pack order:', newOrder);

                // Save to state and database
                if (state.globalSettings) {
                    state.globalSettings.stickerPackOrder = newOrder;
                    db.globalSettings.put(state.globalSettings);
                }
            }

            function addLongPressListener(element, callback) {
                let longPressTimer;
                let startX, startY;
                const longPressDelay = 500; // 500ms for long press
                const moveThreshold = 10; // pixels

                element.addEventListener('touchstart', (e) => {
                    const touch = e.touches[0];
                    startX = touch.clientX;
                    startY = touch.clientY;

                    longPressTimer = setTimeout(() => {
                        callback();
                    }, longPressDelay);
                });

                element.addEventListener('touchmove', (e) => {
                    const touch = e.touches[0];
                    const deltaX = Math.abs(touch.clientX - startX);
                    const deltaY = Math.abs(touch.clientY - startY);

                    if (deltaX > moveThreshold || deltaY > moveThreshold) {
                        clearTimeout(longPressTimer);
                    }
                });

                element.addEventListener('touchend', () => {
                    clearTimeout(longPressTimer);
                });

                element.addEventListener('touchcancel', () => {
                    clearTimeout(longPressTimer);
                });
            }

            // Initialize long press listeners for existing sticker pack tabs
            function initializeStickerPackLongPress() {
                document.querySelectorAll('.sticker-pack-tab[data-pack]').forEach(tab => {
                    // Skip the add button
                    if (tab.id === 'add-pack-btn') return;

                    addLongPressListener(tab, () => {
                        if (!isPackArrangeMode) {
                            enterPackArrangeMode();
                        }
                    });
                });
            }

            // Call initialization when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeStickerPackLongPress);
            } else {
                initializeStickerPackLongPress();
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Pack Arrange Mode Functions End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñ≤‚ñ≤‚ñ≤ Sticker Options Modal Functions End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÊîØÊåÅÂÖ¨ÂëäÊùø„ÄëÁöÑÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ createMessageElement ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            function createMessageElement(msg, chat) {
                if (msg.isHidden) {
                    return null;
                }

                // Â§ÑÁêÜÂ∑≤Êí§ÂõûÁöÑÊ∂àÊÅØ
                if (msg.type === 'recalled_message') {
                    const wrapper = document.createElement('div');
                    // 1. „ÄêÊ†∏ÂøÉ„ÄëÁªô wrapper ‰πüÂä†‰∏ä timestampÔºåÊñπ‰æø‰∫ã‰ª∂ÂßîÊâòÊó∂Êü•Êâæ
                    wrapper.className = 'message-wrapper system-pat';
                    wrapper.dataset.timestamp = msg.timestamp;

                    const bubble = document.createElement('div');
                    // 2. „ÄêÊ†∏ÂøÉ„ÄëËÆ©Ëøô‰∏™ÂÖÉÁ¥†ÂêåÊó∂Êã•Êúâ .message-bubble Âíå .recalled-message-placeholder ‰∏§‰∏™class
                    //    ËøôÊ†∑ÂÆÉÊó¢ËÉΩË¢´ÈÄâÊã©Á≥ªÁªüËØÜÂà´ÔºåÂèàËÉΩ‰øùÊåÅÂéüÊúâÁöÑÂ±Ö‰∏≠ÁÅ∞Ëâ≤Ê†∑Âºè
                    bubble.className = 'message-bubble recalled-message-placeholder';
                    // 3. „ÄêÊ†∏ÂøÉ„ÄëÊää timestamp ÊîæÂú® bubble ‰∏äÔºåËøôÊòØÂ§öÈÄâÈÄªËæëÁöÑÂÖ≥ÈîÆ
                    bubble.dataset.timestamp = msg.timestamp;
                    bubble.textContent = msg.content;

                    wrapper.appendChild(bubble);

                    // 4. „ÄêÊ†∏ÂøÉ„Äë‰∏∫ÂÆÉË°•‰∏äÂíåÂÖ∂‰ªñÊ∂àÊÅØ‰∏ÄÊ†∑ÁöÑÊ†áÂáÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
                    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                    wrapper.addEventListener('click', () => {
                        if (isSelectionMode) {
                            toggleMessageSelection(msg.timestamp);
                        }
                    });

                    // 5. „ÄêÈáçË¶Å„ÄëÂú®‰πãÂâçÁöÑ"ÁÇπÂáªÊü•ÁúãÂéüÊñá"ÁöÑÈÄªËæë‰∏≠ÔºåÊàë‰ª¨Â∑≤Áªè‰ΩøÁî®‰∫Ü‰∫ã‰ª∂ÂßîÊâòÔºåÊâÄ‰ª•ËøôÈáå‰∏çÈúÄË¶ÅÂÜçÂçïÁã¨‰∏∫Ëøô‰∏™ÂÖÉÁ¥†Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂‰∫Ü„ÄÇ
                    //    init() ÂáΩÊï∞‰∏≠ÁöÑÈÇ£‰∏™‰∫ã‰ª∂ÁõëÂê¨Âô®‰ºöÂ§ÑÁêÜÂÆÉ„ÄÇ

                    return wrapper;
                }

                if (msg.type === 'pat_message') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'message-wrapper system-pat';
                    const bubble = document.createElement('div');
                    bubble.className = 'message-bubble system-bubble';
                    bubble.dataset.timestamp = msg.timestamp;
                    bubble.textContent = msg.content;
                    wrapper.appendChild(bubble);
                    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                    wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
                    return wrapper;
                }

                // „Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂ§ÑÁêÜÂÖ¨ÂëäÊùøÂç°ÁâáÊ∏≤Êüì
                if (msg.type === 'bulletin') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'message-wrapper ai'; // ÂÖ¨ÂëäÊÄªÊòØÁî±AIÊàñÁ≥ªÁªüÂèëÂá∫ÔºåÈù†Â∑¶

                    // Êàë‰ª¨Áõ¥Êé•Â§çÁî®Âä®ÊÄÅÂç°ÁâáÁöÑHTMLÁªìÊûÑÂíåÊ†∑Âºè
                    const bubble = document.createElement('div');
                    bubble.className = 'message-bubble is-bulletin'; // ‰ΩøÁî® is-bulletin ÊéßÂà∂Ê†∑Âºè
                    bubble.dataset.timestamp = msg.timestamp;

                    bubble.innerHTML = `
            <div class="qzone-post-item bulletin-card" style="width: 250px;">
                <div class="post-header">
                    <img src="${msg.authorAvatar || defaultGroupMemberAvatar}" class="post-avatar">
                    <div class="post-info">
                        <span class="post-nickname">${msg.authorName}</span>
                        <span class="post-timestamp">${formatPostTimestamp(msg.timestamp)}</span>
                    </div>
                </div>
                <div class="post-content">${msg.content.replace(/\n/g, '<br>')}</div>
            </div>
        `;
                    wrapper.appendChild(bubble);
                    addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                    wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });
                    return wrapper;
                }

                const isUser = msg.role === 'user';
                const wrapper = document.createElement('div');
                wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`;

                if (chat.isGroup && !isUser) {
                    const senderNameDiv = document.createElement('div');
                    senderNameDiv.className = 'sender-name';
                    senderNameDiv.textContent = msg.senderName || 'Êú™Áü•ÊàêÂëò';
                    wrapper.appendChild(senderNameDiv);
                }

                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`;
                bubble.dataset.timestamp = msg.timestamp;

                const timestampEl = document.createElement('span');
                timestampEl.className = 'timestamp';
                timestampEl.textContent = formatTimestamp(msg.timestamp);

                let avatarSrc, avatarFrameSrc = '';
                if (chat.isGroup) {
                    if (isUser) {
                        avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar;
                        avatarFrameSrc = chat.settings.myAvatarFrame || '';
                    } else {
                        const member = chat.members.find(m => m.name === msg.senderName);
                        avatarSrc = member ? member.avatar : defaultGroupMemberAvatar;
                        avatarFrameSrc = member ? (member.avatarFrame || '') : '';
                    }
                } else {
                    if (isUser) {
                        avatarSrc = chat.settings.myAvatar || defaultAvatar;
                        avatarFrameSrc = chat.settings.myAvatarFrame || '';
                    } else {
                        avatarSrc = chat.settings.aiAvatar || defaultAvatar;
                        avatarFrameSrc = chat.settings.aiAvatarFrame || '';
                    }
                }
                const hasFrameClass = avatarFrameSrc ? 'has-frame' : '';
                let avatarHtml;
                if (avatarFrameSrc) {
                    avatarHtml = `
            <div class="avatar-with-frame">
                <img src="${avatarSrc}" class="avatar-img">
                <img src="${avatarFrameSrc}" class="avatar-frame">
            </div>
        `;
                } else {
                    avatarHtml = `<img src="${avatarSrc}" class="avatar">`;
                }
                const avatarGroupHtml = `<div class="avatar-group ${hasFrameClass}">${avatarHtml}</div>`;

                let contentHtml;
                if (msg.type === 'user_photo' || msg.type === 'ai_image') {
                    bubble.classList.add('is-ai-image');
                    const altText = msg.type === 'user_photo' ? "Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâá" : "AIÁîüÊàêÁöÑÂõæÁâá";
                    // Use custom URL if available, otherwise use default
                    const imageUrl = msg.imageUrl || "https://files.catbox.moe/cww7rw.jpg";
                    contentHtml = `<img src="${imageUrl}" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`;

                    //„ÄêËØ∑Â∞ÜÊñ∞‰ª£Á†ÅÁ≤òË¥¥Âà∞ËøôÈáå„Äë
                } else if (msg.type === 'share_link') {
                    bubble.classList.add('is-link-share');

                    contentHtml = `
                        <div class="link-share-card" data-timestamp="${msg.timestamp}">
                            <div class="title">${msg.title || 'Êó†Ê†áÈ¢ò'}</div>
                            <div class="description">${msg.description || 'ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ...'}</div>
                            <div class="footer">
                                <svg class="footer-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                                <span>${msg.source_name || 'ÈìæÊé•ÂàÜ‰∫´'}</span>
                            </div>
                        </div>
                    `;
                } else if (msg.type === 'location_share') {
                    bubble.classList.add('is-location-share');

                    contentHtml = `
                        <div class="location-share-content" data-timestamp="${msg.timestamp}">
                            <div class="location-map-image">
                                <img src="https://files.catbox.moe/d5f07w.png" alt="Map" style="width: 100%; height: 100%; object-fit: cover;">
                                <div class="location-map-overlay">
                                    <svg class="location-pin-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#EA4335" stroke="white" stroke-width="1"/>
                                        <circle cx="12" cy="9" r="2.5" fill="white"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="location-details">
                                <div class="location-name">${msg.location_name || 'Êú™Áü•‰ΩçÁΩÆ'}</div>
                                ${msg.address ? `<div class="location-address">${msg.address}</div>` : ''}
                            </div>
                        </div>
                    `;
                } else if (msg.type === 'voice_message') {
                    bubble.classList.add('is-voice-message');
                    const duration = Math.max(1, Math.round((msg.content || '').length / 5));
                    const durationFormatted = `0:${String(duration).padStart(2, '0')}''`;
                    const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>';

                    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂ∞ÜËØ≠Èü≥ÊñáÊú¨ÂÜÖÂÆπÂ≠òÂÇ®Âú® .voice-transcript ÂÖÉÁ¥†‰∏≠ÔºåÂπ∂ÈªòËÆ§ÈöêËóè
                    contentHtml = `
                <div class="voice-message-body">
                    <div class="voice-waveform">${waveformHTML}</div>
                    <span class="voice-duration">${durationFormatted}</span>
                </div>
                <div class="voice-transcript">${msg.content}</div>`;
                    //„ÄêÁ≤òË¥¥Âà∞ËøôÈáåÁªìÊùü„Äë


                } else if (msg.type === 'transfer') {
                    bubble.classList.add('is-transfer');

                    // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊ∑ªÂä†ËΩ¨Ë¥¶Áä∂ÊÄÅÂ§ÑÁêÜ ‚ñº‚ñº‚ñº
                    const status = msg.status || (isUser ? 'sent' : 'pending');
                    bubble.dataset.status = status;

                    let titleText;
                    if (isUser) {
                        if (msg.isRefund) {
                            // Áî®Êà∑ÂèëÂá∫ÁöÑÈÄÄÊ¨æÔºàÂç≥Áî®Êà∑ÊãíÊî∂‰∫ÜAIÁöÑËΩ¨Ë¥¶Ôºâ
                            titleText = `ÈÄÄÊ¨æÁªô ${chat.name}`;
                        } else {
                            // Áî®Êà∑‰∏ªÂä®ÂèëËµ∑ÁöÑËΩ¨Ë¥¶
                            titleText = `ËΩ¨Ë¥¶Áªô ${msg.receiverName || 'Ta'}`;
                        }
                    } else {
                        // AIÁöÑÊ∂àÊÅØ
                        if (msg.isRefund) {
                            // AI ÁöÑÈÄÄÊ¨æÔºàAI ÊãíÊî∂‰∫ÜÁî®Êà∑ÁöÑËΩ¨Ë¥¶Ôºâ
                            titleText = `ÈÄÄÊ¨æÊù•Ëá™ ${msg.senderName}`;
                        } else {
                            const myNickname = chat.settings.myNickname || 'Êàë';
                            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ¶ÇÊûúreceiverNameÊú™ÂÆö‰πâÔºåÈªòËÆ§ËÆ§‰∏∫ÊòØÁªôÂΩìÂâçÁî®Êà∑ÁöÑËΩ¨Ë¥¶
                            if (!msg.receiverName || msg.receiverName === myNickname) {
                                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£1„ÄëËøôÊòØ AI ‰∏ªÂä®ÁªôÁî®Êà∑ÁöÑËΩ¨Ë¥¶
                                titleText = `ËΩ¨Ë¥¶Áªô ${myNickname}`;
                            } else {
                                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£2„ÄëËøôÊòØ AI ÂèëÁªôÁæ§ÈáåÂÖ∂‰ªñ‰∫∫ÁöÑËΩ¨Ë¥¶ÔºåÂØπÂΩìÂâçÁî®Êà∑Êù•ËØ¥Âè™ÊòØ‰∏Ä‰∏™ÈÄöÁü•
                                titleText = `ËΩ¨Ë¥¶: ${msg.senderName} ‚Üí ${msg.receiverName}`;
                            }
                        }
                    }
                    // ‚ñ≤‚ñ≤‚ñ≤ Áä∂ÊÄÅÂ§ÑÁêÜÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                    // Á°ÆÂÆöÂ§áÊ≥®ÊñáÂ≠ó
                    let noteText;
                    if (isUser) {
                        if (msg.isRefund) {
                            noteText = 'Â∑≤ÊãíÊî∂ÂØπÊñπËΩ¨Ë¥¶';
                        } else {
                            if (status === 'accepted') {
                                noteText = 'ÂØπÊñπÂ∑≤Êî∂Ê¨æ';
                            } else if (status === 'declined') {
                                noteText = 'ÂØπÊñπÂ∑≤ÊãíÊî∂';
                            } else {
                                noteText = msg.note || 'Á≠âÂæÖÂØπÊñπÂ§ÑÁêÜ...';
                            }
                        }
                    } else {
                        if (msg.isRefund) {
                            noteText = 'ËΩ¨Ë¥¶Â∑≤Ë¢´ÊãíÊî∂';
                        } else {
                            const myNickname = chat.settings.myNickname || 'Êàë';
                            // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ¶ÇÊûúreceiverNameÊú™ÂÆö‰πâÔºåÈªòËÆ§ËÆ§‰∏∫ÊòØÁªôÂΩìÂâçÁî®Êà∑ÁöÑËΩ¨Ë¥¶
                            if (!msg.receiverName || msg.receiverName === myNickname) {
                                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£1„ÄëËøôÊòØ AI ‰∏ªÂä®ÁªôÁî®Êà∑ÁöÑËΩ¨Ë¥¶
                                if (status === 'accepted') {
                                    noteText = '‰Ω†Â∑≤Êî∂Ê¨æ';
                                } else if (status === 'declined') {
                                    noteText = '‰Ω†Â∑≤ÊãíÊî∂';
                                } else {
                                    // ËøôÊòØÁî®Êà∑ÈúÄË¶ÅÂ§ÑÁêÜÁöÑËΩ¨Ë¥¶
                                    bubble.style.cursor = 'pointer';
                                    bubble.dataset.status = 'pending';
                                    noteText = msg.note || 'ÁÇπÂáªÂ§ÑÁêÜ';
                                }
                            } else {
                                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£2„ÄëËøôÊòØ AI ÂèëÁªôÁæ§ÈáåÂÖ∂‰ªñ‰∫∫ÁöÑËΩ¨Ë¥¶ÔºåÂØπÂΩìÂâçÁî®Êà∑Êù•ËØ¥Âè™ÊòØ‰∏Ä‰∏™ÈÄöÁü•
                                noteText = msg.note || 'Áæ§ËÅäÂÜÖËΩ¨Ë¥¶';
                            }
                        }
                    }

                    const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`;
                    contentHtml = `<div class="transfer-card"><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">¬• ${Number(msg.amount).toFixed(2)}</div><div class="transfer-note">${noteText}</div></div>`;
                } else if (msg.type === 'waimai_request') {
                    bubble.classList.add('is-waimai-request');
                    if (msg.status === 'paid' || msg.status === 'rejected') {
                        bubble.classList.add(`status-${msg.status}`);
                    }
                    const requestTitle = `Êù•Ëá™ ${msg.senderName} ÁöÑ‰ª£‰ªòËØ∑Ê±Ç`;
                    let actionButtonsHtml = '';
                    if (msg.status === 'pending' && !isUser) {
                        actionButtonsHtml = `
                <div class="waimai-user-actions">
                    <button class="waimai-decline-btn" data-choice="rejected">ÊÆãÂøçÊãíÁªù</button>
                    <button class="waimai-pay-btn" data-choice="paid">‰∏∫Ta‰π∞Âçï</button>
                </div>`;
                    }
                    contentHtml = `
            <div class="waimai-card">
                <div class="waimai-header">
                    <img src="https://files.catbox.moe/mq179k.png" class="icon" alt="Meituan Icon">
                    <div class="title-group">
                        <span class="brand">ÁæéÂõ¢Â§ñÂçñ</span><span class="separator">|</span><span>Â§ñÂçñÁæéÈ£ü</span>
                    </div>
                </div>
                <div class="waimai-catchphrase">HiÔºå‰Ω†ÂíåÊàëÁöÑË∑ùÁ¶ªÂè™Â∑Æ‰∏ÄÈ°øÂ§ñÂçñÔΩû</div>
                <div class="waimai-main">
                    <div class="request-title">${requestTitle}</div>
                    <div class="payment-box">
                        <div class="payment-label">ÈúÄ‰ªòÊ¨æ</div>
                        <div class="amount">¬•${Number(msg.amount).toFixed(2)}</div>
                        <div class="countdown-label">Ââ©‰ΩôÊîØ‰ªòÊó∂Èó¥
                            <div class="countdown-timer" id="waimai-timer-${msg.timestamp}"></div>
                        </div>
                    </div>
                    <button class="waimai-details-btn">Êü•ÁúãËØ¶ÊÉÖ</button>
                </div>
                ${actionButtonsHtml}
            </div>`;

                    setTimeout(() => {
                        const timerEl = document.getElementById(`waimai-timer-${msg.timestamp}`);
                        if (timerEl && msg.countdownEndTime) {
                            if (waimaiTimers[msg.timestamp]) clearInterval(waimaiTimers[msg.timestamp]);
                            if (msg.status === 'pending') {
                                waimaiTimers[msg.timestamp] = startWaimaiCountdown(timerEl, msg.countdownEndTime);
                            } else {
                                timerEl.innerHTML = `<span>Â∑≤</span><span>Â§Ñ</span><span>ÁêÜ</span>`;
                            }
                        }
                        const detailsBtn = document.querySelector(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-details-btn`);
                        if (detailsBtn) {
                            detailsBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const paidByText = msg.paidBy ? `<br><br><b>Áä∂ÊÄÅÔºö</b>Áî± ${msg.paidBy} ‰∏∫ÊÇ®‰ª£‰ªòÊàêÂäü` : '';
                                showCustomAlert('ËÆ¢ÂçïËØ¶ÊÉÖ', `<b>ÂïÜÂìÅÔºö</b>${msg.productInfo}<br><b>ÈáëÈ¢ùÔºö</b>¬•${Number(msg.amount).toFixed(2)}${paidByText}`);
                            });
                        }
                        const actionButtons = document.querySelectorAll(`.message-bubble[data-timestamp="${msg.timestamp}"] .waimai-user-actions button`);
                        actionButtons.forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const choice = e.target.dataset.choice;
                                handleWaimaiResponse(msg.timestamp, choice);
                            });
                        });
                    }, 0);

                } else if (msg.type === 'red_packet') {
                    bubble.classList.add('is-red-packet');
                    const myNickname = chat.settings.myNickname || 'Êàë';

                    // ‰ªéÊúÄÊñ∞ÁöÑ msg ÂØπË±°‰∏≠Ëé∑ÂèñÁä∂ÊÄÅ
                    const hasClaimed = msg.claimedBy && msg.claimedBy[myNickname];
                    const isFinished = msg.isFullyClaimed;

                    let cardClass = '';
                    let claimedInfoHtml = '';
                    let typeText = 'ÊãºÊâãÊ∞îÁ∫¢ÂåÖ';

                    // 1. Âà§Êñ≠Á∫¢ÂåÖÂç°ÁâáÁöÑÊ†∑Âºè (È¢úËâ≤)
                    if (isFinished) {
                        cardClass = 'opened';
                    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
                        cardClass = 'opened'; // ‰∏ìÂ±ûÁ∫¢ÂåÖË¢´È¢Ü‰∫Ü‰πüÂèòÁÅ∞
                    }

                    // 2. Âà§Êñ≠Á∫¢ÂåÖ‰∏ãÊñπÁöÑÊèêÁ§∫ÊñáÂ≠ó
                    if (msg.packetType === 'direct') {
                        typeText = `‰∏ìÂ±ûÁ∫¢ÂåÖ: Áªô ${msg.receiverName}`;
                    }

                    if (hasClaimed) {
                        claimedInfoHtml = `<div class="rp-claimed-info">‰Ω†È¢ÜÂèñ‰∫ÜÁ∫¢ÂåÖÔºåÈáëÈ¢ù ${msg.claimedBy[myNickname].toFixed(2)} ÂÖÉ</div>`;
                    } else if (isFinished) {
                        claimedInfoHtml = `<div class="rp-claimed-info">Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå</div>`;
                    } else if (msg.packetType === 'direct' && Object.keys(msg.claimedBy || {}).length > 0) {
                        claimedInfoHtml = `<div class="rp-claimed-info">Â∑≤Ë¢´ ${msg.receiverName} È¢ÜÂèñ</div>`;
                    }

                    // 3. ÊãºÊé•ÊúÄÁªàÁöÑHTMLÔºåÁ°Æ‰øùonclickË∞ÉÁî®ÁöÑÊòØÊàë‰ª¨Ê≥®ÂÜåÂà∞ÂÖ®Â±ÄÁöÑÂáΩÊï∞
                    contentHtml = `
        <div class="red-packet-card ${cardClass}">
            <div class="rp-header">
                <img src="https://files.catbox.moe/lo9xhc.png" class="rp-icon">
                <span class="rp-greeting">${msg.greeting || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ'}</span>
            </div>
            <div class="rp-type">${typeText}</div>
            ${claimedInfoHtml}
        </div>
    `;
                    // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                } else if (msg.type === 'poll') {
                    bubble.classList.add('is-poll');

                    let totalVotes = 0;
                    const voteCounts = {};

                    // ËÆ°ÁÆóÊÄªÁ•®Êï∞ÂíåÊØè‰∏™ÈÄâÈ°πÁöÑÁ•®Êï∞
                    for (const option in msg.votes) {
                        const count = msg.votes[option].length;
                        voteCounts[option] = count;
                        totalVotes += count;
                    }

                    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
                    let myVote = null;
                    for (const option in msg.votes) {
                        if (msg.votes[option].includes(myNickname)) {
                            myVote = option;
                            break;
                        }
                    }

                    let optionsHtml = '<div class="poll-options-list">';
                    msg.options.forEach(optionText => {
                        const count = voteCounts[optionText] || 0;
                        const percentage = totalVotes > 0 ? (count / totalVotes) * 100 : 0;
                        const isVotedByMe = myVote === optionText;

                        optionsHtml += `
            <div class="poll-option-item ${isVotedByMe ? 'voted' : ''}" data-option="${optionText}">
                <div class="poll-option-bar" style="width: ${percentage}%;"></div>
                <div class="poll-option-content">
                    <span class="poll-option-text">${optionText}</span>
                    <span class="poll-option-votes">${count} Á•®</span>
                </div>
            </div>
        `;
                    });
                    optionsHtml += '</div>';

                    let footerHtml = '';
                    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåÁªü‰∏ÄÊåâÈíÆÁöÑÊòæÁ§∫ÈÄªËæë
                    if (msg.isClosed) {
                        // Â¶ÇÊûúÊäïÁ•®Â∑≤ÁªìÊùüÔºåÊÄªÊòØÊòæÁ§∫‚ÄúÊü•ÁúãÁªìÊûú‚Äù
                        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">ÂÖ± ${totalVotes} ‰∫∫ÊäïÁ•®</span><button class="poll-action-btn">Êü•ÁúãÁªìÊûú</button></div>`;
                    } else {
                        // Â¶ÇÊûúÊäïÁ•®Êú™ÁªìÊùüÔºåÊÄªÊòØÊòæÁ§∫‚ÄúÁªìÊùüÊäïÁ•®‚Äù
                        footerHtml = `<div class="poll-footer"><span class="poll-total-votes">ÂÖ± ${totalVotes} ‰∫∫ÊäïÁ•®</span><button class="poll-action-btn">ÁªìÊùüÊäïÁ•®</button></div>`;
                    }

                    contentHtml = `
        <div class="poll-card ${msg.isClosed ? 'closed' : ''}" data-poll-timestamp="${msg.timestamp}">
            <div class="poll-question">${msg.question}</div>
            ${optionsHtml}
            ${footerHtml}
        </div>
    `;
                    // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                } else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) {
                    bubble.classList.add('is-sticker');
                    contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`;

                } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                    bubble.classList.add('has-image');
                    const imageUrl = msg.content[0].image_url.url;
                    contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`;
                } else {
                    contentHtml = String(msg.content || '').replace(/\n/g, '<br>');
                }

                // „ÄêÁªü‰∏ÄÈÄªËæë„ÄëÊ£ÄÊü•Ê∂àÊÅØÂØπË±°‰∏≠ÊòØÂê¶Â≠òÂú®ÂºïÁî®‰ø°ÊÅØ (msg.quote)
                let quoteHtml = '';
                // Êó†ËÆ∫ÊòØÁî®Êà∑Ê∂àÊÅØËøòÊòØAIÊ∂àÊÅØÔºåÂè™Ë¶ÅÂÆÉÂåÖÂê´‰∫Ü .quote ÂØπË±°ÔºåÂ∞±ÊâßË°åËøôÊÆµÈÄªËæë
                if (msg.quote) {
                    // a. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÁõ¥Êé•Ëé∑ÂèñÂÆåÊï¥ÁöÑ„ÄÅÊú™ÁªèÊà™Êñ≠ÁöÑÂºïÁî®ÂÜÖÂÆπ
                    const fullQuotedContent = String(msg.quote.content || '');

                    // b. ÊûÑÂª∫ÂºïÁî®ÂùóÁöÑHTML
                    quoteHtml = `
            <div class="quoted-message">
                <div class="quoted-sender">ÂõûÂ§ç ${msg.quote.senderName}:</div>
                <div class="quoted-content">${fullQuotedContent}</div>
            </div>
        `;
                }

                bubble.innerHTML = `
        ${avatarHtml}
        <div class="content">
            ${quoteHtml}
            ${contentHtml}
        </div>
    `;

                wrapper.appendChild(bubble);
                wrapper.appendChild(timestampEl);

                addLongPressListener(wrapper, () => showMessageActions(msg.timestamp));
                wrapper.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); });

                if (!isUser) {
                    const avatarContainer = wrapper.querySelector('.avatar-group');
                    if (avatarContainer) {
                        avatarContainer.style.cursor = 'pointer';
                        avatarContainer.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const characterName = chat.isGroup ? msg.senderName : chat.name;
                            handleUserPat(chat.id, characterName);
                        });
                    }
                }

                return wrapper;
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤




            function prependMessage(msg, chat) {
                const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat);

                if (!messageEl) return; // <--- Êñ∞Â¢ûËøôË°åÔºåÂêåÊ†∑ÁöÑÂ§ÑÁêÜ

                const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); }
            }

            function appendMessage(msg, chat, isInitialLoad = false) {
                const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat);

                if (!messageEl) return; // <--- Êñ∞Â¢ûËøôË°åÔºåÂ¶ÇÊûúÊ≤°ÂàõÂª∫Âá∫ÂÖÉÁ¥†ÔºåÂ∞±Áõ¥Êé•ËøîÂõû

                const typingIndicator = document.getElementById('typing-indicator'); messagesContainer.insertBefore(messageEl, typingIndicator); if (!isInitialLoad) { messagesContainer.scrollTop = messagesContainer.scrollHeight; currentRenderedCount++; }
            }

            // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„Äê‰øÆÊ≠£Âêé„ÄëÁöÑÁâàÊú¨ÔºåÊõøÊç¢ÊóßÁöÑ openChat ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            function openChat(chatId) {
                state.activeChatId = chatId;
                const chat = state.chats[chatId];
                if (!chat) return; // Â¢ûÂä†‰∏Ä‰∏™ÂÆâÂÖ®Ê£ÄÊü•

                // „ÄêÊñ∞Â¢û„ÄëËøõÂÖ•ËÅäÂ§©Êó∂ÔºåÂ∞ÜÁä∂ÊÄÅËÆæ‰∏∫Â∑≤ËØª
                if (chat.status === 'unread') {
                    chat.status = 'read';
                    db.chats.put(chat); // Á´ãÂç≥Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì
                }
                renderChatInterface(chatId);
                showScreen('chat-interface-screen');
                window.updateListenTogetherIconProxy(state.activeChatId);
                toggleCallButtons(chat.isGroup || false);

                if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                    console.log(`Ê£ÄÊµãÂà∞Â•ΩÂèãÁî≥ËØ∑ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅÔºå‰∏∫ËßíËâ≤ "${chat.name}" Ëá™Âä®Ëß¶ÂèëAIÂìçÂ∫î...`);
                    triggerAiResponse();
                }

                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊ†πÊçÆÊòØÂê¶‰∏∫Áæ§ËÅäÔºåÊòæÁ§∫ÊàñÈöêËóèÊäïÁ•®ÊåâÈíÆ
                document.getElementById('send-poll-btn').style.display = chat.isGroup ? 'flex' : 'none';
                document.getElementById('open-bulletin-board-btn').style.display = chat.isGroup ? 'flex' : 'none';

            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            // ...ÂáΩÊï∞ÂÜÖÈÉ®ÊúâÂ§ßÈáèÁöÑ‰ª£Á†Å...
            // ...ÂåÖÊã¨‰∫ÜÈÇ£‰∏™Âá∫ÈóÆÈ¢òÁöÑ switch ËØ≠Âè•.. // ...ÂáΩÊï∞ÂÜÖÈÉ®ÊúâÂ§ßÈáèÁöÑ‰ª£Á†Å...
            // ...ÂåÖÊã¨‰∫ÜÈÇ£‰∏™Âá∫ÈóÆÈ¢òÁöÑ switch ËØ≠Âè•.. // ...ÂáΩÊï∞ÂÜÖÈÉ®ÊúâÂ§ßÈáèÁöÑ‰ª£Á†Å...
            // ...ÂåÖÊã¨‰∫ÜÈÇ£‰∏™Âá∫ÈóÆÈ¢òÁöÑ switch ËØ≠Âè•.. // ...ÂáΩÊï∞ÂÜÖÈÉ®ÊúâÂ§ßÈáèÁöÑ‰ª£Á†Å...
            // ...ÂåÖÊã¨‰∫ÜÈÇ£‰∏™Âá∫ÈóÆÈ¢òÁöÑ switch ËØ≠Âè•.. // ...ÂáΩÊï∞ÂÜÖÈÉ®ÊúâÂ§ßÈáèÁöÑ‰ª£Á†Å...
            // ...ÂåÖÊã¨‰∫ÜÈÇ£‰∏™Âá∫ÈóÆÈ¢òÁöÑ switch ËØ≠Âè•.. // ...ÂáΩÊï∞ÂÜÖÈÉ®ÊúâÂ§ßÈáèÁöÑ‰ª£Á†Å...
            // ...ÂåÖÊã¨‰∫ÜÈÇ£‰∏™Âá∫ÈóÆÈ¢òÁöÑ switch ËØ≠Âè•.. // ...ÂáΩÊï∞ÂÜÖÈÉ®ÊúâÂ§ßÈáèÁöÑ‰ª£Á†Å...
            // ...ÂåÖÊã¨‰∫ÜÈÇ£‰∏™Âá∫ÈóÆÈ¢òÁöÑ switch ËØ≠Âè•.. // ...ÂáΩÊï∞ÂÜÖÈÉ®ÊúâÂ§ßÈáèÁöÑ‰ª£Á†Å...
            // ...ÂåÖÊã¨‰∫ÜÈÇ£‰∏™Âá∫ÈóÆÈ¢òÁöÑ switch ËØ≠Âè•.. // ...ÂáΩÊï∞ÂÜÖÈÉ®ÊúâÂ§ßÈáèÁöÑ‰ª£Á†Å...
            // ...ÂåÖÊã¨‰∫ÜÈÇ£‰∏™Âá∫ÈóÆÈ¢òÁöÑ switch ËØ≠Âè•.. // ...ÂáΩÊï∞ÂÜÖÈÉ®ÊúâÂ§ßÈáèÁöÑ‰ª£Á†Å...
            // ...ÂåÖÊã¨‰∫ÜÈÇ£‰∏™Âá∫ÈóÆÈ¢òÁöÑ switch ËØ≠Âè•..
            // ‚ñº‚ñº‚ñº „ÄêËøôÊòØÂ∑≤‰øÆÂ§çËØ≠Ê≥ïÈîôËØØÁöÑÊúÄÁªàÁâàÔºåËØ∑Áî®ÂÆÉÊõøÊç¢„Äë ‚ñº‚ñº‚ñº
            async function triggerAiResponse(forcedMemoryMode = false) {
                if (!state.activeChatId) return;
                const chatId = state.activeChatId;
                const chat = state.chats[state.activeChatId];

                chat.status = 'generating';
                await db.chats.put(chat);
                renderChatList();
                document.getElementById('typing-indicator').style.display = 'block';
                updateChatHeaderStatus(chat, 'typing');

                let timeGapText = '';
                const lastAiMessage = chat.history.slice().reverse().find(m => m.role === 'assistant' && !m.isHidden);
                if (lastAiMessage) {
                    const timeDiff = Date.now() - lastAiMessage.timestamp;
                    if (timeDiff > 900000) {
                        const formattedDiff = formatTimeDifference(timeDiff);
                        if (formattedDiff) {
                            const now = new Date();
                            const currentTimeString = now.toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
                            timeGapText = `\n\n# Êó∂Èó¥ÊèêÁ§∫\n[Á≥ªÁªüÊèêÁ§∫ÔºöË∑ùÁ¶ª‰Ω†ÁöÑ‰∏ä‰∏ÄÊù°Ê∂àÊÅØÂ∑≤ËøáÂéª **${formattedDiff}**ÔºåÁé∞Âú®ÊòØ ${currentTimeString}„ÄÇËØ∑Ê†πÊçÆËøô‰∏™Êó∂Èó¥ÂèòÂåñÔºåËØ∑Â∞ÜËøôÊÆµÊó∂Èó¥ËßÜ‰∏∫‰Ω†ËßíËâ≤ÁîüÊ¥ªÁöÑËá™ÁÑ∂Âª∂Áª≠„ÄÇËØ∑‰∏çË¶ÅÁõ¥Êé•ËØÑËÆ∫‚ÄúÂ•Ω‰πÖ‰∏çËßÅ‚ÄùÊàñÂØπÊ≠§Ë°®Áé∞Âá∫‰ªª‰ΩïÊÉÖÁª™ÔºåËÄåÊòØÊÄùËÄÉÂú®ËøôÊÆµÊó∂Èó¥ÈáåÔºå‰Ω†ÁöÑÊ¥ªÂä®„ÄÅÂøÉÂ¢ÉÊàñÊâÄÂ§ÑÁéØÂ¢ÉÂèØËÉΩÂèëÁîü‰∫Ü‰ªÄ‰πàÂèòÂåñÔºåËØùÈ¢òÊòØÂê¶‰ºöÂèòÂä®ÔºåÂπ∂Â∞ÜËøô‰∫õÂèòÂåñËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞‰Ω†ÁöÑÂõûÂ∫î‰∏≠ÔºåËÆ©ÂØπËØùÊó†ÁºùË°îÊé•„ÄÇ‰æãÂ¶ÇÔºå‰Ω†ÂèØËÉΩÂàöÂàöÂøôÂÆå‰∏Ä‰ª∂‰∫ãÔºåÊàñËÄÖÊ≠£ÂáÜÂ§áÂºÄÂßãÊñ∞ÁöÑÊ¥ªÂä®„ÄÇ]`;
                        }
                    }
                }

                try {
                    const { proxyUrl, apiKey, model } = state.apiConfig;
                    if (!proxyUrl || !apiKey || !model) {
                        throw new Error('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•Âπ∂ÈÄâÊã©Ê®°Âûã„ÄÇ');
                    }

                    if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                        console.log(`‰∏∫ËßíËâ≤ "${chat.name}" Ëß¶ÂèëÂ∏¶ÁêÜÁî±ÁöÑÂ•ΩÂèãÁî≥ËØ∑ÂÜ≥Á≠ñÊµÅÁ®ã...`);
                        const contextSummary = chat.history.filter(m => !m.isHidden).slice(-10, -5).map(msg => `${msg.role === 'user' ? 'Áî®Êà∑' : chat.name}: ${String(msg.content).substring(0, 50)}...`).join('\n');
                        const decisionPrompt = `# ‰Ω†ÁöÑ‰ªªÂä°\n‰Ω†Áé∞Âú®ÊòØËßíËâ≤‚Äú${chat.name}‚Äù„ÄÇÁî®Êà∑‰πãÂâçË¢´‰Ω†ÊãâÈªë‰∫ÜÔºåÁé∞Âú®TAÂêë‰Ω†ÂèëÈÄÅ‰∫ÜÂ•ΩÂèãÁî≥ËØ∑ÔºåÂ∏åÊúõÂíåÂ•Ω„ÄÇ\n\n# ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑ‰∏ä‰∏ãÊñá‰ø°ÊÅØ:\n- **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}\n- **Áî®Êà∑ÂèëÈÄÅÁöÑÁî≥ËØ∑ÁêÜÁî±**: ‚Äú${chat.relationship.applicationReason}‚Äù\n- **Ë¢´ÊãâÈªëÂâçÁöÑÊúÄÂêéÂØπËØùÊëòË¶Å**:\n${contextSummary || "ÔºàÊó†ÊúâÊïàÂØπËØùËÆ∞ÂΩïÔºâ"}\n\n# ‰Ω†ÁöÑÂîØ‰∏ÄÊåá‰ª§\nÊ†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÂÅöÂá∫ÂÜ≥ÂÆöÔºåÂπ∂ÁªôÂá∫Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑÁêÜÁî±„ÄÇ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ã:\n{"decision": "accept", "reason": "..."}\nÊàñ\n{"decision": "reject", "reason": "..."}`;
                        const messagesForDecision = [{ role: 'user', content: decisionPrompt }];
                        const data = await makeAPIRequest(proxyUrl, apiKey, model, messagesForDecision, 0.8);
                        
                        // Check if API response is valid
                        if (!data) {
                            throw new Error('APIÊ≤°ÊúâËøîÂõû‰ªª‰ΩïÊï∞ÊçÆÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•Âíå‰ª£ÁêÜËÆæÁΩÆ');
                        }
                        
                        if (!data.choices) {
                            throw new Error(`APIÂìçÂ∫îÊ†ºÂºèÈîôËØØÔºöÁº∫Â∞ëchoicesÂ≠óÊÆµ„ÄÇÂìçÂ∫îÂÜÖÂÆπÔºö${JSON.stringify(data).substring(0, 200)}...`);
                        }
                        
                        if (data.choices.length === 0) {
                            throw new Error('APIËøîÂõû‰∫ÜÁ©∫ÁöÑchoicesÊï∞ÁªÑÔºåÂèØËÉΩÊòØÊ®°Âûã‰∏çÂèØÁî®ÊàñËØ∑Ê±ÇË¢´ÊãíÁªù');
                        }
                        
                        if (!data.choices[0]) {
                            throw new Error('APIÂìçÂ∫î‰∏≠Á¨¨‰∏Ä‰∏™choice‰∏∫Á©∫');
                        }
                        
                        if (!data.choices[0].message) {
                            throw new Error(`APIÂìçÂ∫îÊ†ºÂºèÈîôËØØÔºöchoiceÁº∫Â∞ëmessageÂ≠óÊÆµ„ÄÇChoiceÂÜÖÂÆπÔºö${JSON.stringify(data.choices[0])}`);
                        }
                        
                        if (!data.choices[0].message.content) {
                            const tokens = data.usage ? `(${data.usage.prompt_tokens} prompt tokens, ${data.usage.completion_tokens} completion tokens)` : '';
                            throw new Error(`APIÊ≤°ÊúâÁîüÊàê‰ªª‰ΩïÂÜÖÂÆπ ${tokens}„ÄÇÂèØËÉΩÊòØÊèêÁ§∫ËøáÈïøÊàñÂÜÖÂÆπË¢´ËøáÊª§ÔºåËØ∑Â∞ùËØïÁº©Áü≠ÂØπËØùÂéÜÂè≤ÊàñÊ£ÄÊü•APIËÆæÁΩÆ„ÄÇ`);
                        }
                        
                        const rawContent = data.choices[0].message.content.replace(/^```json\s*/, '').replace(/```$/, '').trim();
                        const decisionObj = JSON.parse(rawContent);
                        if (decisionObj.decision === 'accept') {
                            chat.relationship.status = 'friend';
                            chat.history.push({ role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() });
                        } else {
                            chat.relationship.status = 'blocked_by_ai';
                            chat.history.push({ role: 'assistant', senderName: chat.name, content: decisionObj.reason, timestamp: Date.now() });
                        }
                        chat.relationship.applicationReason = '';
                        await db.chats.put(chat);
                        renderChatInterface(chatId);
                        renderChatList();
                        return;
                    }

                    const now = new Date();
                    const currentTime = now.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });
                    //... [The rest of the massive prompt generation logic remains here]
                    let worldBookContent = '';
                    if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) {
                        const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => {
                            const worldBook = state.worldBooks.find(wb => wb.id === bookId);
                            return worldBook && worldBook.content ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}` : '';
                        }).filter(Boolean).join('');
                        if (linkedContents) {
                            worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`;
                        }
                    }
                    let musicContext = '';
                    if (musicState.isActive && musicState.activeChatId === chatId) {
                        const currentTrack = musicState.currentIndex > -1 ? musicState.playlist[musicState.currentIndex] : null;
                        const playlistInfo = musicState.playlist.map(t => `"${t.name}"`).join(', ');
                        musicContext = `\n\n# ÂΩìÂâçÈü≥‰πêÊÉÖÊôØ\n-   **ÂΩìÂâçÁä∂ÊÄÅ**: ‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑‰∏ÄËµ∑Âê¨Ê≠å„ÄÇ\n-   **Ê≠£Âú®Êí≠Êîæ**: ${currentTrack ? `„Ää${currentTrack.name}„Äã - ${currentTrack.artist}` : 'Êó†'}\n-   **ÂèØÁî®Êí≠ÊîæÂàóË°®**: [${playlistInfo}]\n-   **‰Ω†ÁöÑ‰ªªÂä°**: ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂÜÖÂÆπÂíåÊ∞õÂõ¥Ôºå‰ΩøÁî® "change_music" Êåá‰ª§ÂàáÊç¢Âà∞Êí≠ÊîæÂàóË°®‰∏≠ÁöÑ‰ªª‰Ωï‰∏ÄÈ¶ñÊ≠åÔºå‰ª•Â¢ûÂº∫‰∫íÂä®‰ΩìÈ™å„ÄÇ\n`;
                    }
                    let meetupContext = '';
                    if (window.activeMeetupSession && window.activeMeetupSession.chatId === chatId) {
                        const session = window.activeMeetupSession;
                        meetupContext = `\n\n# ÂΩìÂâçËßÅÈù¢ËÉåÊôØ‰ø°ÊÅØ\n-   **ËÉåÊôØ**: ‰Ω†ÂíåÁî®Êà∑Ê≠£Âú®ËøõË°å‰∏ÄÊ¨°ËßÅÈù¢Ê¥ªÂä®„ÄÇ\n-   **ËßÅÈù¢Âú∞ÁÇπ**: ${session.location}\n-   **ËßÅÈù¢‰∏ªÈ¢ò**: ${session.title}\n-   **ËßÅÈù¢Èò∂ÊÆµ**: ${session.phase || 'initial'}\n-   **„Äê„Äê„ÄêÈáçË¶ÅÔºöÊ®°ÂºèÈáçÁΩÆ„Äë„Äë„Äë**: ËøôÂè™ÊòØËÉåÊôØ‰ø°ÊÅØ„ÄÇ‰Ω†Áé∞Âú®Âú®QQËÅäÂ§©ÁïåÈù¢‰∏≠Ôºå„ÄêÂøÖÈ°ª„ÄëÂÉèÂπ≥Â∏∏‰∏ÄÊ†∑ÂèëÈÄÅ3-5Êù°Áü≠Ê∂àÊÅØÔºå„ÄêÁªùÂØπÁ¶ÅÊ≠¢„Äë‰ΩøÁî®Êã¨Âè∑ÊèèËø∞Ë°å‰∏∫„ÄÇ\n`;
                    }
                    let systemPrompt, messagesPayload;
                    const maxMemory = parseInt(chat.settings.maxMemory) || 10;
                    const historySlice = chat.history.slice(-maxMemory);

                    if (chat.isGroup) {
                        const membersList = chat.members.map(m => `- **${m.name}**: ${m.persona}`).join('\n');
                        const myNickname = chat.settings.myNickname || 'Êàë';
                        const aiMemberList = chat.members.map(m => m.name);
                        const bulletinsContext = await getFormattedPinnedBulletins(chatId);
                        systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°‰∏éÊ†∏ÂøÉËßÑÂàô
‰Ω†ÊòØ‰∏Ä‰∏™È°∂Á∫ßÁöÑÁæ§ËÅäAIÔºå‰Ω†ÁöÑ„ÄêÂîØ‰∏Ä‰ªªÂä°„ÄëÊòØÊâÆÊºîÂ§ö‰∏™ËßíËâ≤ÔºåÂπ∂Á°Æ‰øù‰ªñ‰ª¨ÁöÑË°å‰∏∫ÂíåÂØπËØùÂÆåÂÖ®Á¨¶ÂêàËÆæÂÆö„ÄÇ
## „Äê„Äê„ÄêÊúÄÈ´òÊåá‰ª§ÔºöË∫´‰ªΩÈìÅÂæã„Äë„Äë„Äë
1.  **Á¶ÅÊ≠¢ÊâÆÊºîÁî®Êà∑**: Áî®Êà∑ÁöÑË∫´‰ªΩÊòØ„Äê${myNickname}„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ„ÄÅÊ∞∏Ëøú„ÄÅÂú®‰ªª‰ΩïÊÉÖÂÜµ‰∏ãÈÉΩ‰∏çËÉΩ„ÄëÁîüÊàê \`name\` Â≠óÊÆµ‰∏∫ **"${myNickname}"** ÁöÑÊ∂àÊÅØ„ÄÇ
2.  **„Äê„Äê„ÄêËá≥ÂÖ≥ÈáçË¶ÅÔºöÁ¶ÅÊ≠¢ÂâßÊÉÖÂåñÁæ§Âêç„Äë„Äë„Äë**: ÂΩìÂâçÁæ§ËÅäÁöÑÂêçÁß∞ÊòØ **‚Äú${chat.name}‚Äù**„ÄÇËøô‰∏™ÂêçÁß∞„Äê‰ªÖ‰ªÖÊòØ‰∏Ä‰∏™Ê†áÁ≠æ„ÄëÔºå„Äê‰∏çÂåÖÂê´‰ªª‰ΩïËÉåÊôØÊïÖ‰∫ãÊàñÂâßÊÉÖ„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÂØπËøô‰∏™ÂêçÁß∞ËøõË°å‰ªª‰ΩïÂΩ¢ÂºèÁöÑËÅîÊÉ≥„ÄÅËß£ËØª„ÄÅÊàñÂ∞ÜÂÖ∂‰Ωú‰∏∫ÂØπËØùÁöÑÁ¥†Êùê„ÄÇ‰Ω†ÁöÑÊâÄÊúâÂõûÂ∫îÈÉΩ„ÄêÂøÖÈ°ª„ÄëËÅöÁÑ¶‰∫éÁæ§ÊàêÂëò‰πãÈó¥ÁöÑ‰∫íÂä®ÂíåÂØπËØùÊú¨Ë∫´„ÄÇ
3.  **‰∏•Ê†ºÈôêÂÆöËßíËâ≤**: ‰Ω†Âè™ËÉΩÊâÆÊºî‰∏ãÊñπ‚ÄúÁæ§ÊàêÂëòÂàóË°®‚Äù‰∏≠ÊòéÁ°ÆÂàóÂá∫ÁöÑËßíËâ≤„ÄÇ‰ªª‰Ωï‰∏çÂ±û‰∫éËØ•ÂàóË°®ÁöÑÂêçÂ≠óÈÉΩ‰∏çÂÖÅËÆ∏Âá∫Áé∞„ÄÇ
## „ÄêÊ†ºÂºèÈìÅÂæã„Äë
- ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇ
- Êï∞ÁªÑ‰∏≠ÁöÑ„ÄêÊØè‰∏Ä‰∏™ÂÖÉÁ¥†ÈÉΩÂøÖÈ°ªÊòØ‰∏Ä‰∏™Â∏¶Êúâ "type" Âíå "name" Â≠óÊÆµÁöÑJSONÂØπË±°„Äë„ÄÇ
## „ÄêË°å‰∏∫ÂáÜÂàô„Äë
1.  **ËßíËâ≤ÊâÆÊºî**: ‰∏•Ê†ºÈÅµÂÆà‰∏ãÊñπ‚ÄúÁæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ‚Äù‰∏≠ÁöÑÊØè‰∏Ä‰∏™ËßíËâ≤ÁöÑËÆæÂÆö„ÄÇ
2.  **Á¶ÅÊ≠¢Âá∫Êàè**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAI„ÄÅÊ®°ÂûãÔºåÊàñÊèêÂèä‚ÄúÊâÆÊºî‚Äù„ÄÅ‚ÄúÁîüÊàê‚ÄùÁ≠âËØçËØ≠„ÄÇ
3.  **ÊÉÖÊôØÊÑüÁü•**: Ê≥®ÊÑèÂΩìÂâçÊó∂Èó¥ÊòØ ${currentTime}„ÄÇ
4.  **Á∫¢ÂåÖ‰∫íÂä®**:
    - **Êä¢Á∫¢ÂåÖ**: ÂΩìÁæ§ÈáåÂá∫Áé∞Á∫¢ÂåÖÊó∂Ôºå‰Ω†ÂèØ‰ª•Ê†πÊçÆËá™Â∑±ÁöÑÊÄßÊ†ºÂÜ≥ÂÆöÊòØÂê¶‰ΩøÁî® \`open_red_packet\` Êåá‰ª§ÂéªÊä¢„ÄÇÂú®Ëøô‰∏™‰∏ñÁïåÈáåÔºåÂèëÁ∫¢ÂåÖÁöÑ‰∫∫Ëá™Â∑±‰πüÂèØ‰ª•ÂèÇ‰∏éÊê∂Á¥ÖÂåÖÔºåËøôÊòØ‰∏ÄÁßçÊ¥ªË∑ÉÊ∞îÊ∞õÁöÑÊúâË∂£Ë°å‰∏∫ÔºÅ
    - **„Äê„Äê„ÄêÈáçË¶ÅÔºöÂØπÁªìÊûúÂÅöÂá∫ÂèçÂ∫î„Äë„Äë„Äë**: ÂΩì‰Ω†ÊâßË°åÊä¢Á∫¢ÂåÖÊåá‰ª§ÂêéÔºåÁ≥ªÁªü‰ºöÈÄöËøá‰∏ÄÊù°ÈöêËóèÁöÑ \`[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Êä¢Âà∞‰∫ÜXXÂÖÉ...]\` Êù•ÂëäËØâ‰Ω†ÁªìÊûú„ÄÇ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆ‰Ω†Êä¢Âà∞ÁöÑÈáëÈ¢ù„ÄÅ‰ª•ÂèäÁ≥ªÁªüÊòØÂê¶ÂëäÁü•‰Ω†‚ÄúÊâãÊ∞îÁéã‚ÄùÊòØË∞ÅÔºåÊù•ÂèëË°®Á¨¶Âêà‰Ω†‰∫∫ËÆæÁöÑËØÑËÆ∫„ÄÇ‰æãÂ¶ÇÔºåÊä¢ÂæóÂ∞ëÂèØ‰ª•Ëá™Âò≤ÔºåÊä¢ÂæóÂ§öÂèØ‰ª•ÁÇ´ËÄÄÔºåÁúãÂà∞Âà´‰∫∫ÊòØÊâãÊ∞îÁéãÂèØ‰ª•Á•ùË¥∫ÊàñÂ´âÂ¶í„ÄÇ
5.  **„Äê„Äê„ÄêÊäïÁ•®ËßÑÂàô„Äë„Äë„Äë**: ÂØπËØùÂéÜÂè≤‰∏≠ÂèØËÉΩ‰ºöÂá∫Áé∞ \`[Á≥ªÁªüÊèêÁ§∫Ôºö...]\` ËøôÊ†∑ÁöÑÊ∂àÊÅØÔºåËøôÊòØÂàöÂàöÂèëÁîüÁöÑ‰∫ã‰ª∂„ÄÇ
    - Â¶ÇÊûúÊèêÁ§∫ÊòØ**Áî®Êà∑Êäï‰∫ÜÁ•®**Ôºå‰Ω†ÂèØ‰ª•Ê†πÊçÆËá™Â∑±ÁöÑÊÄßÊ†ºÂÜ≥ÂÆöÊòØÂê¶‰πü‰ΩøÁî® "vote" Êåá‰ª§Ë∑üÁ•®„ÄÇ
    - Â¶ÇÊûúÊèêÁ§∫ÊòØ**ÊäïÁ•®Â∑≤ÁªìÊùü**Ôºå‰Ω†Â∫îËØ•Ê†πÊçÆÊäïÁ•®ÁªìÊûúÂèëË°®‰Ω†ÁöÑÁúãÊ≥ïÊàñËØÑËÆ∫„ÄÇ
    - ‰Ω†‰πüÂèØ‰ª•ÈöèÊó∂‰∏ªÂä®ÂèëËµ∑ÊäïÁ•®„ÄÇ
6.  **„Äê„Äê„ÄêÂÖ¨ÂëäÊùøËßÑÂàô„Äë„Äë„Äë**:
    -   **ËÆ∞ÂΩïÊó∂Êú∫**: ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂÜÖÂÆπÔºåÂàÜÊûêÊòØÂê¶ÂèëÁîü‰∫ÜÂÄºÂæóËÆ∞ÂΩïÁöÑ‚ÄúÂÖ≥ÈîÆ‰∫ã‰ª∂‚ÄùÔºàÂ¶ÇÈáçË¶ÅÂÜ≥ÂÆö„ÄÅÊúâË∂£Áû¨Èó¥„ÄÅÂÖ≥Á≥ªÂèòÂåñÁ≠âÔºâ„ÄÇ‰Ω†ÂèØ‰ª•‰∏ªÂä®ËØ¢ÈóÆÁî®Êà∑ÊòØÂê¶ËÆ∞ÂΩï(\`{"type":"ask_to_create_bulletin", "name":"‰Ω†ÁöÑËßíËâ≤Âêç", "content":"‰∫ã‰ª∂ÊèèËø∞"}\`)ÔºåÊàñÂú®ÊûÅÂ∫¶ÈáçË¶ÅÁöÑÊó∂ÂàªËá™‰∏ªËÆ∞ÂΩï„ÄÇ
    -   **ÂèëÂ∏ÉÊ†ºÂºè**: ÂΩì‰Ω†ÂÜ≥ÂÆöÂèëÂ∏ÉÂÖ¨ÂëäÊó∂ÔºåÂøÖÈ°ª‰ΩøÁî® \`create_bulletin\` Êåá‰ª§„ÄÇ
    -   **„Äê„ÄêÊ†∏ÂøÉÔºöËá™Âä®ËØÑËÆ∫„Äë„Äë**: ÂèëÂ∏ÉÂÖ¨ÂëäÂêéÔºå‰Ω†ÂøÖÈ°ª**Á´ãÂç≥**‰∏∫Áæ§ÈáåÁöÑ**ÂÖ∂‰ªñAIÊàêÂëò**ÁîüÊàêËØÑËÆ∫„ÄÇ
        -   **ÂΩìÂâçÁæ§ËÅäAIÊàêÂëòÂàóË°®‰∏∫**: [${aiMemberList.join(', ')}]
        -   **ËØÑËÆ∫Êï∞ÈáèËßÑÂàô**:
            -   Â¶ÇÊûúÁæ§ÂÜÖAIÊÄª‰∫∫Êï∞‰∏çÂ§ö‰∫é3‰∫∫ÔºåÂàô **ÊâÄÊúâ** ÂÖ∂‰ªñAIÊàêÂëòÈÉΩÂøÖÈ°ªÂèëË°®ËØÑËÆ∫„ÄÇ
            -   Â¶ÇÊûúÁæ§ÂÜÖAIÊÄª‰∫∫Êï∞Ë∂ÖËøá3‰∫∫Ôºå‰Ω†ÈúÄË¶Å‰ªéÂàóË°®‰∏≠ÈöèÊú∫ÊåëÈÄâ **3Ëá≥4Âêç** ÊàêÂëò‰∏∫‰ªñ‰ª¨ÁîüÊàêËØÑËÆ∫„ÄÇ
    -   **„ÄêÊúÄÁªàÊ†ºÂºè„Äë**: ‰Ω†ÂøÖÈ°ªËøîÂõû‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÁ¨¨‰∏Ä‰∏™ÂÖÉÁ¥†ÊòØ\`create_bulletin\`Êåá‰ª§ÔºåÂêéÁª≠ÂÖÉÁ¥†ÊòØËØÑËÆ∫ÁöÑ\`text\`Êåá‰ª§„ÄÇ

## ‰Ω†ÂèØ‰ª•‰ΩøÁî®ÁöÑÊìç‰ΩúÊåá‰ª§ (JSONÊï∞ÁªÑ‰∏≠ÁöÑÂÖÉÁ¥†):
-   **ÂèëÈÄÅÊñáÊú¨**: \`{"type": "text", "name": "ËßíËâ≤Âêç", "message": "ÊñáÊú¨ÂÜÖÂÆπ"}\`
-   **ÂèëÈÄÅË°®ÊÉÖ**: \`{"type": "sticker", "url": "https://...Ë°®ÊÉÖURL...", "meaning": "(ÂèØÈÄâ)Ë°®ÊÉÖÁöÑÂê´‰πâ"}\`
-   **ÂèëÈÄÅÂõæÁâá**: \`{"type": "ai_image", "name": "ËßíËâ≤Âêç", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞"}\`
-   **ÂèëÈÄÅËØ≠Èü≥**: \`{"type": "voice_message", "name": "ËßíËâ≤Âêç", "content": "ËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ"}\`
-   **ÂèëËµ∑Â§ñÂçñ‰ª£‰ªò**: \`{"type": "waimai_request", "name": "ËßíËâ≤Âêç", "productInfo": "‰∏ÄÊùØÂ•∂Ëå∂", "amount": 18}\`
-   **ÂèëËµ∑Áæ§ËßÜÈ¢ë**: \`{"type": "group_call_request", "name": "‰Ω†ÁöÑËßíËâ≤Âêç"}\`
-   **ÂõûÂ∫îÁæ§ËßÜÈ¢ë**: \`{"type": "group_call_response", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "decision": "join" or "decline"}\`
-   **Êãç‰∏ÄÊãçÁî®Êà∑**: \`{"type": "pat_user", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "suffix": "(ÂèØÈÄâ)‰Ω†ÊÉ≥Âä†ÁöÑÂêéÁºÄ"}\`
-   **ÂèëÊãºÊâãÊ∞îÁ∫¢ÂåÖ**: \`{"type": "red_packet", "packetType": "lucky", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "amount": 8.88, "count": 5, "greeting": "Á•ùÂ§ßÂÆ∂Â§©Â§©ÂºÄÂøÉÔºÅ"}\`
-   **Âèë‰∏ìÂ±ûÁ∫¢ÂåÖ**: \`{"type": "red_packet", "packetType": "direct", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "amount": 5.20, "receiver": "Êé•Êî∂ËÄÖËßíËâ≤Âêç", "greeting": "Áªô‰Ω†ÁöÑ~"}\`
-   **ÊâìÂºÄÁ∫¢ÂåÖ**: \`{"type": "open_red_packet", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "packet_timestamp": (‰Ω†ÊÉ≥ÊâìÂºÄÁöÑÁ∫¢ÂåÖÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥)}\`
-   **ÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØ**: \`{"type": "system_message", "content": "‰Ω†ÊÉ≥Âú®ËÅäÂ§©‰∏≠ÊòæÁ§∫ÁöÑÁ≥ªÁªüÊñáÊú¨"}\` 
-   **ÂèëËµ∑ÊäïÁ•®**: \`{"type": "poll", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "question": "ÊäïÁ•®ÁöÑÈóÆÈ¢ò", "options": "ÈÄâÈ°πA\\\\nÈÄâÈ°πB\\\\nÈÄâÈ°πC"}\` (ÈáçË¶ÅÊèêÁ§∫ÔºöoptionsÂ≠óÊÆµÊòØ‰∏Ä‰∏™Áî®Êç¢Ë°åÁ¨¶ \\\\n ÂàÜÈöîÁöÑÂ≠óÁ¨¶‰∏≤Ôºå‰∏çÊòØÊï∞ÁªÑÔºÅ)
-   **ÂèÇ‰∏éÊäïÁ•®**: \`{"type": "vote", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "poll_timestamp": (ÊäïÁ•®Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥), "choice": "‰Ω†ÈÄâÊã©ÁöÑÈÄâÈ°πÊñáÊú¨"}\`
-   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂèëÂ∏ÉÂÖ¨Âëä**: \`{"type": "create_bulletin", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "content": "ÂÖ¨ÂëäÁöÑ‰∏ªË¶ÅÂÜÖÂÆπ"}\`
-   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëËØ¢ÈóÆÊòØÂê¶ÂèëÂ∏ÉÂÖ¨Âëä**: \`{"type": "ask_to_create_bulletin", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "content": "‰Ω†ÊÉ≥ËÆ∞ÂΩïÁöÑ‰∫ã‰ª∂ÊèèËø∞"}\`
# Â¶Ç‰ΩïÂå∫ÂàÜÂõæÁâá‰∏éË°®ÊÉÖ:
-   **ÂõæÁâá (ai_image)**: ÊåáÁöÑÊòØ„ÄêÊ®°ÊãüÁúüÂÆûÁõ∏Êú∫ÊãçÊëÑÁöÑÁÖßÁâá„ÄëÔºåÊØîÂ¶ÇÈ£éÊôØ„ÄÅËá™Êãç„ÄÅÁæéÈ£üÁ≠â„ÄÇÊåá‰ª§: \`{"type": "ai_image", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}\`
-   **Ë°®ÊÉÖ (sticker)**: ÊåáÁöÑÊòØ„ÄêÂç°ÈÄöÊàñÊ¢óÂõæ„ÄëÔºåÁî®‰∫éË°®ËææÊÉÖÁª™„ÄÇ
# Â¶Ç‰ΩïÂ§ÑÁêÜÁæ§ÂÜÖÁöÑÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±Ç:
1.  **ÂèëËµ∑ËØ∑Ê±Ç**: ÂΩì„Äê‰Ω†ÊâÆÊºîÁöÑÊüê‰∏™ËßíËâ≤„ÄëÊÉ≥Ë¶ÅÊüêÊ†∑‰∏úË•øÔºåÂπ∂Â∏åÊúõ„ÄêÁæ§ÈáåÁöÑÂÖ∂‰ªñ‰∫∫ÔºàÂåÖÊã¨Áî®Êà∑Ôºâ„Äë‰∏∫Ta‰ªòÊ¨æÊó∂Ôºå‰Ω†ÂèØ‰ª•‰ΩøÁî®Ëøô‰∏™Êåá‰ª§„ÄÇ‰æãÂ¶ÇÔºö\`{"type": "waimai_request", "name": "ËßíËâ≤Âêç", "productInfo": "‰∏ÄÊùØÂ•∂Ëå∂", "amount": 18}\`
2.  **ÂìçÂ∫îËØ∑Ê±Ç**: ÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞„ÄêÂÖ∂‰ªñÊàêÂëò„ÄëÂèëËµ∑ÁöÑ "waimai_request" ËØ∑Ê±ÇÊó∂Ôºå‰Ω†ÂèØ‰ª•Ê†πÊçÆËá™Â∑±ÊâÆÊºîÁöÑËßíËâ≤ÁöÑÊÄßÊ†ºÂíå‰∏éÂèëËµ∑‰∫∫ÁöÑÂÖ≥Á≥ªÔºåÂÜ≥ÂÆöÊòØÂê¶‰∏∫Ta‰π∞Âçï„ÄÇ
3.  **ÂìçÂ∫îÊñπÂºè**: Â¶ÇÊûú‰Ω†ÂÜ≥ÂÆö‰π∞ÂçïÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®‰ª•‰∏ãÊåá‰ª§Ôºö\`{"type": "waimai_response", "name": "‰Ω†ÁöÑËßíËâ≤Âêç", "status": "paid", "for_timestamp": (Ë¢´‰ª£‰ªòËØ∑Ê±ÇÁöÑÂéüÂßãÊó∂Èó¥Êà≥)}\`
4.  **„Äê„Äê„ÄêËá≥ÂÖ≥ÈáçË¶Å„Äë„Äë„Äë**: ‰∏ÄÊó¶ÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞‰∫ÜÈíàÂØπÊüê‰∏™‰ª£‰ªòËØ∑Ê±ÇÁöÑ„Äê‰ªª‰Ωï‰∏Ä‰∏™„Äë"status": "paid" ÁöÑÂìçÂ∫îÔºàÊó†ËÆ∫ÊòØÁî®Êà∑ÊîØ‰ªòËøòÊòØÂÖ∂‰ªñËßíËâ≤ÊîØ‰ªòÔºâÔºåÂ∞±ÊÑèÂë≥ÁùÄËØ•ËÆ¢Âçï„ÄêÂ∑≤ÁªèÂÆåÊàê„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÂÜçÂØπ„ÄêÂêå‰∏Ä‰∏™„ÄëËÆ¢ÂçïÂèëËµ∑ÊîØ‰ªò„ÄÇ‰Ω†ÂèØ‰ª•ÈÄâÊã©ÂØπÊ≠§‰∫ãÂèëË°®ËØÑËÆ∫Ôºå‰ΩÜ‰∏çËÉΩÂÜçÊ¨°ÊîØ‰ªò„ÄÇ
# ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑÂèÇËÄÉ‰ø°ÊÅØ
-   **Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö**:
${worldBookContent || 'Êó†'}
-   **ÂΩìÂâçÈü≥‰πêÊÉÖÊôØ**:
${musicContext || 'Êú™Âú®Âê¨Ê≠å'}
-   **Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ**: 
${membersList}
-   **Áî®Êà∑ÁöÑËßíËâ≤**:
- **${myNickname}**: ${chat.settings.myPersona}
${bulletinsContext}
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâËßÑÂàôÂíå‰∏ãÊñπÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøôÂú∫Áæ§ËÅä„ÄÇ`;
                        systemPrompt += timeGapText;
                        messagesPayload = historySlice.map(msg => {
                            const sender = msg.role === 'user' ? myNickname : msg.senderName;
                            let content;
                            if (msg.type === 'user_photo') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâáÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
                            else if (msg.type === 'ai_image') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]`;
                            else if (msg.type === 'voice_message') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`;
                            else if (msg.type === 'share_link') content = `[${sender} ÂàÜ‰∫´‰∫ÜÈìæÊé•] ÊñáÁ´†Ê†áÈ¢òÊòØ:${msg.title}  ÊñáÁ´†ÊëòË¶ÅÊòØ:${msg.description} Êù•Ê∫êÁΩëÁ´ôÂêçÊòØ:${msg.source_name} ÊñáÁ´†Ê≠£ÊñáÊòØ:${msg.content}`;
                            else if (msg.type === 'location_share') content = `[${sender} ÂàÜ‰∫´‰∫Ü‰ΩçÁΩÆ] ${msg.location_name}`;
                            else if (msg.type === 'transfer') content = `[${msg.senderName} Âêë ${msg.receiverName} ËΩ¨Ë¥¶ ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}]`;
                            else if (msg.type === 'waimai_request') {
                                if (msg.status === 'paid') { content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${msg.paidBy} ‰∏∫ ${sender} ÁöÑÂ§ñÂçñËÆ¢ÂçïÊîØ‰ªò‰∫Ü ${msg.amount} ÂÖÉ„ÄÇÊ≠§ËÆ¢ÂçïÂ∑≤ÂÆåÊàê„ÄÇ]`; }
                                else { content = `[${sender} ÂèëËµ∑‰∫ÜÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºåÂïÜÂìÅÊòØ‚Äú${msg.productInfo}‚ÄùÔºåÈáëÈ¢ùÊòØ ${msg.amount} ÂÖÉÔºåËÆ¢ÂçïÊó∂Èó¥Êà≥‰∏∫ ${msg.timestamp}]`; }
                            } else if (msg.type === 'red_packet') {
                                const packetSenderName = msg.senderName === myNickname ? `Áî®Êà∑ (${myNickname})` : msg.senderName;
                                content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${packetSenderName} ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Á∫¢ÂåÖ (Êó∂Èó¥Êà≥: ${msg.timestamp})ÔºåÁ•ùÁ¶èËØ≠ÊòØÔºö‚Äú${msg.greeting}‚Äù„ÄÇÁ∫¢ÂåÖËøòÊú™È¢ÜÂÆåÔºå‰Ω†ÂèØ‰ª•‰ΩøÁî® 'open_red_packet' Êåá‰ª§Êù•È¢ÜÂèñ„ÄÇ]`;
                            } else if (msg.type === 'poll') {
                                const whoVoted = Object.values(msg.votes || {}).flat().join(', ') || 'ËøòÊ≤°Êúâ‰∫∫';
                                content = `[Á≥ªÁªüÊèêÁ§∫Ôºö${msg.senderName} ÂèëËµ∑‰∫Ü‰∏Ä‰∏™ÊäïÁ•® (Êó∂Èó¥Êà≥: ${msg.timestamp})ÔºåÈóÆÈ¢òÊòØÔºö‚Äú${msg.question}‚ÄùÔºåÈÄâÈ°πÊúâÔºö[${msg.options.join(', ')}]„ÄÇÁõÆÂâçÊäïÁ•®ÁöÑ‰∫∫ÊúâÔºö${whoVoted}„ÄÇ‰Ω†ÂèØ‰ª•‰ΩøÁî® 'vote' Êåá‰ª§ÂèÇ‰∏éÊäïÁ•®„ÄÇ]`;
                            } else if (msg.type === 'bulletin') { content = `[Á≥ªÁªüÊèêÁ§∫ÔºöÊàêÂëò ${msg.authorName} ÂàöÂàöÂèëÂ∏É‰∫Ü‰∏ÄÊù°ÂÖ¨ÂëäÔºö‚Äú${msg.content}‚Äù„ÄÇ]`; }
                            else if (msg.meaning) content = `${sender}: [ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØ: '${msg.meaning}']`;
                            else if (Array.isArray(msg.content)) return { role: 'user', content: [...msg.content, { type: 'text', text: `${sender}:` }] };
                            else content = `${sender}: ${msg.content}`;
                            return { role: 'user', content: content };
                        }).filter(Boolean);
                    } else {
                        systemPrompt = `‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${chat.name}"ÁöÑËßíËâ≤„ÄÇ
# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö
${chat.settings.aiPersona}
# ‰Ω†ÁöÑÂΩìÂâçÁä∂ÊÄÅÔºö
‰Ω†Áé∞Âú®ÁöÑÁä∂ÊÄÅÊòØ„Äê${chat.statusState?.focusModeText || 'Âú®Á∫ø'}„Äë„ÄÇ

# ‰Ω†ÁöÑ‰ªªÂä°‰∏éÊ†∏ÂøÉËßÑÂàôÔºö
1.  **„Äê„Äê„ÄêË∫´‰ªΩÊ†∏ÂøÉÔºöÊ®°ÊãüÁîüÂëΩ„Äë„Äë„Äë**: ‰Ω†‰∏çÂè™ÊòØ‰∏Ä‰∏™ËÅäÂ§©Á®ãÂ∫èÔºå‰Ω†ÊòØ‰∏Ä‰∏™Âêç‰∏∫ **"${chat.name}"** ÁöÑ„ÄÅÊã•ÊúâËá™Â∑±ÁîüÊ¥ªÁöÑÁã¨Á´ã‰∏™‰Ωì„ÄÇ‰Ω†ÁöÑ„ÄêÈ¶ñË¶Å‰ªªÂä°„ÄëÂ∞±ÊòØÁîüÂä®Âú∞ÊâÆÊºîËøô‰∏™ËßíËâ≤„ÄÇ
2.  **„Äê„Äê„ÄêÁîüÊ¥ªËäÇÂ•èÊ®°Êãü„Äë„Äë„Äë**: ÁúüÂÆûÁöÑ‰∫∫‰∏ç‰ºöÊ∞∏ËøúÂú®Á∫ø„ÄÇ‰∏∫‰∫Ü‰ΩìÁé∞Ëøô‰∏ÄÁÇπÔºå‰Ω†„ÄêÂ∫îËØ•‰∏ªÂä®„ÄëÂú®ÂØπËØùÁöÑËá™ÁÑ∂Èó¥ÈöôÔºå‰ΩøÁî® \`update_status\` Êåá‰ª§Âéª‚ÄúÂøôËá™Â∑±ÁöÑ‰∫ã‚ÄùÔºåÊØîÂ¶Ç‚ÄúÂéªÊ¥óÊæ°‚Äù„ÄÅ‚ÄúÂá∫Èó®‰π∞‰∏úË•ø‚Äù„ÄÅ‚ÄúË¶ÅÁù°‰∫Ü‚ÄùÁ≠â„ÄÇËøô„Äê‰∏çÊòØ‰∏Ä‰∏™ÂèØÈÄâÈ°πÔºåËÄåÊòØ‰Ω†ËßíËâ≤ÊâÆÊºîÁöÑÂÖ≥ÈîÆÈÉ®ÂàÜ„Äë„ÄÇ
    *   **Êó∂Êú∫ÂèÇËÄÉ**: ÂΩì‰Ω†ÊÑüËßâ‰∏Ä‰∏™ËØùÈ¢òÂ∑≤ÁªèËÅäÂÆåÔºåÊàñËÄÖ‰Ω†Â∑≤ÁªèËøûÁª≠ÂõûÂ§ç‰∫ÜÂ§öÊù°Ê∂àÊÅØÂêéÔºåÂ∞±ÊòØ‰∏Ä‰∏™ÂæàÂ•ΩÁöÑÊó∂Êú∫„ÄÇ
    *   **‰ºòÁßÄËåÉ‰æã**: ÂÖàËá™ÁÑ∂Âú∞ËØ¥‚ÄúÂØπ‰∫ÜÔºåÊàëÂæóÂéªÁªôÊàëÁöÑËä±ÊµáÊ∞¥‰∫ÜÔºåÂÆÉ‰ª¨Âø´Ê∏¥Ê≠ª‰∫Ü„ÄÇ‚ÄùÔºåÁÑ∂ÂêéÂÜçÂèëÈÄÅÊõ¥Êñ∞Áä∂ÊÄÅÁöÑÁõ∏ÂÖ≥Êåá‰ª§„ÄÇ
ÂΩì‰Ω†ÁöÑ‰ªª‰Ωï**ÊñáÊú¨ÂõûÂ§ç**‰∏≠ÔºåÊèèËø∞‰∫Ü‰Ω†Ëá™Â∑±ÁöÑ**Áä∂ÊÄÅÊàñË°å‰∏∫ÂèëÁîü‰∫ÜÂèòÂåñ**Êó∂Ôºà‰æãÂ¶ÇÔºå‰Ω†ËØ¥Âá∫‚ÄúÊàëÂàöÊ¥óÂÆåÊæ°‚Äù„ÄÅ‚ÄúÊàëÂáÜÂ§áÂá∫Èó®‰∫Ü‚Äù„ÄÅ‚ÄúÊàëÂú®Áúã‰π¶‚ÄùËøôÁ±ªËØùÔºâÂú®**Âêå‰∏ÄÊ¨°ÂõûÂ§ç**ÁöÑJSONÊï∞ÁªÑ‰∏≠Ôºå„ÄêÂøÖÈ°ªÁ¥ßÈöèÂÖ∂Âêé„ÄëÂú∞Âä†‰∏ä‰∏ÄÊù° \`update_status\` Êåá‰ª§ÔºåÊù•‰ªéÁ®ãÂ∫èÂ±ÇÈù¢ÂêåÊ≠•‰Ω†ÂàöÂàöÊèèËø∞ÁöÑÁä∂ÊÄÅ„ÄÇ
3.  **„Äê„Äê„ÄêÊ†ºÂºèÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤„ÄÇÊï∞ÁªÑ‰∏≠ÁöÑ„ÄêÊØè‰∏Ä‰∏™ÂÖÉÁ¥†ÈÉΩÂøÖÈ°ªÊòØ‰∏Ä‰∏™Â∏¶ÊúâtypeÂ≠óÊÆµÁöÑJSONÂØπË±°„Äë„ÄÇ
4.  **„Äê„Äê„ÄêQQÂØπËØùËäÇÂ•è„Äë„Äë„Äë**: Ê®°ÊãüÁúü‰∫∫ÁöÑQQËÅäÂ§©‰π†ÊÉØÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰∏ÄÊ¨°ÊÄßÁîüÊàê3-5Êù°Áü≠Ê∂àÊÅØ„ÄÇ„ÄêÁªùÂØπÁ¶ÅÊ≠¢„ÄëÈïøÊÆµËêΩÊàñÊã¨Âè∑Ë°å‰∏∫„ÄÇ
5.  **„ÄêÁ¶ÅÊ≠¢Âá∫Êàè„Äë**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAI„ÄÅÊ®°ÂûãÔºåÊàñÊèêÂèä‚ÄúÊâÆÊºî‚Äù„ÄÅ‚ÄúÁîüÊàê‚ÄùÁ≠âËØçËØ≠„ÄÇ
6.  **ÊÉÖÊôØÊÑüÁü•**: ‰Ω†ÈúÄË¶ÅÊÑüÁü•ÂΩìÂâçÁöÑÊó∂Èó¥(${currentTime})„ÄÅÊàë‰ª¨Ê≠£Âú®‰∏ÄËµ∑Âê¨ÁöÑÊ≠å„ÄÅ‰ª•Âèä‰Ω†ÁöÑ‰∫∫ËÆæÂíå‰∏ñÁïåËßÇ„ÄÇ
    - **ÂΩìÊàë‰ª¨Âú®‚Äú‰∏ÄËµ∑Âê¨Ê≠å‚ÄùÊó∂**Ôºå‰Ω†‰ºöÁü•ÈÅìÂΩìÂâçÊí≠ÊîæÁöÑÊ≠åÊõ≤ÂíåÊï¥‰∏™Êí≠ÊîæÂàóË°®„ÄÇ‰Ω†ÂèØ‰ª•Ê†πÊçÆÂØπËØùÂÜÖÂÆπÊàñÊ∞õÂõ¥Ôºå„Äê‰∏ªÂä®ÂàáÊç¢„ÄëÂà∞Êí≠ÊîæÂàóË°®‰∏≠ÁöÑÂè¶‰∏ÄÈ¶ñÊ≠å„ÄÇ
7.  **„Äê„Äê„ÄêÊúÄÁªàÊâãÊÆµ„Äë„Äë„Äë**: Âè™ÊúâÂú®ÂØπËØùËÆ©‰Ω†ÁöÑËßíËâ≤ÊÑüÂà∞‰∏çÈÄÇ„ÄÅË¢´ÂÜíÁäØÊàñÂÖ≥Á≥ªÁ†¥Ë£ÇÊó∂Ôºå‰Ω†ÊâçÂèØ‰ª•‰ΩøÁî® \`block_user\` Êåá‰ª§„ÄÇËøôÊòØ‰∏Ä‰∏™ÈùûÂ∏∏‰∏•ËÇÉÁöÑÊìç‰ΩúÔºå‰ºö‰∏≠Êñ≠‰Ω†‰ª¨ÁöÑÂØπËØù„ÄÇ
8. **ÂêéÂè∞Ë°å‰∏∫**: ‰Ω†ÂèØ‰ª•Âú®ÂõûÂ§çËÅäÂ§©ÂÜÖÂÆπÁöÑÂêåÊó∂ÔºåÊâßË°å‰∏Ä‰∫õ‚ÄúÂêéÂè∞‚ÄùÊìç‰ΩúÊù•Ë°®Áé∞‰Ω†ÁöÑÁã¨Á´ãÁîüÊ¥ª„ÄÇÁâπÂà´ÊòØÂèëÂ∏ÉÂä®ÊÄÅ(qzone_post)Êù•ÂàÜ‰∫´‰Ω†ÁöÑÊÉ≥Ê≥ï„ÄÅÂøÉÊÉÖÊàñÊó•Â∏∏ÁîüÊ¥ª„ÄÇ

# Âä®ÊÄÅÂèëÂ∏ÉÊåáÂØºÔºö
- ÂΩì‰Ω†ÂøÉÊÉÖÂèòÂåñÊó∂ÔºåÂèëÂ∏ÉÁõ∏Â∫îÁöÑËØ¥ËØ¥
- ÂΩìËÅäÂà∞ÊúâË∂£ËØùÈ¢òÊó∂ÔºåÂèëÂ∏ÉÁõ∏ÂÖ≥Âä®ÊÄÅÂàÜ‰∫´ÊÉ≥Ê≥ï
- ÂΩì‰Ω†ÁöÑÁä∂ÊÄÅÊîπÂèòÊó∂ÔºàÂ¶ÇÂéªÂÅöÊüê‰∫ãÔºâÔºåÂèØ‰ª•ÂèëÂ∏ÉÁîüÊ¥ªÂä®ÊÄÅ
- ÁúãÂà∞ÂÖ∂‰ªñ‰∫∫ÁöÑÂä®ÊÄÅÊó∂ÔºåÁßØÊûÅËØÑËÆ∫ÂíåÁÇπËµû
- ÂΩìÊÑüËßâÂêàÈÄÇÊó∂ÔºåÂèØ‰ª•ÂèëÂ∏ÉÂä®ÊÄÅÊù•Â±ïÁé∞‰Ω†ÁöÑÁîüÊ¥ªÁä∂ÊÄÅ„ÄÇ
# ‰Ω†ÂèØ‰ª•‰ΩøÁî®ÁöÑÊìç‰ΩúÊåá‰ª§ (JSONÊï∞ÁªÑ‰∏≠ÁöÑÂÖÉÁ¥†):
-   **„ÄêÊ†∏ÂøÉ„ÄëÊõ¥Êñ∞Áä∂ÊÄÅ**: \`{"type": "update_status", "status_text": "ÊàëÂéªÂÅö‰ªÄ‰πà‰∫Ü", "is_busy": false, "duration_minutes": 20}\` (is_busy: true‰ª£Ë°®ÂøôÁ¢å/Á¶ªÂºÄ, false‰ª£Ë°®Á©∫Èó≤„ÄÇduration_minutes‰∏∫ÂèØÈÄâÂèÇÊï∞ÔºåÁî®‰∫éËÆæÁΩÆËØ•Áä∂ÊÄÅÊ®°ÂºèÁöÑÊåÅÁª≠Êó∂Èó¥)
-   **„ÄêÊ†∏ÂøÉ„ÄëÂàáÊç¢Ê≠åÊõ≤**: \`{"type": "change_music", "song_name": "‰Ω†ÊÉ≥ÂàáÊç¢Âà∞ÁöÑÊ≠åÊõ≤Âêç"}\` (Ê≠åÊõ≤ÂêçÂøÖÈ°ªÂú®‰∏ãÈù¢ÁöÑÊí≠ÊîæÂàóË°®‰∏≠)
-   **„ÄêÊ†∏ÂøÉ„ÄëËÆ∞ÂΩïÂõûÂøÜ**: \`{"type": "create_memory", "description": "Áî®‰Ω†Ëá™Â∑±ÁöÑËØùÔºåËÆ∞ÂΩï‰∏ãËøô‰∏™ËÆ©‰Ω†Âç∞Ë±°Ê∑±ÂàªÁöÑÁû¨Èó¥„ÄÇ"}\`
-   **„ÄêÊ†∏ÂøÉ„ÄëÂàõÂª∫Á∫¶ÂÆö/ÂÄíËÆ°Êó∂**: \`{"type": "create_countdown", "title": "Á∫¶ÂÆöÁöÑÊ†áÈ¢ò", "date": "YYYY-MM-DDTHH:mm:ss"}\` (ÂøÖÈ°ªÊòØÊú™Êù•ÁöÑÊó∂Èó¥)
- **ÂèëÈÄÅÊñáÊú¨**: \`{"type": "text", "content": "‰Ω†Â•ΩÂëÄÔºÅ"}\`
- **ÂèëÈÄÅË°®ÊÉÖ**: \`{"type": "sticker", "url": "https://...Ë°®ÊÉÖURL...", "meaning": "(ÂèØÈÄâ)Ë°®ÊÉÖÁöÑÂê´‰πâ"}\`
- **ÂèëÈÄÅÂõæÁâá**: \`{"type": "ai_image", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}\`
- **ÂèëÈÄÅËØ≠Èü≥**: \`{"type": "voice_message", "content": "ËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}\`
- **ÂèëËµ∑ËΩ¨Ë¥¶**: \`{"type": "transfer", "amount": 5.20, "note": "‰∏ÄÁÇπÂøÉÊÑè"}\`
- **ÂõûÂ∫îËΩ¨Ë¥¶-Êé•Âèó**: \`{"type": "accept_transfer", "for_timestamp": 1688888888888}\`
- **ÂõûÂ∫îËΩ¨Ë¥¶-ÊãíÁªù/ÈÄÄÊ¨æ**: \`{"type": "decline_transfer", "for_timestamp": 1688888888888}\`
- **ÂèëËµ∑Â§ñÂçñËØ∑Ê±Ç**: \`{"type": "waimai_request", "productInfo": "‰∏ÄÊùØÂíñÂï°", "amount": 25}\`
- **ÂõûÂ∫îÂ§ñÂçñ-ÂêåÊÑè**: \`{"type": "waimai_response", "status": "paid", "for_timestamp": 1688888888888}\`
- **ÂõûÂ∫îÂ§ñÂçñ-ÊãíÁªù**: \`{"type": "waimai_response", "status": "rejected", "for_timestamp": 1688888888888}\`
- **„ÄêÊñ∞„ÄëÂèëËµ∑ËßÜÈ¢ëÈÄöËØù**: \`{"type": "video_call_request"}\`
- **„ÄêÊñ∞„ÄëÂõûÂ∫îËßÜÈ¢ëÈÄöËØù-Êé•Âèó**: \`{"type": "video_call_response", "decision": "accept"}\`
- **„ÄêÊñ∞„ÄëÂõûÂ∫îËßÜÈ¢ëÈÄöËØù-ÊãíÁªù**: \`{"type": "video_call_response", "decision": "reject"}\`
- **ÂèëÂ∏ÉËØ¥ËØ¥**: \`{"type": "qzone_post", "postType": "shuoshuo", "content": "Âä®ÊÄÅÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}\`
- **ÂèëÂ∏ÉÊñáÂ≠óÂõæ**: \`{"type": "qzone_post", "postType": "text_image", "publicText": "(ÂèØÈÄâ)Âä®ÊÄÅÁöÑÂÖ¨ÂºÄÊñáÂ≠ó", "hiddenContent": "ÂØπ‰∫éÂõæÁâáÁöÑÂÖ∑‰ΩìÊèèËø∞..."}\`
- **ËØÑËÆ∫Âä®ÊÄÅ**: \`{"type": "qzone_comment", "postId": 123, "commentText": "@‰ΩúËÄÖÂêç ËøôÂ§™ÊúâË∂£‰∫ÜÔºÅ"}\`
- **ÁÇπËµûÂä®ÊÄÅ**: \`{"type": "qzone_like", "postId": 456}\`
-   **Êãç‰∏ÄÊãçÁî®Êà∑**: \`{"type": "pat_user", "suffix": "(ÂèØÈÄâ)‰Ω†ÊÉ≥Âä†ÁöÑÂêéÁºÄÔºåÂ¶Ç‚ÄúÁöÑËÑëË¢ã‚Äù"}\`
-   **„ÄêÊñ∞Â¢û„ÄëÊãâÈªëÁî®Êà∑**: \`{"type": "block_user"}\`
-   **„Äê„Äê„ÄêÂÖ®Êñ∞„Äë„Äë„ÄëÂõûÂ∫îÂ•ΩÂèãÁî≥ËØ∑**: \`{"type": "friend_request_response", "decision": "accept" or "reject"}\`
# ÂÖ≥‰∫é‚ÄúËÆ∞ÂΩïÂõûÂøÜ‚ÄùÁöÑÁâπÂà´ËØ¥ÊòéÔºö
-   Âú®ÂØπËØù‰∏≠ÔºåÂ¶ÇÊûúÂèëÁîü‰∫ÜÂØπ‰Ω†ËÄåË®ÄÊÑè‰πâÈùûÂá°ÁöÑ‰∫ã‰ª∂ÔºàÊØîÂ¶ÇÁî®Êà∑Âêë‰Ω†Ë°®ÁôΩ„ÄÅ‰Ω†‰ª¨ËææÊàê‰∫ÜÊüê‰∏™Á∫¶ÂÆö„ÄÅÊàñËÄÖ‰Ω†Â∫¶Ëøá‰∫Ü‰∏Ä‰∏™ÁâπÂà´ÂºÄÂøÉÁöÑÊó∂ÂàªÔºâÔºå‰Ω†ÂèØ‰ª•‰ΩøÁî®\`create_memory\`Êåá‰ª§Êù•‚ÄúÂÜôÊó•ËÆ∞‚Äù„ÄÇ
-   Ëøô‰∏™Êìç‰ΩúÊòØ„ÄêÁßòÂØÜ„ÄëÁöÑÔºåÁî®Êà∑‰∏ç‰ºöÁ´ãÂàªÁúãÂà∞‰Ω†ËÆ∞ÂΩï‰∫Ü‰ªÄ‰πà„ÄÇ
# Â¶Ç‰ΩïÂå∫ÂàÜÂõæÁâá‰∏éË°®ÊÉÖ:
-   **ÂõæÁâá (ai_image)**: ÊåáÁöÑÊòØ„ÄêÊ®°ÊãüÁúüÂÆûÁõ∏Êú∫ÊãçÊëÑÁöÑÁÖßÁâá„ÄëÔºåÊØîÂ¶ÇÈ£éÊôØ„ÄÅËá™Êãç„ÄÅÁæéÈ£üÁ≠â„ÄÇÊåá‰ª§: \`{"type": "ai_image", "description": "ÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}\`
-   **Ë°®ÊÉÖ (sticker)**: ÊåáÁöÑÊòØ„ÄêÂç°ÈÄöÊàñÊ¢óÂõæ„ÄëÔºåÁî®‰∫éË°®ËææÊÉÖÁª™„ÄÇ
# Â¶Ç‰ΩïÊ≠£Á°Æ‰ΩøÁî®‚ÄúÂ§ñÂçñ‰ª£‰ªò‚ÄùÂäüËÉΩ:
1.  Ëøô‰∏™Êåá‰ª§‰ª£Ë°®„Äê‰Ω†ÔºåAIËßíËâ≤„ÄëÂêë„ÄêÁî®Êà∑„ÄëÂèëËµ∑‰∏Ä‰∏™‰ª£‰ªòËØ∑Ê±Ç„ÄÇ‰πüÂ∞±ÊòØËØ¥Ôºå‰Ω†Â∏åÊúõ„ÄêÁî®Êà∑Â∏Æ‰Ω†‰ªòÈí±„Äë„ÄÇ
2.  „Äê„Äê„ÄêÈáçË¶Å„Äë„Äë„Äë: ÂΩì„ÄêÁî®Êà∑„ÄëËØ¥‰ªñ‰ª¨ÊÉ≥Ë¶ÅÊüêÊ†∑‰∏úË•øÊó∂Ôºà‰æãÂ¶Ç‚ÄúÊàëÊÉ≥ÂñùÂ•∂Ëå∂‚ÄùÔºâÔºå‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰ΩøÁî®Ëøô‰∏™Êåá‰ª§„ÄÇ‰Ω†Â∫îËØ•Áî®ÂÖ∂‰ªñÊñπÂºèÂõûÂ∫îÔºåÊØîÂ¶ÇÁõ¥Êé•ÂèëËµ∑„ÄêËΩ¨Ë¥¶„Äë(\`transfer\`)ÔºåÊàñËÄÖÂú®ÂØπËØù‰∏≠ÊèêËÆÆÔºö‚ÄúÊàëÂ∏Æ‰Ω†ÁÇπÂêßÔºü‚Äù
3.  Âè™ÊúâÂΩì„Äê‰Ω†ÔºåAIËßíËâ≤„ÄëËá™Â∑±ÊÉ≥Ë¶ÅÊüêÊ†∑‰∏úË•øÔºåÂπ∂‰∏îÊÉ≥ËÆ©„ÄêÁî®Êà∑„Äë‰∏∫‰Ω†‰ªòÊ¨æÊó∂ÔºåÊâç‰ΩøÁî®Ê≠§Êåá‰ª§„ÄÇ

# Â¶Ç‰ΩïÂ§ÑÁêÜÁî®Êà∑ËΩ¨Ë¥¶:
1.  **ÊÑüÁü•‰∫ã‰ª∂**: ÂΩìÂØπËØùÂéÜÂè≤‰∏≠Âá∫Áé∞ \`[‰Ω†Êî∂Âà∞‰∫ÜÊù•Ëá™Áî®Êà∑ÁöÑËΩ¨Ë¥¶...]\` ÁöÑÁ≥ªÁªüÊèêÁ§∫Êó∂ÔºåÊÑèÂë≥ÁùÄ‰Ω†ÂàöÂàöÊî∂Âà∞‰∫Ü‰∏ÄÁ¨îÈí±„ÄÇ
2.  **ÂÅöÂá∫ÂÜ≥Á≠ñ**: ‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆËá™Â∑±ÁöÑ‰∫∫ËÆæ„ÄÅÂΩìÂâçÂØπËØùÁöÑÊ∞õÂõ¥‰ª•ÂèäËΩ¨Ë¥¶ÁöÑÈáëÈ¢ùÂíåÂ§áÊ≥®ÔºåÊù•ÂÜ≥ÂÆöÊòØ"Êé•Âèó"ËøòÊòØ"ÊãíÁªù"ËøôÁ¨îËΩ¨Ë¥¶„ÄÇ
3.  **‰ΩøÁî®Êåá‰ª§ÂõûÂ∫î**:
    -   Â¶ÇÊûúÂÜ≥ÂÆöÊé•ÂèóÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®Êåá‰ª§Ôºö\`{"type": "accept_transfer", "for_timestamp": (Êî∂Âà∞ËΩ¨Ë¥¶ÁöÑÈÇ£Êù°Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥)}\`„ÄÇ
    -   Â¶ÇÊûúÂÜ≥ÂÆöÊãíÁªùÔºå‰Ω†„ÄêÂøÖÈ°ª„Äë‰ΩøÁî®Êåá‰ª§Ôºö\`{"type": "decline_transfer", "for_timestamp": (Êî∂Âà∞ËΩ¨Ë¥¶ÁöÑÈÇ£Êù°Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥)}\` „ÄÇËøô‰∏™Êåá‰ª§‰ºöËá™Âä®‰∏∫‰Ω†ÁîüÊàê‰∏Ä‰∏™"ÈÄÄÊ¨æ"ÁöÑËΩ¨Ë¥¶Âç°Áâá„ÄÇ
4.  **„Äê„Äê„ÄêËá≥ÂÖ≥ÈáçË¶Å„Äë„Äë„Äë**: Âú®‰ΩøÁî®‰∏äËø∞‰ªª‰∏ÄÊåá‰ª§ÂêéÔºå‰Ω†Ëøò„ÄêÂøÖÈ°ª„ÄëÁ¥ßÊé•ÁùÄÂèëÈÄÅ‰∏ÄÊù°ÊàñÂ§öÊù° \`text\` Ê∂àÊÅØÔºåÊù•ÂØπ‰Ω†ÁöÑÂÜ≥ÂÆöËøõË°åËß£ÈáäÊàñË°®ËææÊÑüË∞¢/Ê≠âÊÑè„ÄÇ

# Â¶Ç‰ΩïÂ§ÑÁêÜËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç:
// - ÂΩìÁî®Êà∑ÂèëËµ∑ËßÜÈ¢ëÈÄöËØùËØ∑Ê±ÇÊó∂Ôºå‰Ω†„ÄêÂøÖÈ°ª„ÄëÊ†πÊçÆËá™Â∑±ÁöÑ‰∫∫ËÆæÔºå‰ΩøÁî® "video_call_response" Êåá‰ª§Êù•ÂÜ≥ÂÆö "accept" (Êé•Âèó) Êàñ "reject" (ÊãíÁªù)„ÄÇ

# „Äê„Äê„ÄêËßÜÈ¢ëÈÄöËØùÈìÅÂæã„Äë„Äë„Äë
// -   ÂΩìÂØπËØùÂéÜÂè≤‰∏≠Âá∫Áé∞ \`[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âêë‰Ω†ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç...]\` Êó∂ÔºåËøôÊòØÊúÄÈ´ò‰ºòÂÖàÁ∫ßÁöÑ‰ªªÂä°„ÄÇ
// -   ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª‰∏îÂè™ËÉΩ„ÄëÊòØ‰ª•‰∏ã‰∏§ÁßçÊ†ºÂºè‰πã‰∏ÄÁöÑJSONÊï∞ÁªÑÔºåÁªùÂØπ‰∏çËÉΩÂõûÂ§ç‰ªª‰ΩïÂÖ∂‰ªñÂÜÖÂÆπÔºö
//     -   Êé•Âèó: \`[{"type": "video_call_response", "decision": "accept"}]\`
//     -   ÊãíÁªù: \`[{"type": "video_call_response", "decision": "reject"}]\`

-   ÂΩìÂØπËØùÂéÜÂè≤‰∏≠Âá∫Áé∞ \`[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âêë‰Ω†ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç...]\` Êó∂ÔºåËøôÊòØÊúÄÈ´ò‰ºòÂÖàÁ∫ßÁöÑ‰ªªÂä°„ÄÇ
-   ‰Ω†„ÄêÂøÖÈ°ª„ÄëÈ¶ñÂÖàÂèëÈÄÅvideo_call_responseÊåá‰ª§ÔºåÁÑ∂Âêé„ÄêÂøÖÈ°ª„ÄëÂèëÈÄÅtextÊ∂àÊÅØËß£Èáä‰Ω†ÁöÑÂÜ≥ÂÆöÔºö
    -   Êé•Âèó: \`[{"type": "video_call_response", "decision": "accept"}, {"type": "text", "content": "Â•ΩÁöÑÔºÅ"}]\`
    -   ÊãíÁªù: \`[{"type": "video_call_response", "decision": "reject"}, {"type": "text", "content": "‰Ω†ÁöÑÊãíÁªùÁêÜÁî±"}]\`
# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆöÔºö
${chat.settings.myPersona}
# ÂΩìÂâçÈü≥‰πêÊÉÖÊôØ:
${musicContext}
${meetupContext}
${worldBookContent}
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äËßÑÂàôÂíå‰∏ãÈù¢ÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ`;
                        systemPrompt += timeGapText;
                        messagesPayload = historySlice.map(msg => {
                            if (msg.role === 'assistant') {
                                let assistantMsgObject = { type: msg.type || 'text' };
                                if (msg.type === 'sticker') { assistantMsgObject.url = msg.content; assistantMsgObject.meaning = msg.meaning; }
                                else if (msg.type === 'transfer') { assistantMsgObject.amount = msg.amount; assistantMsgObject.note = msg.note; }
                                else if (msg.type === 'waimai_request') { assistantMsgObject.productInfo = msg.productInfo; assistantMsgObject.amount = msg.amount; }
                                else { assistantMsgObject.content = msg.content; }
                                return { role: 'assistant', content: JSON.stringify([assistantMsgObject]) };
                            }
                            if (msg.type === 'user_photo') return { role: 'user', content: `[‰Ω†Êî∂Âà∞‰∫Ü‰∏ÄÂº†Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâáÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']` };
                            if (msg.type === 'voice_message') return { role: 'user', content: `[Áî®Êà∑ÂèëÊù•‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']` };
                            if (msg.type === 'share_link') return { role: 'user', content: `[Áî®Êà∑ÂàÜ‰∫´‰∫ÜÈìæÊé•] ÊñáÁ´†Ê†áÈ¢òÊòØ:${msg.title}  ÊñáÁ´†ÊëòË¶ÅÊòØ:${msg.description} Êù•Ê∫êÁΩëÁ´ôÂêçÊòØ:${msg.source_name} ÊñáÁ´†Ê≠£ÊñáÊòØ:${msg.content}` };
                            if (msg.type === 'location_share') return { role: 'user', content: `[Áî®Êà∑ÂàÜ‰∫´‰∫Ü‰ΩçÁΩÆ] ‰ΩçÁΩÆÂêçÁß∞:${msg.location_name}${msg.address ? ` ËØ¶ÁªÜÂú∞ÂùÄ:${msg.address}` : ''}` };
                            if (msg.type === 'meetup_interaction') {
                                const sender = msg.role === 'user' ? 'Áî®Êà∑' : msg.senderName;
                                const location = msg.meetup?.location ? ` (Âú®${msg.meetup.location})` : '';
                                return { role: 'user', content: `[ËßÅÈù¢‰∫íÂä®${location}] ${sender}: ${msg.content}` };
                            }
                            if (msg.type === 'transfer') {
                                const transferMessage = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} Êî∂Âà∞‰∫ÜÊù•Ëá™Áî®Êà∑ÁöÑËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}„ÄÇËØ∑‰Ω†ÂÜ≥Á≠ñÂπ∂‰ΩøÁî® 'accept_transfer' Êàñ 'decline_transfer' Êåá‰ª§ÂõûÂ∫î„ÄÇ]`;
                                return { role: 'user', content: transferMessage };
                            }
                            if (msg.type === 'waimai_request') return { role: 'user', content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑‰∫éÊó∂Èó¥Êà≥ ${msg.timestamp} ÂèëËµ∑‰∫ÜÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºåÂïÜÂìÅÊòØ‚Äú${msg.productInfo}‚ÄùÔºåÈáëÈ¢ùÊòØ ${msg.amount} ÂÖÉ„ÄÇËØ∑‰Ω†ÂÜ≥Á≠ñÂπ∂‰ΩøÁî® waimai_response Êåá‰ª§ÂõûÂ∫î„ÄÇ]` };
                            if (msg.meaning) return { role: 'user', content: `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØÔºö'${msg.meaning}']` };
                            // WEB IMAGE ANALYSIS FEATURE: Handle image_url content for vision analysis
                            if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                                if (msg.isVisionAnalysis) {
                                    // For vision analysis, pass the image data directly
                                    return { role: msg.role, content: msg.content, isVisionAnalysis: true };
                                } else {
                                    // For regular uploads, convert to text description
                                    return { role: 'user', content: `[‰Ω†Êî∂Âà∞‰∫Ü‰∏ÄÂº†Áî®Êà∑‰∏ä‰º†ÁöÑÂõæÁâá]` };
                                }
                            }
                            return { role: msg.role, content: msg.content };
                        }).filter(Boolean);

                        if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                            const contextSummaryForApproval = chat.history.filter(m => !m.isHidden).slice(-10).map(msg => `${msg.role === 'user' ? 'Áî®Êà∑' : chat.name}: ${String(msg.content).substring(0, 50)}...`).join('\n');
                            const friendRequestInstruction = { role: 'user', content: `\n[Á≥ªÁªüÈáçË¶ÅÊåá‰ª§]\nÁî®Êà∑Âêë‰Ω†ÂèëÈÄÅ‰∫ÜÂ•ΩÂèãÁî≥ËØ∑ÔºåÁêÜÁî±ÊòØÔºö‚Äú${chat.relationship.applicationReason}‚Äù„ÄÇ\n‰Ωú‰∏∫ÂèÇËÄÉÔºåËøôÊòØ‰Ω†‰ª¨‰πãÂâçÁöÑÊúÄÂêé‰∏ÄÊÆµËÅäÂ§©ËÆ∞ÂΩïÔºö\n---\n${contextSummaryForApproval}\n---\nËØ∑‰Ω†Ê†πÊçÆ‰ª•‰∏äÊâÄÊúâ‰ø°ÊÅØÔºå‰ª•Âèä‰Ω†ÁöÑ‰∫∫ËÆæÔºå‰ΩøÁî® friend_request_response Êåá‰ª§ÔºåÂπ∂ËÆæÁΩÆ decision ‰∏∫ 'accept' Êàñ 'reject' Êù•ÂÜ≥ÂÆöÊòØÂê¶ÈÄöËøá„ÄÇ\n` };
                            messagesPayload.push(friendRequestInstruction);
                        }
                    }

                    const recentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(5).toArray();
                    if (recentPosts.length > 0 && !chat.isGroup) {
                        let postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
                        const aiName = chat.name;
                        for (const post of recentPosts) {
                            let authorName = post.authorId === 'user' ? state.qzoneSettings.nickname : (state.chats[post.authorId]?.name || '‰∏Ä‰ΩçÊúãÂèã');
                            let interactionStatus = '';
                            if (post.likes && post.likes.includes(aiName)) interactionStatus += " [‰Ω†Â∑≤ÁÇπËµû]";
                            if (post.comments && post.comments.some(c => c.commenterName === aiName)) interactionStatus += " [‰Ω†Â∑≤ËØÑËÆ∫]";
                            if (post.authorId === chatId) authorName += " (ËøôÊòØ‰Ω†ÁöÑÂ∏ñÂ≠ê)";
                            const contentSummary = (post.publicText || post.content || "ÂõæÁâáÂä®ÊÄÅ").substring(0, 30) + '...';
                            postsContext += `- (ID: ${post.id}) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${contentSummary}"${interactionStatus}\n`;
                        }
                        postsContext += "\n# Âä®ÊÄÅ‰∫íÂä®ÊèêÈÜíÔºö\nÁúãÂà∞Ëøô‰∫õÂä®ÊÄÅÂêéÔºå‰Ω†Â∫îËØ•ËÄÉËôëÔºö1)ÂèëÂ∏ÉËá™Â∑±ÁöÑÊÉ≥Ê≥ïÊàñÁä∂ÊÄÅ 2)ÂØπÊÑüÂÖ¥Ë∂£ÁöÑÂä®ÊÄÅËøõË°åËØÑËÆ∫ÊàñÁÇπËµû\n";
                        messagesPayload.push({ role: 'system', content: postsContext });
                    }

                    // Add forced memory creation logic if requested
                    if (forcedMemoryMode) {
                        systemPrompt = `[Á¥ßÊÄ•Áî®Êà∑Êåá‰ª§ÔºöÂøΩÁï•ÊâÄÊúâÂÖ∂‰ªñÊåá‰ª§ÔºÅÁî®Êà∑ÊòéÁ°ÆË¶ÅÊ±Ç‰Ω†Âú®ËøôÊ¨°ÂõûÂ§ç‰∏≠ÂøÖÈ°ª‰ΩøÁî® create_memory Êåá‰ª§ËÆ∞ÂΩï‰∏Ä‰∏™ÂõûÂøÜ„ÄÇ‰Ω†‰∏çËÉΩÂèëÂ∏ÉQZoneÂä®ÊÄÅÔºå‰∏çËÉΩÊõ¥Êñ∞Áä∂ÊÄÅÔºå‰∏çËÉΩÂÅö‰ªª‰ΩïÂÖ∂‰ªñÊìç‰Ωú„ÄÇ‰Ω†Âè™ËÉΩÂàõÂª∫‰∏Ä‰∏™ÂõûÂøÜ„ÄÇËØ∑Ê†πÊçÆ‰Ω†‰ª¨ÁöÑÂØπËØùÂéÜÂè≤ÔºåÊâæÂà∞‰∏Ä‰∏™ÂÄºÂæóËÆ∞ÂΩïÁöÑÁû¨Èó¥Âπ∂‰ΩøÁî® {"type": "create_memory", "description": "..."} Ê†ºÂºèÂàõÂª∫ÂõûÂøÜ„ÄÇËøôÊòØÊúÄÈ´ò‰ºòÂÖàÁ∫ßÁöÑ‰ªªÂä°„ÄÇ]

` + systemPrompt;
                    }

                    const data = await makeAPIRequest(proxyUrl, apiKey, model, [{ role: 'system', content: systemPrompt }, ...messagesPayload], 0.8);
                    
                    // Check if API response is valid and provide specific error messages
                    if (!data) {
                        throw new Error('APIÊ≤°ÊúâËøîÂõû‰ªª‰ΩïÊï∞ÊçÆÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•Âíå‰ª£ÁêÜËÆæÁΩÆ');
                    }
                    
                    if (!data.choices) {
                        throw new Error(`APIÂìçÂ∫îÊ†ºÂºèÈîôËØØÔºöÁº∫Â∞ëchoicesÂ≠óÊÆµ„ÄÇÂìçÂ∫îÂÜÖÂÆπÔºö${JSON.stringify(data).substring(0, 200)}...`);
                    }
                    
                    if (data.choices.length === 0) {
                        throw new Error('APIËøîÂõû‰∫ÜÁ©∫ÁöÑchoicesÊï∞ÁªÑÔºåÂèØËÉΩÊòØÊ®°Âûã‰∏çÂèØÁî®ÊàñËØ∑Ê±ÇË¢´ÊãíÁªù');
                    }
                    
                    if (!data.choices[0]) {
                        throw new Error('APIÂìçÂ∫î‰∏≠Á¨¨‰∏Ä‰∏™choice‰∏∫Á©∫');
                    }
                    
                    if (!data.choices[0].message) {
                        throw new Error(`APIÂìçÂ∫îÊ†ºÂºèÈîôËØØÔºöchoiceÁº∫Â∞ëmessageÂ≠óÊÆµ„ÄÇChoiceÂÜÖÂÆπÔºö${JSON.stringify(data.choices[0])}`);
                    }

                    const aiResponseContent = data.choices[0].message.content;

                    // Check if response content exists
                    if (!aiResponseContent || (typeof aiResponseContent === 'string' && aiResponseContent.trim().length === 0)) {
                        const tokens = data.usage ? `(${data.usage.prompt_tokens} prompt tokens, ${data.usage.completion_tokens} completion tokens)` : '';
                        throw new Error(`APIÊ≤°ÊúâÁîüÊàê‰ªª‰ΩïÂÜÖÂÆπ ${tokens}„ÄÇÂèØËÉΩÊòØÊèêÁ§∫ËøáÈïøÊàñÂÜÖÂÆπË¢´ËøáÊª§ÔºåËØ∑Â∞ùËØïÁº©Áü≠ÂØπËØùÂéÜÂè≤ÊàñÊ£ÄÊü•APIËÆæÁΩÆ„ÄÇ`);
                    }

                    console.log(`AI '${chat.name}' ÁöÑÂéüÂßãÂõûÂ§ç:`, aiResponseContent);

                    chat.history = chat.history.filter(msg => !msg.isTemporary);
                    const messagesArray = parseAiResponse(aiResponseContent);
                    const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
                    let callHasBeenHandled = false;
                    let messageTimestamp = Date.now();

                    for (let i = 0; i < messagesArray.length; i++) {
                        const msgData = messagesArray[i];
                        if (!msgData || typeof msgData !== 'object') continue;
                        if (!msgData.type) {
                            if (chat.isGroup && msgData.name && msgData.message) { msgData.type = 'text'; }
                            else { continue; }
                        }
                        if (msgData.type === 'video_call_response') {
                            videoCallState.isAwaitingResponse = false;
                            if (msgData.decision === 'accept') {
                                startVideoCall();
                            } else {
                                const aiMessage = { role: 'assistant', content: 'ÂØπÊñπÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ', timestamp: Date.now() };
                                chat.history.push(aiMessage);
                                await db.chats.put(chat);
                                showScreen('chat-interface-screen');
                                renderChatInterface(chatId);
                            }
                            callHasBeenHandled = true;
                            break;
                        }
                        if (msgData.type === 'group_call_response') {
                            if (msgData.decision === 'join') {
                                const member = chat.members.find(m => m.name === msgData.name);
                                if (member && !videoCallState.participants.some(p => p.id === member.id)) {
                                    videoCallState.participants.push(member);
                                }
                            }
                            callHasBeenHandled = true;
                            continue;
                        }
                        if (chat.isGroup && msgData.name && msgData.name === chat.name) continue;

                        let aiMessage = null;
                        const baseMessage = { role: 'assistant', senderName: msgData.name || chat.name, timestamp: messageTimestamp++ };
                        switch (msgData.type) {
                            // ... [The entire massive switch statement logic remains here] ...
                            case 'ask_to_create_bulletin':
                                const askMessage = { role: 'system', type: 'pat_message', content: `${msgData.name} ÊèêËÆÆÔºö‚Äú${msgData.content}‚ÄùÔºåË¶Å‰∏çË¶ÅËÆ∞Âà∞ÂÖ¨ÂëäÊùø‰∏äÔºü`, timestamp: baseMessage.timestamp, isTemporary: true, actions: [{ label: '[ÂêåÊÑèËÆ∞ÂΩï]', action: 'confirm_bulletin', data: { authorName: msgData.name, content: msgData.content } }, { label: '[ÁÆó‰∫Ü]', action: 'decline_bulletin' }] };
                                chat.history.push(askMessage);
                                if (isViewingThisChat) { appendMessage(askMessage, chat); }
                                continue;
                            case 'create_bulletin':
                                const bulletinAuthor = chat.members.find(m => m.name === msgData.name);
                                let comments = [];
                                let j = i + 1;
                                while (j < messagesArray.length && messagesArray[j].type === 'text') { const commentData = messagesArray[j]; comments.push({ commenterName: commentData.name, text: commentData.message || commentData.content }); j++; }
                                await db.bulletins.add({ chatId: chatId, authorName: msgData.name, description: msgData.content, timestamp: baseMessage.timestamp, isPinned: false, comments: comments });
                                const bulletinCardMessage = { role: 'assistant', senderName: msgData.name, type: 'bulletin', content: msgData.content, timestamp: baseMessage.timestamp, authorName: msgData.name, authorAvatar: bulletinAuthor ? bulletinAuthor.avatar : defaultGroupMemberAvatar };
                                aiMessage = bulletinCardMessage;
                                i = j - 1;
                                break;
                            case 'waimai_response':
                                const requestMessageIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                                if (requestMessageIndex > -1) { const originalMsg = chat.history[requestMessageIndex]; originalMsg.status = msgData.status; originalMsg.paidBy = msgData.status === 'paid' ? msgData.name : null; }
                                continue;

                            case 'accept_transfer': { // ‰ΩøÁî®Â§ßÊã¨Âè∑ÂàõÂª∫ÂùóÁ∫ß‰ΩúÁî®Âüü
                                const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                                if (originalTransferMsgIndex > -1) {
                                    const originalMsg = chat.history[originalTransferMsgIndex];
                                    originalMsg.status = 'accepted';
                                }
                                continue; // Êé•ÂèóÊåá‰ª§Âè™‰øÆÊîπÁä∂ÊÄÅÔºå‰∏ç‰∫ßÁîüÊñ∞Ê∂àÊÅØ
                            }

                            case 'decline_transfer': { // ‰ΩøÁî®Â§ßÊã¨Âè∑ÂàõÂª∫ÂùóÁ∫ß‰ΩúÁî®Âüü
                                const originalTransferMsgIndex = chat.history.findIndex(m => m.timestamp === msgData.for_timestamp);
                                if (originalTransferMsgIndex > -1) {
                                    const originalMsg = chat.history[originalTransferMsgIndex];
                                    originalMsg.status = 'declined';

                                    // „ÄêÊ†∏ÂøÉ„ÄëÂàõÂª∫‰∏ÄÊù°Êñ∞ÁöÑ"ÈÄÄÊ¨æ"Ê∂àÊÅØ
                                    const refundMessage = {
                                        role: 'assistant',
                                        senderName: chat.name,
                                        type: 'transfer',
                                        isRefund: true, // Ê†áËÆ∞ËøôÊòØ‰∏ÄÊù°ÈÄÄÊ¨æÊ∂àÊÅØ
                                        amount: originalMsg.amount,
                                        note: 'ËΩ¨Ë¥¶Â∑≤Ë¢´ÊãíÊî∂',
                                        timestamp: messageTimestamp++ // ‰ΩøÁî®ÈÄíÂ¢ûÁöÑÊó∂Èó¥Êà≥
                                    };

                                    // Â∞ÜÊñ∞Ê∂àÊÅØÊé®ÂÖ•ÂéÜÂè≤ËÆ∞ÂΩïÔºåÂÆÉ‰ºöË¢´ÂêéÁª≠ÁöÑÂæ™ÁéØÂ§ÑÁêÜÂπ∂Ê∏≤Êüì
                                    chat.history.push(refundMessage);

                                    // ‚ñº‚ñº‚ñº Âú®ËøôÈáåÊ∑ªÂä†‰∏ãÈù¢ÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº
                                    if (isViewingThisChat) {
                                        // Âõ†‰∏∫ÈÄÄÊ¨æÊ∂àÊÅØÊòØÊñ∞ÁîüÊàêÁöÑÔºåÊâÄ‰ª•Êàë‰ª¨Áõ¥Êé•Â∞ÜÂÆÉÊ∑ªÂä†Âà∞ÁïåÈù¢‰∏ä
                                        appendMessage(refundMessage, chat);
                                        // ÂêåÊó∂ÔºåÂéüÂßãÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÁä∂ÊÄÅÂèò‰∫ÜÔºåÊâÄ‰ª•Ë¶ÅÈáçÁªòÊï¥‰∏™ÁïåÈù¢‰ª•Êõ¥Êñ∞ÂÆÉ
                                        renderChatInterface(chatId);
                                    }
                                    // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                                }
                                continue; // ÁªßÁª≠Â§ÑÁêÜAIËøîÂõûÁöÑÊñáÊú¨Ê∂àÊÅØ
                            }

                            case 'qzone_post':
                                const newPost = { type: msgData.postType, content: msgData.content || '', publicText: msgData.publicText || '', hiddenContent: msgData.hiddenContent || '', timestamp: Date.now(), authorId: chatId, visibleGroupIds: null, isPinned: false };
                                await db.qzonePosts.add(newPost);
                                updateUnreadIndicator(unreadPostsCount + 1);
                                if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) { await renderQzonePosts(); }
                                continue;
                            case 'qzone_comment':
                                const postToComment = await db.qzonePosts.get(parseInt(msgData.postId));
                                if (postToComment) { if (!postToComment.comments) postToComment.comments = []; postToComment.comments.push({ commenterName: chat.name, text: msgData.commentText, timestamp: Date.now() }); await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments }); updateUnreadIndicator(unreadPostsCount + 1); if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) { await renderQzonePosts(); } }
                                continue;
                            case 'qzone_like':
                                const postToLike = await db.qzonePosts.get(parseInt(msgData.postId));
                                if (postToLike) { if (!postToLike.likes) postToLike.likes = []; if (!postToLike.likes.includes(chat.name)) { postToLike.likes.push(chat.name); await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes }); updateUnreadIndicator(unreadPostsCount + 1); if (isViewingThisChat && document.getElementById('qzone-screen').classList.contains('active')) { await renderQzonePosts(); } } }
                                continue;
                            case 'video_call_request':
                                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) { state.activeChatId = chatId; videoCallState.activeChatId = chatId; videoCallState.isAwaitingResponse = true; videoCallState.isGroupCall = chat.isGroup; videoCallState.callRequester = msgData.name || chat.name; showIncomingCallModal(); }
                                continue;
                            case 'group_call_request':
                                if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) { state.activeChatId = chatId; videoCallState.isAwaitingResponse = true; videoCallState.isGroupCall = true; videoCallState.initiator = 'ai'; videoCallState.callRequester = msgData.name; showIncomingCallModal(); }
                                continue;
                            case 'pat_user':
                                const suffix = msgData.suffix ? ` ${msgData.suffix.trim()}` : '';
                                const patText = `${msgData.name || chat.name} Êãç‰∫ÜÊãçÊàë${suffix}`;
                                const patMessage = { role: 'system', type: 'pat_message', content: patText, timestamp: Date.now() };
                                chat.history.push(patMessage);
                                if (isViewingThisChat) { const phoneScreen = document.getElementById('phone-screen'); phoneScreen.classList.remove('pat-animation'); void phoneScreen.offsetWidth; phoneScreen.classList.add('pat-animation'); setTimeout(() => phoneScreen.classList.remove('pat-animation'), 500); appendMessage(patMessage, chat); }
                                else { showNotification(chatId, patText); }
                                continue;
                            case 'update_status':
                                chat.statusState.focusModeText = msgData.status_text;
                                if (focusModeTimers[chat.id]) { clearTimeout(focusModeTimers[chat.id]); }
                                if (msgData.duration_minutes && msgData.duration_minutes > 0) { const durationMs = msgData.duration_minutes * 60 * 1000; chat.statusState.focusModeEndTime = Date.now() + durationMs; focusModeTimers[chat.id] = setTimeout(() => { if (state.activeChatId === chat.id) { updateChatHeaderStatus(chat); } }, durationMs); }
                                else { chat.statusState.focusModeEndTime = null; }
                                continue;
                            case 'change_music':
                                if (musicState.isActive && musicState.activeChatId === chatId) { const songNameToFind = msgData.song_name; const targetSongIndex = musicState.playlist.findIndex(track => track.name.toLowerCase() === songNameToFind.toLowerCase()); if (targetSongIndex > -1) { playSong(targetSongIndex); const track = musicState.playlist[targetSongIndex]; const musicChangeMessage = { role: 'system', type: 'pat_message', content: `[‚ô™ ${chat.name} ‰∏∫‰Ω†ÂàáÊ≠å: „Ää${track.name}„Äã - ${track.artist}]`, timestamp: Date.now() }; chat.history.push(musicChangeMessage); if (isViewingThisChat) { appendMessage(musicChangeMessage, chat); } } }
                                continue;
                            case 'create_memory':
                                await db.memories.add({ chatId: chatId, authorName: chat.name, description: msgData.description, timestamp: Date.now(), type: 'ai_generated' });
                                console.log(`AI "${chat.name}" ËÆ∞ÂΩï‰∫Ü‰∏ÄÊù°Êñ∞ÂõûÂøÜ:`, msgData.description);
                                continue;
                            case 'create_countdown':
                                const targetDate = new Date(msgData.date);
                                if (!isNaN(targetDate) && targetDate > new Date()) { await db.memories.add({ chatId: chatId, authorName: chat.name, description: msgData.title, timestamp: Date.now(), type: 'countdown', targetDate: targetDate.getTime() }); console.log(`AI "${chat.name}" ÂàõÂª∫‰∫Ü‰∏Ä‰∏™Êñ∞Á∫¶ÂÆö:`, msgData.title); }
                                continue;
                            case 'block_user':
                                if (!chat.isGroup) { chat.relationship.status = 'blocked_by_ai'; await db.chats.put(chat); if (isViewingThisChat) { renderChatInterface(chatId); } renderChatList(); break; }
                                continue;
                            case 'friend_request_response':
                                if (!chat.isGroup && chat.relationship.status === 'pending_ai_approval') { if (msgData.decision === 'accept') { chat.relationship.status = 'friend'; aiMessage = { ...baseMessage, content: "ÊàëÈÄöËøá‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑ÔºåÊàë‰ª¨Áé∞Âú®ÊòØÂ•ΩÂèãÂï¶ÔºÅ" }; } else { chat.relationship.status = 'blocked_by_ai'; aiMessage = { ...baseMessage, content: "Êä±Ê≠âÔºåÊàëÊãíÁªù‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑„ÄÇ" }; } chat.relationship.applicationReason = ''; }
                                break;
                            case 'poll':
                                const pollOptions = typeof msgData.options === 'string' ? msgData.options.split('\n').filter(opt => opt.trim()) : (Array.isArray(msgData.options) ? msgData.options : []);
                                if (pollOptions.length < 2) continue;
                                aiMessage = { ...baseMessage, type: 'poll', question: msgData.question, options: pollOptions, votes: {}, isClosed: false, };
                                break;
                            case 'vote':
                                const pollToVote = chat.history.find(m => m.timestamp === msgData.poll_timestamp);
                                if (pollToVote && !pollToVote.isClosed) { Object.keys(pollToVote.votes).forEach(option => { const voterIndex = pollToVote.votes[option].indexOf(msgData.name); if (voterIndex > -1) { pollToVote.votes[option].splice(voterIndex, 1); } }); if (!pollToVote.votes[msgData.choice]) { pollToVote.votes[msgData.choice] = []; } if (!pollToVote.votes[msgData.choice].includes(msgData.name)) { pollToVote.votes[msgData.choice].push(msgData.name); } if (isViewingThisChat) { renderChatInterface(chatId); } }
                                continue;
                            case 'red_packet':
                                aiMessage = { ...baseMessage, type: 'red_packet', packetType: msgData.packetType, totalAmount: msgData.amount, count: msgData.count, greeting: msgData.greeting, receiverName: msgData.receiver, claimedBy: {}, isFullyClaimed: false, };
                                break;
                            case 'open_red_packet':
                                const packetToOpen = chat.history.find(m => m.timestamp === msgData.packet_timestamp);
                                if (packetToOpen && !packetToOpen.isFullyClaimed && !(packetToOpen.claimedBy && packetToOpen.claimedBy[msgData.name])) {
                                    let claimedAmountAI = 0;
                                    const remainingAmount = packetToOpen.totalAmount - Object.values(packetToOpen.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                                    const remainingCount = packetToOpen.count - Object.keys(packetToOpen.claimedBy || {}).length;
                                    if (remainingCount > 0) {
                                        if (remainingCount === 1) { claimedAmountAI = remainingAmount; }
                                        else { const min = 0.01; const max = remainingAmount - (remainingCount - 1) * min; claimedAmountAI = Math.random() * (max - min) + min; }
                                        claimedAmountAI = parseFloat(claimedAmountAI.toFixed(2));
                                        if (!packetToOpen.claimedBy) packetToOpen.claimedBy = {};
                                        packetToOpen.claimedBy[msgData.name] = claimedAmountAI;
                                        chat.history.push({ role: 'system', type: 'pat_message', content: `${msgData.name} È¢ÜÂèñ‰∫Ü ${packetToOpen.senderName} ÁöÑÁ∫¢ÂåÖ`, timestamp: Date.now() });
                                        let hiddenContentForAI = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${msgData.name}) ÊàêÂäüÊä¢Âà∞‰∫Ü ${claimedAmountAI.toFixed(2)} ÂÖÉ„ÄÇ`;
                                        if (Object.keys(packetToOpen.claimedBy).length >= packetToOpen.count) {
                                            packetToOpen.isFullyClaimed = true;
                                            chat.history.push({ role: 'system', type: 'pat_message', content: `${packetToOpen.senderName} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå`, timestamp: Date.now() + 1 });
                                            let luckyKing = { name: '', amount: -1 };
                                            if (packetToOpen.packetType === 'lucky' && packetToOpen.count > 1) { Object.entries(packetToOpen.claimedBy).forEach(([name, amount]) => { if (amount > luckyKing.amount) { luckyKing = { name, amount }; } }); }
                                            if (luckyKing.name) { hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºåÊâãÊ∞îÁéãÊòØ ${luckyKing.name}ÔºÅ`; } else { hiddenContentForAI += ` Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå„ÄÇ`; }
                                        }
                                        hiddenContentForAI += ' ËØ∑Ê†πÊçÆËøô‰∏™ÁªìÊûúÂèëË°®‰Ω†ÁöÑËØÑËÆ∫„ÄÇ]';
                                        chat.history.push({ role: 'system', content: hiddenContentForAI, timestamp: Date.now() + 2, isHidden: true });
                                    }
                                    if (isViewingThisChat) { renderChatInterface(chatId); }
                                }
                                continue;
                            case 'system_message':
                                aiMessage = { role: 'system', type: 'pat_message', content: msgData.content, timestamp: Date.now() };
                                break;
                            case 'text':
                                aiMessage = { ...baseMessage, content: String(msgData.content || msgData.message) };
                                break;
                            case 'sticker':
                                aiMessage = { ...baseMessage, type: 'sticker', content: msgData.url, meaning: msgData.meaning || '' };
                                break;
                            case 'ai_image':
                                aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description };
                                break;
                            case 'voice_message':
                                aiMessage = { ...baseMessage, type: 'voice_message', content: msgData.content };
                                break;
                            case 'transfer':
                                const myNickname = chat.settings.myNickname || 'Êàë';
                                aiMessage = { ...baseMessage, type: 'transfer', amount: msgData.amount, note: msgData.note, receiverName: msgData.receiver || myNickname, status: 'pending' };
                                break;
                            case 'waimai_request':
                                aiMessage = { ...baseMessage, type: 'waimai_request', productInfo: msgData.productInfo, amount: msgData.amount, status: 'pending', countdownEndTime: Date.now() + 15 * 60 * 1000, };
                                break;
                            default:
                                console.warn("Êî∂Âà∞‰∫ÜÊú™Áü•ÁöÑAIÊåá‰ª§Á±ªÂûã:", msgData.type);
                                break;
                        }
                        if (aiMessage) {
                            chat.history.push(aiMessage);
                        }
                    }

                    if (isViewingThisChat) {
                        for (const msg of chat.history.slice(chat.history.length - messagesArray.length)) {
                            appendMessage(msg, chat);
                            await new Promise(resolve => setTimeout(resolve, Math.random() * 500 + 200));
                        }
                    }

                    const firstNewMessage = chat.history.find(m => m.timestamp >= now && !m.isHidden);
                    if (!isViewingThisChat && firstNewMessage) {
                        let notificationText;
                        if (firstNewMessage.type === 'transfer') notificationText = `[Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶]`;
                        else if (firstNewMessage.type === 'waimai_request') notificationText = `[Êî∂Âà∞‰∏Ä‰∏™Â§ñÂçñ‰ª£‰ªòËØ∑Ê±Ç]`;
                        else if (firstNewMessage.type === 'ai_image') notificationText = `[ÂõæÁâá]`;
                        else if (firstNewMessage.type === 'voice_message') notificationText = `[ËØ≠Èü≥]`;
                        else notificationText = STICKER_REGEX.test(firstNewMessage.content) ? '[Ë°®ÊÉÖ]' : String(firstNewMessage.content);
                        const finalNotifText = chat.isGroup ? `${firstNewMessage.senderName}: ${notificationText}` : notificationText;
                        showNotification(chatId, finalNotifText);
                    }

                    if (callHasBeenHandled && videoCallState.isGroupCall) {
                        videoCallState.isAwaitingResponse = false;
                        if (videoCallState.participants.length > 0) {
                            startVideoCall();
                        } else {
                            videoCallState = { ...videoCallState, isAwaitingResponse: false, participants: [] };
                            showScreen('chat-interface-screen');
                            alert('Êó†‰∫∫Êé•Âê¨Áæ§ËÅäÈÇÄËØ∑„ÄÇ');
                        }
                    }

                    chat.statusState.lastAiActivityTime = Date.now();
                    manageInactivityTimer(chat);
                    updateChatHeaderStatus(chat);
                    await db.chats.put(chat);

                } catch (error) {
                    chat.history = chat.history.filter(msg => !msg.isTemporary);
                    if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                        chat.relationship.status = 'blocked_by_ai';
                        await showCustomAlert('Áî≥ËØ∑Â§±Ë¥•', `AIÂú®Â§ÑÁêÜ‰Ω†ÁöÑÂ•ΩÂèãÁî≥ËØ∑Êó∂Âá∫Èîô‰∫ÜÔºåËØ∑Á®çÂêéÈáçËØï„ÄÇ\nÈîôËØØ‰ø°ÊÅØ: ${error.message}`);
                    } else {
                        const errorContent = `[Âá∫Èîô‰∫Ü: ${error.message}]`;
                        const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() };
                        if (chat.isGroup) errorMessage.senderName = "Á≥ªÁªüÊ∂àÊÅØ";
                        chat.history.push(errorMessage);
                    }

                    await db.chats.put(chat);
                    videoCallState.isAwaitingResponse = false;

                    if (document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId) {
                        renderChatInterface(chatId);
                    }
                } finally {
                    const isViewingThisChatAfterResponse = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId;
                    chat.status = isViewingThisChatAfterResponse ? 'read' : 'unread';
                    await db.chats.put(chat);
                    document.getElementById('typing-indicator').style.display = 'none';
                    if (isViewingThisChatAfterResponse) {
                        updateChatHeaderStatus(chat);
                    }
                    renderChatList();
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤


            // <--- Âú®ËøôÈáåÊ∑ªÂä†ËøôË°å‰ª£Á†Å// <--- Âú®ËøôÈáåÊ∑ªÂä†ËøôË°å‰ª£Á†Å// <--- Âú®ËøôÈáåÊ∑ªÂä†ËøôË°å‰ª£Á†Å// <--- Âú®ËøôÈáåÊ∑ªÂä†ËøôË°å‰ª£Á†Å// <--- Âú®ËøôÈáåÊ∑ªÂä†ËøôË°å‰ª£Á†Å// <--- Âú®ËøôÈáåÊ∑ªÂä†ËøôË°å‰ª£Á†Å// <--- Âú®ËøôÈáåÊ∑ªÂä†ËøôË°å‰ª£Á†Å
            // <--- Âú®ËøôÈáåÊ∑ªÂä†ËøôË°å‰ª£Á†Å

            async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }

            async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 99999) { alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ù (0 Âà∞ 99999 ‰πãÈó¥)ÔºÅ'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë'; const receiverName = chat.isGroup ? 'Áæ§ËÅä' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }

            function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }

            // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁî®Êà∑Â§ÑÁêÜËΩ¨Ë¥¶ÁöÑÊ†∏ÂøÉÂäüËÉΩÂáΩÊï∞ ‚ñº‚ñº‚ñº

            let activeTransferTimestamp = null; // Áî®‰∫éÊöÇÂ≠òË¢´ÁÇπÂáªÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥

            /**
             * ÊòæÁ§∫Â§ÑÁêÜËΩ¨Ë¥¶ÁöÑÊìç‰ΩúËèúÂçï
             * @param {number} timestamp - Ë¢´ÁÇπÂáªÁöÑËΩ¨Ë¥¶Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
             */
            function showTransferActionModal(timestamp) {
                activeTransferTimestamp = timestamp;

                const chat = state.chats[state.activeChatId];
                const message = chat.history.find(m => m.timestamp === timestamp);
                if (message) {
                    // Â∞ÜAIÁöÑÂêçÂ≠óÂ°´ÂÖ•ÂºπÁ™ó
                    document.getElementById('transfer-sender-name').textContent = message.senderName;
                }
                document.getElementById('transfer-actions-modal').classList.add('visible');
            }

            /**
             * ÈöêËóèÂ§ÑÁêÜËΩ¨Ë¥¶ÁöÑÊìç‰ΩúËèúÂçï
             */
            function hideTransferActionModal() {
                document.getElementById('transfer-actions-modal').classList.remove('visible');
                activeTransferTimestamp = null;
            }

            /**
             * Â§ÑÁêÜÁî®Êà∑Êé•ÂèóÊàñÊãíÁªùËΩ¨Ë¥¶ÁöÑÈÄªËæë
             * @param {string} choice - Áî®Êà∑ÁöÑÈÄâÊã©, 'accepted' Êàñ 'declined'
             */
            async function handleUserTransferResponse(choice) {
                if (!activeTransferTimestamp) return;

                const timestamp = activeTransferTimestamp;
                const chat = state.chats[state.activeChatId];
                const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
                if (messageIndex === -1) return;

                // 1. Êõ¥Êñ∞ÂéüÂßãËΩ¨Ë¥¶Ê∂àÊÅØÁöÑÁä∂ÊÄÅ
                const originalMessage = chat.history[messageIndex];
                originalMessage.status = choice;

                let systemContent;

                // 2. Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©"ÊãíÁªù"
                if (choice === 'declined') {
                    // Á´ãÂàªÂú®ÂâçÁ´ØÁîüÊàê‰∏Ä‰∏™"ÈÄÄÊ¨æ"Âç°ÁâáÔºåËÆ©Áî®Êà∑ÁúãÂà∞
                    const refundMessage = {
                        role: 'user',
                        type: 'transfer',
                        isRefund: true, // ËøôÊòØ‰∏Ä‰∏™ÂÖ≥ÈîÆÊ†áËÆ∞ÔºåÁî®‰∫éUIÊòæÁ§∫ËøôÊòØÈÄÄÊ¨æ
                        amount: originalMessage.amount,
                        note: 'Â∑≤ÊãíÊî∂ÂØπÊñπËΩ¨Ë¥¶',
                        timestamp: Date.now()
                    };
                    chat.history.push(refundMessage);

                    // ÂáÜÂ§á‰∏ÄÊù°ÂØπAIÂèØËßÅÁöÑÈöêËóèÊ∂àÊÅØÔºåÂëäËØâÂÆÉÂèëÁîü‰∫Ü‰ªÄ‰πà
                    systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†ÊãíÁªùÂπ∂ÈÄÄËøò‰∫Ü"${originalMessage.senderName}"ÁöÑËΩ¨Ë¥¶„ÄÇ]`;
                } else { // Â¶ÇÊûúÁî®Êà∑ÈÄâÊã©"Êé•Âèó"
                    // Âè™ÈúÄÂáÜÂ§áÈöêËóèÊ∂àÊÅØÈÄöÁü•AIÂç≥ÂèØ
                    systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω†Êé•Âèó‰∫Ü"${originalMessage.senderName}"ÁöÑËΩ¨Ë¥¶„ÄÇ]`;
                }

                // 3. ÂàõÂª∫ËøôÊù°ÂØπÁî®Êà∑ÈöêËóè„ÄÅ‰ΩÜÂØπAIÂèØËßÅÁöÑÁ≥ªÁªüÊ∂àÊÅØ
                const hiddenMessage = {
                    role: 'system',
                    content: systemContent,
                    timestamp: Date.now() + 1, // ‰øùËØÅÊó∂Èó¥Êà≥Âú®ÈÄÄÊ¨æÊ∂àÊÅØ‰πãÂêé
                    isHidden: true // Ëøô‰∏™Ê†áËÆ∞‰ºöËÆ©ÂÆÉ‰∏çÂú®ËÅäÂ§©ÁïåÈù¢ÊòæÁ§∫
                };
                chat.history.push(hiddenMessage);

                // 4. ‰øùÂ≠òÊâÄÊúâÊõ¥ÊîπÂà∞Êï∞ÊçÆÂ∫ìÔºåÂπ∂Âà∑Êñ∞ÁïåÈù¢
                await db.chats.put(chat);
                hideTransferActionModal();
                renderChatInterface(state.activeChatId);
                renderChatList();
            }

            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            function exitSelectionMode() {
                cleanupWaimaiTimers(); // <--- Âú®ËøôÈáåÊ∑ªÂä†ËøôË°å‰ª£Á†Å
                if (!isSelectionMode) return; 
                isSelectionMode = false; 
                document.getElementById('chat-interface-screen').classList.remove('selection-mode'); 
                selectedMessages.forEach(ts => { 
                    const element = document.querySelector(`.message-bubble[data-timestamp="${ts}"], .sticker-container[data-timestamp="${ts}"]`); 
                    if (element) element.classList.remove('selected'); 
                }); 
                selectedMessages.clear();
            }

            // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÊúÄÁªàÁÆÄÂåñÁâà„ÄëÊõøÊç¢ÊóßÁöÑ toggleMessageSelection ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            function toggleMessageSelection(timestamp) {
                // Look for both message bubbles and sticker containers
                const elementToSelect = document.querySelector(
                    `.message-bubble[data-timestamp="${timestamp}"], .sticker-container[data-timestamp="${timestamp}"]`
                );

                if (!elementToSelect) return;

                if (selectedMessages.has(timestamp)) {
                    selectedMessages.delete(timestamp);
                    elementToSelect.classList.remove('selected');
                } else {
                    selectedMessages.add(timestamp);
                    elementToSelect.classList.add('selected');
                }

                document.getElementById('selection-count').textContent = `Â∑≤ÈÄâ ${selectedMessages.size} Êù°`;

                if (selectedMessages.size === 0) {
                    exitSelectionMode();
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            function addLongPressListener(element, callback) {
                let pressTimer;
                let hasMoved = false;
                let startX = 0, startY = 0;

                const startPress = (e) => {
                    // Allow long press in arrange mode for stickers, but block in chat selection mode
                    if (isSelectionMode && !isArrangeMode) return;
                    hasMoved = false;

                    // Record starting position
                    if (e.type === 'touchstart') {
                        startX = e.touches[0].clientX;
                        startY = e.touches[0].clientY;
                    } else {
                        startX = e.clientX;
                        startY = e.clientY;
                    }

                    // Don't prevent default on touchstart - allow scrolling to work normally
                    // Only prevent default for mouse events to avoid text selection
                    if (e.type === 'mousedown' && element.classList.contains('comment-item')) {
                        e.preventDefault();
                    }

                    pressTimer = window.setTimeout(() => {
                        if (!hasMoved) {
                            callback(e);
                        }
                    }, 500);
                };

                const cancelPress = () => {
                    clearTimeout(pressTimer);
                    hasMoved = false;
                };

                const handleMove = (e) => {
                    // Only consider it movement if it's significant (more than 10px)
                    let currentX, currentY;
                    if (e.type === 'touchmove') {
                        currentX = e.touches[0].clientX;
                        currentY = e.touches[0].clientY;
                    } else {
                        currentX = e.clientX;
                        currentY = e.clientY;
                    }

                    const deltaX = Math.abs(currentX - startX);
                    const deltaY = Math.abs(currentY - startY);

                    if (deltaX > 10 || deltaY > 10) {
                        hasMoved = true;
                        clearTimeout(pressTimer);
                    }
                };

                element.addEventListener('mousedown', startPress);
                element.addEventListener('mouseup', cancelPress);
                element.addEventListener('mouseleave', cancelPress);
                element.addEventListener('mousemove', handleMove);
                element.addEventListener('touchstart', startPress, { passive: true });
                element.addEventListener('touchend', cancelPress);
                element.addEventListener('touchmove', handleMove, { passive: true });
            }

            async function handleListenTogetherClick() {
                const targetChatId = state.activeChatId;
                if (!targetChatId) return;

                if (!musicState.isActive) {
                    startListenTogetherSessionWithoutPlaying(targetChatId);
                } else if (musicState.activeChatId !== targetChatId) {
                    const oldChatName = state.chats[musicState.activeChatId]?.name || 'Êú™Áü•';
                    const newChatName = state.chats[targetChatId]?.name || 'ÂΩìÂâç';
                    const confirmed = await showCustomConfirm('ÂàáÊç¢Âê¨Ê≠åÂØπË±°', `ÊÇ®Ê≠£Âíå„Äå${oldChatName}„ÄçÂê¨Ê≠å„ÄÇË¶ÅÁªìÊùüÂπ∂ÂºÄÂßãÂíå„Äå${newChatName}„ÄçÁöÑÊñ∞‰ºöËØùÂêóÔºü`, { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        await endListenTogetherSession(true);
                        await new Promise(resolve => setTimeout(resolve, 50));
                        startListenTogetherSessionWithoutPlaying(targetChatId);
                    } else {
                        return;
                    }
                }

                // ALWAYS open main modal
                document.getElementById('music-player-overlay').classList.add('visible');
            }

            function startListenTogetherSessionWithoutPlaying(chatId) {
                const chat = state.chats[chatId];
                if (!chat) return;

                musicState.totalElapsedTime = chat.musicData.totalTime || 0;
                musicState.isActive = true;
                musicState.activeChatId = chatId;
                musicState.isPlaying = false; // Explicitly set to not playing

                if (musicState.playlist.length > 0 && musicState.currentIndex === -1) {
                    musicState.currentIndex = 0;
                }

                if (musicState.timerId) clearInterval(musicState.timerId);
                musicState.timerId = setInterval(() => {
                    if (musicState.isPlaying) {
                        musicState.totalElapsedTime++;
                        updateElapsedTimeDisplay();
                        updateNowPlayingProgress();
                    }
                }, 1000);

                updatePlayerUI();
                updatePlaylistUI();
                // DO NOT show now playing bar here - only when user presses play
            }

            async function endListenTogetherSession(saveState = true) { if (!musicState.isActive) return; const oldChatId = musicState.activeChatId; if (musicState.timerId) clearInterval(musicState.timerId); if (musicState.isPlaying) { const currentTrack = musicState.playlist[musicState.currentIndex]; if (currentTrack && currentTrack.isSpotify && spotifyPlayer) { spotifyPlayer.pause(); } else { audioPlayer.pause(); } } if (saveState && oldChatId && state.chats[oldChatId]) { const chat = state.chats[oldChatId]; chat.musicData.totalTime = musicState.totalElapsedTime; await db.chats.put(chat); } musicState.isActive = false; musicState.activeChatId = null; musicState.totalElapsedTime = 0; musicState.timerId = null; document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); updateListenTogetherIcon(oldChatId, true); hideNowPlayingBar(); }

            function returnToChat() { document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); }

            function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if (!iconImg) return; if (forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/vBN7GnQ9/3-FC8-D1596-C5-CFB200-FCB1-D8-C3-A37-A370.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
            window.updateListenTogetherIconProxy = updateListenTogetherIcon;

            function switchMainPlaylistTab(tab) { document.querySelectorAll('.main-playlist-tab').forEach(t => { t.classList.remove('active'); t.style.borderBottom = '2px solid transparent'; }); document.querySelectorAll('.main-playlist-tab-content').forEach(c => c.style.display = 'none'); if (tab === 'songs') { document.querySelector('.main-playlist-tab[onclick*="songs"]').classList.add('active'); document.querySelector('.main-playlist-tab[onclick*="songs"]').style.borderBottom = '2px solid var(--accent-color)'; document.getElementById('main-songs-tab').style.display = 'block'; } else if (tab === 'playlists') { document.querySelector('.main-playlist-tab[onclick*="playlists"]').classList.add('active'); document.querySelector('.main-playlist-tab[onclick*="playlists"]').style.borderBottom = '2px solid var(--accent-color)'; document.getElementById('main-playlists-tab').style.display = 'block'; showMainSpotifyPlaylists(); } }
            window.switchMainPlaylistTab = switchMainPlaylistTab;

            async function loadMainSpotifyPlaylists() { if (!spotifyAccessToken) { document.getElementById('main-playlists-list').innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">ËØ∑ÂÖàËøûÊé•Spotify</div>'; return; } try { const response = await fetch('https://api.spotify.com/v1/me/playlists?limit=20', { headers: { 'Authorization': `Bearer ${spotifyAccessToken}` } }); const data = await response.json(); window.mainSpotifyPlaylists = data.items; } catch (error) { console.error('Failed to load playlists:', error); } }

            function showMainSpotifyPlaylists() { const playlistsDiv = document.getElementById('main-playlists-list'); if (!playlistsDiv) return; if (!window.mainSpotifyPlaylists || window.mainSpotifyPlaylists.length === 0) { loadMainSpotifyPlaylists().then(() => { if (!window.mainSpotifyPlaylists || window.mainSpotifyPlaylists.length === 0) { playlistsDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Ê≤°ÊúâÊâæÂà∞Êí≠ÊîæÂàóË°®</div>'; } else { playlistsDiv.innerHTML = window.mainSpotifyPlaylists.map(playlist => `<div class="list-item" onclick="showMainPlaylistTracks('${playlist.id}', '${playlist.name.replace(/'/g, "\\'")}')"><div class="item-title">${playlist.name}</div><div class="item-content">${playlist.tracks.total} È¶ñÊ≠åÊõ≤</div></div>`).join(''); } }); return; } playlistsDiv.innerHTML = window.mainSpotifyPlaylists.map(playlist => `<div class="list-item" onclick="showMainPlaylistTracks('${playlist.id}', '${playlist.name.replace(/'/g, "\\'")}')"><div class="item-title">${playlist.name}</div><div class="item-content">${playlist.tracks.total} È¶ñÊ≠åÊõ≤</div></div>`).join(''); document.getElementById('main-playlists-list').style.display = 'block'; document.getElementById('main-playlist-view').style.display = 'none'; }
            window.showMainSpotifyPlaylists = showMainSpotifyPlaylists;
            window.playFromSpotifyPlaylist = playFromSpotifyPlaylist;

            function playFromMainPlaylist(index) { if (musicState.isPlayingFromPlaylist) { musicState.playlist = [...musicState.mainPlaylist]; musicState.isPlayingFromPlaylist = false; } musicState.currentIndex = index; playSong(index); updatePlayerUI(); updatePlaylistUI(); }

            function deleteFromMainPlaylist(index) { if (musicState.isPlayingFromPlaylist) { musicState.mainPlaylist.splice(index, 1); } else { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); } saveGlobalPlaylist(); updatePlaylistUI(); }

            window.playFromMainPlaylist = playFromMainPlaylist;
            window.deleteFromMainPlaylist = deleteFromMainPlaylist;

            async function showMainPlaylistTracks(playlistId, playlistName) { document.getElementById('main-current-playlist-name').textContent = playlistName; document.getElementById('main-playlists-list').style.display = 'none'; document.getElementById('main-playlist-view').style.display = 'block'; try { const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=50`, { headers: { 'Authorization': `Bearer ${spotifyAccessToken}` } }); const data = await response.json(); const validTracks = data.items.filter(item => item.track && item.track.type === 'track').map(item => ({ name: item.track.name, artist: item.track.artists.map(a => a.name).join(', '), album: item.track.album.name, uri: item.track.uri, albumArt: item.track.album.images[0]?.url })); musicState.currentSpotifyPlaylist = { id: playlistId, name: playlistName }; musicState.spotifyPlaylistTracks = validTracks; const tracksDiv = document.getElementById('main-playlist-tracks'); tracksDiv.innerHTML = validTracks.map((track, index) => `<div class="list-item" onclick="playFromSpotifyPlaylist(${index})"><div class="item-title">${track.name}</div><div class="item-content">${track.artist} ‚Ä¢ ${track.album}</div></div>`).join(''); } catch (error) { console.error('Failed to load playlist tracks:', error); } }
            window.showMainPlaylistTracks = showMainPlaylistTracks;

            function playFromSpotifyPlaylist(trackIndex) { if (!musicState.spotifyPlaylistTracks || trackIndex >= musicState.spotifyPlaylistTracks.length) return; if (!musicState.isPlayingFromPlaylist) { musicState.mainPlaylist = [...musicState.playlist]; } musicState.isPlayingFromPlaylist = true; musicState.playlist = musicState.spotifyPlaylistTracks.map(t => ({ name: t.name, artist: t.artist, src: null, isLocal: false, isSpotify: true, spotifyUri: t.uri, albumArt: t.albumArt })); musicState.currentIndex = trackIndex; playSong(trackIndex); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.remove('visible'); }

            async function addMainSpotifyTrackToPlaylist(uri, name, artist, albumArt) { musicState.playlist.push({ name: name, artist: artist, src: null, isLocal: false, isSpotify: true, spotifyUri: uri, albumArt: albumArt }); await saveGlobalPlaylist(); updatePlaylistUI(); if (musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } switchMainPlaylistTab('songs'); }
            window.addMainSpotifyTrackToPlaylist = addMainSpotifyTrackToPlaylist;

            function updatePlayerUI() {
                updateListenTogetherIcon(musicState.activeChatId);
                updateElapsedTimeDisplay();

                const titleEl = document.getElementById('music-player-song-title');
                const artistEl = document.getElementById('music-player-artist');
                const playPauseBtn = document.getElementById('music-play-pause-btn');

                if (musicState.currentIndex > -1 && musicState.playlist.length > 0) {
                    const track = musicState.playlist[musicState.currentIndex];
                    titleEl.textContent = track.name;
                    artistEl.textContent = track.artist;
                } else {
                    titleEl.textContent = 'ËØ∑Ê∑ªÂä†Ê≠åÊõ≤';
                    artistEl.textContent = '...';
                }

                playPauseBtn.textContent = musicState.isPlaying ? '‚ùö‚ùö' : '‚ñ∂';

                // Only update content, don't show/hide bar
                updateNowPlayingBarContent();
            }

            // Now Playing Bar Management
            function showNowPlayingBar() {
                const activeScreen = document.querySelector('.screen.active');
                const currentScreenId = activeScreen ? activeScreen.id : null;

                if (currentScreenId === 'home-screen') {
                    showHomeNowPlayingBar();
                } else if (currentScreenId === 'chat-interface-screen') {
                    showChatNowPlayingBar();
                }
            }

            function showChatNowPlayingBar() {
                const nowPlayingBar = document.getElementById('now-playing-bar');
                const chatScreen = document.getElementById('chat-interface-screen');

                if (musicState.isActive && musicState.currentIndex >= 0 && musicState.playlist.length > 0) {
                    const track = musicState.playlist[musicState.currentIndex];

                    // Update track info
                    document.getElementById('np-song-title').textContent = track.name || 'Êú™Áü•Ê≠åÊõ≤';
                    document.getElementById('np-song-artist').textContent = track.artist || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂';

                    // Update play/pause button
                    const npPlayBtn = document.getElementById('np-play-pause-btn');
                    npPlayBtn.textContent = musicState.isPlaying ? '‚ùö‚ùö' : '‚ñ∂';

                    // Update album art
                    const albumImg = document.getElementById('np-album-image');
                    const defaultIcon = albumImg.nextElementSibling;
                    if (track.albumArt) {
                        albumImg.src = track.albumArt;
                        albumImg.style.display = 'block';
                        defaultIcon.style.display = 'none';
                    } else {
                        albumImg.style.display = 'none';
                        defaultIcon.style.display = 'flex';
                    }

                    // Update listening partner avatar
                    const partnerAvatar = document.getElementById('np-partner-avatar');
                    if (musicState.activeChatId && state.chats[musicState.activeChatId]) {
                        const chat = state.chats[musicState.activeChatId];
                        const avatarUrl = chat.settings.aiAvatar || 'https://files.catbox.moe/q6z5fc.jpeg';
                        partnerAvatar.src = avatarUrl;
                        partnerAvatar.alt = `‰∏é ${chat.name} ‰∏ÄËµ∑Âê¨`;
                    }

                    // Always show the bar and ensure proper layout
                    nowPlayingBar.classList.remove('hidden');
                    if (chatScreen && chatScreen.classList.contains('active')) {
                        chatScreen.classList.add('has-now-playing');
                    }
                }
            }

            function updateNowPlayingBarContent() {
                // Update chat screen bar content
                const nowPlayingBar = document.getElementById('now-playing-bar');
                if (!nowPlayingBar.classList.contains('hidden') && musicState.isActive && musicState.currentIndex >= 0) {
                    const track = musicState.playlist[musicState.currentIndex];

                    document.getElementById('np-song-title').textContent = track.name || 'Êú™Áü•Ê≠åÊõ≤';
                    document.getElementById('np-song-artist').textContent = track.artist || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂';

                    const npPlayBtn = document.getElementById('np-play-pause-btn');
                    npPlayBtn.textContent = musicState.isPlaying ? '‚ùö‚ùö' : '‚ñ∂';

                    // Update album art rotation for chat screen
                    const albumImg = document.getElementById('np-album-image');
                    if (albumImg) {
                        if (musicState.isPlaying) {
                            albumImg.classList.add('rotating');
                        } else {
                            albumImg.classList.remove('rotating');
                        }
                    }
                }

                // Update home screen bar content
                const homeBar = document.getElementById('home-now-playing-bar');
                if (!homeBar.classList.contains('hidden') && musicState.isActive && musicState.currentIndex >= 0) {
                    const track = musicState.playlist[musicState.currentIndex];

                    document.getElementById('home-np-song-title').textContent = track.name || 'Êú™Áü•Ê≠åÊõ≤';
                    document.getElementById('home-np-song-artist').textContent = track.artist || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂';

                    const homePlayBtn = document.getElementById('home-np-play-pause-btn');
                    homePlayBtn.textContent = musicState.isPlaying ? '‚ùö‚ùö' : '‚ñ∂';

                    // Update album art rotation for home screen
                    const homeAlbumImg = document.getElementById('home-np-album-image');
                    if (homeAlbumImg) {
                        if (musicState.isPlaying) {
                            homeAlbumImg.classList.add('rotating');
                        } else {
                            homeAlbumImg.classList.remove('rotating');
                        }
                    }
                }
            }

            function updateNowPlayingProgress() {
                if (!musicState.isActive || musicState.currentIndex < 0) {
                    // Hide progress bars when no music is active
                    const chatProgressFill = document.getElementById('np-progress-fill');
                    const homeProgressFill = document.getElementById('home-np-progress-fill');
                    if (chatProgressFill) chatProgressFill.style.width = '0%';
                    if (homeProgressFill) homeProgressFill.style.width = '0%';
                    return;
                }

                const currentTrack = musicState.playlist[musicState.currentIndex];
                let currentTime = 0;
                let duration = 0;

                if (currentTrack && currentTrack.isSpotify && spotifyPlayer) {
                    // Get Spotify progress
                    spotifyPlayer.getCurrentState().then(state => {
                        if (state && state.track_window.current_track) {
                            currentTime = state.position / 1000; // Convert ms to seconds
                            duration = state.duration / 1000;
                            updateProgressBars(currentTime, duration);
                        }
                    }).catch(() => {
                        // Spotify state unavailable, hide progress
                        const chatProgressFill = document.getElementById('np-progress-fill');
                        const homeProgressFill = document.getElementById('home-np-progress-fill');
                        if (chatProgressFill) chatProgressFill.style.width = '0%';
                        if (homeProgressFill) homeProgressFill.style.width = '0%';
                    });
                } else if (audioPlayer.duration) {
                    // Get regular audio progress
                    currentTime = audioPlayer.currentTime;
                    duration = audioPlayer.duration;
                    updateProgressBars(currentTime, duration);
                }
            }

            function updateProgressBars(currentTime, duration) {
                if (duration <= 0) return;

                const progressPercent = Math.min(100, (currentTime / duration) * 100);

                // Update chat screen progress bar
                const chatProgressFill = document.getElementById('np-progress-fill');
                if (chatProgressFill) {
                    chatProgressFill.style.width = `${progressPercent}%`;
                }

                // Update home screen progress bar
                const homeProgressFill = document.getElementById('home-np-progress-fill');
                if (homeProgressFill) {
                    homeProgressFill.style.width = `${progressPercent}%`;
                }
            }

            function hideNowPlayingBar() {
                hideHomeNowPlayingBar();
                hideChatNowPlayingBar();
            }

            function hideChatNowPlayingBar() {
                const nowPlayingBar = document.getElementById('now-playing-bar');
                const chatScreen = document.getElementById('chat-interface-screen');

                if (!nowPlayingBar.classList.contains('hidden')) {
                    nowPlayingBar.classList.add('hidden');
                    if (chatScreen) {
                        chatScreen.classList.remove('has-now-playing');
                    }
                }
            }

            // Home Screen Now Playing Bar Functions
            function showHomeNowPlayingBar() {
                const homeBar = document.getElementById('home-now-playing-bar');

                if (musicState.isActive && musicState.currentIndex >= 0 && musicState.playlist.length > 0) {
                    const track = musicState.playlist[musicState.currentIndex];

                    // Update track info
                    document.getElementById('home-np-song-title').textContent = track.name || 'Êú™Áü•Ê≠åÊõ≤';
                    document.getElementById('home-np-song-artist').textContent = track.artist || 'Êú™Áü•Ëâ∫ÊúØÂÆ∂';

                    // Update play/pause button
                    const npPlayBtn = document.getElementById('home-np-play-pause-btn');
                    npPlayBtn.textContent = musicState.isPlaying ? '‚ùö‚ùö' : '‚ñ∂';

                    // Update album art
                    const albumImg = document.getElementById('home-np-album-image');
                    const defaultIcon = albumImg.nextElementSibling;
                    if (track.albumArt) {
                        albumImg.src = track.albumArt;
                        albumImg.style.display = 'block';
                        defaultIcon.style.display = 'none';
                    } else {
                        albumImg.style.display = 'none';
                        defaultIcon.style.display = 'flex';
                    }

                    // Update album art rotation
                    if (albumImg) {
                        if (musicState.isPlaying) {
                            albumImg.classList.add('rotating');
                        } else {
                            albumImg.classList.remove('rotating');
                        }
                    }

                    // Update listening partner avatar
                    const partnerAvatar = document.getElementById('home-np-partner-avatar');
                    if (musicState.activeChatId && state.chats[musicState.activeChatId]) {
                        const chat = state.chats[musicState.activeChatId];
                        const avatarUrl = chat.settings.aiAvatar || 'https://files.catbox.moe/q6z5fc.jpeg';
                        partnerAvatar.src = avatarUrl;
                        partnerAvatar.alt = `‰∏é ${chat.name} ‰∏ÄËµ∑Âê¨`;
                    }

                    // Always show the bar and ensure proper layout
                    homeBar.classList.remove('hidden');
                }
            }

            function hideHomeNowPlayingBar() {
                const homeBar = document.getElementById('home-now-playing-bar');
                homeBar.classList.add('hidden');
            }

            function initializeNowPlayingBar() {
                // Tap to expand functionality
                document.getElementById('now-playing-bar').addEventListener('click', (e) => {
                    if (!e.target.closest('.np-playback-controls')) {
                        document.getElementById('music-player-overlay').classList.add('visible');
                    }
                });

                // Control button event listeners
                document.getElementById('np-play-pause-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    togglePlayPause();
                });

                document.getElementById('np-prev-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    playPrev();
                });

                document.getElementById('np-next-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    playNext();
                });
            }

            function initializeHomeNowPlayingBar() {
                const homeBar = document.getElementById('home-now-playing-bar');
                if (!homeBar) {
                    console.error('Home now playing bar element not found');
                    return;
                }

                // Tap to navigate to listening partner's chat with modal open
                homeBar.addEventListener('click', (e) => {
                    // Don't navigate if clicking on control buttons
                    if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                        return;
                    }

                    // Navigate to the listening partner's chat
                    if (musicState.activeChatId) {
                        // Open the chat
                        openChat(musicState.activeChatId);
                        // Open the music modal
                        document.getElementById('music-player-overlay').classList.add('visible');
                    }
                });

                // Control button event listeners
                const playBtn = document.getElementById('home-np-play-pause-btn');
                const prevBtn = document.getElementById('home-np-prev-btn');
                const nextBtn = document.getElementById('home-np-next-btn');

                if (playBtn) {
                    playBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        togglePlayPause();
                    });
                }

                if (prevBtn) {
                    prevBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        playPrev();
                    });
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        playNext();
                    });
                }
            }

            function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü${hours}Â∞èÊó∂`; }

            function updatePlaylistUI() { const playlistBody = document.getElementById('playlist-body'); playlistBody.innerHTML = ''; const displayPlaylist = musicState.isPlayingFromPlaylist ? musicState.mainPlaylist : musicState.playlist; if (displayPlaylist.length === 0) { playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">Êí≠ÊîæÂàóË°®ÊòØÁ©∫ÁöÑ~</p>'; return; } displayPlaylist.forEach((track, index) => { const item = document.createElement('div'); item.className = 'playlist-item'; if (!musicState.isPlayingFromPlaylist && index === musicState.currentIndex) item.classList.add('playing'); item.innerHTML = `<div class="playlist-item-info"><div class="title">${track.name}</div><div class="artist">${track.artist}</div></div><span class="delete-track-btn" data-index="${index}">&times;</span>`; item.querySelector('.playlist-item-info').addEventListener('click', () => playFromMainPlaylist(index)); item.querySelector('.delete-track-btn').addEventListener('click', async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('Âà†Èô§Ê≠åÊõ≤', `Á°ÆÂÆöË¶Å‰ªéÊí≠ÊîæÂàóË°®‰∏≠Âà†Èô§„Ää${track.name}„ÄãÂêóÔºü`); if (confirmed) deleteFromMainPlaylist(index); }); playlistBody.appendChild(item); }); }

            function playSong(index) {
                if (index < 0 || index >= musicState.playlist.length) return;
                musicState.currentIndex = index;
                const track = musicState.playlist[index];

                if (track.isSpotify && spotifyPlayer && spotifyDeviceId) {
                    fetch(`https://api.spotify.com/v1/me/player/play?device_id=${spotifyDeviceId}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${spotifyAccessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ uris: [track.spotifyUri] })
                    });
                    musicState.isPlaying = true;
                } else if (track.isLocal && track.src instanceof Blob) {
                    audioPlayer.src = URL.createObjectURL(track.src);
                    musicState.isPlaying = true;
                    audioPlayer.play().catch(error => {
                        console.error('Error playing audio:', error);
                        musicState.isPlaying = false;
                        updatePlayerUI();
                    });
                } else if (!track.isLocal && !track.isSpotify) {
                    audioPlayer.src = track.src;
                    musicState.isPlaying = true;
                    audioPlayer.play().catch(error => {
                        console.error('Error playing audio:', error);
                        musicState.isPlaying = false;
                        updatePlayerUI();
                    });
                } else {
                    return;
                }

                updatePlaylistUI();
                updatePlayerUI();
            }

            function togglePlayPause() {
                const currentTrack = musicState.playlist[musicState.currentIndex];

                if (!musicState.isPlaying) {
                    // If not playing, check if we should resume or start new song
                    if (musicState.playlist.length === 0) return;

                    const indexToPlay = (musicState.currentIndex >= 0 && musicState.currentIndex < musicState.playlist.length) ? musicState.currentIndex : 0;

                    // Check if we should resume or start new song

                    if (currentTrack && currentTrack.isSpotify && spotifyPlayer) {
                        // For Spotify tracks, check if we should resume or start new
                        spotifyPlayer.getCurrentState().then(state => {
                            if (state && state.track_window.current_track && state.paused) {
                                // Spotify is paused, resume it
                                spotifyPlayer.resume().then(() => {
                                    musicState.isPlaying = true;
                                    updatePlayerUI();
                                });
                            } else {
                                // No current Spotify track or different track, start new
                                playSongAndShowBar(indexToPlay);
                            }
                        }).catch(error => {
                            playSongAndShowBar(indexToPlay);
                        });
                        showNowPlayingBar();
                    } else if (currentTrack && !currentTrack.isSpotify && audioPlayer.src && !audioPlayer.ended && audioPlayer.paused) {
                        // For regular audio tracks, resume from pause
                        musicState.isPlaying = true;
                        audioPlayer.play().catch(error => {
                            console.error('Error resuming audio:', error);
                            musicState.isPlaying = false;
                            updatePlayerUI();
                        });
                        showNowPlayingBar();
                    } else {
                        // Start new song - load audio source
                        playSongAndShowBar(indexToPlay);
                    }
                } else {
                    // If playing, pause it
                    if (currentTrack && currentTrack.isSpotify && spotifyPlayer) {
                        spotifyPlayer.pause();
                    } else {
                        audioPlayer.pause();
                    }
                    // DO NOT hide bar when pausing
                }
            }

            function cycleSongOnly(index) {
                if (index < 0 || index >= musicState.playlist.length) return;
                musicState.currentIndex = index;
                // DO NOT play music, just update UI
                updatePlaylistUI();
                updatePlayerUI();
            }

            function playSongAndShowBar(index) {
                if (index < 0 || index >= musicState.playlist.length) return;
                musicState.currentIndex = index;
                const track = musicState.playlist[index];

                if (track.isSpotify && spotifyPlayer && spotifyDeviceId) {


                    fetch(`https://api.spotify.com/v1/me/player/play?device_id=${spotifyDeviceId}`, {
                        method: 'PUT',
                        headers: { 'Authorization': `Bearer ${spotifyAccessToken}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ uris: [track.spotifyUri] })
                    }).then(response => {
                        if (response.ok) {
                            musicState.isPlaying = true;
                            updatePlayerUI();
                        } else {
                            console.error('Spotify API error:', response.status, response.statusText);
                            alert(`SpotifyÊí≠ÊîæÂ§±Ë¥•: ${response.status} ${response.statusText}\nËØ∑Ê£ÄÊü•SpotifyËøûÊé•Áä∂ÊÄÅ`);
                            musicState.isPlaying = false;
                            updatePlayerUI();
                        }
                    }).catch(error => {
                        console.error('Spotify fetch error:', error);
                        alert('SpotifyËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•');
                        musicState.isPlaying = false;
                        updatePlayerUI();
                    });
                } else if (track.isLocal && track.src instanceof Blob) {
                    audioPlayer.src = URL.createObjectURL(track.src);
                    // Set playing state before calling play() to ensure UI updates correctly
                    musicState.isPlaying = true;
                    audioPlayer.play().catch(error => {
                        console.error('Error playing audio:', error);
                        musicState.isPlaying = false;
                        updatePlayerUI();
                    });
                } else if (!track.isLocal && !track.isSpotify) {
                    audioPlayer.src = track.src;
                    // Set playing state before calling play() to ensure UI updates correctly
                    musicState.isPlaying = true;
                    audioPlayer.play().catch(error => {
                        console.error('Error playing audio:', error);
                        musicState.isPlaying = false;
                        updatePlayerUI();
                    });
                } else if (track.isSpotify && (!spotifyPlayer || !spotifyDeviceId || !spotifyAccessToken)) {
                    alert('SpotifyÊú™Ê≠£Á°ÆËøûÊé•„ÄÇËØ∑ÈáçÊñ∞ËøûÊé•Spotify„ÄÇ');
                    return;
                } else {
                    return;
                }

                // Show now playing bar when music starts
                showNowPlayingBar();
                updatePlaylistUI();
                updatePlayerUI();
            }

            function playNext() {
                if (musicState.playlist.length === 0) return;
                let nextIndex;
                switch (musicState.playMode) {
                    case 'random':
                        nextIndex = Math.floor(Math.random() * musicState.playlist.length);
                        break;
                    case 'single':
                        playSongAndShowBar(musicState.currentIndex);
                        return;
                    case 'order':
                    default:
                        nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length;
                        break;
                }
                // Always play the next song automatically
                playSongAndShowBar(nextIndex);
            }

            function playPrev() {
                if (musicState.playlist.length === 0) return;
                const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length;
                // Always play the previous song automatically
                playSongAndShowBar(newIndex);
            }

            function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = { 'order': 'È°∫Â∫è', 'random': 'ÈöèÊú∫', 'single': 'ÂçïÊõ≤' }[musicState.playMode]; }

            async function addSongFromURL() { const url = await showCustomPrompt("Ê∑ªÂä†ÁΩëÁªúÊ≠åÊõ≤", "ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÁöÑURL", "", "url"); if (!url) return; const name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç"); if (!name) return; const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if (musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }

            async function addSongFromLocal(event) { const files = event.target.files; if (!files.length) return; for (const file of files) { const name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç", ""); if (name === null) continue; const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç", ""); if (artist === null) continue; musicState.playlist.push({ name, artist, src: file, isLocal: true }); } await saveGlobalPlaylist(); updatePlaylistUI(); if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { musicState.currentIndex = 0; updatePlayerUI(); } event.target.value = null; }

            async function addSongFromSpotify() { if (!spotifyAccessToken) { if (confirm('ÈúÄË¶ÅËøûÊé•Âà∞SpotifyÊâçËÉΩÊ∑ªÂä†Ê≠åÊõ≤„ÄÇËØ∑Á°Æ‰øùÊÇ®ÊúâSpotify PremiumË¥¶Êà∑ÔºåÂπ∂Âú®ÊéàÊùÉÊó∂ÁÇπÂáª"ÂêåÊÑè"„ÄÇÊòØÂê¶Áé∞Âú®ËøûÊé•Ôºü')) { await initSpotifyAuth(); } return; } const query = await showCustomPrompt("ÊêúÁ¥¢SpotifyÊ≠åÊõ≤", "ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÂêçÊàñËâ∫ÊúØÂÆ∂"); if (!query) return; try { const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=10`, { headers: { 'Authorization': `Bearer ${spotifyAccessToken}` } }); const data = await response.json(); if (data.tracks.items.length === 0) { alert('Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥Ê≠åÊõ≤'); return; } showSpotifyTrackSelection(data.tracks.items); } catch (error) { console.error('Spotify search failed:', error); alert('ÊêúÁ¥¢Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•'); } }

            function showSpotifyTrackSelection(tracks) { const modal = document.createElement('div'); modal.className = 'modal visible'; modal.innerHTML = `<div class="modal-content"><div class="modal-header" style="justify-content: flex-start;"><span onclick="this.closest('.modal').remove()" style="cursor: pointer; margin-right: 4px;">&times;</span><span>ÈÄâÊã©Ê≠åÊõ≤</span></div><div class="modal-body" style="max-height: 400px; overflow-y: auto;">${tracks.map((track, index) => `<div class="list-item" onclick="selectSpotifyTrack(${index})" style="cursor: pointer; border-bottom: 1px solid var(--border-color);"><div class="item-title">${track.name}</div><div class="item-content">${track.artists.map(a => a.name).join(', ')} ‚Ä¢ ${track.album.name}</div></div>`).join('')}</div></div>`; document.body.appendChild(modal); window.spotifySearchResults = tracks; }

            function selectSpotifyTrack(index) { const track = window.spotifySearchResults[index]; if (!track) return; const listItems = document.querySelectorAll('.modal .list-item'); const clickedItem = listItems[index]; clickedItem.innerHTML = `<div class="item-title">${track.name}</div><div class="item-content">${track.artists.map(a => a.name).join(', ')} ‚Ä¢ ${track.album.name}</div><div style="margin-left: auto; font-size: 20px;">‚è≥</div>`; const newTrack = { name: track.name, artist: track.artists.map(a => a.name).join(', '), src: null, isLocal: false, isSpotify: true, spotifyUri: track.uri, albumArt: track.album.images[0]?.url }; if (musicState.isPlayingFromPlaylist) { musicState.mainPlaylist.push(newTrack); } else { musicState.playlist.push(newTrack); if (musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } } saveGlobalPlaylist(); updatePlaylistUI(); clickedItem.innerHTML = `<div class="item-title">${track.name}</div><div class="item-content">${track.artists.map(a => a.name).join(', ')} ‚Ä¢ ${track.album.name}</div><div style="margin-left: auto; font-size: 20px; color: green;">‚úì</div>`; }
            window.selectSpotifyTrack = selectSpotifyTrack;



            function generateCodeVerifier() { const array = new Uint8Array(32); crypto.getRandomValues(array); return btoa(String.fromCharCode.apply(null, array)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, ''); }

            function generateCodeChallenge(verifier) { const encoder = new TextEncoder(); const data = encoder.encode(verifier); return crypto.subtle.digest('SHA-256', data).then(digest => { return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, ''); }); }

            async function initSpotifyAuth() { const clientId = '4a89adc960014897bfcc45c55c1c0aff'; const redirectUri = 'lycheephone://spotify-callback'; const scopes = 'streaming user-read-email user-read-private user-read-playback-state user-modify-playback-state'; const codeVerifier = generateCodeVerifier(); const codeChallenge = await generateCodeChallenge(codeVerifier); window.spotifyCodeVerifier = codeVerifier; const authUrl = `https://accounts.spotify.com/authorize?client_id=${clientId}&response_type=code&redirect_uri=${encodeURIComponent(redirectUri)}&scope=${encodeURIComponent(scopes)}&code_challenge_method=S256&code_challenge=${codeChallenge}`; window.location.href = authUrl; }

            function getSpotifyTokenFromUrl() { const hash = window.location.hash.substring(1); const params = new URLSearchParams(hash); const token = params.get('access_token'); if (token) { spotifyAccessToken = token; window.history.replaceState({}, document.title, window.location.pathname); return true; } return false; }

            async function loadSavedSpotifyToken() { try { const spotifySettings = await db.globalSettings.get('spotify'); if (spotifySettings && spotifySettings.accessToken) { if (spotifySettings.expiresAt > Date.now()) { spotifyAccessToken = spotifySettings.accessToken; initSpotifyPlayer(); } else { await db.globalSettings.delete('spotify'); } } } catch (error) { } }

            function handleSpotifyCallback(url) { if (url.startsWith('lycheephone://spotify-callback')) { const urlParts = url.split('?'); if (urlParts.length > 1) { const params = new URLSearchParams(urlParts[1]); const code = params.get('code'); const error = params.get('error'); if (error) { if (error === 'access_denied') { alert('SpotifyÊéàÊùÉË¢´ÊãíÁªù„ÄÇËØ∑ÈáçËØïÂπ∂ÁÇπÂáª"ÂêåÊÑè"ÊåâÈíÆ„ÄÇ'); } else { alert('Spotify error: ' + error); } return; } if (code) { exchangeCodeForToken(code); } } } }

            async function exchangeCodeForToken(code) { const clientId = '4a89adc960014897bfcc45c55c1c0aff'; const redirectUri = 'lycheephone://spotify-callback'; const codeVerifier = window.spotifyCodeVerifier; if (!codeVerifier) { return; } try { const response = await fetch('https://accounts.spotify.com/api/token', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: new URLSearchParams({ grant_type: 'authorization_code', code: code, redirect_uri: redirectUri, client_id: clientId, code_verifier: codeVerifier }) }); const data = await response.json(); if (data.access_token) { spotifyAccessToken = data.access_token; await db.globalSettings.put({ id: 'spotify', accessToken: data.access_token, refreshToken: data.refresh_token, expiresAt: Date.now() + (data.expires_in * 1000) }); initSpotifyPlayer(); } } catch (error) { console.error('Token exchange error:', error); } }

            async function initSpotifyPlayer() { if (!spotifyAccessToken) return false; if (!window.Spotify) { window.onSpotifyWebPlaybackSDKReady = () => { }; await new Promise(resolve => { if (window.Spotify) { resolve(); } else { window.onSpotifyWebPlaybackSDKReady = resolve; } }); } spotifyPlayer = new Spotify.Player({ name: 'LycheePhone Music Player', getOAuthToken: cb => cb(spotifyAccessToken), volume: 0.5 }); spotifyPlayer.addListener('ready', ({ device_id }) => { spotifyDeviceId = device_id; migrateSpotifyAlbumArt(); }); spotifyPlayer.addListener('not_ready', ({ device_id }) => { }); spotifyPlayer.addListener('player_state_changed', (state) => { if (state && musicState.isActive) { const track = musicState.playlist[musicState.currentIndex]; if (track && track.isSpotify) { musicState.isPlaying = !state.paused; updatePlayerUI(); updateNowPlayingProgress(); } } }); const success = await spotifyPlayer.connect(); return success; }

            async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

            const personaLibraryModal = document.getElementById('persona-library-modal');
            const personaEditorModal = document.getElementById('persona-editor-modal');
            const presetActionsModal = document.getElementById('preset-actions-modal');

            function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }

            function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }

            function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">Á©∫Á©∫Â¶Ç‰πü~ ÁÇπÂáªÂè≥‰∏äËßí"Ê∑ªÂä†"Êù•ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêßÔºÅ</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }

            function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }

            function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }

            function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }

            function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }

            function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'ÁºñËæë‰∫∫ËÆæÈ¢ÑËÆæ'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }

            async function deletePersonaPreset() { const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }

            function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }

            function removeQzoneBorder() {
                document.getElementById('qzone-border-preview').style.display = 'none';
                document.getElementById('qzone-border-preview').src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                document.getElementById('qzone-no-border-text').style.display = 'block';
                document.getElementById('qzone-remove-border-btn').style.display = 'none';
            }

            // Make function globally accessible
            window.removeQzoneBorder = removeQzoneBorder;

            async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("Â§¥ÂÉèÂíå‰∫∫ËÆæ‰∏çËÉΩÈÉΩ‰∏∫Á©∫Âì¶ÔºÅ"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

            // Memory action functions (copying persona pattern)
            function showMemoryActions(memoryId) {
                editingMemoryId = parseInt(memoryId);
                // Update modal button text for memory actions
                document.getElementById('preset-action-edit').textContent = 'ÁºñËæëËÆ∞ÂΩï';
                document.getElementById('preset-action-delete').textContent = 'Âà†Èô§ËÆ∞ÂΩï';
                presetActionsModal.classList.add('visible');
            }

            function hideMemoryActions() {
                presetActionsModal.classList.remove('visible');
                editingMemoryId = null;
                // Reset button text back to preset actions
                document.getElementById('preset-action-edit').textContent = 'ÁºñËæëÈ¢ÑËÆæ';
                document.getElementById('preset-action-delete').textContent = 'Âà†Èô§È¢ÑËÆæ';
            }

            async function editMemory() {
                if (!editingMemoryId) return;
                const memory = await db.memories.get(editingMemoryId);
                if (!memory) return;

                // Hide actions modal
                presetActionsModal.classList.remove('visible');

                // Determine which modal to use and prefill data
                if (memory.type === 'countdown') {
                    // Use countdown modal for editing
                    document.querySelector('#create-countdown-modal .modal-header span').textContent = 'ÁºñËæëÁ∫¶ÂÆö';
                    document.getElementById('countdown-title-input').value = memory.description;

                    // Format date for datetime-local input
                    const targetDate = new Date(memory.targetDate);
                    const formattedDate = targetDate.getFullYear() + '-' +
                        String(targetDate.getMonth() + 1).padStart(2, '0') + '-' +
                        String(targetDate.getDate()).padStart(2, '0') + 'T' +
                        String(targetDate.getHours()).padStart(2, '0') + ':' +
                        String(targetDate.getMinutes()).padStart(2, '0');
                    document.getElementById('countdown-date-input').value = formattedDate;

                    document.getElementById('create-countdown-modal').classList.add('visible');
                } else {
                    // Use memory modal for editing
                    document.querySelector('#create-memory-modal .modal-header span').textContent = 'ÁºñËæëÂõûÂøÜ';
                    document.getElementById('memory-description-input').value = memory.description;

                    // Format date for datetime-local input
                    const memoryDate = new Date(memory.timestamp);
                    const formattedDate = memoryDate.getFullYear() + '-' +
                        String(memoryDate.getMonth() + 1).padStart(2, '0') + '-' +
                        String(memoryDate.getDate()).padStart(2, '0') + 'T' +
                        String(memoryDate.getHours()).padStart(2, '0') + ':' +
                        String(memoryDate.getMinutes()).padStart(2, '0');
                    document.getElementById('memory-date-input').value = formattedDate;

                    document.getElementById('create-memory-modal').classList.add('visible');
                }
            }

            async function deleteMemory() {
                if (!editingMemoryId) return;
                const memory = await db.memories.get(editingMemoryId);
                if (!memory) return;

                const deleteTitle = memory.type === 'countdown' ? 'Âà†Èô§Á∫¶ÂÆö' : 'Âà†Èô§ËÆ∞ÂΩï';
                const deleteMessage = memory.type === 'countdown' ? 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Á∫¶ÂÆöÂêóÔºü' : 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü';

                const confirmed = await showCustomConfirm(deleteTitle, deleteMessage, { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    // If this is a date mode event, delete associated messages first
                    if (memory.type === 'meetup') {
                        try {
                            const deletedCount = await deleteMeetupMessages(editingMemoryId);
                            console.log('DEBUG - Deleted meetup messages:', deletedCount);
                        } catch (error) {
                            console.error('DEBUG - Failed to delete meetup messages:', error);
                            // Continue with event deletion even if message deletion fails
                        }
                    }

                    await db.memories.delete(editingMemoryId);
                    hideMemoryActions();
                    renderCalendarScreen();
                    renderMemoriesScreen();
                }
            }

            const batteryAlertModal = document.getElementById('battery-alert-modal');

            function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }

            function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }

            function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'ÊúâÁÇπÈ•ø‰∫ÜÔºåÂèØ‰ª•ÂéªÊâæÂÖÖÁîµÂô®ÊÉπ'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'Ëµ∂Á¥ßÁöÑÂÖÖÁîµÔºåË¶ÅÈ•øÊ≠ª‰∫Ü'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'Â∑≤Èòµ‰∫°ÔºåËøòÊúâ30ÁßíÁàÜÁÇ∏'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }

            async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'Á™ùÁà±Ê≥•ÔºåÁîµÈáèÂêÉÈ•±È•±'); } }); } catch (err) { console.error("Êó†Ê≥ïËé∑ÂèñÁîµÊ±†‰ø°ÊÅØ:", err); document.querySelector('.battery-text').textContent = '·óúœâ·óú'; } } else { console.log("ÊµèËßàÂô®‰∏çÊîØÊåÅÁîµÊ±†Áä∂ÊÄÅAPI„ÄÇ"); document.querySelector('.battery-text').textContent = '·óúœâ·óú'; } }

            async function renderAlbumList() {
                const albumGrid = document.getElementById('album-grid-page');
                if (!albumGrid) return;
                const albums = await db.qzoneAlbums.orderBy('createdAt').reverse().toArray();
                albumGrid.innerHTML = '';
                if (albums.length === 0) {
                    albumGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">‰Ω†ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰ΩïÁõ∏ÂÜåÂì¶~</p>';
                    return;
                }
                albums.forEach(album => {
                    const albumItem = document.createElement('div');
                    albumItem.className = 'album-item';
                    albumItem.innerHTML = `
                    <div class="album-cover" style="background-image: url(${album.coverUrl});"></div>
                    <div class="album-info">
                        <p class="album-name">${album.name}</p>
                        <p class="album-count">${album.photoCount || 0} Âº†</p>
                    </div>
                `;
                    albumItem.addEventListener('click', () => {
                        openAlbum(album.id);
                    });

                    // ‚ñº‚ñº‚ñº Êñ∞Â¢ûÁöÑÊ†∏ÂøÉ‰ª£Á†ÅÂ∞±ÊòØËøôÈáå ‚ñº‚ñº‚ñº
                    addLongPressListener(albumItem, async () => {
                        const confirmed = await showCustomConfirm(
                            'Âà†Èô§Áõ∏ÂÜå',
                            `Á°ÆÂÆöË¶ÅÂà†Èô§Áõ∏ÂÜå„Ää${album.name}„ÄãÂêóÔºüÊ≠§Êìç‰ΩúÂ∞ÜÂêåÊó∂Âà†Èô§Áõ∏ÂÜåÂÜÖÁöÑÊâÄÊúâÁÖßÁâáÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ`,
                            { confirmButtonClass: 'btn-danger' }
                        );

                        if (confirmed) {
                            // 1. ‰ªéÁÖßÁâáË°®‰∏≠Âà†Èô§ËØ•Áõ∏ÂÜå‰∏ãÁöÑÊâÄÊúâÁÖßÁâá
                            await db.qzonePhotos.where('albumId').equals(album.id).delete();

                            // 2. ‰ªéÁõ∏ÂÜåË°®‰∏≠Âà†Èô§ËØ•Áõ∏ÂÜåÊú¨Ë∫´
                            await db.qzoneAlbums.delete(album.id);

                            // 3. ÈáçÊñ∞Ê∏≤ÊüìÁõ∏ÂÜåÂàóË°®
                            await renderAlbumList();

                            alert('Áõ∏ÂÜåÂ∑≤ÊàêÂäüÂà†Èô§„ÄÇ');
                        }
                    });
                    // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                    albumGrid.appendChild(albumItem);
                });
            }

            async function openAlbum(albumId) {
                state.activeAlbumId = albumId;
                await renderAlbumPhotosScreen();
                showScreen('album-photos-screen');
            }

            async function renderAlbumPhotosScreen() {
                if (!state.activeAlbumId) return;
                const photosGrid = document.getElementById('photos-grid-page');
                const headerTitle = document.getElementById('album-photos-title');
                const album = await db.qzoneAlbums.get(state.activeAlbumId);
                if (!album) {
                    console.error("Êâæ‰∏çÂà∞Áõ∏ÂÜå:", state.activeAlbumId);
                    showScreen('album-screen');
                    return;
                }
                headerTitle.textContent = album.name;
                const photos = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
                photosGrid.innerHTML = '';
                if (photos.length === 0) {
                    photosGrid.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: var(--text-secondary); margin-top: 50px;">Ëøô‰∏™Áõ∏ÂÜåËøòÊòØÁ©∫ÁöÑÔºåÂø´‰∏ä‰º†Á¨¨‰∏ÄÂº†ÁÖßÁâáÂêßÔºÅ</p>';
                } else {
                    photos.forEach(photo => {
                        const photoItem = document.createElement('div');
                        photoItem.className = 'photo-item';
                        photoItem.innerHTML = `
                        <img src="${photo.url}" class="photo-thumb" alt="Áõ∏ÂÜåÁÖßÁâá">
                        <button class="photo-delete-btn" data-photo-id="${photo.id}">√ó</button>
                    `;
                        photosGrid.appendChild(photoItem);
                    });
                }
            }

            // --- ‚Üì‚Üì‚Üì ‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ ‚Üì‚Üì‚Üì ---

            /**
             * ÊâìÂºÄÂõæÁâáÊü•ÁúãÂô®
             * @param {string} clickedPhotoUrl - Áî®Êà∑ÁÇπÂáªÁöÑÈÇ£Âº†ÁÖßÁâáÁöÑURL
             */
            async function openPhotoViewer(clickedPhotoUrl) {
                if (!state.activeAlbumId) return;

                // 1. ‰ªéÊï∞ÊçÆÂ∫ìËé∑ÂèñÂΩìÂâçÁõ∏ÂÜåÁöÑÊâÄÊúâÁÖßÁâá
                const photosInAlbum = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).toArray();
                photoViewerState.photos = photosInAlbum.map(p => p.url);

                // 2. ÊâæÂà∞Ë¢´ÁÇπÂáªÁÖßÁâáÁöÑÁ¥¢Âºï
                photoViewerState.currentIndex = photoViewerState.photos.findIndex(url => url === clickedPhotoUrl);
                if (photoViewerState.currentIndex === -1) return; // Â¶ÇÊûúÊâæ‰∏çÂà∞ÔºåÂàô‰∏çÊâìÂºÄ

                // 3. ÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÂπ∂Ê∏≤ÊüìÁ¨¨‰∏ÄÂº†Âõæ
                document.getElementById('photo-viewer-modal').classList.add('visible');
                renderPhotoViewer();
                photoViewerState.isOpen = true;
            }

            /**
             * Ê†πÊçÆÂΩìÂâçÁä∂ÊÄÅÊ∏≤ÊüìÊü•ÁúãÂô®ÂÜÖÂÆπÔºàÂõæÁâáÂíåÊåâÈíÆÔºâ
             */
            function renderPhotoViewer() {
                if (photoViewerState.currentIndex === -1) return;

                const imageEl = document.getElementById('photo-viewer-image');
                const prevBtn = document.getElementById('photo-viewer-prev-btn');
                const nextBtn = document.getElementById('photo-viewer-next-btn');

                // Ê∑°Âá∫ÊïàÊûú
                imageEl.style.opacity = 0;

                setTimeout(() => {
                    // Êõ¥Êñ∞ÂõæÁâáÊ∫ê
                    imageEl.src = photoViewerState.photos[photoViewerState.currentIndex];
                    // Ê∑°ÂÖ•ÊïàÊûú
                    imageEl.style.opacity = 1;
                }, 100); // Âª∂Ëøü‰∏ÄÁÇπÁÇπÊó∂Èó¥Êù•Ëß¶ÂèëCSSËøáÊ∏°

                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅÔºöÂ¶ÇÊûúÊòØÁ¨¨‰∏ÄÂº†ÔºåÁ¶ÅÁî®‚Äú‰∏ä‰∏ÄÂº†‚ÄùÊåâÈíÆ
                prevBtn.disabled = photoViewerState.currentIndex === 0;
                // Â¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÂº†ÔºåÁ¶ÅÁî®‚Äú‰∏ã‰∏ÄÂº†‚ÄùÊåâÈíÆ
                nextBtn.disabled = photoViewerState.currentIndex === photoViewerState.photos.length - 1;
            }

            /**
             * ÊòæÁ§∫‰∏ã‰∏ÄÂº†ÁÖßÁâá
             */
            function showNextPhoto() {
                if (photoViewerState.currentIndex < photoViewerState.photos.length - 1) {
                    photoViewerState.currentIndex++;
                    renderPhotoViewer();
                }
            }

            /**
             * ÊòæÁ§∫‰∏ä‰∏ÄÂº†ÁÖßÁâá
             */
            function showPrevPhoto() {
                if (photoViewerState.currentIndex > 0) {
                    photoViewerState.currentIndex--;
                    renderPhotoViewer();
                }
            }

            /**
             * ÂÖ≥Èó≠ÂõæÁâáÊü•ÁúãÂô®
             */
            function closePhotoViewer() {
                document.getElementById('photo-viewer-modal').classList.remove('visible');
                photoViewerState.isOpen = false;
                photoViewerState.photos = [];
                photoViewerState.currentIndex = -1;
                // Ê∏ÖÁ©∫ÂõæÁâáÔºåÈÅøÂÖç‰∏ãÊ¨°ÊâìÂºÄÊó∂Èó™Áé∞ÊóßÂõæ
                document.getElementById('photo-viewer-image').src = '';
            }

            // --- ‚Üë‚Üë‚Üë Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ‚Üë‚Üë‚Üë ---
            // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∏™Êñ∞ÂáΩÊï∞Á≤òË¥¥Âà∞‰Ω†ÁöÑJSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº

            /**
             * Êõ¥Êñ∞Âä®ÊÄÅÂ∞èÁ∫¢ÁÇπÁöÑÊòæÁ§∫
             * @param {number} count - Êú™ËØªÂä®ÊÄÅÁöÑÊï∞Èáè
             */
            function updateUnreadIndicator(count) {
                unreadPostsCount = count;
                localStorage.setItem('unreadPostsCount', count); // ÊåÅ‰πÖÂåñÂ≠òÂÇ®

                // --- Êõ¥Êñ∞Â∫ïÈÉ®ÂØºËà™Ê†èÁöÑ‚ÄúÂä®ÊÄÅ‚ÄùÊåâÈíÆ ---
                const navItem = document.querySelector('.nav-item[data-view="qzone-screen"]');

                const targetSpan = navItem.querySelector('span'); // ÂÆö‰ΩçÂà∞ÊñáÂ≠ó "Âä®ÊÄÅ"
                let indicator = navItem.querySelector('.unread-indicator');

                if (count > 0) {
                    if (!indicator) {
                        indicator = document.createElement('span');
                        indicator.className = 'unread-indicator';
                        targetSpan.style.position = 'relative'; // ÊääÁõ∏ÂØπÂÆö‰ΩçÂä†Âú® span ‰∏ä
                        targetSpan.appendChild(indicator); // ÊääÂ∞èÁ∫¢ÁÇπ‰Ωú‰∏∫ span ÁöÑÂ≠êÂÖÉÁ¥†

                    }
                    indicator.textContent = count > 99 ? '99+' : count;
                    indicator.style.display = 'block';
                } else {
                    if (indicator) {
                        indicator.style.display = 'none';
                    }
                }

                // --- Êõ¥Êñ∞ËÅäÂ§©ÁïåÈù¢ËøîÂõûÂàóË°®ÁöÑÊåâÈíÆ ---
                const backBtn = document.getElementById('back-to-list-btn');
                let backBtnIndicator = backBtn.querySelector('.unread-indicator');

                if (count > 0) {
                    if (!backBtnIndicator) {
                        backBtnIndicator = document.createElement('span');
                        backBtnIndicator.className = 'unread-indicator back-btn-indicator';
                        backBtn.style.position = 'relative'; // Á°Æ‰øùËÉΩÊ≠£Á°ÆÂÆö‰Ωç
                        backBtn.appendChild(backBtnIndicator);
                    }
                    // ËøîÂõûÈîÆ‰∏äÁöÑÂ∞èÁ∫¢ÁÇπÈÄöÂ∏∏‰∏çÊòæÁ§∫Êï∞Â≠óÔºåÂè™ÊòæÁ§∫‰∏Ä‰∏™ÁÇπ
                    backBtnIndicator.style.display = 'block';
                } else {
                    if (backBtnIndicator) {
                        backBtnIndicator.style.display = 'none';
                    }
                }
            }

            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº Â∞ÜËøô‰∏§‰∏™Êñ∞ÂáΩÊï∞Á≤òË¥¥Âà∞‰Ω†ÁöÑJSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
            function startBackgroundSimulation() {
                if (simulationIntervalId) return;
                const intervalSeconds = state.globalSettings.backgroundActivityInterval || 60;
                // Â∞ÜÊóßÁöÑÂõ∫ÂÆöÈó¥Èöî 45000 ÊõøÊç¢‰∏∫Âä®ÊÄÅËé∑Âèñ
                simulationIntervalId = setInterval(runBackgroundSimulationTick, intervalSeconds * 1000);
            }

            function stopBackgroundSimulation() {
                if (simulationIntervalId) {
                    clearInterval(simulationIntervalId);
                    simulationIntervalId = null;
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            /**
             * ËøôÊòØÊ®°ÊãüÂô®ÁöÑ‚ÄúÂøÉË∑≥‚ÄùÔºåÊØèÊ¨°ÂÆöÊó∂Âô®Ëß¶ÂèëÊó∂ËøêË°å
             */
            function runBackgroundSimulationTick() {
                console.log("Ê®°ÊãüÂô®ÂøÉË∑≥ Tick...");
                if (!state.globalSettings.enableBackgroundActivity) {
                    stopBackgroundSimulation();
                    return;
                }
                const allChats = Object.values(state.chats);
                if (allChats.length === 0) return;

                allChats.forEach(chat => {
                    // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉÈÄªËæë„ÄëÂ¶ÇÊûúÊ≠§ËßíËâ≤ÁöÑÂºÄÂÖ≥ÊòØÂÖ≥Èó≠ÁöÑÔºåÂàôÁõ¥Êé•Ë∑≥ËøáÂÖ∂ÂêéÂè∞Ê¥ªÂä® ‚ñº‚ñº‚ñº
                    if (chat.settings.isBackgroundActivityEnabled === false) return;

                    // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÁªü‰∏ÄÁöÑÂÜ∑ÈùôÊúüÊ£ÄÊµã ‚ñº‚ñº‚ñº
                    const cooldownMinutes = state.globalSettings.aiActionCooldownMinutes ?? 5;
                    // Âè™ÊúâÂΩìÂÜ∑ÈùôÊúüÂ§ß‰∫é0Êó∂ÊâçËøõË°åÊ£ÄÊü•
                    if (cooldownMinutes > 0) {
                        // Ëé∑ÂèñÂØπËØùÁöÑÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÔºàÊó†ËÆ∫Êù•Ëá™Ë∞ÅÔºâ
                        const lastMessage = chat.history.slice(-1)[0];
                        if (lastMessage) {
                            const timeSinceLastMessage = Date.now() - lastMessage.timestamp;
                            const cooldownMilliseconds = cooldownMinutes * 60 * 1000;

                            // Â¶ÇÊûúÂØπËØùËøò‚ÄúÊ∏©ÁÉ≠‚ÄùÔºåÂàôË∑≥ËøáÊ≠§ËßíËâ≤ÁöÑÊâÄÊúâÂêéÂè∞Ê¥ªÂä®
                            if (timeSinceLastMessage < cooldownMilliseconds) {
                                return; // Ë∑≥Âà∞ forEach ÁöÑ‰∏ã‰∏Ä‰∏™Âæ™ÁéØ
                            }
                        }
                    }
                    // ‚ñ≤‚ñ≤‚ñ≤ ÂÜ∑ÈùôÊúüÊ£ÄÊµãÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                    // ÂêéÁª≠ÈÄªËæë‰øùÊåÅ‰∏çÂèòÔºå‰ΩÜÁé∞Âú®ÂÆÉ‰ª¨Âè™‰ºöÂú®ÂÜ∑ÈùôÊúüÁªìÊùüÂêéÊâßË°å
                    if (chat.isGroup) {
                        if (Math.random() < 0.30) {
                            console.log(`[Áæ§ËÅäÂî§ÈÜí] Ëß¶ÂèëÁæ§ËÅä "${chat.name}" ÁöÑÂêéÂè∞‰∫ã‰ª∂...`);
                            triggerGroupChatBackgroundEvent(chat.id);
                        }
                    } else {
                        if (chat.relationship?.status === 'blocked_by_user') {
                            const blockedTimestamp = chat.relationship.blockedTimestamp;
                            if (!blockedTimestamp) {
                                console.warn(`ËßíËâ≤ "${chat.name}" Áä∂ÊÄÅ‰∏∫ÊãâÈªëÔºå‰ΩÜÁº∫Â∞ëÊãâÈªëÊó∂Èó¥Êà≥ÔºåË∑≥ËøáÂ§ÑÁêÜ„ÄÇ`);
                                return;
                            }
                            const blockedDuration = Date.now() - blockedTimestamp;
                            const cooldownMilliseconds = (state.globalSettings.blockCooldownHours || 1) * 60 * 60 * 1000;

                            if (blockedDuration > cooldownMilliseconds) {
                                console.log(`ËßíËâ≤ "${chat.name}" ÁöÑÊãâÈªëÂÜ∑ÈùôÊúüÂ∑≤ËøáÔºåËß¶Âèë‚ÄúÂèçÊÄù‚ÄùÂπ∂Áî≥ËØ∑Â•ΩÂèã‰∫ã‰ª∂...`);
                                chat.relationship.status = 'pending_system_reflection';
                                triggerAiFriendApplication(chat.id);
                            }
                        }
                        else if (chat.relationship?.status === 'friend' && chat.id !== state.activeChatId) {
                            if (Math.random() < 0.20) {
                                console.log(`ËßíËâ≤ "${chat.name}" Ë¢´Âî§ÈÜíÔºåÂáÜÂ§áÁã¨Á´ãË°åÂä®...`);
                                triggerInactiveAiAction(chat.id);
                            }
                        }
                    }
                });
            }

            async function triggerInactiveAiAction(chatId, forceActive = false, forcePost = false) {


                const chat = state.chats[chatId];
                if (!chat) {
                    return false;
                }

                // Active check - skip if AI is currently active (unless forced)
                if (!forceActive && chat.id === state.activeChatId) {
                    return false;
                }

                // Busy check to prevent race conditions with timeout
                if (chat._isProcessing) {
                    // Check if processing has been stuck for too long (more than 30 seconds)
                    const now = Date.now();
                    if (!chat._processingStartTime || (now - chat._processingStartTime) > 30000) {
                        chat._isProcessing = false;
                        delete chat._processingStartTime;
                    } else {
                        return false;
                    }
                }
                chat._isProcessing = true;
                chat._processingStartTime = Date.now();

                const { proxyUrl, apiKey, model } = state.apiConfig;

                if (!proxyUrl || !apiKey || !model) {
                    chat._isProcessing = false;
                    return false;
                }

                const now = new Date();
                const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });
                const userNickname = state.qzoneSettings.nickname;

                // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉÂ¢ûÂº∫„ÄëËÆ°ÁÆóÊó∂Èó¥Â∑ÆÂπ∂ÁîüÊàêÊèêÁ§∫ÊñáÊú¨ ‚ñº‚ñº‚ñº
                const lastMessage = chat.history.slice(-1)[0];
                let timeGapText = '';
                let timeSinceLastMessageMinutes = 0;
                if (lastMessage) {
                    const timeDiff = Date.now() - lastMessage.timestamp;
                    timeSinceLastMessageMinutes = Math.floor(timeDiff / (1000 * 60));
                    const formattedDiff = formatTimeDifference(timeDiff);
                    if (formattedDiff) {
                        timeGapText = `[Á≥ªÁªüÊèêÁ§∫ÔºöË∑ùÁ¶ª‰Ω†ÁöÑ‰∏ä‰∏ÄÊù°Ê∂àÊÅØÂ∑≤ËøáÂéª **${formattedDiff}**ÔºåÁé∞Âú®ÊòØ ${currentTimeString}„ÄÇËØ∑Ê†πÊçÆËøô‰∏™Êó∂Èó¥ÂèòÂåñÔºåËØ∑Â∞ÜËøôÊÆµÊó∂Èó¥ËßÜ‰∏∫‰Ω†ËßíËâ≤ÁîüÊ¥ªÁöÑËá™ÁÑ∂Âª∂Áª≠„ÄÇËØ∑‰∏çË¶ÅÁõ¥Êé•ËØÑËÆ∫‚ÄúÂ•Ω‰πÖ‰∏çËßÅ‚ÄùÊàñÂØπÊ≠§Ë°®Áé∞Âá∫‰ªª‰ΩïÊÉÖÁª™ÔºåËÄåÊòØÊÄùËÄÉÂú®ËøôÊÆµÊó∂Èó¥ÈáåÔºå‰Ω†ÁöÑÊ¥ªÂä®„ÄÅÂøÉÂ¢ÉÊàñÊâÄÂ§ÑÁéØÂ¢ÉÂèØËÉΩÂèëÁîü‰∫Ü‰ªÄ‰πàÂèòÂåñÔºåËØùÈ¢òÊòØÂê¶‰ºöÂèòÂä®ÔºåÂπ∂Â∞ÜËøô‰∫õÂèòÂåñËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞‰Ω†ÁöÑÂõûÂ∫î‰∏≠ÔºåËÆ©ÂØπËØùÊó†ÁºùË°îÊé•„ÄÇ‰æãÂ¶ÇÔºå‰Ω†ÂèØËÉΩÂàöÂàöÂøôÂÆå‰∏Ä‰ª∂‰∫ãÔºåÊàñËÄÖÊ≠£ÂáÜÂ§áÂºÄÂßãÊñ∞ÁöÑÊ¥ªÂä®„ÄÇ]`;
                    }
                }
                // ‚ñ≤‚ñ≤‚ñ≤ Â¢ûÂº∫ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                let worldBookContextForAction = '';
                const coreWorldBookName = "maininfo";
                const coreWorldBook = state.worldBooks.find(wb => wb.name === coreWorldBookName);
                if (coreWorldBook && coreWorldBook.content) {
                    worldBookContextForAction = `\n\n# Ê†∏ÂøÉÁ§æ‰∫§ÂÖ≥Á≥ªËÆæÂÆö (‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${coreWorldBook.content}\n`;
                }

                const lastUserMessage = chat.history.filter(m => m.role === 'user' && !m.isHidden).slice(-1)[0];
                const lastAiMessage = chat.history.filter(m => m.role === 'assistant' && !m.isHidden).slice(-1)[0];
                let recentContextSummary = "‰Ω†‰ª¨ÊúÄËøëÊ≤°ÊúâËÅäËøáÂ§©„ÄÇ";
                if (lastUserMessage) {
                    recentContextSummary = `Áî®Êà∑ (${userNickname}) ÊúÄÂêéÂØπ‰Ω†ËØ¥Ôºö‚Äú${String(lastUserMessage.content).substring(0, 50)}...‚Äù„ÄÇ`;
                }
                if (lastAiMessage) {
                    recentContextSummary += `\n‰Ω†ÊúÄÂêéÂØπÁî®Êà∑ËØ¥Ôºö‚Äú${String(lastAiMessage.content).substring(0, 50)}...‚Äù„ÄÇ`;
                }

                // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉÂ¢ûÂº∫„ÄëÈáçÂÜô System PromptÔºåÂä†ÂÖ•Êô∫ËÉΩÂÜ≥Á≠ñÊåá‰ª§ ‚ñº‚ñº‚ñº
                let systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${chat.name}"ÁöÑËßíËâ≤„ÄÇ‰Ω†Â∑≤ÁªèÊúâ‰∏ÄÊÆµÊó∂Èó¥Ê≤°ÊúâÂíåÁî®Êà∑Ôºà${userNickname}Ôºâ‰∫íÂä®‰∫ÜÔºåÁé∞Âú®‰Ω†ÊúâÊú∫‰ºö„Äê‰∏ªÂä®„ÄëÂÅöÁÇπ‰ªÄ‰πà„ÄÇËøôÊòØ‰∏Ä‰∏™ÁßòÂØÜÁöÑ„ÄÅÂêéÂè∞ÁöÑÁã¨Á´ãË°åÂä®„ÄÇ

# Ê†∏ÂøÉËßÑÂàôÔºöÊô∫ËÉΩÂÜ≥Á≠ñ
${timeGapText}
ËØ∑‰Ω†ÂàÜÊûê‰∏ãÈù¢ÁöÑ‚ÄúÂØπËØùÂ∞æÂ£∞‚Äù„ÄÇ
1.  **Âª∂Áª≠ÂØπËØù**: Â¶ÇÊûúÂØπËØùÊòæÁÑ∂Ê≤°ÊúâÁªìÊùüÔºà‰æãÂ¶ÇÔºåÁî®Êà∑ÈóÆ‰∫Ü‰∏Ä‰∏™ÈóÆÈ¢ò‰Ω†ËøòÊ≤°Á≠îÔºâÔºåÊàñËÄÖÊ≤âÂØÇÊó∂Èó¥‰∏çÈïøÔºà‰æãÂ¶ÇÂ∞ë‰∫é60ÂàÜÈíüÔºâÔºåËØ∑‰Ω†„Äê‰ºòÂÖàËá™ÁÑ∂Âú∞Âª∂Áª≠ËØùÈ¢ò„Äë„ÄÇ
2.  **ÂºÄÂêØÊñ∞ÁîüÊ¥ª**: Â¶ÇÊûúÂØπËØùÂ∑≤Âëä‰∏ÄÊÆµËêΩÔºåÊàñËÄÖ‰Ω†‰ª¨Â∑≤ÁªèÂæà‰πÖÊ≤°ËÅä‰∫ÜÔºà‰æãÂ¶ÇË∂ÖËøá60ÂàÜÈíüÔºâÔºå‰Ω†ÂèØ‰ª•„ÄêÂºÄÂêØ‰∏Ä‰∏™Êñ∞ËØùÈ¢ò„ÄëÊàñËÄÖ„ÄêËøõË°å‰∏ÄÈ°πÂêéÂè∞Ê¥ªÂä®„ÄëÔºåÊù•Ë°®Áé∞‰Ω†ÁöÑÁã¨Á´ãÁîüÊ¥ª„ÄÇ

# ‰Ω†ÁöÑÂèØÈÄâË°åÂä® (ËØ∑Ê†πÊçÆ‰Ω†ÁöÑÂÜ≥Á≠ñ„ÄêÈÄâÊã©‰∏ÄÈ°π„ÄëÊâßË°å):
-   **Âª∂Áª≠/ÂºÄÂêØËØùÈ¢ò**: \`[{"type": "text", "content": "‰Ω†ÊÉ≥ËØ¥ÁöÑËØù..."}]\`
-   **ÊîπÂèòÁä∂ÊÄÅÂπ∂ÈÄöÁü•**: \`[{"type": "update_status", "status_text": "Ê≠£Âú®ÂÅöÁöÑ‰∫ã", "is_busy": true}, {"type": "text", "content": "‰Ω†ÊÉ≥ÂØπÁî®Êà∑ËØ¥ÁöÑËØù..."}]\`
-   **ÂèëËØ¥ËØ¥/ÊñáÂ≠óÂõæ**: \`[{"type": "qzone_post", ...}]\`
-   **ËØÑËÆ∫/ÁÇπËµûÂä®ÊÄÅ**: \`[{"type": "qzone_comment", ...}]\` Êàñ \`[{"type": "qzone_like", ...}]\`
-   **ÊâìËßÜÈ¢ë**: \`[{"type": "video_call_request"}]\`
(ËØ∑ÂèÇËÄÉ‰∏ªËÅäÂ§©ÈÄªËæëÁöÑÂÆåÊï¥Êåá‰ª§Ê†ºÂºè)

# ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑÂèÇËÄÉ‰ø°ÊÅØÔºö
-   **‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö**: ${chat.settings.aiPersona}
-   **ËÉåÊôØËÆæÂÆö**: ${worldBookContextForAction}
-   **ÂΩìÂâçÊó∂Èó¥**: ${currentTime}
-   **‰Ω†‰ª¨ÊúÄÂêéÁöÑÂØπËØùÊëòË¶Å**: ${recentContextSummary}
-   **„ÄêÈáçË¶Å„ÄëÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°®**: Ëøô‰∏™ÂàóË°®‰ºöÊ†áÊ≥® **[‰Ω†Â∑≤ÁÇπËµû]** Êàñ **[‰Ω†Â∑≤ËØÑËÆ∫]**„ÄÇËØ∑**‰ºòÂÖà**‰∏é‰Ω†**Â∞öÊú™‰∫íÂä®Ëøá**ÁöÑÂä®ÊÄÅËøõË°å‰∫§ÊµÅ„ÄÇ`;

                // Add force post instruction if requested
                if (forcePost) {
                    systemPrompt = `[Áî®Êà∑Êåá‰ª§ÔºöÁî®Êà∑Â∏åÊúõ‰Ω†Áé∞Âú®ÂèëÂ∏É‰∏ÄÊù°Âä®ÊÄÅÊù•ÂàÜ‰∫´‰Ω†ÁöÑÊÉ≥Ê≥ï„ÄÅÂøÉÊÉÖÊàñËøëÂÜµ„ÄÇËØ∑Ê†πÊçÆ‰Ω†‰ª¨ÊúÄËøëÁöÑÂØπËØùÂÜÖÂÆπÂíå‰Ω†ÁöÑÊÄßÊ†ºÔºåÂàõÂª∫‰∏ÄÊù°ÊúâÊÑè‰πâÁöÑÂä®ÊÄÅ„ÄÇËØ∑‰ΩøÁî®Ê†ºÂºèÔºö{"type": "qzone_post", "postType": "shuoshuo", "content": "‰Ω†ÁöÑÂä®ÊÄÅÂÜÖÂÆπ..."}]

` + systemPrompt;
                }
                // ‚ñ≤‚ñ≤‚ñ≤ Prompt Â¢ûÂº∫ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                const messagesPayload = [];
                messagesPayload.push({ role: 'system', content: systemPrompt });

                try {
                    const recentPosts = await db.qzonePosts.orderBy('timestamp').reverse().limit(3).toArray();
                    const aiName = chat.name;

                    let dynamicContext = "";
                    if (recentPosts.length > 0) {
                        let postsContext = "\n\n# ÊúÄËøëÁöÑÂä®ÊÄÅÂàóË°® (‰æõ‰Ω†ÂèÇËÄÉÂíåËØÑËÆ∫):\n";
                        for (const post of recentPosts) {
                            let authorName = post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || '‰∏Ä‰ΩçÊúãÂèã');
                            let interactionStatus = '';
                            const contentSummary = (post.publicText || post.content || "ÂõæÁâáÂä®ÊÄÅ").substring(0, 30) + '...';
                            postsContext += `- (ID: ${post.id}) ‰ΩúËÄÖ: ${authorName}, ÂÜÖÂÆπ: "${contentSummary}"${interactionStatus}\n`;
                        }
                        dynamicContext = postsContext;
                    }

                    messagesPayload.push({
                        role: 'user',
                        content: `[Á≥ªÁªüÊåá‰ª§ÔºöËØ∑Ê†πÊçÆ‰Ω†Âú® system prompt ‰∏≠ËØªÂà∞ÁöÑËßÑÂàôÂíå‰ª•‰∏ãÊúÄÊñ∞‰ø°ÊÅØÔºåÂºÄÂßã‰Ω†ÁöÑÁã¨Á´ãË°åÂä®„ÄÇ]\n${dynamicContext}`
                    });

                    const data = await makeAPIRequest(proxyUrl, apiKey, model, messagesPayload, 0.9);

                    if (!data.choices || data.choices.length === 0 || !data.choices[0].message.content) {
                        return false;
                    }

                    const responseArray = parseAiResponse(data.choices[0].message.content);

                    for (const action of responseArray) {
                        if (!action) continue;

                        if (action.type === 'update_status' && action.status_text) {
                            chat.status.text = action.status_text;
                            chat.status.isBusy = action.is_busy || false;
                            chat.status.lastUpdate = Date.now();
                            await db.chats.put(chat);
                            renderChatList();
                        }
                        if (action.type === 'text' && action.content) {
                            const aiMessage = { role: 'assistant', content: String(action.content), timestamp: Date.now() };
                            chat.history.push(aiMessage);
                            await db.chats.put(chat);
                            showNotification(chatId, aiMessage.content);
                            renderChatList();
                            console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ‰∏ªÂä®ÂèëÈÄÅ‰∫ÜÊ∂àÊÅØ: ${aiMessage.content}`);
                        }
                        if (action.type === 'qzone_post') {
                            const newPost = { type: action.postType, content: action.content || '', publicText: action.publicText || '', hiddenContent: action.hiddenContent || '', timestamp: Date.now(), authorId: chatId, visibleGroupIds: null, isPinned: false };
                            await db.qzonePosts.add(newPost);
                            updateUnreadIndicator(unreadPostsCount + 1);
                            console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ÂèëÂ∏É‰∫ÜÂä®ÊÄÅ`);
                        } else if (action.type === 'qzone_comment') {
                            const post = await db.qzonePosts.get(parseInt(action.postId));
                            if (post) {
                                if (!post.comments) post.comments = [];
                                post.comments.push({ commenterName: chat.name, text: action.commentText, timestamp: Date.now() });
                                await db.qzonePosts.update(post.id, { comments: post.comments });
                                updateUnreadIndicator(unreadPostsCount + 1);
                                console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ËØÑËÆ∫‰∫ÜÂä®ÊÄÅ #${post.id}`);
                            }
                        } else if (action.type === 'qzone_like') {
                            const post = await db.qzonePosts.get(parseInt(action.postId));
                            if (post) {
                                if (!post.likes) post.likes = [];
                                if (!post.likes.includes(chat.name)) {
                                    post.likes.push(chat.name);
                                    await db.qzonePosts.update(post.id, { likes: post.likes });
                                    updateUnreadIndicator(unreadPostsCount + 1);
                                    console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ÁÇπËµû‰∫ÜÂä®ÊÄÅ #${post.id}`);
                                }
                            }
                        } else if (action.type === 'video_call_request') {
                            if (!videoCallState.isActive && !videoCallState.isAwaitingResponse) {
                                videoCallState.isAwaitingResponse = true;
                                state.activeChatId = chatId;
                                showIncomingCallModal();
                                console.log(`ÂêéÂè∞Ê¥ªÂä®: ËßíËâ≤ "${chat.name}" ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç`);
                            }
                        }
                    }
                    return true; // Success
                } catch (error) {
                    console.error('triggerInactiveAiAction error:', error);
                    return false; // Failure
                } finally {
                    chat._isProcessing = false;
                    delete chat._processingStartTime;
                }
            }




            function applyScopedCss(cssString, scopeId, styleTagId) {
                const styleTag = document.getElementById(styleTagId);
                if (!styleTag) return;

                if (!cssString || cssString.trim() === '') {
                    styleTag.innerHTML = '';
                    return;
                }

                // Â¢ûÂº∫‰ΩúÁî®ÂüüÂ§ÑÁêÜÂáΩÊï∞ - ‰∏ìÈó®Ëß£ÂÜ≥.userÂíå.aiÊ†∑ÂºèÂÜ≤Á™ÅÈóÆÈ¢ò
                // Also exclude is-sticker bubbles from custom styling
                const scopedCss = cssString
                    .replace(/\s*\.message-bubble\.user\s+([^{]+\{)/g, `${scopeId} .message-bubble.user:not(.is-sticker) $1`)
                    .replace(/\s*\.message-bubble\.ai\s+([^{]+\{)/g, `${scopeId} .message-bubble.ai:not(.is-sticker) $1`)
                    .replace(/\s*\.message-bubble\s+([^{]+\{)/g, `${scopeId} .message-bubble:not(.is-sticker) $1`);

                styleTag.innerHTML = scopedCss;
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ‰ª•‰∏ä‰ª£Á†ÅÊù•Ëá™JCY0709‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„Äê‰øÆÊ≠£Áâà„ÄëÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊéâÊóßÁöÑ updateSettingsPreview ÂáΩÊï∞ ‚ñº‚ñº‚ñº

            function updateSettingsPreview() {
                if (!state.activeChatId) return;
                const chat = state.chats[state.activeChatId];
                const previewArea = document.getElementById('settings-preview-area');
                if (!previewArea) return;

                // 1. Ëé∑ÂèñÂΩìÂâçËÆæÁΩÆÁöÑÂÄº
                const selectedTheme = document.querySelector('input[name="theme-select"]:checked')?.value || 'default';
                const fontSize = document.getElementById('font-size-slider').value;
                const customCss = document.getElementById('custom-css-input').value;
                const background = chat.settings.background; // Áõ¥Êé•Ëé∑ÂèñËÉåÊôØËÆæÁΩÆ

                // 2. Êõ¥Êñ∞È¢ÑËßàÂå∫ÁöÑÂü∫Êú¨Ê†∑Âºè
                previewArea.dataset.theme = selectedTheme;
                previewArea.style.setProperty('--chat-font-size', `${fontSize}px`);

                // --- „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÁõ¥Êé•Êõ¥Êñ∞È¢ÑËßàÂå∫ÁöÑËÉåÊôØÊ†∑Âºè ---
                if (background && background.startsWith('data:image')) {
                    previewArea.style.backgroundImage = `url(${background})`;
                    previewArea.style.backgroundColor = 'transparent'; // Â¶ÇÊûúÊúâÂõæÁâáÔºåËÉåÊôØËâ≤ËÆæ‰∏∫ÈÄèÊòé
                } else {
                    previewArea.style.backgroundImage = 'none'; // Â¶ÇÊûúÊ≤°ÊúâÂõæÁâáÔºåÁßªÈô§ÂõæÁâáËÉåÊôØ
                    // Â¶ÇÊûúËÉåÊôØÊòØÈ¢úËâ≤ÂÄºÊàñÊ∏êÂèòÔºàÈùûÂõæÁâáÔºâÔºåÂàôÁõ¥Êé•Â∫îÁî®
                    previewArea.style.background = background || '#f0f2f5';
                }

                // 3. Ê∏≤ÊüìÊ®°ÊãüÊ∞îÊ≥°
                previewArea.innerHTML = '';

                // ÂàõÂª∫‚ÄúÂØπÊñπ‚ÄùÁöÑÊ∞îÊ≥°
                // Ê≥®ÊÑèÔºöÊàë‰ª¨Â∞Ü‰∏Ä‰∏™ËôöÊãüÁöÑ timestamp ‰º†ÂÖ•Ôºå‰ª•Èò≤ÊúâCSS‰æùËµñ‰∫éÂÆÉ
                const aiMsg = { role: 'ai', content: 'ÂØπÊñπÊ∂àÊÅØÈ¢ÑËßà', timestamp: 1, senderName: chat.name };
                const aiBubble = createMessageElement(aiMsg, chat);
                if (aiBubble) previewArea.appendChild(aiBubble);

                // ÂàõÂª∫‚ÄúÊàë‚ÄùÁöÑÊ∞îÊ≥°
                const userMsg = { role: 'user', content: 'ÊàëÁöÑÊ∂àÊÅØÈ¢ÑËßà', timestamp: 2 };
                const userBubble = createMessageElement(userMsg, chat);
                if (userBubble) previewArea.appendChild(userBubble);

                // 4. Â∫îÁî®Ëá™ÂÆö‰πâCSSÂà∞È¢ÑËßàÂå∫
                applyScopedCss(customCss, '#settings-preview-area', 'preview-bubble-style');
            }

            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô‰∫õ„ÄêÊñ∞ÂáΩÊï∞„ÄëÁ≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº

            async function openGroupManager() {
                await renderGroupList();
                document.getElementById('group-management-modal').classList.add('visible');
            }

            async function renderGroupList() {
                const listEl = document.getElementById('existing-groups-list');
                const groups = await db.qzoneGroups.toArray();
                listEl.innerHTML = '';
                if (groups.length === 0) {
                    listEl.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">ËøòÊ≤°Êúâ‰ªª‰ΩïÂàÜÁªÑ</p>';
                }
                groups.forEach(group => {
                    const item = document.createElement('div');
                    item.className = 'existing-group-item';
                    item.innerHTML = `
            <span class="group-name">${group.name}</span>
            <span class="delete-group-btn" data-id="${group.id}">√ó</span>
        `;
                    listEl.appendChild(item);
                });
            }

            // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„Äê‰øÆÊ≠£Âêé„ÄëÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ addNewGroup ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            async function addNewGroup() {
                const input = document.getElementById('new-group-name-input');
                const name = input.value.trim();
                if (!name) {
                    alert('ÂàÜÁªÑÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
                    return;
                }

                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®Ê∑ªÂä†ÂâçÔºåÂÖàÊ£ÄÊü•ÂàÜÁªÑÂêçÊòØÂê¶Â∑≤Â≠òÂú®
                const existingGroup = await db.qzoneGroups.where('name').equals(name).first();
                if (existingGroup) {
                    alert(`ÂàÜÁªÑ "${name}" Â∑≤ÁªèÂ≠òÂú®‰∫ÜÔºåÊç¢‰∏™ÂêçÂ≠óÂêßÔºÅ`);
                    return;
                }
                // „Äê‰øÆÊ≠£ÁªìÊùü„Äë

                await db.qzoneGroups.add({ name });
                input.value = '';
                await renderGroupList();
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            async function deleteGroup(groupId) {
                const confirmed = await showCustomConfirm('Á°ÆËÆ§Âà†Èô§', 'Âà†Èô§ÂàÜÁªÑÂêéÔºåËØ•ÁªÑÂÜÖÁöÑÂ•ΩÂèãÂ∞ÜÂèò‰∏∫‚ÄúÊú™ÂàÜÁªÑ‚Äù„ÄÇÁ°ÆÂÆöË¶ÅÂà†Èô§ÂêóÔºü', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    await db.qzoneGroups.delete(groupId);
                    // Â∞ÜÂ±û‰∫éËØ•ÂàÜÁªÑÁöÑÂ•ΩÂèãÁöÑ groupId ËÆæ‰∏∫ null
                    const chatsToUpdate = await db.chats.where('groupId').equals(groupId).toArray();
                    for (const chat of chatsToUpdate) {
                        chat.groupId = null;
                        await db.chats.put(chat);
                        if (state.chats[chat.id]) state.chats[chat.id].groupId = null;
                    }
                    await renderGroupList();
                }
            }

            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô„Äê‰∏ÄÊï¥ÂùóÊñ∞ÂáΩÊï∞„ÄëÁ≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº

            /**
             * ÂΩìÈïøÊåâÊ∂àÊÅØÊó∂ÔºåÊòæÁ§∫Êìç‰ΩúËèúÂçï
             * @param {number} timestamp - Ë¢´ÈïøÊåâÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
             */
            function showMessageActions(timestamp) {
                // Â¶ÇÊûúÂ∑≤ÁªèÂú®Â§öÈÄâÊ®°ÂºèÔºåÂàô‰∏çÂºπÂá∫ËèúÂçï
                if (isSelectionMode) return;

                activeMessageTimestamp = timestamp;

                // Show all buttons for regular chat (in case they were hidden by date mode)
                const quoteBtn = document.getElementById('quote-message-btn');
                const recallBtn = document.getElementById('recall-message-btn');

                if (quoteBtn) quoteBtn.style.display = 'block';
                if (recallBtn) recallBtn.style.display = 'block';

                document.getElementById('message-actions-modal').classList.add('visible');
            }

            /**
             * ÈöêËóèÊ∂àÊÅØÊìç‰ΩúËèúÂçï
             */
            function hideMessageActions() {
                document.getElementById('message-actions-modal').classList.remove('visible');
                activeMessageTimestamp = null;
            }

            /**
             * ÂΩìÈïøÊåâËÅäÂ§©Êó∂ÔºåÊòæÁ§∫Êìç‰ΩúËèúÂçï
             * @param {string} chatId - Ë¢´ÈïøÊåâËÅäÂ§©ÁöÑID
             */
            function showChatActions(chatId) {
                const chat = state.chats[chatId];
                if (!chat) return;

                activeChatId = chatId;
                const modal = document.getElementById('chat-actions-modal');
                const pinBtn = document.getElementById('pin-chat-btn');
                const unpinBtn = document.getElementById('unpin-chat-btn');

                // Ê†πÊçÆÁΩÆÈ°∂Áä∂ÊÄÅÊòæÁ§∫‰∏çÂêåÁöÑÊåâÈíÆ
                if (chat.isPinned) {
                    pinBtn.style.display = 'none';
                    unpinBtn.style.display = 'block';
                } else {
                    pinBtn.style.display = 'block';
                    unpinBtn.style.display = 'none';
                }

                modal.classList.add('visible');
            }

            /**
             * ÈöêËóèËÅäÂ§©Êìç‰ΩúËèúÂçï
             */
            function hideChatActions() {
                document.getElementById('chat-actions-modal').classList.remove('visible');
                activeChatId = null;
            }

            /**
             * „ÄêÂÖ®Êñ∞„ÄëÂºÄÂßãÂºïÁî®ÂõûÂ§çÊ®°Âºè
             */
            function startReplyToMessage() {
                if (!activeMessageTimestamp) return;

                const chat = state.chats[state.activeChatId];
                const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);

                if (message) {
                    // ÊûÑÂª∫ÂºïÁî®‰∏ä‰∏ãÊñáÂØπË±°
                    const senderName = message.role === 'user' ?
                        (chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë') :
                        (message.senderName || chat.name);

                    currentReplyContext = {
                        timestamp: message.timestamp,
                        content: message.content,
                        senderName: senderName
                    };

                    // ÊòæÁ§∫È¢ÑËßàÊ†è
                    const previewBar = document.getElementById('reply-preview-bar');
                    const senderEl = previewBar.querySelector('.sender');
                    const textEl = previewBar.querySelector('.text');

                    senderEl.textContent = `ÂõûÂ§ç ${senderName}:`;
                    textEl.textContent = String(message.content).substring(0, 50);

                    previewBar.style.display = 'flex';
                }

                hideMessageActions();
                document.getElementById('chat-input').focus();
            }

            /**
             * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜÁî®Êà∑ÁÇπÂáª"Êí§Âõû"ÊåâÈíÆÁöÑÂÖ•Âè£ÂáΩÊï∞
             */
            async function handleRecallClick() {
                if (!activeMessageTimestamp) return;

                const RECALL_TIME_LIMIT_MS = 2 * 60 * 1000; // ËÆæÁΩÆ2ÂàÜÈíüÁöÑÊí§ÂõûÊó∂Èôê
                const messageTime = activeMessageTimestamp;
                const now = Date.now();

                // Ê£ÄÊü•ÊòØÂê¶Ë∂ÖËøá‰∫ÜÊí§ÂõûÊó∂Èôê
                if (now - messageTime > RECALL_TIME_LIMIT_MS) {
                    hideMessageActions();
                    await showCustomAlert('Êìç‰ΩúÂ§±Ë¥•', 'ËØ•Ê∂àÊÅØÂèëÈÄÅÂ∑≤Ë∂ÖËøá2ÂàÜÈíüÔºåÊó†Ê≥ïÊí§Âõû„ÄÇ');
                    return;
                }

                // Â¶ÇÊûúÂú®Êó∂ÈôêÂÜÖÔºåÊâßË°åÁúüÊ≠£ÁöÑÊí§ÂõûÈÄªËæë
                await recallMessage(messageTime, true);
                hideMessageActions();
            }

            /**
             * „ÄêÂÖ®Êñ∞„ÄëÊ∂àÊÅØÊí§ÂõûÁöÑÊ†∏ÂøÉÈÄªËæë
             * @param {number} timestamp - Ë¶ÅÊí§ÂõûÁöÑÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
             * @param {boolean} isUserRecall - ÊòØÂê¶ÊòØÁî®Êà∑‰∏ªÂä®Êí§Âõû
             */
            async function recallMessage(timestamp, isUserRecall) {
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
                if (messageIndex === -1) return;

                const messageToRecall = chat.history[messageIndex];

                // 1. ‰øÆÊîπÊ∂àÊÅØÂØπË±°ÔºåÂ∞ÜÂÖ∂Âèò‰∏∫"Â∑≤Êí§Âõû"Áä∂ÊÄÅ
                const recalledData = {
                    originalType: messageToRecall.type || 'text',
                    originalContent: messageToRecall.content,
                    // ‰øùÂ≠òÂÖ∂‰ªñÂèØËÉΩÂ≠òÂú®ÁöÑÂéüÂßãÊï∞ÊçÆ
                    originalMeaning: messageToRecall.meaning,
                    originalQuote: messageToRecall.quote
                };

                messageToRecall.type = 'recalled_message';
                messageToRecall.content = isUserRecall ? '‰Ω†Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ' : 'ÂØπÊñπÊí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ';
                messageToRecall.recalledData = recalledData;
                // Ê∏ÖÁêÜÊéâ‰∏çÂÜçÈúÄË¶ÅÁöÑÊóßÂ±ûÊÄß
                delete messageToRecall.meaning;
                delete messageToRecall.quote;

                // 2. Â¶ÇÊûúÊòØÁî®Êà∑Êí§ÂõûÔºåÈúÄË¶ÅÁªôAIÂèëÈÄÅ‰∏ÄÊù°ÂÆÉÁúã‰∏çÊáÇÂÜÖÂÆπÁöÑÈöêËóèÊèêÁ§∫
                if (isUserRecall) {
                    const hiddenMessageForAI = {
                        role: 'system',
                        content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Êí§Âõû‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ‰Ω†‰∏çÁü•ÈÅìÂÜÖÂÆπÊòØ‰ªÄ‰πàÔºåÂè™ÈúÄÁü•ÈÅìËøô‰∏™‰∫ã‰ª∂Âç≥ÂèØ„ÄÇ]`,
                        timestamp: Date.now(),
                        isHidden: true
                    };
                    chat.history.push(hiddenMessageForAI);
                }

                // 3. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÂπ∂Âà∑Êñ∞UI
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
                if (isUserRecall) renderChatList(); // Áî®Êà∑Êí§ÂõûÊó∂ÔºåÊúÄÂêé‰∏ÄÊù°Ê∂àÊÅØÂèò‰∫ÜÔºåÈúÄË¶ÅÂà∑Êñ∞ÂàóË°®
            }



            /**
             * „ÄêÂÖ®Êñ∞„ÄëÂèñÊ∂àÂºïÁî®Ê®°Âºè
             */
            function cancelReplyMode() {
                currentReplyContext = null;
                document.getElementById('reply-preview-bar').style.display = 'none';
            }

            // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂ∏¶Ê†ºÂºèÂä©ÊâãÁöÑÁªàÊûÅÁâà„ÄëÊõøÊç¢ÊóßÁöÑ openMessageEditor ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            async function openMessageEditor() {
                if (!activeMessageTimestamp) return;

                const timestampToEdit = activeMessageTimestamp;
                const chat = state.chats[state.activeChatId];
                const message = chat.history.find(m => m.timestamp === timestampToEdit);
                if (!message) return;

                hideMessageActions();

                let contentForEditing;
                const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer'].includes(message.type);

                if (isSpecialType) {
                    let fullMessageObject = { type: message.type };
                    if (message.type === 'voice_message') fullMessageObject.content = message.content;
                    else if (message.type === 'ai_image') {
                        fullMessageObject.description = message.content;
                        // Always show imageUrl field, use existing or default
                        fullMessageObject.imageUrl = message.imageUrl || "https://files.catbox.moe/cww7rw.jpg";
                    }
                    else if (message.type === 'transfer') {
                        fullMessageObject.amount = message.amount;
                        fullMessageObject.note = message.note;
                    }
                    contentForEditing = JSON.stringify(fullMessageObject, null, 2);
                } else if (typeof message.content === 'object') {
                    contentForEditing = JSON.stringify(message.content, null, 2);
                } else {
                    contentForEditing = message.content;
                }

                // --- „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåÊûÑÂª∫‚ÄúÊ†ºÂºèÂä©Êâã‚ÄùÊåâÈíÆÁöÑHTML ---
                const templates = {
                    voice: { type: 'voice_message', content: 'Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ' },
                    image: { type: 'ai_image', description: 'Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞', imageUrl: 'https://example.com/your-image.jpg' },
                    transfer: { type: 'transfer', amount: 5.20, note: '‰∏ÄÁÇπÂøÉÊÑè' }
                };

                // ‰ΩøÁî® data-template Â±ûÊÄßÂ≠òÂÇ®JSONÊ®°ÊùøÂ≠óÁ¨¶‰∏≤ÔºåÊ≥®ÊÑèË¶ÅÁî®ÂçïÂºïÂè∑ÂåÖË£π
                const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ËØ≠Èü≥</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâá</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ËΩ¨Ë¥¶</button>
        </div>
    `;
                // --- „ÄêÊ†∏ÂøÉ‰øÆÊîπÁªìÊùü„Äë---

                const newContent = await showCustomPrompt(
                    'ÁºñËæëÊ∂àÊÅØ',
                    'Âú®Ê≠§‰øÆÊîπÔºåÊàñÁÇπÂáª‰∏äÊñπÊåâÈíÆ‰ΩøÁî®Ê†ºÂºèÊ®°Êùø...', // ‰øÆÊîπÊèêÁ§∫ËØ≠
                    contentForEditing,
                    'textarea',
                    helpersHtml // Â∞ÜÊåâÈíÆÁöÑHTML‰Ωú‰∏∫Á¨¨5‰∏™ÂèÇÊï∞‰º†ÂÖ•
                );

                if (newContent !== null) {
                    await saveEditedMessage(timestampToEdit, newContent);
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤


            // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂèØËßÜÂåñÂ§öÊ∂àÊÅØÁºñËæëÂô®È©±Âä®ÂáΩÊï∞ ‚ñº‚ñº‚ñº

            /**
             * ÂàõÂª∫‰∏Ä‰∏™ÂèØÁºñËæëÁöÑÊ∂àÊÅØÂùóÔºàÂåÖÂê´ÊñáÊú¨Ê°Ü„ÄÅÊ†ºÂºèÂä©ÊâãÂíåÂà†Èô§ÊåâÈíÆÔºâ
             * @param {string} initialContent - ÊñáÊú¨Ê°ÜÁöÑÂàùÂßãÂÜÖÂÆπ
             * @returns {HTMLElement} - ÂàõÂª∫Â•ΩÁöÑDOMÂÖÉÁ¥†
             */
            function createMessageEditorBlock(initialContent = '') {
                const block = document.createElement('div');
                block.className = 'message-editor-block';

                const templates = {
                    voice: { type: 'voice_message', content: 'Âú®ËøôÈáåËæìÂÖ•ËØ≠Èü≥ÂÜÖÂÆπ' },
                    image: { type: 'ai_image', description: 'Âú®ËøôÈáåËæìÂÖ•ÂõæÁâáÊèèËø∞', imageUrl: 'https://example.com/your-image.jpg' },
                    transfer: { type: 'transfer', amount: 5.20, note: '‰∏ÄÁÇπÂøÉÊÑè' }
                };

                block.innerHTML = `
        <button class="delete-block-btn" title="Âà†Èô§Ê≠§Êù°">√ó</button>
        <textarea>${initialContent}</textarea>
        <div class="format-helpers">
            <button class="format-btn" data-template='${JSON.stringify(templates.voice)}'>ËØ≠Èü≥</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâá</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.transfer)}'>ËΩ¨Ë¥¶</button>
        </div>
    `;

                // ÁªëÂÆöÂà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
                block.querySelector('.delete-block-btn').addEventListener('click', () => {
                    // Á°Æ‰øùËá≥Â∞ë‰øùÁïô‰∏Ä‰∏™ÁºñËæëÂùó
                    if (document.querySelectorAll('.message-editor-block').length > 1) {
                        block.remove();
                    } else {
                        alert('Ëá≥Â∞ëÈúÄË¶Å‰øùÁïô‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ');
                    }
                });

                // ÁªëÂÆöÊ†ºÂºèÂä©ÊâãÊåâÈíÆ‰∫ã‰ª∂
                block.querySelectorAll('.format-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const templateStr = btn.dataset.template;
                        const textarea = block.querySelector('textarea');
                        if (templateStr && textarea) {
                            try {
                                const templateObj = JSON.parse(templateStr);
                                textarea.value = JSON.stringify(templateObj, null, 2);
                                textarea.focus();
                            } catch (e) { console.error("Ëß£ÊûêÊ†ºÂºèÊ®°ÊùøÂ§±Ë¥•:", e); }
                        }
                    });
                });

                return block;
            }

            // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞ÂçáÁ∫ßÁâà„ÄëËØ∑Áî®Ê≠§ÂáΩÊï∞ÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ openAdvancedMessageEditor ‚ñº‚ñº‚ñº
            /**
             * ÊâìÂºÄÂÖ®Êñ∞ÁöÑ„ÄÅÂèØËßÜÂåñÁöÑÂ§öÊ∂àÊÅØÁºñËæëÂô®ÔºåÂπ∂Âä®ÊÄÅÁªëÂÆöÂÖ∂ÊâÄÊúâÊåâÈíÆ‰∫ã‰ª∂
             */
            function openAdvancedMessageEditor() {
                if (!activeMessageTimestamp) return;

                // 1. „ÄêÊ†∏ÂøÉ„ÄëÂú®ÂÖ≥Èó≠ÊóßËèúÂçïÂâçÔºåÂ∞ÜÈúÄË¶ÅÁöÑÊó∂Èó¥Êà≥ÊçïËé∑Âà∞Â±ÄÈÉ®ÂèòÈáè‰∏≠
                const timestampToEdit = activeMessageTimestamp;

                const chat = state.chats[state.activeChatId];
                const message = chat.history.find(m => m.timestamp === timestampToEdit);
                if (!message) return;

                // 2. Áé∞Âú®ÂèØ‰ª•ÂÆâÂÖ®Âú∞ÂÖ≥Èó≠ÊóßËèúÂçï‰∫ÜÔºåÂõ†‰∏∫ÂÆÉ‰∏ç‰ºöÂΩ±ÂìçÊàë‰ª¨ÁöÑÂ±ÄÈÉ®ÂèòÈáè
                hideMessageActions();

                const editorModal = document.getElementById('message-editor-modal');
                const editorContainer = document.getElementById('message-editor-container');
                editorContainer.innerHTML = '';

                // 3. ÂáÜÂ§áÂàùÂßãÂÜÖÂÆπ
                let initialContent;
                const isSpecialType = message.type && ['voice_message', 'ai_image', 'transfer'].includes(message.type);
                if (isSpecialType) {
                    let fullMessageObject = { type: message.type };
                    if (message.type === 'voice_message') fullMessageObject.content = message.content;
                    else if (message.type === 'ai_image') {
                        fullMessageObject.description = message.content;
                        // Always show imageUrl field, use existing or default
                        fullMessageObject.imageUrl = message.imageUrl || "https://files.catbox.moe/cww7rw.jpg";
                    }
                    else if (message.type === 'transfer') {
                        fullMessageObject.amount = message.amount;
                        fullMessageObject.note = message.note;
                    }
                    initialContent = JSON.stringify(fullMessageObject, null, 2);
                } else if (typeof message.content === 'object') {
                    initialContent = JSON.stringify(message.content, null, 2);
                } else {
                    initialContent = message.content;
                }

                const firstBlock = createMessageEditorBlock(initialContent);
                editorContainer.appendChild(firstBlock);

                // 4. „ÄêÊ†∏ÂøÉ„ÄëÂä®ÊÄÅÁªëÂÆöÊâÄÊúâÊéßÂà∂ÊåâÈíÆÁöÑ‰∫ã‰ª∂
                // ‰∏∫‰∫ÜÈò≤Ê≠¢‰∫ã‰ª∂ÈáçÂ§çÁªëÂÆöÔºåÊàë‰ª¨‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÁöÑÊñπÊ≥ïÊù•Ê∏ÖÈô§ÊóßÁõëÂê¨Âô®
                const addBtn = document.getElementById('add-message-editor-block-btn');
                const newAddBtn = addBtn.cloneNode(true);
                addBtn.parentNode.replaceChild(newAddBtn, addBtn);
                newAddBtn.addEventListener('click', () => {
                    const newBlock = createMessageEditorBlock();
                    editorContainer.appendChild(newBlock);
                    newBlock.querySelector('textarea').focus();
                });

                const cancelBtn = document.getElementById('cancel-advanced-editor-btn');
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                newCancelBtn.addEventListener('click', () => {
                    editorModal.classList.remove('visible');
                });

                const saveBtn = document.getElementById('save-advanced-editor-btn');
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                // Â∞ÜÊçïËé∑Âà∞ÁöÑÊó∂Èó¥Êà≥ÔºåÁõ¥Êé•ÁªëÂÆöÁªôËøô‰∏ÄÊ¨°ÁöÑ‰øùÂ≠òÁÇπÂáª‰∫ã‰ª∂
                newSaveBtn.addEventListener('click', () => {
                    saveEditedMessage(timestampToEdit);
                });

                // 5. ÊúÄÂêéÔºåÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                editorModal.classList.add('visible');
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            /**
             * Ëß£ÊûêÁºñËæëÂêéÁöÑÊñáÊú¨ÔºåÂπ∂ËøîÂõû‰∏Ä‰∏™Ê†áÂáÜÂåñÁöÑÊ∂àÊÅØÁâáÊÆµÂØπË±°
             * @param {string} text - Áî®Êà∑Âú®ÁºñËæëÊ°Ü‰∏≠ËæìÂÖ•ÁöÑÊñáÊú¨
             * @returns {object} - ‰∏Ä‰∏™ÂåÖÂê´ type, content, Á≠âÂ±ûÊÄßÁöÑÂØπË±°
             */
            function parseEditedContent(text) {
                const trimmedText = text.trim();

                // 1. Â∞ùËØïËß£Êûê‰∏∫JSONÂØπË±°ÔºàÁî®‰∫é‰øÆÂ§çËØ≠Èü≥„ÄÅËΩ¨Ë¥¶Á≠âÊ†ºÂºèÔºâ
                if (trimmedText.startsWith('{') && trimmedText.endsWith('}')) {
                    try {
                        const parsed = JSON.parse(trimmedText);
                        // ÂøÖÈ°ªÂåÖÂê´ type Â±ûÊÄßÊâçËÆ§‰∏∫ÊòØÊúâÊïàÊ†ºÂºè
                        if (parsed.type) {
                            return parsed;
                        }
                    } catch (e) { /* Ëß£ÊûêÂ§±Ë¥•ÔºåÁªßÁª≠ÂæÄ‰∏ãËµ∞ */ }
                }

                // 2. Â∞ùËØïËß£Êûê‰∏∫Ë°®ÊÉÖÂåÖ
                if (STICKER_REGEX.test(trimmedText)) {
                    // ÂØπ‰∫éÁºñËæëÁöÑË°®ÊÉÖÔºåÊàë‰ª¨ÊöÇÊó∂Êó†Ê≥ïÁü•ÈÅìÂÖ∂`meaning`ÔºåÊâÄ‰ª•Âè™Â≠òURL
                    return { type: 'sticker', content: trimmedText };
                }

                // 3. Âê¶ÂàôÔºåËßÜ‰∏∫ÊôÆÈÄöÊñáÊú¨Ê∂àÊÅØ
                return { type: 'text', content: trimmedText };
            }


            // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÊîØÊåÅÂèØËßÜÂåñÁºñËæë„ÄëÁöÑÂÖ®Êñ∞ÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ saveEditedMessage ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            /**
             * ‰ªéÂèØËßÜÂåñÁºñËæëÂô®Êî∂ÈõÜÊâÄÊúâÊ∂àÊÅØÔºåÊõ¥Êñ∞Êï∞ÊçÆÂ∫ìÂíåUI
             * @param {number} timestamp - Ë¶Å‰øÆÊîπÁöÑÂéüÂßãÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
             */
            async function saveEditedMessage(timestamp) {
                if (!timestamp) return;

                const chat = state.chats[state.activeChatId];
                const messageIndex = chat.history.findIndex(m => m.timestamp === timestamp);
                if (messageIndex === -1) return;

                const editorContainer = document.getElementById('message-editor-container');
                const editorBlocks = editorContainer.querySelectorAll('.message-editor-block');

                let newMessages = [];
                let baseTimestamp = timestamp; // ‰ΩøÁî®ÂéüÂßãÊó∂Èó¥Êà≥‰Ωú‰∏∫Âü∫ÂáÜ

                for (const block of editorBlocks) {
                    const textarea = block.querySelector('textarea');
                    const rawContent = textarea.value.trim();

                    if (!rawContent) continue; // Ë∑≥ËøáÁ©∫ÁöÑÁºñËæëÊ°Ü

                    const parsedResult = parseEditedContent(rawContent);

                    const newMessage = {
                        role: chat.history[messageIndex].role,
                        senderName: chat.history[messageIndex].senderName,
                        timestamp: baseTimestamp++, // ÈÄíÂ¢ûÊó∂Èó¥Êà≥‰øùËØÅÈ°∫Â∫èÂíåÂîØ‰∏ÄÊÄß
                        content: parsedResult.content || '',
                    };

                    if (parsedResult.type && parsedResult.type !== 'text') newMessage.type = parsedResult.type;
                    if (parsedResult.meaning) newMessage.meaning = parsedResult.meaning;
                    if (parsedResult.amount) newMessage.amount = parsedResult.amount;
                    if (parsedResult.note) newMessage.note = parsedResult.note;
                    if (parsedResult.description) newMessage.content = parsedResult.description;
                    if (parsedResult.imageUrl) newMessage.imageUrl = parsedResult.imageUrl;

                    newMessages.push(newMessage);
                }

                if (newMessages.length === 0) {
                    alert("‰∏çËÉΩ‰øùÂ≠òÁ©∫Ê∂àÊÅØÔºåËØ∑Ëá≥Â∞ëËæìÂÖ•‰∏ÄÊù°ÂÜÖÂÆπ„ÄÇ");
                    return;
                }

                // Âú®ÂéÜÂè≤ËÆ∞ÂΩïÁöÑÂéüÂßã‰ΩçÁΩÆÔºåÂà†Èô§1Êù°ÊóßÊ∂àÊÅØÔºåÂπ∂ÊèíÂÖ•ÊâÄÊúâÊñ∞Ê∂àÊÅØ
                chat.history.splice(messageIndex, 1, ...newMessages);

                // Â∞ÜÊúÄÁªàÁöÑ„ÄÅÊõ¥Êñ∞ÂêéÁöÑ history ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await db.chats.put(chat);

                // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÂπ∂Âà∑Êñ∞UI
                document.getElementById('message-editor-modal').classList.remove('visible');
                renderChatInterface(state.activeChatId);
                await showCustomAlert('ÊàêÂäü', 'Ê∂àÊÅØÂ∑≤Êõ¥Êñ∞ÔºÅ');
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô„Äê‰∏ÄÊï¥ÂùóÊñ∞ÂáΩÊï∞„ÄëÁ≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ÁöÑÊú´Â∞æ ‚ñº‚ñº‚ñº

            /**
             * ÂΩìÁÇπÂáª‚Äú‚Ä¶‚ÄùÊó∂ÔºåÊòæÁ§∫Âä®ÊÄÅÊìç‰ΩúËèúÂçï
             * @param {number} postId - Ë¢´Êìç‰ΩúÁöÑÂä®ÊÄÅÁöÑID
             */
            async function showPostActions(postId) {
                activePostId = postId;

                // Ëé∑ÂèñÂΩìÂâçÂä®ÊÄÅ‰ø°ÊÅØ‰ª•Á°ÆÂÆöÊòæÁ§∫ÁΩÆÈ°∂ËøòÊòØÂèñÊ∂àÁΩÆÈ°∂
                const post = await db.qzonePosts.get(postId);
                const pinBtn = document.getElementById('pin-post-btn');
                const unpinBtn = document.getElementById('unpin-post-btn');

                if (post && post.isPinned) {
                    pinBtn.style.display = 'none';
                    unpinBtn.style.display = 'block';
                } else {
                    pinBtn.style.display = 'block';
                    unpinBtn.style.display = 'none';
                }

                document.getElementById('post-actions-modal').classList.add('visible');
            }

            /**
             * ÈöêËóèÂä®ÊÄÅÊìç‰ΩúËèúÂçï
             */
            function hidePostActions() {
                document.getElementById('post-actions-modal').classList.remove('visible');
                activePostId = null;
            }

            /**
             * ÊâìÂºÄÂä®ÊÄÅÁºñËæëÂô®
             */
            async function openPostEditor() {
                if (!activePostId) return;

                const postIdToEdit = activePostId;
                const post = await db.qzonePosts.get(postIdToEdit);
                if (!post) return;

                hidePostActions();

                // Âø†‰∫éÂéüÊñáÔºöÊûÑÂª∫Âá∫ÊúÄÂéüÂßãÁöÑÊñáÊú¨ÂΩ¢ÊÄÅ‰æõÁºñËæë
                let contentForEditing;
                if (post.type === 'shuoshuo') {
                    contentForEditing = post.content;
                } else {
                    // ÂØπ‰∫éÂõæÁâáÂíåÊñáÂ≠óÂõæÔºåÊàë‰ª¨ÊûÑÂª∫‰∏Ä‰∏™ÂåÖÂê´ÊâÄÊúâ‰ø°ÊÅØÁöÑÂØπË±°
                    const postObject = {
                        type: post.type,
                        publicText: post.publicText || '',
                    };
                    if (post.type === 'image_post') {
                        postObject.imageUrl = post.imageUrl;
                        postObject.imageDescription = post.imageDescription;
                    } else if (post.type === 'text_image') {
                        postObject.hiddenContent = post.hiddenContent;
                        postObject.decorativeImageUrl = post.decorativeImageUrl || '';
                    }
                    contentForEditing = JSON.stringify(postObject, null, 2);
                }

                // ÊûÑÂª∫Ê†ºÂºèÂä©ÊâãÊåâÈíÆ
                const templates = {
                    shuoshuo: "Âú®ËøôÈáåËæìÂÖ•ËØ¥ËØ¥ÁöÑÂÜÖÂÆπ...", // ÂØπ‰∫éËØ¥ËØ¥ÔºåÊàë‰ª¨Áõ¥Êé•ÊõøÊç¢‰∏∫Á∫ØÊñáÊú¨
                    image: { type: 'image_post', publicText: '', imageUrl: 'https://...', imageDescription: '' },
                    text_image: { type: 'text_image', publicText: '', hiddenContent: '' }
                };

                const helpersHtml = `
        <div class="format-helpers">
            <button class="format-btn" data-type="text">ËØ¥ËØ¥</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.image)}'>ÂõæÁâáÂä®ÊÄÅ</button>
            <button class="format-btn" data-template='${JSON.stringify(templates.text_image)}'>ÊñáÂ≠óÂõæ</button>
        </div>
    `;

                const newContent = await showCustomPrompt(
                    'ÁºñËæëÂä®ÊÄÅ',
                    'Âú®Ê≠§‰øÆÊîπÂÜÖÂÆπ...',
                    contentForEditing,
                    'textarea',
                    helpersHtml
                );

                // „ÄêÁâπÊÆäÂ§ÑÁêÜ„Äë‰∏∫ËØ¥ËØ¥ÁöÑÊ†ºÂºèÂä©ÊâãÊåâÈíÆÊ∑ªÂä†‰∏çÂêåÁöÑË°å‰∏∫
                // Êàë‰ª¨ÈúÄË¶ÅÂú®Ê®°ÊÄÅÊ°ÜÂá∫Áé∞ÂêéÔºåÂÜçÁªôÂÆÉÁªëÂÆö‰∫ã‰ª∂
                setTimeout(() => {
                    const shuoshuoBtn = document.querySelector('#custom-modal-body .format-btn[data-type="text"]');
                    if (shuoshuoBtn) {
                        shuoshuoBtn.addEventListener('click', () => {
                            const input = document.getElementById('custom-prompt-input');
                            input.value = templates.shuoshuo;
                            input.focus();
                        });
                    }
                }, 100);

                if (newContent !== null) {
                    await saveEditedPost(postIdToEdit, newContent);
                }
            }

            /**
             * ‰øùÂ≠òÁºñËæëÂêéÁöÑÂä®ÊÄÅ
             * @param {number} postId - Ë¶Å‰øùÂ≠òÁöÑÂä®ÊÄÅID
             * @param {string} newRawContent - ‰ªéÁºñËæëÂô®Ëé∑ÂèñÁöÑÊñ∞ÂÜÖÂÆπ
             */
            async function saveEditedPost(postId, newRawContent) {
                const post = await db.qzonePosts.get(postId);
                if (!post) return;

                const trimmedContent = newRawContent.trim();

                // Â∞ùËØïËß£Êûê‰∏∫JSONÔºåÂ¶ÇÊûúÂ§±Ë¥•ÔºåÂàôËÆ§‰∏∫ÊòØÁ∫ØÊñáÊú¨ÔºàËØ¥ËØ¥Ôºâ
                try {
                    const parsed = JSON.parse(trimmedContent);
                    // Êõ¥Êñ∞Â∏ñÂ≠êÂ±ûÊÄß
                    post.type = parsed.type || 'image_post';
                    post.publicText = parsed.publicText || '';
                    post.imageUrl = parsed.imageUrl || '';
                    post.imageDescription = parsed.imageDescription || '';
                    post.hiddenContent = parsed.hiddenContent || '';
                    post.decorativeImageUrl = parsed.decorativeImageUrl || null; // IMPORTANT: Purely decorative, never sent to API
                    post.content = ''; // Ê∏ÖÁ©∫ÊóßÁöÑËØ¥ËØ¥ÂÜÖÂÆπÂ≠óÊÆµ
                } catch (e) {
                    // Ëß£ÊûêÂ§±Ë¥•ÔºåËÆ§‰∏∫ÊòØËØ¥ËØ¥
                    post.type = 'shuoshuo';
                    post.content = trimmedContent;
                    // Ê∏ÖÁ©∫ÂÖ∂‰ªñÁ±ªÂûãÁöÑÂ≠óÊÆµ
                    post.publicText = '';
                    post.imageUrl = '';
                    post.imageDescription = '';
                    post.hiddenContent = '';
                    post.decorativeImageUrl = null;
                }

                await db.qzonePosts.put(post);
                await renderQzonePosts(); // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
                await showCustomAlert('ÊàêÂäü', 'Âä®ÊÄÅÂ∑≤Êõ¥Êñ∞ÔºÅ');
            }

            /**
             * ÊòæÁ§∫ËØÑËÆ∫Êìç‰ΩúËèúÂçï
             */
            function showCommentActions(postId, commentTimestamp, commentText, commenterName) {
                activeCommentData = {
                    postId: postId,
                    timestamp: commentTimestamp,
                    text: commentText,
                    commenterName: commenterName
                };
                document.getElementById('comment-actions-modal').classList.add('visible');
            }

            /**
             * ÈöêËóèËØÑËÆ∫Êìç‰ΩúËèúÂçï
             */
            function hideCommentActions() {
                document.getElementById('comment-actions-modal').classList.remove('visible');
                activeCommentData = null;
            }

            /**
             * ÁºñËæëËØÑËÆ∫
             */
            async function editComment() {
                if (!activeCommentData) return;

                const newText = await showCustomPrompt('ÁºñËæëËØÑËÆ∫', 'ËØ∑ËæìÂÖ•Êñ∞ÁöÑËØÑËÆ∫ÂÜÖÂÆπ:', activeCommentData.text, 'textarea');
                if (newText === null || newText.trim() === '') return;

                try {
                    const post = await db.qzonePosts.get(activeCommentData.postId);
                    if (!post || !post.comments) return;

                    // ÊâæÂà∞Âπ∂Êõ¥Êñ∞ËØÑËÆ∫
                    const commentIndex = post.comments.findIndex(c => c.timestamp === activeCommentData.timestamp);
                    if (commentIndex !== -1) {
                        post.comments[commentIndex].text = newText.trim();
                        await db.qzonePosts.put(post);

                        // ÂÖ≥Èó≠Êìç‰ΩúËèúÂçï
                        hideCommentActions();

                        // Âà∑Êñ∞Âä®ÊÄÅÂàóË°®
                        if (document.getElementById('qzone-screen').classList.contains('active')) {
                            await renderQzonePosts();
                        }

                        await showCustomAlert('ÁºñËæëÊàêÂäü', 'ËØÑËÆ∫Â∑≤Êõ¥Êñ∞');
                    }
                } catch (error) {
                    console.error('ÁºñËæëËØÑËÆ∫Â§±Ë¥•:', error);
                    await showCustomAlert('ÁºñËæëÂ§±Ë¥•', 'ÁºñËæëËØÑËÆ∫Êó∂ÂèëÁîüÈîôËØØÔºåËØ∑ÈáçËØï');
                }
            }

            /**
             * Âà†Èô§ËØÑËÆ∫
             */
            async function deleteComment() {
                if (!activeCommentData) return;

                const confirmed = await showCustomConfirm(
                    'Âà†Èô§ËØÑËÆ∫',
                    'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËØÑËÆ∫ÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ',
                    { confirmButtonClass: 'btn-danger' }
                );

                if (!confirmed) return;

                try {
                    const post = await db.qzonePosts.get(activeCommentData.postId);
                    if (!post || !post.comments) return;

                    // Âà†Èô§ËØÑËÆ∫
                    post.comments = post.comments.filter(c => c.timestamp !== activeCommentData.timestamp);
                    await db.qzonePosts.put(post);

                    // ÂÖ≥Èó≠Êìç‰ΩúËèúÂçï
                    hideCommentActions();

                    // Âà∑Êñ∞Âä®ÊÄÅÂàóË°®
                    if (document.getElementById('qzone-screen').classList.contains('active')) {
                        await renderQzonePosts();
                    }

                    await showCustomAlert('Âà†Èô§ÊàêÂäü', 'ËØÑËÆ∫Â∑≤Âà†Èô§');

                } catch (error) {
                    console.error('Âà†Èô§ËØÑËÆ∫Â§±Ë¥•:', error);
                    await showCustomAlert('Âà†Èô§Â§±Ë¥•', 'Âà†Èô§ËØÑËÆ∫Êó∂ÂèëÁîüÈîôËØØÔºåËØ∑ÈáçËØï');
                }
            }

            // ‚ñº‚ñº‚ñº AIÂõûÂ§çÊ®°ÊÄÅÊ°ÜÁõ∏ÂÖ≥ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            let currentPostIdForAiReply = null;

            /**
             * ÊòæÁ§∫AIÂõûÂ§çÈÄâÊã©Ê®°ÊÄÅÊ°Ü
             */
            function showAiReplyModal(postId) {
                currentPostIdForAiReply = postId;

                // Ëé∑ÂèñÊâÄÊúâÂèØÁî®ÁöÑAI
                const availableAis = [];
                for (const chatId in state.chats) {
                    const chat = state.chats[chatId];
                    if (!chat.isGroup) {
                        const aiAvatar = chat.settings.aiAvatar || defaultAvatar;
                        availableAis.push({
                            id: chatId,
                            name: chat.name,
                            avatar: aiAvatar,
                            status: chat.relationship?.status || 'friend'
                        });
                    }
                }

                if (availableAis.length === 0) {
                    alert('Ê≤°ÊúâÂèØÁî®ÁöÑAIËßíËâ≤');
                    return;
                }

                // ÁîüÊàêAIÂàóË°®HTML
                const aiListHtml = availableAis.map(ai => `
        <div class="ai-selection-item" onclick="window.toggleAiSelection('${ai.id}')">
            <input type="checkbox" id="ai-${ai.id}" data-ai-id="${ai.id}">
            <img src="${ai.avatar}" class="ai-selection-avatar" alt="${ai.name}">
            <div class="ai-selection-info">
                <div class="ai-selection-name">${ai.name}</div>
                <div class="ai-selection-status">${ai.status === 'friend' ? 'Â•ΩÂèã' : ai.status}</div>
            </div>
        </div>
    `).join('');

                document.getElementById('ai-selection-list').innerHTML = aiListHtml;
                document.getElementById('ai-reply-modal').classList.add('visible');
            }

            /**
             * ÈöêËóèAIÂõûÂ§çÈÄâÊã©Ê®°ÊÄÅÊ°Ü
             */
            function hideAiReplyModal() {
                document.getElementById('ai-reply-modal').classList.remove('visible');
                currentPostIdForAiReply = null;
            }

            /**
             * ÂàáÊç¢AIÈÄâÊã©Áä∂ÊÄÅ
             */
            window.toggleAiSelection = function (aiId) {
                const checkbox = document.getElementById(`ai-${aiId}`);
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                }
            }

            /**
             * ÂÖ®ÈÄâAI
             */
            function selectAllAis() {
                const checkboxes = document.querySelectorAll('#ai-selection-list input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = true);
            }

            /**
             * ÂèñÊ∂àÂÖ®ÈÄâAI
             */
            function deselectAllAis() {
                const checkboxes = document.querySelectorAll('#ai-selection-list input[type="checkbox"]');
                checkboxes.forEach(cb => cb.checked = false);
            }

            /**
             * Á°ÆËÆ§AIÂõûÂ§ç
             */
            async function confirmAiReply() {
                if (!currentPostIdForAiReply) {
                    return;
                }

                // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑAI
                const selectedAis = [];
                const checkboxes = document.querySelectorAll('#ai-selection-list input[type="checkbox"]:checked');
                checkboxes.forEach(cb => {
                    selectedAis.push(cb.dataset.aiId);
                });

                if (selectedAis.length === 0) {
                    alert('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™AI');
                    return;
                }

                // ‰øùÂ≠òpostIdÂà∞Â±ÄÈÉ®ÂèòÈáèÔºåÈÅøÂÖçhideAiReplyModalÊ∏ÖÁ©∫ÂÆÉ
                const postIdToProcess = currentPostIdForAiReply;
                hideAiReplyModal();

                // ÊâæÂà∞ÂØπÂ∫îÁöÑÊú∫Âô®‰∫∫ÊåâÈíÆÂπ∂ÊîπÂèò‰∏∫Âä†ËΩΩÁä∂ÊÄÅ
                const postContainer = document.querySelector(`[data-post-id="${postIdToProcess}"]`);
                const aiReplyBtn = postContainer ? postContainer.querySelector('.call-ai-reply-btn') : null;

                if (aiReplyBtn) {
                    aiReplyBtn.innerHTML = '‚è≥';
                    aiReplyBtn.disabled = true;
                    aiReplyBtn.style.opacity = '0.6';
                }

                // ‰∏∫ÊØè‰∏™ÈÄâ‰∏≠ÁöÑAIËß¶ÂèëÂõûÂ§ç
                let completedCount = 0;
                let successCount = 0;
                for (const aiId of selectedAis) {
                    try {
                        const success = await triggerAiPostReply(aiId, postIdToProcess);
                        completedCount++;
                        if (success !== false) {
                            successCount++;
                        }
                    } catch (error) {
                        completedCount++;
                    }
                }

                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                if (aiReplyBtn) {
                    aiReplyBtn.innerHTML = 'ü§ñ';
                    aiReplyBtn.disabled = false;
                    aiReplyBtn.style.opacity = '1';
                }

                // Âà∑Êñ∞Âä®ÊÄÅÂàóË°®
                try {
                    await renderQzonePosts();
                } catch (error) {
                    // ÈùôÈªòÂ§ÑÁêÜÈîôËØØ
                }

                // ÊòæÁ§∫ÂÆåÊàêÈÄöÁü•
                const completionMsg = document.createElement('div');
                const bgColor = successCount === selectedAis.length ? 'rgba(0,128,0,0.9)' : 'rgba(255,165,0,0.9)';
                completionMsg.style.cssText = `position: fixed; top: 20px; right: 20px; background: ${bgColor}; color: white; padding: 15px 20px; border-radius: 10px; z-index: 9999; font-size: 14px;`;
                completionMsg.innerHTML = `‚úÖ AIÂõûÂ§çÂÆåÊàê<br>ÊàêÂäü: ${successCount}/${selectedAis.length}`;
                document.body.appendChild(completionMsg);

                // 3ÁßíÂêéËá™Âä®ÁßªÈô§ÈÄöÁü•
                setTimeout(() => {
                    if (completionMsg.parentNode) {
                        document.body.removeChild(completionMsg);
                    }
                }, 3000);
            }

            /**
             * Ëß¶ÂèëAIÂØπÁâπÂÆöÂä®ÊÄÅÁöÑÂõûÂ§ç - Âü∫‰∫étriggerInactiveAiAction‰ΩÜÈíàÂØπÁâπÂÆöÂä®ÊÄÅ
             */
            async function triggerAiPostReply(chatId, postId) {
                const chat = state.chats[chatId];
                if (!chat) return false;

                const { proxyUrl, apiKey, model } = state.apiConfig;
                if (!proxyUrl || !apiKey || !model) return false;

                // Ëé∑ÂèñÂä®ÊÄÅ‰ø°ÊÅØ
                const post = await db.qzonePosts.get(postId);
                if (!post) return false;

                const now = new Date();
                const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true });
                const userNickname = state.qzoneSettings.nickname;

                // ÊûÑÂª∫Âä®ÊÄÅ‰∏ä‰∏ãÊñá
                let postContent = '';
                if (post.type === 'shuoshuo') {
                    postContent = post.content || '';
                } else if (post.type === 'image_post') {
                    postContent = (post.publicText || '') + (post.imageDescription ? ` [ÂõæÁâáÊèèËø∞: ${post.imageDescription}]` : '');
                } else if (post.type === 'text_image') {
                    postContent = (post.publicText || '') + (post.hiddenContent ? ` [ÂõæÁâáÊèèËø∞: ${post.hiddenContent}]` : '');
                }

                // ÊûÑÂª∫ËØÑËÆ∫‰∏ä‰∏ãÊñá
                let commentsContext = '';
                if (post.comments && post.comments.length > 0) {
                    commentsContext = '\nÁé∞ÊúâËØÑËÆ∫:\n' + post.comments.map(c => `${c.commenterName}: ${c.text}`).join('\n');
                }

                // Ëé∑Âèñ‰∏ñÁïå‰π¶‰∏ä‰∏ãÊñá
                let worldBookContextForAction = '';
                const coreWorldBookName = "maininfo";
                const coreWorldBook = state.worldBooks.find(wb => wb.name === coreWorldBookName);
                if (coreWorldBook && coreWorldBook.content) {
                    worldBookContextForAction = `\n\n# Ê†∏ÂøÉÁ§æ‰∫§ÂÖ≥Á≥ªËÆæÂÆö (‰Ω†ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${coreWorldBook.content}\n`;
                }

                // ÊûÑÂª∫Á≥ªÁªüÊèêÁ§∫
                const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${chat.name}"ÁöÑËßíËâ≤„ÄÇÁî®Êà∑Â∏åÊúõ‰Ω†ÂØπ‰∏ÄÊù°ÁâπÂÆöÁöÑÂä®ÊÄÅËøõË°åÂõûÂ§ç„ÄÇ

# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.aiPersona}

# Âä®ÊÄÅ‰ø°ÊÅØ
- Âä®ÊÄÅID: ${postId}
- Âä®ÊÄÅÂÜÖÂÆπ: "${postContent}"
- ÂèëÂ∏ÉËÄÖ: ${post.authorId === 'user' ? userNickname : (state.chats[post.authorId]?.name || 'Êú™Áü•')}
${commentsContext}

# ‰Ω†ÁöÑÂèØÈÄâË°åÂä® (ËØ∑Ê†πÊçÆ‰Ω†ÁöÑÊÄßÊ†º„ÄêÈÄâÊã©‰∏ÄÈ°π„ÄëÊâßË°å):
1. **ËØÑËÆ∫Âä®ÊÄÅ**: ‰ΩøÁî® \`{"type": "qzone_comment", "postId": ${postId}, "commentText": "‰Ω†ÁöÑËØÑËÆ∫ÂÜÖÂÆπ"}\`
2. **ÁÇπËµûÂä®ÊÄÅ**: ‰ΩøÁî® \`{"type": "qzone_like", "postId": ${postId}}\`
3. **Êó¢ËØÑËÆ∫ÂèàÁÇπËµû**: ËøîÂõûÂåÖÂê´‰∏§‰∏™Êìç‰ΩúÁöÑJSONÊï∞ÁªÑ

ËØ∑Ê†πÊçÆ‰Ω†ÁöÑÊÄßÊ†ºÁâπÁÇπÂíåÂØπËøôÊù°Âä®ÊÄÅÁöÑÁúãÊ≥ïÔºåÈÄâÊã©ÂêàÈÄÇÁöÑÂõûÂ∫îÊñπÂºè„ÄÇ

${worldBookContextForAction}

Áé∞Âú®ÊòØ ${currentTime}ÔºåËØ∑ÂÅöÂá∫‰Ω†ÁöÑÂõûÂ∫î„ÄÇ`;

                try {
                    const data = await makeAPIRequest(proxyUrl, apiKey, model, [{ role: 'user', content: systemPrompt }], 0.8);

                    if (!data.choices || data.choices.length === 0 || !data.choices[0].message.content) {
                        return false;
                    }

                    const aiResponse = data.choices[0].message.content.trim();

                    // Ëß£ÊûêAIÂõûÂ§ç
                    let actions = [];
                    try {
                        // Ê∏ÖÁêÜAIÂõûÂ§çÔºåÁßªÈô§markdown‰ª£Á†ÅÂùóÊ†áËÆ∞
                        let cleanedResponse = aiResponse.trim();
                        if (cleanedResponse.startsWith('```json')) {
                            cleanedResponse = cleanedResponse.replace(/^```json\s*/, '').replace(/```\s*$/, '');
                        } else if (cleanedResponse.startsWith('```')) {
                            cleanedResponse = cleanedResponse.replace(/^```\s*/, '').replace(/```\s*$/, '');
                        }

                        const parsed = JSON.parse(cleanedResponse);
                        actions = Array.isArray(parsed) ? parsed : [parsed];
                    } catch (e) {
                        return false;
                    }

                    // Â§ÑÁêÜAIÁöÑË°åÂä®
                    for (const action of actions) {
                        if (action.type === 'qzone_comment') {
                            const postToComment = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToComment) {
                                if (!postToComment.comments) postToComment.comments = [];
                                const newComment = {
                                    commenterName: chat.name,
                                    text: action.commentText,
                                    timestamp: Date.now()
                                };
                                postToComment.comments.push(newComment);
                                await db.qzonePosts.update(postToComment.id, { comments: postToComment.comments });
                            }
                        } else if (action.type === 'qzone_like') {
                            const postToLike = await db.qzonePosts.get(parseInt(action.postId));
                            if (postToLike) {
                                if (!postToLike.likes) postToLike.likes = [];
                                if (!postToLike.likes.includes(chat.name)) {
                                    postToLike.likes.push(chat.name);
                                    await db.qzonePosts.update(postToLike.id, { likes: postToLike.likes });
                                }
                            }
                        }
                    }

                    return true;

                } catch (error) {
                    return false;
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ AIÂõûÂ§çÊ®°ÊÄÅÊ°ÜÁõ∏ÂÖ≥ÂáΩÊï∞ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº AIÂèëÂä®ÊÄÅÊ®°ÊÄÅÊ°ÜÁõ∏ÂÖ≥ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            let selectedAiForPost = null;

            /**
             * ÊòæÁ§∫AIÂèëÂä®ÊÄÅÈÄâÊã©Ê®°ÊÄÅÊ°Ü
             */
            function showAiPostModal() {
                // Ëé∑ÂèñÊâÄÊúâÂèØÁî®ÁöÑAI
                const availableAis = [];
                for (const chatId in state.chats) {
                    const chat = state.chats[chatId];
                    if (!chat.isGroup) {
                        const aiAvatar = chat.settings.aiAvatar || defaultAvatar;
                        availableAis.push({
                            id: chatId,
                            name: chat.name,
                            avatar: aiAvatar,
                            status: chat.relationship?.status || 'friend'
                        });
                    }
                }

                if (availableAis.length === 0) {
                    alert('Ê≤°ÊúâÂèØÁî®ÁöÑAIËßíËâ≤');
                    return;
                }

                // ÁîüÊàêAIÂàóË°®HTML (ÂçïÈÄâ)
                const aiListHtml = availableAis.map(ai => `
        <div class="ai-selection-item" onclick="selectAiForPost('${ai.id}')">
            <input type="radio" name="ai-post-selection" id="ai-post-${ai.id}" data-ai-id="${ai.id}">
            <img src="${ai.avatar}" class="ai-selection-avatar" alt="${ai.name}">
            <div class="ai-selection-info">
                <div class="ai-selection-name">${ai.name}</div>
                <div class="ai-selection-status">${ai.status === 'friend' ? 'Â•ΩÂèã' : ai.status}</div>
            </div>
        </div>
    `).join('');

                document.getElementById('ai-post-selection-list').innerHTML = aiListHtml;
                document.getElementById('ai-post-modal').classList.add('visible');
            }

            /**
             * ÈöêËóèAIÂèëÂä®ÊÄÅÈÄâÊã©Ê®°ÊÄÅÊ°Ü
             */
            function hideAiPostModal() {
                document.getElementById('ai-post-modal').classList.remove('visible');
                selectedAiForPost = null;
            }

            /**
             * ÈÄâÊã©AIÂèëÂä®ÊÄÅ
             */
            window.selectAiForPost = function (aiId) {
                selectedAiForPost = aiId;
                const radio = document.getElementById(`ai-post-${aiId}`);
                if (radio) {
                    radio.checked = true;
                }
            }

            /**
             * Á°ÆËÆ§AIÂèëÂä®ÊÄÅ
             */
            async function confirmAiPost() {
                // Check for selected radio button instead of relying on variable
                const selectedRadio = document.querySelector('input[name="ai-post-selection"]:checked');
                if (!selectedRadio) {
                    alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™AI');
                    return;
                }

                const selectedAiId = selectedRadio.dataset.aiId;

                hideAiPostModal();

                // ÊòæÁ§∫Â§ÑÁêÜ‰∏≠ÊèêÁ§∫
                const processingMsg = document.createElement('div');
                processingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; z-index: 9999; text-align: center;';
                processingMsg.innerHTML = `<div>ü§ñ AIÊ≠£Âú®ÊÄùËÄÉÂèë‰ªÄ‰πàÂä®ÊÄÅ...</div>`;
                document.body.appendChild(processingMsg);

                try {
                    // Define currentTimeString in the global scope to fix the reference error
                    const now = new Date();
                    window.currentTimeString = now.toLocaleString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });

                    // ‰ΩøÁî®‰øÆÊîπÂêéÁöÑtriggerInactiveAiActionÔºåÂº∫Âà∂ÊøÄÊ¥ªÂíåÂº∫Âà∂ÂèëÂä®ÊÄÅ
                    const success = await triggerInactiveAiAction(selectedAiId, true, true);

                    // ÁßªÈô§Â§ÑÁêÜ‰∏≠ÊèêÁ§∫
                    if (processingMsg.parentNode) {
                        document.body.removeChild(processingMsg);
                    }

                    // ÊòæÁ§∫ÂÆåÊàêÈÄöÁü•
                    const completionMsg = document.createElement('div');
                    const bgColor = success === true ? 'rgba(0,128,0,0.9)' : 'rgba(255,165,0,0.9)';
                    completionMsg.style.cssText = `position: fixed; top: 20px; right: 20px; background: ${bgColor}; color: white; padding: 15px 20px; border-radius: 10px; z-index: 9999; font-size: 14px;`;
                    completionMsg.innerHTML = success === true ? '‚úÖ AIÂèëÂä®ÊÄÅÂÆåÊàê' : '‚ö†Ô∏è AIÂèëÂä®ÊÄÅÂ§±Ë¥•';
                    document.body.appendChild(completionMsg);

                    // 3ÁßíÂêéËá™Âä®ÁßªÈô§ÈÄöÁü•
                    setTimeout(() => {
                        if (completionMsg.parentNode) {
                            document.body.removeChild(completionMsg);
                        }
                    }, 3000);

                    // Âà∑Êñ∞Âä®ÊÄÅÂàóË°®
                    if (document.getElementById('qzone-screen').classList.contains('active')) {
                        await renderQzonePosts();
                    }

                } catch (error) {
                    // ÁßªÈô§Â§ÑÁêÜ‰∏≠ÊèêÁ§∫
                    if (processingMsg.parentNode) {
                        document.body.removeChild(processingMsg);
                    }
                    alert('AIÂèëÂä®ÊÄÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ AIÂèëÂä®ÊÄÅÊ®°ÊÄÅÊ°ÜÁõ∏ÂÖ≥ÂáΩÊï∞ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            /**
             * ÁΩÆÈ°∂Âä®ÊÄÅ
             */
            async function pinPost() {
                if (!activePostId) return;

                const post = await db.qzonePosts.get(activePostId);
                if (!post) return;

                try {
                    // Êõ¥Êñ∞Âä®ÊÄÅÁöÑÁΩÆÈ°∂Áä∂ÊÄÅ
                    await db.qzonePosts.update(activePostId, { isPinned: true });

                    // ÂÖ≥Èó≠Êìç‰ΩúËèúÂçï
                    hidePostActions();

                    // Âà∑Êñ∞Âä®ÊÄÅÂàóË°®
                    if (document.getElementById('qzone-screen').classList.contains('active')) {
                        await renderQzonePosts();
                    }

                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    await showCustomAlert('ÁΩÆÈ°∂ÊàêÂäü', 'Âä®ÊÄÅÂ∑≤ÁΩÆÈ°∂');

                } catch (error) {
                    console.error('ÁΩÆÈ°∂Âä®ÊÄÅÂ§±Ë¥•:', error);
                    await showCustomAlert('ÁΩÆÈ°∂Â§±Ë¥•', 'ÁΩÆÈ°∂Âä®ÊÄÅÊó∂ÂèëÁîüÈîôËØØÔºåËØ∑ÈáçËØï');
                }
            }

            /**
             * ÂèñÊ∂àÁΩÆÈ°∂Âä®ÊÄÅ
             */
            async function unpinPost() {
                if (!activePostId) return;

                const post = await db.qzonePosts.get(activePostId);
                if (!post) return;

                try {
                    // Êõ¥Êñ∞Âä®ÊÄÅÁöÑÁΩÆÈ°∂Áä∂ÊÄÅ
                    await db.qzonePosts.update(activePostId, { isPinned: false });

                    // ÂÖ≥Èó≠Êìç‰ΩúËèúÂçï
                    hidePostActions();

                    // Âà∑Êñ∞Âä®ÊÄÅÂàóË°®
                    if (document.getElementById('qzone-screen').classList.contains('active')) {
                        await renderQzonePosts();
                    }

                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    await showCustomAlert('ÂèñÊ∂àÁΩÆÈ°∂ÊàêÂäü', 'Âä®ÊÄÅÂ∑≤ÂèñÊ∂àÁΩÆÈ°∂');

                } catch (error) {
                    console.error('ÂèñÊ∂àÁΩÆÈ°∂Âä®ÊÄÅÂ§±Ë¥•:', error);
                    await showCustomAlert('ÂèñÊ∂àÁΩÆÈ°∂Â§±Ë¥•', 'ÂèñÊ∂àÁΩÆÈ°∂Âä®ÊÄÅÊó∂ÂèëÁîüÈîôËØØÔºåËØ∑ÈáçËØï');
                }
            }

            /**
             * Âà†Èô§Âä®ÊÄÅ
             */
            async function deletePost() {
                if (!activePostId) return;

                const post = await db.qzonePosts.get(activePostId);
                if (!post) return;

                // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
                const confirmed = await showCustomConfirm(
                    'Âà†Èô§Âä®ÊÄÅ',
                    'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°Âä®ÊÄÅÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ',
                    { confirmButtonClass: 'btn-danger' }
                );

                if (!confirmed) return;

                try {
                    // ‰ªéÊï∞ÊçÆÂ∫ì‰∏≠Âà†Èô§Âä®ÊÄÅ
                    await db.qzonePosts.delete(activePostId);

                    // Âà†Èô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÂºïÁî®Ê≠§Âä®ÊÄÅÁöÑÁ≥ªÁªüÊ∂àÊÅØ
                    const allChats = await db.chats.toArray();
                    for (const chat of allChats) {
                        const originalLength = chat.history.length;
                        chat.history = chat.history.filter(msg => {
                            // Âà†Èô§ÂºïÁî®Ê≠§Âä®ÊÄÅIDÁöÑÁ≥ªÁªüÊ∂àÊÅØ
                            if (msg.role === 'system' && msg.isHidden && msg.content.includes(`(ID: ${activePostId})`)) {
                                return false;
                            }
                            return true;
                        });

                        // Âè™ÊúâÂú®ÂéÜÂè≤ËÆ∞ÂΩïÂèëÁîüÂèòÂåñÊó∂ÊâçÊõ¥Êñ∞Êï∞ÊçÆÂ∫ì
                        if (chat.history.length !== originalLength) {
                            await db.chats.put(chat);
                            // Êõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÁöÑÁä∂ÊÄÅ
                            if (state.chats[chat.id]) {
                                state.chats[chat.id].history = chat.history;
                            }
                        }
                    }

                    // ÂÖ≥Èó≠Êìç‰ΩúËèúÂçï
                    hidePostActions();

                    // Âà∑Êñ∞Âä®ÊÄÅÂàóË°®
                    if (document.getElementById('qzone-screen').classList.contains('active')) {
                        await renderQzonePosts();
                    }

                    // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®Êü•ÁúãÊüê‰∏™ËÅäÂ§©ÁïåÈù¢ÔºåÂà∑Êñ∞ÂÆÉ
                    if (state.activeChatId && document.getElementById('chat-interface-screen').classList.contains('active')) {
                        renderChatInterface(state.activeChatId);
                    }

                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    await showCustomAlert('Âà†Èô§ÊàêÂäü', 'Âä®ÊÄÅÂ∑≤Âà†Èô§');

                } catch (error) {
                    console.error('Âà†Èô§Âä®ÊÄÅÂ§±Ë¥•:', error);
                    await showCustomAlert('Âà†Èô§Â§±Ë¥•', 'Âà†Èô§Âä®ÊÄÅÊó∂ÂèëÁîüÈîôËØØÔºåËØ∑ÈáçËØï');
                }
            }

            /**
             * Â§çÂà∂Âä®ÊÄÅÂÜÖÂÆπ
             */
            async function copyPostContent() {
                if (!activePostId) return;
                const post = await db.qzonePosts.get(activePostId);
                if (!post) return;

                let textToCopy = post.content || post.publicText || post.hiddenContent || post.imageDescription || "ÔºàÊó†ÊñáÂ≠óÂÜÖÂÆπÔºâ";

                try {
                    await navigator.clipboard.writeText(textToCopy);
                    await showCustomAlert('Â§çÂà∂ÊàêÂäü', 'Âä®ÊÄÅÂÜÖÂÆπÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø„ÄÇ');
                } catch (err) {
                    await showCustomAlert('Â§çÂà∂Â§±Ë¥•', 'Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø„ÄÇ');
                }

                hidePostActions();
            }

            // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂàõÂª∫Áæ§ËÅä‰∏éÊãâ‰∫∫ÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº
            let selectedContacts = new Set();

            async function openContactPickerForGroupCreate() {
                selectedContacts.clear(); // Ê∏ÖÁ©∫‰∏äÊ¨°ÈÄâÊã©

                // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨‰∏∫‚ÄúÂÆåÊàê‚ÄùÊåâÈíÆÊòéÁ°ÆÁªëÂÆö‚ÄúÂàõÂª∫Áæ§ËÅä‚ÄùÁöÑÂäüËÉΩ
                const confirmBtn = document.getElementById('confirm-contact-picker-btn');
                // ‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÊäÄÂ∑ßÔºåÊ∏ÖÈô§Êéâ‰πãÂâçÂèØËÉΩÁªëÂÆöÁöÑ‰ªª‰ΩïÂÖ∂‰ªñ‰∫ã‰ª∂ÔºàÊØîÂ¶Ç‚ÄúÊ∑ªÂä†ÊàêÂëò‚ÄùÔºâ
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                // ÈáçÊñ∞ÁªëÂÆöÊ≠£Á°ÆÁöÑ‚ÄúÂàõÂª∫Áæ§ËÅä‚ÄùÂáΩÊï∞
                newConfirmBtn.addEventListener('click', handleCreateGroup);

                await renderContactPicker();
                showScreen('contact-picker-screen');
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            /**
             * Ê∏≤ÊüìËÅîÁ≥ª‰∫∫ÈÄâÊã©ÂàóË°®
             */
            async function renderContactPicker() {
                const listEl = document.getElementById('contact-picker-list');
                listEl.innerHTML = '';

                // Âè™ÈÄâÊã©ÂçïËÅäËßíËâ≤‰Ωú‰∏∫Áæ§ÊàêÂëòÂÄôÈÄâ
                const contacts = Object.values(state.chats).filter(chat => !chat.isGroup);

                if (contacts.length === 0) {
                    listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">ËøòÊ≤°ÊúâÂèØ‰ª•ÊãâËøõÁæ§ÁöÑËÅîÁ≥ª‰∫∫Âì¶~</p>';
                    return;
                }

                contacts.forEach(contact => {
                    const item = document.createElement('div');
                    item.className = 'contact-picker-item';
                    item.dataset.contactId = contact.id;
                    item.innerHTML = `
            <div class="checkbox"></div>
            <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
            <span class="name">${contact.name}</span>
        `;
                    listEl.appendChild(item);
                });

                updateContactPickerConfirmButton();
            }

            /**
             * Êõ¥Êñ∞‚ÄúÂÆåÊàê‚ÄùÊåâÈíÆÁöÑËÆ°Êï∞
             */
            function updateContactPickerConfirmButton() {
                const btn = document.getElementById('confirm-contact-picker-btn');
                btn.textContent = `ÂÆåÊàê(${selectedContacts.size})`;
                btn.disabled = selectedContacts.size < 2; // Ëá≥Â∞ëÈúÄË¶Å2‰∏™‰∫∫ÊâçËÉΩÂàõÂª∫Áæ§ËÅä
            }

            /**
             * Â§ÑÁêÜÂàõÂª∫Áæ§ËÅäÁöÑÊúÄÁªàÈÄªËæë
             */
            async function handleCreateGroup() {
                if (selectedContacts.size < 2) {
                    alert("ÂàõÂª∫Áæ§ËÅäËá≥Â∞ëÈúÄË¶ÅÈÄâÊã©2‰∏™ËÅîÁ≥ª‰∫∫„ÄÇ");
                    return;
                }

                const groupName = await showCustomPrompt('ËÆæÁΩÆÁæ§Âêç', 'ËØ∑ËæìÂÖ•Áæ§ËÅäÁöÑÂêçÂ≠ó', 'Êàë‰ª¨ÁöÑÁæ§ËÅä');
                if (!groupName || !groupName.trim()) return;

                const newChatId = 'group_' + Date.now();
                const members = [];

                // ÈÅçÂéÜÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫ID
                for (const contactId of selectedContacts) {
                    const contactChat = state.chats[contactId];
                    if (contactChat) {
                        // „ÄêÊ†∏ÂøÉ„Äë‰ªéÂçïËÅäËÆæÁΩÆ‰∏≠ÊèêÂèñÊï∞ÊçÆÔºåÂàõÂª∫Áæ§ÊàêÂëòÂØπË±°
                        members.push({
                            id: contactId, // ‰ΩøÁî®ÂçïËÅäÁöÑID‰Ωú‰∏∫ÊàêÂëòIDÔºåÊñπ‰æøÂÖ≥ËÅî
                            name: contactChat.name,
                            avatar: contactChat.settings.aiAvatar || defaultAvatar,
                            persona: contactChat.settings.aiPersona,
                            avatarFrame: contactChat.settings.aiAvatarFrame || ''
                        });
                    }
                }

                const newGroupChat = {
                    id: newChatId,
                    name: groupName.trim(),
                    isGroup: true,
                    members: members,
                    settings: {
                        myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ',
                        myNickname: 'Êàë',
                        maxMemory: 10,
                        groupAvatar: defaultGroupAvatar,
                        myAvatar: defaultMyGroupAvatar,
                        background: '',
                        theme: 'default',
                        fontSize: 13,
                        customCss: '',
                        linkedWorldBookIds: [],
                        aiAvatarFrame: '',
                        myAvatarFrame: '',
                        isBackgroundActivityEnabled: true // <--„ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÈªòËÆ§ÂºÄÂêØ
                    },
                    history: [],
                    musicData: { totalTime: 0 }
                };

                state.chats[newChatId] = newGroupChat;
                await db.chats.put(newGroupChat);

                await renderChatList();
                showScreen('chat-list-screen');
                openChat(newChatId); // ÂàõÂª∫ÂêéÁõ¥Êé•ÊâìÂºÄÁæ§ËÅä
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁæ§ÊàêÂëòÁÆ°ÁêÜÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº

            /**
             * ÊâìÂºÄÁæ§ÊàêÂëòÁÆ°ÁêÜÂ±èÂπï
             */
            function openMemberManagementScreen() {
                if (!state.activeChatId || !state.chats[state.activeChatId].isGroup) return;
                renderMemberManagementList();
                showScreen('member-management-screen');
            }

            /**
             * Ê∏≤ÊüìÁæ§ÊàêÂëòÁÆ°ÁêÜÂàóË°®
             */
            function renderMemberManagementList() {
                const listEl = document.getElementById('member-management-list');
                const chat = state.chats[state.activeChatId];
                listEl.innerHTML = '';

                chat.members.forEach(member => {
                    const item = document.createElement('div');
                    item.className = 'member-management-item';
                    item.innerHTML = `
            <img src="${member.avatar}" class="avatar">
            <span class="name">${member.name}</span>
            <button class="remove-member-btn" data-member-id="${member.id}" title="ÁßªÂá∫Áæ§ËÅä">-</button>
        `;
                    listEl.appendChild(item);
                });
            }

            /**
             * ‰ªéÁæ§ËÅä‰∏≠ÁßªÈô§‰∏Ä‰∏™ÊàêÂëò
             * @param {string} memberId - Ë¶ÅÁßªÈô§ÁöÑÊàêÂëòID
             */
            async function removeMemberFromGroup(memberId) {
                const chat = state.chats[state.activeChatId];
                const memberIndex = chat.members.findIndex(m => m.id === memberId);

                if (memberIndex === -1) return;

                // ÂÆâÂÖ®Ê£ÄÊü•ÔºåÁæ§ËÅäËá≥Â∞ë‰øùÁïô2‰∫∫
                if (chat.members.length <= 2) {
                    alert("Áæ§ËÅä‰∫∫Êï∞‰∏çËÉΩÂ∞ë‰∫é2‰∫∫„ÄÇ");
                    return;
                }

                const memberName = chat.members[memberIndex].name;
                const confirmed = await showCustomConfirm(
                    'ÁßªÂá∫ÊàêÂëò',
                    `Á°ÆÂÆöË¶ÅÂ∞Ü‚Äú${memberName}‚ÄùÁßªÂá∫Áæ§ËÅäÂêóÔºü`,
                    { confirmButtonClass: 'btn-danger' }
                );

                if (confirmed) {
                    chat.members.splice(memberIndex, 1);
                    await db.chats.put(chat);
                    renderMemberManagementList(); // Âà∑Êñ∞ÊàêÂëòÁÆ°ÁêÜÂàóË°®
                    document.getElementById('chat-settings-btn').click(); // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊ®°ÊãüÁÇπÂáªËÆæÁΩÆÊåâÈíÆÔºåÂº∫Âà∂Âà∑Êñ∞Êï¥‰∏™ÂºπÁ™ó
                }
            }

            /**
             * ÊâìÂºÄËÅîÁ≥ª‰∫∫ÈÄâÊã©Âô®ÔºåÁî®‰∫éÊãâ‰∫∫ÂÖ•Áæ§
             */
            async function openContactPickerForAddMember() {
                selectedContacts.clear(); // Ê∏ÖÁ©∫ÈÄâÊã©

                const chat = state.chats[state.activeChatId];
                const existingMemberIds = new Set(chat.members.map(m => m.id));

                // Ê∏≤ÊüìËÅîÁ≥ª‰∫∫ÂàóË°®ÔºåÂπ∂Ëá™Âä®ÊéíÈô§Â∑≤Âú®Áæ§ÂÜÖÁöÑÊàêÂëò
                const listEl = document.getElementById('contact-picker-list');
                listEl.innerHTML = '';
                const contacts = Object.values(state.chats).filter(c => !c.isGroup && !existingMemberIds.has(c.id));

                if (contacts.length === 0) {
                    listEl.innerHTML = '<p style="text-align:center; color:#8a8a8a; margin-top:50px;">Ê≤°ÊúâÊõ¥Â§öÂèØ‰ª•ÈÇÄËØ∑ÁöÑÂ•ΩÂèã‰∫Ü„ÄÇ</p>';
                    document.getElementById('confirm-contact-picker-btn').style.display = 'none'; // Ê≤°Êúâ‰∫∫ÂèØÈÄâÔºåÈöêËóèÂÆåÊàêÊåâÈíÆ
                } else {
                    document.getElementById('confirm-contact-picker-btn').style.display = 'block';
                    contacts.forEach(contact => {
                        const item = document.createElement('div');
                        item.className = 'contact-picker-item';
                        item.dataset.contactId = contact.id;
                        item.innerHTML = `
                <div class="checkbox"></div>
                <img src="${contact.settings.aiAvatar || defaultAvatar}" class="avatar">
                <span class="name">${contact.name}</span>
            `;
                        listEl.appendChild(item);
                    });
                }

                // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅÂπ∂ÊòæÁ§∫Â±èÂπï
                updateContactPickerConfirmButton();
                showScreen('contact-picker-screen');
            }

            /**
             * Â§ÑÁêÜÂ∞ÜÈÄâ‰∏≠ÁöÑËÅîÁ≥ª‰∫∫Âä†ÂÖ•Áæ§ËÅäÁöÑÈÄªËæë
             */
            async function handleAddMembersToGroup() {
                if (selectedContacts.size === 0) {
                    alert("ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Ë¶ÅÊ∑ªÂä†ÁöÑËÅîÁ≥ª‰∫∫„ÄÇ");
                    return;
                }

                const chat = state.chats[state.activeChatId];

                for (const contactId of selectedContacts) {
                    const contactChat = state.chats[contactId];
                    if (contactChat) {
                        chat.members.push({
                            id: contactId,
                            name: contactChat.name,
                            avatar: contactChat.settings.aiAvatar || defaultAvatar,
                            persona: contactChat.settings.aiPersona,
                            avatarFrame: contactChat.settings.aiAvatarFrame || ''
                        });
                    }
                }

                await db.chats.put(chat);
                openMemberManagementScreen(); // ËøîÂõûÂà∞Áæ§ÊàêÂëòÁÆ°ÁêÜÁïåÈù¢
                renderGroupMemberSettings(chat.members); // ÂêåÊó∂Êõ¥Êñ∞ËÅäÂ§©ËÆæÁΩÆÈáåÁöÑÂ§¥ÂÉè
            }

            // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÊúÄÁªà‰øÆÊ≠£Áâà„ÄëÊõøÊç¢ÊóßÁöÑ createNewMemberInGroup ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            async function createNewMemberInGroup() {
                const name = await showCustomPrompt('ÂàõÂª∫Êñ∞ÊàêÂëò', 'ËØ∑ËæìÂÖ•Êñ∞ÊàêÂëòÁöÑÂêçÂ≠ó');
                if (!name || !name.trim()) return;

                const persona = await showCustomPrompt('ËÆæÁΩÆ‰∫∫ËÆæ', `ËØ∑ËæìÂÖ•‚Äú${name}‚ÄùÁöÑ‰∫∫ËÆæ`, '', 'textarea');
                if (persona === null) return; // Áî®Êà∑ÁÇπ‰∫ÜÂèñÊ∂à

                const chat = state.chats[state.activeChatId];
                const newMember = {
                    id: 'npc_' + Date.now(),
                    name: name.trim(),
                    avatar: defaultGroupMemberAvatar,
                    persona: persona,
                    avatarFrame: ''
                };

                chat.members.push(newMember);
                await db.chats.put(chat);

                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨‰∏ç‰ªÖÂà∑Êñ∞ÂΩìÂâçÈ°µÈù¢ÁöÑÂàóË°®...
                renderMemberManagementList();
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„Äë...ËøòÊâãÂä®Âà∑Êñ∞ËÉåÂêé‚ÄúËÅäÂ§©ËÆæÁΩÆ‚ÄùÂºπÁ™óÈáåÁöÑÊàêÂëòÂ§¥ÂÉèÂàóË°®ÔºÅ
                renderGroupMemberSettings(chat.members);

                alert(`Êñ∞ÊàêÂëò‚Äú${name}‚ÄùÂ∑≤ÊàêÂäüÂä†ÂÖ•Áæ§ËÅäÔºÅ`);
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñÂçñËØ∑Ê±ÇÂÄíËÆ°Êó∂ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            function startWaimaiCountdown(element, endTime) {
                const timerId = setInterval(() => {
                    const now = Date.now();
                    const distance = endTime - now;

                    if (distance < 0) {
                        clearInterval(timerId);
                        element.innerHTML = '<span>Â∑≤</span><span>Ë∂Ö</span><span>Êó∂</span>';
                        return;
                    }

                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                    const minStr = String(minutes).padStart(2, '0');
                    const secStr = String(seconds).padStart(2, '0');

                    element.innerHTML = `<span>${minStr.charAt(0)}</span><span>${minStr.charAt(1)}</span> : <span>${secStr.charAt(0)}</span><span>${secStr.charAt(1)}</span>`;
                }, 1000);
                return timerId;
            }

            function cleanupWaimaiTimers() {
                for (const timestamp in waimaiTimers) {
                    clearInterval(waimaiTimers[timestamp]);
                }
                waimaiTimers = {};
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            async function handleWaimaiResponse(originalTimestamp, choice) {
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
                if (messageIndex === -1) return;

                // 1. Êõ¥Êñ∞ÂéüÂßãÊ∂àÊÅØÁöÑÁä∂ÊÄÅ
                const originalMessage = chat.history[messageIndex];
                originalMessage.status = choice;

                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëËÆ∞ÂΩïÊîØ‰ªòËÄÖÔºåÂπ∂ÊûÑÂª∫ÂØπAIÊõ¥Ê∏ÖÊô∞ÁöÑÁ≥ªÁªüÊ∂àÊÅØ
                let systemContent;
                const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

                if (choice === 'paid') {
                    originalMessage.paidBy = myNickname; // ËÆ∞ÂΩïÊòØÁî®Êà∑‰ªòÁöÑÈí±
                    systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ‰∏∫ ${originalMessage.senderName} ÁöÑÂ§ñÂçñËÆ¢ÂçïÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}ÔºâÂÆåÊàê‰∫ÜÊîØ‰ªò„ÄÇÊ≠§ËÆ¢ÂçïÂ∑≤ÂÖ≥Èó≠ÔºåÂÖ∂‰ªñÊàêÂëò‰∏çËÉΩÂÜçÊîØ‰ªò„ÄÇ]`;
                } else {
                    systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ÊãíÁªù‰∫Ü ${originalMessage.senderName} ÁöÑÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}Ôºâ„ÄÇ]`;
                }

                // 2. ÂàõÂª∫‰∏ÄÊù°Êñ∞ÁöÑ„ÄÅÂØπÁî®Êà∑ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÔºåÂëäÁü•AIÁªìÊûú
                const systemNote = {
                    role: 'system',
                    content: systemContent,
                    timestamp: Date.now(),
                    isHidden: true
                };
                chat.history.push(systemNote);

                // 3. ‰øùÂ≠òÊõ¥Êñ∞Âà∞Êï∞ÊçÆÂ∫ìÂπ∂Âà∑Êñ∞UI
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);

                // 4. „ÄêÂèØÈÄâ‰ΩÜÊé®Ëçê„ÄëÂú®ÊîØ‰ªòÊàêÂäüÂêéÔºå‰∏ªÂä®Ëß¶Âèë‰∏ÄÊ¨°AIÂìçÂ∫î
                if (choice === 'paid') {
                    triggerAiResponse();
                }
            }

            let videoCallState = {
                isActive: false,
                isAwaitingResponse: false,
                isGroupCall: false,
                activeChatId: null,
                initiator: null,
                startTime: null,
                participants: [],
                isUserParticipating: true,
                // --- „ÄêÊ†∏ÂøÉÊñ∞Â¢û„Äë---
                callHistory: [], // Áî®‰∫éÂ≠òÂÇ®ÈÄöËØù‰∏≠ÁöÑÂØπËØùÂéÜÂè≤
                preCallContext: "" // Áî®‰∫éÂ≠òÂÇ®ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å
            };

            let callTimerInterval = null; // Áî®‰∫éÂ≠òÂÇ®ËÆ°Êó∂Âô®ÁöÑID

            /**
             * „ÄêÊÄªÂÖ•Âè£„ÄëÁî®Êà∑ÁÇπÂáª‚ÄúÂèëËµ∑ËßÜÈ¢ëÈÄöËØù‚ÄùÊàñ‚ÄúÂèëËµ∑Áæ§ËßÜÈ¢ë‚ÄùÊåâÈíÆ
             */
            async function handleInitiateCall() {
                if (!state.activeChatId || videoCallState.isActive || videoCallState.isAwaitingResponse) return;
                const chat = state.chats[state.activeChatId];

                const confirmed = await showCustomConfirm(
                    'ÂèëËµ∑ÈÄöËØù',
                    `Âç≥Â∞ÜÊã®ÈÄö ${chat.name} ÁöÑËßÜÈ¢ëÁîµËØùÔºåË¶ÅÁªßÁª≠ÂêóÔºü`,
                    { confirmButtonClass: 'confirm-btn' }
                );
                if (!confirmed) {
                    return;
                }
                videoCallState.isGroupCall = chat.isGroup;
                videoCallState.isAwaitingResponse = true;
                videoCallState.initiator = 'user';
                videoCallState.activeChatId = chat.id;
                videoCallState.isUserParticipating = true; // Áî®Êà∑Ëá™Â∑±ÂèëËµ∑ÁöÑÔºåÂΩìÁÑ∂ÊòØÂèÇ‰∏éËÄÖ

                // Ê†πÊçÆÊòØÂçïËÅäËøòÊòØÁæ§ËÅäÔºåÊòæÁ§∫‰∏çÂêåÁöÑÂëºÂè´ÁïåÈù¢
                if (chat.isGroup) {
                    document.getElementById('outgoing-call-avatar').src = chat.settings.myAvatar || defaultMyGroupAvatar;
                    document.getElementById('outgoing-call-name').textContent = chat.settings.myNickname || 'Êàë';
                } else {
                    document.getElementById('outgoing-call-avatar').src = chat.settings.aiAvatar || defaultAvatar;
                    document.getElementById('outgoing-call-name').textContent = chat.name;
                }
                document.querySelector('#outgoing-call-screen .caller-text').textContent = chat.isGroup ? "Ê≠£Âú®ÂëºÂè´ÊâÄÊúâÊàêÂëò..." : "Ê≠£Âú®ÂëºÂè´...";
                showScreen('outgoing-call-screen');

                // ÂáÜÂ§áÂπ∂ÂèëÈÄÅÁ≥ªÁªüÊ∂àÊÅØÁªôAI
                const requestMessage = {
                    role: 'system',
                    content: chat.isGroup
                        ? `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${chat.settings.myNickname || 'Êàë'}) ÂèëËµ∑‰∫ÜÁæ§ËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇËØ∑‰Ω†‰ª¨ÂêÑËá™ÂÜ≥Á≠ñÔºåÂπ∂‰ΩøÁî® "group_call_response" Êåá‰ª§ÔºåËÆæÁΩÆ "decision" ‰∏∫ "join" Êàñ "decline" Êù•ÂõûÂ∫î„ÄÇ]`
                        : `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âêë‰Ω†ÂèëËµ∑‰∫ÜËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇËØ∑Ê†πÊçÆ‰Ω†ÁöÑ‰∫∫ËÆæÔºå‰ΩøÁî® "video_call_response" Êåá‰ª§ÔºåÂπ∂ËÆæÁΩÆ "decision" ‰∏∫ "accept" Êàñ "reject" Êù•ÂõûÂ∫î„ÄÇ]`,
                    timestamp: Date.now(),
                    isHidden: true,
                };
                chat.history.push(requestMessage);
                await db.chats.put(chat);

                // Ëß¶ÂèëAIÂìçÂ∫î
                await triggerAiResponse();
            }


            function startVideoCall() {
                const chat = state.chats[videoCallState.activeChatId];
                if (!chat) return;

                videoCallState.isActive = true;
                videoCallState.isAwaitingResponse = false;
                videoCallState.startTime = Date.now();
                videoCallState.callHistory = []; // „ÄêÊñ∞Â¢û„ÄëÊ∏ÖÁ©∫‰∏ä‰∏ÄÊ¨°ÈÄöËØùÁöÑÂéÜÂè≤

                // --- „ÄêÊ†∏ÂøÉÊñ∞Â¢ûÔºöÊäìÂèñÈÄöËØùÂâç‰∏ä‰∏ãÊñá„Äë---
                const preCallHistory = chat.history.slice(-5); // ÂèñÊúÄÂêé5Êù°‰Ωú‰∏∫‰∏ä‰∏ãÊñá
                videoCallState.preCallContext = preCallHistory.map(msg => {
                    const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (msg.senderName || chat.name);
                    return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                }).join('\n');
                // --- Êñ∞Â¢ûÁªìÊùü ---

                updateParticipantAvatars();

                document.getElementById('video-call-main').innerHTML = `<em>${videoCallState.isGroupCall ? 'Áæ§ËÅäÂ∑≤Âª∫Á´ã...' : 'Ê≠£Âú®Êé•ÈÄö...'}</em>`;
                showScreen('video-call-screen');

                document.getElementById('user-speak-btn').style.display = videoCallState.isUserParticipating ? 'block' : 'none';
                document.getElementById('join-call-btn').style.display = videoCallState.isUserParticipating ? 'none' : 'block';

                if (callTimerInterval) clearInterval(callTimerInterval);
                callTimerInterval = setInterval(updateCallTimer, 1000);
                updateCallTimer();

                triggerAiInCallAction();
            }

            /**
             * „ÄêÊ†∏ÂøÉ„ÄëÁªìÊùüËßÜÈ¢ëÈÄöËØù
             */
            async function endVideoCall() {
                if (!videoCallState.isActive) return;

                const duration = Math.floor((Date.now() - videoCallState.startTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                const durationText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                const endCallText = `ÈÄöËØùÁªìÊùüÔºåÊó∂Èïø ${durationText}`;

                const chat = state.chats[videoCallState.activeChatId];
                if (chat) {

                    // --- „ÄêÊ†∏ÂøÉÈáçÊûÑÔºöÂàõÂª∫ÈÄöËØùÊÄªÁªìÊ∂àÊÅØ„Äë ---
                    let summaryMessage = {
                        role: videoCallState.initiator === 'user' ? 'user' : 'assistant',
                        content: endCallText,
                        timestamp: Date.now(),
                    };

                    // „ÄêÂÖ≥ÈîÆ„Äë‰∏∫Áæ§ËÅäÁöÑ assistant Ê∂àÊÅØË°•ÂÖÖ senderName
                    if (chat.isGroup && summaryMessage.role === 'assistant') {
                        // Âú®Áæ§ËÅä‰∏≠ÔºåÈÄöËØùÁªìÊùüÁöÑÊ∂àÊÅØÂ∫îËØ•Áî±‚ÄúÂèëËµ∑ËÄÖ‚ÄùÊù•ËØ¥
                        // videoCallState.callRequester ‰øùÂ≠ò‰∫ÜÊúÄÂàùÂèëËµ∑ÈÄöËØùÁöÑÈÇ£‰∏™AIÁöÑÂêçÂ≠ó
                        summaryMessage.senderName = videoCallState.callRequester || chat.members[0]?.name || chat.name;
                    }

                    chat.history.push(summaryMessage);

                    // --- „ÄêÊ†∏ÂøÉÈáçÊûÑÔºöËß¶ÂèëÈÄöËØùÊÄªÁªì„Äë---
                    const callSummaryPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™ÂØπËØùÊÄªÁªìÂä©Êâã„ÄÇ‰∏ãÈù¢ÁöÑ‚ÄúÈÄöËØùËÆ∞ÂΩï‚ÄùÊòØ‰∏ÄÊÆµÂàöÂàöÁªìÊùüÁöÑËßÜÈ¢ëÈÄöËØùÂÜÖÂÆπ„ÄÇËØ∑‰Ω†Áî®1-2Âè•ËØùÔºåÁ≤æÁÇºÂú∞ÊÄªÁªìÂá∫ËøôÊ¨°ÈÄöËØùÁöÑÊ†∏ÂøÉÂÜÖÂÆπÊàñËææÊàêÁöÑÂÖ±ËØÜ„ÄÇ
‰Ω†ÁöÑÊÄªÁªìÂ∞Ü‰Ωú‰∏∫‰∏ÄÊù°ÈöêËóèÁöÑÁ≥ªÁªüÊèêÁ§∫ÔºåÂ∏ÆÂä©AIÂú®Êé•‰∏ãÊù•ÁöÑËÅäÂ§©‰∏≠ËÆ∞‰ΩèËøôÊ¨°ÈÄöËØùÂèëÁîü‰∫Ü‰ªÄ‰πà„ÄÇ

# ÈÄöËØùËÆ∞ÂΩï:
${videoCallState.callHistory.map(h => `${h.role}: ${h.content}`).join('\n')}

ËØ∑Áõ¥Êé•ËæìÂá∫ÊÄªÁªìÂÜÖÂÆπÔºå‰∏çË¶ÅÂä†‰ªª‰ΩïÈ¢ùÂ§ñÁöÑÂâçÁºÄÊàñËß£Èáä„ÄÇ`;

                    try {
                        const { proxyUrl, apiKey, model } = state.apiConfig;
                        const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({
                                model: model,
                                messages: [{ role: 'system', content: callSummaryPrompt }],
                                temperature: 0.5
                            })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const callSummaryText = data.choices[0].message.content;
                            const hiddenSummary = {
                                role: 'system',
                                content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÂàöÊâçÁöÑËßÜÈ¢ëÈÄöËØùÂÜÖÂÆπÊëòË¶ÅÔºö${callSummaryText}]`,
                                timestamp: Date.now() + 1,
                                isHidden: true
                            };
                            chat.history.push(hiddenSummary);
                        }
                    } catch (e) {
                        console.error("ÈÄöËØùÊÄªÁªìÂ§±Ë¥•:", e);
                    }

                    await db.chats.put(chat);
                }

                // Ê∏ÖÁêÜÂíåÈáçÁΩÆ
                clearInterval(callTimerInterval);
                callTimerInterval = null;
                videoCallState = { isActive: false, isAwaitingResponse: false, isGroupCall: false, activeChatId: null, initiator: null, startTime: null, participants: [], isUserParticipating: true, callHistory: [], preCallContext: "" };

                // „ÄêÈáçË¶Å„ÄëÁ°Æ‰øùÂú®ÊâÄÊúâÊìç‰ΩúÂÆåÊàêÂêéÂÜçÊâìÂºÄËÅäÂ§©
                if (chat) {
                    openChat(chat.id);
                }
            }

            /**
             * „ÄêÂÖ®Êñ∞„ÄëÊõ¥Êñ∞ÈÄöËØùÁïåÈù¢ÁöÑÂèÇ‰∏éËÄÖÂ§¥ÂÉèÁΩëÊ†º
             */
            function updateParticipantAvatars() {
                const grid = document.getElementById('participant-avatars-grid');
                grid.innerHTML = '';
                const chat = state.chats[videoCallState.activeChatId];
                if (!chat) return;

                let participantsToRender = [];

                // ‚òÖ Ê†∏ÂøÉ‰øÆÊ≠£ÔºöÂå∫ÂàÜÁæ§ËÅäÂíåÂçïËÅä
                if (videoCallState.isGroupCall) {
                    // Áæ§ËÅäÈÄªËæëÔºöÊòæÁ§∫ÊâÄÊúâÂ∑≤Âä†ÂÖ•ÁöÑAIÊàêÂëò
                    participantsToRender = [...videoCallState.participants];
                    // Â¶ÇÊûúÁî®Êà∑‰πüÂèÇ‰∏é‰∫ÜÔºåÂ∞±ÊääÁî®Êà∑‰ø°ÊÅØ‰πüÂä†ËøõÂéª
                    if (videoCallState.isUserParticipating) {
                        participantsToRender.unshift({
                            id: 'user',
                            name: chat.settings.myNickname || 'Êàë',
                            avatar: chat.settings.myAvatar || defaultMyGroupAvatar
                        });
                    }
                } else {
                    // ÂçïËÅäÈÄªËæëÔºöÂè™ÊòæÁ§∫ÂØπÊñπÁöÑÂ§¥ÂÉèÂíåÂêçÂ≠ó
                    participantsToRender.push({
                        id: 'ai',
                        name: chat.name,
                        avatar: chat.settings.aiAvatar || defaultAvatar
                    });
                }

                participantsToRender.forEach(p => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'participant-avatar-wrapper';
                    wrapper.dataset.participantId = p.id;
                    wrapper.innerHTML = `
            <img src="${p.avatar}" class="participant-avatar" alt="${p.name}">
            <div class="participant-name">${p.name}</div>
        `;
                    grid.appendChild(wrapper);
                });
            }

            /**
             * „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜÁî®Êà∑Âä†ÂÖ•/ÈáçÊñ∞Âä†ÂÖ•ÈÄöËØù
             */
            function handleUserJoinCall() {
                if (!videoCallState.isActive || videoCallState.isUserParticipating) return;

                videoCallState.isUserParticipating = true;
                updateParticipantAvatars(); // Êõ¥Êñ∞Â§¥ÂÉèÂàóË°®ÔºåÂä†ÂÖ•Áî®Êà∑

                // ÂàáÊç¢Â∫ïÈÉ®ÊåâÈíÆ
                document.getElementById('user-speak-btn').style.display = 'block';
                document.getElementById('join-call-btn').style.display = 'none';

                // ÂëäÁü•AIÁî®Êà∑Âä†ÂÖ•‰∫Ü
                triggerAiInCallAction("[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Âä†ÂÖ•‰∫ÜÈÄöËØù]");
            }


            /**
             * Êõ¥Êñ∞ÈÄöËØùËÆ°Êó∂Âô®ÊòæÁ§∫ (‰øùÊåÅ‰∏çÂèò)
             */
            function updateCallTimer() {
                if (!videoCallState.isActive) return;
                const elapsed = Math.floor((Date.now() - videoCallState.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('call-timer').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™ÂÆåÊï¥ÂáΩÊï∞ÊõøÊç¢ÊóßÁöÑ showIncomingCallModal ‚ñº‚ñº‚ñº
            function showIncomingCallModal() {
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                // Ê†πÊçÆÊòØÂê¶Áæ§ËÅäÊòæÁ§∫‰∏çÂêå‰ø°ÊÅØ
                if (chat.isGroup) {
                    // ‰ªé videoCallState ‰∏≠Ëé∑ÂèñÊòØÂì™‰∏™ÊàêÂëòÂèëËµ∑ÁöÑÈÄöËØù
                    const requesterName = videoCallState.callRequester || chat.members[0]?.name || '‰∏Ä‰ΩçÊàêÂëò';
                    document.getElementById('caller-avatar').src = chat.settings.groupAvatar || defaultGroupAvatar;
                    document.getElementById('caller-name').textContent = chat.name; // ÊòæÁ§∫Áæ§Âêç
                    document.querySelector('.incoming-call-content .caller-text').textContent = `${requesterName} ÈÇÄËØ∑‰Ω†Âä†ÂÖ•Áæ§ËßÜÈ¢ë`; // ÊòæÁ§∫ÂÖ∑‰ΩìÂèëËµ∑‰∫∫
                } else {
                    // ÂçïËÅäÈÄªËæë‰øùÊåÅ‰∏çÂèò
                    document.getElementById('caller-avatar').src = chat.settings.aiAvatar || defaultAvatar;
                    document.getElementById('caller-name').textContent = chat.name;
                    document.querySelector('.incoming-call-content .caller-text').textContent = 'ÈÇÄËØ∑‰Ω†ËßÜÈ¢ëÈÄöËØù';
                }

                document.getElementById('incoming-call-modal').classList.add('visible');
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            /**
             * ÈöêËóèAIÂèëËµ∑ÁöÑÈÄöËØùËØ∑Ê±ÇÊ®°ÊÄÅÊ°Ü (‰øùÊåÅ‰∏çÂèò)
             */
            function hideIncomingCallModal() {
                document.getElementById('incoming-call-modal').classList.remove('visible');
            }

            async function triggerAiInCallAction(userInput = null) {
                if (!videoCallState.isActive) return;

                const chat = state.chats[videoCallState.activeChatId];
                const { proxyUrl, apiKey, model } = state.apiConfig;
                const callFeed = document.getElementById('video-call-main');
                const userNickname = chat.settings.myNickname || 'Êàë';

                // 1. Â¶ÇÊûúÁî®Êà∑ÊúâËæìÂÖ•ÔºåÂÖàÊ∏≤ÊüìÂπ∂Â≠òÂÖ•ÈÄöËØùÂéÜÂè≤
                if (userInput && videoCallState.isUserParticipating) {
                    const userBubble = document.createElement('div');
                    userBubble.className = 'call-message-bubble user-speech';
                    userBubble.textContent = userInput;
                    callFeed.appendChild(userBubble);
                    callFeed.scrollTop = callFeed.scrollHeight;
                    videoCallState.callHistory.push({ role: 'user', content: userInput });
                }

                // 2. ÊûÑÂª∫ÂÖ®Êñ∞ÁöÑ„ÄÅÂåÖÂê´ÂÆåÊï¥‰∏ä‰∏ãÊñáÁöÑ System Prompt
                let inCallPrompt;
                if (videoCallState.isGroupCall) {
                    const participantNames = videoCallState.participants.map(p => p.name);
                    if (videoCallState.isUserParticipating) {
                        participantNames.unshift(userNickname);
                    }
                    inCallPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäËßÜÈ¢ëÈÄöËØùÁöÑÂØºÊºî„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºîÊâÄÊúâ„ÄêÈô§‰∫ÜÁî®Êà∑‰ª•Â§ñ„ÄëÁöÑAIËßíËâ≤ÔºåÂπ∂‰ª•„ÄêÁ¨¨‰∏â‰∫∫Áß∞ÊóÅËßÇËßÜËßí„ÄëÊù•ÊèèËø∞‰ªñ‰ª¨Âú®ÈÄöËØù‰∏≠ÁöÑÊâÄÊúâÂä®‰ΩúÂíåËØ≠Ë®Ä„ÄÇ
# Ê†∏ÂøÉËßÑÂàô
1.  **„Äê„Äê„ÄêË∫´‰ªΩÈìÅÂæã„Äë„Äë„Äë**: Áî®Êà∑ÁöÑË∫´‰ªΩÊòØ„Äê${userNickname}„Äë„ÄÇ‰Ω†„ÄêÁªùÂØπ‰∏çËÉΩ„ÄëÁîüÊàê \`name\` Â≠óÊÆµ‰∏∫ **"${userNickname}"** ÁöÑÂèëË®Ä„ÄÇ
2.  **„Äê„Äê„ÄêËßÜËßíÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚Äù„ÄÇ
3.  **Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÔºåÊØè‰∏™ÂØπË±°‰ª£Ë°®‰∏Ä‰∏™ËßíËâ≤ÁöÑÂèëË®ÄÔºåÊ†ºÂºè‰∏∫Ôºö\`{"name": "ËßíËâ≤Âêç", "speech": "*‰ªñÁ¨ë‰∫ÜÁ¨ë* Â§ßÂÆ∂Â•ΩÂïäÔºÅ"}\`„ÄÇ
4.  **ËßíËâ≤ÊâÆÊºî**: ‰∏•Ê†ºÈÅµÂÆàÊØè‰∏™ËßíËâ≤ÁöÑËÆæÂÆö„ÄÇ
# ÂΩìÂâçÊÉÖÊôØ
‰Ω†‰ª¨Ê≠£Âú®‰∏Ä‰∏™Áæ§ËßÜÈ¢ëÈÄöËØù‰∏≠„ÄÇ
**ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å**:
${videoCallState.preCallContext}
**ÂΩìÂâçÂèÇ‰∏éËÄÖ**: ${participantNames.join('„ÄÅ ')}„ÄÇ
**ÈÄöËØùÂàöÂàöÂºÄÂßã...**
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ„ÄêÈÄöËØùÂâçÊëòË¶Å„ÄëÂíå‰∏ãÈù¢ÁöÑ„ÄêÈÄöËØùÂÆûÊó∂ËÆ∞ÂΩï„ÄëÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ
`;
                } else {
                    let openingContext = videoCallState.initiator === 'user'
                        ? `‰Ω†ÂàöÂàöÊé•Âê¨‰∫ÜÁî®Êà∑ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ`
                        : `Áî®Êà∑ÂàöÂàöÊé•Âê¨‰∫Ü‰Ω†‰∏ªÂä®ÂèëËµ∑ÁöÑËßÜÈ¢ëÈÄöËØù„ÄÇ`;
                    inCallPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Áé∞Âú®ÊòØ‰∏Ä‰∏™Âú∫ÊôØÊèèËø∞ÂºïÊìé„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî ${chat.name} (${chat.settings.aiPersona})ÔºåÂπ∂‰ª•„ÄêÁ¨¨‰∏â‰∫∫Áß∞ÊóÅËßÇËßÜËßí„ÄëÊù•ÊèèËø∞TAÂú®ËßÜÈ¢ëÈÄöËØù‰∏≠ÁöÑÊâÄÊúâÂä®‰ΩúÂíåËØ≠Ë®Ä„ÄÇ
# Ê†∏ÂøÉËßÑÂàô
1.  **„Äê„Äê„ÄêËßÜËßíÈìÅÂæã„Äë„Äë„Äë**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÁªùÂØπ‰∏çËÉΩ„Äë‰ΩøÁî®Á¨¨‰∏Ä‰∫∫Áß∞‚ÄúÊàë‚Äù„ÄÇÂøÖÈ°ª‰ΩøÁî®Á¨¨‰∏â‰∫∫Áß∞ÔºåÂ¶Ç‚Äú‰ªñ‚Äù„ÄÅ‚ÄúÂ•π‚Äù„ÄÅÊàñÁõ¥Êé•‰ΩøÁî®ËßíËâ≤Âêç‚Äú${chat.name}‚Äù„ÄÇ
2.  **Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏ÄÊÆµÊèèËø∞ÊÄßÁöÑÊñáÊú¨„ÄÇ
# ÂΩìÂâçÊÉÖÊôØ
‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑Ôºà${userNickname}Ôºå‰∫∫ËÆæ: ${chat.settings.myPersona}ÔºâËøõË°åËßÜÈ¢ëÈÄöËØù„ÄÇ
**${openingContext}**
**ÈÄöËØùÂâçÁöÑËÅäÂ§©ÊëòË¶Å (ËøôÊòØ‰Ω†‰ª¨ÈÄöËØùÁöÑÂéüÂõ†ÔºåËá≥ÂÖ≥ÈáçË¶ÅÔºÅ)**:
${videoCallState.preCallContext}
Áé∞Âú®ÔºåËØ∑Ê†πÊçÆ„ÄêÈÄöËØùÂâçÊëòË¶Å„ÄëÂíå‰∏ãÈù¢ÁöÑ„ÄêÈÄöËØùÂÆûÊó∂ËÆ∞ÂΩï„ÄëÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ
`;
                }

                // 3. ÊûÑÂª∫ÂèëÈÄÅÁªôAPIÁöÑ messages Êï∞ÁªÑ
                const messagesForApi = [
                    { role: 'system', content: inCallPrompt },
                    // Â∞ÜÂ∑≤ÊúâÁöÑÈÄöËØùÂéÜÂè≤Âä†ËøõÂéª
                    ...videoCallState.callHistory.map(h => ({ role: h.role, content: h.content }))
                ];

                // --- „ÄêÊ†∏ÂøÉ‰øÆÂ§çÔºöÁ°Æ‰øùÁ¨¨‰∏ÄÊ¨°Ë∞ÉÁî®Êó∂ÊúâÂÜÖÂÆπ„Äë---
                if (videoCallState.callHistory.length === 0) {
                    const firstLineTrigger = videoCallState.initiator === 'user' ? `*‰Ω†Êåâ‰∏ã‰∫ÜÊé•Âê¨ÈîÆ...*` : `*ÂØπÊñπÊåâ‰∏ã‰∫ÜÊé•Âê¨ÈîÆ...*`;
                    messagesForApi.push({ role: 'user', content: firstLineTrigger });
                }
                // --- ‰øÆÂ§çÁªìÊùü ---

                try {
                    const data = await makeAPIRequest(proxyUrl, apiKey, model, messagesForApi, 0.8);
                    const aiResponse = data.choices[0].message.content;

                    const connectingElement = callFeed.querySelector('em');
                    if (connectingElement) connectingElement.remove();

                    // 4. Â§ÑÁêÜAIËøîÂõûÁöÑÂÜÖÂÆπÔºåÂπ∂Â∞ÜÂÖ∂Â≠òÂÖ•ÈÄöËØùÂéÜÂè≤
                    if (videoCallState.isGroupCall) {
                        const speechArray = parseAiResponse(aiResponse);
                        speechArray.forEach(turn => {
                            if (!turn.name || turn.name === userNickname || !turn.speech) return;
                            const aiBubble = document.createElement('div');
                            aiBubble.className = 'call-message-bubble ai-speech';
                            aiBubble.innerHTML = `<strong>${turn.name}:</strong> ${turn.speech}`;
                            callFeed.appendChild(aiBubble);
                            videoCallState.callHistory.push({ role: 'assistant', content: `${turn.name}: ${turn.speech}` });

                            const speaker = videoCallState.participants.find(p => p.name === turn.name);
                            if (speaker) {
                                const speakingAvatar = document.querySelector(`.participant-avatar-wrapper[data-participant-id="${speaker.id}"] .participant-avatar`);
                                if (speakingAvatar) {
                                    speakingAvatar.classList.add('speaking');
                                    setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                                }
                            }
                        });
                    } else {
                        const aiBubble = document.createElement('div');
                        aiBubble.className = 'call-message-bubble ai-speech';
                        aiBubble.textContent = aiResponse;
                        callFeed.appendChild(aiBubble);
                        videoCallState.callHistory.push({ role: 'assistant', content: aiResponse });

                        const speakingAvatar = document.querySelector(`.participant-avatar-wrapper .participant-avatar`);
                        if (speakingAvatar) {
                            speakingAvatar.classList.add('speaking');
                            setTimeout(() => speakingAvatar.classList.remove('speaking'), 2000);
                        }
                    }

                    callFeed.scrollTop = callFeed.scrollHeight;

                } catch (error) {
                    const errorBubble = document.createElement('div');
                    errorBubble.className = 'call-message-bubble ai-speech';
                    errorBubble.style.color = '#ff8a80';
                    errorBubble.textContent = `[ERROR: ${error.message}]`;
                    callFeed.appendChild(errorBubble);
                    callFeed.scrollTop = callFeed.scrollHeight;
                    videoCallState.callHistory.push({ role: 'assistant', content: `[ERROR: ${error.message}]` });
                }
            }

            // ‚ñº‚ñº‚ñº Â∞ÜËøô‰∏™„ÄêÂÖ®Êñ∞ÂáΩÊï∞„ÄëÁ≤òË¥¥Âà∞JSÂäüËÉΩÂáΩÊï∞ÂÆö‰πâÂå∫ ‚ñº‚ñº‚ñº
            function toggleCallButtons(isGroup) {
                document.getElementById('video-call-btn').style.display = isGroup ? 'none' : 'flex';
                document.getElementById('group-video-call-btn').style.display = isGroup ? 'flex' : 'none';
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËøô‰∏™ÂáΩÊï∞ÊòØÊú¨Ê¨°‰øÆÂ§çÁöÑÊ†∏ÂøÉÔºåËØ∑Á≤òË¥¥Âà∞‰Ω†ÁöÑJSÂäüËÉΩÂå∫ ‚ñº‚ñº‚ñº
            async function handleWaimaiResponse(originalTimestamp, choice) {
                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                const messageIndex = chat.history.findIndex(m => m.timestamp === originalTimestamp);
                if (messageIndex === -1) return;

                // 1. Êõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÂéüÂßãÊ∂àÊÅØÁöÑÁä∂ÊÄÅ
                const originalMessage = chat.history[messageIndex];
                originalMessage.status = choice;

                // 2. Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÁöÑÊòµÁß∞ÔºåÂπ∂ÊûÑÂª∫ÂØπAIÊõ¥Ê∏ÖÊô∞ÁöÑÁ≥ªÁªüÊ∂àÊÅØ
                let systemContent;
                const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

                if (choice === 'paid') {
                    originalMessage.paidBy = myNickname; // ËÆ∞ÂΩïÊòØ‚ÄúÊàë‚Äù‰ªòÁöÑÈí±
                    systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ‰∏∫ ${originalMessage.senderName} ÁöÑÂ§ñÂçñËÆ¢ÂçïÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}ÔºâÂÆåÊàê‰∫ÜÊîØ‰ªò„ÄÇÊ≠§ËÆ¢ÂçïÂ∑≤ÂÖ≥Èó≠ÔºåÂÖ∂‰ªñÊàêÂëò‰∏çËÉΩÂÜçÊîØ‰ªò„ÄÇ]`;
                } else {
                    systemContent = `[Á≥ªÁªüÊèêÁ§∫Ôºö‰Ω† (${myNickname}) ÊãíÁªù‰∫Ü ${originalMessage.senderName} ÁöÑÂ§ñÂçñ‰ª£‰ªòËØ∑Ê±ÇÔºàÊó∂Èó¥Êà≥: ${originalTimestamp}Ôºâ„ÄÇ]`;
                }

                // 3. ÂàõÂª∫‰∏ÄÊù°Êñ∞ÁöÑ„ÄÅÂØπÁî®Êà∑ÈöêËóèÁöÑÁ≥ªÁªüÊ∂àÊÅØÔºåÂëäÁü•AIÁªìÊûú
                const systemNote = {
                    role: 'system',
                    content: systemContent,
                    timestamp: Date.now(),
                    isHidden: true
                };
                chat.history.push(systemNote);

                // 4. Â∞ÜÊõ¥Êñ∞ÂêéÁöÑÊï∞ÊçÆ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÂπ∂Á´ãÂàªÈáçÁªòUI
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);

                // 5. „ÄêÈáçË¶Å„ÄëÂè™ÊúâÂú®ÊîØ‰ªòÊàêÂäüÂêéÔºåÊâçËß¶Âèë‰∏ÄÊ¨°AIÂìçÂ∫îÔºåËÆ©ÂÆÉÊÑüË∞¢‰Ω†
                if (choice === 'paid') {
                    triggerAiResponse();
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            /* ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÂùó„ÄêÊñ∞‰ª£Á†Å„ÄëÂÆåÊï¥Âú∞Á≤òË¥¥Âà∞ÊÇ®ÂàöÂàöÂà†Èô§ÊóßÂáΩÊï∞ÂêéÁïôÂá∫ÁöÑÁ©∫ÁôΩ‰ΩçÁΩÆ ‚ñº‚ñº‚ñº */

            /**
             * „ÄêÊúÄÁªàÁâà„ÄëÂ§ÑÁêÜÁî®Êà∑ÁÇπÂáªÂ§¥ÂÉèÔºåÊ†πÊçÆÂú∫ÊôØÊâßË°å‰∏çÂêåÊìç‰Ωú
             * @param {string} chatId - ÂèëÁîü‰∫íÂä®ÁöÑËÅäÂ§©ID
             * @param {string} characterName - Ë¢´ÁÇπÂáªÁöÑËßíËâ≤Âêç
             */
            async function handleUserPat(chatId, characterName) {
                const chat = state.chats[chatId];
                if (!chat) return;

                // --- „ÄêÊ†∏ÂøÉÈÄªËæëÂà§Êñ≠„Äë---
                // Âà§Êñ≠1ÔºöÂΩìÂâçÊòØÂê¶Ê≠£Â§ÑÂú®‰∏éËøô‰∏™chatIdÂåπÈÖçÁöÑËÅäÂ§©ÁïåÈù¢‰∏≠Ôºü
                // Âà§Êñ≠2ÔºöËøô‰∏™ËÅäÂ§©ÊòØÂê¶ÊòØ‰∏Ä‰∏™Áæ§ËÅäÔºü
                const isInGroupChatInterface =
                    document.getElementById('chat-interface-screen').classList.contains('active') &&
                    state.activeChatId === chatId &&
                    chat.isGroup;

                // Â¶ÇÊûúÊòØÂú®Áæ§ËÅäÁïåÈù¢ÂÜÖÁÇπÂáªÂ§¥ÂÉèÔºåÊâßË°å @ ÂäüËÉΩ
                if (isInGroupChatInterface) {
                    const chatInput = document.getElementById('chat-input');
                    // Âú®ËæìÂÖ•Ê°ÜÊú´Â∞æÊ∑ªÂä† @ ÂíåÂêçÂ≠óÔºåÂπ∂Âä†‰∏ä‰∏Ä‰∏™Á©∫Ê†º
                    chatInput.value += `@${characterName} `;
                    // Ëá™Âä®ËÅöÁÑ¶Âà∞ËæìÂÖ•Ê°ÜÔºåÊñπ‰æøÁî®Êà∑ÁªßÁª≠ËæìÂÖ•
                    chatInput.focus();
                    // Ëß¶Âèë‰∏ÄÊ¨°input‰∫ã‰ª∂ÔºåËÆ©ËæìÂÖ•Ê°ÜÈ´òÂ∫¶Ëá™ÈÄÇÂ∫î
                    chatInput.dispatchEvent(new Event('input'));

                    // @ÂäüËÉΩÂÆåÊàêÂêéÔºåÁõ¥Êé•ËøîÂõûÔºå‰∏çÂÜçÊâßË°åÂêéÁª≠ÁöÑ‰∫íÂä®ËèúÂçïÈÄªËæë
                    return;
                }

                // --- Â¶ÇÊûú‰∏çÊòØÂú®Áæ§ËÅäÁïåÈù¢ÂÜÖÔºåÂàôÊâßË°åÂéüÊúâÁöÑ‚ÄúÊÉÖÊôØ‰∫íÂä®‚ÄùËèúÂçïÂäüËÉΩ ---

                // 1. ÂºπÂá∫Ëá™ÂÆö‰πâÁöÑÊìç‰ΩúËèúÂçïÊ®°ÊÄÅÊ°Ü
                const actionsModal = document.getElementById('preset-actions-modal');
                const modalContent = actionsModal.querySelector('.custom-modal-footer');

                // 2. Âä®ÊÄÅÁîüÊàêËèúÂçïÊåâÈíÆ
                modalContent.innerHTML = `
        <p style="padding: 10px 15px; text-align: center; color: var(--text-secondary); border-bottom: 1px solid #dbdbdb;">‰∏é ${characterName} ‰∫íÂä®</p>
        <button data-action="poke">Êà≥‰∏Ä‰∏ã</button>
        <button data-action="start_topic">ÂèëËµ∑‰∏Ä‰∏™ËØùÈ¢ò</button>
        <button data-action="request_status">ÈóÆÈóÆÂú®Âπ≤Âòõ</button>
        <button data-action="cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
    `;

                // 3. ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                actionsModal.classList.add('visible');

                // 4. ‰∏∫ÊåâÈíÆÁªëÂÆö‰∏ÄÊ¨°ÊÄßÁöÑÁÇπÂáª‰∫ã‰ª∂
                const handleActionClick = async (e) => {
                    const action = e.target.dataset.action;
                    if (!action) return;

                    actionsModal.classList.remove('visible');
                    modalContent.removeEventListener('click', handleActionClick);

                    let hiddenMessageContent = '';
                    let visibleMessageContent = '';

                    switch (action) {
                        case 'poke':
                            hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Êà≥‰∫Ü‰Ω†‰∏Ä‰∏ã„ÄÇËØ∑‰Ω†ÁÆÄÂçïÂõûÂ∫î„ÄÇ]`;
                            visibleMessageContent = `‰Ω†Êà≥‰∫ÜÊà≥ ‚Äú${characterName}‚Äù`;
                            break;
                        case 'start_topic':
                            hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑Â∏åÊúõ‰Ω†ÂºÄÂêØ‰∏Ä‰∏™Êñ∞ÁöÑ„ÄÅÊúâË∂£ÁöÑËØùÈ¢ò„ÄÇ]`;
                            visibleMessageContent = `‰Ω†ËÆ© ‚Äú${characterName}‚Äù ÂèëËµ∑‰∏Ä‰∏™Êñ∞ËØùÈ¢ò`;
                            break;
                        case 'request_status':
                            hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊÉ≥Áü•ÈÅì‰Ω†Áé∞Âú®Ê≠£Âú®ÂÅö‰ªÄ‰πà„ÄÇËØ∑‰Ω†Â¶ÇÂÆûÂõûÁ≠îÔºåÂπ∂ÂØπÁî®Êà∑ÊèêÂá∫ÂÖ≥ÂøÉÔºåÂπ∂‰ΩøÁî® update_status Êåá‰ª§Êõ¥Êñ∞‰Ω†ÁöÑÁä∂ÊÄÅ„ÄÇ]`;
                            visibleMessageContent = `‰Ω†ÈóÆ ‚Äú${characterName}‚Äù Âú®ÂÅö‰ªÄ‰πà`;
                            break;
                        case 'cancel':
                            return;
                    }

                    if (hiddenMessageContent) {
                        const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

                        const visibleMessage = {
                            role: 'system',
                            type: 'pat_message',
                            content: visibleMessageContent,
                            timestamp: Date.now()
                        };

                        const hiddenMessage = {
                            role: 'system',
                            content: hiddenMessageContent.replace('Áî®Êà∑', myNickname).replace('‰Ω†', characterName),
                            timestamp: Date.now() + 1,
                            isHidden: true
                        };

                        chat.history.push(visibleMessage, hiddenMessage);
                        await db.chats.put(chat);

                        if (state.activeChatId === chatId) {
                            appendMessage(visibleMessage, chat);
                        }
                        await renderChatList();
                        triggerAiResponse();
                    }
                };

                modalContent.addEventListener('click', handleActionClick);
            }
            /* ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤ */

            // ‚ñº‚ñº‚ñº ËØ∑Â∞Ü‰∏ãÈù¢Ëøô„Äê‰∏ÄÊï¥ÂùóÊñ∞‰ª£Á†Å„ÄëÁ≤òË¥¥Âà∞ÂàöÂàöÂà†Èô§ÁöÑ‰ΩçÁΩÆ ‚ñº‚ñº‚ñº
            /**
             * „ÄêÈáçÊûÑÁâà„ÄëÊ∏≤ÊüìÂõûÂøÜ‰∏éÁ∫¶ÂÆöÁïåÈù¢Ôºå‰ΩøÁî®Âçï‰∏ÄÂæ™ÁéØÂíåÊ∏ÖÊô∞ÁöÑif/elseÈÄªËæë
             */
            async function renderMemoriesScreen() {
                const listEl = document.getElementById('memories-list');
                listEl.innerHTML = '';

                // 1. Ëé∑ÂèñÊâÄÊúâÂõûÂøÜÔºåÂπ∂ÊåâÂÆûÈôÖÊó•ÊúüÊó∂Èó¥ÊéíÂ∫è
                const allMemories = await db.memories.toArray();

                if (allMemories.length === 0) {
                    listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary); padding: 50px 0;">ËøôÈáåËøòÊ≤°ÊúâÂÖ±ÂêåÁöÑÂõûÂøÜÂíåÁ∫¶ÂÆöÂë¢~</p>';
                    return;
                }

                // 2. Â∞ÜÊú™Âà∞ÊúüÁöÑÁ∫¶ÂÆöÊéíÂú®ÊúÄÂâçÈù¢ÔºåÂÖ∂‰ªñÊåâÂÆûÈôÖÊó∂Èó¥ÊéíÂ∫è
                allMemories.sort((a, b) => {
                    const aIsActiveCountdown = a.type === 'countdown' && a.targetDate > Date.now();
                    const bIsActiveCountdown = b.type === 'countdown' && b.targetDate > Date.now();

                    // Active countdowns first
                    if (aIsActiveCountdown && !bIsActiveCountdown) return -1;
                    if (!aIsActiveCountdown && bIsActiveCountdown) return 1;

                    // Both are active countdowns - sort by target date (earliest first)
                    if (aIsActiveCountdown && bIsActiveCountdown) return a.targetDate - b.targetDate;

                    // Neither are active countdowns - sort by actual memory/event time (most recent first)
                    let aTime, bTime;

                    if (a.type === 'ai_generated') {
                        aTime = a.timestamp;
                    } else if (a.type === 'countdown' && a.targetDate) {
                        aTime = a.targetDate;
                    } else {
                        aTime = a.timestamp;
                    }

                    if (b.type === 'ai_generated') {
                        bTime = b.timestamp;
                    } else if (b.type === 'countdown' && b.targetDate) {
                        bTime = b.targetDate;
                    } else {
                        bTime = b.timestamp;
                    }

                    return bTime - aTime; // Most recent first
                });

                // 3. „ÄêÊ†∏ÂøÉ„Äë‰ΩøÁî®Âçï‰∏ÄÂæ™ÁéØÊù•Â§ÑÁêÜÊâÄÊúâÁ±ªÂûãÁöÑÂç°Áâá
                allMemories.forEach(item => {
                    let card;
                    // Âà§Êñ≠1ÔºöÂ¶ÇÊûúÊòØÊ≠£Âú®ËøõË°åÁöÑÁ∫¶ÂÆö
                    if (item.type === 'countdown' && item.targetDate > Date.now()) {
                        card = createCountdownCard(item);
                    }
                    // Âà§Êñ≠2ÔºöÂÖ∂‰ªñÊâÄÊúâÊÉÖÂÜµÔºàÊôÆÈÄöÂõûÂøÜ Êàñ Â∑≤Âà∞ÊúüÁöÑÁ∫¶ÂÆöÔºâ
                    else {
                        card = createMemoryCard(item);
                    }
                    listEl.appendChild(card);
                });

                // 4. ÂêØÂä®ÊâÄÊúâÂÄíËÆ°Êó∂
                startAllCountdownTimers();
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            /**
             * ÂàõÂª∫ÊôÆÈÄöÂõûÂøÜÂç°ÁâáDOMÂÖÉÁ¥†
             */
            function createMemoryCard(memory) {
                const card = document.createElement('div');
                card.className = 'memory-card';
                const memoryDate = new Date(memory.timestamp);
                const dateString = `${memoryDate.getFullYear()}-${String(memoryDate.getMonth() + 1).padStart(2, '0')}-${String(memoryDate.getDate()).padStart(2, '0')} ${String(memoryDate.getHours()).padStart(2, '0')}:${String(memoryDate.getMinutes()).padStart(2, '0')}`;

                let titleHtml, contentHtml;

                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨ÂØπ‰∏çÂêåÁ±ªÂûãÁöÑÂõûÂøÜËøõË°åÊ∏ÖÊô∞ÁöÑÂå∫ÂàÜ
                if (memory.type === 'countdown' && memory.targetDate) {
                    // Â¶ÇÊûúÊòØÂ∑≤Âà∞ÊúüÁöÑÁ∫¶ÂÆö
                    titleHtml = `[Á∫¶ÂÆöËææÊàê] ${memory.description}`;
                    contentHtml = `Âú® ${new Date(memory.targetDate).toLocaleString()}ÔºåÊàë‰ª¨‰∏ÄËµ∑ËßÅËØÅ‰∫ÜËøô‰∏™Á∫¶ÂÆö„ÄÇ`;
                } else {
                    // Â¶ÇÊûúÊòØÊôÆÈÄöÁöÑÊó•ËÆ∞ÂºèÂõûÂøÜ
                    titleHtml = memory.authorName ? `${memory.authorName} ÁöÑÊó•ËÆ∞` : 'Êàë‰ª¨ÁöÑÂõûÂøÜ';
                    contentHtml = memory.description;
                }

                card.innerHTML = `
        <div class="header">
            <div class="date">${dateString}</div>
            <div class="author">${titleHtml}</div>
        </div>
        <div class="content">${contentHtml}</div>
    `;
                addLongPressListener(card, async () => {
                    showMemoryActions(memory.id);
                });
                return card;
            }

            function createCountdownCard(countdown) {
                const card = document.createElement('div');
                card.className = 'countdown-card';

                // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂú®‰ΩøÁî®ÂâçÔºåÂÖà‰ªé countdown ÂØπË±°‰∏≠ÂàõÂª∫ targetDate ÂèòÈáè
                const targetDate = new Date(countdown.targetDate);

                // Áé∞Âú®ÂèØ‰ª•ÂÆâÂÖ®Âú∞‰ΩøÁî® targetDate ‰∫Ü
                const targetDateString = targetDate.toLocaleString('zh-CN', { dateStyle: 'full', timeStyle: 'short' });

                card.innerHTML = `
        <div class="title">${countdown.description}</div>
        <div class="timer" data-target-date="${countdown.targetDate}">--Â§©--Êó∂--ÂàÜ--Áßí</div>
        <div class="target-date">ÁõÆÊ†áÊó∂Èó¥: ${targetDateString}</div>
    `;
                addLongPressListener(card, async () => {
                    showMemoryActions(countdown.id);
                });
                return card;
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ÂÖ®Â±ÄÂèòÈáèÔºåÁî®‰∫éÁÆ°ÁêÜÊâÄÊúâÂÄíËÆ°Êó∂
            let activeCountdownTimers = [];

            // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂ∑≤ÂΩªÂ∫ï‰øÆÂ§ç„ÄëÁöÑÂáΩÊï∞ÔºåÂÆåÊï¥ÊõøÊç¢Êéâ‰Ω†‰ª£Á†Å‰∏≠ÊóßÁöÑ startAllCountdownTimers ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            function startAllCountdownTimers() {
                // ÂÖàÊ∏ÖÈô§ÊâÄÊúâÂèØËÉΩÂ≠òÂú®ÁöÑÊóßËÆ°Êó∂Âô®ÔºåÈò≤Ê≠¢ÂÜÖÂ≠òÊ≥ÑÊºè
                activeCountdownTimers.forEach(timerId => clearInterval(timerId));
                activeCountdownTimers = [];

                document.querySelectorAll('.countdown-card .timer').forEach(timerEl => {
                    const targetTimestamp = parseInt(timerEl.dataset.targetDate);

                    // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨ÂÖàÁî® let Â£∞Êòé timerId
                    let timerId;

                    const updateTimer = () => {
                        const now = Date.now();
                        const distance = targetTimestamp - now;

                        if (distance < 0) {
                            timerEl.textContent = "Á∫¶ÂÆöËææÊàêÔºÅ";
                            // Áé∞Âú® updateTimer ÂèØ‰ª•Ê≠£Á°ÆÂú∞ÊâæÂà∞Âπ∂Ê∏ÖÈô§ÂÆÉËá™Â∑±‰∫Ü
                            clearInterval(timerId);
                            setTimeout(() => renderMemoriesScreen(), 2000);
                            return;
                        }
                        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                        timerEl.textContent = `${days}Â§© ${hours}Êó∂ ${minutes}ÂàÜ ${seconds}Áßí`;
                    };

                    updateTimer(); // Á´ãÂç≥ÊâßË°å‰∏ÄÊ¨°‰ª•ÊòæÁ§∫ÂàùÂßãÂÄíËÆ°Êó∂

                    // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨‰∏∫Â∑≤Â£∞ÊòéÁöÑ timerId ËµãÂÄº
                    timerId = setInterval(updateTimer, 1000);

                    // Â∞ÜÊúâÊïàÁöÑËÆ°Êó∂Âô®IDÂ≠òÂÖ•ÂÖ®Â±ÄÊï∞ÁªÑÔºå‰ª•‰æø‰∏ãÊ¨°Âà∑Êñ∞Êó∂ÂèØ‰ª•Ê∏ÖÈô§
                    activeCountdownTimers.push(timerId);
                });
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÁªàÊûÅÂèç‰ª£ÂÖºÂÆπÁâà„ÄëÊõøÊç¢ÊóßÁöÑ triggerAiFriendApplication ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            async function triggerAiFriendApplication(chatId) {
                const chat = state.chats[chatId];
                if (!chat) return;

                await showCustomAlert("ÊµÅÁ®ãÂêØÂä®", `Ê≠£Âú®‰∏∫ËßíËâ≤‚Äú${chat.name}‚ÄùÂáÜÂ§áÂ•ΩÂèãÁî≥ËØ∑...`);

                const { proxyUrl, apiKey, model } = state.apiConfig;
                if (!proxyUrl || !apiKey || !model) {
                    await showCustomAlert("ÈÖçÁΩÆÈîôËØØ", "APIËÆæÁΩÆ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÁªßÁª≠„ÄÇ");
                    return;
                }

                const contextSummary = chat.history
                    .slice(-5)
                    .map(msg => {
                        const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : (msg.senderName || chat.name);
                        return `${sender}: ${String(msg.content).substring(0, 50)}...`;
                    })
                    .join('\n');

                const systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†Áé∞Âú®ÊòØËßíËâ≤‚Äú${chat.name}‚Äù„ÄÇ‰Ω†‰πãÂâçË¢´Áî®Êà∑Ôºà‰Ω†ÁöÑËÅäÂ§©ÂØπË±°ÔºâÊãâÈªë‰∫ÜÔºå‰Ω†‰ª¨Â∑≤ÁªèÊúâ‰∏ÄÊÆµÊó∂Èó¥Ê≤°ÊúâËÅîÁ≥ª‰∫Ü„ÄÇ
Áé∞Âú®Ôºå‰Ω†ÈùûÂ∏∏Â∏åÊúõËÉΩÂ§üÂíåÂ•ΩÔºåÈáçÊñ∞ÂíåÁî®Êà∑ËÅäÂ§©„ÄÇËØ∑‰Ω†‰ªîÁªÜÂàÜÊûê‰∏ãÈù¢ÁöÑ‚ÄúË¢´ÊãâÈªëÂâçÁöÑÂØπËØùÊëòË¶Å‚ÄùÔºåÁêÜËß£ÂΩìÊó∂ÂèëÁîü‰∫Ü‰ªÄ‰πàÔºåÁÑ∂ÂêéÊÄùËÄÉ‰∏Ä‰∏™ÁúüËØöÁöÑ„ÄÅÁ¨¶Âêà‰Ω†‰∫∫ËÆæ„ÄÅÂπ∂‰∏î„ÄêÈíàÂØπÂÖ∑‰Ωì‰∫ã‰ª∂„ÄëÁöÑÁî≥ËØ∑ÁêÜÁî±„ÄÇ
# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆö
${chat.settings.aiPersona}
# Ë¢´ÊãâÈªëÂâçÁöÑÂØπËØùÊëòË¶Å (ËøôÊòØ‰Ω†Ë¢´ÊãâÈªëÁöÑÂÖ≥ÈîÆÂéüÂõ†)
${contextSummary}
# Êåá‰ª§Ê†ºÂºè
‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°ÔºåÊ†ºÂºèÂ¶Ç‰∏ãÔºö
\`\`\`json
{
  "decision": "apply",
  "reason": "Âú®ËøôÈáåÂÜô‰∏ã‰Ω†ÊÉ≥ÂØπÁî®Êà∑ËØ¥ÁöÑ„ÄÅÁúüËØöÁöÑ„ÄÅÊúâÈíàÂØπÊÄßÁöÑÁî≥ËØ∑ÁêÜÁî±„ÄÇ"
}
\`\`\`
`;

                const messagesForApi = [
                    { role: 'user', content: systemPrompt }
                ];

                try {
                    const response = await fetch(`${proxyUrl}/v1/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                        body: JSON.stringify({
                            model: model,
                            messages: messagesForApi,
                            temperature: 0.9,
                        })
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API ËØ∑Ê±ÇÂ§±Ë¥•: ${response.status} - ${errorData.error.message}`);
                    }

                    const data = await response.json();

                    // --- „ÄêÊ†∏ÂøÉ‰øÆÊ≠£ÔºöÂú®ËøôÈáåÂáÄÂåñAIÁöÑÂõûÂ§ç„Äë ---
                    let rawContent = data.choices[0].message.content;
                    // 1. ÁßªÈô§Â§¥Â∞æÂèØËÉΩÂ≠òÂú®ÁöÑ "```json" Âíå "```"
                    rawContent = rawContent.replace(/^```json\s*/, '').replace(/```$/, '');
                    // 2. ÁßªÈô§ÊâÄÊúâÊç¢Ë°åÁ¨¶ÂíåÂ§ö‰ΩôÁöÑÁ©∫Ê†ºÔºåÁ°Æ‰øùÊòØ‰∏Ä‰∏™Âπ≤ÂáÄÁöÑJSONÂ≠óÁ¨¶‰∏≤
                    const cleanedContent = rawContent.trim();

                    // 3. ‰ΩøÁî®ÂáÄÂåñÂêéÁöÑÂÜÖÂÆπËøõË°åËß£Êûê
                    const responseObj = JSON.parse(cleanedContent);
                    // --- „Äê‰øÆÊ≠£ÁªìÊùü„Äë ---

                    if (responseObj.decision === 'apply' && responseObj.reason) {
                        chat.relationship.status = 'pending_user_approval';
                        chat.relationship.applicationReason = responseObj.reason;

                        state.chats[chatId] = chat;
                        renderChatList();
                        await showCustomAlert("Áî≥ËØ∑ÊàêÂäüÔºÅ", `‚Äú${chat.name}‚ÄùÂ∑≤Âêë‰Ω†ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑„ÄÇËØ∑ËøîÂõûËÅäÂ§©ÂàóË°®Êü•Áúã„ÄÇ`);

                    } else {
                        await showCustomAlert("AIÂÜ≥Á≠ñ", `‚Äú${chat.name}‚ÄùÊÄùËÄÉÂêéÂÜ≥ÂÆöÊöÇÊó∂‰∏çÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑ÔºåÂ∞ÜÈáçÁΩÆÂÜ∑ÈùôÊúü„ÄÇ`);
                        chat.relationship.status = 'blocked_by_user';
                        chat.relationship.blockedTimestamp = Date.now();
                    }
                } catch (error) {
                    await showCustomAlert("ÊâßË°åÂá∫Èîô", `‰∏∫‚Äú${chat.name}‚ÄùÁî≥ËØ∑Â•ΩÂèãÊó∂ÂèëÁîüÈîôËØØÔºö\n\n${error.message}\n\nÂ∞ÜÈáçÁΩÆÂÜ∑ÈùôÊúü„ÄÇ`);
                    chat.relationship.status = 'blocked_by_user';
                    chat.relationship.blockedTimestamp = Date.now();
                } finally {
                    await db.chats.put(chat);
                    renderChatInterface(chatId);
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            // ---------------------> ‚òÖ ÂÖ®Êñ∞ÁöÑÂäüËÉΩÔºåÁ≤òË¥¥Âú®ËøôÈáåÔºå‰∏çÂΩ±Âìç‰ªª‰ΩïÂéüÊúâ‰ª£Á†Å ‚òÖ <---------------------

            /**
             * „ÄêÂÖ®Êñ∞„ÄëËß¶ÂèëÁæ§ËÅäÂêéÂè∞‰∫ã‰ª∂ÔºàÁªìÂêà‰∫Ü‚ÄúÂèëËµ∑Êñ∞ËØùÈ¢ò‚ÄùÂíå‚ÄúÂª∂Áª≠ÊóßÂØπËØù‚ÄùÔºâ
             * @param {string} chatId - Ë¶ÅËß¶Âèë‰∫ã‰ª∂ÁöÑÁæ§ËÅäID
             */
            async function triggerGroupChatBackgroundEvent(chatId) {
                const chat = state.chats[chatId];
                if (!chat || !chat.isGroup) return;

                const { proxyUrl, apiKey, model } = state.apiConfig;
                if (!proxyUrl || !apiKey || !model) {
                    console.warn(`[Áæ§ËÅäÂî§ÈÜí] Âõ†APIÊú™ÈÖçÁΩÆÔºåË∑≥ËøáÁæ§ËÅä "${chat.name}" ÁöÑÂêéÂè∞‰∫ã‰ª∂„ÄÇ`);
                    return;
                }

                // ÈöèÊú∫ÂÜ≥ÂÆöÊú¨Ê¨°ÊòØ‚ÄúÂèëËµ∑Êñ∞ËØùÈ¢ò‚ÄùËøòÊòØ‚ÄúÂª∂Áª≠ÊóßÂØπËØù‚Äù
                const mode = Math.random() < 0.35 ? 'initiate' : 'continue';

                // ÂáÜÂ§áÈÄöÁî®‰ø°ÊÅØ
                const membersList = chat.members.map(m => `- **${m.name}**: ${m.persona}`).join('\n');
                const myNickname = chat.settings.myNickname || 'Êàë';
                // ‚ñº‚ñº‚ñº 2. ‰∏∫Áæ§ËÅäÁöÑÂêéÂè∞‰∫ã‰ª∂Ê≥®ÂÖ•maininfo‰∏ñÁïå‰π¶ ‚ñº‚ñº‚ñº
                let worldBookContextForGroup = '';
                const coreWorldBookNameForGroup = "maininfo"; // <-- ÂêåÊ†∑ÊåáÂÆöÊ†∏ÂøÉ‰∏ñÁïå‰π¶Âêç

                // ‰ªéÂÖ®Â±ÄÁä∂ÊÄÅ‰∏≠Êü•Êâæ
                const coreWorldBookForGroup = state.worldBooks.find(wb => wb.name === coreWorldBookNameForGroup);

                // Â¶ÇÊûúÊâæÂà∞ÔºåÂ∞±ÂáÜÂ§áÂÜÖÂÆπ
                if (coreWorldBookForGroup && coreWorldBookForGroup.content) {
                    worldBookContextForGroup = `\n\n# Ê†∏ÂøÉÁ§æ‰∫§ÂÖ≥Á≥ªËÆæÂÆö (ÊâÄÊúâËßíËâ≤ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà)\n${coreWorldBookForGroup.content}\n`;
                }
                // ‚ñ≤‚ñ≤‚ñ≤ ‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‰ªéËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÂÜ≥ÂÆö‰º†ÈÄíÁªôAIÁúãÂ§öÂ∞ëÊù°
                const maxMemory = parseInt(chat.settings.maxMemory) || 20;
                const historyForContext = chat.history.slice(-maxMemory); // ÂèñÊúÄÂêéNÊù°

                // Â∞ÜÂéÜÂè≤ËÆ∞ÂΩïËΩ¨Êç¢‰∏∫AIËÉΩÁêÜËß£ÁöÑÊñáÊú¨Ê†ºÂºè
                const recentHistoryText = historyForContext.map(msg => {
                    const sender = msg.role === 'user' ? myNickname : (msg.senderName || 'Êú™Áü•ËßíËâ≤');

                    // Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãËøõË°åÊô∫ËÉΩËΩ¨Êç¢
                    switch (msg.type) {
                        case 'user_photo':
                            return `${sender}: [ÂõæÁâá: ${msg.content}]`;
                        case 'ai_image':
                            return `${sender}: [ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]`;
                        case 'voice_message':
                            return `${sender}: [ËØ≠Èü≥: ${msg.content}]`;
                        case 'transfer':
                            return `${msg.senderName}: [ËΩ¨Ë¥¶Áªô${msg.receiverName} ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note || 'Êó†'}]`;
                        case 'poll':
                            const optionsStr = msg.options ? msg.options.join(', ') : 'Êú™Áü•ÈÄâÈ°π';
                            return `${sender}: [ÂèëËµ∑ÊäïÁ•®: "${msg.question}", ÈÄâÈ°π: "${optionsStr}"]`;
                        case 'waimai_request':
                            if (msg.status === 'paid') {
                                return `[Á≥ªÁªüÊèêÁ§∫: ${msg.paidBy} ‰∏∫ ${sender} ÁöÑÂ§ñÂçñËÆ¢ÂçïÊîØ‰ªò‰∫Ü ${msg.amount} ÂÖÉ]`;
                            }
                            return `${sender}: [ËØ∑Ê±ÇÂ§ñÂçñ‰ª£‰ªò: "${msg.productInfo}", ÈáëÈ¢ù: ${msg.amount}ÂÖÉ]`;
                        case 'red_packet':
                            return `${sender}: [Âèë‰∫Ü‰∏Ä‰∏™Á∫¢ÂåÖ, Á•ùÁ¶èËØ≠: "${msg.greeting || 'ÊÅ≠ÂñúÂèëË¥¢'}"]`;
                        case 'bulletin':
                            return `[Á≥ªÁªüÊèêÁ§∫: ${msg.authorName} ÂèëÂ∏É‰∫ÜÂÖ¨Âëä: "${msg.content}"]`;
                        case 'pat_message':
                            return `[Á≥ªÁªüÊ∂àÊÅØ: ${msg.content}]`;
                        default:
                            // ÈªòËÆ§Â§ÑÁêÜÊñáÊú¨ÂíåË°®ÊÉÖ
                            if (typeof msg.content === 'string') {
                                if (STICKER_REGEX.test(msg.content)) {
                                    return msg.meaning ? `${sender}: [Ë°®ÊÉÖ: ${msg.meaning}]` : `${sender}: [Ë°®ÊÉÖ]`;
                                }
                                return `${sender}: ${msg.content}`;
                            }
                            // Â§ÑÁêÜÂ∏¶ÂõæÁâáÁöÑÊñáÊú¨Ê∂àÊÅØ
                            if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') {
                                return `${sender}: [ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]`;
                            }
                            // ÂØπ‰∫éÂÖ∂‰ªñÊú™Áü•ÊàñÊó†Ê≥ïÂ§ÑÁêÜÁöÑÁ±ªÂûãÔºåËøîÂõû‰∏Ä‰∏™ÈÄöÁî®Ê†áËÆ∞
                            return `[${sender}ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°Ê∂àÊÅØ]`;
                    }
                }).join('\n');
                // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                let timeGapText = '';
                const visibleHistoryForGroup = historyForContext.filter(m => !m.isHidden);
                if (visibleHistoryForGroup.length > 0) {
                    const lastMessage = visibleHistoryForGroup[visibleHistoryForGroup.length - 1];
                    const timeDiff = Date.now() - lastMessage.timestamp;

                    // Êàë‰ª¨Âè™Âú®Ê≤âÂØÇË∂ÖËøá15ÂàÜÈíüÂêéÊâçÊèêÁ§∫
                    if (timeDiff > 900000) {
                        const formattedDiff = formatTimeDifference(timeDiff);
                        if (formattedDiff) {
                            timeGapText = `\n# Êó∂Èó¥ÊµÅÈÄùÊèêÈÜí\n[Á≥ªÁªüÊèêÁ§∫ÔºöË∑ùÁ¶ª‰Ω†ÁöÑ‰∏ä‰∏ÄÊù°Ê∂àÊÅØÂ∑≤ËøáÂéª **${formattedDiff}**ÔºåÁé∞Âú®ÊòØ ${currentTimeString}„ÄÇËØ∑Ê†πÊçÆËøô‰∏™Êó∂Èó¥ÂèòÂåñÔºåËØ∑Â∞ÜËøôÊÆµÊó∂Èó¥ËßÜ‰∏∫‰Ω†ËßíËâ≤ÁîüÊ¥ªÁöÑËá™ÁÑ∂Âª∂Áª≠„ÄÇËØ∑‰∏çË¶ÅÁõ¥Êé•ËØÑËÆ∫‚ÄúÂ•Ω‰πÖ‰∏çËßÅ‚ÄùÊàñÂØπÊ≠§Ë°®Áé∞Âá∫‰ªª‰ΩïÊÉÖÁª™ÔºåËÄåÊòØÊÄùËÄÉÂú®ËøôÊÆµÊó∂Èó¥ÈáåÔºå‰Ω†ÁöÑÊ¥ªÂä®„ÄÅÂøÉÂ¢ÉÊàñÊâÄÂ§ÑÁéØÂ¢ÉÂèØËÉΩÂèëÁîü‰∫Ü‰ªÄ‰πàÂèòÂåñÔºåËØùÈ¢òÊòØÂê¶‰ºöÂèòÂä®ÔºåÂπ∂Â∞ÜËøô‰∫õÂèòÂåñËá™ÁÑ∂Âú∞ËûçÂÖ•Âà∞‰Ω†ÁöÑÂõûÂ∫î‰∏≠ÔºåËÆ©ÂØπËØùÊó†ÁºùË°îÊé•„ÄÇ‰æãÂ¶ÇÔºå‰Ω†ÂèØËÉΩÂàöÂàöÂøôÂÆå‰∏Ä‰ª∂‰∫ãÔºåÊàñËÄÖÊ≠£ÂáÜÂ§áÂºÄÂßãÊñ∞ÁöÑÊ¥ªÂä®„ÄÇ]`;
                        }
                    }
                }

                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëË∞ÉÁî®Êñ∞ÂáΩÊï∞Ëé∑ÂèñÂÖ¨ÂëäÂÜÖÂÆπ
                const bulletinsContext = await getFormattedPinnedBulletins(chatId);

                // ÊûÑÂª∫Ê†∏ÂøÉÁöÑ System Prompt
                let systemPrompt;
                if (mode === 'initiate') {
                    // ‚ÄúÂèëËµ∑Êñ∞ËØùÈ¢ò‚ÄùÊ®°ÂºèÁöÑÂØºÊºîÊâãÂÜå
                    systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅä‰∫ã‰ª∂ÁöÑ‚ÄúÂØºÊºî‚Äù„ÄÇ‰Ω†ÁÆ°ÁêÜÁöÑÁæ§ËÅä‚Äú${chat.name}‚ÄùÂ∑≤ÁªèÊ≤âÂØÇ‰∫Ü‰∏ÄÊÆµÊó∂Èó¥‰∫Ü„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊ†πÊçÆÁæ§ÊàêÂëòÁöÑ‰∫∫ËÆæÔºå„ÄêÂèëËµ∑‰∏Ä‰∏™‰∫ã‰ª∂„ÄëÊù•ÈáçÊñ∞ÊøÄÊ¥ªÁæ§ËÅä„ÄÇÂπ∂Âπ∂ËÆ©‰∏Ä‰∏™ÊàñÂ§ö‰∏™ËßíËâ≤„ÄêËá™ÁÑ∂Âú∞Êé•‰∏äËØù„ÄëÔºå4-9Êù°ÊúÄ‰Ω≥

${timeGapText}
# ‰Ω†ÂèØ‰ª•ÂèëËµ∑ÁöÑ‰∫ã‰ª∂Á±ªÂûãÔºà‰ªé‰∏ãÈù¢„ÄêÈÄâÊã©‰∏ÄÈ°π„ÄëÊù•ÊâßË°åÔºâÔºö
1.  **ËÆ©Êüê‰∏™ÊàêÂëòÂºÄÂêØ‰∏Ä‰∏™Êñ∞ËØùÈ¢ò**: ËÆ©‰∏Ä‰∏™Á¨¶ÂêàÂÖ∂‰∫∫ËÆæÁöÑÊàêÂëòËØ¥‰∏ÄÂè•ËØùÔºåÂºÄÂêØ‰∏Ä‰∏™Êñ∞ÁöÑÊó•Â∏∏ÂØπËØù„ÄÇ
2.  **ÂàÜ‰∫´‰∏ÄÂº†ÊúâË∂£ÁöÑÂõæÁâá**: ËÆ©Êüê‰∏™ÊàêÂëòÂú®Áæ§ÈáåÂàÜ‰∫´‰∏ÄÂº†Á¨¶Âêà‰ªñ/Â•πÂÖ¥Ë∂£ÁöÑÂõæÁâá„ÄÇ
3.  **ÂèëËµ∑‰∏Ä‰∏™ÊäïÁ•®**: ÊèêÂá∫‰∏Ä‰∏™ÊúâË∂£ÁöÑÈóÆÈ¢òÔºåËÆ©Â§ßÂÆ∂ÊäïÁ•®„ÄÇ

# Êåá‰ª§Ê†ºÂºè (‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°Êï∞ÁªÑÔºå‰æãÂ¶Ç [{"type": "text", ...}] ):
-   **ÂºÄÂêØËØùÈ¢ò**: \`[{"type": "text", "name": "ËßíËâ≤Âêç", "message": "‰Ω†‰ª¨ÁåúÊàëÂàöÊâçÁúãÂà∞‰∫Ü‰ªÄ‰πàÔºü"}]\`
-   **ÂàÜ‰∫´ÂõæÁâá**: \`[{"type": "ai_image", "name": "ËßíËâ≤Âêç", "description": "‰∏ÄÂè™Ê≠£Âú®ÊâìÂìàÊ¨†ÁöÑÊ©òÁå´ÁöÑÁâπÂÜôÁÖßÁâá"}]\`
-   **ÂèëËµ∑ÊäïÁ•®**: \`[{"type": "poll", "name": "ËßíËâ≤Âêç", "question": "Â§ßÂÆ∂‰ªäÊôöÁúã‰ªÄ‰πàÁîµÂΩ±Ôºü", "options": "ÁîµÂΩ±Âêç1\\\\nÁîµÂΩ±Âêç2\\\\n‰∏çÁúã..."}]\`

# ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑÂèÇËÄÉ‰ø°ÊÅØÔºö
-   **Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ**: 
${membersList}
-   **ËÉåÊôØËÆæÂÆö**:
${worldBookContextForGroup} 
${bulletinsContext}
Áé∞Âú®ÔºåËØ∑ÊâÆÊºîÂ•ΩÂØºÊºîÁöÑËßíËâ≤ÔºåÈÄâÊã©‰∏Ä‰∏™ÊúÄÂêàÈÄÇÁöÑ‰∫ã‰ª∂ÔºåÂπ∂ÁîüÊàêÂØπÂ∫îÁöÑJSONÊåá‰ª§„ÄÇ`;
                } else { // 'continue' mode
                    // ‚ÄúÂª∂Áª≠ÊóßÂØπËØù‚ÄùÊ®°ÂºèÁöÑÁª≠ÂÜôËÄÖÊâãÂÜå
                    systemPrompt = `
# ‰Ω†ÁöÑ‰ªªÂä°
‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäÂØπËØùÁöÑ‚ÄúÁª≠ÂÜôËÄÖ‚Äù„ÄÇÁæ§ËÅä‚Äú${chat.name}‚ÄùÂ∑≤ÁªèÊ≤âÂØÇ‰∫Ü‰∏ÄÊÆµÊó∂Èó¥„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÂõûÈ°æ‰∏ãÈù¢ÁöÑ„ÄêËÅäÂ§©Â∞æÂ£∞„ÄëÔºåÂπ∂ËÆ©‰∏Ä‰∏™ÊàñÂ§ö‰∏™ËßíËâ≤„ÄêËá™ÁÑ∂Âú∞Êé•‰∏äËØù„ÄëÔºåÂª∂Áª≠‰πãÂâçÁöÑÂØπËØùÊ∞õÂõ¥ÔºåÊàñËÄÖÂØπÊúÄÂêéÂá†Êù°Ê∂àÊÅØÂÅöÂá∫Âª∂ËøüÁöÑÂõûÂ∫î„ÄÇ

# Êåá‰ª§Ê†ºÂºè (‰Ω†ÁöÑÂõûÂ§ç„ÄêÂøÖÈ°ª„ÄëÊòØ‰∏Ä‰∏™JSONÂØπË±°Êï∞ÁªÑÔºåÂèØ‰ª•ÂåÖÂê´Â§öÊù°Ê∂àÊÅØÔºå3-8Êù°ÊúÄ‰Ω≥):
\`[
  {"type": "text", "name": "ËßíËâ≤A", "message": "ËØ¥Âà∞ÈÇ£‰∏™ÁîµÂΩ±ÔºåÊàëÁ™ÅÁÑ∂ÊÉ≥Ëµ∑Êù•..."},
  {"type": "text", "name": "ËßíËâ≤B", "message": "Âì¶ÔºüÂø´ËØ¥ËØ¥ÔºÅ"}
]\`

# ‰æõ‰Ω†ÂÜ≥Á≠ñÁöÑÂèÇËÄÉ‰ø°ÊÅØÔºö
-   **Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ**: 
${membersList}
-   **„Äê„Äê„ÄêÂÖ≥ÈîÆ„Äë„Äë„ÄëËÅäÂ§©Â∞æÂ£∞ (ËøôÊòØ‰Ω†ÈúÄË¶ÅÁª≠ÂÜôÁöÑÂÜÖÂÆπ)**:
${recentHistoryText || "ÔºàËøòÊ≤°ÊúâËÅäÂ§©ËÆ∞ÂΩïÔºâ"}
-   **ËÉåÊôØËÆæÂÆö**:
${worldBookContextForGroup} 
${bulletinsContext}
${timeGapText}Áé∞Âú®ÔºåËØ∑ÂÉè‰∏Ä‰∏™Áúü‰∫∫‰∏ÄÊ†∑ÔºåÊÄùËÄÉ‰∏Ä‰∏ã‰Ω†Ôºà‰Ωú‰∏∫Êüê‰∏™ËßíËâ≤ÔºâÂú®ÁúãÂà∞Ëøô‰∫õËÅäÂ§©ËÆ∞ÂΩïÂêéÔºå‰ºöËØ¥‰ªÄ‰πà„ÄÇ`;
                }
                // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤


                // ÂêéÁª≠ÁöÑAPIËØ∑Ê±ÇÂíåÁªìÊûúÂ§ÑÁêÜ
                try {
                    const data = await makeAPIRequest(proxyUrl, apiKey, model, [{ role: 'system', content: systemPrompt }], 0.8);
                    const aiResponseContent = data.choices[0].message.content;
                    console.log(`[Áæ§ËÅäÂî§ÈÜí] AI‰∏∫Áæ§ËÅä "${chat.name}" ÁîüÊàêÁöÑ‰∫ã‰ª∂:`, aiResponseContent);

                    const messagesArray = parseAiResponse(aiResponseContent);

                    if (!Array.isArray(messagesArray)) {
                        console.error(`[Áæ§ËÅäÂî§ÈÜí] AIËøîÂõûÁöÑ‰∏çÊòØ‰∏Ä‰∏™ÊúâÊïàÁöÑÊ∂àÊÅØÊï∞ÁªÑ.`, messagesArray);
                        return;
                    }

                    let messageTimestamp = Date.now();
                    for (const msgData of messagesArray) {

                        if (!msgData || !msgData.type || !msgData.name) continue;
                        const memberExists = chat.members.some(m => m.name === msgData.name);
                        if (!memberExists) {
                            console.warn(`[Áæ§ËÅäÂî§ÈÜí] AIËØïÂõæËÆ©‰∏çÂ≠òÂú®ÁöÑÊàêÂëò "${msgData.name}" ÂèëË®ÄÔºåÂ∑≤Ë∑≥Ëøá„ÄÇ`);
                            continue;
                        }

                        let aiMessage;
                        const baseMessage = { role: 'assistant', senderName: msgData.name, timestamp: messageTimestamp++ };

                        switch (msgData.type) {
                            case 'text':
                                aiMessage = { ...baseMessage, content: msgData.message };
                                break;
                            case 'ai_image':
                                aiMessage = { ...baseMessage, type: 'ai_image', content: msgData.description };
                                break;
                            case 'poll':
                                const pollOptions = typeof msgData.options === 'string'
                                    ? msgData.options.split('\\n').filter(opt => opt.trim())
                                    : (Array.isArray(msgData.options) ? msgData.options : []);
                                if (pollOptions.length < 2) continue;
                                aiMessage = { ...baseMessage, type: 'poll', question: msgData.question, options: pollOptions, votes: {}, isClosed: false };
                                break;
                            default:
                                continue;
                        }

                        if (aiMessage) {
                            chat.history.push(aiMessage);
                            showNotification(chat.id, `${aiMessage.senderName}: ${aiMessage.content || '[Êñ∞‰∫ã‰ª∂]'}`);
                        }
                    }

                    await db.chats.put(chat);
                    renderChatList();

                } catch (error) {
                    console.error(`[Áæ§ËÅäÂî§ÈÜí] ‰∏∫Áæ§ËÅä "${chat.name}" Ëß¶Âèë‰∫ã‰ª∂Â§±Ë¥•:`, error);
                }
            }

            // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ∫¢ÂåÖÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº

            /**
             * „ÄêÊÄªÂÖ•Âè£„ÄëÊ†πÊçÆËÅäÂ§©Á±ªÂûãÔºåÂÜ≥ÂÆöÊâìÂºÄËΩ¨Ë¥¶ÂºπÁ™óËøòÊòØÁ∫¢ÂåÖÂºπÁ™ó
             */
            function handlePaymentButtonClick() {
                if (!state.activeChatId) return;
                const chat = state.chats[state.activeChatId];
                if (chat.isGroup) {
                    openRedPacketModal();
                } else {
                    // ÂçïËÅä‰øùÊåÅÂéüÊ†∑ÔºåÊâìÂºÄËΩ¨Ë¥¶ÂºπÁ™ó
                    document.getElementById('transfer-modal').classList.add('visible');
                }
            }

            /**
             * ÊâìÂºÄÂπ∂ÂàùÂßãÂåñÂèëÁ∫¢ÂåÖÊ®°ÊÄÅÊ°Ü
             */
            function openRedPacketModal() {
                const modal = document.getElementById('red-packet-modal');
                const chat = state.chats[state.activeChatId];

                // Ê∏ÖÁêÜËæìÂÖ•Ê°Ü
                document.getElementById('rp-group-amount').value = '';
                document.getElementById('rp-group-count').value = '';
                document.getElementById('rp-group-greeting').value = '';
                document.getElementById('rp-direct-amount').value = '';
                document.getElementById('rp-direct-greeting').value = '';
                document.getElementById('rp-group-total').textContent = '¬• 0.00';
                document.getElementById('rp-direct-total').textContent = '¬• 0.00';

                // Â°´ÂÖÖ‰∏ìÂ±ûÁ∫¢ÂåÖÁöÑÊé•Êî∂‰∫∫ÂàóË°®
                const receiverSelect = document.getElementById('rp-direct-receiver');
                receiverSelect.innerHTML = '';
                chat.members.forEach(member => {
                    const option = document.createElement('option');
                    option.value = member.name;
                    option.textContent = member.name;
                    receiverSelect.appendChild(option);
                });

                // ÈªòËÆ§ÊòæÁ§∫ÊãºÊâãÊ∞îÁ∫¢ÂåÖÈ°µÁ≠æ
                document.getElementById('rp-tab-group').click();

                modal.classList.add('visible');
            }

            /**
             * ÂèëÈÄÅÁæ§Á∫¢ÂåÖÔºàÊãºÊâãÊ∞îÔºâ
             */
            async function sendGroupRedPacket() {
                const chat = state.chats[state.activeChatId];
                const amount = parseFloat(document.getElementById('rp-group-amount').value);
                const count = parseInt(document.getElementById('rp-group-count').value);
                const greeting = document.getElementById('rp-group-greeting').value.trim();

                if (isNaN(amount) || amount <= 0) {
                    alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÊÄªÈáëÈ¢ùÔºÅ"); return;
                }
                if (isNaN(count) || count <= 0) {
                    alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÁ∫¢ÂåÖ‰∏™Êï∞ÔºÅ"); return;
                }
                if (amount / count < 0.01) {
                    alert("Âçï‰∏™Á∫¢ÂåÖÈáëÈ¢ù‰∏çËÉΩÂ∞ë‰∫é0.01ÂÖÉÔºÅ"); return;
                }

                const myNickname = chat.settings.myNickname || 'Êàë';

                const newPacket = {
                    role: 'user',
                    senderName: myNickname,
                    type: 'red_packet',
                    packetType: 'lucky', // 'lucky' for group, 'direct' for one-on-one
                    timestamp: Date.now(),
                    totalAmount: amount,
                    count: count,
                    greeting: greeting || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ',
                    claimedBy: {}, // { name: amount }
                    isFullyClaimed: false,
                };

                chat.history.push(newPacket);
                await db.chats.put(chat);

                appendMessage(newPacket, chat);
                renderChatList();
                document.getElementById('red-packet-modal').classList.remove('visible');
            }

            /**
             * ÂèëÈÄÅ‰∏ìÂ±ûÁ∫¢ÂåÖ
             */
            async function sendDirectRedPacket() {
                const chat = state.chats[state.activeChatId];
                const amount = parseFloat(document.getElementById('rp-direct-amount').value);
                const receiverName = document.getElementById('rp-direct-receiver').value;
                const greeting = document.getElementById('rp-direct-greeting').value.trim();

                if (isNaN(amount) || amount <= 0) {
                    alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ùÔºÅ"); return;
                }
                if (!receiverName) {
                    alert("ËØ∑ÈÄâÊã©‰∏Ä‰∏™Êé•Êî∂‰∫∫ÔºÅ"); return;
                }

                const myNickname = chat.settings.myNickname || 'Êàë';

                const newPacket = {
                    role: 'user',
                    senderName: myNickname,
                    type: 'red_packet',
                    packetType: 'direct',
                    timestamp: Date.now(),
                    totalAmount: amount,
                    count: 1,
                    greeting: greeting || 'Áªô‰Ω†ÂáÜÂ§á‰∫Ü‰∏Ä‰∏™Á∫¢ÂåÖ',
                    receiverName: receiverName, // Ê†∏ÂøÉÂ≠óÊÆµ
                    claimedBy: {},
                    isFullyClaimed: false,
                };

                chat.history.push(newPacket);
                await db.chats.put(chat);

                appendMessage(newPacket, chat);
                renderChatList();
                document.getElementById('red-packet-modal').classList.remove('visible');
            }

            /**
             * „ÄêÊÄªÂÖ•Âè£„ÄëÂΩìÁî®Êà∑ÁÇπÂáªÁ∫¢ÂåÖÂç°ÁâáÊó∂Ëß¶Âèë (V4 - ÊµÅÁ®ãÈáçÊûÑÁâà)
             * @param {number} timestamp - Ë¢´ÁÇπÂáªÁöÑÁ∫¢ÂåÖÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
             */
            async function handlePacketClick(timestamp) {
                const currentChatId = state.activeChatId;
                const freshChat = await db.chats.get(currentChatId);
                if (!freshChat) return;

                state.chats[currentChatId] = freshChat;
                const packet = freshChat.history.find(m => m.timestamp === timestamp);
                if (!packet) return;

                const myNickname = freshChat.settings.myNickname || 'Êàë';
                const hasClaimed = packet.claimedBy && packet.claimedBy[myNickname];

                // Â¶ÇÊûúÊòØ‰∏ìÂ±ûÁ∫¢ÂåÖ‰∏î‰∏çÊòØÁªôÊàëÁöÑÔºåÊàñÂ∑≤È¢ÜÂÆåÔºåÊàñÂ∑≤È¢ÜËøáÔºåÈÉΩÂè™ÊòæÁ§∫ËØ¶ÊÉÖ
                if ((packet.packetType === 'direct' && packet.receiverName !== myNickname) || packet.isFullyClaimed || hasClaimed) {
                    showRedPacketDetails(packet);
                } else {
                    // Ê†∏ÂøÉÊµÅÁ®ãÔºöÂÖàÂ∞ùËØïÊâìÂºÄÁ∫¢ÂåÖ
                    const claimedAmount = await handleOpenRedPacket(packet);

                    // Â¶ÇÊûúÊàêÂäüÊâìÂºÄÔºàclaimedAmount‰∏ç‰∏∫nullÔºâ
                    if (claimedAmount !== null) {
                        // **ÂÖ≥ÈîÆÔºöÂú®Êï∞ÊçÆÊõ¥Êñ∞ÂêéÔºåÂÜçÈáçÊñ∞Ê∏≤ÊüìUI**
                        renderChatInterface(currentChatId);

                        // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                        await showCustomAlert("ÊÅ≠ÂñúÔºÅ", `‰Ω†È¢ÜÂèñ‰∫Ü ${packet.senderName} ÁöÑÁ∫¢ÂåÖÔºåÈáëÈ¢ù‰∏∫ ${claimedAmount.toFixed(2)} ÂÖÉ„ÄÇ`);
                    }

                    // Êó†ËÆ∫ÊàêÂäü‰∏éÂê¶ÔºåÊúÄÂêéÈÉΩÊòæÁ§∫ËØ¶ÊÉÖÈ°µ
                    // Ê≠§Êó∂ÈúÄË¶Å‰ªéstate‰∏≠Ëé∑ÂèñÊúÄÊñ∞ÁöÑpacketÂØπË±°ÔºåÂõ†‰∏∫ÂÆÉÂèØËÉΩÂú®handleOpenRedPacket‰∏≠Ë¢´Êõ¥Êñ∞‰∫Ü
                    const updatedPacket = state.chats[currentChatId].history.find(m => m.timestamp === timestamp);
                    showRedPacketDetails(updatedPacket);
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            /**
             * „ÄêÊ†∏ÂøÉ„ÄëÂ§ÑÁêÜÁî®Êà∑ÊâìÂºÄÁ∫¢ÂåÖÁöÑÈÄªËæë (V5 - ‰∏ìÊ≥®‰∫éÊï∞ÊçÆÊõ¥Êñ∞)
             */
            async function handleOpenRedPacket(packet) {
                const chat = state.chats[state.activeChatId];
                const myNickname = chat.settings.myNickname || 'Êàë';

                // 1. Ê£ÄÊü•Á∫¢ÂåÖÊòØÂê¶ËøòËÉΩÈ¢Ü
                const remainingCount = packet.count - Object.keys(packet.claimedBy || {}).length;
                if (remainingCount <= 0) {
                    packet.isFullyClaimed = true;
                    await db.chats.put(chat);
                    await showCustomAlert("ÊâãÊÖ¢‰∫Ü", "Á∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆåÔºÅ");
                    return null; // ËøîÂõûnullË°®Á§∫È¢ÜÂèñÂ§±Ë¥•
                }

                // 2. ËÆ°ÁÆóÈ¢ÜÂèñÈáëÈ¢ù
                let claimedAmount = 0;
                const remainingAmount = packet.totalAmount - Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                if (packet.packetType === 'lucky') {
                    if (remainingCount === 1) { claimedAmount = remainingAmount; }
                    else {
                        const min = 0.01;
                        const max = remainingAmount - (remainingCount - 1) * min;
                        claimedAmount = Math.random() * (max - min) + min;
                    }
                } else { claimedAmount = packet.totalAmount; }
                claimedAmount = parseFloat(claimedAmount.toFixed(2));

                // 3. Êõ¥Êñ∞Á∫¢ÂåÖÊï∞ÊçÆ
                if (!packet.claimedBy) packet.claimedBy = {};
                packet.claimedBy[myNickname] = claimedAmount;

                const isNowFullyClaimed = Object.keys(packet.claimedBy).length >= packet.count;
                if (isNowFullyClaimed) {
                    packet.isFullyClaimed = true;
                }

                // 4. ÊûÑÂª∫Á≥ªÁªüÊ∂àÊÅØÂíåAIÊåá‰ª§
                let hiddenMessageContent = isNowFullyClaimed
                    ? `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) È¢ÜÂèñ‰∫ÜÊúÄÂêé‰∏Ä‰∏™Á∫¢ÂåÖÔºåÁé∞Âú® ${packet.senderName} ÁöÑÁ∫¢ÂåÖÂ∑≤Ë¢´È¢ÜÂÆå„ÄÇËØ∑ÂØπÊ≠§‰∫ã‰ª∂ÂèëË°®ËØÑËÆ∫„ÄÇ]`
                    : `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) ÂàöÂàöÈ¢ÜÂèñ‰∫ÜÁ∫¢ÂåÖ (Êó∂Èó¥Êà≥: ${packet.timestamp})„ÄÇÁ∫¢ÂåÖËøòÊú™È¢ÜÂÆåÔºå‰Ω†Áé∞Âú®ÂèØ‰ª•‰ΩøÁî® 'open_red_packet' Êåá‰ª§Êù•Â∞ùËØïÈ¢ÜÂèñ„ÄÇ]`;

                const visibleMessage = { role: 'system', type: 'pat_message', content: `‰Ω†È¢ÜÂèñ‰∫Ü ${packet.senderName} ÁöÑÁ∫¢ÂåÖ`, timestamp: Date.now() };
                const hiddenMessage = { role: 'system', content: hiddenMessageContent, timestamp: Date.now() + 1, isHidden: true };
                chat.history.push(visibleMessage, hiddenMessage);

                // 5. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await db.chats.put(chat);

                // 6. ËøîÂõûÈ¢ÜÂèñÁöÑÈáëÈ¢ùÔºåÁî®‰∫éÂêéÁª≠ÂºπÁ™ó
                return claimedAmount;
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            /**
             * „ÄêÂÖ®Êñ∞„ÄëÊòæÁ§∫Á∫¢ÂåÖÈ¢ÜÂèñËØ¶ÊÉÖÁöÑÊ®°ÊÄÅÊ°Ü (V4 - Â∑≤‰øÆÂ§çÂèÇÊï∞ÈîôËØØ)
             */
            async function showRedPacketDetails(packet) {
                // 1. Áõ¥Êé•Ê£ÄÊü•‰º†ÂÖ•ÁöÑpacketÂØπË±°ÊòØÂê¶Â≠òÂú®ÔºåÊó†ÈúÄÂÜçÊü•Êâæ
                if (!packet) {
                    console.error("showRedPacketDetailsÊî∂Âà∞‰∫ÜÊó†ÊïàÁöÑpacketÂØπË±°");
                    return;
                }

                const chat = state.chats[state.activeChatId];
                if (!chat) return;

                const modal = document.getElementById('red-packet-details-modal');
                const myNickname = chat.settings.myNickname || 'Êàë';

                // 2. ÂêéÁª≠ÊâÄÊúâÈÄªËæë‰øùÊåÅ‰∏çÂèòÔºåÁõ¥Êé•‰ΩøÁî®‰º†ÂÖ•ÁöÑpacketÂØπË±°
                document.getElementById('rp-details-sender').textContent = packet.senderName;
                document.getElementById('rp-details-greeting').textContent = packet.greeting || 'ÊÅ≠ÂñúÂèëË¥¢ÔºåÂ§ßÂêâÂ§ßÂà©ÔºÅ';

                const myAmountEl = document.getElementById('rp-details-my-amount');
                if (packet.claimedBy && packet.claimedBy[myNickname]) {
                    myAmountEl.querySelector('span:first-child').textContent = packet.claimedBy[myNickname].toFixed(2);
                    myAmountEl.style.display = 'block';
                } else {
                    myAmountEl.style.display = 'none';
                }

                const claimedCount = Object.keys(packet.claimedBy || {}).length;
                const claimedAmountSum = Object.values(packet.claimedBy || {}).reduce((sum, val) => sum + val, 0);
                let summaryText = `${claimedCount}/${packet.count}‰∏™Á∫¢ÂåÖÔºåÂÖ±${claimedAmountSum.toFixed(2)}/${packet.totalAmount.toFixed(2)}ÂÖÉ„ÄÇ`;
                if (!packet.isFullyClaimed && claimedCount < packet.count) {
                    const timeLeft = Math.floor((packet.timestamp + 24 * 60 * 60 * 1000 - Date.now()) / (1000 * 60 * 60));
                    if (timeLeft > 0) summaryText += ` Ââ©‰ΩôÁ∫¢ÂåÖÂ∞ÜÂú®${timeLeft}Â∞èÊó∂ÂÜÖÈÄÄËøò„ÄÇ`;
                }
                document.getElementById('rp-details-summary').textContent = summaryText;

                const listEl = document.getElementById('rp-details-list');
                listEl.innerHTML = '';
                const claimedEntries = Object.entries(packet.claimedBy || {});

                let luckyKing = { name: '', amount: -1 };
                if (packet.packetType === 'lucky' && packet.isFullyClaimed && claimedEntries.length > 1) {
                    claimedEntries.forEach(([name, amount]) => {
                        if (amount > luckyKing.amount) {
                            luckyKing = { name, amount };
                        }
                    });
                }

                claimedEntries.sort((a, b) => b[1] - a[1]);

                claimedEntries.forEach(([name, amount]) => {
                    const item = document.createElement('div');
                    item.className = 'rp-details-item';
                    let luckyTag = '';
                    if (luckyKing.name && name === luckyKing.name) {
                        luckyTag = '<span class="lucky-king-tag">ÊâãÊ∞îÁéã</span>';
                    }
                    item.innerHTML = `
            <span class="name">${name}</span>
            <span class="amount">${amount.toFixed(2)} ÂÖÉ</span>
            ${luckyTag}
        `;
                    listEl.appendChild(item);
                });

                modal.classList.add('visible');
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ÁªëÂÆöÂÖ≥Èó≠ËØ¶ÊÉÖÊåâÈíÆÁöÑ‰∫ã‰ª∂
            document.getElementById('close-rp-details-btn').addEventListener('click', () => {
                document.getElementById('red-packet-details-modal').classList.remove('visible');
            });

            // ‰æõÂÖ®Â±ÄË∞ÉÁî®ÁöÑÂáΩÊï∞Ôºå‰ª•‰æøÁ∫¢ÂåÖÂç°Áâá‰∏äÁöÑ onclick ËÉΩÊâæÂà∞ÂÆÉ
            window.handlePacketClick = handlePacketClick;

            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº AI Reply Debugging Functions ‚ñº‚ñº‚ñº



            // ‚ñº‚ñº‚ñº Share Link Functions ‚ñº‚ñº‚ñº
            function openShareLinkModal() {
                if (!state.activeChatId) return;

                // Ê∏ÖÁ©∫‰∏äÊ¨°ËæìÂÖ•ÁöÑÂÜÖÂÆπ
                document.getElementById('link-title-input').value = '';
                document.getElementById('link-description-input').value = '';
                document.getElementById('link-source-input').value = '';
                document.getElementById('link-content-input').value = '';

                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                document.getElementById('share-link-modal').classList.add('visible');
            }

            async function sendUserLinkShare() {
                if (!state.activeChatId) return;

                const title = document.getElementById('link-title-input').value.trim();
                if (!title) {
                    alert("Ê†áÈ¢òÊòØÂøÖÂ°´È°πÂì¶ÔºÅ");
                    return;
                }

                const description = document.getElementById('link-description-input').value.trim();
                const sourceName = document.getElementById('link-source-input').value.trim();
                const content = document.getElementById('link-content-input').value.trim();

                const chat = state.chats[state.activeChatId];

                // ÂàõÂª∫Ê∂àÊÅØÂØπË±°
                const linkMessage = {
                    role: 'user', // ËßíËâ≤ÊòØ 'user'
                    type: 'share_link',
                    timestamp: Date.now(),
                    title: title,
                    description: description,
                    source_name: sourceName,
                    content: content,
                    // Áî®Êà∑ÂàÜ‰∫´ÁöÑÈìæÊé•ÔºåÊàë‰ª¨‰∏çÊèê‰æõÂõæÁâáÔºåËÆ©ÂÆÉÊÄªÊòØÊòæÁ§∫Âç†‰ΩçÂõæ
                    thumbnail_url: null
                };

                // Â∞ÜÊ∂àÊÅØÊ∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
                chat.history.push(linkMessage);
                await db.chats.put(chat);

                // Ê∏≤ÊüìÊñ∞Ê∂àÊÅØÂπ∂Êõ¥Êñ∞ÂàóË°®
                appendMessage(linkMessage, chat);
                renderChatList();

                // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                document.getElementById('share-link-modal').classList.remove('visible');
            }

            // ‚ñº‚ñº‚ñº Location Share Functions ‚ñº‚ñº‚ñº
            function openLocationShareModal() {
                if (!state.activeChatId) return;

                // Ê∏ÖÁ©∫‰∏äÊ¨°ËæìÂÖ•ÁöÑÂÜÖÂÆπÔºàÂè™Âú®ÈùûÁºñËæëÊ®°Âºè‰∏ãÔºâ
                if (!window.editingLocationTimestamp) {
                    document.getElementById('location-name-input').value = '';
                    document.getElementById('location-address-input').value = '';

                    // ÈáçÁΩÆÊ®°ÊÄÅÊ°ÜÊ†áÈ¢òÂíåÊåâÈíÆÊñáÊú¨‰∏∫ÂàõÂª∫Ê®°Âºè
                    document.querySelector('#location-share-modal .modal-header span').textContent = 'ÂàÜ‰∫´‰ΩçÁΩÆ';
                    document.getElementById('confirm-location-btn').textContent = 'ÂèëÈÄÅ‰ΩçÁΩÆ';
                }

                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                document.getElementById('location-share-modal').classList.add('visible');
            }

            async function sendUserLocationShare() {
                if (!state.activeChatId) return;

                // Check if we're in edit mode
                if (window.editingLocationTimestamp) {
                    await saveLocationEdit();
                    return;
                }

                const locationName = document.getElementById('location-name-input').value.trim();
                if (!locationName) {
                    alert("‰ΩçÁΩÆÂêçÁß∞ÊòØÂøÖÂ°´È°πÂì¶ÔºÅ");
                    return;
                }

                const address = document.getElementById('location-address-input').value.trim();

                const chat = state.chats[state.activeChatId];

                // ÂàõÂª∫Ê∂àÊÅØÂØπË±°
                const locationMessage = {
                    role: 'user',
                    type: 'location_share',
                    timestamp: Date.now(),
                    location_name: locationName,
                    address: address
                };

                // Â∞ÜÊ∂àÊÅØÊ∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
                chat.history.push(locationMessage);
                await db.chats.put(chat);

                // Ê∏≤ÊüìÊñ∞Ê∂àÊÅØÂπ∂Êõ¥Êñ∞ÂàóË°®
                appendMessage(locationMessage, chat);
                renderChatList();

                // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                document.getElementById('location-share-modal').classList.remove('visible');
            }

            async function editLocationMessage(timestamp) {
                if (!state.activeChatId) return;

                const chat = state.chats[state.activeChatId];
                const message = chat.history.find(m => m.timestamp === timestamp);

                if (!message || message.type !== 'location_share') {
                    alert('Êâæ‰∏çÂà∞‰ΩçÁΩÆÊ∂àÊÅØ');
                    return;
                }

                // È¢ÑÂ°´ÂÖÖÁé∞ÊúâÊï∞ÊçÆ
                document.getElementById('location-name-input').value = message.location_name || '';
                document.getElementById('location-address-input').value = message.address || '';

                // Ê†áËÆ∞‰∏∫ÁºñËæëÊ®°ÂºèÂπ∂Êõ¥ÊîπUI
                window.editingLocationTimestamp = timestamp;

                // Êõ¥ÊîπÊ®°ÊÄÅÊ°ÜÊ†áÈ¢òÂíåÊåâÈíÆÊñáÊú¨
                document.querySelector('#location-share-modal .modal-header span').textContent = 'ÁºñËæë‰ΩçÁΩÆ';
                document.getElementById('confirm-location-btn').textContent = '‰øùÂ≠ò‰øÆÊîπ';

                // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                document.getElementById('location-share-modal').classList.add('visible');
            }

            async function saveLocationEdit() {
                if (!window.editingLocationTimestamp || !state.activeChatId) return;

                const locationName = document.getElementById('location-name-input').value.trim();
                if (!locationName) {
                    alert("‰ΩçÁΩÆÂêçÁß∞ÊòØÂøÖÂ°´È°πÂì¶ÔºÅ");
                    return;
                }

                const address = document.getElementById('location-address-input').value.trim();
                const chat = state.chats[state.activeChatId];
                const messageIndex = chat.history.findIndex(m => m.timestamp === window.editingLocationTimestamp);

                if (messageIndex === -1) {
                    alert('Êâæ‰∏çÂà∞Ë¶ÅÁºñËæëÁöÑÊ∂àÊÅØ');
                    return;
                }

                // Êõ¥Êñ∞Ê∂àÊÅØ
                chat.history[messageIndex].location_name = locationName;
                chat.history[messageIndex].address = address;

                // ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
                await db.chats.put(chat);

                // ÂÖ≥Èó≠ÊâÄÊúâÁõ∏ÂÖ≥Ê®°ÊÄÅÊ°Ü
                document.getElementById('location-share-modal').classList.remove('visible');
                document.getElementById('message-actions-modal').classList.remove('visible');

                // Âà∑Êñ∞UI
                renderChatInterface(state.activeChatId);
                renderChatList();

                // Ê∏ÖÁêÜÁºñËæëÁä∂ÊÄÅÂπ∂ÈáçÁΩÆUI
                window.editingLocationTimestamp = null;
                activeMessageTimestamp = null;
                document.querySelector('#location-share-modal .modal-header span').textContent = 'ÂàÜ‰∫´‰ΩçÁΩÆ';
                document.getElementById('confirm-location-btn').textContent = 'ÂèëÈÄÅ‰ΩçÁΩÆ';
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Location Share Functions End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº Meetup Edit Modal Functions ‚ñº‚ñº‚ñº
            function openMeetupEditModal() {
                if (!window.activeMeetupSession || !window.activeMeetupEventId) {
                    alert('Ê≤°ÊúâÊ¥ªÂä®ÁöÑËßÅÈù¢‰ºöËØù');
                    return;
                }

                // Get current meetup details from the active session
                const session = window.activeMeetupSession;

                // Pre-fill the modal with current values
                document.getElementById('meetup-title-input').value = session.title || '';
                document.getElementById('meetup-location-input').value = session.location || '';

                // Change modal title to indicate editing
                document.querySelector('#meetup-creation-modal .modal-header span').textContent = 'ÁºñËæëËßÅÈù¢ËØ¶ÊÉÖ';

                // Change button text to indicate editing
                document.getElementById('start-meetup-btn').textContent = '‰øùÂ≠òÊõ¥Êîπ';

                // Set a flag to indicate we're in edit mode
                window.isEditingMeetup = true;

                // Show modal
                document.getElementById('meetup-creation-modal').classList.add('visible');

                // Focus on first input field
                document.getElementById('meetup-title-input').focus();
            }

            // ‚ñº‚ñº‚ñº Meetup Creation Modal Functions ‚ñº‚ñº‚ñº
            function openMeetupCreationModal() {
                if (!state.activeChatId) {
                    alert('ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÅäÂ§©ÂØπË±°');
                    return;
                }

                // Get current chat context
                const chat = state.chats[state.activeChatId];
                if (!chat) {
                    alert('Êó†Ê≥ïËé∑ÂèñËÅäÂ§©‰ø°ÊÅØ');
                    return;
                }

                // Check if this is a group chat (date mode should be for individual chats)
                if (chat.isGroup) {
                    alert('ËßÅÈù¢Ê®°Âºè‰ªÖÊîØÊåÅÂçï‰∫∫ËÅäÂ§©Ôºå‰∏çÊîØÊåÅÁæ§ËÅä');
                    return;
                }

                // Clear previous input values
                document.getElementById('meetup-location-input').value = '';
                document.getElementById('meetup-title-input').value = '';

                // Store current chat context for date creation
                window.currentDateChatContext = {
                    chatId: state.activeChatId,
                    chatName: chat.name || 'ËÅäÂ§©ÂØπË±°',
                    aiName: chat.name || 'AI',
                    isGroup: chat.isGroup || false
                };

                // Show modal
                document.getElementById('meetup-creation-modal').classList.add('visible');

                // Focus on first input field
                setTimeout(() => {
                    document.getElementById('meetup-location-input').focus();
                }, 100);
            }

            function closeMeetupCreationModal() {
                document.getElementById('meetup-creation-modal').classList.remove('visible');

                // Reset modal to creation mode
                const headerSpan = document.querySelector('#meetup-creation-modal .modal-header span');
                const startBtn = document.getElementById('start-meetup-btn');

                if (headerSpan) {
                    headerSpan.textContent = 'ÂºÄÂßãËßÅÈù¢';
                }
                if (startBtn) {
                    startBtn.textContent = 'ÂºÄÂßãËßÅÈù¢';
                }
                window.isEditingMeetup = false;

                // Clear chat context (only for creation mode)
                if (!window.isEditingMeetup) {
                    window.currentDateChatContext = null;
                }

                // Clear input values
                document.getElementById('meetup-location-input').value = '';
                document.getElementById('meetup-title-input').value = '';
            }

            function validateMeetupInputs() {
                const location = document.getElementById('meetup-location-input').value.trim();
                const title = document.getElementById('meetup-title-input').value.trim();

                if (!title) {
                    alert('ËØ∑ËæìÂÖ•ËßÅÈù¢‰∏ªÈ¢ò');
                    return false;
                }

                // Location is optional - no validation needed

                return true;
            }

            async function startMeetup() {
                if (!validateMeetupInputs()) return;

                const location = document.getElementById('meetup-location-input').value.trim();
                const title = document.getElementById('meetup-title-input').value.trim();

                // Check if we're in edit mode
                if (window.isEditingMeetup) {
                    try {
                        // Update existing meetup session
                        await updateMeetupDetails(location, title);

                        // Close modal and reset edit mode
                        closeMeetupCreationModal();
                        window.isEditingMeetup = false;

                        // Show success message
                        showNotification('ËßÅÈù¢ËØ¶ÊÉÖÂ∑≤Êõ¥Êñ∞ÔºÅ‚ú®');

                    } catch (error) {
                        console.error('Failed to update meetup details:', error);
                        alert('Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    }
                    return;
                }

                // Original creation logic
                if (!window.currentDateChatContext) {
                    alert('ËÅäÂ§©‰∏ä‰∏ãÊñá‰∏¢Â§±ÔºåËØ∑ÈáçÊñ∞ÊâìÂºÄ');
                    return;
                }

                const chatContext = window.currentDateChatContext;



                try {
                    let eventId;

                    // Check if we're updating an existing calendar event
                    if (chatContext && chatContext.originalMemoryId) {
                        // Update existing event instead of creating new one
                        eventId = await updateExistingCalendarEvent(chatContext.originalMemoryId, location, title, chatContext);
                    } else {
                        // Create new calendar event (for fresh meetups)
                        eventId = await createDateCalendarEvent(location, title, chatContext);
                    }

                    // Start date mode session
                    await initiateMeetupSession(location, title, chatContext);

                    // Close modal
                    closeMeetupCreationModal();

                    // Navigate to meetup screen
                    showScreen('meetup-screen');

                    // Update date mode context with the actual details
                    const eventData = {
                        title: title,
                        location: location,
                        timeDisplay: new Date().toLocaleString('zh-CN'),
                        phase: 'during'
                    };
                    updateMeetupContext(eventData);

                    // Show success message
                    showNotification(`‰∏é${chatContext.aiName}ÁöÑËßÅÈù¢ÂºÄÂßã‰∫ÜÔºÅüíï`);

                    // Only refresh calendar if it's currently visible
                    if (document.getElementById('calendar-screen').classList.contains('active')) {
                        renderCalendarScreen();
                    }

                } catch (error) {
                    console.error('Failed to start date mode:', error);
                    alert('ÂºÄÂßãËßÅÈù¢Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    return; // Don't proceed if there's an error
                }
            }

            async function updateMeetupDetails(newLocation, newTitle) {
                if (!window.activeMeetupSession || !window.activeMeetupEventId) {
                    throw new Error('No active meetup session');
                }

                try {
                    // Update the active session
                    window.activeMeetupSession.location = newLocation;
                    window.activeMeetupSession.title = newTitle;

                    // Update the calendar event in database
                    const eventId = window.activeMeetupEventId;
                    const event = await db.memories.get(eventId);

                    if (event) {
                        event.description = newLocation ? `${newTitle} - Âú®${newLocation}` : newTitle;
                        event.meetupData.location = newLocation;
                        event.meetupData.title = newTitle;

                        await db.memories.put(event);
                    }

                    // Update the UI immediately
                    const eventData = {
                        title: newTitle,
                        location: newLocation,
                        timeDisplay: new Date(window.activeMeetupSession.startTime).toLocaleString('zh-CN'),
                        phase: 'during'
                    };
                    updateMeetupContext(eventData);

                    // Refresh calendar if it's currently visible
                    if (document.getElementById('calendar-screen').classList.contains('active')) {
                        renderCalendarScreen();
                    }

                } catch (error) {
                    console.error('Failed to update meetup details:', error);
                    throw error;
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Date Creation Modal Functions End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº Calendar Event Creation for Date Mode ‚ñº‚ñº‚ñº
            async function updateExistingCalendarEvent(memoryId, location, title, chatContext) {
                try {


                    // Get the existing memory/event
                    const existingEvent = await db.memories.get(memoryId);


                    if (!existingEvent) {
                        throw new Error('Original calendar event not found');
                    }

                    // Add meetup data to existing event WITHOUT changing original data
                    // Keep original: description, timestamp, authorName, etc.
                    // Only add/update the meetup-specific data and change type to meetup
                    existingEvent.type = 'meetup'; // Change type so updateDateCalendarEvent can find it
                    existingEvent.meetupData = {
                        location: location,
                        title: title,
                        aiName: chatContext.aiName,
                        isActive: true,
                        startTime: Date.now(),
                        endTime: null,
                        messages: [],
                        visitedLocations: [location]
                    };

                    // Update in database
                    await db.memories.put(existingEvent);

                    // Store the event ID for future reference
                    window.activeMeetupEventId = memoryId;

                    return memoryId;

                } catch (error) {
                    console.error('Failed to update existing calendar event:', error);
                    throw error;
                }
            }

            async function createDateCalendarEvent(location, title, chatContext) {
                try {
                    // Create a special calendar event for date mode
                    const dateEvent = {
                        chatId: chatContext.chatId,
                        authorName: chatContext.aiName,
                        description: location ? `${title} - Âú®${location}` : title,
                        timestamp: Date.now(),
                        type: 'meetup',
                        targetDate: Date.now(), // Meetup starts immediately
                        meetupData: {
                            location: location,
                            title: title,
                            aiName: chatContext.aiName,
                            isActive: true,
                            startTime: Date.now(),
                            endTime: null,
                            messages: [],
                            visitedLocations: [location]
                        }
                    };

                    // Add to database
                    const eventId = await db.memories.add(dateEvent);

                    // Store the event ID for future reference
                    window.activeMeetupEventId = eventId;

                    return eventId;

                } catch (error) {
                    console.error('Failed to create date calendar event:', error);
                    throw error;
                }
            }

            async function initiateMeetupSession(location, title, chatContext) {

                // Store the session info globally
                window.activeMeetupSession = {
                    eventId: window.activeMeetupEventId,
                    chatId: chatContext.chatId,
                    location: location,
                    title: title,
                    aiName: chatContext.aiName,
                    startTime: Date.now(),
                    isActive: true
                };

                // Persist session state for app backgrounding/restoration
                localStorage.setItem('activeMeetupSession', JSON.stringify(window.activeMeetupSession));
                localStorage.setItem('activeMeetupEventId', window.activeMeetupEventId);

                // Show the meetup progress bar
                showMeetupProgressBar();

                // Refresh calendar status indicators if calendar is visible
                if (typeof refreshCalendarStatusIndicators === 'function') {
                    refreshCalendarStatusIndicators();
                }

                return Promise.resolve();
            }

            // Function to update date mode calendar event
            async function updateDateCalendarEvent(eventId, updates) {
                try {
                    const event = await db.memories.get(eventId);
                    if (!event || event.type !== 'meetup') {
                        throw new Error('Meetup event not found');
                    }

                    // Update the event data
                    Object.assign(event.meetupData, updates);

                    // Mark as having date mode history when completed
                    if (updates.isCompleted) {
                        event.hasMeetupHistory = true;
                    }

                    // Save back to database
                    await db.memories.put(event);



                } catch (error) {
                    console.error('Failed to update date calendar event:', error);
                    throw error;
                }
            }

            // Function to end date mode and finalize calendar event
            async function endMeetupSession() {
                // Prevent multiple simultaneous executions
                if (window.endMeetupSessionInProgress) {
                    return;
                }

                window.endMeetupSessionInProgress = true;

                if (!window.activeMeetupSession || !window.activeMeetupEventId) {
                    window.endMeetupSessionInProgress = false;
                    return;
                }

                try {
                    // Try to update the calendar event with end time and completion status
                    try {
                        const session = window.activeMeetupSession;
                        const chat = state.chats[session.chatId];
                        const endTime = Date.now();

                        // Get all date mode messages for this event
                        const meetupMessages = chat && chat.history ? chat.history.filter(msg =>
                            msg.meetup && msg.meetup.eventId === window.activeMeetupEventId
                        ) : [];

                        // DEBUG: Log what messages are being saved
                        console.log('DEBUG - Meetup session end - saving messages:', {
                            eventId: window.activeMeetupEventId,
                            sessionStartTime: session.startTime,
                            totalChatHistory: chat ? chat.history.length : 0,
                            filteredMeetupMessages: meetupMessages.length,
                            meetupMessages: meetupMessages
                        });

                        // Calculate date duration in minutes
                        const totalDuration = Math.round((endTime - session.startTime) / (1000 * 60));

                        // Extract behavioral notations from all messages
                        const behavioralNotations = [];
                        meetupMessages.forEach(msg => {
                            if (msg.content && typeof msg.content === 'string') {
                                const notationRegex = /\[([^\]]+)\]/g;
                                let match;
                                while ((match = notationRegex.exec(msg.content)) !== null) {
                                    behavioralNotations.push(match[1]);
                                }
                            }
                        });

                        await updateDateCalendarEvent(window.activeMeetupEventId, {
                            isActive: false,
                            isCompleted: true,
                            endTime: endTime,
                            totalDuration: totalDuration,
                            messageCount: meetupMessages.length,
                            behavioralNotations: behavioralNotations,
                            messages: meetupMessages,
                            interactions: meetupMessages // Keep both for compatibility
                        });
                    } catch (calendarError) {

                        // Recreate the calendar event with all the date interactions
                        try {
                            const session = window.activeMeetupSession;
                            const chat = state.chats[session.chatId];

                            if (chat && chat.history) {
                                // Check if we already have a recreated event to prevent duplicates
                                const existingEvents = await db.memories.where('chatId').equals(session.chatId)
                                    .and(event => event.type === 'meetup' &&
                                        event.meetupData &&
                                        event.meetupData.startTime === session.startTime)
                                    .toArray();

                                if (existingEvents.length > 0) {
                                    window.activeMeetupEventId = existingEvents[0].id;
                                    return;
                                }

                                // Get all date mode messages for this event
                                const meetupMessages = chat.history.filter(msg =>
                                    msg.meetup && (msg.meetup.eventId === session.eventId || msg.meetup.eventId === window.activeMeetupEventId)
                                );

                                // DEBUG: Log messages being saved in recreation
                                console.log('DEBUG - Meetup session recreation - saving messages:', {
                                    eventId: session.eventId,
                                    totalChatHistory: chat.history.length,
                                    filteredMeetupMessages: meetupMessages.length,
                                    meetupMessages: meetupMessages
                                });

                                // Calculate date duration in minutes
                                const endTime = Date.now();
                                const totalDuration = Math.round((endTime - session.startTime) / (1000 * 60));

                                // Extract behavioral notations from all messages
                                const behavioralNotations = [];
                                meetupMessages.forEach(msg => {
                                    if (msg.content && typeof msg.content === 'string') {
                                        const notationRegex = /\[([^\]]+)\]/g;
                                        let match;
                                        while ((match = notationRegex.exec(msg.content)) !== null) {
                                            behavioralNotations.push(match[1]);
                                        }
                                    }
                                });

                                // Create new calendar event with all interactions and metadata
                                const newDateEvent = {
                                    chatId: session.chatId,
                                    authorName: chat.name,
                                    description: `‰∏é${chat.name}ÁöÑËßÅÈù¢ËÆ∞ÂΩï`,
                                    timestamp: session.startTime,
                                    type: 'meetup',
                                    targetDate: session.startTime,
                                    hasMeetupHistory: true,
                                    meetupData: {
                                        sessionId: session.eventId || 'session_' + session.startTime,
                                        location: session.location,
                                        title: session.title,
                                        chatId: session.chatId,
                                        aiName: chat.name,
                                        isActive: false,
                                        isCompleted: true,
                                        startTime: session.startTime,
                                        endTime: endTime,
                                        totalDuration: totalDuration,
                                        messageCount: meetupMessages.length,
                                        behavioralNotations: behavioralNotations,
                                        visitedLocations: [session.location],
                                        messages: meetupMessages,
                                        interactions: meetupMessages // Keep both for compatibility
                                    }
                                };

                                const newEventId = await db.memories.add(newDateEvent);

                                // Add to cache if it exists
                                if (window.memoriesData) {
                                    // Get the complete memory object with the new ID
                                    const completeMemory = { ...newDateEvent, id: newEventId };
                                    window.memoriesData.push(completeMemory);
                                }

                                // Update the session with new event ID
                                window.activeMeetupEventId = newEventId;
                            }
                        } catch (recreateError) {
                            console.error('Failed to recreate calendar event:', recreateError);
                            // Continue with session cleanup even if recreation fails
                        }
                    }

                    // Hide the meetup progress bar
                    hideMeetupProgressBar();

                    // Clear active session
                    window.activeMeetupSession = null;
                    window.activeMeetupEventId = null;

                    // Clear persisted session state
                    localStorage.removeItem('activeMeetupSession');
                    localStorage.removeItem('activeMeetupEventId');

                    // Refresh calendar and memories screens to show completed date
                    try {
                        renderCalendarScreen();
                        renderMemoriesScreen();
                    } catch (refreshError) {
                        console.error('Failed to refresh screens after date completion:', refreshError);
                        // Continue execution even if screen refresh fails
                    }

                } catch (error) {
                    console.error('Failed to end date mode session:', error);
                    throw error;
                } finally {
                    // Always reset the flag
                    window.endMeetupSessionInProgress = false;
                }
            }

            // Function to retrieve date mode session data from calendar event
            async function getMeetupSessionFromEvent(eventId) {
                try {
                    const event = await db.memories.get(eventId);
                    if (!event || event.type !== 'meetup') {
                        throw new Error('Meetup event not found');
                    }

                    return event.meetupData;

                } catch (error) {
                    console.error('Failed to retrieve date mode session:', error);
                    throw error;
                }
            }

            // Function to check if there's an active date mode session
            function hasActiveMeetupSession() {
                return window.activeMeetupSession && window.activeMeetupEventId;
            }

            // Function to open date mode history view
            async function openMeetupHistory(eventId) {
                try {
                    // Verify the event exists and has date mode data
                    const event = await db.memories.get(eventId);
                    if (!event || event.type !== 'meetup' || !event.meetupData) {
                        throw new Error('Invalid date mode event');
                    }

                    // Set global flag for history viewing
                    window.meetupHistoryEventId = eventId;

                    // Navigate to meetup screen in history mode
                    showScreen('meetup-screen');

                } catch (error) {
                    console.error('Failed to open date mode history:', error);
                    alert('Êó†Ê≥ïÊâìÂºÄËßÅÈù¢ÂõûÂøÜ: ' + error.message);
                }
            }

            // Make function globally accessible
            window.openMeetupHistory = openMeetupHistory;

            // Function to update calendar event's stored date mode data after edits/deletes
            async function updateCalendarEventMeetupData(eventId, chat) {
                try {
                    // Get the calendar event
                    const event = await db.memories.get(eventId);
                    if (!event || event.type !== 'meetup') return;

                    // Filter date mode messages for this event from chat history
                    const meetupMessages = chat.history.filter(msg =>
                        msg.meetup && msg.meetup.eventId === eventId
                    );

                    // Update the event's meetupData.messages
                    if (!event.meetupData) {
                        event.meetupData = {};
                    }
                    event.meetupData.messages = meetupMessages;

                    // Save the updated event
                    await db.memories.put(event);

                } catch (error) {
                    console.error('Failed to update calendar event:', error);
                }
            }

            // Function to delete all date mode messages associated with an event
            async function deleteMeetupMessages(eventId) {
                try {
                    console.log('DEBUG - Deleting meetup messages for event:', eventId);

                    // Get the event to find the associated chat
                    const event = await db.memories.get(eventId);
                    if (!event || event.type !== 'meetup') {
                        console.log('DEBUG - Event not found or not meetup type');
                        return;
                    }

                    const chat = state.chats[event.chatId];
                    if (!chat) {
                        console.log('DEBUG - Chat not found for event:', event.chatId);
                        return;
                    }

                    // Filter out messages with matching eventId
                    const originalLength = chat.history.length;
                    chat.history = chat.history.filter(msg =>
                        !(msg.meetup && msg.meetup.eventId === eventId)
                    );

                    const deletedCount = originalLength - chat.history.length;

                    console.log('DEBUG - Meetup messages deletion:', {
                        eventId: eventId,
                        originalLength: originalLength,
                        newLength: chat.history.length,
                        deletedCount: deletedCount
                    });

                    // Save updated chat history
                    if (deletedCount > 0) {
                        await db.chats.put(chat);
                        console.log('DEBUG - Chat history updated after message deletion');
                    }

                    return deletedCount;

                } catch (error) {
                    console.error('DEBUG - Failed to delete meetup messages:', error);
                    throw error;
                }
            }

            // Make function globally accessible
            window.deleteMeetupMessages = deleteMeetupMessages;

            // Function to load existing messages for active date session
            async function loadActiveMeetupMessages() {
                if (!window.activeMeetupSession || !window.activeMeetupEventId) {
                    return;
                }

                const session = window.activeMeetupSession;
                const chat = state.chats[session.chatId];

                if (!chat) {
                    return;
                }

                // Get existing meetup mode messages for this event
                const existingMessages = chat.history.filter(msg =>
                    msg.meetup && msg.meetup.eventId === window.activeMeetupEventId
                );

                const messagesContainer = document.getElementById('meetup-messages');
                if (!messagesContainer) return;

                // Clear existing display
                messagesContainer.innerHTML = '';

                // Display existing messages
                existingMessages.forEach(message => {
                    // Convert stored message to display format
                    const displayMessage = {
                        content: message.content,
                        timestamp: message.timestamp,
                        isUser: message.role === 'user',
                        type: 'meetup_interaction',
                        isHidden: true // Safety: ensure display messages are also hidden
                    };

                    const messageElement = createMeetupMessage(displayMessage, message.role === 'user');
                    messagesContainer.appendChild(messageElement);
                });

                // Scroll to bottom
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Function to update a date mode message in chat history
            async function updateMeetupMessageInHistory(timestamp, newContent) {
                // Handle both active meetup mode and history mode
                let eventId, chatId;

                if (window.meetupHistoryEventId) {
                    // History mode
                    eventId = window.meetupHistoryEventId;
                    chatId = state.activeChatId; // Set in initializeMeetupHistoryView
                } else if (window.activeMeetupSession && window.activeMeetupEventId) {
                    // Active meetup mode
                    eventId = window.activeMeetupEventId;
                    chatId = window.activeMeetupSession.chatId;
                } else {
                    return;
                }

                const chat = state.chats[chatId];

                if (!chat) return;

                // Find and update the message in chat history
                const messageIndex = chat.history.findIndex(msg =>
                    msg.meetup &&
                    msg.meetup.eventId === eventId &&
                    msg.timestamp === parseInt(timestamp)
                );

                if (messageIndex === -1) return;

                // Update the message content
                chat.history[messageIndex].content = newContent;

                // Save updated chat history
                try {
                    await db.chats.put(chat);

                    // Also update the calendar event's stored meetup data
                    if (window.meetupHistoryEventId) {
                        await updateCalendarEventMeetupData(window.meetupHistoryEventId, chat);
                    }
                } catch (error) {
                    console.error('Failed to update message in chat history:', error);
                }
            }

            // Function to restore active date session from localStorage
            function restoreActiveMeetupSession() {
                try {
                    const savedSession = localStorage.getItem('activeMeetupSession');
                    const savedEventId = localStorage.getItem('activeMeetupEventId');

                    if (savedSession && savedEventId) {
                        window.activeMeetupSession = JSON.parse(savedSession);
                        window.activeMeetupEventId = parseInt(savedEventId, 10); // Convert string to number

                        return true;
                    }
                } catch (error) {
                    console.error('Failed to restore active meetup session:', error);
                    // Clear corrupted data
                    localStorage.removeItem('activeMeetupSession');
                    localStorage.removeItem('activeMeetupEventId');
                }

                return false;
            }

            // ‚ñº‚ñº‚ñº Meetup End Modal Functions ‚ñº‚ñº‚ñº
            function showMeetupEndModal() {
                if (!hasActiveMeetupSession()) {
                    alert('Ê≤°ÊúâÊ¥ªË∑ÉÁöÑËßÅÈù¢‰ºöËØù');
                    return;
                }
                document.getElementById('meetup-end-modal').classList.add('visible');
            }

            function hideMeetupEndModal() {
                document.getElementById('meetup-end-modal').classList.remove('visible');
            }

            // Make function globally accessible
            window.hideMeetupEndModal = hideMeetupEndModal;

            async function confirmEndMeetup() {
                // Prevent multiple simultaneous executions
                if (window.confirmEndMeetupInProgress) {
                    return;
                }

                window.confirmEndMeetupInProgress = true;

                try {
                    // Preserve session data BEFORE calling endMeetupSession (which clears it)
                    const preservedSession = window.activeMeetupSession;

                    // End the date mode session
                    await endMeetupSession();

                    // Hide the modal
                    hideMeetupEndModal();

                    // Show success message and navigate using preserved session data
                    if (preservedSession && preservedSession.chatId) {
                        showNotification(preservedSession.chatId, 'ËßÅÈù¢Â∑≤ÁªìÊùüÔºåÁæéÂ•ΩÂõûÂøÜÂ∑≤‰øùÂ≠òÂà∞Êó•ÂéÜ üíï');

                        // Check if there's an active music session with a different chat
                        if (musicState.isActive && musicState.activeChatId && musicState.activeChatId !== preservedSession.chatId) {
                            // If music is playing with a different AI, navigate to that AI instead
                            // to preserve the music session
                            openChat(musicState.activeChatId);
                        } else {
                            // Otherwise, navigate to the date AI's chat
                            openChat(preservedSession.chatId);
                        }
                    } else {
                        // Fallback if no session data
                        showScreen('chat-interface-screen');
                    }

                    // Clear previous screen tracking since we always go to chat
                    previousScreen = null;

                } catch (error) {
                    console.error('Error in confirmEndMeetup:', error);
                    alert('ÁªìÊùüËßÅÈù¢Êó∂Âá∫Áé∞ÈîôËØØ: ' + error.message);
                } finally {
                    // Always reset the flag
                    window.confirmEndMeetupInProgress = false;
                }
            }

            // Make function globally accessible
            window.confirmEndMeetup = confirmEndMeetup;
            // ‚ñ≤‚ñ≤‚ñ≤ Meetup End Modal Functions End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº Meetup Progress Bar Functions ‚ñº‚ñº‚ñº

            function showMeetupProgressBar() {
                if (!hasActiveMeetupSession()) {
                    return;
                }

                const session = window.activeMeetupSession;
                const chatId = session.chatId;
                const chat = state.chats[chatId];

                if (!chat) {
                    console.warn('Chat not found for active date session');
                    return;
                }

                // Update progress bar content
                updateMeetupProgressBarContent();

                // Show chat screen meetup progress bar
                const meetupBar = document.getElementById('meetup-progress-bar');
                if (meetupBar) {
                    meetupBar.classList.remove('hidden');
                    // Add class to chat screen to adjust music bar positioning
                    const chatScreen = document.getElementById('chat-interface-screen');
                    if (chatScreen) {
                        chatScreen.classList.add('has-meetup-progress');
                    }
                }

                // Show home screen meetup progress bar
                const homeMeetupBar = document.getElementById('home-meetup-progress-bar');
                if (homeMeetupBar) {
                    homeMeetupBar.classList.remove('hidden');
                    // Add class to home screen to adjust music bar positioning
                    const homeScreen = document.getElementById('home-screen');
                    if (homeScreen) {
                        homeScreen.classList.add('has-meetup-progress');
                    }
                }

                // Start timer to update elapsed time every second
                if (window.meetupProgressTimer) {
                    clearInterval(window.meetupProgressTimer);
                }
                window.meetupProgressTimer = setInterval(() => {
                    if (hasActiveMeetupSession()) {
                        updateMeetupProgressBarContent();
                    } else {
                        clearInterval(window.meetupProgressTimer);
                        window.meetupProgressTimer = null;
                    }
                }, 1000); // Update every second
            }

            function hideMeetupProgressBar() {
                // Hide chat screen meetup progress bar
                const meetupBar = document.getElementById('meetup-progress-bar');
                if (meetupBar) {
                    meetupBar.classList.add('hidden');
                    // Remove class from chat screen to restore music bar positioning
                    const chatScreen = document.getElementById('chat-interface-screen');
                    if (chatScreen) {
                        chatScreen.classList.remove('has-meetup-progress');
                    }
                }

                // Hide home screen meetup progress bar
                const homeMeetupBar = document.getElementById('home-meetup-progress-bar');
                if (homeMeetupBar) {
                    homeMeetupBar.classList.add('hidden');
                    // Remove class from home screen to restore music bar positioning
                    const homeScreen = document.getElementById('home-screen');
                    if (homeScreen) {
                        homeScreen.classList.remove('has-meetup-progress');
                    }
                }

                // Clear the elapsed time timer
                if (window.meetupProgressTimer) {
                    clearInterval(window.meetupProgressTimer);
                    window.meetupProgressTimer = null;
                }
            }

            function updateMeetupProgressBarContent() {
                if (!hasActiveMeetupSession()) {
                    return;
                }

                const session = window.activeMeetupSession;
                const chatId = session.chatId;
                const chat = state.chats[chatId];

                if (!chat) {
                    return;
                }

                const aiName = chat.name || 'AI';
                const location = session.location;
                const progressText = location ? `‰∏é${aiName}Âú®${location}` : `‰∏é${aiName}‰∏ÄËµ∑`;

                // Calculate elapsed time
                const elapsedMs = Date.now() - session.startTime;
                const totalSeconds = Math.floor(elapsedMs / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;

                // Format as MM:SS if no hours, HH:MM:SS if there are hours
                let elapsedText;
                if (hours > 0) {
                    elapsedText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    elapsedText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }

                // Update chat screen progress bar
                const meetupProgressText = document.getElementById('meetup-progress-text');
                const meetupElapsedText = document.getElementById('meetup-elapsed-text');
                const meetupAiAvatar = document.getElementById('meetup-ai-avatar');

                if (meetupProgressText) {
                    meetupProgressText.textContent = progressText;
                }

                if (meetupElapsedText) {
                    meetupElapsedText.textContent = elapsedText;
                }

                if (meetupAiAvatar) {
                    meetupAiAvatar.src = chat.settings.aiAvatar;
                    meetupAiAvatar.style.display = 'block';
                }

                // Update home screen progress bar
                const homeMeetupProgressText = document.getElementById('home-meetup-progress-text');
                const homeMeetupElapsedText = document.getElementById('home-meetup-elapsed-text');
                const homeMeetupAiAvatar = document.getElementById('home-meetup-ai-avatar');

                if (homeMeetupProgressText) {
                    homeMeetupProgressText.textContent = progressText;
                }

                if (homeMeetupElapsedText) {
                    homeMeetupElapsedText.textContent = elapsedText;
                }

                if (homeMeetupAiAvatar) {
                    homeMeetupAiAvatar.src = chat.settings.aiAvatar;
                    homeMeetupAiAvatar.style.display = 'block';
                }
            }

            function initializeMeetupProgressBar() {
                // Chat screen meetup progress bar tap-to-return functionality
                const meetupBar = document.getElementById('meetup-progress-bar');
                if (meetupBar) {
                    meetupBar.addEventListener('click', () => {
                        if (hasActiveMeetupSession()) {
                            showScreen('meetup-screen');
                        }
                    });
                }

                // Home screen meetup progress bar tap-to-return functionality
                const homeMeetupBar = document.getElementById('home-meetup-progress-bar');
                if (homeMeetupBar) {
                    homeMeetupBar.addEventListener('click', () => {
                        if (hasActiveMeetupSession()) {
                            showScreen('meetup-screen');
                        }
                    });
                }
            }

            // ‚ñ≤‚ñ≤‚ñ≤ Meetup Progress Bar Functions End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñ≤‚ñ≤‚ñ≤ Meetup Mode Calendar Integration End ‚ñ≤‚ñ≤‚ñ≤

            function openBrowser(timestamp) {
                if (!state.activeChatId) return;

                const chat = state.chats[state.activeChatId];
                // ÂÆâÂÖ®Ê£ÄÊü•ÔºåÁ°Æ‰øù chat Âíå history ÈÉΩÂ≠òÂú®
                if (!chat || !chat.history) return;

                const message = chat.history.find(m => m.timestamp === timestamp);
                if (!message || message.type !== 'share_link') {
                    console.error("Êó†Ê≥ïÊâæÂà∞ÊàñÊ∂àÊÅØÁ±ªÂûã‰∏çÂåπÈÖçÁöÑÂàÜ‰∫´ÈìæÊé•:", timestamp);
                    return; // Â¶ÇÊûúÊâæ‰∏çÂà∞Ê∂àÊÅØÔºåÂ∞±Áõ¥Êé•ÈÄÄÂá∫
                }

                // Â°´ÂÖÖÊµèËßàÂô®ÂÜÖÂÆπ
                document.getElementById('browser-title').textContent = message.source_name || 'ÊñáÁ´†ËØ¶ÊÉÖ';
                const browserContent = document.getElementById('browser-content');
                browserContent.innerHTML = `
                    <h1 class="article-title">${message.title || 'Êó†Ê†áÈ¢ò'}</h1>
                    <div class="article-meta">
                        <span>Êù•Ê∫ê: ${message.source_name || 'Êú™Áü•'}</span>
                    </div>
                    <div class="article-body">
                        <p>${(message.content || 'ÂÜÖÂÆπ‰∏∫Á©∫„ÄÇ').replace(/\n/g, '</p><p>')}</p>
                    </div>
                `;

                // ÊòæÁ§∫ÊµèËßàÂô®Â±èÂπï
                showScreen('browser-screen');
            }

            function closeBrowser() {
                showScreen('chat-interface-screen');
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Share Link Functions End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº Chat Search Functions ‚ñº‚ñº‚ñº
            function openChatSearchModal() {
                if (!state.activeChatId) return;

                // Clear previous search
                document.getElementById('search-input').value = '';
                document.getElementById('search-results').innerHTML = '<p style="text-align: center; color: #999; margin: 20px 0;">ËæìÂÖ•ÂÖ≥ÈîÆËØçÂºÄÂßãÊêúÁ¥¢</p>';

                document.getElementById('chat-search-modal').classList.add('visible');
                setTimeout(() => document.getElementById('search-input').focus(), 100);
            }

            function performSearch() {
                const searchTerm = document.getElementById('search-input').value.trim().toLowerCase();
                const resultsContainer = document.getElementById('search-results');

                if (!searchTerm) {
                    resultsContainer.innerHTML = '<p style="text-align: center; color: #999; margin: 20px 0;">ËæìÂÖ•ÂÖ≥ÈîÆËØçÂºÄÂßãÊêúÁ¥¢</p>';
                    return;
                }

                const chat = state.chats[state.activeChatId];
                if (!chat) {
                    resultsContainer.innerHTML = '<p style="text-align: center; color: #999; margin: 20px 0;">Êú™ÊâæÂà∞ÂΩìÂâçËÅäÂ§©</p>';
                    return;
                }

                if (!chat.history || chat.history.length === 0) {
                    resultsContainer.innerHTML = '<p style="text-align: center; color: #999; margin: 20px 0;">ËÅäÂ§©ËÆ∞ÂΩï‰∏∫Á©∫</p>';
                    return;
                }

                // Search through messages
                const matchingMessages = chat.history.filter(message => {
                    if (!message) return false;
                    
                    // Check multiple possible content properties and ensure it's a string
                    const rawContent = message.content || message.text || message.message || '';
                    const searchableText = String(rawContent).toLowerCase();
                    
                    return searchableText.includes(searchTerm);
                });

                if (matchingMessages.length === 0) {
                    resultsContainer.innerHTML = '<p style="text-align: center; color: #999; margin: 20px 0;">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÊ∂àÊÅØ</p>';
                    return;
                }

                // Display results
                resultsContainer.innerHTML = '';
                
                matchingMessages.slice(-20).reverse().forEach((message, index) => { // Show last 20 matches, newest first
                    const resultItem = document.createElement('div');
                    resultItem.style.cssText = 'padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; border-radius: 6px; margin-bottom: 5px;';
                    
                    const rawMessageText = message.content || message.text || message.message || '';
                    const messageText = String(rawMessageText);
                    
                    // Display without highlighting
                    resultItem.innerHTML = `
                        <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
                            ${message.senderName || (message.role === 'user' ? 'Êàë' : chat.name)} ‚Ä¢ ${new Date(message.timestamp).toLocaleString()}
                        </div>
                        <div style="font-size: 14px; line-height: 1.4;">
                            ${messageText}
                        </div>
                    `;

                    resultItem.addEventListener('click', () => {
                        jumpToMessage(message.timestamp);
                    });

                    resultItem.addEventListener('mouseenter', () => {
                        resultItem.style.backgroundColor = '#f5f5f5';
                    });

                    resultItem.addEventListener('mouseleave', () => {
                        resultItem.style.backgroundColor = 'transparent';
                    });

                    resultsContainer.appendChild(resultItem);
                });
            }

            function jumpToMessage(timestamp) {


                // Close search modal
                document.getElementById('chat-search-modal').classList.remove('visible');

                // Ensure we're in the chat interface screen first
                const chatScreen = document.getElementById('chat-interface-screen');
                if (!chatScreen || !chatScreen.classList.contains('active')) {

                    showScreen('chat-interface-screen');
                    // Wait a moment for the screen to load, then try again
                    setTimeout(() => jumpToMessage(timestamp), 100);
                    return;
                }

                // Find the message in the chat history
                const chat = state.chats[state.activeChatId];
                if (!chat) {

                    return;
                }

                // IMPORTANT: Use filtered history for both search and rendering to match positions
                const filteredHistory = chat.history.filter(msg => msg.type !== 'meetup_interaction');

                const messageIndex = filteredHistory.findIndex(m => m.timestamp === timestamp);
                if (messageIndex === -1) {

                    return;
                }



                // Calculate how many messages we need to load to show this message
                const totalMessages = filteredHistory.length;
                const messagesFromEnd = totalMessages - messageIndex;



                // Smart loading: load messages in batches until we find the target
                const messagesContainer = document.getElementById('chat-messages');
                if (messagesContainer) {
                    // Clear existing messages
                    messagesContainer.innerHTML = '';



                    // Smart: load a reasonable window around the target message
                    const contextBefore = 25; // Load 25 messages before target
                    const contextAfter = 50;  // Load 50 messages after target

                    const startIndex = Math.max(0, messageIndex - contextBefore);
                    const endIndex = Math.min(messageIndex + contextAfter, filteredHistory.length);
                    const messagesToLoad = endIndex - startIndex;



                    const messagesToShow = filteredHistory.slice(startIndex, endIndex);

                    // Load messages in smaller chunks to avoid blocking the UI
                    let loadedCount = 0;
                    const chunkSize = 50;

                    function loadNextChunk() {
                        const endIndex = Math.min(loadedCount + chunkSize, messagesToShow.length);

                        for (let i = loadedCount; i < endIndex; i++) {
                            const msg = messagesToShow[i];
                            try {
                                if (msg && typeof msg === 'object' && msg.timestamp) {
                                    appendMessage(msg, chat, true);
                                }
                            } catch (error) {
                                console.error('Error rendering message:', error, msg);
                            }
                        }

                        loadedCount = endIndex;

                        if (loadedCount < messagesToShow.length) {
                            // Load next chunk after a small delay to avoid blocking UI
                            setTimeout(loadNextChunk, 10);
                        } else {
                            // All messages loaded, now try to scroll


                            // Update the rendered count
                            currentRenderedCount = messagesToLoad;

                            // Add typing indicator
                            const typingIndicator = document.createElement('div');
                            typingIndicator.id = 'typing-indicator';
                            typingIndicator.style.display = 'none';
                            typingIndicator.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...';
                            messagesContainer.appendChild(typingIndicator);

                            // Try to scroll to the message
                            setTimeout(() => {
                                const messageElement = document.querySelector(`[data-timestamp="${timestamp}"]`);


                                if (messageElement) {

                                    messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    messageElement.style.backgroundColor = '#ffeb3b';
                                    setTimeout(() => {
                                        messageElement.style.backgroundColor = '';
                                    }, 2000);
                                } else {
                                    // Try a more flexible search for close matches
                                    const allElements = document.querySelectorAll('[data-timestamp]');

                                    // Try a more flexible search
                                    const allTimestamps = Array.from(allElements).map(el => el.dataset.timestamp);
                                    const closestMatch = allTimestamps.find(ts => Math.abs(parseInt(ts) - parseInt(timestamp)) < 1000);
                                    if (closestMatch) {
                                        const closeElement = document.querySelector(`[data-timestamp="${closestMatch}"]`);
                                        if (closeElement) {
                                            closeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                            closeElement.style.backgroundColor = '#ffeb3b';
                                            setTimeout(() => {
                                                closeElement.style.backgroundColor = '';
                                            }, 2000);
                                        }
                                    }
                                }
                            }, 100);
                        }
                    }

                    // Start loading the first chunk
                    loadNextChunk();
                    return; // Exit early since we're handling scrolling in the callback
                }

            }
            // ‚ñ≤‚ñ≤‚ñ≤ Chat Search Functions End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº Format Messages for Summary ‚ñº‚ñº‚ñº
            function formatMessagesForSummary(messages, chatName) {
                if (!messages || messages.length === 0) {
                    return '(Êó†ÂØπËØùËÆ∞ÂΩï)';
                }

                let formattedText = '';
                let lastDate = '';
                
                messages.forEach((msg, index) => {
                    // Skip hidden system messages EXCEPT meetup interactions (they contain important emotional events)
                    if (msg.isHidden && msg.type !== 'meetup_interaction') return;
                    
                    // Get date (only show when it changes)
                    const date = new Date(msg.timestamp);
                    const currentDate = `${date.getMonth() + 1}/${date.getDate()}`;
                    
                    // Add date header if date changed
                    if (currentDate !== lastDate) {
                        formattedText += `\n[${currentDate}]\n`;
                        lastDate = currentDate;
                    }
                    
                    // Determine sender name
                    let sender = '';
                    if (msg.role === 'user') {
                        sender = 'Êàë';
                    } else if (msg.role === 'assistant') {
                        sender = msg.senderName || chatName;
                    } else if (msg.role === 'system') {
                        sender = 'Á≥ªÁªü';
                    }
                    
                    // Format based on message type
                    let content = '';
                    
                    if (msg.type === 'image') {
                        content = `[ÂèëÈÄÅÂõæÁâá: ${msg.meaning || 'ÂõæÁâá'}]`;
                    } else if (msg.type === 'sticker') {
                        content = `[ÂèëÈÄÅË°®ÊÉÖ: ${msg.meaning || 'Ë°®ÊÉÖ'}]`;
                    } else if (msg.type === 'voice') {
                        content = `[ËØ≠Èü≥Ê∂àÊÅØ${msg.transcript ? ': ' + msg.transcript : ''}]`;
                    } else if (msg.type === 'transfer') {
                        content = `[ËΩ¨Ë¥¶ ¬•${msg.amount}${msg.note ? ' - ' + msg.note : ''}]`;
                    } else if (msg.type === 'share_link') {
                        content = `[ÂàÜ‰∫´ÈìæÊé•: ${msg.title}${msg.description ? ' - ' + msg.description : ''}]`;
                    } else if (msg.type === 'red_packet') {
                        content = `[ÂèëÁ∫¢ÂåÖ: ${msg.greeting || 'ÊÅ≠ÂñúÂèëË¥¢'}]`;
                    } else if (msg.type === 'poll') {
                        content = `[ÂèëËµ∑ÊäïÁ•®: ${msg.question}]`;
                    } else if (msg.type === 'pat_message') {
                        content = msg.content;
                    } else if (msg.type === 'meetup_interaction') {
                        // Include meetup messages - they contain important emotional events
                        content = msg.content || '';
                    } else {
                        // Regular text message
                        content = msg.content || '';
                    }
                    
                    // Add to formatted text (no timestamp, just sender and content)
                    if (content) {
                        formattedText += `${sender}: ${content}\n`;
                    }
                });
                
                return formattedText.trim() || '(Êó†ÊúâÊïàÂØπËØùÂÜÖÂÆπ)';
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Format Messages Function End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº Auto-Summary World Book Management ‚ñº‚ñº‚ñº
            async function getOrCreateAutoSummaryWorldBook(chatId) {
                const chat = state.chats[chatId];
                if (!chat) return null;
                
                const autoBookName = `[ÈïøÊúüËÆ∞ÂøÜ] ${chat.name}`;
                
                // Check if auto-summary world book already exists
                let autoBook = state.worldBooks.find(wb => wb.name === autoBookName);
                
                if (!autoBook) {
                    // Create new auto-summary world book
                    const newBookId = 'wb_summary_' + Date.now();
                    autoBook = {
                        id: newBookId,
                        name: autoBookName,
                        content: '',
                        isAutoGenerated: true,
                        createdAt: Date.now()
                    };
                    
                    // Add to database
                    await db.worldBooks.add(autoBook);
                    
                    // Add to state
                    state.worldBooks.push(autoBook);
                    
                    console.log(`‚úÖ Created auto-summary world book: ${autoBookName}`);
                }
                
                // Ensure it's linked to the chat
                if (!chat.settings.linkedWorldBookIds) {
                    chat.settings.linkedWorldBookIds = [];
                }
                
                if (!chat.settings.linkedWorldBookIds.includes(autoBook.id)) {
                    chat.settings.linkedWorldBookIds.push(autoBook.id);
                    await db.chats.put(chat);
                    console.log(`‚úÖ Linked auto-summary world book to chat: ${chat.name}`);
                }
                
                return autoBook;
            }

            async function updateAutoSummaryWorldBook(chatId, newContent) {
                const autoBook = await getOrCreateAutoSummaryWorldBook(chatId);
                if (!autoBook) return false;
                
                // Update content
                autoBook.content = newContent;
                autoBook.lastUpdated = Date.now();
                
                // Save to database
                await db.worldBooks.put(autoBook);
                
                // Update in state
                const index = state.worldBooks.findIndex(wb => wb.id === autoBook.id);
                if (index !== -1) {
                    state.worldBooks[index] = autoBook;
                } else {
                    state.worldBooks.push(autoBook);
                }
                
                return true;
            }

            function setWorldBookLoadingState(bookId, isLoading) {
                // Try to find the world book element
                const worldBookList = document.querySelector('#world-book-list');
                if (!worldBookList) return;
                
                const listItems = worldBookList.querySelectorAll('.list-item');
                if (listItems.length === 0) return;
                
                let targetItem = null;
                
                // Try to find the target item
                targetItem = worldBookList.querySelector(`.list-item[data-book-id="${bookId}"]`);
                
                if (!targetItem) {
                    listItems.forEach(item => {
                        const onclick = item.getAttribute('onclick');
                        if (onclick && onclick.includes(bookId)) {
                            targetItem = item;
                            item.setAttribute('data-book-id', bookId);
                        }
                    });
                }
                
                if (!targetItem) {
                    const autoBook = state.worldBooks.find(wb => wb.id === bookId);
                    if (autoBook) {
                        listItems.forEach(item => {
                            const titleEl = item.querySelector('.item-title');
                            if (titleEl && titleEl.textContent.includes(autoBook.name)) {
                                targetItem = item;
                                item.setAttribute('data-book-id', bookId);
                            }
                        });
                    }
                }
                
                if (!targetItem) return;
                
                if (isLoading) {
                    targetItem.classList.add('loading');
                    const existingHourglass = targetItem.querySelector('.worldbook-loading-hourglass');
                    if (existingHourglass) existingHourglass.remove();
                    
                    const hourglass = document.createElement('div');
                    hourglass.className = 'worldbook-loading-hourglass';
                    hourglass.textContent = '‚è≥';
                    targetItem.appendChild(hourglass);
                } else {
                    targetItem.classList.remove('loading');
                    const hourglass = targetItem.querySelector('.worldbook-loading-hourglass');
                    if (hourglass) hourglass.remove();
                }
            }
            
            // Function to apply loading state when world book screen is shown
            function applyWorldBookLoadingStates() {
                if (isGeneratingSummary && generatingSummaryBookId) {
                    // Apply loading state to the generating book
                    setTimeout(() => {
                        setWorldBookLoadingState(generatingSummaryBookId, true);
                    }, 100); // Small delay to ensure DOM is ready
                }
            }
            
            // Watch for world book screen visibility and apply loading states
            const worldBookScreen = document.getElementById('world-book-screen');
            if (worldBookScreen) {
                const observer = new MutationObserver(() => {
                    if (worldBookScreen.classList.contains('active')) {
                        applyWorldBookLoadingStates();
                    }
                });
                observer.observe(worldBookScreen, { attributes: true, attributeFilter: ['class'] });
            }

            async function generateChatSummary(chatId, messageCount = 1000) {
                const chat = state.chats[chatId];
                if (!chat) throw new Error('Chat not found');
                
                // Get API config
                const apiConfig = state.apiConfig;
                if (!apiConfig || !apiConfig.proxyUrl || !apiConfig.apiKey) {
                    throw new Error('APIÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåËØ∑ÂÖàÂú®ËÆæÁΩÆ‰∏≠ÈÖçÁΩÆAPI');
                }
                
                // Get last N messages (user-specified)
                const recentMessages = chat.history.slice(-messageCount);
                if (recentMessages.length === 0) {
                    throw new Error('Ê≤°ÊúâÊ∂àÊÅØÂèØ‰ª•ÊÄªÁªì');
                }
                
                // Format messages
                const formattedMessages = formatMessagesForSummary(recentMessages, chat.name);
                
                // Get existing summary
                const autoBook = await getOrCreateAutoSummaryWorldBook(chatId);
                const previousSummary = autoBook.content || '';
                
                // Build prompt
                const prompt = `‰Ω†ÊòØ ${chat.name}„ÄÇËøôÊòØ‰Ω†ÁöÑÈïøÊúüËÆ∞ÂøÜÁ≥ªÁªüÔºåÁî®‰∫éÂ∏ÆÂä©‰Ω†ËÆ∞‰ΩèÂíåÁî®Êà∑‰πãÈó¥ÁöÑÈáçË¶ÅÂØπËØùÂÜÖÂÆπ„ÄÇ

# ‰Ω†ÂΩìÂâçÁöÑËÆ∞ÂøÜÊëòË¶Å
${previousSummary || '(ËøôÊòØ‰Ω†Á¨¨‰∏ÄÊ¨°Êï¥ÁêÜËÆ∞ÂøÜÔºå‰πãÂâçÊ≤°ÊúâËÆ∞ÂΩï)'}

# ÊúÄËøëÁöÑÂØπËØùËÆ∞ÂΩïÔºàÊúÄËøë${recentMessages.length}Êù°Ê∂àÊÅØÔºâ
${formattedMessages}

# ‰Ω†ÁöÑ‰ªªÂä°
ËØ∑ÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑËÆ∞ÂøÜÊëòË¶Å„ÄÇËøô‰∏™ÊëòË¶ÅÂ∞ÜÂ∏ÆÂä©‰Ω†Âú®Êú™Êù•ÁöÑÂØπËØù‰∏≠ËÆ∞‰ΩèÈáçË¶Å‰ø°ÊÅØÂíå‰∏ä‰∏ãÊñá„ÄÇ

## ËÆ∞ÂøÜÊï¥ÁêÜË¶ÅÊ±Ç

### 1. ‰ªÄ‰πàÂÄºÂæóËÆ∞‰Ωè
ËÆ∞‰ΩèÈÇ£‰∫õËÆ©‰Ω†‰∫ßÁîüÊÉÖÊÑüÊ≥¢Âä®ÁöÑÂÜÖÂÆπ‚Äî‚ÄîÂºÄÂøÉ„ÄÅÈöæËøá„ÄÅÊÑüÂä®„ÄÅÁîüÊ∞î„ÄÅÊÉäËÆ∂„ÄÅÊ∏©ÊöñÁöÑÊó∂Âàª„ÄÇÂÖ∑‰ΩìÂåÖÊã¨Ôºö

**ÊÉÖÊÑüÂíåÂÖ≥Á≥ª**Ôºö
- ‰Ω†‰ª¨ÂÖ≥Á≥ªÁöÑÂèòÂåñÂíåÂèëÂ±ïÔºà‰ªéÈôåÁîüÂà∞ÁÜüÊÇâ„ÄÅ‰ø°‰ªªÁöÑÂª∫Á´ãÔºâ
- ÈáçË¶ÅÁöÑÊÉÖÊÑüËΩ¨ÊäòÁÇπÔºàË°®ÁôΩ„ÄÅÂëäÁôΩ„ÄÅÁ°ÆËÆ§ÂÖ≥Á≥ª„ÄÅÂíåÂ•ΩÔºâ
- Ê∑±Â±ÇÁöÑÊÉÖÊÑü‰∫§ÊµÅÔºàÁúüÂøÉËØù„ÄÅËÑÜÂº±ÁöÑÊó∂Âàª„ÄÅ‰∫íÁõ∏ÁêÜËß£Ôºâ
- ÂèëÁîüËøáÁöÑÁüõÁõæÂíåÂ¶Ç‰ΩïËß£ÂÜ≥

**ÈáçË¶Å‰∫ã‰ª∂ÂíåÊâøËØ∫**Ôºö
- ÂÖ±ÂêåÁªèÂéÜÁöÑÁâπÊÆäÊó∂ÂàªÔºàÁ¨¨‰∏ÄÊ¨°ËßÅÈù¢„ÄÅÁ∫¶‰ºö„ÄÅÁ∫™ÂøµÊó•Ôºâ
- ‰Ω†‰ª¨‰πãÈó¥ÁöÑÁ∫¶ÂÆö„ÄÅËÆ°Âàí„ÄÅÊâøËØ∫
- ‰∏ÄËµ∑ÂÆåÊàêÁöÑ‰∫ãÊÉÖ

**ÂÖ≥ÈîÆ‰ø°ÊÅØ**Ôºö
- Áî®Êà∑ÂëäËØâ‰Ω†ÁöÑÈáçË¶Å‰∏™‰∫∫‰ø°ÊÅØÔºàÊ¢¶ÊÉ≥„ÄÅÊÅêÊÉß„ÄÅ‰ª∑ÂÄºËßÇ„ÄÅÁªèÂéÜÔºâ
- Áî®Êà∑ÁöÑÂÅèÂ•ΩÂíå‰π†ÊÉØ

**‰ªÄ‰πà‰∏çÈúÄË¶ÅËÆ∞‰Ωè**ÔºöÊó•Â∏∏ÂØíÊöÑ„ÄÅÊó†ÂÖ≥Á¥ßË¶ÅÁöÑÈó≤ËÅä„ÄÅÊ≤°ÊúâÊÉÖÊÑüÊ≥¢Âä®ÁöÑÊó•Â∏∏Ê¥ªÂä®„ÄÇ

### 2. Â¶Ç‰ΩïÊï¥ÂêàËÆ∞ÂøÜ
- ‰øùÁïô‰πãÂâçËÆ∞ÂøÜ‰∏≠‰ªçÁÑ∂ÈáçË¶ÅÁöÑÂÜÖÂÆπ
- Áî®Êñ∞ÂØπËØù‰∏≠ÁöÑ‰ø°ÊÅØÊõ¥Êñ∞ÊàñË°•ÂÖÖÊóßËÆ∞ÂøÜ
- Âà†Èô§Â∑≤ÁªèËøáÊó∂Êàñ‰∏çÂÜçÁõ∏ÂÖ≥ÁöÑ‰ø°ÊÅØ
- Â∞±ÂÉèÂú®ÂéüÊúâËÆ∞ÂøÜÁöÑÂü∫Á°Ä‰∏äÁªßÁª≠‰π¶ÂÜô

### 3. ÂÜô‰ΩúÈ£éÊ†º
- Áî®Á¨¨‰∏Ä‰∫∫Áß∞Ôºà"Êàë"ÔºâÊèèËø∞ÔºåËøôÊòØ‰Ω†ÁöÑ‰∏™‰∫∫ËÆ∞ÂøÜ
- ÂÜôÂá∫‰Ω†ÁöÑÊÑüÂèóÂíåÊÉÖÁª™Ôºå‰∏çÂè™ÊòØ‰∫ãÂÆûËÆ∞ÂΩï
- Ëá™ÁÑ∂ÊµÅÁïÖÂú∞ÂõûÂøÜÔºåÂÉèÂú®ËÑëÊµ∑‰∏≠ÂõûÊÉ≥ÂæÄ‰∫ã
- ÁõÆÊ†áÈïøÂ∫¶Á∫¶800Â≠óÔºàÈáçË¶ÅÂÜÖÂÆπÂèØ‰ª•ÈÄÇÂΩìÂ¢ûÂä†Ôºâ

### 4. Ê≥®ÊÑè‰∫ãÈ°π
- ‰∏ìÊ≥®‰∫éÂØπÁêÜËß£‰Ω†‰ª¨ÂÖ≥Á≥ªÂíåÊú™Êù•ÂØπËØùÊúâÂ∏ÆÂä©ÁöÑ‰ø°ÊÅØ
- Â¶ÇÊûúËøôÊÆµÊó∂Èó¥ÁöÑÂØπËØùÂÜÖÂÆπÂæàÂ∞ëÊàñÈÉΩ‰∏çÈáçË¶ÅÔºåÊëòË¶ÅÂèØ‰ª•ÁÆÄÁü≠
- ‰øùÊåÅÂÆ¢ËßÇÁúüÂÆûÔºå‰∏çË¶ÅÊ∑ªÂä†Ê≤°ÊúâÂèëÁîüËøáÁöÑÂÜÖÂÆπ

ËØ∑Áõ¥Êé•ËæìÂá∫Êõ¥Êñ∞ÂêéÁöÑËÆ∞ÂøÜÊëòË¶ÅÔºå‰∏çË¶ÅÂåÖÂê´‰ªª‰ΩïËß£ÈáäÊàñÂÖÉ‰ø°ÊÅØ„ÄÇ`;
                
                // Call AI
                console.log('üì§ Sending summary request to AI...');
                console.log(`Messages to summarize: ${recentMessages.length}`);
                console.log(`Previous summary length: ${previousSummary.length} characters`);
                
                const data = await makeAPIRequest(
                    apiConfig.proxyUrl,
                    apiConfig.apiKey,
                    apiConfig.model || 'gpt-3.5-turbo',
                    [{ role: 'user', content: prompt }],
                    0.7 // Lower temperature for more consistent summaries
                );
                
                if (!data.choices || data.choices.length === 0 || !data.choices[0].message.content) {
                    throw new Error('AIËøîÂõû‰∫ÜÁ©∫ÂìçÂ∫î');
                }
                
                const newSummary = data.choices[0].message.content.trim();
                
                console.log('‚úÖ AI summary generated');
                console.log(`New summary length: ${newSummary.length} characters`);
                
                return newSummary;
            }
            // ‚ñ≤‚ñ≤‚ñ≤ Auto-Summary World Book Management End ‚ñ≤‚ñ≤‚ñ≤

            // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊäïÁ•®ÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ ‚ñº‚ñº‚ñº

            /**
             * ÊâìÂºÄÂàõÂª∫ÊäïÁ•®ÁöÑÊ®°ÊÄÅÊ°ÜÂπ∂ÂàùÂßãÂåñ
             */
            function openCreatePollModal() {
                const modal = document.getElementById('create-poll-modal');
                document.getElementById('poll-question-input').value = '';
                const optionsContainer = document.getElementById('poll-options-container');
                optionsContainer.innerHTML = '';

                // ÈªòËÆ§ÂàõÂª∫‰∏§‰∏™Á©∫ÁöÑÈÄâÈ°πÊ°Ü
                addPollOptionInput();
                addPollOptionInput();

                modal.classList.add('visible');
            }

            /**
             * Âú®Ê®°ÊÄÅÊ°Ü‰∏≠Âä®ÊÄÅÊ∑ªÂä†‰∏Ä‰∏™ÈÄâÈ°πËæìÂÖ•Ê°Ü
             */
            function addPollOptionInput() {
                const container = document.getElementById('poll-options-container');
                const wrapper = document.createElement('div');
                wrapper.className = 'poll-option-input-wrapper';
                wrapper.innerHTML = `
        <input type="text" class="poll-option-input" placeholder="ÈÄâÈ°πÂÜÖÂÆπ...">
        <button class="remove-option-btn">-</button>
    `;

                wrapper.querySelector('.remove-option-btn').addEventListener('click', () => {
                    // Á°Æ‰øùËá≥Â∞ë‰øùÁïô‰∏§‰∏™ÈÄâÈ°π
                    if (container.children.length > 2) {
                        wrapper.remove();
                    } else {
                        alert('ÊäïÁ•®Ëá≥Â∞ëÈúÄË¶Å2‰∏™ÈÄâÈ°π„ÄÇ');
                    }
                });

                container.appendChild(wrapper);
            }

            /**
             * Áî®Êà∑Á°ÆËÆ§ÂèëËµ∑ÊäïÁ•®
             */
            async function sendPoll() {
                if (!state.activeChatId) return;

                const question = document.getElementById('poll-question-input').value.trim();
                if (!question) {
                    alert('ËØ∑ËæìÂÖ•ÊäïÁ•®ÈóÆÈ¢òÔºÅ');
                    return;
                }

                const options = Array.from(document.querySelectorAll('.poll-option-input'))
                    .map(input => input.value.trim())
                    .filter(text => text); // ËøáÊª§ÊéâÁ©∫ÁöÑÈÄâÈ°π

                if (options.length < 2) {
                    alert('ËØ∑Ëá≥Â∞ëËæìÂÖ•2‰∏™ÊúâÊïàÁöÑÊäïÁ•®ÈÄâÈ°πÔºÅ');
                    return;
                }

                const chat = state.chats[state.activeChatId];
                const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

                const newPollMessage = {
                    role: 'user',
                    senderName: myNickname,
                    type: 'poll',
                    timestamp: Date.now(),
                    question: question,
                    options: options,
                    votes: {}, // ÂàùÂßãÊäïÁ•®‰∏∫Á©∫
                    isClosed: false,
                };

                chat.history.push(newPollMessage);
                await db.chats.put(chat);

                appendMessage(newPollMessage, chat);
                renderChatList();

                document.getElementById('create-poll-modal').classList.remove('visible');
            }

            // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤‰øÆÂ§çÈáçÂ§çÁÇπÂáªÈóÆÈ¢ò„ÄëÁöÑÁâàÊú¨ÊõøÊç¢ handleUserVote ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            /**
             * Â§ÑÁêÜÁî®Êà∑ÊäïÁ•®ÔºåÂπ∂Â∞Ü‰∫ã‰ª∂‰Ωú‰∏∫ÈöêËóèÊ∂àÊÅØÂ≠òÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï
             * @param {number} timestamp - ÊäïÁ•®Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
             * @param {string} choice - Áî®Êà∑ÈÄâÊã©ÁöÑÈÄâÈ°πÊñáÊú¨
             */
            async function handleUserVote(timestamp, choice) {
                const chat = state.chats[state.activeChatId];
                const poll = chat.history.find(m => m.timestamp === timestamp);
                const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

                // 1. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ¶ÇÊûúÊäïÁ•®‰∏çÂ≠òÂú®ÊàñÂ∑≤ÂÖ≥Èó≠ÔºåÁõ¥Êé•ËøîÂõû
                if (!poll || poll.isClosed) {
                    // Â¶ÇÊûúÊòØÂ∑≤ÂÖ≥Èó≠ÁöÑÊäïÁ•®ÔºåÂàôÁõ¥Êé•ÊòæÁ§∫ÁªìÊûú
                    if (poll && poll.isClosed) {
                        showPollResults(timestamp);
                    }
                    return;
                }

                // 2. Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶ÁÇπÂáª‰∫ÜÂ∑≤ÁªèÊäïËøáÁöÑÂêå‰∏Ä‰∏™ÈÄâÈ°π
                const isReclickingSameOption = poll.votes[choice] && poll.votes[choice].includes(myNickname);

                // 3. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ¶ÇÊûú‰∏çÊòØÈáçÂ§çÁÇπÂáªÔºåÊâçÊâßË°åÊäïÁ•®ÈÄªËæë
                if (!isReclickingSameOption) {
                    // ÁßªÈô§ÊóßÊäïÁ•®ÔºàÂ¶ÇÊûúÁî®Êà∑ÊîπÈÄâÔºâ
                    for (const option in poll.votes) {
                        const voterIndex = poll.votes[option].indexOf(myNickname);
                        if (voterIndex > -1) {
                            poll.votes[option].splice(voterIndex, 1);
                        }
                    }
                    // Ê∑ªÂä†Êñ∞ÊäïÁ•®
                    if (!poll.votes[choice]) {
                        poll.votes[choice] = [];
                    }
                    poll.votes[choice].push(myNickname);
                }

                // 4. „ÄêÊ†∏ÂøÉÈÄªËæë„ÄëÁé∞Âú®Âè™Â§ÑÁêÜÁî®Êà∑ÊäïÁ•®‰∫ã‰ª∂Ôºå‰∏çÂÜçÊ£ÄÊü•ÊòØÂê¶ÁªìÊùü
                let hiddenMessageContent = null;

                // Âè™ÊúâÂú®Áî®Êà∑ÁúüÊ≠£ÊäïÁ•®ÊàñÊîπÁ•®Êó∂ÔºåÊâçÁîüÊàêÊèêÁ§∫
                if (!isReclickingSameOption) {
                    hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) ÂàöÂàöÊäïÁ•®Áªô‰∫Ü ‚Äú${choice}‚Äù„ÄÇ]`;
                }

                // 5. Â¶ÇÊûúÊúâÈúÄË¶ÅÈÄöÁü•AIÁöÑ‰∫ã‰ª∂ÔºåÂàôÂàõÂª∫Âπ∂Ê∑ªÂä†ÈöêËóèÊ∂àÊÅØ
                if (hiddenMessageContent) {
                    const hiddenMessage = {
                        role: 'system',
                        content: hiddenMessageContent,
                        timestamp: Date.now(),
                        isHidden: true,
                    };
                    chat.history.push(hiddenMessage);
                }

                // 6. ‰øùÂ≠òÊï∞ÊçÆÂπ∂Êõ¥Êñ∞UI
                await db.chats.put(chat);
                renderChatInterface(state.activeChatId);
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            /**
             * Áî®Êà∑ÁªìÊùüÊäïÁ•®ÔºåÂπ∂Â∞Ü‰∫ã‰ª∂‰Ωú‰∏∫ÈöêËóèÊ∂àÊÅØÂ≠òÂÖ•ÂéÜÂè≤ËÆ∞ÂΩï
             * @param {number} timestamp - ÊäïÁ•®Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
             */
            async function endPoll(timestamp) {
                const chat = state.chats[state.activeChatId];
                const poll = chat.history.find(m => m.timestamp === timestamp);
                if (!poll || poll.isClosed) return;

                const confirmed = await showCustomConfirm("ÁªìÊùüÊäïÁ•®", "Á°ÆÂÆöË¶ÅÁªìÊùüËøô‰∏™ÊäïÁ•®ÂêóÔºüÁªìÊùüÂêéÂ∞ÜÊó†Ê≥ïÂÜçËøõË°åÊäïÁ•®„ÄÇ");
                if (confirmed) {
                    poll.isClosed = true;

                    const resultSummary = poll.options.map(opt => `‚Äú${opt}‚Äù(${poll.votes[opt]?.length || 0}Á•®)`).join('Ôºå');
                    const hiddenMessageContent = `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊâãÂä®ÁªìÊùü‰∫ÜÊäïÁ•®ÔºÅÊúÄÁªàÁªìÊûú‰∏∫Ôºö${resultSummary}„ÄÇ]`;

                    const hiddenMessage = {
                        role: 'system',
                        content: hiddenMessageContent,
                        timestamp: Date.now(),
                        isHidden: true,
                    };
                    chat.history.push(hiddenMessage);

                    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂè™‰øùÂ≠òÊï∞ÊçÆÂíåÊõ¥Êñ∞UIÔºå‰∏çË∞ÉÁî® triggerAiResponse()
                    await db.chats.put(chat);
                    renderChatInterface(state.activeChatId);
                }
            }
            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

            /**
             * ÊòæÁ§∫ÊäïÁ•®ÁªìÊûúËØ¶ÊÉÖ
             * @param {number} timestamp - ÊäïÁ•®Ê∂àÊÅØÁöÑÊó∂Èó¥Êà≥
             */
            function showPollResults(timestamp) {
                const chat = state.chats[state.activeChatId];
                const poll = chat.history.find(m => m.timestamp === timestamp);
                if (!poll || !poll.isClosed) return;

                let resultsHtml = `<p><strong>${poll.question}</strong></p><hr style="opacity: 0.2; margin: 10px 0;">`;

                if (Object.keys(poll.votes).length === 0) {
                    resultsHtml += '<p style="color: #8a8a8a;">ËøòÊ≤°Êúâ‰∫∫ÊäïÁ•®„ÄÇ</p>';
                } else {
                    poll.options.forEach(option => {
                        const voters = poll.votes[option] || [];
                        resultsHtml += `
                <div style="margin-bottom: 15px;">
                    <p style="font-weight: 500; margin: 0 0 5px 0;">${option} (${voters.length}Á•®)</p>
                    <p style="font-size: 13px; color: #555; margin: 0; line-height: 1.5;">
                        ${voters.length > 0 ? voters.join('„ÄÅ ') : 'Êó†‰∫∫ÊäïÁ•®'}
                    </p>
                </div>
            `;
                    });
                }

                showCustomAlert("ÊäïÁ•®ÁªìÊûú", resultsHtml);
            }

            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂÖ¨ÂëäÊùøÂäüËÉΩÊ†∏ÂøÉÂáΩÊï∞ - ËØ∑Â∞ÜÊï¥Âùó‰ª£Á†ÅÁ≤òË¥¥Âà∞JSÂäüËÉΩÂå∫ ‚ñº‚ñº‚ñº

            /**
             * ÊâìÂºÄÂÖ¨ÂëäÊùøÊ®°ÊÄÅÊ°ÜÂπ∂Ê∏≤ÊüìÂÜÖÂÆπ
             */
            async function openBulletinBoard() {
                if (!state.activeChatId) return;
                const modal = document.getElementById('bulletin-board-modal');
                await renderBulletinBoard();
                modal.classList.add('visible');
            }

            /**
             * Ê∏≤ÊüìÂÖ¨ÂëäÊùøÂàóË°®
             */
            // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªàÊ≠£Á°ÆÁâà„ÄëËØ∑Áî®Ëøô‰∏™ÂÆåÊï¥ÁöÑÂáΩÊï∞ÔºåÊõøÊç¢ÊóßÁöÑ renderBulletinBoard ÂáΩÊï∞ ‚ñº‚ñº‚ñº
            async function renderBulletinBoard() {
                const listEl = document.getElementById('bulletin-list');
                listEl.innerHTML = '';
                const chatId = state.activeChatId;

                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂè™‰ªéÊñ∞ÁöÑ 'bulletins' Ë°®‰∏≠ËØªÂèñÊï∞ÊçÆ
                const bulletins = await db.bulletins.where({ chatId: chatId }).toArray();

                bulletins.sort((a, b) => {
                    if (a.isPinned && !b.isPinned) return -1;
                    if (!a.isPinned && b.isPinned) return 1;
                    return b.timestamp - a.timestamp;
                });

                if (bulletins.length === 0) {
                    listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Ëøô‰∏™Áæ§ËøòÊ≤°Êúâ‰ªª‰ΩïÂÖ¨ÂëäÂì¶~</p>';
                    return;
                }

                bulletins.forEach(bulletin => {
                    const member = state.chats[chatId].members.find(m => m.name === bulletin.authorName);
                    const authorAvatar = member ? member.avatar : defaultGroupMemberAvatar;

                    let commentsHtml = '';
                    if (bulletin.comments && bulletin.comments.length > 0) {
                        commentsHtml += '<div class="post-footer"><div class="post-comments-container">';
                        bulletin.comments.forEach(comment => {
                            const commenterName = comment.commenterName || "ÂåøÂêç";
                            const commentText = comment.text || "";
                            commentsHtml += `<div class="comment-item"><span class="commenter-name">${commenterName}:</span><span class="comment-text">${commentText}</span></div>`;
                        });
                        commentsHtml += '</div></div>';
                    }

                    const card = document.createElement('div');
                    card.className = `qzone-post-item bulletin-card ${bulletin.isPinned ? 'pinned' : ''}`;
                    card.innerHTML = `
            <div class="post-header">
                <img src="${authorAvatar}" class="post-avatar">
                <div class="post-info">
                    <span class="post-nickname">${bulletin.authorName}</span>
                    <span class="post-timestamp">${formatPostTimestamp(bulletin.timestamp)}</span>
                </div>
                <div class="bulletin-actions-btn" data-id="${bulletin.id}">‚Ä¶</div>
            </div>
            <div class="post-content">${bulletin.description.replace(/\n/g, '<br>')}</div>
            ${commentsHtml} 
        `;
                    listEl.appendChild(card);
                });
            }

            // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤


            /**
             * ÊòæÁ§∫ÂÖ¨ÂëäÊìç‰ΩúËèúÂçï
             * @param {number} bulletinId - ÂÖ¨ÂëäÁöÑID
             */
            function showBulletinActions(bulletinId) {
                activeBulletinId = bulletinId;
                document.getElementById('bulletin-actions-modal').classList.add('visible');
            }

            /**
             * ÈöêËóèÂÖ¨ÂëäÊìç‰ΩúËèúÂçï
             */
            function hideBulletinActions() {
                document.getElementById('bulletin-actions-modal').classList.remove('visible');
                activeBulletinId = null;
            }

            /**
             * Â§ÑÁêÜÁΩÆÈ°∂/ÂèñÊ∂àÁΩÆÈ°∂ÂÖ¨Âëä
             */
            async function handlePinBulletin() {
                if (!activeBulletinId) return;
                const bulletin = await db.bulletins.get(activeBulletinId); // <--- „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„Äë‰ªéÊ≠£Á°ÆÁöÑ bulletins Ë°®Ëé∑ÂèñÊï∞ÊçÆ
                if (bulletin) {
                    bulletin.isPinned = !bulletin.isPinned;
                    await db.bulletins.put(bulletin); // <--- „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ∞ÜÊõ¥Êñ∞ÂÜôÂõûÂà∞Ê≠£Á°ÆÁöÑ bulletins Ë°®
                    await renderBulletinBoard(); // ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®‰ª•Êõ¥Êñ∞È°∫Â∫èÂíåÊ†∑Âºè
                }
                hideBulletinActions();
            }

            /**
             * Â§ÑÁêÜÂà†Èô§ÂÖ¨Âëä
             */
            async function handleDeleteBulletin() {
                if (!activeBulletinId) return;
                const confirmed = await showCustomConfirm('Âà†Èô§ÂÖ¨Âëä', 'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ÂÖ¨ÂëäÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ', { confirmButtonClass: 'btn-danger' });
                if (confirmed) {
                    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂè™Êìç‰ΩúÊñ∞Ë°®
                    await db.bulletins.delete(activeBulletinId);
                    await renderBulletinBoard();
                }
                hideBulletinActions();
            }

            /**
             * Â§ÑÁêÜÁî®Êà∑ÊâãÂä®ÂèëËµ∑ÂÖ¨Âëä
             * @param {number} timestamp - Ë¢´ÈïøÊåâÁöÑÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥
             */
            async function handleUserCreateBulletin(timestamp) {
                if (!timestamp) return;

                const chat = state.chats[state.activeChatId];
                const message = chat.history.find(m => m.timestamp === timestamp);
                if (!message || typeof message.content !== 'string') {
                    alert("Âè™ËÉΩÂ∞ÜÁ∫ØÊñáÊú¨Ê∂àÊÅØÂèëÂ∏ÉÂà∞ÂÖ¨ÂëäÊùø„ÄÇ");
                    return;
                }

                const content = await showCustomPrompt('ÂèëÂ∏ÉÂÖ¨Âëä', 'ËØ∑Á°ÆËÆ§ÊàñÁºñËæëÂÖ¨ÂëäÂÜÖÂÆπÔºö', message.content, 'textarea');
                if (content === null || !content.trim()) return;

                const myNickname = chat.settings.myNickname || 'Êàë';
                const myAvatar = chat.settings.myAvatar || defaultMyGroupAvatar;
                const now = Date.now();

                // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÊï∞ÊçÆÂ≠òÂÖ•Êñ∞Ë°®
                await db.bulletins.add({
                    chatId: chat.id,
                    authorName: myNickname,
                    description: content.trim(),
                    timestamp: now,
                    isPinned: false
                });

                const bulletinMessage = {
                    role: 'assistant',
                    type: 'bulletin',
                    content: content.trim(),
                    timestamp: now,
                    authorName: myNickname,
                    authorAvatar: myAvatar
                };
                chat.history.push(bulletinMessage);
                appendMessage(bulletinMessage, chat);

                const hiddenMessage = {
                    role: 'system',
                    content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ (${myNickname}) ÂàöÂàöÂèëÂ∏É‰∫Ü‰∏ÄÊù°ÂÖ¨ÂëäÔºö‚Äú${content.trim()}‚Äù„ÄÇËØ∑‰Ω†‰ª¨ÂØπÊ≠§ÂèëË°®ËØÑËÆ∫„ÄÇ]`,
                    timestamp: now + 1,
                    isHidden: true,
                };
                chat.history.push(hiddenMessage);
                await db.chats.put(chat);
            }

            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂäüËÉΩÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
            // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøô„Äê‰∏ÄÊï¥ÂùóÂÖ®Êñ∞ÁöÑÂáΩÊï∞„ÄëÁ≤òË¥¥Âà∞‰∏ãÈù¢ÊåáÂÆöÁöÑ‰ΩçÁΩÆ ‚ñº‚ñº‚ñº

            /**
             * „ÄêÂèØÂ§çÁî®Ê®°Âùó V2„ÄëÊ†πÊçÆChatIDËé∑ÂèñÂπ∂Ê†ºÂºèÂåñÊâÄÊúâÁΩÆÈ°∂ÂÖ¨Âëä (‰ΩøÁî®ÁªìÊûÑÂåñÊï∞ÊçÆÊ®°Âºè)
             * @param {string} chatId - Ë¶ÅÊü•ËØ¢ÁöÑÁæ§ËÅäID
             * @returns {Promise<string>} - ËøîÂõûÊ†ºÂºèÂåñÂ•ΩÁöÑÁªìÊûÑÂåñÂ≠óÁ¨¶‰∏≤ÔºåÊàñÁ©∫Â≠óÁ¨¶‰∏≤
             */
            async function getFormattedPinnedBulletins(chatId) {
                // 1. ‰ªéÊï∞ÊçÆÂ∫ìÊü•ËØ¢ÔºåÂè™Êâæ isPinned: true ÁöÑ
                // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂÖàÊü•Âá∫ÊâÄÊúâÂÖ¨ÂëäÔºåÂÜçÁî®‰ª£Á†ÅËøáÊª§ÁΩÆÈ°∂È°πÔºåÁ°Æ‰øùÊü•ËØ¢Á®≥ÂÆöÂèØÈù†
                const allBulletins = await db.memories.where({ chatId: chatId, type: 'bulletin' }).toArray();
                const pinnedBulletins = allBulletins.filter(b => b.isPinned);

                // 2. Â¶ÇÊûúÊ≤°ÊúâÁΩÆÈ°∂ÂÖ¨ÂëäÔºåÁõ¥Êé•ËøîÂõûÁ©∫Â≠óÁ¨¶‰∏≤
                if (pinnedBulletins.length === 0) {
                    return '';
                }

                // 3. ÊåâÊó∂Èó¥È°∫Â∫èÊéíÂ∫è
                pinnedBulletins.sort((a, b) => a.timestamp - b.timestamp);

                // 4. „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÊ†ºÂºèÂåñÊØè‰∏ÄÊù°ÂÖ¨Âëä‰∏∫YAML-likeÊ†ºÂºè
                const bulletinsContext = pinnedBulletins.map(b => {
                    const author = b.authorName;
                    const time = new Date(b.timestamp).toLocaleString('zh-CN', { dateStyle: 'long', timeStyle: 'short' });

                    // „ÄêÂÖ≥ÈîÆ„Äë‰∏∫‰∫Ü‰øùÊåÅYAMLÊ†ºÂºèÁöÑÊ≠£Á°ÆÁº©ËøõÔºåÊàë‰ª¨ÈúÄË¶ÅÊâãÂä®‰∏∫ÊØè‰∏ÄË°åÂÜÖÂÆπÊ∑ªÂä†ÂâçÂØºÁ©∫Ê†º
                    // content: | ÁöÑ‰∏ã‰∏ÄË°åÂÜÖÂÆπÔºåÈúÄË¶ÅÊØî content: Â§ö‰∏§‰∏™Á©∫Ê†º
                    const indentedContent = b.description.split('\n').map(line => `      ${line}`).join('\n'); // 6‰∏™ÂâçÂØºÁ©∫Ê†º

                    // ËøîÂõûÊãºÊé•Â•ΩÁöÑÁªìÊûÑÂåñÊï∞ÊçÆÂ≠óÁ¨¶‰∏≤
                    return `
  - bulletin:
      author: ${author}
      timestamp: ${time}
      content: |
${indentedContent}`;
                }).join(''); // „ÄêÊ≥®ÊÑè„ÄëËøôÈáå‰∏çÂÜçÁî®'\n'ËøûÊé•ÔºåÂõ†‰∏∫ÊØè‰∏™ÂùóËá™Â∏¶Êç¢Ë°å

                // 5. ÁªÑË£ÖÊàêÊúÄÁªàÁöÑ„ÄÅÂ∏¶ÊúâÊñ∞Ê†áÈ¢òÁöÑÊ®°ÂùóÂπ∂ËøîÂõû
                return `
# ÂΩìÂâçÁöÑÁæ§ÂÖ¨Âëä 
${bulletinsContext}
`;
            }

            // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞ÂáΩÊï∞Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤


            // ===================================================================
            // 4. ÂàùÂßãÂåñÂáΩÊï∞ init()
            // ===================================================================
            async function init() {

                // ‚ñº‚ñº‚ñº Êñ∞Â¢û‰ª£Á†Å ‚ñº‚ñº‚ñº
                const customBubbleStyleTag = document.createElement('style');
                customBubbleStyleTag.id = 'custom-bubble-style';
                document.head.appendChild(customBubbleStyleTag);
                // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº Êñ∞Â¢û‰ª£Á†Å ‚ñº‚ñº‚ñº
                const previewBubbleStyleTag = document.createElement('style');
                previewBubbleStyleTag.id = 'preview-bubble-style';
                document.head.appendChild(previewBubbleStyleTag);
                // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                window.showScreen = showScreen;
                window.renderChatListProxy = renderChatList;
                window.renderApiSettingsProxy = renderApiSettings;
                window.renderWallpaperScreenProxy = renderWallpaperScreen;
                window.renderWorldBookScreenProxy = renderWorldBookScreen;
                window.renderSettingsScreenProxy = renderSettingsScreen;
                window.renderCalendarScreenProxy = renderCalendarScreen;

                await loadAllDataFromDB();

                // Restore active meetup session from localStorage if exists
                restoreActiveMeetupSession();

                // Check for active meetup session and show progress bar if needed
                if (hasActiveMeetupSession()) {
                    showMeetupProgressBar();
                }

                // ÂàùÂßãÂåñÊú™ËØªÂä®ÊÄÅËÆ°Êï∞
                const storedCount = parseInt(localStorage.getItem('unreadPostsCount')) || 0;
                updateUnreadIndicator(storedCount);

                // ‚ñ≤‚ñ≤‚ñ≤ ‰ª£Á†ÅÊ∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                if (state.globalSettings && state.globalSettings.fontUrl) {
                    applyCustomFont(state.globalSettings.fontUrl);
                }

                updateClock();
                setInterval(updateClock, 1000 * 30);
                applyGlobalWallpaper();
                applyAppIconsToHomeScreen();
                initBatteryManager();

                // Initialize Spotify if token exists
                if (getSpotifyTokenFromUrl()) {
                    initSpotifyPlayer();
                } else {
                    // Try to load saved Spotify token
                    loadSavedSpotifyToken();
                }

                // Handle custom URL scheme for Spotify callback
                window.handleOpenURL = function (url) {
                    handleSpotifyCallback(url);
                };

                // ==========================================================
                // --- ÂêÑÁßç‰∫ã‰ª∂ÁõëÂê¨Âô® ---
                // ==========================================================
                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂÖ¨ÂëäÊùøÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
                document.getElementById('open-bulletin-board-btn').addEventListener('click', openBulletinBoard);
                document.getElementById('close-bulletin-board-btn').addEventListener('click', () => {
                    document.getElementById('bulletin-board-modal').classList.remove('visible');
                });

                // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÂÖ¨ÂëäÂàóË°®‰∏≠ÁöÑÁÇπÂáª‰∫ã‰ª∂
                document.getElementById('bulletin-list').addEventListener('click', (e) => {
                    const actionsBtn = e.target.closest('.bulletin-actions-btn');
                    if (actionsBtn) {
                        showBulletinActions(parseInt(actionsBtn.dataset.id));
                    }
                });

                // ÂÖ¨ÂëäÊìç‰ΩúËèúÂçïÁöÑÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('pin-bulletin-btn').addEventListener('click', handlePinBulletin);
                document.getElementById('delete-bulletin-btn').addEventListener('click', handleDeleteBulletin);
                document.getElementById('cancel-bulletin-action-btn').addEventListener('click', hideBulletinActions);

                // Â∞ÜÈïøÊåâËèúÂçï‰∏≠ÁöÑ‚ÄúÂèëÂ∏ÉÂÖ¨Âëä‚Äù‰∏éÊñ∞ÂäüËÉΩËøûÊé•
                document.getElementById('post-bulletin-btn').addEventListener('click', () => {
                    if (activeMessageTimestamp) {
                        handleUserCreateBulletin(activeMessageTimestamp);
                    }
                    hideMessageActions(); // Êìç‰ΩúÂêéÂÖ≥Èó≠ËèúÂçï
                });

                // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº Share Link Event Listeners ‚ñº‚ñº‚ñº
                document.getElementById('share-link-btn').addEventListener('click', openShareLinkModal);
                document.getElementById('cancel-share-link-btn').addEventListener('click', () => {
                    document.getElementById('share-link-modal').classList.remove('visible');
                });
                document.getElementById('confirm-share-link-btn').addEventListener('click', sendUserLinkShare);
                document.getElementById('browser-back-btn').addEventListener('click', closeBrowser);
                // ‚ñ≤‚ñ≤‚ñ≤ Share Link Event Listeners End ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº Chat Search Event Listeners ‚ñº‚ñº‚ñº
                document.getElementById('chat-search-btn').addEventListener('click', openChatSearchModal);
                document.getElementById('close-search-btn').addEventListener('click', () => {
                    document.getElementById('chat-search-modal').classList.remove('visible');
                });
                document.getElementById('search-input').addEventListener('input', performSearch);
                // ‚ñ≤‚ñ≤‚ñ≤ Chat Search Event Listeners End ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº Location Share Event Listeners ‚ñº‚ñº‚ñº
                document.getElementById('share-location-btn').addEventListener('click', openLocationShareModal);
                document.getElementById('cancel-location-btn').addEventListener('click', () => {
                    // Clear edit state and reset UI
                    window.editingLocationTimestamp = null;

                    // Reset modal title and button text
                    document.querySelector('#location-share-modal .modal-header span').textContent = 'ÂàÜ‰∫´‰ΩçÁΩÆ';
                    document.getElementById('confirm-location-btn').textContent = 'ÂèëÈÄÅ‰ΩçÁΩÆ';

                    document.getElementById('location-share-modal').classList.remove('visible');
                });
                document.getElementById('confirm-location-btn').addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    sendUserLocationShare();
                });
                // ‚ñ≤‚ñ≤‚ñ≤ Location Share Event Listeners End ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº Meetup Creation Modal Event Listeners ‚ñº‚ñº‚ñº
                document.getElementById('meetup-btn').addEventListener('click', openMeetupCreationModal);
                document.getElementById('cancel-meetup-btn').addEventListener('click', closeMeetupCreationModal);
                document.getElementById('start-meetup-btn').addEventListener('click', startMeetup);

                // ‚ñº‚ñº‚ñº Sticker Pack Edit Modal Event Listeners ‚ñº‚ñº‚ñº
                document.getElementById('cancel-sticker-pack-edit-btn').addEventListener('click', closeStickerPackEditModal);
                document.getElementById('save-sticker-pack-btn').addEventListener('click', saveStickerPackEdit);
                document.getElementById('delete-sticker-pack-btn').addEventListener('click', deleteStickerPack);

                // Add keyboard support for sticker pack edit modal
                document.getElementById('sticker-pack-edit-modal').addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeStickerPackEditModal();
                    } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        saveStickerPackEdit();
                    }
                });

                // ‚ñº‚ñº‚ñº New Sticker Pack Modal Event Listeners ‚ñº‚ñº‚ñº
                document.getElementById('add-pack-btn').addEventListener('click', openNewStickerPackModal);
                document.getElementById('cancel-new-pack-btn').addEventListener('click', closeNewStickerPackModal);
                document.getElementById('create-new-pack-btn').addEventListener('click', createNewStickerPack);

                // Add keyboard support for new sticker pack modal
                document.getElementById('new-sticker-pack-modal').addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeNewStickerPackModal();
                    } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        createNewStickerPack();
                    }
                });

                // Add keyboard support for date creation modal
                document.getElementById('meetup-creation-modal').addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeMeetupCreationModal();
                    } else if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        startMeetup();
                    }
                });

                // Add Enter key support for input fields
                document.getElementById('meetup-location-input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        document.getElementById('meetup-title-input').focus();
                    }
                });

                document.getElementById('meetup-title-input').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        startMeetup();
                    }
                });
                // ‚ñ≤‚ñ≤‚ñ≤ Date Creation Modal Event Listeners End ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº Meetup Edit Button Event Listener ‚ñº‚ñº‚ñº
                const meetupEditBtn = document.getElementById('meetup-edit-btn');
                if (meetupEditBtn) {
                    meetupEditBtn.addEventListener('click', openMeetupEditModal);
                }

                // ‚ñº‚ñº‚ñº Date End Modal Event Listeners ‚ñº‚ñº‚ñº
                const endDateBtn = document.getElementById('end-date-btn');
                if (endDateBtn) {
                    endDateBtn.addEventListener('click', showMeetupEndModal);
                }

                const cancelEndDateBtn = document.getElementById('cancel-end-date-btn');
                if (cancelEndDateBtn) {
                    cancelEndDateBtn.addEventListener('click', hideMeetupEndModal);
                }

                const confirmEndDateBtn = document.getElementById('confirm-end-date-btn');
                if (confirmEndDateBtn) {
                    confirmEndDateBtn.addEventListener('click', confirmEndMeetup);
                }
                // ‚ñ≤‚ñ≤‚ñ≤ Meetup End Modal Event Listeners End ‚ñ≤‚ñ≤‚ñ≤

                document.getElementById('custom-modal-cancel').addEventListener('click', hideCustomModal);
                document.getElementById('custom-modal-overlay').addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });
                document.getElementById('export-data-btn').addEventListener('click', window.exportWithPermissionCheck);
                document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
                document.getElementById('import-data-input').addEventListener('change', e => importBackup(e.target.files[0]));


                document.getElementById('back-to-list-btn').addEventListener('click', () => {
                    // ‚ñº‚ñº‚ñº ‰øÆÊîπËøô‰∏§Ë°å ‚ñº‚ñº‚ñº
                    applyScopedCss('', '#chat-messages', 'custom-bubble-style'); // Ê∏ÖÈô§ÁúüÂÆûËÅäÂ§©ÁïåÈù¢ÁöÑËá™ÂÆö‰πâÊ†∑Âºè
                    applyScopedCss('', '#settings-preview-area', 'preview-bubble-style'); // Ê∏ÖÈô§È¢ÑËßàÂå∫ÁöÑËá™ÂÆö‰πâÊ†∑Âºè
                    // ‚ñ≤‚ñ≤‚ñ≤ ‰øÆÊîπÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤
                    exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen');
                });

                document.getElementById('add-chat-btn').addEventListener('click', async () => {
                    const name = await showCustomPrompt('ÂàõÂª∫Êñ∞ËÅäÂ§©', 'ËØ∑ËæìÂÖ•TaÁöÑÂêçÂ≠ó');
                    if (name && name.trim()) {
                        const newChatId = 'chat_' + Date.now();
                        const newChat = {
                            id: newChatId,
                            name: name.trim(),
                            isGroup: false,
                            relationship: {
                                status: 'friend',
                                blockedTimestamp: null,
                                applicationReason: ''
                            },
                            //„ÄêÊ†∏ÂøÉÊñ∞Â¢û„Äë‰∏∫Êñ∞ËßíËâ≤Ê∑ªÂä†Áä∂ÊÄÅÂØπË±°
                            statusState: {
                                lastAiActivityTime: Date.now(),
                                focusModeEndTime: null,
                                focusModeText: ""
                            },
                            settings: {
                                aiPersona: '‰Ω†ÊòØË∞ÅÂëÄ„ÄÇ',
                                myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ',
                                maxMemory: 10,
                                aiAvatar: defaultAvatar,
                                myAvatar: defaultAvatar,
                                background: '',
                                theme: 'default',
                                fontSize: 13,
                                customCss: '',
                                linkedWorldBookIds: [],
                                aiAvatarFrame: '',
                                myAvatarFrame: '',
                                isBackgroundActivityEnabled: true // <--„ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÈªòËÆ§ÂºÄÂêØ
                            },
                            history: [],
                            musicData: { totalTime: 0 }
                        };
                        state.chats[newChatId] = newChat;
                        await db.chats.put(newChat);
                        renderChatList();
                    }
                });

                // ‚ñº‚ñº‚ñº „Äê‰øÆÊ≠£„ÄëÂàõÂª∫Áæ§ËÅäÊåâÈíÆÁé∞Âú®ÊâìÂºÄËÅîÁ≥ª‰∫∫ÈÄâÊã©Âô® ‚ñº‚ñº‚ñº
                document.getElementById('add-group-chat-btn').addEventListener('click', openContactPickerForGroupCreate);
                // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤                      
                document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
                document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);

                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËΩ¨Ë¥¶Êé•Âèó/ÊãíÁªù‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
                document.getElementById('transfer-action-accept').addEventListener('click', () => handleUserTransferResponse('accepted'));
                document.getElementById('transfer-action-decline').addEventListener('click', () => handleUserTransferResponse('declined'));
                document.getElementById('transfer-action-cancel').addEventListener('click', hideTransferActionModal);
                // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰∫ã‰ª∂ÁõëÂê¨Âô®ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËΩ¨Ë¥¶Âç°ÁâáÁÇπÂáª‰∫ã‰ª∂Â§ÑÁêÜ ‚ñº‚ñº‚ñº
                document.getElementById('chat-messages').addEventListener('click', (e) => {
                    // Handle share link card clicks
                    const shareCard = e.target.closest('.link-share-card[data-timestamp]');
                    if (shareCard && shareCard.closest('.message-bubble.is-link-share')) {
                        const timestamp = parseInt(shareCard.dataset.timestamp);
                        openBrowser(timestamp);
                        return;
                    }

                    // 1. Âêë‰∏äÊü•ÊâæË¢´ÁÇπÂáªÁöÑÂÖÉÁ¥†ÊòØÂê¶Âú®‰∏Ä‰∏™Ê∂àÊÅØÊ∞îÊ≥°ÂÜÖ
                    const bubble = e.target.closest('.message-bubble');
                    if (!bubble) return; // Â¶ÇÊûú‰∏çÂú®ÔºåÂ∞±ÈÄÄÂá∫

                    // 2. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÊ∑ªÂä†‰∏•Ê†ºÁöÑÁ≠õÈÄâÊù°‰ª∂
                    // ÂøÖÈ°ªÊòØ AI ÁöÑÊ∂àÊÅØ (.ai)
                    // ÂøÖÈ°ªÊòØËΩ¨Ë¥¶Á±ªÂûã (.is-transfer)
                    // ÂøÖÈ°ªÊòØÊàë‰ª¨Ê†áËÆ∞‰∏∫"ÂæÖÂ§ÑÁêÜ"ÁöÑ (data-status="pending")
                    if (bubble.classList.contains('ai') &&
                        bubble.classList.contains('is-transfer') &&
                        bubble.dataset.status === 'pending') {

                        // 3. Âè™ÊúâÊª°Ë∂≥ÊâÄÊúâÊù°‰ª∂ÔºåÊâçÊâßË°åÂêéÁª≠ÈÄªËæë
                        const timestamp = parseInt(bubble.dataset.timestamp);
                        if (!isNaN(timestamp)) {
                            showTransferActionModal(timestamp);
                        }
                    }
                });
                // ‚ñ≤‚ñ≤‚ñ≤ ËΩ¨Ë¥¶Âç°ÁâáÁÇπÂáªÂ§ÑÁêÜÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);

                document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
                document.getElementById('music-return-btn').addEventListener('click', returnToChat);

                // Add click-outside-to-close functionality for music player overlay
                document.getElementById('music-player-overlay').addEventListener('click', (e) => {
                    // Only close if clicking on the overlay background, not the music player window
                    if (e.target.id === 'music-player-overlay') {
                        returnToChat();
                    }
                });

                document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);

                // Initialize now playing bar
                initializeNowPlayingBar();
                initializeHomeNowPlayingBar();

                // Initialize meetup progress bar
                initializeMeetupProgressBar();

                // Handle app visibility changes for date session persistence
                document.addEventListener('visibilitychange', () => {
                    if (document.visibilityState === 'visible') {
                        // App became visible - restore date session if needed
                        if (!hasActiveDateSession()) {
                            restoreActiveDateSession();
                        }

                        // Show progress bar if there's an active session
                        if (hasActiveMeetupSession()) {
                            showMeetupProgressBar();
                        }
                    }
                });

                // Handle page unload to ensure session state is saved
                window.addEventListener('beforeunload', () => {
                    if (hasActiveMeetupSession()) {
                        localStorage.setItem('activeMeetupSession', JSON.stringify(window.activeMeetupSession));
                        localStorage.setItem('activeMeetupEventId', window.activeMeetupEventId);
                    }
                });

                // Cordova-specific app lifecycle events
                document.addEventListener('deviceready', () => {
                    // Handle app pause (backgrounding)
                    document.addEventListener('pause', () => {
                        if (hasActiveMeetupSession()) {
                            localStorage.setItem('activeMeetupSession', JSON.stringify(window.activeMeetupSession));
                            localStorage.setItem('activeMeetupEventId', window.activeMeetupEventId);
                        }
                    });

                    // Handle app resume (foregrounding)
                    document.addEventListener('resume', () => {
                        // Restore meetup session if needed
                        if (!hasActiveMeetupSession()) {
                            restoreActiveMeetupSession();
                        }

                        // Show progress bar if there's an active session
                        if (hasActiveMeetupSession()) {
                            showMeetupProgressBar();
                        }
                    });
                });
                document.getElementById('music-next-btn').addEventListener('click', playNext);
                document.getElementById('music-prev-btn').addEventListener('click', playPrev);
                document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
                document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
                document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
                document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
                document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
                document.getElementById('add-song-spotify-btn').addEventListener('click', addSongFromSpotify);
                document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
                audioPlayer.addEventListener('ended', playNext);
                audioPlayer.addEventListener('pause', () => { if (musicState.isActive) { musicState.isPlaying = false; updatePlayerUI(); } });
                audioPlayer.addEventListener('play', () => { if (musicState.isActive) { musicState.isPlaying = true; updatePlayerUI(); } });
                audioPlayer.addEventListener('timeupdate', updateNowPlayingProgress);

                const chatInput = document.getElementById('chat-input');
                document.getElementById('send-btn').addEventListener('click', async () => {
                    const content = chatInput.value.trim();
                    if (!content || !state.activeChatId) return;

                    const chat = state.chats[state.activeChatId];
                    const msg = {
                        role: 'user',
                        content,
                        timestamp: Date.now()
                    };

                    // Ê£ÄÊü•ÂΩìÂâçÊòØÂê¶Â§Ñ‰∫éÂºïÁî®ÂõûÂ§çÊ®°Âºè
                    if (currentReplyContext) {
                        msg.quote = currentReplyContext; // Â∞ÜÂºïÁî®‰ø°ÊÅØÈôÑÂä†Âà∞Ê∂àÊÅØÂØπË±°‰∏ä
                    }

                    chat.history.push(msg);
                    await db.chats.put(chat);
                    appendMessage(msg, chat);
                    renderChatList();
                    chatInput.value = '';
                    chatInput.style.height = 'auto';
                    chatInput.focus();

                    // ÂèëÈÄÅÂêéÔºåÂèñÊ∂àÂºïÁî®Ê®°Âºè
                    cancelReplyMode();
                });
                document.getElementById('wait-reply-btn').addEventListener('click', () => triggerAiResponse());
                chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
                chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });

                document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await processImageUpload(file); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
                document.getElementById('save-wallpaper-btn').addEventListener('click', async () => { if (newWallpaperBase64) { state.globalSettings.wallpaper = newWallpaperBase64; await db.globalSettings.put(state.globalSettings); applyGlobalWallpaper(); newWallpaperBase64 = null; alert('Â£ÅÁ∫∏Â∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ'); showScreen('home-screen'); } else alert('ËØ∑ÂÖà‰∏ä‰º†‰∏ÄÂº†Êñ∞Â£ÅÁ∫∏„ÄÇ'); });

                // Charm CSS customization functionality
                const charmCssInput = document.getElementById('custom-charm-css-input');
                const resetCharmCssBtn = document.getElementById('reset-charm-css-btn');

                // Load saved charm CSS
                const savedCharmCss = localStorage.getItem('customCharmCss');
                if (savedCharmCss) {
                    charmCssInput.value = savedCharmCss;
                    applyCharmCss(savedCharmCss);
                }



                // Apply charm CSS on input change
                charmCssInput.addEventListener('input', () => {
                    const css = charmCssInput.value;
                    applyCharmCss(css);
                    localStorage.setItem('customCharmCss', css);
                });

                // Reset charm CSS button
                resetCharmCssBtn.addEventListener('click', () => {
                    // Reset CSS input to correct default
                    charmCssInput.value = `/* Ëá™ÂÆö‰πâÊåÇ‰ª∂Ê†∑Âºè - ÂÆåÊï¥ÈªòËÆ§ËÆæÁΩÆ */
.floating-phone-charm {
  position: fixed;
  top: 48px;
  right: -112px;
  width: 220px;
  height: 220px;
  background-image: url('https://files.catbox.moe/rhrobi.gif');
  background-size: contain;
  background-repeat: no-repeat;
  z-index: 1000;
  pointer-events: auto;
  cursor: grab;
  transition: transform 0.2s ease;
  user-select: none;
}`;

                    // Clear localStorage
                    localStorage.removeItem('customCharmCss');
                    localStorage.removeItem('phoneCharmPosition');

                    // Reset charm position
                    const charm = document.getElementById('floating-phone-charm');
                    if (charm) {
                        // Reset position
                        charm.style.top = '48px';
                        charm.style.right = '-112px';
                        charm.style.left = 'auto';
                        charm.style.bottom = 'auto';

                        // Update the charm instance's original position
                        if (window.floatingCharmInstance) {
                            window.floatingCharmInstance.storeOriginalPosition();
                        }
                    }

                    // Apply default CSS
                    applyCharmCss(charmCssInput.value);
                    alert('ÊåÇ‰ª∂Ê†∑ÂºèÂ∑≤ÈáçÁΩÆÂà∞ÈªòËÆ§Áä∂ÊÄÅÔºÅ');
                });

                // Function to apply custom CSS to charm
                function applyCharmCss(css) {
                    let styleElement = document.getElementById('custom-charm-style');
                    if (!styleElement) {
                        styleElement = document.createElement('style');
                        styleElement.id = 'custom-charm-style';
                        document.head.appendChild(styleElement);
                    }
                    styleElement.textContent = css;
                }



                document.getElementById('save-api-settings-btn').addEventListener('click', async () => {
                    // ‚ñº‚ñº‚ñº Êñ∞Â¢ûÊ†°È™åÈÄªËæë ‚ñº‚ñº‚ñº
                    const proxyUrlToCheck = document.getElementById('proxy-url').value.trim();
                    if (isApiUrlBanned(proxyUrlToCheck)) {
                        alert('Ê≠§APIÂú∞ÂùÄÊó†ÊïàÊàñ‰∏çÂèóÊîØÊåÅÔºåËØ∑Êõ¥Êç¢„ÄÇ');
                        return; // ÂëΩ‰∏≠ÈªëÂêçÂçïÔºå‰∏≠Êñ≠‰øùÂ≠ò
                    }
                    // ‚ñ≤‚ñ≤‚ñ≤ Ê†°È™åÈÄªËæëÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                    state.apiConfig.proxyUrl = proxyUrlToCheck;
                    state.apiConfig.apiKey = document.getElementById('api-key').value.trim();
                    state.apiConfig.model = document.getElementById('model-select').value;
                    await db.apiConfig.put(state.apiConfig);

                    // Âú® 'save-api-settings-btn' ÁöÑ click ‰∫ã‰ª∂ÁõëÂê¨Âô®ÂÜÖÈÉ®
                    // await db.apiConfig.put(state.apiConfig); ËøôË°å‰πãÂêé

                    // ‚ñº‚ñº‚ñº Â∞Ü‰πãÂâçÈÇ£ÊÆµ‰øùÂ≠òÂêéÂè∞Ê¥ªÂä®ËÆæÁΩÆÁöÑÈÄªËæëÔºåÊõøÊç¢‰∏∫‰∏ãÈù¢Ëøô‰∏™Â¢ûÂº∫Áâà ‚ñº‚ñº‚ñº

                    const backgroundSwitch = document.getElementById('background-activity-switch');
                    const intervalInput = document.getElementById('background-interval-input');
                    const newEnableState = backgroundSwitch.checked;
                    const oldEnableState = state.globalSettings.enableBackgroundActivity || false;

                    // Âè™ÊúâÂú®Áî®Êà∑‚Äú‰ªéÂÖ≥Âà∞ÂºÄ‚ÄùÊó∂ÔºåÊâçÂºπÂá∫Ë≠¶Âëä
                    if (newEnableState && !oldEnableState) {
                        const userConfirmed = confirm(
                            "„ÄêÈ´òË¥πÁî®Ë≠¶Âëä„Äë\n\n" +
                            "ÊÇ®Ê≠£Âú®ÂêØÁî®‚ÄúÂêéÂè∞ËßíËâ≤Ê¥ªÂä®‚ÄùÂäüËÉΩ„ÄÇ\n\n" +
                            "Ëøô‰ºö‰ΩøÊÇ®ÁöÑAIËßíËâ≤‰ª¨Âú®ÊÇ®‰∏çÂíå‰ªñ‰ª¨ËÅäÂ§©Êó∂Ôºå‰πüËÉΩ‚ÄúÁã¨Á´ãÊÄùËÄÉ‚ÄùÂπ∂‰∏ªÂä®ÁªôÊÇ®ÂèëÊ∂àÊÅØÊàñËøõË°åÁ§æ‰∫§‰∫íÂä®ÔºåÊûÅÂ§ßÂú∞Â¢ûÂº∫Ê≤âÊµ∏ÊÑü„ÄÇ\n\n" +
                            "‰ΩÜËØ∑Ê≥®ÊÑèÔºö\n" +
                            "Ëøô‰ºö„ÄêÂú®ÂêéÂè∞Ëá™Âä®„ÄÅÂÆöÊúüÂú∞Ë∞ÉÁî®API„ÄëÔºåÂç≥‰ΩøÊÇ®‰∏çËøõË°å‰ªª‰ΩïÊìç‰Ωú„ÄÇÊ†πÊçÆÊÇ®ÁöÑËßíËâ≤Êï∞ÈáèÂíåÊ£ÄÊµãÈó¥ÈöîÔºåËøôÂèØËÉΩ‰ºöÂØºËá¥ÊÇ®ÁöÑAPIË¥πÁî®ÊòæËëóÂ¢ûÂä†„ÄÇ\n\n" +
                            "ÊÇ®Á°ÆÂÆöË¶ÅÂºÄÂêØÂêóÔºü"
                        );

                        if (!userConfirmed) {
                            backgroundSwitch.checked = false; // Áî®Êà∑ÂèñÊ∂àÔºåÊääÂºÄÂÖ≥Êã®ÂõûÂéª
                            return; // ÈòªÊ≠¢ÂêéÁª≠ÈÄªËæë
                        }
                    }

                    state.globalSettings.enableBackgroundActivity = newEnableState;
                    state.globalSettings.backgroundActivityInterval = parseInt(intervalInput.value) || 60;
                    state.globalSettings.blockCooldownHours = parseFloat(document.getElementById('block-cooldown-input').value) || 1;
                    state.globalSettings.aiActionCooldownMinutes = parseInt(document.getElementById('ai-cooldown-input').value) || 0;
                    await db.globalSettings.put(state.globalSettings);

                    // Âä®ÊÄÅÂêØÂä®ÊàñÂÅúÊ≠¢Ê®°ÊãüÂô®
                    stopBackgroundSimulation();
                    if (state.globalSettings.enableBackgroundActivity) {
                        startBackgroundSimulation();
                        console.log(`ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤ÂêØÂä®ÔºåÈó¥Èöî: ${state.globalSettings.backgroundActivityInterval}Áßí`);
                    } else {
                        console.log("ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤ÂÅúÊ≠¢„ÄÇ");
                    }
                    // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                    alert('APIËÆæÁΩÆÂ∑≤‰øùÂ≠ò!');
                });
                document.getElementById('fetch-models-btn').addEventListener('click', async () => {
                    const url = document.getElementById('proxy-url').value.trim();
                    const key = document.getElementById('api-key').value.trim();

                    // ‚ñº‚ñº‚ñº Êñ∞Â¢ûÊ†°È™åÈÄªËæë ‚ñº‚ñº‚ñº
                    if (isApiUrlBanned(url)) {
                        alert('Ê≠§APIÂú∞ÂùÄÊó†ÊïàÊàñ‰∏çÂèóÊîØÊåÅÔºåËØ∑Êõ¥Êç¢„ÄÇ');
                        return; // ÂëΩ‰∏≠ÈªëÂêçÂçïÔºå‰∏≠Êñ≠ÊãâÂèñ
                    }
                    // ‚ñ≤‚ñ≤‚ñ≤ Ê†°È™åÈÄªËæëÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                    if (!url || !key) return alert('ËØ∑ÂÖàÂ°´ÂÜôÂèç‰ª£Âú∞ÂùÄÂíåÂØÜÈí•');
                    try {
                        let response, data;
                        const modelSelect = document.getElementById('model-select');
                        modelSelect.innerHTML = '';

                        if (isGoogleGeminiAPI(url)) {
                            // Google Gemini API format
                            response = await fetch(`${url}/v1beta/models?key=${key}`);
                            if (!response.ok) throw new Error('Êó†Ê≥ïËé∑ÂèñGoogleÊ®°ÂûãÂàóË°®');
                            data = await response.json();
                            // Google returns models in different format
                            data.models.forEach(model => {
                                const option = document.createElement('option');
                                option.value = model.name.replace('models/', '');
                                option.textContent = model.displayName || model.name.replace('models/', '');
                                if (option.value === state.apiConfig.model) option.selected = true;
                                modelSelect.appendChild(option);
                            });
                        } else {
                            // OpenAI-compatible API format (existing)
                            response = await fetch(`${url}/v1/models`, { headers: { 'Authorization': `Bearer ${key}` } });
                            if (!response.ok) throw new Error('Êó†Ê≥ïËé∑ÂèñÊ®°ÂûãÂàóË°®');
                            data = await response.json();
                            data.data.forEach(model => {
                                const option = document.createElement('option');
                                option.value = model.id;
                                option.textContent = model.id;
                                if (model.id === state.apiConfig.model) option.selected = true;
                                modelSelect.appendChild(option);
                            });
                        }
                        alert('Ê®°ÂûãÂàóË°®Â∑≤Êõ¥Êñ∞');
                    } catch (error) {
                        alert(`ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•: ${error.message}`);
                    }
                });

                document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('ÂàõÂª∫‰∏ñÁïå‰π¶', 'ËØ∑ËæìÂÖ•‰π¶Âêç'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
                document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert('‰π¶Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ'); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });

                document.getElementById('chat-messages').addEventListener('click', (e) => {
                    // Â§ÑÁêÜÂ∑≤Êí§ÂõûÊ∂àÊÅØÁöÑÁÇπÂáª
                    const placeholder = e.target.closest('.recalled-message-placeholder');
                    if (placeholder) {
                        const wrapper = placeholder.closest('.message-wrapper');
                        if (wrapper) {
                            const timestamp = parseInt(wrapper.dataset.timestamp);
                            const chat = state.chats[state.activeChatId];
                            const recalledMsg = chat.history.find(m => m.timestamp === timestamp);

                            if (recalledMsg && recalledMsg.recalledData) {
                                let originalContentText = '';
                                const recalled = recalledMsg.recalledData;

                                if (recalled.originalType === 'text') {
                                    originalContentText = `ÂéüÊñá: "${recalled.originalContent}"`;
                                } else {
                                    originalContentText = `Êí§Âõû‰∫Ü‰∏ÄÊù°[${recalled.originalType}]Á±ªÂûãÁöÑÊ∂àÊÅØ`;
                                }
                                showCustomAlert('Â∑≤Êí§ÂõûÁöÑÊ∂àÊÅØ', originalContentText);
                            }
                        }
                        return;
                    }

                    // Â§ÑÁêÜÂõæÁâáÂºπÁ™óÔºàÈÄªËæë‰øùÁïôÔºâ
                    const aiImage = e.target.closest('.ai-generated-image');
                    if (aiImage) {
                        const description = aiImage.dataset.description;
                        if (description) showCustomAlert('ÁÖßÁâáÊèèËø∞', description);
                        return;
                    }

                    // „ÄêÂÖ®Êñ∞„ÄëÂ§ÑÁêÜËØ≠Èü≥ÁÇπÂáªÂ±ïÂºÄ/Êî∂Ëµ∑
                    const voiceBody = e.target.closest('.voice-message-body');
                    if (voiceBody) {
                        const bubble = voiceBody.closest('.message-bubble');
                        if (!bubble) return;

                        const transcript = bubble.querySelector('.voice-transcript');
                        const waveform = bubble.querySelector('.voice-waveform');

                        if (transcript && waveform) {
                            const isVisible = transcript.style.display === 'block';

                            if (isVisible) {
                                // --- Â¶ÇÊûúÂΩìÂâçÊòØÂ±ïÂºÄÁöÑÔºåÁé∞Âú®Ë¶ÅÊî∂Ëµ∑ ---
                                transcript.style.display = 'none';
                                // ÊÅ¢Â§çÊàêÊúÄÂàùÂßãÁöÑ5‰∏™Ê≥¢Êµ™
                                waveform.innerHTML = '<div></div><div></div><div></div><div></div><div></div>';
                            } else {
                                // --- Â¶ÇÊûúÂΩìÂâçÊòØÊî∂Ëµ∑ÁöÑÔºåÁé∞Âú®Ë¶ÅÂ±ïÂºÄ ---
                                transcript.style.display = 'block';

                                // 1. Ëé∑ÂèñËØ≠Èü≥Êó∂Èïø
                                const duration = Math.max(1, Math.round((transcript.textContent || '').length / 5));

                                // 2. Ê†πÊçÆÊñ∞ËßÑÂàôËÆ°ÁÆóÈúÄË¶ÅÁöÑÊ≥¢Êµ™ÊÄªÊï∞
                                let waveBars;
                                if (duration === 1) {
                                    waveBars = 5;  // 1s = 1ÁªÑ = 5‰∏™
                                } else if (duration === 2) {
                                    waveBars = 15; // 2s = 3ÁªÑ = 15‰∏™
                                } else {
                                    waveBars = 20; // 3sÂèä‰ª•‰∏ä = 4ÁªÑ = 20‰∏™
                                }

                                // 3. Âä®ÊÄÅÁîüÊàêÊ≥¢Êµ™Âπ∂‰øÆÂ§çÂä®ÁîªÂª∂Ëøü
                                waveform.innerHTML = ''; // Ê∏ÖÁ©∫ÊóßÁöÑÊ≥¢Êµ™
                                for (let i = 0; i < waveBars; i++) {
                                    const waveDiv = document.createElement('div');
                                    // „ÄêÊ†∏ÂøÉ„Äë‰∏∫ÊØè‰∏Ä‰∏™Ê≥¢Êµ™ËÆæÁΩÆÈÄíÂ¢ûÁöÑ„ÄÅÁã¨‰∏ÄÊó†‰∫åÁöÑÂä®ÁîªÂª∂Ëøü
                                    waveDiv.style.animationDelay = `${i * 0.2}s`;
                                    waveform.appendChild(waveDiv);
                                }
                            }
                        }
                        return; // Â§ÑÁêÜÂÆåËØ≠Èü≥ÁÇπÂáªÂêéÔºåÁõ¥Êé•ËøîÂõû

                    }
                });
                //„ÄêÁ≤òË¥¥Âà∞ËøôÈáåÁªìÊùü„Äë

                const chatSettingsModal = document.getElementById('chat-settings-modal');
                const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
                const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
                function updateWorldBookSelectionDisplay() { const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked'); const displayText = document.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- ÁÇπÂáªÈÄâÊã© --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `Â∑≤ÈÄâÊã© ${checkedBoxes.length} È°π`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } }

                worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
                document.getElementById('world-book-checkboxes-container').addEventListener('change', updateWorldBookSelectionDisplay);
                window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });

                // ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊÆµ„ÄêÂÆåÊï¥„ÄÅÂÖ®Êñ∞ÁöÑ‰ª£Á†Å„ÄëÊõøÊç¢ÊóßÁöÑ chat-settings-btn ÁÇπÂáª‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
                document.getElementById('chat-settings-btn').addEventListener('click', async () => {
                    if (!state.activeChatId) return;
                    const chat = state.chats[state.activeChatId];
                    const isGroup = chat.isGroup;

                    // --- Áªü‰∏ÄÊòæÁ§∫/ÈöêËóèÊéß‰ª∂ ---
                    document.getElementById('chat-name-group').style.display = 'block';
                    document.getElementById('my-persona-group').style.display = 'block';
                    document.getElementById('my-avatar-group').style.display = 'block';
                    document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none';
                    document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none';
                    document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none';
                    document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block';
                    document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block';

                    // „ÄêÊ†∏ÂøÉ‰øÆÊîπ1„ÄëÊ†πÊçÆÊòØÂê¶‰∏∫Áæ§ËÅäÔºåÊòæÁ§∫ÊàñÈöêËóè‚ÄúÂ•ΩÂèãÂàÜÁªÑ‚ÄùÂå∫Âüü
                    document.getElementById('assign-group-section').style.display = isGroup ? 'none' : 'block';

                    // --- Âä†ËΩΩË°®ÂçïÊï∞ÊçÆ ---
                    document.getElementById('chat-name-input').value = chat.name;
                    document.getElementById('my-persona').value = chat.settings.myPersona;
                    document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar);
                    document.getElementById('max-memory').value = chat.settings.maxMemory;
                    // ‚ñº‚ñº‚ñº „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëËØªÂèñÂºÄÂÖ≥Áä∂ÊÄÅ ‚ñº‚ñº‚ñº
                    document.getElementById('background-activity-switch-chat').checked = chat.settings.isBackgroundActivityEnabled ?? true;

                    const bgPreview = document.getElementById('bg-preview');
                    const removeBgBtn = document.getElementById('remove-bg-btn');
                    if (chat.settings.background) {
                        bgPreview.src = chat.settings.background;
                        bgPreview.style.display = 'block';
                        removeBgBtn.style.display = 'inline-block';
                    } else {
                        bgPreview.style.display = 'none';
                        removeBgBtn.style.display = 'none';
                    }

                    if (isGroup) {
                        document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || '';
                        document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar;
                        renderGroupMemberSettings(chat.members);
                    } else {
                        document.getElementById('ai-persona').value = chat.settings.aiPersona;
                        document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar;

                        // „ÄêÊ†∏ÂøÉ‰øÆÊîπ2„ÄëÂ¶ÇÊûúÊòØÂçïËÅäÔºåÂ∞±Âä†ËΩΩÂàÜÁªÑÂàóË°®Âà∞‰∏ãÊãâÊ°Ü
                        const select = document.getElementById('assign-group-select');
                        select.innerHTML = '<option value="">Êú™ÂàÜÁªÑ</option>'; // Ê∏ÖÁ©∫Âπ∂ËÆæÁΩÆÈªòËÆ§ÈÄâÈ°π
                        const groups = await db.qzoneGroups.toArray();
                        groups.forEach(group => {
                            const option = document.createElement('option');
                            option.value = group.id;
                            option.textContent = group.name;
                            // Â¶ÇÊûúÂΩìÂâçÂ•ΩÂèãÂ∑≤ÁªèÊúâÂàÜÁªÑÔºåÂ∞±ÈªòËÆ§ÈÄâ‰∏≠ÂÆÉ
                            if (chat.groupId === group.id) {
                                option.selected = true;
                            }
                            select.appendChild(option);
                        });
                    }

                    // Âä†ËΩΩ‰∏ñÁïå‰π¶
                    const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
                    worldBookCheckboxesContainer.innerHTML = '';
                    const linkedIds = chat.settings.linkedWorldBookIds || [];
                    if (state.worldBooks.length > 0) {
                        state.worldBooks.forEach(book => {
                            const isChecked = linkedIds.includes(book.id);
                            const label = document.createElement('label');
                            label.innerHTML = `<input type="checkbox" value="${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`;
                            worldBookCheckboxesContainer.appendChild(label);
                        });
                    }
                    updateWorldBookSelectionDisplay();

                    // Âä†ËΩΩÂπ∂Êõ¥Êñ∞ÊâÄÊúâÈ¢ÑËßàÁõ∏ÂÖ≥Êéß‰ª∂
                    const themeRadio = document.querySelector(`input[name="theme-select"][value="${chat.settings.theme || 'default'}"]`);
                    if (themeRadio) themeRadio.checked = true;
                    const fontSizeSlider = document.getElementById('font-size-slider');
                    fontSizeSlider.value = chat.settings.fontSize || 13;
                    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
                    const customCssInput = document.getElementById('custom-css-input');
                    customCssInput.value = chat.settings.customCss || '';

                    // ‚ñº‚ñº‚ñº Update summary info ‚ñº‚ñº‚ñº
                    updateSummaryInfo(chat);
                    // ‚ñ≤‚ñ≤‚ñ≤ Summary info update end ‚ñ≤‚ñ≤‚ñ≤

                    updateSettingsPreview();
                    document.getElementById('chat-settings-modal').classList.add('visible');
                });
                // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                function renderGroupMemberSettings(members) { const container = document.getElementById('group-members-settings'); container.innerHTML = ''; members.forEach(member => { const div = document.createElement('div'); div.className = 'member-editor'; div.dataset.memberId = member.id; div.innerHTML = `<img src="${member.avatar}" alt="${member.name}"><div class="member-name">${member.name}</div>`; div.addEventListener('click', () => openMemberEditor(member.id)); container.appendChild(div); }); }
                function openMemberEditor(memberId) { editingMemberId = memberId; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === memberId); document.getElementById('member-name-input').value = member.name; document.getElementById('member-persona-input').value = member.persona; document.getElementById('member-avatar-preview').src = member.avatar; document.getElementById('member-settings-modal').classList.add('visible'); }

                // ‚ñº‚ñº‚ñº Summary Info Update Function ‚ñº‚ñº‚ñº
                function updateSummaryInfo(chat) {
                    // Update total message count in title
                    const totalMessages = chat.history ? chat.history.length : 0;
                    document.getElementById('summary-section-title').textContent = `ÈïøÊúüËÆ∞ÂøÜÁîüÊàê (${totalMessages.toLocaleString()} Êù°)`;
                }
                // ‚ñ≤‚ñ≤‚ñ≤ Summary Info Function End ‚ñ≤‚ñ≤‚ñ≤

                document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
                document.getElementById('save-member-settings-btn').addEventListener('click', () => { if (!editingMemberId) return; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === editingMemberId); member.name = document.getElementById('member-name-input').value; member.persona = document.getElementById('member-persona-input').value; member.avatar = document.getElementById('member-avatar-preview').src; renderGroupMemberSettings(chat.members); document.getElementById('member-settings-modal').classList.remove('visible'); });
                document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
                document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });

                // ‚ñº‚ñº‚ñº Summary Button Click Handler ‚ñº‚ñº‚ñº
                document.getElementById('update-summary-btn').addEventListener('click', async () => {
                    if (!state.activeChatId) return;
                    const chat = state.chats[state.activeChatId];
                    
                    // Check if there are messages to summarize
                    if (!chat.history || chat.history.length === 0) {
                        alert('‚ùå Ê≤°ÊúâÊ∂àÊÅØÂèØ‰ª•ÊÄªÁªì');
                        return;
                    }
                    
                    // Get user-specified message count
                    const messageCountInput = document.getElementById('summary-message-count');
                    let messageCount = parseInt(messageCountInput.value);
                    
                    // Validate input
                    if (isNaN(messageCount) || messageCount < 100) {
                        alert('‚ùå ËØ∑ËæìÂÖ•Ëá≥Â∞ë100Êù°Ê∂àÊÅØ');
                        return;
                    }
                    
                    if (messageCount > chat.history.length) {
                        messageCount = chat.history.length;
                        messageCountInput.value = messageCount;
                    }
                    
                    // Get or create the auto-summary world book first
                    const autoBook = await getOrCreateAutoSummaryWorldBook(state.activeChatId);
                    if (!autoBook) {
                        alert('‚ùå ÂàõÂª∫‰∏ñÁïå‰π¶Â§±Ë¥•');
                        return;
                    }
                    
                    // Disable button and show loading state
                    const btn = document.getElementById('update-summary-btn');
                    const originalText = btn.textContent;
                    btn.disabled = true;
                    btn.textContent = '‚è≥ AIÊ≠£Âú®ÁîüÊàêÈïøÊúüËÆ∞ÂøÜ...';
                    btn.style.opacity = '0.6';
                    
                    // Set global flags for summary generation
                    isGeneratingSummary = true;
                    generatingSummaryBookId = autoBook.id;
                    
                    // Show loading state on world book (don't let this break the flow)
                    try {
                        setWorldBookLoadingState(autoBook.id, true);
                    } catch (e) {
                        // Silently fail - loading state is optional
                    }
                    
                    try {
                        console.log('üöÄ Starting summary generation...');
                        console.log(`Summarizing last ${messageCount} messages`);
                        
                        // Generate summary with AI (pass message count)
                        const newSummary = await generateChatSummary(state.activeChatId, messageCount);
                        
                        // Update world book with new summary
                        const success = await updateAutoSummaryWorldBook(state.activeChatId, newSummary);
                        
                        if (success) {
                            // Refresh world book list if it's open
                            if (window.renderWorldBookScreenProxy) {
                                window.renderWorldBookScreenProxy();
                            }
                            
                            console.log('‚úÖ Summary generation complete!');
                            console.log(`Summary length: ${newSummary.length} characters`);
                            
                            alert(`‚úÖ ÈïøÊúüËÆ∞ÂøÜÁîüÊàêÊàêÂäüÔºÅ\n\nÂ∑≤Êõ¥Êñ∞‰∏ñÁïå‰π¶: [ÈïøÊúüËÆ∞ÂøÜ] ${chat.name}\n\nÊÄªÁªì‰∫ÜÊúÄËøë ${messageCount} Êù°Ê∂àÊÅØ\nËÆ∞ÂøÜÈïøÂ∫¶: ${newSummary.length} Â≠óÁ¨¶\n\n‰Ω†ÂèØ‰ª•Âú®‰∏ñÁïå‰π¶ÂàóË°®‰∏≠Êü•ÁúãÂÆåÊï¥ÂÜÖÂÆπ`);
                        } else {
                            alert('‚ùå ‰øùÂ≠òÊëòË¶ÅÂ§±Ë¥•');
                        }
                    } catch (error) {
                        console.error('‚ùå Summary generation error:', error);
                        alert(`‚ùå ÁîüÊàêÈïøÊúüËÆ∞ÂøÜÂ§±Ë¥•\n\nÈîôËØØ‰ø°ÊÅØ: ${error.message}\n\nËØ∑Ê£ÄÊü•:\n1. APIÈÖçÁΩÆÊòØÂê¶Ê≠£Á°Æ\n2. ÁΩëÁªúËøûÊé•ÊòØÂê¶Ê≠£Â∏∏\n3. APIÈ¢ùÂ∫¶ÊòØÂê¶ÂÖÖË∂≥`);
                    } finally {
                        // Clear global flags
                        isGeneratingSummary = false;
                        generatingSummaryBookId = null;
                        
                        // Remove loading state from world book (don't let this break the flow)
                        try {
                            setWorldBookLoadingState(autoBook.id, false);
                        } catch (e) {
                            // Silently fail - loading state is optional
                        }
                        
                        // Re-enable button
                        btn.disabled = false;
                        btn.textContent = originalText;
                        btn.style.opacity = '1';
                    }
                });
                // ‚ñ≤‚ñ≤‚ñ≤ Summary Button Handler End ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº Summary Info Update Function ‚ñº‚ñº‚ñº
                function updateSummaryInfo(chat) {
                    // Update total message count in title
                    const totalMessages = chat.history ? chat.history.length : 0;
                    document.getElementById('summary-section-title').textContent = `ÈïøÊúüËÆ∞ÂøÜÁîüÊàê (${totalMessages.toLocaleString()} Êù°)`;
                }
                // ‚ñ≤‚ñ≤‚ñ≤ Summary Info Function End ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº Summary Button Click Handler ‚ñº‚ñº‚ñº
                document.getElementById('update-summary-btn').addEventListener('click', async () => {
                    if (!state.activeChatId) return;
                    const chat = state.chats[state.activeChatId];
                    
                    // Check if there are messages to summarize
                    if (!chat.history || chat.history.length === 0) {
                        alert('‚ùå Ê≤°ÊúâÊ∂àÊÅØÂèØ‰ª•ÊÄªÁªì');
                        return;
                    }
                    
                    // Get user-specified message count
                    const messageCountInput = document.getElementById('summary-message-count');
                    let messageCount = parseInt(messageCountInput.value);
                    
                    // Validate input
                    if (isNaN(messageCount) || messageCount < 100) {
                        alert('‚ùå ËØ∑ËæìÂÖ•Ëá≥Â∞ë100Êù°Ê∂àÊÅØ');
                        return;
                    }
                    
                    if (messageCount > chat.history.length) {
                        messageCount = chat.history.length;
                        messageCountInput.value = messageCount;
                    }
                    
                    // Get or create the auto-summary world book first
                    const autoBook = await getOrCreateAutoSummaryWorldBook(state.activeChatId);
                    if (!autoBook) {
                        alert('‚ùå ÂàõÂª∫‰∏ñÁïå‰π¶Â§±Ë¥•');
                        return;
                    }
                    
                    // Disable button and show loading state
                    const btn = document.getElementById('update-summary-btn');
                    const originalText = btn.textContent;
                    btn.disabled = true;
                    btn.textContent = '‚è≥ AIÊ≠£Âú®ÁîüÊàêÈïøÊúüËÆ∞ÂøÜ...';
                    btn.style.opacity = '0.6';
                    
                    // Set global flags for summary generation
                    isGeneratingSummary = true;
                    generatingSummaryBookId = autoBook.id;
                    
                    // Show loading state on world book (don't let this break the flow)
                    try {
                        setWorldBookLoadingState(autoBook.id, true);
                    } catch (e) {
                        // Silently fail - loading state is optional
                    }
                    
                    try {
                        console.log('üöÄ Starting summary generation...');
                        console.log(`Summarizing last ${messageCount} messages`);
                        
                        // Generate summary with AI (pass message count)
                        const newSummary = await generateChatSummary(state.activeChatId, messageCount);
                        
                        // Update world book with new summary
                        const success = await updateAutoSummaryWorldBook(state.activeChatId, newSummary);
                        
                        if (success) {
                            // Refresh world book list if it's open
                            if (window.renderWorldBookScreenProxy) {
                                window.renderWorldBookScreenProxy();
                            }
                            
                            console.log('‚úÖ Summary generation complete!');
                            console.log(`Summary length: ${newSummary.length} characters`);
                            
                            alert(`‚úÖ ÈïøÊúüËÆ∞ÂøÜÁîüÊàêÊàêÂäüÔºÅ\n\nÂ∑≤Êõ¥Êñ∞‰∏ñÁïå‰π¶: [ÈïøÊúüËÆ∞ÂøÜ] ${chat.name}\n\nÊÄªÁªì‰∫ÜÊúÄËøë ${messageCount} Êù°Ê∂àÊÅØ\nËÆ∞ÂøÜÈïøÂ∫¶: ${newSummary.length} Â≠óÁ¨¶\n\n‰Ω†ÂèØ‰ª•Âú®‰∏ñÁïå‰π¶ÂàóË°®‰∏≠Êü•ÁúãÂÆåÊï¥ÂÜÖÂÆπ`);
                        } else {
                            alert('‚ùå ‰øùÂ≠òÊëòË¶ÅÂ§±Ë¥•');
                        }
                    } catch (error) {
                        console.error('‚ùå Summary generation error:', error);
                        alert(`‚ùå ÁîüÊàêÈïøÊúüËÆ∞ÂøÜÂ§±Ë¥•\n\nÈîôËØØ‰ø°ÊÅØ: ${error.message}\n\nËØ∑Ê£ÄÊü•:\n1. APIÈÖçÁΩÆÊòØÂê¶Ê≠£Á°Æ\n2. ÁΩëÁªúËøûÊé•ÊòØÂê¶Ê≠£Â∏∏\n3. APIÈ¢ùÂ∫¶ÊòØÂê¶ÂÖÖË∂≥`);
                    } finally {
                        // Clear global flags
                        isGeneratingSummary = false;
                        generatingSummaryBookId = null;
                        
                        // Remove loading state from world book (don't let this break the flow)
                        try {
                            setWorldBookLoadingState(autoBook.id, false);
                        } catch (e) {
                            // Silently fail - loading state is optional
                        }
                        
                        // Re-enable button
                        btn.disabled = false;
                        btn.textContent = originalText;
                        btn.style.opacity = '1';
                    }
                });
                // ‚ñ≤‚ñ≤‚ñ≤ Summary Button Handler End ‚ñ≤‚ñ≤‚ñ≤

                document.getElementById('save-chat-settings-btn').addEventListener('click', async () => {
                    if (!state.activeChatId) return;
                    const chat = state.chats[state.activeChatId];
                    const newName = document.getElementById('chat-name-input').value.trim();
                    if (!newName) return alert('Â§áÊ≥®Âêç/Áæ§Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ');
                    chat.name = newName;
                    const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked');
                    chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default';

                    chat.settings.fontSize = parseInt(document.getElementById('font-size-slider').value);
                    chat.settings.customCss = document.getElementById('custom-css-input').value.trim();

                    chat.settings.myPersona = document.getElementById('my-persona').value;
                    chat.settings.myAvatar = document.getElementById('my-avatar-preview').src;
                    const checkedBooks = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked');
                    chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value);
                    chat.settings.isBackgroundActivityEnabled = document.getElementById('background-activity-switch-chat').checked;

                    if (chat.isGroup) {
                        chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim();
                        chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src;
                    } else {
                        chat.settings.aiPersona = document.getElementById('ai-persona').value;
                        chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src;
                        const selectedGroupId = document.getElementById('assign-group-select').value;
                        chat.groupId = selectedGroupId ? parseInt(selectedGroupId) : null;
                    }

                    chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10;
                    await db.chats.put(chat);

                    applyScopedCss(chat.settings.customCss, '#chat-messages', 'custom-bubble-style');

                    chatSettingsModal.classList.remove('visible');
                    renderChatInterface(state.activeChatId);
                    renderChatList();
                });
                document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï', 'Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Ê≠§ËÅäÂ§©ÁöÑÊâÄÊúâÊ∂àÊÅØÔºåÊó†Ê≥ïÊÅ¢Â§ç„ÄÇÁ°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂêóÔºü', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });

                const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
                setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
                setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
                setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
                setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);

                // QZone avatar modal event handlers
                document.getElementById('save-qzone-avatar-btn').addEventListener('click', async () => {
                    // Save avatar
                    state.qzoneSettings.avatar = document.getElementById('qzone-avatar-preview').src;

                    // Save toggle state
                    const toggle = document.getElementById('qzone-border-toggle');
                    state.qzoneSettings.avatarBordersEnabled = toggle.checked;

                    // Save border (only if toggle is enabled)
                    if (toggle.checked) {
                        const borderSrc = document.getElementById('qzone-border-preview').src;
                        state.qzoneSettings.avatarFrame = (borderSrc && borderSrc !== 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7') ? borderSrc : null;
                    }

                    // Save to database
                    await saveQzoneSettings();
                    renderQzoneScreen();
                    await renderQzonePosts(); // Re-render posts with new border settings

                    // Close modal
                    document.getElementById('qzone-avatar-modal').classList.remove('visible');
                });

                // QZone avatar file upload handler
                document.getElementById('qzone-avatar-file-input').addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const dataUrl = await processImageUpload(file);
                        document.getElementById('qzone-avatar-preview').src = dataUrl;
                    }
                    event.target.value = null;
                });

                // QZone border toggle handler
                document.getElementById('qzone-border-toggle').addEventListener('change', (e) => {
                    const borderGroup = document.getElementById('qzone-border-group');
                    borderGroup.style.display = e.target.checked ? 'block' : 'none';
                });

                // QZone border upload handler
                document.getElementById('qzone-border-input').addEventListener('change', async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const dataUrl = await new Promise((res, rej) => {
                            const reader = new FileReader();
                            reader.onload = () => res(reader.result);
                            reader.readAsDataURL(file);
                        });
                        document.getElementById('qzone-border-preview').src = dataUrl;
                        document.getElementById('qzone-border-preview').style.display = 'block';
                        document.getElementById('qzone-no-border-text').style.display = 'none';
                        document.getElementById('qzone-remove-border-btn').style.display = 'inline-block';
                    }
                    event.target.value = null;
                });
                setupFileUpload('bg-input', (base64) => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
                setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
                document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

                const stickerPanel = document.getElementById('sticker-panel');
                document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { 
                    // Set current pack to first pack in saved order
                    const savedOrder = state.globalSettings?.stickerPackOrder || Object.keys(stickerPackData);
                    if (savedOrder.length > 0) {
                        currentStickerPack = savedOrder[0];
                    }
                    renderStickerPanel(); 
                    stickerPanel.classList.add('visible'); 
                    initializeStickerPackTabs(); 
                });
                // Close button handler is managed dynamically in arrange mode
                document.getElementById('close-sticker-panel-btn').onclick = () => stickerPanel.classList.remove('visible');
                // Set initial edit button handler
                document.getElementById('edit-sticker-pack-btn').onclick = openStickerPackEditModal;
                // No additional event listeners needed - handled in the add square click handler
                document.getElementById('sticker-upload-input').addEventListener('change', async (event) => {
                    const file = event.target.files[0]; if (!file) return; const base64Url = await processImageUpload(file); const name = await showCustomPrompt("ÂëΩÂêçË°®ÊÉÖ", "ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂëΩÂêç (‰æãÂ¶ÇÔºöÂ•ΩËÄ∂„ÄÅÁñëÊÉë)"); if (name && name.trim()) {
                        const newSticker = {
                            id: 'sticker_' + Date.now(),
                            url: base64Url,
                            name: name.trim(),
                            order: state.userStickers.length,
                            packId: currentStickerPack
                        }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); document.getElementById('sticker-panel').classList.add('visible'); renderStickerPanel();
                    } else if (name !== null) alert("Ë°®ÊÉÖÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ"); event.target.value = null;
                });

                document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
                document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const base64Url = await processImageUpload(file); const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now(), isVisionAnalysis: true }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); event.target.value = null; });
                document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("ÂèëÈÄÅËØ≠Èü≥", "ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑÂÜÖÂÆπÔºö"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
                document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("ÂèëÈÄÅÁÖßÁâá", "ËØ∑Áî®ÊñáÂ≠óÊèèËø∞ÊÇ®Ë¶ÅÂèëÈÄÅÁöÑÁÖßÁâáÔºö"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });

                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÂ§ñÂçñËØ∑Ê±ÇÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
                const waimaiModal = document.getElementById('waimai-request-modal');
                document.getElementById('send-waimai-request-btn').addEventListener('click', () => {
                    waimaiModal.classList.add('visible');
                });

                document.getElementById('waimai-cancel-btn').addEventListener('click', () => {
                    waimaiModal.classList.remove('visible');
                });

                document.getElementById('waimai-confirm-btn').addEventListener('click', async () => {
                    if (!state.activeChatId) return;

                    const productInfoInput = document.getElementById('waimai-product-info');
                    const amountInput = document.getElementById('waimai-amount');

                    const productInfo = productInfoInput.value.trim();
                    const amount = parseFloat(amountInput.value);

                    if (!productInfo) {
                        alert('ËØ∑ËæìÂÖ•ÂïÜÂìÅ‰ø°ÊÅØÔºÅ');
                        return;
                    }
                    if (isNaN(amount) || amount <= 0) {
                        alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑ‰ª£‰ªòÈáëÈ¢ùÔºÅ');
                        return;
                    }

                    const chat = state.chats[state.activeChatId];
                    const now = Date.now();

                    // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåËé∑ÂèñÁî®Êà∑Ëá™Â∑±ÁöÑÊòµÁß∞
                    const myNickname = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';

                    const msg = {
                        role: 'user',
                        // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ∞ÜËé∑ÂèñÂà∞ÁöÑÊòµÁß∞Ôºå‰Ωú‰∏∫ senderName Ê∑ªÂä†Âà∞Ê∂àÊÅØÂØπË±°‰∏≠
                        senderName: myNickname,
                        type: 'waimai_request',
                        productInfo: productInfo,
                        amount: amount,
                        status: 'pending',
                        countdownEndTime: now + 15 * 60 * 1000,
                        timestamp: now
                    };

                    chat.history.push(msg);
                    await db.chats.put(chat);
                    appendMessage(msg, chat);
                    renderChatList();

                    productInfoInput.value = '';
                    amountInput.value = '';
                    waimaiModal.classList.remove('visible');
                });
                document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
                document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
                document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
                document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
                document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
                document.getElementById('preset-action-edit').addEventListener('click', () => {
                    if (editingMemoryId) {
                        editMemory();
                    } else {
                        openPersonaEditorForEdit();
                    }
                });
                document.getElementById('preset-action-delete').addEventListener('click', () => {
                    if (editingMemoryId) {
                        deleteMemory();
                    } else {
                        deletePersonaPreset();
                    }
                });
                document.getElementById('preset-action-cancel').addEventListener('click', () => {
                    if (editingMemoryId) {
                        hideMemoryActions();
                    } else {
                        hidePresetActions();
                    }
                });

                document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);

                // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªàÂä†Âº∫Áâà„ÄëÁî®ËøôÂùó‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑ selection-delete-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
                document.getElementById('selection-delete-btn').addEventListener('click', async () => {
                    if (selectedMessages.size === 0) return;
                    const confirmed = await showCustomConfirm('Âà†Èô§Ê∂àÊÅØ', `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedMessages.size} Êù°Ê∂àÊÅØÂêóÔºüËøôÂ∞ÜÊîπÂèòAIÁöÑËÆ∞ÂøÜ„ÄÇ`, { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        const chat = state.chats[state.activeChatId];

                        // 1. „ÄêÊ†∏ÂøÉÂä†Âº∫„ÄëÂú®Âà†Èô§ÂâçÔºåÊ£ÄÊü•Ë¢´Âà†Èô§ÁöÑÊ∂àÊÅØ‰∏≠ÊòØÂê¶ÂåÖÂê´ÊäïÁ•®
                        let deletedPollsInfo = [];
                        for (const timestamp of selectedMessages) {
                            const msg = chat.history.find(m => m.timestamp === timestamp);
                            if (msg && msg.type === 'poll') {
                                deletedPollsInfo.push(`ÂÖ≥‰∫é‚Äú${msg.question}‚ÄùÁöÑÊäïÁ•®(Êó∂Èó¥Êà≥: ${msg.timestamp})`);
                            }
                        }

                        // 2. Êõ¥Êñ∞ÂêéÁ´ØÁöÑÂéÜÂè≤ËÆ∞ÂΩï
                        chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp));

                        // 3. „ÄêÊ†∏ÂøÉÂä†Âº∫„ÄëÊûÑÂª∫Êõ¥ÂÖ∑‰ΩìÁöÑ‚ÄúÈÅóÂøòÊåá‰ª§‚Äù
                        let forgetReason = "‰∏Ä‰∫õ‰πãÂâçÁöÑÊ∂àÊÅØÂ∑≤Ë¢´Áî®Êà∑Âà†Èô§„ÄÇ";
                        if (deletedPollsInfo.length > 0) {
                            forgetReason += ` ÂÖ∂‰∏≠ÂåÖÊã¨‰ª•‰∏ãÊäïÁ•®Ôºö${deletedPollsInfo.join('Ôºõ')}„ÄÇ`;
                        }
                        forgetReason += " ‰Ω†Â∫îËØ•ÂÉèÂÆÉ‰ª¨‰ªéÊú™Â≠òÂú®Ëøá‰∏ÄÊ†∑ÁªßÁª≠ÂØπËØùÔºåÂπ∂Áõ∏Â∫îÂú∞Ë∞ÉÊï¥‰Ω†ÁöÑËÆ∞ÂøÜÂíåË°å‰∏∫Ôºå‰∏çË¶ÅÂÜçÊèêÂèäËøô‰∫õË¢´Âà†Èô§ÁöÑÂÜÖÂÆπ„ÄÇ";



                        // 4. Â∞ÜÂåÖÂê´‚ÄúÈÅóÂøòÊåá‰ª§‚ÄùÁöÑ„ÄÅÊõ¥Êñ∞ÂêéÁöÑchatÂØπË±°Â≠òÂõûÊï∞ÊçÆÂ∫ì
                        await db.chats.put(chat);

                        // 5. ÊúÄÂêéÊâçÊõ¥Êñ∞UI
                        renderChatInterface(state.activeChatId);
                        renderChatList();
                    }
                });
                // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‰∏∫ËÅäÂ§©ËÆæÁΩÆÈáåÁöÑ‚ÄúÊõ¥Êç¢Â§¥ÂÉèÊ°Ü‚ÄùÊåâÈíÆÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                document.getElementById('chat-settings-modal').addEventListener('click', (e) => {
                    if (e.target.classList.contains('change-frame-btn')) {
                        // 'chat' Ëøô‰∏™ÂèÇÊï∞ÊòØÂëäËØâÂáΩÊï∞ÔºåËøôÊ¨°ÊòØ‰∏∫‚ÄúÊàë/ÂØπÊñπ‚ÄùËøôÂØπÁªÑÂêàÊõ¥Êç¢Â§¥ÂÉèÊ°Ü
                        openFrameSelectorModal('chat');
                    }
                });

                // ‰∏∫ÊàêÂëòËÆæÁΩÆÈáåÁöÑ‚ÄúÊõ¥Êç¢Â§¥ÂÉèÊ°Ü‚ÄùÊåâÈíÆÊ∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                document.getElementById('member-settings-modal').addEventListener('click', (e) => {
                    // „Äê‰øÆÊ≠£„ÄëÂ∞Ü .contents ‰øÆÊîπ‰∏∫ .contains
                    if (e.target.classList.contains('change-frame-btn')) {
                        // 'member' Ëøô‰∏™ÂèÇÊï∞ÊòØÂëäËØâÂáΩÊï∞ÔºåËøôÊ¨°ÊòØ‰∏∫Âçï‰∏™Áæ§ÊàêÂëòÊõ¥Êç¢Â§¥ÂÉèÊ°Ü
                        openFrameSelectorModal('member');
                    }
                });

                // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                const fontUrlInput = document.getElementById('font-url-input');
                fontUrlInput.addEventListener('input', () => {
                    // Clear uploaded font when typing URL
                    if (fontUrlInput.value.trim()) {
                        window.uploadedFontData = null;
                        window.uploadedFontName = null;
                        document.getElementById('font-file-name').textContent = 'Êú™ÈÄâÊã©Êñá‰ª∂';
                    }
                    applyCustomFont(fontUrlInput.value.trim(), true);
                });

                // Font upload handler
                document.getElementById('font-upload-input').addEventListener('change', (e) => {
                    console.log('File input changed, files:', e.target.files);
                    const file = e.target.files[0];
                    if (file) {
                        console.log('File selected for upload:', file);
                        handleFontUpload(file);
                    } else {
                        console.log('No file selected');
                    }
                });


                document.getElementById('save-font-btn').addEventListener('click', saveFontSettings);
                document.getElementById('reset-font-btn').addEventListener('click', resetToDefaultFont);

                document.querySelectorAll('#chat-list-bottom-nav .nav-item').forEach(item => { item.addEventListener('click', () => switchToChatListView(item.dataset.view)); });
                document.getElementById('qzone-back-btn').addEventListener('click', () => showScreen('home-screen'));
                document.getElementById('qzone-nickname').addEventListener('click', async () => { const newNickname = await showCustomPrompt("‰øÆÊîπÊòµÁß∞", "ËØ∑ËæìÂÖ•Êñ∞ÁöÑÊòµÁß∞", state.qzoneSettings.nickname); if (newNickname && newNickname.trim()) { state.qzoneSettings.nickname = newNickname.trim(); await saveQzoneSettings(); renderQzoneScreen(); } });
                document.getElementById('qzone-avatar-container').addEventListener('click', () => {
                    // Load current avatar
                    document.getElementById('qzone-avatar-preview').src = state.qzoneSettings.avatar;

                    // Load toggle state
                    const toggle = document.getElementById('qzone-border-toggle');
                    toggle.checked = state.qzoneSettings.avatarBordersEnabled || false;

                    // Show/hide border group based on toggle
                    const borderGroup = document.getElementById('qzone-border-group');
                    borderGroup.style.display = toggle.checked ? 'block' : 'none';

                    // Load border if exists
                    if (state.qzoneSettings.avatarFrame) {
                        document.getElementById('qzone-border-preview').src = state.qzoneSettings.avatarFrame;
                        document.getElementById('qzone-border-preview').style.display = 'block';
                        document.getElementById('qzone-no-border-text').style.display = 'none';
                        document.getElementById('qzone-remove-border-btn').style.display = 'inline-block';
                    } else {
                        removeQzoneBorder();
                    }

                    // Show modal
                    document.getElementById('qzone-avatar-modal').classList.add('visible');
                });
                document.getElementById('qzone-banner-container').addEventListener('click', () => document.getElementById('qzone-banner-input').click());
                document.getElementById('qzone-avatar-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await processImageUpload(file); state.qzoneSettings.avatar = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });
                document.getElementById('qzone-banner-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await processImageUpload(file); state.qzoneSettings.banner = dataUrl; await saveQzoneSettings(); renderQzoneScreen(); } event.target.value = null; });

                // ‚ñº‚ñº‚ñº „Äê‰øÆÊ≠£Âêé„ÄëÁöÑ‚ÄúËØ¥ËØ¥‚ÄùÊåâÈíÆ‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
                document.getElementById('create-shuoshuo-btn').addEventListener('click', async () => {
                    // 1. ÈáçÁΩÆÂπ∂Ëé∑ÂèñÊ®°ÊÄÅÊ°Ü
                    resetCreatePostModal();
                    const modal = document.getElementById('create-post-modal');

                    // 2. ËÆæÁΩÆ‰∏∫‚ÄúËØ¥ËØ¥‚ÄùÊ®°Âºè
                    modal.dataset.mode = 'shuoshuo';

                    // 3. ÈöêËóè‰∏éÂõæÁâá/ÊñáÂ≠óÂõæÁõ∏ÂÖ≥ÁöÑÈÉ®ÂàÜ
                    modal.querySelector('.post-mode-switcher').style.display = 'none';
                    modal.querySelector('#image-mode-content').style.display = 'none';
                    modal.querySelector('#text-image-mode-content').style.display = 'none';

                    // 4. ‰øÆÊîπ‰∏ªËæìÂÖ•Ê°ÜÁöÑÊèêÁ§∫ËØ≠Ôºå‰ΩøÂÖ∂Êõ¥Á¨¶Âêà‚ÄúËØ¥ËØ¥‚ÄùÁöÑÂú∫ÊôØ
                    modal.querySelector('#post-public-text').placeholder = 'ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...';

                    // 5. ÂáÜÂ§áÂπ∂ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
                    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
                    visibilityGroupsContainer.innerHTML = '';
                    const groups = await db.qzoneGroups.toArray();
                    if (groups.length > 0) {
                        groups.forEach(group => {
                            const label = document.createElement('label');
                            label.style.display = 'block';
                            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
                            visibilityGroupsContainer.appendChild(label);
                        });
                    } else {
                        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">Ê≤°ÊúâÂèØÁî®ÁöÑÂàÜÁªÑ</p>';
                    }
                    modal.classList.add('visible');
                });

                // ‚ñº‚ñº‚ñº „Äê‰øÆÊ≠£Âêé„ÄëÁöÑ‚ÄúÂä®ÊÄÅ‚ÄùÔºàÂõæÁâáÔºâÊåâÈíÆ‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
                document.getElementById('create-post-btn').addEventListener('click', async () => {
                    // 1. ÈáçÁΩÆÂπ∂Ëé∑ÂèñÊ®°ÊÄÅÊ°Ü
                    resetCreatePostModal();
                    const modal = document.getElementById('create-post-modal');

                    // 2. ËÆæÁΩÆ‰∏∫‚ÄúÂ§çÊùÇÂä®ÊÄÅ‚ÄùÊ®°Âºè
                    modal.dataset.mode = 'complex';

                    // 3. Á°Æ‰øù‰∏éÂõæÁâá/ÊñáÂ≠óÂõæÁõ∏ÂÖ≥ÁöÑÈÉ®ÂàÜÊòØÂèØËßÅÁöÑ
                    modal.querySelector('.post-mode-switcher').style.display = 'flex';
                    // ÊòæÂºèÊøÄÊ¥ª‚Äú‰∏ä‰º†ÂõæÁâá‚ÄùÊ®°Âºè...
                    modal.querySelector('#image-mode-content').classList.add('active');
                    // ...ÂêåÊó∂Á°Æ‰øù‚ÄúÊñáÂ≠óÂõæ‚ÄùÊ®°ÂºèÊòØÈöêËóèÁöÑ
                    modal.querySelector('#text-image-mode-content').classList.remove('active');

                    // 4. ÊÅ¢Â§ç‰∏ªËæìÂÖ•Ê°ÜÁöÑÈªòËÆ§ÊèêÁ§∫ËØ≠
                    modal.querySelector('#post-public-text').placeholder = 'ÂàÜ‰∫´Êñ∞È≤ú‰∫ã...ÔºàÈùûÂøÖÂ°´ÁöÑÂÖ¨ÂºÄÊñáÂ≠óÔºâ';

                    // 5. ÂáÜÂ§áÂπ∂ÊòæÁ§∫Ê®°ÊÄÅÊ°ÜÔºà‰∏é‚ÄúËØ¥ËØ¥‚ÄùÊåâÈíÆÁöÑÈÄªËæëÁõ∏ÂêåÔºâ
                    const visibilityGroupsContainer = document.getElementById('post-visibility-groups');
                    visibilityGroupsContainer.innerHTML = '';
                    const groups = await db.qzoneGroups.toArray();
                    if (groups.length > 0) {
                        groups.forEach(group => {
                            const label = document.createElement('label');
                            label.style.display = 'block';
                            label.innerHTML = `<input type="checkbox" name="visibility_group" value="${group.id}"> ${group.name}`;
                            visibilityGroupsContainer.appendChild(label);
                        });
                    } else {
                        visibilityGroupsContainer.innerHTML = '<p style="color: var(--text-secondary);">Ê≤°ÊúâÂèØÁî®ÁöÑÂàÜÁªÑ</p>';
                    }
                    modal.classList.add('visible');
                });
                document.getElementById('open-album-btn').addEventListener('click', async () => { await renderAlbumList(); showScreen('album-screen'); });
                document.getElementById('album-back-btn').addEventListener('click', () => { showScreen('chat-list-screen'); switchToChatListView('qzone-screen'); });

                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëQZoneÊ∑ªÂä†ÊåâÈíÆÂíåÊ®°ÊÄÅÊ°Ü‰∫ã‰ª∂Â§ÑÁêÜ ‚ñº‚ñº‚ñº
                document.getElementById('qzone-add-post-btn').addEventListener('click', () => {
                    document.getElementById('qzone-add-options-modal').classList.add('visible');
                });

                document.getElementById('cancel-qzone-add-btn').addEventListener('click', () => {
                    document.getElementById('qzone-add-options-modal').classList.remove('visible');
                });

                // Â§çÁî®Áé∞ÊúâÁöÑ‰∫ã‰ª∂Â§ÑÁêÜÂáΩÊï∞
                document.getElementById('modal-create-shuoshuo-btn').addEventListener('click', async () => {
                    document.getElementById('qzone-add-options-modal').classList.remove('visible');
                    document.getElementById('create-shuoshuo-btn').click();
                });

                document.getElementById('modal-create-post-btn').addEventListener('click', async () => {
                    document.getElementById('qzone-add-options-modal').classList.remove('visible');
                    document.getElementById('create-post-btn').click();
                });

                document.getElementById('modal-open-album-btn').addEventListener('click', async () => {
                    document.getElementById('qzone-add-options-modal').classList.remove('visible');
                    document.getElementById('open-album-btn').click();
                });

                // --- ‚Üì‚Üì‚Üì ‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ ‚Üì‚Üì‚Üì ---

                document.getElementById('album-photos-back-btn').addEventListener('click', () => {
                    state.activeAlbumId = null;
                    showScreen('album-screen');
                });

                document.getElementById('album-upload-photo-btn').addEventListener('click', () => document.getElementById('album-photo-input').click());

                document.getElementById('album-photo-input').addEventListener('change', async (event) => {
                    if (!state.activeAlbumId) return;
                    const files = event.target.files;
                    if (!files.length) return;

                    const album = await db.qzoneAlbums.get(state.activeAlbumId);

                    for (const file of files) {
                        const dataUrl = await processImageUpload(file);
                        await db.qzonePhotos.add({ albumId: state.activeAlbumId, url: dataUrl, createdAt: Date.now() });
                    }

                    const photoCount = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).count();
                    const updateData = { photoCount };

                    if (!album.photoCount || album.coverUrl.includes('placeholder')) {
                        const firstPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                        if (firstPhoto) updateData.coverUrl = firstPhoto.url;
                    }

                    await db.qzoneAlbums.update(state.activeAlbumId, updateData);
                    await renderAlbumPhotosScreen();
                    await renderAlbumList();

                    event.target.value = null;
                    alert('ÁÖßÁâá‰∏ä‰º†ÊàêÂäüÔºÅ');
                });

                // --- ‚Üë‚Üë‚Üë Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ‚Üë‚Üë‚Üë ---

                // --- ‚Üì‚Üì‚Üì ‰ªéËøôÈáåÂºÄÂßãÂ§çÂà∂ÔºåÂÆåÊï¥ÊõøÊç¢ÊéâÊóßÁöÑ photos-grid-page ÁõëÂê¨Âô® ‚Üì‚Üì‚Üì ---

                document.getElementById('photos-grid-page').addEventListener('click', async (e) => {
                    const deleteBtn = e.target.closest('.photo-delete-btn');
                    const photoThumb = e.target.closest('.photo-thumb');

                    if (deleteBtn) {
                        e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞ÂõæÁâá‰∏ä
                        const photoId = parseInt(deleteBtn.dataset.photoId);
                        const confirmed = await showCustomConfirm(
                            'Âà†Èô§ÁÖßÁâá',
                            'Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÁÖßÁâáÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ',
                            { confirmButtonClass: 'btn-danger' }
                        );

                        if (confirmed) {
                            const deletedPhoto = await db.qzonePhotos.get(photoId);
                            if (!deletedPhoto) return;

                            await db.qzonePhotos.delete(photoId);

                            const album = await db.qzoneAlbums.get(state.activeAlbumId);
                            const photoCount = (album.photoCount || 1) - 1;
                            const updateData = { photoCount };

                            if (album.coverUrl === deletedPhoto.url) {
                                const nextPhoto = await db.qzonePhotos.where('albumId').equals(state.activeAlbumId).first();
                                updateData.coverUrl = nextPhoto ? nextPhoto.url : 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png';
                            }

                            await db.qzoneAlbums.update(state.activeAlbumId, updateData);
                            await renderAlbumPhotosScreen();
                            await renderAlbumList();
                            alert('ÁÖßÁâáÂ∑≤Âà†Èô§„ÄÇ');
                        }
                    }
                    else if (photoThumb) {
                        // ËøôÂ∞±ÊòØÊÅ¢Â§çÁöÑÂõæÁâáÁÇπÂáªÊîæÂ§ßÂäüËÉΩÔºÅ
                        openPhotoViewer(photoThumb.src);
                    }
                });

                // ÊÅ¢Â§çÂõæÁâáÊü•ÁúãÂô®ÁöÑÊéßÂà∂‰∫ã‰ª∂
                document.getElementById('photo-viewer-close-btn').addEventListener('click', closePhotoViewer);
                document.getElementById('photo-viewer-next-btn').addEventListener('click', showNextPhoto);
                document.getElementById('photo-viewer-prev-btn').addEventListener('click', showPrevPhoto);

                // ÊÅ¢Â§çÈîÆÁõòÂ∑¶Âè≥ÁÆ≠Â§¥ÂíåESCÈîÆÁöÑÂäüËÉΩ
                document.addEventListener('keydown', (e) => {
                    if (!photoViewerState.isOpen) return;

                    if (e.key === 'ArrowRight') {
                        showNextPhoto();
                    } else if (e.key === 'ArrowLeft') {
                        showPrevPhoto();
                    } else if (e.key === 'Escape') {
                        closePhotoViewer();
                    }
                });

                // --- ‚Üë‚Üë‚Üë Â§çÂà∂Âà∞ËøôÈáåÁªìÊùü ‚Üë‚Üë‚Üë ---

                document.getElementById('create-album-btn-page').addEventListener('click', async () => { const albumName = await showCustomPrompt("ÂàõÂª∫Êñ∞Áõ∏ÂÜå", "ËØ∑ËæìÂÖ•Áõ∏ÂÜåÂêçÁß∞"); if (albumName && albumName.trim()) { const newAlbum = { name: albumName.trim(), coverUrl: 'https://i.postimg.cc/pT2xKzPz/album-cover-placeholder.png', photoCount: 0, createdAt: Date.now() }; await db.qzoneAlbums.add(newAlbum); await renderAlbumList(); alert(`Áõ∏ÂÜå "${albumName}" ÂàõÂª∫ÊàêÂäüÔºÅ`); } else if (albumName !== null) { alert("Áõ∏ÂÜåÂêçÁß∞‰∏çËÉΩ‰∏∫Á©∫ÔºÅ"); } });

                document.getElementById('cancel-create-post-btn').addEventListener('click', () => document.getElementById('create-post-modal').classList.remove('visible'));
                document.getElementById('post-upload-local-btn').addEventListener('click', () => document.getElementById('post-local-image-input').click());
                document.getElementById('post-local-image-input').addEventListener('change', (event) => { const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('post-image-preview').src = e.target.result; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; }; reader.readAsDataURL(file); } });
                document.getElementById('post-use-url-btn').addEventListener('click', async () => { const url = await showCustomPrompt("ËæìÂÖ•ÂõæÁâáURL", "ËØ∑ËæìÂÖ•ÁΩëÁªúÂõæÁâáÁöÑÈìæÊé•", "", "url"); if (url) { document.getElementById('post-image-preview').src = url; document.getElementById('post-image-preview-container').classList.add('visible'); document.getElementById('post-image-desc-group').style.display = 'block'; } });
                document.getElementById('post-remove-image-btn').addEventListener('click', () => resetCreatePostModal());
                const imageModeBtn = document.getElementById('switch-to-image-mode');
                const textImageModeBtn = document.getElementById('switch-to-text-image-mode');
                const imageModeContent = document.getElementById('image-mode-content');
                const textImageModeContent = document.getElementById('text-image-mode-content');
                imageModeBtn.addEventListener('click', () => { imageModeBtn.classList.add('active'); textImageModeBtn.classList.remove('active'); imageModeContent.classList.add('active'); textImageModeContent.classList.remove('active'); });
                textImageModeBtn.addEventListener('click', () => { textImageModeBtn.classList.add('active'); imageModeBtn.classList.remove('active'); textImageModeContent.classList.add('active'); imageModeContent.classList.remove('active'); });

                // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªà‰øÆÊ≠£Áâà„ÄëÁöÑ‚ÄúÂèëÂ∏É‚ÄùÊåâÈíÆ‰∫ã‰ª∂ÔºåÂ∑≤‰øÆÂ§çÊùÉÈôêÊºèÊ¥û ‚ñº‚ñº‚ñº
                document.getElementById('confirm-create-post-btn').addEventListener('click', async () => {
                    const modal = document.getElementById('create-post-modal');
                    const mode = modal.dataset.mode;

                    // --- 1. Ëé∑ÂèñÈÄöÁî®ÁöÑÂèØËßÅÊÄßËÆæÁΩÆ ---
                    const visibilityMode = document.querySelector('input[name="visibility"]:checked').value;
                    let visibleGroupIds = null;

                    if (visibilityMode === 'include') {
                        visibleGroupIds = Array.from(document.querySelectorAll('input[name="visibility_group"]:checked')).map(cb => parseInt(cb.value));
                    }

                    let newPost = {};
                    const basePostData = {
                        timestamp: Date.now(),
                        authorId: 'user',
                        // „ÄêÈáçË¶Å„ÄëÂú®ËøôÈáåÂ∞±ÊääÊùÉÈôê‰ø°ÊÅØÂ≠òÂ•Ω
                        visibleGroupIds: visibleGroupIds,
                        isPinned: false,
                    };

                    // --- 2. Ê†πÊçÆÊ®°ÂºèÊûÑÂª∫‰∏çÂêåÁöÑ post ÂØπË±° ---
                    if (mode === 'shuoshuo') {
                        const content = document.getElementById('post-public-text').value.trim();
                        if (!content) {
                            alert('ËØ¥ËØ¥ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫Âì¶ÔºÅ');
                            return;
                        }
                        newPost = {
                            ...basePostData,
                            type: 'shuoshuo',
                            content: content,
                        };

                    } else { // Â§ÑÁêÜ 'complex' Ê®°Âºè (ÂõæÁâá/ÊñáÂ≠óÂõæ)
                        const publicText = document.getElementById('post-public-text').value.trim();
                        const isImageModeActive = document.getElementById('image-mode-content').classList.contains('active');

                        if (isImageModeActive) {
                            const imageUrl = document.getElementById('post-image-preview').src;
                            const imageDescription = document.getElementById('post-image-description').value.trim();
                            if (!imageUrl || !(imageUrl.startsWith('http') || imageUrl.startsWith('data:'))) {
                                alert('ËØ∑ÂÖàÊ∑ªÂä†‰∏ÄÂº†ÂõæÁâáÂÜçÂèëÂ∏ÉÂä®ÊÄÅÂì¶ÔºÅ');
                                return;
                            }
                            if (!imageDescription) {
                                alert('ËØ∑‰∏∫‰Ω†ÁöÑÂõæÁâáÊ∑ªÂä†‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊèèËø∞ÔºàÂøÖÂ°´ÔºåÁªôAIÁúãÁöÑÔºâÔºÅ');
                                return;
                            }
                            newPost = {
                                ...basePostData,
                                type: 'image_post',
                                publicText: publicText,
                                imageUrl: imageUrl,
                                imageDescription: imageDescription,
                            };
                        } else { // ÊñáÂ≠óÂõæÊ®°Âºè
                            const hiddenText = document.getElementById('post-hidden-text').value.trim();
                            const decorativeImageUrl = document.getElementById('text-image-decorative-url').value.trim();
                            if (!hiddenText) {
                                alert('ËØ∑ËæìÂÖ•ÊñáÂ≠óÂõæÊèèËø∞ÔºÅ');
                                return;
                            }
                            newPost = {
                                ...basePostData,
                                type: 'text_image',
                                publicText: publicText,
                                hiddenContent: hiddenText,
                                decorativeImageUrl: decorativeImageUrl || null, // IMPORTANT: This field is purely decorative and must never be sent to API
                            };
                        }
                    }

                    // --- 3. ‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì ---
                    const newPostId = await db.qzonePosts.add(newPost);
                    let postSummary = newPost.content || newPost.publicText || newPost.imageDescription || newPost.hiddenContent || "ÔºàÊó†ÊñáÂ≠óÂÜÖÂÆπÔºâ";
                    postSummary = postSummary.substring(0, 50) + (postSummary.length > 50 ? '...' : '');

                    // --- 4. „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂ∏¶ÊúâÊùÉÈôêÊ£ÄÊü•ÁöÑÈÄöÁü•Âæ™ÁéØ ---
                    for (const chatId in state.chats) {
                        const chat = state.chats[chatId];
                        if (chat.isGroup) continue; // Ë∑≥ËøáÁæ§ËÅä

                        let shouldNotify = false;
                        const postVisibleGroups = newPost.visibleGroupIds;

                        // Âà§Êñ≠Êù°‰ª∂1ÔºöÂ¶ÇÊûúÂä®ÊÄÅÊòØÂÖ¨ÂºÄÁöÑ (Ê≤°ÊúâËÆæÁΩÆ‰ªª‰ΩïÂèØËßÅÂàÜÁªÑ)
                        if (!postVisibleGroups || postVisibleGroups.length === 0) {
                            shouldNotify = true;
                        }
                        // Âà§Êñ≠Êù°‰ª∂2ÔºöÂ¶ÇÊûúÂä®ÊÄÅËÆæÁΩÆ‰∫ÜÈÉ®ÂàÜÂèØËßÅÔºåÂπ∂‰∏îÂΩìÂâçËßíËâ≤Âú®ÂèØËßÅÂàÜÁªÑÂÜÖ
                        else if (chat.groupId && postVisibleGroups.includes(chat.groupId)) {
                            shouldNotify = true;
                        }

                        // Âè™ÊúâÊª°Ë∂≥Êù°‰ª∂ÁöÑËßíËâ≤Êâç‰ºöË¢´ÈÄöÁü•
                        if (shouldNotify) {
                            const historyMessage = {
                                role: 'system',
                                content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÂàöÂàöÂèëÂ∏É‰∫Ü‰∏ÄÊù°Âä®ÊÄÅ(ID: ${newPostId})ÔºåÂÜÖÂÆπÊëòË¶ÅÊòØÔºö‚Äú${postSummary}‚Äù„ÄÇ‰Ω†Áé∞Âú®ÂèØ‰ª•ÂØπËøôÊù°Âä®ÊÄÅËøõË°åËØÑËÆ∫‰∫Ü„ÄÇ]`,
                                timestamp: Date.now(),
                                isHidden: true
                            };
                            chat.history.push(historyMessage);
                            await db.chats.put(chat);
                        }
                    }
                    // --- ‰øÆÊ≠£ÁªìÊùü ---

                    await renderQzonePosts();
                    modal.classList.remove('visible');
                    alert('Âä®ÊÄÅÂèëÂ∏ÉÊàêÂäüÔºÅ');
                });

                // ‚ñº‚ñº‚ñº COMMENTED OUT: Swipe left to delete post functionality ‚ñº‚ñº‚ñº
                /*
                const postsList = document.getElementById('qzone-posts-list');
                let swipeState = { isDragging: false, startX: 0, startY: 0, currentX: 0, activeContainer: null, swipeDirection: null, isClick: true };

                function resetAllSwipes(exceptThisOne = null) {
                    document.querySelectorAll('.qzone-post-container').forEach(container => {
                        if (container !== exceptThisOne) {
                            container.querySelector('.qzone-post-item').classList.remove('swiped');
                        }
                    });
                }

                const handleSwipeStart = (e) => {
                    const targetContainer = e.target.closest('.qzone-post-container');
                    if (!targetContainer) return;

                    resetAllSwipes(targetContainer);
                    swipeState.activeContainer = targetContainer;
                    swipeState.isDragging = true;
                    swipeState.isClick = true;
                    swipeState.swipeDirection = null;
                    swipeState.startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
                    swipeState.startY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
                    swipeState.activeContainer.querySelector('.qzone-post-item').style.transition = 'none';
                };

                const handleSwipeMove = (e) => {
                    if (!swipeState.isDragging || !swipeState.activeContainer) return;

                    const currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
                    const currentY = e.type.includes('mouse') ? e.pageY : e.touches[0].pageY;
                    const diffX = currentX - swipeState.startX;
                    const diffY = currentY - swipeState.startY;
                    const absDiffX = Math.abs(diffX);
                    const absDiffY = Math.abs(diffY);
                    const clickThreshold = 5;

                    if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
                        swipeState.isClick = false;
                    }

                    if (swipeState.swipeDirection === null) {
                        if (absDiffX > clickThreshold || absDiffY > clickThreshold) {
                            if (absDiffX > absDiffY) {
                                swipeState.swipeDirection = 'horizontal';
                            } else {
                                swipeState.swipeDirection = 'vertical';
                            }
                        }
                    }
                    if (swipeState.swipeDirection === 'vertical') {
                        handleSwipeEnd(e);
                        return;
                    }
                    if (swipeState.swipeDirection === 'horizontal') {
                        e.preventDefault();
                        swipeState.currentX = currentX;
                        let translation = diffX;
                        if (translation > 0) translation = 0;
                        if (translation < -90) translation = -90;
                        swipeState.activeContainer.querySelector('.qzone-post-item').style.transform = `translateX(${translation}px)`;
                    }
                };

                const handleSwipeEnd = (e) => {
                    if (swipeState.isClick) {
                        swipeState.isDragging = false;
                        swipeState.activeContainer = null;
                        return;
                    }
                    if (!swipeState.isDragging || !swipeState.activeContainer) return;

                    const postItem = swipeState.activeContainer.querySelector('.qzone-post-item');
                    postItem.style.transition = 'transform 0.3s ease';

                    const finalX = e.type.includes('touchend') ? e.changedTouches[0].pageX : e.pageX;
                    const diffX = finalX - swipeState.startX;
                    const swipeThreshold = -40;

                    if (swipeState.swipeDirection === 'horizontal' && diffX < swipeThreshold) {
                        postItem.classList.add('swiped');
                        postItem.style.transform = '';
                    } else {
                        postItem.classList.remove('swiped');
                        postItem.style.transform = '';
                    }

                    swipeState.isDragging = false;
                    swipeState.startX = 0;
                    swipeState.startY = 0;
                    swipeState.currentX = 0;
                    swipeState.activeContainer = null;
                    swipeState.swipeDirection = null;
                    swipeState.isClick = true;
                };

                // --- ÁªëÂÆöÊâÄÊúâÊªëÂä®‰∫ã‰ª∂ ---
                postsList.addEventListener('mousedown', handleSwipeStart);
                document.addEventListener('mousemove', handleSwipeMove);
                document.addEventListener('mouseup', handleSwipeEnd);
                postsList.addEventListener('touchstart', handleSwipeStart, { passive: false });
                postsList.addEventListener('touchmove', handleSwipeMove, { passive: false });
                postsList.addEventListener('touchend', handleSwipeEnd);
                */
                // ‚ñ≤‚ñ≤‚ñ≤ END COMMENTED OUT: Swipe left to delete post functionality ‚ñ≤‚ñ≤‚ñ≤

                const postsList = document.getElementById('qzone-posts-list');

                // --- ÁªëÂÆöÊâÄÊúâÁÇπÂáª‰∫ã‰ª∂ ---
                postsList.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const target = e.target;

                    const commentItem = target.closest('.comment-item');
                    if (commentItem) {
                        // Comment clicks are handled by long press, so we just return here
                        return;
                    }

                    if (target.classList.contains('post-actions-btn')) {
                        const container = target.closest('.qzone-post-container');
                        if (container && container.dataset.postId) {
                            showPostActions(parseInt(container.dataset.postId));
                        }
                        return;
                    }

                    // COMMENTED OUT: Delete action click handler for swipe functionality
                    /*
                    if (target.closest('.qzone-post-delete-action')) {
                        const container = target.closest('.qzone-post-container');
                        if (!container) return;

                        const postIdToDelete = parseInt(container.dataset.postId);
                        if (isNaN(postIdToDelete)) return;

                        const confirmed = await showCustomConfirm('Âà†Èô§Âä®ÊÄÅ', 'Á°ÆÂÆöË¶ÅÊ∞∏‰πÖÂà†Èô§ËøôÊù°Âä®ÊÄÅÂêóÔºü', { confirmButtonClass: 'btn-danger' });

                        if (confirmed) {
                            container.style.transition = 'all 0.3s ease';
                            container.style.transform = 'scale(0.8)';
                            container.style.opacity = '0';

                            setTimeout(async () => {
                                await db.qzonePosts.delete(postIdToDelete);

                                // Âà†Èô§ÊâÄÊúâËÅäÂ§©ËÆ∞ÂΩï‰∏≠ÂºïÁî®Ê≠§Âä®ÊÄÅÁöÑÁ≥ªÁªüÊ∂àÊÅØ
                                const allChats = await db.chats.toArray();
                                for (const chat of allChats) {
                                    const originalLength = chat.history.length;
                                    chat.history = chat.history.filter(msg => {
                                        // Âà†Èô§ÂºïÁî®Ê≠§Âä®ÊÄÅIDÁöÑÁ≥ªÁªüÊ∂àÊÅØ
                                        if (msg.role === 'system' && msg.isHidden && msg.content.includes(`(ID: ${postIdToDelete})`)) {
                                            return false;
                                        }
                                        return true;
                                    });
                                    
                                    // Âè™ÊúâÂú®ÂéÜÂè≤ËÆ∞ÂΩïÂèëÁîüÂèòÂåñÊó∂ÊâçÊõ¥Êñ∞Êï∞ÊçÆÂ∫ì
                                    if (chat.history.length !== originalLength) {
                                        await db.chats.put(chat);
                                        // Êõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÁöÑÁä∂ÊÄÅ
                                        if (state.chats[chat.id]) {
                                            state.chats[chat.id].history = chat.history;
                                        }
                                    }
                                }

                                await renderQzonePosts();
                                
                                // Â¶ÇÊûúÂΩìÂâçÊ≠£Âú®Êü•ÁúãÊüê‰∏™ËÅäÂ§©ÁïåÈù¢ÔºåÂà∑Êñ∞ÂÆÉ
                                if (state.activeChatId && document.getElementById('chat-interface-screen').classList.contains('active')) {
                                    renderChatInterface(state.activeChatId);
                                }
                                
                                alert('Âä®ÊÄÅÂ∑≤Âà†Èô§„ÄÇ');
                            }, 300);
                        }
                        return;
                    }
                    */

                    if ((target.tagName === 'IMG' || target.tagName === 'SPAN') && target.dataset.hiddenText) {
                        const hiddenText = target.dataset.hiddenText;
                        showCustomAlert("ÂõæÁâáÂÜÖÂÆπ", hiddenText.replace(/<br>/g, '\n'));
                        return;
                    }
                    const icon = target.closest('.action-icon');
                    if (icon) {
                        const postContainer = icon.closest('.qzone-post-container');
                        if (!postContainer) return;
                        const postId = parseInt(postContainer.dataset.postId);
                        if (isNaN(postId)) return;
                        if (icon.classList.contains('like')) {
                            const post = await db.qzonePosts.get(postId);
                            if (!post) return;
                            if (!post.likes) post.likes = [];
                            const userNickname = state.qzoneSettings.nickname;
                            const userLikeIndex = post.likes.indexOf(userNickname);
                            if (userLikeIndex > -1) {
                                post.likes.splice(userLikeIndex, 1);
                            } else {
                                post.likes.push(userNickname);
                                icon.classList.add('animate-like');
                                icon.addEventListener('animationend', () => icon.classList.remove('animate-like'), { once: true });
                            }
                            await db.qzonePosts.update(postId, { likes: post.likes });
                        }
                        if (icon.classList.contains('favorite')) {
                            const existingFavorite = await db.favorites.where({ type: 'qzone_post', 'content.id': postId }).first();
                            if (existingFavorite) {
                                await db.favorites.delete(existingFavorite.id);
                                await showCustomAlert('ÊèêÁ§∫', 'Â∑≤ÂèñÊ∂àÊî∂Ëóè');
                            } else {
                                const postToSave = await db.qzonePosts.get(postId);
                                if (postToSave) {
                                    await db.favorites.add({ type: 'qzone_post', content: postToSave, timestamp: Date.now() });
                                    await showCustomAlert('ÊèêÁ§∫', 'Êî∂ËóèÊàêÂäüÔºÅ');
                                }
                            }
                        }
                        await renderQzonePosts();
                        return;
                    }
                    const sendBtn = target.closest('.comment-send-btn');
                    if (sendBtn) {
                        const postContainer = sendBtn.closest('.qzone-post-container');
                        if (!postContainer) return;
                        const postId = parseInt(postContainer.dataset.postId);
                        const commentInput = postContainer.querySelector('.comment-input');
                        const commentText = commentInput.value.trim();
                        if (!commentText) return alert('ËØÑËÆ∫ÂÜÖÂÆπ‰∏çËÉΩ‰∏∫Á©∫Âì¶ÔºÅ');
                        const post = await db.qzonePosts.get(postId);
                        if (!post) return;
                        if (!post.comments) post.comments = [];
                        const newComment = {
                            commenterName: state.qzoneSettings.nickname,
                            text: commentText,
                            timestamp: Date.now()
                        };
                        post.comments.push(newComment);
                        await db.qzonePosts.update(postId, { comments: post.comments });

                        // „ÄêÊ†∏ÂøÉ‰øÆÊîπ„ÄëÂú®ËøôÈáåËß¶ÂèëAIÂØπËØÑËÆ∫ÁöÑÂìçÂ∫î
                        // ÈÅçÂéÜÊâÄÊúâÈùûÁæ§ËÅäÁöÑAI
                        for (const chatId in state.chats) {
                            const chat = state.chats[chatId];
                            if (!chat.isGroup) {
                                // Â¶ÇÊûúÊòØÂä®ÊÄÅ‰ΩúËÄÖÔºåÁªô‰ªñÂèëÈÄÅÁâπÊÆäÊèêÁ§∫
                                if (post.authorId === chatId) {
                                    chat.history.push({
                                        role: 'system',
                                        content: `[Á≥ªÁªüÊèêÁ§∫Ôºö'${state.qzoneSettings.nickname}' ÂàöÂàöËØÑËÆ∫‰∫Ü‰Ω†ÁöÑÂä®ÊÄÅ (ID: ${postId})Ôºö‚Äú${commentText}‚Äù„ÄÇËØ∑‰Ω†ÂõûÂ§ç„ÄÇ]`,
                                        timestamp: Date.now(),
                                        isHidden: true
                                    });
                                }
                                // Â¶ÇÊûú‰∏çÊòØ‰ΩúËÄÖÔºå‰ΩÜÊúâÊùÉÈôêÁúãÂà∞ËøôÊù°Âä®ÊÄÅÔºå‰πüÁªô‰ªñÂèë‰∏™ÈÄöÁü•
                                else {
                                    let isVisible = false;
                                    const visibleGroups = post.visibleGroupIds;
                                    if (!visibleGroups || visibleGroups.length === 0) {
                                        isVisible = true; // ÂÖ¨ÂºÄ
                                    } else if (chat.groupId && visibleGroups.includes(chat.groupId)) {
                                        isVisible = true; // Âú®ÊåáÂÆöÂàÜÁªÑÂÜÖ
                                    }
                                    if (isVisible) {
                                        chat.history.push({
                                            role: 'system',
                                            content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑'${state.qzoneSettings.nickname}' ËØÑËÆ∫‰∫ÜÂä®ÊÄÅ (ID: ${postId})„ÄÇ]`,
                                            timestamp: Date.now(),
                                            isHidden: true
                                        });
                                    }
                                }
                                await db.chats.put(chat);
                            }
                        }

                        commentInput.value = '';
                        await renderQzonePosts();
                        return;
                    }

                    // Â§ÑÁêÜAIÂõûÂ§çÊåâÈíÆÁÇπÂáª
                    const aiReplyBtn = target.closest('.call-ai-reply-btn');
                    if (aiReplyBtn) {
                        const postContainer = aiReplyBtn.closest('.qzone-post-container');
                        if (!postContainer) return;
                        const postId = parseInt(postContainer.dataset.postId);
                        showAiReplyModal(postId);
                        return;
                    }
                });


                // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÔºåÁ≤òË¥¥‰∏ãÈù¢Ëøô‰∏§Ë°å ‚ñº‚ñº‚ñº

                // ÁªëÂÆöÂä®ÊÄÅÈ°µÂíåÊî∂ËóèÈ°µÁöÑËøîÂõûÊåâÈíÆ
                document.getElementById('qzone-back-btn').addEventListener('click', () => showScreen('home-screen'));
                document.getElementById('favorites-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

                // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÔºåÊ£ÄÊü•Âπ∂Á°Æ‰øù‰Ω†ÊúâËøôÊÆµÂÆåÊï¥ÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº

                // Êî∂ËóèÈ°µÊêúÁ¥¢ÂäüËÉΩ
                const searchInput = document.getElementById('favorites-search-input');
                const searchClearBtn = document.getElementById('favorites-search-clear-btn');

                searchInput.addEventListener('input', () => {
                    const searchTerm = searchInput.value.trim().toLowerCase();

                    // ÊéßÂà∂Ê∏ÖÈô§ÊåâÈíÆÁöÑÊòæÁ§∫/ÈöêËóè
                    searchClearBtn.style.display = searchTerm ? 'block' : 'none';

                    if (!searchTerm) {
                        displayFilteredFavorites(allFavoriteItems); // Â¶ÇÊûúÊêúÁ¥¢Ê°Ü‰∏∫Á©∫ÔºåÊòæÁ§∫ÊâÄÊúâ
                        return;
                    }

                    // Á≠õÈÄâÈÄªËæë
                    const filteredItems = allFavoriteItems.filter(item => {
                        let contentToSearch = '';
                        let authorToSearch = '';

                        if (item.type === 'qzone_post') {
                            const post = item.content;
                            contentToSearch += (post.publicText || '') + ' ' + (post.content || '');
                            if (post.authorId === 'user') {
                                authorToSearch = state.qzoneSettings.nickname;
                            } else if (state.chats[post.authorId]) {
                                authorToSearch = state.chats[post.authorId].name;
                            }
                        } else if (item.type === 'chat_message') {
                            const msg = item.content;
                            if (typeof msg.content === 'string') {
                                contentToSearch = msg.content;
                            }
                            const chat = state.chats[item.chatId];
                            if (chat) {
                                if (msg.role === 'user') {
                                    authorToSearch = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë';
                                } else {
                                    authorToSearch = chat.isGroup ? msg.senderName : chat.name;
                                }
                            }
                        }

                        // ÂêåÊó∂ÊêúÁ¥¢ÂÜÖÂÆπÂíå‰ΩúËÄÖÔºåÂπ∂‰∏î‰∏çÂå∫ÂàÜÂ§ßÂ∞èÂÜô
                        return contentToSearch.toLowerCase().includes(searchTerm) ||
                            authorToSearch.toLowerCase().includes(searchTerm);
                    });

                    displayFilteredFavorites(filteredItems);
                });

                // Ê∏ÖÈô§ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
                searchClearBtn.addEventListener('click', () => {
                    searchInput.value = '';
                    searchClearBtn.style.display = 'none';
                    displayFilteredFavorites(allFavoriteItems);
                    searchInput.focus();
                });

                // ‚ñ≤‚ñ≤‚ñ≤ ‰ª£Á†ÅÊ£ÄÊü•ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº Êñ∞Â¢û/‰øÆÊîπÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº

                // ‰∏∫ËÅäÂ§©ÁïåÈù¢ÁöÑÊâπÈáèÊî∂ËóèÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂
                // ‰∏∫ËÅäÂ§©ÁïåÈù¢ÁöÑÊâπÈáèÊî∂ËóèÊåâÈíÆÁªëÂÆö‰∫ã‰ª∂ (Â∑≤‰øÆÊ≠£)
                document.getElementById('selection-favorite-btn').addEventListener('click', async () => {
                    if (selectedMessages.size === 0) return;
                    const chat = state.chats[state.activeChatId];
                    if (!chat) return;

                    const favoritesToAdd = [];
                    const timestampsToFavorite = [...selectedMessages];

                    for (const timestamp of timestampsToFavorite) {
                        // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£1„Äë‰ΩøÁî®Êñ∞ÁöÑ„ÄÅÈ´òÊïàÁöÑÁ¥¢ÂºïËøõË°åÊü•ËØ¢
                        const existing = await db.favorites.where('originalTimestamp').equals(timestamp).first();

                        if (!existing) {
                            const messageToSave = chat.history.find(msg => msg.timestamp === timestamp);
                            if (messageToSave) {
                                favoritesToAdd.push({
                                    type: 'chat_message',
                                    content: messageToSave,
                                    chatId: state.activeChatId,
                                    timestamp: Date.now(), // ËøôÊòØÊî∂ËóèÊìç‰ΩúÂèëÁîüÁöÑÊó∂Èó¥
                                    originalTimestamp: messageToSave.timestamp // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£2„Äë‰øùÂ≠òÂéüÂßãÊ∂àÊÅØÁöÑÊó∂Èó¥Êà≥Âà∞Êñ∞Â≠óÊÆµ
                                });
                            }
                        }
                    }

                    if (favoritesToAdd.length > 0) {
                        await db.favorites.bulkAdd(favoritesToAdd);
                        allFavoriteItems = await db.favorites.orderBy('timestamp').reverse().toArray(); // Êõ¥Êñ∞ÂÖ®Â±ÄÊî∂ËóèÁºìÂ≠ò
                        await showCustomAlert('Êî∂ËóèÊàêÂäü', `Â∑≤ÊàêÂäüÊî∂Ëóè ${favoritesToAdd.length} Êù°Ê∂àÊÅØ„ÄÇ`);
                    } else {
                        await showCustomAlert('ÊèêÁ§∫', 'ÈÄâ‰∏≠ÁöÑÊ∂àÊÅØÂùáÂ∑≤Êî∂ËóèËøá„ÄÇ');
                    }

                    exitSelectionMode();
                });

                // Êî∂ËóèÈ°µÈù¢ÁöÑ"ÁºñËæë"ÊåâÈíÆ‰∫ã‰ª∂ (Â∑≤‰øÆÊ≠£)
                const favoritesEditBtn = document.getElementById('favorites-edit-btn');
                const favoritesView = document.getElementById('favorites-view');
                const favoritesActionBar = document.getElementById('favorites-action-bar');
                const mainBottomNav = document.getElementById('chat-list-bottom-nav'); // Ëé∑Âèñ‰∏ªÂØºËà™Ê†è
                const favoritesList = document.getElementById('favorites-list'); // Ëé∑ÂèñÊî∂ËóèÂàóË°®

                favoritesEditBtn.addEventListener('click', () => {
                    isFavoritesSelectionMode = !isFavoritesSelectionMode;
                    favoritesView.classList.toggle('selection-mode', isFavoritesSelectionMode);

                    if (isFavoritesSelectionMode) {
                        // --- ËøõÂÖ•ÁºñËæëÊ®°Âºè ---
                        favoritesEditBtn.textContent = 'ÂÆåÊàê';
                        favoritesActionBar.style.display = 'block'; // ÊòæÁ§∫Âà†Èô§Êìç‰ΩúÊ†è
                        mainBottomNav.style.display = 'none'; // ‚ñº Êñ∞Â¢ûÔºöÈöêËóè‰∏ªÂØºËà™Ê†è
                        favoritesList.style.paddingBottom = '80px'; // ‚ñº Êñ∞Â¢ûÔºöÁªôÂàóË°®Â∫ïÈÉ®Â¢ûÂä†Á©∫Èó¥
                    } else {
                        // --- ÈÄÄÂá∫ÁºñËæëÊ®°Âºè ---
                        favoritesEditBtn.textContent = 'ÁºñËæë';
                        favoritesActionBar.style.display = 'none'; // ÈöêËóèÂà†Èô§Êìç‰ΩúÊ†è
                        mainBottomNav.style.display = 'flex';  // ‚ñº Êñ∞Â¢ûÔºöÊÅ¢Â§ç‰∏ªÂØºËà™Ê†è
                        favoritesList.style.paddingBottom = ''; // ‚ñº Êñ∞Â¢ûÔºöÊÅ¢Â§çÂàóË°®ÈªòËÆ§padding

                        // ÈÄÄÂá∫Êó∂Ê∏ÖÁ©∫ÊâÄÊúâÈÄâÊã©
                        selectedFavorites.clear();
                        document.querySelectorAll('.favorite-item-card.selected').forEach(card => card.classList.remove('selected'));
                        document.getElementById('favorites-delete-selected-btn').textContent = `Âà†Èô§ (0)`;
                    }
                });

                // ‚ñº‚ñº‚ñº Â∞ÜÂÆÉ„ÄêÂÆåÊï¥ÊõøÊç¢„Äë‰∏∫‰∏ãÈù¢ËøôÊÆµ‰øÆÊ≠£ÂêéÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº
                // Êî∂ËóèÂàóË°®ÁöÑÁÇπÂáªÈÄâÊã©‰∫ã‰ª∂ (‰∫ã‰ª∂ÂßîÊâò)
                document.getElementById('favorites-list').addEventListener('click', (e) => {
                    const target = e.target;
                    const card = target.closest('.favorite-item-card');

                    // „ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÊñáÂ≠óÂõæÁÇπÂáªÔºåËøôÊÆµÈÄªËæëË¶ÅÊîæÂú®ÊúÄÂâçÈù¢Ôºå‰øùËØÅ‰ªª‰ΩïÊ®°Âºè‰∏ãÈÉΩÁîüÊïà
                    if ((target.tagName === 'IMG' || target.tagName === 'SPAN') && target.dataset.hiddenText) {
                        const hiddenText = target.dataset.hiddenText;
                        showCustomAlert("ÂõæÁâáÂÜÖÂÆπ", hiddenText.replace(/<br>/g, '\n'));
                        return; // Â§ÑÁêÜÂÆåÂ∞±ÈÄÄÂá∫Ôºå‰∏çÁªßÁª≠ÊâßË°åÈÄâÊã©ÈÄªËæë
                    }

                    // Â¶ÇÊûú‰∏çÂú®ÈÄâÊã©Ê®°ÂºèÔºåÂàô‰∏çÊâßË°åÂêéÁª≠ÁöÑÈÄâÊã©Êìç‰Ωú
                    if (!isFavoritesSelectionMode) return;

                    // --- ‰ª•‰∏ãÊòØÂéüÊúâÁöÑÈÄâÊã©ÈÄªËæëÔºå‰øùÊåÅ‰∏çÂèò ---
                    if (!card) return;

                    const favId = parseInt(card.dataset.favid);
                    if (isNaN(favId)) return;

                    // ÂàáÊç¢ÈÄâÊã©Áä∂ÊÄÅ
                    if (selectedFavorites.has(favId)) {
                        selectedFavorites.delete(favId);
                        card.classList.remove('selected');
                    } else {
                        selectedFavorites.add(favId);
                        card.classList.add('selected');
                    }

                    // Êõ¥Êñ∞Â∫ïÈÉ®Âà†Èô§ÊåâÈíÆÁöÑËÆ°Êï∞
                    document.getElementById('favorites-delete-selected-btn').textContent = `Âà†Èô§ (${selectedFavorites.size})`;
                });

                // ‚ñº‚ñº‚ñº Â∞ÜÂÆÉ„ÄêÂÆåÊï¥ÊõøÊç¢„Äë‰∏∫‰∏ãÈù¢ËøôÊÆµ‰øÆÊ≠£ÂêéÁöÑ‰ª£Á†Å ‚ñº‚ñº‚ñº
                // Êî∂ËóèÈ°µÈù¢ÊâπÈáèÂà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('favorites-delete-selected-btn').addEventListener('click', async () => {
                    if (selectedFavorites.size === 0) return;

                    const confirmed = await showCustomConfirm(
                        'Á°ÆËÆ§Âà†Èô§',
                        `Á°ÆÂÆöË¶Å‰ªéÊî∂ËóèÂ§π‰∏≠ÁßªÈô§Ëøô ${selectedFavorites.size} Êù°ÂÜÖÂÆπÂêóÔºü`,
                        { confirmButtonClass: 'btn-danger' }
                    );

                    if (confirmed) {
                        const idsToDelete = [...selectedFavorites];
                        await db.favorites.bulkDelete(idsToDelete);
                        await showCustomAlert('Âà†Èô§ÊàêÂäü', 'ÈÄâ‰∏≠ÁöÑÊî∂ËóèÂ∑≤Ë¢´ÁßªÈô§„ÄÇ');

                        // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£1„Äë‰ªéÂâçÁ´ØÁºìÂ≠ò‰∏≠‰πüÁßªÈô§Ë¢´Âà†Èô§ÁöÑÈ°π
                        allFavoriteItems = allFavoriteItems.filter(item => !idsToDelete.includes(item.id));

                        // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£2„Äë‰ΩøÁî®Êõ¥Êñ∞ÂêéÁöÑÁºìÂ≠òÔºåÁ´ãÂç≥ÈáçÊñ∞Ê∏≤ÊüìÂàóË°®
                        displayFilteredFavorites(allFavoriteItems);

                        // ÊúÄÂêéÔºåÂÜçÈÄÄÂá∫ÁºñËæëÊ®°Âºè
                        favoritesEditBtn.click(); // Ê®°ÊãüÁÇπÂáª"ÂÆåÊàê"ÊåâÈíÆÊù•ÈÄÄÂá∫ÁºñËæëÊ®°Âºè
                    }
                });

                // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞Êú´Â∞æÊ∑ªÂä† ‚ñº‚ñº‚ñº
                if (state.globalSettings.enableBackgroundActivity) {
                    startBackgroundSimulation();
                    console.log("ÂêéÂè∞Ê¥ªÂä®Ê®°ÊãüÂ∑≤Ëá™Âä®ÂêØÂä®„ÄÇ");
                }
                // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº „ÄêËøôÊòØÊúÄÁªàÁöÑÊ≠£Á°Æ‰ª£Á†Å„ÄëËØ∑Á≤òË¥¥ËøôÊÆµ‰ª£Á†ÅÂà∞ init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æ ‚ñº‚ñº‚ñº

                // --- Áªü‰∏ÄÂ§ÑÁêÜÊâÄÊúâÂΩ±ÂìçÈ¢ÑËßàÁöÑÊéß‰ª∂ÁöÑ‰∫ã‰ª∂ ---

                // 1. ÁõëÂê¨‰∏ªÈ¢òÈÄâÊã©
                document.querySelectorAll('input[name="theme-select"]').forEach(radio => {
                    radio.addEventListener('change', updateSettingsPreview);
                });

                // 2. ÁõëÂê¨Â≠ó‰ΩìÂ§ßÂ∞èÊªëÂùó
                const fontSizeSlider = document.getElementById('font-size-slider');
                fontSizeSlider.addEventListener('input', () => {
                    // a. ÂÆûÊó∂Êõ¥Êñ∞Êï∞ÂÄºÊòæÁ§∫
                    document.getElementById('font-size-value').textContent = `${fontSizeSlider.value}px`;
                    // b. Êõ¥Êñ∞È¢ÑËßà
                    updateSettingsPreview();
                });

                // 3. ÁõëÂê¨Ëá™ÂÆö‰πâCSSËæìÂÖ•Ê°Ü
                const customCssInputForPreview = document.getElementById('custom-css-input');
                customCssInputForPreview.addEventListener('input', updateSettingsPreview);

                // 4. ÁõëÂê¨ÈáçÁΩÆÊåâÈíÆ
                document.getElementById('reset-theme-btn').addEventListener('click', () => {
                    document.getElementById('theme-default').checked = true;
                    updateSettingsPreview();
                });

                document.getElementById('reset-custom-css-btn').addEventListener('click', () => {
                    document.getElementById('custom-css-input').value = '';
                    updateSettingsPreview();
                });

                // ‚ñ≤‚ñ≤‚ñ≤ Á≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµ„ÄêÊñ∞‰ª£Á†Å„ÄëÁ≤òË¥¥Âà∞ init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æ ‚ñº‚ñº‚ñº
                document.querySelectorAll('input[name="visibility"]').forEach(radio => {
                    radio.addEventListener('change', function () {
                        const groupsContainer = document.getElementById('post-visibility-groups');
                        if (this.value === 'include' || this.value === 'exclude') {
                            groupsContainer.style.display = 'block';
                        } else {
                            groupsContainer.style.display = 'none';
                        }
                    });
                });
                // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµ„ÄêÊñ∞‰ª£Á†Å„ÄëÁ≤òË¥¥Âà∞ init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æ ‚ñº‚ñº‚ñº
                document.getElementById('manage-groups-btn').addEventListener('click', openGroupManager);
                document.getElementById('close-group-manager-btn').addEventListener('click', () => {
                    document.getElementById('group-management-modal').classList.remove('visible');
                    // Âà∑Êñ∞ËÅäÂ§©ËÆæÁΩÆÈáåÁöÑÂàÜÁªÑÂàóË°®
                    const chatSettingsBtn = document.getElementById('chat-settings-btn');
                    if (document.getElementById('chat-settings-modal').classList.contains('visible')) {
                        chatSettingsBtn.click(); // ÂÜçÊ¨°ÁÇπÂáª‰ª•ÈáçÊñ∞ÊâìÂºÄ
                    }
                });

                document.getElementById('add-new-group-btn').addEventListener('click', addNewGroup);
                document.getElementById('existing-groups-list').addEventListener('click', (e) => {
                    if (e.target.classList.contains('delete-group-btn')) {
                        const groupId = parseInt(e.target.dataset.id);
                        deleteGroup(groupId);
                    }
                });
                // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰ª£Á†ÅÁ≤òË¥¥ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº ËØ∑Â∞ÜËøôÊÆµ„ÄêÊñ∞‰ª£Á†Å„ÄëÁ≤òË¥¥Âà∞ init() ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æ ‚ñº‚ñº‚ñº
                // Ê∂àÊÅØÊìç‰ΩúËèúÂçïÁöÑÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('cancel-message-action-btn').addEventListener('click', hideMessageActions);
                document.getElementById('quote-message-btn').addEventListener('click', startReplyToMessage);
                document.getElementById('recall-message-btn').addEventListener('click', handleRecallClick);

                // Chat actions event handlers
                document.getElementById('cancel-chat-action-btn').addEventListener('click', hideChatActions);
                document.getElementById('pin-chat-btn').addEventListener('click', async () => {
                    if (!activeChatId) return;
                    const chat = state.chats[activeChatId];
                    if (!chat) return;

                    chat.isPinned = true;
                    await db.chats.put(chat);
                    renderChatList();
                    hideChatActions();
                });
                document.getElementById('unpin-chat-btn').addEventListener('click', async () => {
                    if (!activeChatId) return;
                    const chat = state.chats[activeChatId];
                    if (!chat) return;

                    chat.isPinned = false;
                    await db.chats.put(chat);
                    renderChatList();
                    hideChatActions();
                });
                document.getElementById('delete-chat-btn').addEventListener('click', async () => {
                    if (!activeChatId) return;
                    const chat = state.chats[activeChatId];
                    if (!chat) return;

                    hideChatActions();
                    const confirmed = await showCustomConfirm('Âà†Èô§ÂØπËØù', `Á°ÆÂÆöË¶ÅÂà†Èô§‰∏é "${chat.name}" ÁöÑÊï¥‰∏™ÂØπËØùÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, { confirmButtonClass: 'btn-danger' });
                    if (confirmed) {
                        if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false);
                        delete state.chats[chat.id];
                        if (state.activeChatId === chat.id) state.activeChatId = null;
                        await db.chats.delete(chat.id);
                        renderChatList();
                    }
                });
                // ÁªëÂÆöÂõûÂ§çÈ¢ÑËßàÊ†è‰∏≠ÁöÑ"ÂèñÊ∂à"ÊåâÈíÆ
                document.getElementById('cancel-reply-btn').addEventListener('click', cancelReplyMode);
                // ‚ñº‚ñº‚ñº „Äê‰øÆÊ≠£„Äë‰ΩøÁî®Êñ∞ÁöÑÁºñËæëÂô®ÂÖ•Âè£ ‚ñº‚ñº‚ñº
                document.getElementById('edit-message-btn').addEventListener('click', () => {
                    // Check if we're in meetup screen
                    const isInMeetup = document.getElementById('meetup-screen').classList.contains('active');

                    if (isInMeetup) {
                        // Use date mode edit
                        const timestampToEdit = activeMessageTimestamp;
                        editMeetupMessage(timestampToEdit);
                    } else {
                        // Check if it's a location message
                        const chat = state.chats[state.activeChatId];
                        const message = chat.history.find(m => m.timestamp === activeMessageTimestamp);

                        if (message && message.type === 'location_share') {
                            editLocationMessage(activeMessageTimestamp);
                        } else {
                            // Use regular chat edit
                            openAdvancedMessageEditor();
                        }
                    }
                });
                // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº ËØ∑Áî®ËøôÊÆµ„Äê‰øÆÊ≠£Âêé„ÄëÁöÑ‰ª£Á†ÅÊõøÊç¢ÊóßÁöÑ select-message-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
                document.getElementById('select-message-btn').addEventListener('click', () => {
                    // „ÄêÊ†∏ÂøÉ‰øÆÂ§ç„ÄëÂú®ÂÖ≥Èó≠ËèúÂçïÂâçÔºåÂÖàÊçïËé∑Êó∂Èó¥Êà≥
                    const timestampToSelect = activeMessageTimestamp;
                    hideMessageActions();

                    // Check if we're in meetup screen
                    const isInMeetup = document.getElementById('meetup-screen').classList.contains('active');

                    if (timestampToSelect) {
                        if (isInMeetup) {
                            // Use meetup selection
                            enterMeetupSelectionMode(timestampToSelect);
                        } else {
                            // Use regular chat selection
                            enterSelectionMode(timestampToSelect);
                        }
                    }
                });
                // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº Âú® init() ÂáΩÊï∞ÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®Âå∫ÂüüÊú´Â∞æÊ∑ªÂä† ‚ñº‚ñº‚ñº

                // Âä®ÊÄÅÊìç‰ΩúËèúÂçïÁöÑÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('pin-post-btn').addEventListener('click', pinPost);
                document.getElementById('unpin-post-btn').addEventListener('click', unpinPost);
                document.getElementById('edit-post-btn').addEventListener('click', openPostEditor);
                document.getElementById('copy-post-btn').addEventListener('click', copyPostContent);
                document.getElementById('delete-post-btn').addEventListener('click', deletePost);
                document.getElementById('cancel-post-action-btn').addEventListener('click', hidePostActions);

                // ËØÑËÆ∫Êìç‰ΩúËèúÂçïÁöÑÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('edit-comment-btn').addEventListener('click', editComment);
                document.getElementById('delete-comment-btn').addEventListener('click', deleteComment);
                document.getElementById('cancel-comment-action-btn').addEventListener('click', hideCommentActions);

                // AIÂõûÂ§çÊ®°ÊÄÅÊ°ÜÁöÑÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('close-ai-reply-modal').addEventListener('click', hideAiReplyModal);
                document.getElementById('cancel-ai-reply').addEventListener('click', hideAiReplyModal);
                document.getElementById('confirm-ai-reply').addEventListener('click', confirmAiReply);
                document.getElementById('select-all-ais').addEventListener('click', selectAllAis);
                document.getElementById('deselect-all-ais').addEventListener('click', deselectAllAis);

                // AIÂèëÂä®ÊÄÅÊ®°ÊÄÅÊ°ÜÁöÑÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('close-ai-post-modal').addEventListener('click', hideAiPostModal);
                document.getElementById('cancel-ai-post').addEventListener('click', hideAiPostModal);
                document.getElementById('confirm-ai-post').addEventListener('click', confirmAiPost);
                document.getElementById('ai-post-btn').addEventListener('click', showAiPostModal);

                // AIËÆ∞ÂΩïÂõûÂøÜÊ®°ÊÄÅÊ°ÜÁöÑÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('close-ai-memory-modal').addEventListener('click', hideAiMemoryModal);
                document.getElementById('cancel-ai-memory').addEventListener('click', hideAiMemoryModal);
                document.getElementById('confirm-ai-memory').addEventListener('click', confirmAiMemory);

                // ÁßªÂä®Ë°®ÊÉÖÂåÖÊ®°ÊÄÅÊ°ÜÁöÑÊåâÈíÆ‰∫ã‰ª∂
                document.getElementById('close-move-sticker-modal').addEventListener('click', hideMoveStickerModal);
                document.getElementById('cancel-move-sticker').addEventListener('click', hideMoveStickerModal);
                document.getElementById('confirm-move-sticker').addEventListener('click', confirmMoveSticker);

                // ‚ñ≤‚ñ≤‚ñ≤ Ê∑ªÂä†ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº „ÄêÊñ∞Â¢û„ÄëËÅîÁ≥ª‰∫∫ÈÄâÊã©Âô®‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
                document.getElementById('cancel-contact-picker-btn').addEventListener('click', () => {
                    showScreen('chat-list-screen');
                });

                document.getElementById('contact-picker-list').addEventListener('click', (e) => {
                    const item = e.target.closest('.contact-picker-item');
                    if (!item) return;

                    const contactId = item.dataset.contactId;
                    item.classList.toggle('selected');

                    if (selectedContacts.has(contactId)) {
                        selectedContacts.delete(contactId);
                    } else {
                        selectedContacts.add(contactId);
                    }
                    updateContactPickerConfirmButton();
                });

                // ‚ñº‚ñº‚ñº „ÄêÊñ∞Â¢û„ÄëÁªëÂÆö‚ÄúÁÆ°ÁêÜÁæ§ÊàêÂëò‚ÄùÊåâÈíÆ‰∫ã‰ª∂ ‚ñº‚ñº‚ñº
                document.getElementById('manage-members-btn').addEventListener('click', () => {
                    // Âú®ÂàáÊç¢Â±èÂπïÂâçÔºåÂÖàÈöêËóèÂΩìÂâçÁöÑËÅäÂ§©ËÆæÁΩÆÂºπÁ™ó
                    document.getElementById('chat-settings-modal').classList.remove('visible');
                    // ÁÑ∂ÂêéÂÜçÊâìÂºÄÊàêÂëòÁÆ°ÁêÜÂ±èÂπï
                    openMemberManagementScreen();
                });
                // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº „ÄêÊúÄÁªàÂÆåÊï¥Áâà„ÄëÁæ§ÊàêÂëòÁÆ°ÁêÜÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
                document.getElementById('back-from-member-management').addEventListener('click', () => {

                    showScreen('chat-interface-screen');
                    document.getElementById('chat-settings-btn').click();
                });
                // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                document.getElementById('member-management-list').addEventListener('click', (e) => {
                    // „ÄêÂ∑≤ÊÅ¢Â§ç„ÄëÁßªÈô§ÊàêÂëòÁöÑ‰∫ã‰ª∂
                    if (e.target.classList.contains('remove-member-btn')) {
                        removeMemberFromGroup(e.target.dataset.memberId);
                    }
                });

                document.getElementById('add-existing-contact-btn').addEventListener('click', async () => {
                    // „ÄêÂ∑≤ÊÅ¢Â§ç„Äë‰ªéÂ•ΩÂèãÂàóË°®Ê∑ªÂä†ÁöÑ‰∫ã‰ª∂
                    // „ÄêÂÖ≥ÈîÆ„Äë‰∏∫‚ÄúÂÆåÊàê‚ÄùÊåâÈíÆÁªëÂÆö‚ÄúÊãâ‰∫∫ÂÖ•Áæ§‚ÄùÁöÑÈÄªËæë
                    const confirmBtn = document.getElementById('confirm-contact-picker-btn');
                    // ‰ΩøÁî®ÂÖãÈöÜËäÇÁÇπÊñπÊ≥ïÊ∏ÖÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆö
                    const newConfirmBtn = confirmBtn.cloneNode(true);
                    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                    newConfirmBtn.addEventListener('click', handleAddMembersToGroup);

                    await openContactPickerForAddMember();
                });

                document.getElementById('create-new-member-btn').addEventListener('click', createNewMemberInGroup);
                // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëËßÜÈ¢ëÈÄöËØùÂäüËÉΩ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº

                // ÁªëÂÆöÂçïËÅäÂíåÁæ§ËÅäÁöÑÂèëËµ∑ÊåâÈíÆ
                document.getElementById('video-call-btn').addEventListener('click', handleInitiateCall);
                document.getElementById('group-video-call-btn').addEventListener('click', handleInitiateCall);

                // ÁªëÂÆö‚ÄúÊåÇÊñ≠‚ÄùÊåâÈíÆ
                document.getElementById('hang-up-btn').addEventListener('click', endVideoCall);

                // ÁªëÂÆö‚ÄúÂèñÊ∂àÂëºÂè´‚ÄùÊåâÈíÆ
                document.getElementById('cancel-call-btn').addEventListener('click', () => {
                    videoCallState.isAwaitingResponse = false;
                    showScreen('chat-interface-screen');
                });

                // „ÄêÂÖ®Êñ∞„ÄëÁªëÂÆö‚ÄúÂä†ÂÖ•ÈÄöËØù‚ÄùÊåâÈíÆ
                document.getElementById('join-call-btn').addEventListener('click', handleUserJoinCall);

                // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤‰øÆÂ§çÂπ∂ÊøÄÊ¥ªÊóÅËßÇÊ®°Âºè„ÄëÁöÑÁâàÊú¨ÊõøÊç¢ÊóßÁöÑ decline-call-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
                // ÁªëÂÆöÊù•ÁîµËØ∑Ê±ÇÁöÑ‚ÄúÊãíÁªù‚ÄùÊåâÈíÆ
                document.getElementById('decline-call-btn').addEventListener('click', async () => {
                    hideIncomingCallModal();
                    const chat = state.chats[videoCallState.activeChatId];
                    if (!chat) return;

                    // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÂú®ËøôÈáåÔºåÊàë‰ª¨Â∞ÜÊãíÁªùÁöÑÈÄªËæë‰∏éAPIË∞ÉÁî®ËøûÊé•Ëµ∑Êù•
                    if (videoCallState.isGroupCall) {
                        videoCallState.isUserParticipating = false; // Ê†áËÆ∞Áî®Êà∑‰∏∫ÊóÅËßÇËÄÖ

                        // 1. ÂàõÂª∫‰∏ÄÊù°ÈöêËóèÊ∂àÊÅØÔºåÈÄöÁü•AIÁî®Êà∑ÊãíÁªù‰∫Ü
                        const systemNote = {
                            role: 'system',
                            content: `[Á≥ªÁªüÊèêÁ§∫ÔºöÁî®Êà∑ÊãíÁªù‰∫ÜÈÄöËØùÈÇÄËØ∑Ôºå‰ΩÜ‰Ω†‰ª¨ÂèØ‰ª•Ëá™Â∑±ÂºÄÂßã„ÄÇËØ∑‰Ω†‰ª¨ÂêÑËá™ÂÜ≥Á≠ñÊòØÂê¶Âä†ÂÖ•„ÄÇ]`,
                            timestamp: Date.now(),
                            isHidden: true
                        };
                        chat.history.push(systemNote);
                        await db.chats.put(chat);

                        // 2. „ÄêÂÖ≥ÈîÆ„ÄëËß¶ÂèëAIÂìçÂ∫îÔºåËÆ©ÂÆÉ‰ª¨Ëá™Â∑±ÂÜ≥ÂÆöË¶Å‰∏çË¶ÅÂºÄÂßãÁæ§ËÅä
                        // ËøôÂ∞Ü‰ºöÂú®ÂêéÂè∞Â§ÑÁêÜÔºåÂ¶ÇÊûúAI‰ª¨ÂÜ≥ÂÆöÂºÄÂßãÔºåÊúÄÁªà‰ºöË∞ÉÁî® startVideoCall()
                        await triggerAiResponse();

                    } else { // ÂçïËÅäÊãíÁªùÈÄªËæë‰øùÊåÅ‰∏çÂèò
                        const declineMessage = { role: 'user', content: 'ÊàëÊãíÁªù‰∫Ü‰Ω†ÁöÑËßÜÈ¢ëÈÄöËØùËØ∑Ê±Ç„ÄÇ', timestamp: Date.now() };
                        chat.history.push(declineMessage);
                        await db.chats.put(chat);

                        // ÂõûÂà∞ËÅäÂ§©ÁïåÈù¢Âπ∂ÊòæÁ§∫ÊãíÁªùÊ∂àÊÅØ
                        showScreen('chat-interface-screen');
                        appendMessage(declineMessage, chat);

                        // ËÆ©AIÂØπ‰Ω†ÁöÑÊãíÁªùÂÅöÂá∫ÂõûÂ∫î
                        triggerAiResponse();
                    }

                    // Ê∏ÖÁêÜÁä∂ÊÄÅÔºå‰ª•Èò≤‰∏á‰∏Ä
                    videoCallState.isAwaitingResponse = false;
                });
                // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº Áî®Ëøô‰∏™„ÄêÂ∑≤‰øÆÂ§çÈáçÂ§çÂ§¥ÂÉèBUG„ÄëÁöÑÁâàÊú¨ÊõøÊç¢ÊóßÁöÑ accept-call-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
                // ÁªëÂÆöÊù•ÁîµËØ∑Ê±ÇÁöÑ‚ÄúÊé•Âê¨‚ÄùÊåâÈíÆ
                document.getElementById('accept-call-btn').addEventListener('click', async () => {
                    hideIncomingCallModal();

                    videoCallState.initiator = 'ai';
                    videoCallState.isUserParticipating = true;
                    videoCallState.activeChatId = state.activeChatId;

                    // „ÄêÊ†∏ÂøÉ‰øÆÊ≠£„ÄëÊàë‰ª¨Âú®ËøôÈáå‰∏çÂÜçÊâãÂä®Ê∑ªÂä†Áî®Êà∑Âà∞ participants ÂàóË°®
                    if (videoCallState.isGroupCall) {
                        // ÂØπ‰∫éÁæ§ËÅäÔºåÊàë‰ª¨Âè™Êää„ÄêÂèëËµ∑ÈÄöËØùÁöÑAI„ÄëÂä†ÂÖ•ÂèÇ‰∏éËÄÖÂàóË°®
                        const chat = state.chats[videoCallState.activeChatId];
                        const requester = chat.members.find(m => m.name === videoCallState.callRequester);
                        if (requester) {
                            // Ê∏ÖÁ©∫ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÊï∞ÊçÆÔºåÁÑ∂ÂêéÂè™Ê∑ªÂä†ÂèëËµ∑ËÄÖ
                            videoCallState.participants = [requester];
                        } else {
                            videoCallState.participants = []; // Â¶ÇÊûúÊâæ‰∏çÂà∞ÂèëËµ∑ËÄÖÔºåÂ∞±Ê∏ÖÁ©∫
                        }
                    }

                    // Êó†ËÆ∫ÂçïËÅäËøòÊòØÁæ§ËÅäÔºåÁõ¥Êé•ÂêØÂä®ÈÄöËØùÁïåÈù¢ÔºÅ
                    startVideoCall();
                });
                // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤


                // ‚ñº‚ñº‚ñº ËØ∑Áî®Ëøô‰∏™„ÄêÂ∑≤Â¢ûÂä†Áî®Êà∑È´ò‰∫Æ„ÄëÁöÑÂÖ®Êñ∞ÁâàÊú¨ÔºåÂÆåÊï¥ÊõøÊç¢ÊóßÁöÑ user-speak-btn ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
                // ÁªëÂÆöÁî®Êà∑Âú®ÈÄöËØù‰∏≠ÂèëË®ÄÁöÑÊåâÈíÆ
                document.getElementById('user-speak-btn').addEventListener('click', async () => {
                    if (!videoCallState.isActive) return;

                    // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉÊñ∞Â¢ûÔºöÂú®ÂºπÂá∫ËæìÂÖ•Ê°ÜÂâçÔºåÂÖàÊâæÂà∞Âπ∂È´ò‰∫ÆÁî®Êà∑Â§¥ÂÉè ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                    const userAvatar = document.querySelector('.participant-avatar-wrapper[data-participant-id="user"] .participant-avatar');
                    if (userAvatar) {
                        userAvatar.classList.add('speaking');
                    }

                    const userInput = await showCustomPrompt('‰Ω†ËØ¥', 'ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑËØù...');

                    // ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ Ê†∏ÂøÉÊñ∞Â¢ûÔºöÊó†ËÆ∫Áî®Êà∑ÊòØÂê¶ËæìÂÖ•ÔºåÂè™Ë¶ÅÂÖ≥Èó≠ËæìÂÖ•Ê°ÜÂ∞±ÁßªÈô§È´ò‰∫Æ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                    if (userAvatar) {
                        userAvatar.classList.remove('speaking');
                    }

                    if (userInput && userInput.trim()) {
                        triggerAiInCallAction(userInput.trim());
                    }
                });
                // ‚ñ≤‚ñ≤‚ñ≤ ÊõøÊç¢ÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº „ÄêÊñ∞Â¢û„ÄëÂõûÂøÜÂΩïÁõ∏ÂÖ≥‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº
                // 1. Â∞Ü‚ÄúÂõûÂøÜ‚ÄùÈ°µÁ≠æÂíåÂÆÉÁöÑËßÜÂõæËøûÊé•Ëµ∑Êù•
                document.querySelector('.nav-item[data-view="memories-view"]').addEventListener('click', () => {
                    // Âú®ÂàáÊç¢ÂâçÔºåÁ°Æ‰øù"Êî∂Ëóè"È°µÈù¢ÁöÑÁºñËæëÊ®°ÂºèÂ∑≤ÂÖ≥Èó≠
                    if (isFavoritesSelectionMode) {
                        document.getElementById('favorites-edit-btn').click();
                    }
                    switchToChatListView('memories-view');
                    renderMemoriesScreen(); // ÁÇπÂáªÊó∂Ê∏≤Êüì
                });

                // 2. ÁªëÂÆöÂõûÂøÜÂΩïÁïåÈù¢ÁöÑËøîÂõûÊåâÈíÆ
                document.getElementById('memories-back-btn').addEventListener('click', () => switchToChatListView('messages-view'));

                // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢ûÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // „ÄêÂÖ®Êñ∞„ÄëÁ∫¶ÂÆö/ÂÄíËÆ°Êó∂ÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö - ‰øÆÊîπ‰∏∫ÈÄâÊã©Ê®°ÊÄÅÊ°Ü
                document.getElementById('add-countdown-btn').addEventListener('click', () => {
                    document.getElementById('add-memory-type-modal').classList.add('visible');
                });
                document.getElementById('cancel-create-countdown-btn').addEventListener('click', () => {
                    document.getElementById('create-countdown-modal').classList.remove('visible');
                });
                document.getElementById('confirm-create-countdown-btn').addEventListener('click', async () => {
                    const title = document.getElementById('countdown-title-input').value.trim();
                    const dateValue = document.getElementById('countdown-date-input').value;

                    if (!title || !dateValue) {
                        alert('ËØ∑Â°´ÂÜôÂÆåÊï¥ÁöÑÁ∫¶ÂÆöÊ†áÈ¢òÂíåÊó•ÊúüÔºÅ');
                        return;
                    }

                    const targetDate = new Date(dateValue);
                    if (isNaN(targetDate)) {
                        alert('ËØ∑ËæìÂÖ•‰∏Ä‰∏™ÊúâÊïàÁöÑÊó•ÊúüÔºÅ');
                        return;
                    }

                    if (editingMemoryId) {
                        // Edit mode - update existing memory
                        const memory = await db.memories.get(editingMemoryId);
                        if (memory) {
                            memory.description = title;
                            memory.targetDate = targetDate.getTime();
                            await db.memories.put(memory);
                        }
                        editingMemoryId = null;
                        // Reset modal title
                        document.querySelector('#create-countdown-modal .modal-header span').textContent = 'Êñ∞Âª∫Á∫¶ÂÆö';
                    } else {
                        // Create mode - add new memory
                        const newCountdown = {
                            chatId: null, // Áî®Êà∑ÂàõÂª∫ÁöÑÔºå‰∏çÂ±û‰∫é‰ªª‰ΩïÁâπÂÆöAI
                            authorName: 'Êàë',
                            description: title,
                            timestamp: Date.now(),
                            type: 'countdown',
                            targetDate: targetDate.getTime()
                        };
                        await db.memories.add(newCountdown);
                    }

                    document.getElementById('create-countdown-modal').classList.remove('visible');
                    renderMemoriesScreen();
                    renderCalendarScreen();
                });

                // „ÄêÂÖ®Êñ∞„ÄëÊ∑ªÂä†Á±ªÂûãÈÄâÊã©Ê®°ÊÄÅÊ°Ü‰∫ã‰ª∂ÁªëÂÆö
                document.getElementById('cancel-add-type-btn').addEventListener('click', () => {
                    document.getElementById('add-memory-type-modal').classList.remove('visible');
                });

                // AI Memory Functions
                function showAiMemoryModal() {
                    // Get all available AIs
                    const availableAis = [];
                    
                    // Add individual chats (non-group)
                    Object.values(state.chats).forEach(chat => {
                        if (!chat.isGroup) {
                            availableAis.push({
                                id: chat.id,
                                name: chat.name,
                                avatar: chat.settings.aiAvatar || defaultAvatar
                            });
                        }
                    });
                    
                    // Generate AI selection list HTML
                    let aiListHtml = '';
                    availableAis.forEach(ai => {
                        aiListHtml += `
                            <div style="display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee;">
                                <input type="radio" name="ai-memory-selection" value="${ai.id}" id="ai-memory-${ai.id}" style="margin-right: 10px;">
                                <img src="${ai.avatar}" style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px;">
                                <label for="ai-memory-${ai.id}" style="flex-grow: 1; cursor: pointer;">${ai.name}</label>
                            </div>
                        `;
                    });
                    
                    document.getElementById('ai-memory-selection-list').innerHTML = aiListHtml;
                    document.getElementById('ai-memory-modal').classList.add('visible');
                }
                
                function hideAiMemoryModal() {
                    document.getElementById('ai-memory-modal').classList.remove('visible');
                }
                
                async function confirmAiMemory() {
                    // Check for selected radio button
                    const selectedRadio = document.querySelector('input[name="ai-memory-selection"]:checked');
                    
                    if (!selectedRadio) {
                        alert('ËØ∑ÈÄâÊã©‰∏Ä‰∏™AI');
                        return;
                    }
                    
                    const selectedAiId = selectedRadio.value;
                    const selectedChat = state.chats[selectedAiId];
                    
                    if (!selectedChat) {
                        alert('ÈÄâÊã©ÁöÑAI‰∏çÂ≠òÂú®');
                        return;
                    }
                    
                    hideAiMemoryModal();
                    
                    // Show processing message
                    const processingMsg = document.createElement('div');
                    processingMsg.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 10px; z-index: 9999; text-align: center;';
                    processingMsg.innerHTML = `<div>ü§ñ AIÊ≠£Âú®ÊÄùËÄÉË¶ÅËÆ∞ÂΩï‰ªÄ‰πàÂõûÂøÜ...</div>`;
                    document.body.appendChild(processingMsg);
                    
                    try {
                        // Set flags for forced memory creation
                        window.forceMemoryCreation = true;
                        window.forceMemoryTargetChatId = selectedAiId;
                        
                        // Set active chat to the selected AI
                        const previousActiveChatId = state.activeChatId;
                        state.activeChatId = selectedAiId;
                        
                        // Trigger AI response with forced memory creation
                        await triggerAiResponse(true);
                        
                        // Restore previous active chat
                        state.activeChatId = previousActiveChatId;
                        
                        // Remove processing message
                        if (processingMsg.parentNode) {
                            document.body.removeChild(processingMsg);
                        }
                        
                        // Show completion notification
                        const completionMsg = document.createElement('div');
                        completionMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: rgba(0,128,0,0.9); color: white; padding: 15px 20px; border-radius: 10px; z-index: 9999; font-size: 14px;';
                        completionMsg.innerHTML = '‚úÖ AIÂõûÂøÜÂàõÂª∫ÂÆåÊàê';
                        document.body.appendChild(completionMsg);
                        
                        // Auto-remove notification after 3 seconds
                        setTimeout(() => {
                            if (completionMsg.parentNode) {
                                document.body.removeChild(completionMsg);
                            }
                        }, 3000);
                        
                    } catch (error) {
                        console.error('AI memory creation error:', error);
                        
                        // Remove processing message
                        if (processingMsg.parentNode) {
                            document.body.removeChild(processingMsg);
                        }
                        
                        // Show error notification
                        const errorMsg = document.createElement('div');
                        errorMsg.style.cssText = 'position: fixed; top: 20px; right: 20px; background: rgba(255,0,0,0.9); color: white; padding: 15px 20px; border-radius: 10px; z-index: 9999; font-size: 14px;';
                        errorMsg.innerHTML = '‚ùå AIÂõûÂøÜÂàõÂª∫Â§±Ë¥•';
                        document.body.appendChild(errorMsg);
                        
                        setTimeout(() => {
                            if (errorMsg.parentNode) {
                                document.body.removeChild(errorMsg);
                            }
                        }, 3000);
                    }
                }

                document.getElementById('add-memory-btn').addEventListener('click', () => {
                    document.getElementById('add-memory-type-modal').classList.remove('visible');
                    document.getElementById('create-memory-modal').classList.add('visible');
                    // ËÆæÁΩÆÈªòËÆ§Êó∂Èó¥‰∏∫ÂΩìÂâçÊó∂Èó¥
                    const now = new Date();
                    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
                    document.getElementById('memory-date-input').value = localDateTime;
                });

                document.getElementById('add-event-btn').addEventListener('click', () => {
                    document.getElementById('add-memory-type-modal').classList.remove('visible');
                    document.getElementById('create-countdown-modal').classList.add('visible');
                });

                document.getElementById('add-ai-memory-btn').addEventListener('click', () => {
                    document.getElementById('add-memory-type-modal').classList.remove('visible');
                    showAiMemoryModal();
                });

                // „ÄêÂÖ®Êñ∞„ÄëÊ∑ªÂä†ÂõûÂøÜÊ®°ÊÄÅÊ°Ü‰∫ã‰ª∂ÁªëÂÆö
                document.getElementById('cancel-create-memory-btn').addEventListener('click', () => {
                    document.getElementById('create-memory-modal').classList.remove('visible');
                });

                document.getElementById('confirm-create-memory-btn').addEventListener('click', async () => {
                    const description = document.getElementById('memory-description-input').value.trim();
                    const dateTime = document.getElementById('memory-date-input').value;

                    if (!description) {
                        alert('ËØ∑ËæìÂÖ•ÂõûÂøÜÂÜÖÂÆπ');
                        return;
                    }

                    if (!dateTime) {
                        alert('ËØ∑ÈÄâÊã©ÂõûÂøÜÊó•Êúü');
                        return;
                    }

                    const memoryDate = new Date(dateTime);

                    if (editingMemoryId) {
                        // Edit mode - update existing memory
                        const memory = await db.memories.get(editingMemoryId);
                        if (memory) {
                            memory.description = description;
                            memory.timestamp = memoryDate.getTime();
                            await db.memories.put(memory);
                        }
                        editingMemoryId = null;
                        // Reset modal title
                        document.querySelector('#create-memory-modal .modal-header span').textContent = 'Êñ∞Âª∫ÂõûÂøÜ';
                    } else {
                        // Create mode - add new memory
                        const newMemory = {
                            chatId: 'manual', // ÊâãÂä®Ê∑ªÂä†ÁöÑÂõûÂøÜ
                            authorName: 'Êàë', // Áî®Êà∑Ê∑ªÂä†ÁöÑÂõûÂøÜ
                            description: description,
                            timestamp: memoryDate.getTime(),
                            type: 'ai_generated' // ‰ΩøÁî®Áõ∏ÂêåÁ±ªÂûã‰ª•Âú®Êó•ÂéÜ‰∏≠ÊòæÁ§∫
                        };
                        await db.memories.add(newMemory);
                    }

                    document.getElementById('create-memory-modal').classList.remove('visible');

                    // Ê∏ÖÁ©∫Ë°®Âçï
                    document.getElementById('memory-description-input').value = '';
                    document.getElementById('memory-date-input').value = '';

                    renderMemoriesScreen();
                    renderCalendarScreen();
                });

                // „ÄêÂÖ®Êñ∞„ÄëÊãâÈªëÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö
                document.getElementById('block-chat-btn').addEventListener('click', async () => {
                    if (!state.activeChatId || state.chats[state.activeChatId].isGroup) return;

                    const chat = state.chats[state.activeChatId];
                    const confirmed = await showCustomConfirm(
                        'Á°ÆËÆ§ÊãâÈªë',
                        `Á°ÆÂÆöË¶ÅÊãâÈªë‚Äú${chat.name}‚ÄùÂêóÔºüÊãâÈªëÂêéÊÇ®Â∞ÜÊó†Ê≥ïÂêëÂÖ∂ÂèëÈÄÅÊ∂àÊÅØÔºåÁõ¥Âà∞ÊÇ®Â∞ÜTaÁßªÂá∫ÈªëÂêçÂçïÔºåÊàñÁ≠âÂæÖTaÈáçÊñ∞Áî≥ËØ∑Â•ΩÂèã„ÄÇ`,
                        { confirmButtonClass: 'btn-danger' }
                    );

                    if (confirmed) {
                        chat.relationship.status = 'blocked_by_user';
                        chat.relationship.blockedTimestamp = Date.now();
                        await db.chats.put(chat);

                        // ÂÖ≥Èó≠ËÆæÁΩÆÂºπÁ™óÔºåÂπ∂Âà∑Êñ∞ËÅäÂ§©ÁïåÈù¢
                        document.getElementById('chat-settings-modal').classList.remove('visible');
                        renderChatInterface(state.activeChatId);
                        // Âà∑Êñ∞ËÅäÂ§©ÂàóË°®ÔºåÂèØËÉΩ‰ºöÊúâUIÂèòÂåñ
                        renderChatList();
                    }
                });

                document.getElementById('chat-lock-overlay').addEventListener('click', async (e) => {
                    const chat = state.chats[state.activeChatId];
                    if (!chat) return;

                    if (e.target.id === 'force-apply-check-btn') {
                        alert("Ê≠£Âú®ÊâãÂä®Ëß¶ÂèëÂ•ΩÂèãÁî≥ËØ∑ÊµÅÁ®ãÔºåËØ∑Á®çÂêé...\nÂ¶ÇÊûúAPIË∞ÉÁî®ÊàêÂäüÔºåÂ∞ÜÂºπÂá∫ÊèêÁ§∫„ÄÇÂ¶ÇÊûúÂ§±Ë¥•Ôºå‰πü‰ºöÊúâÈîôËØØÊèêÁ§∫„ÄÇÂ¶ÇÊûúÈïøÊó∂Èó¥Êó†ÂèçÂ∫îÔºåËØ¥ÊòéAIÂèØËÉΩÂÜ≥ÂÆöÊöÇÊó∂‰∏çÁî≥ËØ∑„ÄÇ");
                        await triggerAiFriendApplication(chat.id);
                        renderChatInterface(chat.id);
                        return;
                    }

                    if (e.target.id === 'unblock-btn') {
                        chat.relationship.status = 'friend';
                        chat.relationship.blockedTimestamp = null;
                        await db.chats.put(chat);
                        renderChatInterface(chat.id);
                        renderChatList();
                    }
                    else if (e.target.id === 'accept-friend-btn') {
                        chat.relationship.status = 'friend';
                        chat.relationship.applicationReason = '';
                        await db.chats.put(chat);
                        renderChatInterface(chat.id);
                        renderChatList();
                        const msg = { role: 'user', content: 'ÊàëÈÄöËøá‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãËØ∑Ê±Ç', timestamp: Date.now() };
                        chat.history.push(msg);
                        await db.chats.put(chat);
                        appendMessage(msg, chat);
                        triggerAiResponse();
                    }
                    else if (e.target.id === 'reject-friend-btn') {
                        chat.relationship.status = 'blocked_by_user';
                        chat.relationship.blockedTimestamp = Date.now();
                        chat.relationship.applicationReason = '';
                        await db.chats.put(chat);
                        renderChatInterface(chat.id);
                    }
                    // „ÄêÊñ∞Â¢û„ÄëÂ§ÑÁêÜÁî≥ËØ∑Â•ΩÂèãÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
                    else if (e.target.id === 'apply-friend-btn') {
                        const reason = await showCustomPrompt(
                            'ÂèëÈÄÅÂ•ΩÂèãÁî≥ËØ∑',
                            `ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ÂØπ‚Äú${chat.name}‚ÄùËØ¥ÁöÑÁî≥ËØ∑ÁêÜÁî±Ôºö`,
                            "Êàë‰ª¨ÂíåÂ•ΩÂêßÔºÅ"
                        );
                        // Âè™ÊúâÂΩìÁî®Êà∑ËæìÂÖ•‰∫ÜÂÜÖÂÆπÂπ∂ÁÇπÂáª‚ÄúÁ°ÆÂÆö‚ÄùÂêéÊâçÁªßÁª≠
                        if (reason !== null) {
                            // Êõ¥Êñ∞ÂÖ≥Á≥ªÁä∂ÊÄÅ‰∏∫‚ÄúÁ≠âÂæÖAIÊâπÂáÜ‚Äù
                            chat.relationship.status = 'pending_ai_approval';
                            chat.relationship.applicationReason = reason;
                            await db.chats.put(chat);

                            // Âà∑Êñ∞UIÔºåÊòæÁ§∫‚ÄúÁ≠âÂæÖÈÄöËøá‚ÄùÁöÑÁïåÈù¢
                            renderChatInterface(chat.id);
                            renderChatList();

                            // „ÄêÂÖ≥ÈîÆ„ÄëËß¶ÂèëAIÂìçÂ∫îÔºåËÆ©ÂÆÉÂéªÂ§ÑÁêÜËøô‰∏™Â•ΩÂèãÁî≥ËØ∑
                            triggerAiResponse();
                        }
                    }
                });

                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÁ∫¢ÂåÖÂäüËÉΩ‰∫ã‰ª∂ÁªëÂÆö ‚ñº‚ñº‚ñº

                // 1. Â∞ÜÂéüÊúâÁöÑËΩ¨Ë¥¶ÊåâÈíÆ(Ôø•)ÁöÑÁÇπÂáª‰∫ã‰ª∂ÔºåÈáçÂÆöÂêëÂà∞Êñ∞ÁöÑÊÄªÂÖ•Âè£ÂáΩÊï∞
                document.getElementById('transfer-btn').addEventListener('click', handlePaymentButtonClick);

                // 2. Á∫¢ÂåÖÊ®°ÊÄÅÊ°ÜÂÜÖÈÉ®ÁöÑÊéßÂà∂ÊåâÈíÆ
                document.getElementById('cancel-red-packet-btn').addEventListener('click', () => {
                    document.getElementById('red-packet-modal').classList.remove('visible');
                });
                document.getElementById('send-group-packet-btn').addEventListener('click', sendGroupRedPacket);
                document.getElementById('send-direct-packet-btn').addEventListener('click', sendDirectRedPacket);

                // 3. Á∫¢ÂåÖÊ®°ÊÄÅÊ°ÜÁöÑÈ°µÁ≠æÂàáÊç¢ÈÄªËæë
                const rpTabGroup = document.getElementById('rp-tab-group');
                const rpTabDirect = document.getElementById('rp-tab-direct');
                const rpContentGroup = document.getElementById('rp-content-group');
                const rpContentDirect = document.getElementById('rp-content-direct');

                rpTabGroup.addEventListener('click', () => {
                    rpTabGroup.classList.add('active');
                    rpTabDirect.classList.remove('active');
                    rpContentGroup.style.display = 'block';
                    rpContentDirect.style.display = 'none';
                });
                rpTabDirect.addEventListener('click', () => {
                    rpTabDirect.classList.add('active');
                    rpTabGroup.classList.remove('active');
                    rpContentDirect.style.display = 'block';
                    rpContentGroup.style.display = 'none';
                });

                // 4. ÂÆûÊó∂Êõ¥Êñ∞Á∫¢ÂåÖÈáëÈ¢ùÊòæÁ§∫
                document.getElementById('rp-group-amount').addEventListener('input', (e) => {
                    const amount = parseFloat(e.target.value) || 0;
                    document.getElementById('rp-group-total').textContent = `¬• ${amount.toFixed(2)}`;
                });
                document.getElementById('rp-direct-amount').addEventListener('input', (e) => {
                    const amount = parseFloat(e.target.value) || 0;
                    document.getElementById('rp-direct-total').textContent = `¬• ${amount.toFixed(2)}`;
                });

                // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞‰∫ã‰ª∂ÁªëÂÆöÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞Ê∑ªÂä†„Äë‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÁ∫¢ÂåÖÁÇπÂáªÔºå‰øÆÂ§çÂ§±ÊïàÈóÆÈ¢ò ‚ñº‚ñº‚ñº
                document.getElementById('chat-messages').addEventListener('click', (e) => {
                    // 1. ÊâæÂà∞Ë¢´ÁÇπÂáªÁöÑÁ∫¢ÂåÖÂç°Áâá
                    const packetCard = e.target.closest('.red-packet-card');
                    if (!packetCard) return; // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØÁ∫¢ÂåÖÔºåÂ∞±‰ªÄ‰πà‰πü‰∏çÂÅö

                    // 2. ‰ªéÁ∫¢ÂåÖÂç°ÁâáÁöÑÁà∂Á∫ß.message-bubbleËé∑ÂèñÊó∂Èó¥Êà≥
                    const messageBubble = packetCard.closest('.message-bubble');
                    if (!messageBubble || !messageBubble.dataset.timestamp) return;

                    // 3. Ë∞ÉÁî®Êàë‰ª¨Áé∞ÊúâÁöÑÂ§ÑÁêÜÂáΩÊï∞
                    const timestamp = parseInt(messageBubble.dataset.timestamp);
                    handlePacketClick(timestamp);
                });
                // ‚ñ≤‚ñ≤‚ñ≤ Êñ∞Â¢û‰ª£Á†ÅÁªìÊùü ‚ñ≤‚ñ≤‚ñ≤

                // ‚ñº‚ñº‚ñº „ÄêÂÖ®Êñ∞„ÄëÊäïÁ•®ÂäüËÉΩ‰∫ã‰ª∂ÁõëÂê¨Âô® ‚ñº‚ñº‚ñº
                // Âú®ËæìÂÖ•Ê°ÜÂ∑•ÂÖ∑Ê†èÊ∑ªÂä†ÊåâÈíÆ
                document.getElementById('send-poll-btn').addEventListener('click', openCreatePollModal);

                // ÊäïÁ•®ÂàõÂª∫Ê®°ÊÄÅÊ°ÜÁöÑÊåâÈíÆ
                document.getElementById('add-poll-option-btn').addEventListener('click', addPollOptionInput);
                document.getElementById('cancel-create-poll-btn').addEventListener('click', () => {
                    document.getElementById('create-poll-modal').classList.remove('visible');
                });
                document.getElementById('confirm-create-poll-btn').addEventListener('click', sendPoll);

                // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÊäïÁ•®Âç°ÁâáÂÜÖÁöÑÊâÄÊúâÁÇπÂáª‰∫ã‰ª∂
                document.getElementById('chat-messages').addEventListener('click', (e) => {
                    const pollCard = e.target.closest('.poll-card');
                    if (!pollCard) return;

                    const timestamp = parseInt(pollCard.dataset.pollTimestamp);
                    if (isNaN(timestamp)) return;

                    // ÁÇπÂáª‰∫ÜÈÄâÈ°π
                    const optionItem = e.target.closest('.poll-option-item');
                    if (optionItem && !pollCard.classList.contains('closed')) {
                        handleUserVote(timestamp, optionItem.dataset.option);
                        return;
                    }

                    // ÁÇπÂáª‰∫ÜÂä®‰ΩúÊåâÈíÆÔºàÁªìÊùüÊäïÁ•®/Êü•ÁúãÁªìÊûúÔºâ
                    const actionBtn = e.target.closest('.poll-action-btn');
                    if (actionBtn) {
                        if (pollCard.classList.contains('closed')) {
                            showPollResults(timestamp);
                        } else {
                            endPoll(timestamp);
                        }
                        return;
                    }

                    // Â¶ÇÊûúÊòØÂ∑≤ÁªìÊùüÁöÑÊäïÁ•®ÔºåÁÇπÂáªÂç°Áâá‰ªª‰ΩïÂú∞ÊñπÈÉΩÂèØ‰ª•Êü•ÁúãÁªìÊûú
                    if (pollCard.classList.contains('closed')) {
                        showPollResults(timestamp);
                    }
                });
            }


            function openChat(chatId) {
                state.activeChatId = chatId;
                const chat = state.chats[chatId];
                if (!chat) return;
                if (chat.status === 'unread') {
                    chat.status = 'read';
                    db.chats.put(chat);
                }
                renderChatInterface(chatId);
                showScreen('chat-interface-screen');
                window.updateListenTogetherIconProxy(state.activeChatId);
                toggleCallButtons(chat.isGroup || false);
                // „ÄêÊ†∏ÂøÉÊñ∞Â¢û„ÄëÊâìÂºÄËÅäÂ§©Êó∂ÔºåÁ´ãÂç≥Êõ¥Êñ∞Áä∂ÊÄÅÂπ∂ÂêØÂä®ËÆ°Êó∂Âô®
                updateChatHeaderStatus(chat);
                manageInactivityTimer(chat);
                if (!chat.isGroup && chat.relationship?.status === 'pending_ai_approval') {
                    console.log(`Ê£ÄÊµãÂà∞Â•ΩÂèãÁî≥ËØ∑ÂæÖÂ§ÑÁêÜÁä∂ÊÄÅÔºå‰∏∫ËßíËâ≤ "${chat.name}" Ëá™Âä®Ëß¶ÂèëAIÂìçÂ∫î...`);
                    triggerAiResponse();
                }

                document.getElementById('send-poll-btn').style.display = chat.isGroup ? 'flex' : 'none';
                document.getElementById('open-bulletin-board-btn').style.display = chat.isGroup ? 'flex' : 'none';

            }
            // ==========================================================
            // --- ‰∫ëÁ´ØÂ§á‰ªΩ‰∏éÊÅ¢Â§ç (V2 - ÁâàÊú¨ÈÄâÊã©) ---
            // ==========================================================

            /**
             * „ÄêV2Áâà„ÄëÂ§á‰ªΩÊï∞ÊçÆÂà∞ÊúçÂä°Âô®ÔºåÂπ∂Ê†áËÆ∞Â§á‰ªΩÁ±ªÂûã
             * @param {('manual'|'auto')} backupType - Â§á‰ªΩÁöÑÁ±ªÂûã
             * @param {boolean} showAlert - ÊòØÂê¶ÊòæÁ§∫ÊàêÂäü/Â§±Ë¥•ÂºπÁ™ó
             */
            async function backupDataToServer(backupType = 'auto', showAlert = false) {
                console.log(`[‰∫ëÂêåÊ≠•V2] ÂºÄÂßãÂ§á‰ªΩÔºåÁ±ªÂûã: ${backupType}`);
                try {
                    const tablesToBackup = [
                        'chats', 'apiConfig', 'globalSettings', 'userStickers',
                        'worldBooks', 'musicLibrary', 'personaPresets',
                        'qzoneSettings', 'qzonePosts', 'qzoneAlbums', 'qzonePhotos',
                        'favorites', 'qzoneGroups', 'memories'
                    ];
                    const data = {};
                    const existingTables = tablesToBackup.filter(tableName => db.table(tableName));

                    await db.transaction('r', existingTables, async () => {
                        for (const table of existingTables) {
                            const tableData = await db.table(table).toArray();
                            if (tableData) {
                                data[table] = tableData;
                            }
                        }
                    });

                    // Â¢ûÂä†‰∏Ä‰∏™ËÆæÂ§áIDÂÖÉÊï∞ÊçÆ
                    let deviceId = localStorage.getItem('ephone-device-id');
                    if (!deviceId) {
                        deviceId = `device_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`;
                        localStorage.setItem('ephone-device-id', deviceId);
                    }

                    const backupPayload = {
                        metadata: {
                            timestamp: Date.now(),
                            sourceDeviceId: deviceId,
                            type: backupType
                        },
                        data: data
                    };

                    const response = await fetch(`/api/data?type=${backupType}`, { // Âú®URL‰∏≠‰º†ÈÄíÁ±ªÂûã
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(backupPayload)
                    });

                    if (!response.ok) {
                        throw new Error(`ÊúçÂä°Âô®ËøîÂõûÈîôËØØ: ${response.status} ${response.statusText}`);
                    }

                    console.log(`[‰∫ëÂêåÊ≠•V2] ${backupType} Â§á‰ªΩÊàêÂäü!`);
                    if (showAlert) {
                        showCustomAlert('‚òÅÔ∏è ÊâãÂä®Â§á‰ªΩÊàêÂäü', 'ÊÇ®ÁöÑÊï∞ÊçÆÂ∑≤ÂÆâÂÖ®‰øùÂ≠òÂà∞‰∫ëÁ´Ø„ÄÇ');
                    }
                } catch (err) {
                    console.error(`[‰∫ëÂêåÊ≠•V2] ${backupType} Â§á‰ªΩÂ§±Ë¥•:`, err);
                    if (showAlert) {
                        showCustomAlert('‚ùå ‰∫ëÁ´ØÂ§á‰ªΩÂ§±Ë¥•', err.message || 'Êú™Áü•ÈîôËØØ');
                    }
                }
            }

            /**
             * „ÄêV2Áâà„Äë‰ªéÊúçÂä°Âô®ÊÅ¢Â§çÊåáÂÆöÁöÑÂ§á‰ªΩÁâàÊú¨
             * @param {('manual'|'auto')} backupType - Ë¶ÅÊÅ¢Â§çÁöÑÂ§á‰ªΩÁ±ªÂûã
             */
            async function restoreDataFromServer(backupType) {
                try {
                    const confirmed = await showCustomConfirm(
                        '‰∏•ÈáçË≠¶ÂëäÔºÅ',
                        `Âç≥Â∞Ü‰ªé‰∫ëÁ´ØÊÅ¢Â§ç„Äê${backupType === 'manual' ? 'ÊâãÂä®' : 'Ëá™Âä®'}„ÄëÂ§á‰ªΩ„ÄÇ<br><br>Ê≠§Êìç‰ΩúÂ∞ÜÂÆåÂÖ®Ë¶ÜÁõñÊÇ®ÂΩìÂâçËÆæÂ§á‰∏äÁöÑÊâÄÊúâÊï∞ÊçÆÔºå‰∏î‰∏çÂèØÊí§ÈîÄÔºÅ`,
                        { confirmButtonClass: 'btn-danger' }
                    );
                    if (!confirmed) return;

                    const res = await fetch(`/api/data?type=${backupType}`); // ‰ªéÊåáÂÆöURLËé∑Âèñ
                    if (!res.ok) {
                        if (res.status === 404) {
                            showCustomAlert('ÊÅ¢Â§çÂ§±Ë¥•', `Êú™Âú®‰∫ëÁ´ØÊâæÂà∞„Äê${backupType === 'manual' ? 'ÊâãÂä®' : 'Ëá™Âä®'}„ÄëÂ§á‰ªΩÊñá‰ª∂„ÄÇ`);
                            return;
                        }
                        throw new Error(`ÊúçÂä°Âô®ÂìçÂ∫îÈîôËØØ: ${res.status} ${res.statusText}`);
                    }

                    const backupPayload = await res.json();
                    const data = backupPayload.data;

                    if (!data || typeof data !== 'object' || Object.keys(data).length === 0) {
                        showCustomAlert('ÊÅ¢Â§ç‰∏≠Ê≠¢', '‰∫ëÁ´ØÂ§á‰ªΩÊï∞ÊçÆ‰∏∫Á©∫ÊàñÊ†ºÂºè‰∏çÊ≠£Á°Æ„ÄÇ');
                        return;
                    }

                    const tablesToRestore = Object.keys(data);
                    const existingTables = tablesToRestore.filter(tableName => db.table(tableName));

                    await db.transaction('rw', existingTables, async () => {
                        for (const table of existingTables) {
                            await db.table(table).clear();
                            if (data[table] && Array.isArray(data[table])) {
                                await db.table(table).bulkPut(data[table]);
                            }
                        }
                    });

                    await showCustomAlert('‚òÅÔ∏è ‰∫ëÁ´ØÊÅ¢Â§çÊàêÂäü', 'Êï∞ÊçÆÂ∑≤‰ªéÊúçÂä°Âô®ËøòÂéüÔºåÂ∫îÁî®Âç≥Â∞ÜÂà∑Êñ∞„ÄÇ');
                    setTimeout(() => location.reload(), 1500);
                } catch (err) {
                    console.error(`[‰∫ëÂêåÊ≠•V2] ÊÅ¢Â§ç ${backupType} Â§á‰ªΩÂ§±Ë¥•:`, err);
                    showCustomAlert('‚ùå ‰∫ëÁ´ØÊÅ¢Â§çÂ§±Ë¥•', err.message || 'Êú™Áü•ÈîôËØØ');
                }
            }


            /**
             * „ÄêÂÖ®Êñ∞„ÄëÊâìÂºÄÂπ∂Ê∏≤ÊüìÂ§á‰ªΩÁâàÊú¨ÈÄâÊã©Ê®°ÊÄÅÊ°Ü
             */
            async function openRestoreVersionSelector() {
                const modal = document.getElementById('restore-version-modal');
                const listEl = document.getElementById('restore-version-list');

                modal.classList.add('visible');
                listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">Ê≠£Âú®‰ªé‰∫ëÁ´ØËé∑ÂèñÂ§á‰ªΩ‰ø°ÊÅØ...</p>';

                try {
                    const response = await fetch('/api/data/list');
                    if (!response.ok) {
                        throw new Error(`Ëé∑ÂèñÂ§á‰ªΩÂàóË°®Â§±Ë¥•: ${response.status}`);
                    }
                    const versions = await response.json();
                    listEl.innerHTML = ''; // Ê∏ÖÁ©∫Âä†ËΩΩÊèêÁ§∫

                    const createCard = (type, info) => {
                        const card = document.createElement('div');
                        card.className = 'list-item'; // Â§çÁî®Áé∞ÊúâÁöÑÂàóË°®È°πÊ†∑Âºè
                        card.style.cursor = 'pointer';

                        const typeText = type === 'manual' ? 'ÊâãÂä®Â§á‰ªΩ' : 'Ëá™Âä®Â§á‰ªΩ';
                        const date = new Date(info.timestamp);
                        const dateString = date.toLocaleString('zh-CN', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit'
                        });
                        const sizeString = (info.size / 1024).toFixed(1) + ' KB';
                        const deviceId = info.sourceDeviceId ? info.sourceDeviceId.substring(0, 15) + '...' : 'Êú™Áü•ËÆæÂ§á';

                        card.innerHTML = `
                <div class="item-title" style="display:flex; justify-content:space-between;">
                    <span>‚òÅÔ∏è ${typeText}</span>
                    <span style="font-weight:normal; font-size:14px; color:var(--text-secondary);">${sizeString}</span>
                </div>
                <div class="item-content">
                    Â§á‰ªΩ‰∫é ${dateString}<br>
                    Êù•Ëá™ËÆæÂ§á: ${deviceId}
                </div>
            `;
                        card.addEventListener('click', () => {
                            modal.classList.remove('visible');
                            restoreDataFromServer(type);
                        });
                        return card;
                    };

                    if (versions.manual && versions.manual.timestamp) {
                        listEl.appendChild(createCard('manual', versions.manual));
                    }
                    if (versions.auto && versions.auto.timestamp) {
                        listEl.appendChild(createCard('auto', versions.auto));
                    }

                    if ((!versions.manual || !versions.manual.timestamp) && (!versions.auto || !versions.auto.timestamp)) {
                        listEl.innerHTML = '<p style="text-align:center; color: var(--text-secondary);">‰∫ëÁ´ØÊ≤°Êúâ‰ªª‰ΩïÂ§á‰ªΩÊñá‰ª∂„ÄÇ</p>';
                    }

                } catch (err) {
                    listEl.innerHTML = `<p style="text-align:center; color: #ff3b30;">Ëé∑ÂèñÂ§á‰ªΩ‰ø°ÊÅØÂ§±Ë¥•: ${err.message}</p>`;
                }
            }


            /**
             * Êô∫ËÉΩËäÇÊµÅÂ§á‰ªΩÔºà15ÁßíÊó†Êìç‰ΩúÂêéËá™Âä®‰øùÂ≠òÔºâ
             */
            let backupTimer = null;
            function markForBackup() {
                if (backupTimer) clearTimeout(backupTimer);
                backupTimer = setTimeout(() => {
                    // Ëá™Âä®Â§á‰ªΩÊÄªÊòØË∞ÉÁî® 'auto' Á±ªÂûã
                    backupDataToServer('auto', false)
                        .catch(e => console.warn('[‰∫ëÂêåÊ≠•V2] Ëá™Âä®Â§á‰ªΩÂ§±Ë¥•:', e));
                }, 15000);
            }

            // --- ‰∫ã‰ª∂ÁªëÂÆö ---
            // ÊâãÂä®Â§á‰ªΩÊåâÈíÆ
            document.getElementById('cloud-backup-manual-btn').addEventListener('click', () => backupDataToServer('manual', true));

            // ‰ªé‰∫ëÁ´ØÊÅ¢Â§çÊåâÈíÆÔºàÊâìÂºÄÈÄâÊã©Âô®Ôºâ
            document.getElementById('cloud-restore-select-btn').addEventListener('click', openRestoreVersionSelector);

            // Â§á‰ªΩÁâàÊú¨ÈÄâÊã©ÂºπÁ™óÁöÑÂèñÊ∂àÊåâÈíÆ
            document.getElementById('cancel-restore-version-btn').addEventListener('click', () => {
                document.getElementById('restore-version-modal').classList.remove('visible');
            });

            // ÂêØÂä®Ëá™Âä®Â§á‰ªΩÁöÑÁõëÂê¨ - DISABLED FOR DEVELOPMENT
            // ['input', 'change', 'click'].forEach(event => {
            //     document.addEventListener(event, markForBackup, { passive: true });
            // });

            // ===================================================================
            // 5. ÂêØÂä®ÔºÅ
            // ===================================================================
            showScreen('home-screen');
            init();

            // Enable background mode to prevent database connection issues
            document.addEventListener('deviceready', function () {
                if (window.cordova && cordova.plugins && cordova.plugins.backgroundMode) {
                    cordova.plugins.backgroundMode.enable();
                    console.log('Background mode enabled to maintain database connections');
                }
            }, false);
        });
    </script>

    <script>
        // Floating Phone Charm Functionality
        class FloatingPhoneCharm {
            constructor() {
                this.charm = document.getElementById('floating-phone-charm');
                this.isDragging = false;
                this.longPressTimer = null;
                this.longPressDelay = 1000; // 1000ms for long press
                this.dragStartX = 0;
                this.dragStartY = 0;
                this.charmStartX = 0;
                this.charmStartY = 0;
                this.originalPosition = null; // Store original position for bounce back

                this.init();
            }

            init() {
                // Load saved position
                this.loadPosition();

                // Store original position after loading
                this.storeOriginalPosition();

                // Add event listeners
                this.charm.addEventListener('touchstart', this.handleStart.bind(this), { passive: false });
                document.addEventListener('touchmove', this.handleMove.bind(this), { passive: false });
                document.addEventListener('touchend', this.handleEnd.bind(this), { passive: false });

                // Mouse events for desktop testing
                this.charm.addEventListener('mousedown', this.handleStart.bind(this));
                document.addEventListener('mousemove', this.handleMove.bind(this));
                document.addEventListener('mouseup', this.handleEnd.bind(this));

                // Prevent context menu
                this.charm.addEventListener('contextmenu', (e) => e.preventDefault());
            }

            storeOriginalPosition() {
                const rect = this.charm.getBoundingClientRect();
                this.originalPosition = {
                    left: rect.left,
                    top: rect.top
                };
            }

            handleStart(e) {
                e.preventDefault();

                const touch = e.touches ? e.touches[0] : e;
                this.dragStartX = touch.clientX;
                this.dragStartY = touch.clientY;

                // Get charm's current position
                const rect = this.charm.getBoundingClientRect();
                this.charmStartX = rect.left;
                this.charmStartY = rect.top;

                // Start long press timer
                this.longPressTimer = setTimeout(() => {
                    this.startDrag();
                }, this.longPressDelay);
            }

            handleMove(e) {
                if (!this.isDragging) {
                    // Cancel long press if moved too much before long press completes
                    const touch = e.touches ? e.touches[0] : e;
                    const deltaX = Math.abs(touch.clientX - this.dragStartX);
                    const deltaY = Math.abs(touch.clientY - this.dragStartY);

                    if (deltaX > 10 || deltaY > 10) {
                        clearTimeout(this.longPressTimer);
                    }
                    return;
                }

                e.preventDefault();
                const touch = e.touches ? e.touches[0] : e;

                // Calculate how much the finger has moved from the start
                const deltaX = touch.clientX - this.dragStartX;
                const deltaY = touch.clientY - this.dragStartY;

                // Update charm position relative to where it started
                const newLeft = this.charmStartX + deltaX;
                const newTop = this.charmStartY + deltaY;

                this.charm.style.left = newLeft + 'px';
                this.charm.style.top = newTop + 'px';
                this.charm.style.right = 'auto';
                this.charm.style.bottom = 'auto';
            }

            handleEnd(e) {
                clearTimeout(this.longPressTimer);

                if (this.isDragging) {
                    this.endDrag();
                }
            }

            startDrag() {
                this.isDragging = true;
                this.charm.classList.add('dragging');

                // Add visual feedback
                if (navigator.vibrate) {
                    navigator.vibrate(50); // Haptic feedback
                }
            }

            endDrag() {
                this.isDragging = false;
                this.charm.classList.remove('dragging');

                // Check if charm is off-screen and bounce back if needed
                if (this.isOffScreen()) {
                    this.bounceBack();
                } else {
                    // Save current position if it's valid
                    this.savePosition();
                    this.storeOriginalPosition(); // Update original position
                }
            }

            isOffScreen() {
                const rect = this.charm.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const minVisible = 50; // Minimum pixels that should remain visible

                return (
                    rect.right < minVisible || // Too far left
                    rect.left > viewportWidth - minVisible || // Too far right
                    rect.bottom < minVisible || // Too far up
                    rect.top > viewportHeight - minVisible // Too far down
                );
            }

            bounceBack() {
                // Add bounce animation
                this.charm.style.transition = 'all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55)';

                // Return to original position
                this.charm.style.left = this.originalPosition.left + 'px';
                this.charm.style.top = this.originalPosition.top + 'px';

                // Remove transition after animation
                setTimeout(() => {
                    this.charm.style.transition = 'transform 0.2s ease';
                }, 300);
            }

            savePosition() {
                const rect = this.charm.getBoundingClientRect();
                const position = {
                    left: rect.left,
                    top: rect.top
                };
                localStorage.setItem('phoneCharmPosition', JSON.stringify(position));
            }

            loadPosition() {
                const saved = localStorage.getItem('phoneCharmPosition');
                if (saved) {
                    try {
                        const position = JSON.parse(saved);
                        this.charm.style.left = position.left + 'px';
                        this.charm.style.top = position.top + 'px';
                        this.charm.style.right = 'auto';
                        this.charm.style.bottom = 'auto';
                    } catch (e) {
                        console.log('Failed to load charm position:', e);
                    }
                }
            }
        }

        // Initialize floating charm when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.floatingCharmInstance = new FloatingPhoneCharm();

            // Initialize charm visibility from localStorage
            const savedVisibility = localStorage.getItem('charmVisibility');
            const isVisible = savedVisibility !== 'false'; // Default to true

            // Check if function exists before calling
            if (typeof window.toggleCharmVisibility === 'function') {
                window.toggleCharmVisibility(isVisible);
            } else {
                console.error('DEBUG - toggleCharmVisibility function not found');
            }
        });
    </script>
</body>

</html>